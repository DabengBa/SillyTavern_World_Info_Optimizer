<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WI_Optimizer 替换功能测试</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .search-container { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        input[type="search"], input[type="text"] { width: 40%; padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #test-content { margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 5px; }
        .test-entry { padding: 10px; margin: 10px 0; background: white; border-radius: 4px; border-left: 4px solid #007bff; }
        .highlight { background-color: yellow; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WI_Optimizer 替换功能测试</h1>
        
        <div class="search-container">
            <input type="search" id="rlh-search-input" placeholder="搜索...">
            <input type="text" id="rlh-replace-input" placeholder="替换为...">
            <button id="rlh-replace-btn">替换</button>
        </div>
        
        <div id="test-content">
            <div class="test-entry">
                <h3>测试条目 1</h3>
                <p>这是一个测试条目，包含一些需要替换的文本内容。例如，我们可以替换“测试”这个词。</p>
            </div>
            <div class="test-entry">
                <h3>测试条目 2</h3>
                <p>另一个测试条目，也包含“测试”这个词，用于验证替换功能是否正常工作。</p>
            </div>
            <div class="test-entry">
                <h3>不匹配的条目</h3>
                <p>这个条目不包含搜索词，应该在替换操作中保持不变。</p>
            </div>
        </div>
    </div>

    <script>
        // 模拟必要的全局变量和函数
        const parentDoc = $(document);
        const appState = {
            activeTab: 'global-lore',
            searchFilters: {
                bookName: true,
                entryName: true,
                keywords: true,
                content: true
            }
        };
        
        // 模拟showModal函数
        const showModal = async (options) => {
            if (options.type === 'confirm') {
                return confirm(`${options.title}\n\n${options.text}`);
            } else if (options.type === 'alert') {
                alert(`${options.title}\n\n${options.text}`);
                return Promise.resolve();
            }
        };
        
        // 模拟showProgressToast和showSuccessTick函数
        const showProgressToast = (text) => {
            const toast = $(`<div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #007bff; color: white; padding: 10px 20px; border-radius: 20px; z-index: 10000;">${text}</div>`);
            $('body').append(toast);
            return { remove: () => toast.remove() };
        };
        
        const showSuccessTick = (text) => {
            const tick = $(`<div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 10px 20px; border-radius: 20px; z-index: 10000;">${text} <i class="fas fa-check"></i></div>`);
            $('body').append(tick);
            setTimeout(() => tick.remove(), 2000);
        };
        
        // 模拟performReplace函数
        const performReplace = async (matches, searchTerm, replaceTerm) => {
            // 模拟替换操作
            $('.test-entry').each(function() {
                const $entry = $(this);
                const originalText = $entry.html();
                const replacedText = originalText.replace(new RegExp(searchTerm, 'g'), replaceTerm);
                $entry.html(replacedText);
            });
            
            // 模拟异步操作
            await new Promise(resolve => setTimeout(resolve, 1000));
        };
        
        // 模拟getGlobalLorebookMatches函数
        const getGlobalLorebookMatches = (searchTerm) => {
            const matches = [];
            $('.test-entry').each(function() {
                const $entry = $(this);
                const text = $entry.text();
                if (text.includes(searchTerm)) {
                    matches.push({ bookName: 'TestBook', entry: { comment: $entry.find('h3').text(), content: text } });
                }
            });
            return matches;
        };
        
        // 模拟errorCatched装饰器
        const errorCatched = (fn) => {
            return async (...args) => {
                try {
                    return await fn(...args);
                } catch (error) {
                    console.error('Error in function:', error);
                    alert('操作过程中发生错误，请查看控制台。');
                }
            };
        };
        
        // 导入并修改handleReplace函数的核心逻辑
        const handleReplace = errorCatched(async () => {
            const searchTerm = $(`#rlh-search-input`).val();
            const replaceTerm = $('#rlh-replace-input').val();
            
            if (!searchTerm) {
                await showModal({ type: 'alert', title: '替换失败', text: '请先输入搜索词。' });
                return;
            }
            
            if (!replaceTerm) {
                await showModal({ type: 'alert', title: '替换失败', text: '请先输入替换词。' });
                return;
            }
            
            let matches = [];
            
            switch (appState.activeTab) {
                case 'global-lore':
                    matches = getGlobalLorebookMatches(searchTerm);
                    break;
                default:
                    await showModal({ type: 'alert', title: '替换失败', text: '替换功能仅支持世界书视图。' });
                    return;
            }
            
            if (matches.length === 0) {
                await showModal({ type: 'alert', title: '替换失败', text: '未找到匹配的条目。' });
                return;
            }
            
            const confirmResult = await showModal({
                type: 'confirm',
                title: '确认替换',
                text: `找到 ${matches.length} 个匹配项。\n\n确定要将 "${searchTerm}" 替换为 "${replaceTerm}" 吗？\n\n注意：此操作不可撤销，请谨慎操作。`
            });
            
            if (confirmResult) {
                const progressToast = showProgressToast('正在执行替换...');
                try {
                    await performReplace(matches, searchTerm, replaceTerm);
                    progressToast.remove();
                    showSuccessTick('替换完成');
                } catch (error) {
                    progressToast.remove();
                    console.error('[RegexLoreHub] Replace error:', error);
                    await showModal({ type: 'alert', title: '替换失败', text: '替换过程中发生错误，请检查开发者控制台获取详细信息。' });
                }
            }
        });
        
        // 绑定事件
        $(document).ready(() => {
            $('#rlh-replace-btn').on('click', handleReplace);
        });
    </script>
</body>
</html>
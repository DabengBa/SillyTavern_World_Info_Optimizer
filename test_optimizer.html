<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WI Optimizer Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0V4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #extensionsMenu { border: 1px solid #ccc; padding: 10px; min-height: 50px; display: flex; flex-direction: column; }
        .list-group-item { cursor: pointer; padding: 5px; border: 1px solid #eee; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        #regex-lore-hub-panel {
            display: none; position: fixed; top: 50px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 850px; height: 80vh; max-height: 80vh;
            background-color: #FAF5D5; color: #2C3E50;
            border: 1px solid #7EB7D5; border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1); z-index: 10000;
            flex-direction: column; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; overflow: hidden;
        }
    </style>
</head>
<body>
    <h1>WI Optimizer Test Page</h1>
    <div id="extensionsMenu"></div>
    <button id="open-panel-button" style="margin-top: 20px; padding: 10px 20px; font-size: 16px;">Open Regex & Lorebook Hub</button>
    <div id="test-output"></div>

    <script>
        // Mock SillyTavern and TavernHelper for testing
        window.parent = {
            document: document,
            SillyTavern: {
                getContext: () => ({
                    characterId: 1, // Simulate an active character
                    chatId: 1, // Simulate an active chat
                    characters: [{ name: 'TestChar1' }, { name: 'TestChar2' }],
                    selectCharacterById: async (id) => { console.log(`Character selected: ${id}`); },
                }),
            },
            TavernHelper: {
                getCharData: async () => ({ name: 'TestChar1', lorebook: { primary: 'BookA', additional: ['BookB'] } }),
                getLorebooks: async () => ['BookA', 'BookB', 'BookC', 'ProblematicBook'], // Add ProblematicBook here
                getLorebookSettings: async () => ({ selected_global_lorebooks: ['BookA'] }),
                getCharLorebooks: async () => ({ primary: 'BookA', additional: ['BookB'] }),
                getChatLorebook: async () => 'ChatBook',
                getOrCreateChatLorebook: async () => 'ChatBook',
                setChatLorebook: async (name) => { console.log(`Chat Lorebook set to: ${name}`); },
                getLorebookEntries: async (bookName) => {
                    // Simulate returning non-array data for a specific book to test the fix
                    if (bookName === 'ProblematicBook') {
                        console.warn('Simulating non-array return for ProblematicBook');
                        return null; // Or any non-array, non-null/undefined value like 123, "string", {}
                    }
                    return [
                        { uid: 1, comment: `${bookName} Entry 1`, keys: ['key1'], content: 'Content 1', enabled: true, display_index: 0 },
                        { uid: 2, comment: `${bookName} Entry 2`, keys: ['key2'], content: 'Content 2', enabled: false, display_index: 1 },
                    ];
                },
                setLorebookEntries: async (bookName, entries) => {
                    console.log(`setLorebookEntries called for ${bookName} with:`, entries);
                    // Simulate updating entries in a mock map
                    const currentEntries = new Map(window.parent.TavernHelper._mockLorebookEntries);
                    const bookEntries = currentEntries.get(bookName) || [];
                    entries.forEach(update => {
                        const existingIndex = bookEntries.findIndex(e => e.uid === update.uid);
                        if (existingIndex > -1) {
                            Object.assign(bookEntries[existingIndex], update);
                        } else if (update.comment) { // Simulate create
                            bookEntries.push({ uid: Date.now(), ...update });
                        }
                    });
                    currentEntries.set(bookName, bookEntries);
                    window.parent.TavernHelper._mockLorebookEntries = currentEntries;
                    return { entries: bookEntries, delete_occurred: false, new_uids: entries.filter(e => !e.uid).map((_,i) => Date.now() + i) };
                },
                createLorebook: async (name) => { console.log(`Lorebook created: ${name}`); return true; },
                deleteLorebook: async (name) => { console.log(`Lorebook deleted: ${name}`); return true; },
                replaceTavernRegexes: async (regexes) => { console.log('Regexes replaced:', regexes); },
                getTavernRegexes: async () => ([
                    { id: 'g1', script_name: 'Global Regex 1', find_regex: 'abc', replace_string: 'def', enabled: true, scope: 'global' },
                    { id: 'c1', script_name: 'Char Regex 1', find_regex: 'xyz', replace_string: '123', enabled: true, scope: 'character' },
                ]),
                builtin: {
                    saveSettings: async () => { console.log('Settings saved'); },
                },
                Character: class {
                    constructor(data) { this.data = data; }
                    getRegexScripts() { return []; }
                }
            },
        };
        // Initialize mock lorebook entries map
        window.parent.TavernHelper._mockLorebookEntries = new Map();
        window.parent.TavernHelper._mockLorebookEntries.set('BookA', [
            { uid: 1, comment: 'BookA Entry 1', keys: ['keyA1'], content: 'Content A1', enabled: true, display_index: 0 },
        ]);
        window.parent.TavernHelper._mockLorebookEntries.set('BookB', [
            { uid: 3, comment: 'BookB Entry 1', keys: ['keyB1'], content: 'Content B1', enabled: true, display_index: 0 },
        ]);
        window.parent.TavernHelper._mockLorebookEntries.set('ChatBook', [
            { uid: 5, comment: 'ChatBook Entry 1', keys: ['keyC1'], content: 'Content C1', enabled: true, display_index: 0 },
        ]);
        // Add a problematic book that returns null
        window.parent.TavernHelper._mockLorebookEntries.set('ProblematicBook', null);

        // Add event listener to the new button to open the panel
        document.addEventListener('DOMContentLoaded', () => {
            const openPanelButton = document.getElementById('open-panel-button');
            if (openPanelButton) {
                openPanelButton.addEventListener('click', () => {
                    const panelButton = window.parent.document.getElementById('regex-lore-hub-button');
                    if (panelButton) {
                        panelButton.click();
                    } else {
                        console.error('Regex & Lorebook Hub button not found.');
                    }
                });
            }
        });
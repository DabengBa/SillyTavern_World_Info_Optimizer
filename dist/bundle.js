var ne="regex-lore-hub-panel",De="regex-lore-hub-button";var Mr="\u4E16\u754C\u4E66&\u6B63\u5219\u7BA1\u7406\u5668",Zr="\u4E16\u754C\u4E66&\u6B63\u5219\u7BA1\u7406\u5668",Or="rlh-close-btn",Fe="rlh-search-input",dr="rlh-refresh-btn",hr="rlh-core-toolbar",pr="rlh-replace-tool-container";var rr="rlh-replace-input",tr="rlh-toggle-collapse-btn",et="rlh-toggle-recursion-btn",rt="rlh-fix-keywords-btn",or="rlh-sort-menu",ze="rlh-sort-menu-btn",He="rlh-position-menu",Oe="rlh-position-menu-btn",wr="rlh-create-primary-btn",_r="rlh-character-book-switch",$r="rlh-prefetch-indicator",Er="rlh-prefetch-progress-text",Sr="rlh-prefetch-progress-bar",Re={TOOLBAR_SHELL:"regex-lore-hub-toolbar-shell",TOGGLE_TOOLBAR_BTN:"regex-lore-hub-toggle-toolbar-btn"},Ie={position:{before_character_definition:"\u89D2\u8272\u5B9A\u4E49\u524D",after_character_definition:"\u89D2\u8272\u5B9A\u4E49\u540E",before_example_messages:"\u804A\u5929\u793A\u4F8B\u524D",after_example_messages:"\u804A\u5929\u793A\u4F8B\u540E",before_author_note:"\u4F5C\u8005\u7B14\u8BB0\u524D",after_author_note:"\u4F5C\u8005\u7B14\u8BB0\u540E",at_depth_as_system:"@D \u2699 \u7CFB\u7EDF",at_depth_as_assistant:"@D \u{1F5E8}\uFE0F \u89D2\u8272",at_depth_as_user:"@D \u{1F464} \u7528\u6237"},logic:{and_any:"\u4EFB\u4E00 AND",and_all:"\u6240\u6709 AND",not_any:"\u4EFB\u4E00 NOT",not_all:"\u6240\u6709 NOT"}},lr={bookName:"\u4E66\u540D",entryName:"\u6761\u76EE\u540D",keywords:"\u5173\u952E\u8BCD",content:"\u5185\u5BB9"},Br={entryName:"\u540D\u79F0",content:"\u5185\u5BB9"},tt={bookName:{id:"rlh-filter-book-name"},entryName:{id:"rlh-filter-entry-name"},keywords:{id:"rlh-filter-keywords"},content:{id:"rlh-filter-content"}},ot={status:{value:"status",label:"\u6309\u542F\u7528\u72B6\u6001"},name:{value:"name",label:"\u540D\u79F0\u6392\u5E8F"}},t={regexes:{global:[],character:[]},lorebooks:{character:[]},chatLorebook:null,allLorebooks:[],lorebookEntries:new Map,pendingLorebookUpdates:new Map,pendingRegexUpdates:new Set,lorebookUsage:new Map,activeTab:"global-lore",activeView:"global-lore-list",activeBookName:null,activeCharacterBook:null,charLoreInitialSynced:!1,pendingHighlightEntry:null,isDataLoaded:!1,isLoadingTabData:!1,loadingBookName:null,searchFilters:{bookName:!0,entryName:!0,keywords:!0,content:!0},multiSelectMode:!1,multiSelectTarget:"book",selectedItems:new Set,globalSearch:{term:"",replace:""},searchFilterContextsInitialized:new Set,collapseStateByContext:new Map,sortModeByContext:new Map,characterContext:{name:null,id:null},saveStatus:"idle",saveRetryAttempt:0,isToolbarCollapsed:!0},le=e=>{try{(!t.lorebookEntries||!(t.lorebookEntries instanceof Map))&&(console.warn("[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing..."),t.lorebookEntries=new Map),typeof t.lorebookEntries.get!="function"&&(console.warn("[RegexLoreHub] appState.lorebookEntries.get is not a function, reinitializing..."),t.lorebookEntries=new Map);let r=t.lorebookEntries.get(e);return Array.isArray(r)?r:[]}catch(r){return console.error("[RegexLoreHub] Error in safeGetLorebookEntries:",r),t.lorebookEntries=new Map,[]}},_e=(e,r)=>{try{(!t.lorebookEntries||!(t.lorebookEntries instanceof Map))&&(console.warn("[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing..."),t.lorebookEntries=new Map),typeof t.lorebookEntries.set!="function"&&(console.warn("[RegexLoreHub] appState.lorebookEntries.set is not a function, reinitializing..."),t.lorebookEntries=new Map),t.lorebookEntries.set(e,Array.isArray(r)?r:[])}catch(o){console.error("[RegexLoreHub] Error in safeSetLorebookEntries:",o),t.lorebookEntries=new Map,t.lorebookEntries.set(e,Array.isArray(r)?r:[])}},br=e=>{try{if(!t.lorebookEntries||!(t.lorebookEntries instanceof Map)){console.warn("[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing..."),t.lorebookEntries=new Map;return}if(typeof t.lorebookEntries.delete!="function"){console.warn("[RegexLoreHub] appState.lorebookEntries.delete is not a function, reinitializing..."),t.lorebookEntries=new Map;return}t.lorebookEntries.delete(e)}catch(r){console.error("[RegexLoreHub] Error in safeDeleteLorebookEntries:",r),t.lorebookEntries=new Map}},Dr=()=>{try{if(!t.lorebookEntries||!(t.lorebookEntries instanceof Map)){console.warn("[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing..."),t.lorebookEntries=new Map;return}if(typeof t.lorebookEntries.clear!="function"){console.warn("[RegexLoreHub] appState.lorebookEntries.clear is not a function, reinitializing..."),t.lorebookEntries=new Map;return}t.lorebookEntries.clear()}catch(e){console.error("[RegexLoreHub] Error in safeClearLorebookEntries:",e),t.lorebookEntries=new Map}},Hr=e=>{try{return!t.lorebookEntries||!(t.lorebookEntries instanceof Map)?(console.warn("[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing..."),t.lorebookEntries=new Map,!1):typeof t.lorebookEntries.has!="function"?(console.warn("[RegexLoreHub] appState.lorebookEntries.has is not a function, reinitializing..."),t.lorebookEntries=new Map,!1):t.lorebookEntries.has(e)}catch(r){return console.error("[RegexLoreHub] Error in safeHasLorebookEntries:",r),t.lorebookEntries=new Map,!1}};function ge(){return window.parent||window}function ie(){return ge().document}var I=e=>{if(typeof e!="string")return String(e);let r=ie().createElement("div");return r.textContent=e,r.innerHTML},Xe=(e,r)=>{if(!r||!e)return I(e);let o=I(e),a=I(r),l=new Set([".","*","+","?","^","$","{","}","(",")","|","[","]","\\\\"]),n="";for(let u of a)n+=l.has(u)?"\\"+u:u;let i=new RegExp(`(${n})`,"gi");return o.replace(i,'<mark class="rlh-highlight">$1</mark>')},ce=(e,r="success",o=2e3)=>{let a=te(),l=ie();if(!a||!l)return;let n=a(`#${ne}`,l);if(n.length===0)return;n.find(".rlh-toast-notification").remove();let i={success:"fa-check-circle",error:"fa-times-circle",info:"fa-info-circle"}[r],u=`
    <div class="rlh-toast-notification ${r}">
      <i class="fa-solid ${i}"></i> ${I(e)}
    </div>
  `,m=a(u);n.append(m),setTimeout(()=>m.addClass("visible"),10),setTimeout(()=>{m.removeClass("visible"),setTimeout(()=>m.remove(),300)},o)},qe=(e="\u6B63\u5728\u5904\u7406...")=>{let r=te(),o=ie();if(!r||!o)return{update:()=>{},remove:()=>{}};let a=r(`#${ne}`,o);if(a.length===0)return{update:()=>{},remove:()=>{}};a.find(".rlh-progress-toast").remove();let l=`<div class="rlh-progress-toast"><i class="fa-solid fa-spinner fa-spin"></i> <span class="rlh-progress-text">${I(e)}</span></div>`,n=r(l);return a.append(n),setTimeout(()=>n.addClass("visible"),10),{update:m=>{n.find(".rlh-progress-text").html(I(m))},remove:()=>{n.removeClass("visible"),setTimeout(()=>n.remove(),300)}}},Y=e=>{let r=te(),o=ie();return!r||!o?Promise.reject():new Promise((a,l)=>{let{type:n="alert",title:i="\u901A\u77E5",text:u="",html:m="",placeholder:h="",value:d=""}=e||{},g="";n==="alert"?g='<button class="rlh-modal-btn rlh-modal-ok">\u786E\u5B9A</button>':n==="confirm"?g='<button class="rlh-modal-btn rlh-modal-cancel">\u53D6\u6D88</button><button class="rlh-modal-btn rlh-modal-ok">\u786E\u8BA4</button>':n==="prompt"&&(g='<button class="rlh-modal-btn rlh-modal-cancel">\u53D6\u6D88</button><button class="rlh-modal-btn rlh-modal-ok">\u786E\u5B9A</button>');let v=n==="prompt"?`<input type="text" class="rlh-modal-input" placeholder="${I(h)}" value="${I(d)}">`:"",w=m||`<p>${I(u)}</p>`,M=`<div class="rlh-modal-overlay"><div class="rlh-modal-content"><div class="rlh-modal-header">${I(i)}</div><div class="rlh-modal-body">${w}${v}</div><div class="rlh-modal-footer">${g}</div></div></div>`,C=r(M).hide(),T=r(`#${ne}`,o);T.length>0?T.append(C):r("body",o).append(C),C.fadeIn(200);let s=C.find(".rlh-modal-input");n==="prompt"&&s.focus().select();let k=(y,O)=>{C.fadeOut(200,()=>{C.remove(),y?a(O):l()})};C.on("click",".rlh-modal-ok",()=>{let y=n==="prompt"?s.val():!0;if(n==="prompt"&&!String(y).trim()){s.addClass("rlh-input-error"),setTimeout(()=>s.removeClass("rlh-input-error"),500);return}k(!0,y)}),C.on("click",".rlh-modal-cancel",()=>k(!1)),n==="prompt"&&s.on("keydown",y=>{y.key==="Enter"?C.find(".rlh-modal-ok").click():y.key==="Escape"&&C.find(".rlh-modal-cancel").click()})})},S=(e,r="RegexLoreHub",o={})=>{let{notify:a="toast",toastType:l="error",toastDuration:n=4e3,toastMessage:i="\u64CD\u4F5C\u53D1\u751F\u5F02\u5E38\uFF0C\u8BF7\u67E5\u770B\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u3002",modalTitle:u="\u811A\u672C\u5F02\u5E38",modalText:m="\u64CD\u4F5C\u4E2D\u53D1\u751F\u672A\u77E5\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u3002"}=o??{};return async(...h)=>{try{return await e(...h)}catch(d){if(!d)return;if(console.error(`[${r}] Error:`,d),a==="modal"){await Y({type:"alert",title:u,text:m});return}a==="toast"&&ce(i,l,n)}}};function Pr(e,r){let o;return function(...a){let l=this;clearTimeout(o),o=setTimeout(()=>e.apply(l,a),r)}}var lt=(e,r)=>{let o=e.replace(/[.*+?^${}()|[\]\/\\]/g,"\\$&"),a=r?"g":"gi";return new RegExp(o,a)},at={INSERT_RULES_TITLE:"\u63D2\u5165\u89C4\u5219"};var ar=e=>e.instanceKey||e.id||"default",Ve=e=>{let r=ar(e);return t.collapseStateByContext.get(r)??"expanded"},it=(e,r)=>{let o=ar(e);t.collapseStateByContext.set(o,r)},We=e=>{let r=Array.isArray(e.sortOptions)?e.sortOptions:[];if(!r.length)return null;let o=ar(e),a=t.sortModeByContext.get(o);if(a&&r.includes(a))return a;let l=r[0];return t.sortModeByContext.set(o,l),l},st=(e,r)=>{if(!(e.sortOptions??[]).includes(r))return;let a=ar(e);t.sortModeByContext.set(a,r)},nt=e=>I(String(e??"")),jt=(e,r)=>{let o=e.visibleFilters??[];if(!o.length)return"";let a=o.map(l=>{let n=tt[l];if(!n)return"";let i=e.filterLabels?.[l]??lr[l]??l,u=r[l];return`<label class="rlh-filter-item"><input type="checkbox" id="${n.id}" data-filter-key="${l}" ${u?"checked":""}>${i}</label>`}).filter(Boolean).join("");return a?`<div class="rlh-filter-list" id="rlh-search-filters-container">${a}</div>`:""},Gt=(e,r)=>{let o=Array.isArray(e.sortOptions)?e.sortOptions:[];if(!o.length)return"";let a=o.map(n=>{let i=ot[n];if(!i)return"";let u=i.value===r;return`<li role="presentation"><button type="button" class="rlh-sort-option${u?" active":""}" data-sort-value="${i.value}" role="option" aria-selected="${u?"true":"false"}">${i.label}</button></li>`}).filter(Boolean).join("");if(!a)return"";let l=`${or}-list`;return`<div class="rlh-sort-menu" id="${or}" data-open="false"><button type="button" id="${ze}" class="rlh-toolbar-btn" data-current-sort="${r??""}" aria-haspopup="listbox" aria-expanded="false" aria-controls="${l}"><i class="fa-solid fa-sort"></i><span>\u6392\u5E8F</span></button><ul class="rlh-sort-menu-list" id="${l}" role="listbox" aria-labelledby="${ze}">${a}</ul></div>`},Kt=e=>{if(!e.showPositionMenu)return"";let r=e.activeBookName?.toString().trim()??"",o=r?le(r):[],a=o.length>0,l=new Set(o.map(d=>(d?.position??"before_character_definition").toString())),n=l.size===1?l.values().next().value:null,i=`${He}-list`,u=['type="button"',`id="${Oe}"`,'class="rlh-toolbar-btn"','aria-haspopup="listbox"','aria-expanded="false"',`aria-controls="${i}"`];(!r||!a)&&u.push("disabled"),r&&u.push(`data-book-name="${I(r)}"`);let m=Object.entries(Ie.position).map(([d,g])=>{let v=a&&n===d,w=['type="button"',`class="rlh-position-option${v?" active":""}"`,`data-position-value="${I(d)}"`,'role="option"',`aria-selected="${v?"true":"false"}"`];return r&&w.push(`data-book-name="${I(r)}"`),`<li role="presentation"><button ${w.join(" ")}>${I(g)}</button></li>`}).join(""),h=['class="rlh-position-menu"',`id="${He}"`,'data-open="false"'];return r&&h.push(`data-book-name="${I(r)}"`),`<div ${h.join(" ")}><button ${u.join(" ")}><i class="fa-solid fa-map-pin"></i><span>\u7EDF\u4E00\u4F4D\u7F6E</span></button><ul class="rlh-position-menu-list" id="${i}" role="listbox" aria-labelledby="${Oe}">${m}</ul></div>`},ct=(e,{$toolbar:r,$replaceContainer:o})=>{let a=Ve(e),l=e.sortOptions?.length??0?We(e):null,n=["rlh-toolbar-btn"];t.multiSelectMode&&n.push("active"),e.supportsMultiSelect||n.push("disabled");let i=['type="button"','id="rlh-multi-select-btn"',`class="${n.join(" ")}"`,`data-target="${e.supportsMultiSelect?e.multiSelectTarget:""}"`];e.supportsMultiSelect||i.push("disabled");let u=`<button ${i.join(" ")}><i class="fa-solid fa-check-double"></i><span>\u591A\u9009\u6A21\u5F0F</span></button>`,m=["rlh-multi-select-controls"];t.multiSelectMode&&m.push("active");let h=e.supportsMultiSelect?`
        <div id="rlh-multi-select-controls" class="${m.join(" ")}">
          <div class="rlh-multi-select-actions">
            <button class="rlh-multi-select-action-btn" id="rlh-select-all-btn" title="\u5168\u9009">\u5168</button>
            <button class="rlh-multi-select-action-btn" id="rlh-select-none-btn" title="\u6E05\u9664">\u6E05</button>
            <button class="rlh-multi-select-action-btn" id="rlh-select-invert-btn" title="\u53CD\u9009">\u53CD</button>
            <button class="rlh-multi-select-action-btn enable" id="rlh-batch-enable-btn" title="\u542F\u7528">\u5F00</button>
            <button class="rlh-multi-select-action-btn disable" id="rlh-batch-disable-btn" title="\u7981\u7528">\u5173</button>
            <button class="rlh-multi-select-action-btn disable" id="rlh-batch-delete-btn" title="\u5220\u9664">\u5220</button>
          </div>
          <span class="rlh-selection-count" id="rlh-selection-count">\u5DF2\u9009\u62E9: ${t.selectedItems.size}</span>
        </div>
      `:"",d=`
        <div class="rlh-multi-select-module">
          ${u}
          ${h}
        </div>
      `,g="";e.showCollapseToggle&&(g=`<button type="button" id="${tr}" class="rlh-toolbar-btn" data-collapse-state="${a}"><i class="fa-solid ${a==="collapsed"?"fa-expand-arrows-alt":"fa-compress-arrows-alt"}"></i><span>${a==="collapsed"?"\u5168\u90E8\u5C55\u5F00":"\u5168\u90E8\u6298\u53E0"}</span></button>`);let v=e.showRecursion?(()=>{let f=e.activeBookName??"",x=['type="button"',`id="${et}"`,'class="rlh-toolbar-btn rlh-batch-recursion-btn"'];return f?x.push(`data-book-name="${I(f)}"`):x.push("disabled"),`<button ${x.join(" ")}><i class="fa-solid fa-shield-halved"></i><span>\u5168\u5F00\u9632\u9012\u5F52</span></button>`})():"",w=e.showFixKeywords?(()=>{let f=e.activeBookName??"",x=['type="button"',`id="${rt}"`,'class="rlh-toolbar-btn rlh-fix-keywords-btn"'];return f?x.push(`data-book-name="${I(f)}"`):x.push("disabled"),`<button ${x.join(" ")}><i class="fa-solid fa-check-double"></i><span>\u4FEE\u590D\u5173\u952E\u8BCD</span></button>`})():"",M=Kt(e),C=Gt(e,l),T=jt(e,t.searchFilters),s=I(e.scopeLabel),k=I(e.searchPlaceholder),y=nt(t.globalSearch.term??""),_=`<div class="rlh-search-row">${`<label class="rlh-search-field">
          <input type="search" id="${Fe}" class="rlh-search-input" placeholder="${k}" value="${y}" autocomplete="off" />
        </label>`}<button type="button" id="rlh-search-clear-btn" class="rlh-toolbar-icon-btn" title="\u6E05\u7A7A"><i class="fa-solid fa-eraser"></i></button></div>`,B=nt(t.globalSearch.replace??""),z=e.showReplace?`<div class="rlh-replace-body"><input type="text" id="${rr}" class="rlh-replace-input" placeholder="\u66FF\u6362\u4E3A..." value="${B}" /><button type="button" id="rlh-replace-btn" class="rlh-toolbar-icon-btn rlh-replace-action" title="\u66FF\u6362"><i class="fa-solid fa-repeat"></i></button></div>`:"",R=`<div class="rlh-search-meta">
          ${T}
          <span class="rlh-search-scope">${s}</span>
        </div>`,U=`<div class="rlh-search-box">${_}${z}${R}</div>`,j="";if(e.primaryAction?.visible&&e.primaryAction.scope==="entry"){let f=e.activeBookName??"",x=!f,N=["rlh-toolbar-btn","rlh-create-entry-btn"];x&&N.push("disabled");let F=['type="button"',`class="${N.join(" ")}"`],L=e.primaryAction.title??e.primaryAction.label??"";L&&F.push(`title="${I(L)}"`),x?F.push("disabled"):F.push(`data-book-name="${I(f)}"`);let D=e.primaryAction.icon?e.primaryAction.icon:"fa-file-circle-plus",X=I(e.primaryAction.label??"\u65B0\u5EFA\u6761\u76EE");j=`<button ${F.join(" ")}><i class="fa-solid ${D}"></i><span>${X}</span></button>`}let q="";if(e.primaryAction?.visible&&e.primaryAction.scope==="book"){let x=['type="button"','id="regex-lore-hub-create-lorebook-btn"',`class="${["rlh-toolbar-btn","rlh-create-book-btn"].join(" ")}"`],N=e.primaryAction.title??e.primaryAction.label??"";N&&x.push(`title="${I(N)}"`);let F=e.primaryAction.icon?e.primaryAction.icon:"fa-plus",L=I(e.primaryAction.label??"\u65B0\u5EFA\u4E16\u754C\u4E66");q=`<button ${x.join(" ")}><i class="fa-solid ${F}"></i><span>${L}</span></button>`}let oe=`
    <div class="rlh-toolbar-section rlh-toolbar-section--search">
      <div class="rlh-search-section-grid">
        <div class="rlh-search-section-main">
          ${U}
        </div>
        <div class="rlh-search-section-multiselect">
          ${d}
        </div>
      </div>
    </div>
  `,re=[q,j,e.showCollapseToggle?g:"",v,w,M,C].filter(Boolean),de=re.length?`
        <div class="rlh-toolbar-section rlh-toolbar-section--actions">
          <div class="rlh-toolbar-actions">
            ${re.join("")}
          </div>
        </div>
      `:"",c=`
    <div class="rlh-toolbar-inner">
      ${[oe,de].filter(Boolean).join("")}
    </div>

  `;r.html(c),o.empty()},mr=(e,r)=>{let o=r.toLowerCase();return!!(!o||t.searchFilters.entryName&&(e.name||"").toLowerCase().includes(o)||t.searchFilters.keywords&&e.keys.join(" ").toLowerCase().includes(o)||t.searchFilters.content&&e.content&&e.content.toLowerCase().includes(o))},dt=(e,r)=>{let o=r.toLowerCase();return!!(t.searchFilters.entryName&&(e.script_name||"").toLowerCase().includes(o)||t.searchFilters.content&&(e.find_regex||"").toLowerCase().includes(o)||t.searchFilters.content&&(e.replace_string||"").toLowerCase().includes(o))},ht=(e,r,o,a)=>{let l=te(),n=t.lorebookUsage.get(e.name)||[],i=n.length>0?`<div class="rlh-used-by-chars">\u4F7F\u7528\u8005: ${n.map(s=>`<span>${I(s)}</span>`).join(", ")}</div>`:"",u=Xe(e.name,r),m=t.multiSelectMode&&t.multiSelectTarget==="book",h=`book:${e.name}`,d=m&&t.selectedItems.has(h),g=m?`<label class="rlh-selection-control"><input type="checkbox" class="rlh-multi-select-checkbox" data-select-key="${I(h)}" ${d?"checked":""}></label>`:"",v=l(`
      <div class="rlh-book-group" data-book-name="${I(e.name)}" data-select-key="${I(h)}">
          <div class="rlh-global-book-header rlh-clickable-header">
              ${g}
              <div class="rlh-book-title-wrapper">
                  <span class="rlh-item-name">${u}</span>
                  <div class="rlh-book-stats">\u6761\u76EE: ${e.enabledEntryCount} / ${e.entryCount}</div>
              </div>
              <div class="rlh-item-controls">
                  <button class="rlh-action-btn-icon rlh-rename-book-btn" title="\u91CD\u547D\u540D\u4E16\u754C\u4E66"><i class="fa-solid fa-pen-to-square"></i></button>
                  <button class="rlh-toggle-btn rlh-global-toggle" title="\u542F\u7528/\u7981\u7528\u6574\u4E2A\u4E16\u754C\u4E66"><i class="fa-solid fa-power-off"></i></button>
                  <button class="rlh-action-btn-icon rlh-delete-book-btn" title="\u5220\u9664\u4E16\u754C\u4E66"><i class="fa-solid fa-folder-minus"></i></button>
              </div>
          </div>
          ${n.length>0?`<div class="rlh-book-summary">${i}</div>`:""}
          <div class="rlh-collapsible-content"></div>
      </div>
    `);v.toggleClass("enabled",e.enabled),v.find(".rlh-global-book-header").toggleClass("enabled",e.enabled),v.toggleClass("selected",d);let w=v.find(".rlh-collapsible-content"),M=l(`<div class="rlh-entry-actions"><button class="rlh-action-btn rlh-create-entry-btn" data-book-name="${I(e.name)}"><i class="fa-solid fa-plus"></i> \u65B0\u5EFA\u6761\u76EE</button><button class="rlh-action-btn rlh-batch-recursion-btn" data-book-name="${I(e.name)}"><i class="fa-solid fa-shield-halved"></i> \u5168\u5F00\u9632\u9012\u5F52</button><button class="rlh-action-btn rlh-fix-keywords-btn" data-book-name="${I(e.name)}"><i class="fa-solid fa-check-double"></i> \u4FEE\u590D\u5173\u952E\u8BCD</button></div>`);w.append(M);let C=[...le(e.name)].sort((s,k)=>(s.display_index??Number.MAX_SAFE_INTEGER)-(k.display_index??Number.MAX_SAFE_INTEGER)),T=o?C:a||[];if(T&&T.length>0){let s=l('<div class="rlh-entry-list-wrapper"></div>');T.forEach(k=>s.append(je(k,"lore",e.name,r,{enableDrag:!1}))),w.append(s)}else r&&w.append('<div class="rlh-info-text-small">\u65E0\u5339\u914D\u9879</div>');return v},Cr=e=>typeof e=="string"?e.replace(/\r?\n/g,"<br>"):e,ur=e=>`<span class="rlh-viewer-empty">${I(e)}</span>`,Ur=(e,r)=>{let a=(Array.isArray(e?.keys)?e.keys:[]).join(", "),l=a?Cr(r?Xe(a,r):I(a)):ur("\u6682\u65E0\u5173\u952E\u8BCD"),n=e?.content??"",i=n?Cr(r?Xe(n,r):I(n)):ur("\u6682\u65E0\u5185\u5BB9"),u=z=>z!=null&&z!=="",m=(z,R="\u672A\u8BBE\u7F6E")=>u(z)?I(String(z)):ur(R),h=z=>{if(!z)return"";let{label:R,value:U,placeholder:j,html:q}=z,oe=q!==void 0?q:m(U,j);return`
      <div class="rlh-editor-field rlh-viewer-field">
        <label>${R}</label>
        <div class="rlh-viewer-text">${oe}</div>
      </div>
    `},d=(z,R,U={})=>{if(!R.length)return"";let j=U.layout??"grid",q=z?`<h5>${z}</h5>`:"",oe="";return j==="grid"?oe=`
        <div class="rlh-editor-grid">${R.map(de=>`
          <div class="rlh-grid-item">${h(de)}</div>`).join("")}
        </div>
      `:oe=R.map(h).join(""),`
      <div class="rlh-editor-group rlh-viewer-group">
        ${q}
        ${oe}
      </div>
    `},g=(()=>{let z=e?.position;return u(z)?typeof z=="object"&&z!==null&&typeof z.type=="string"&&z.type?Ie.position?.[z.type]??z.type:typeof z=="string"?Ie.position?.[z]??z:null:null})(),v=u(e?.depth)?e.depth:null,w=u(e?.order)?e.order:null,M=u(e?.logic),C=M?e.logic:"and_any",T=Ie.logic?.[C]??C,s=M?T:`${T} (\u9ED8\u8BA4)`,k=u(e?.probability)?`${e.probability}%`:"100% (\u9ED8\u8BA4)",y=h({label:"\u5173\u952E\u8BCD",html:l}),O=h({label:"\u5185\u5BB9",html:`<article class="rlh:prose rlh:dark:rlh:prose-invert max-w-none">${i}</article>`}),A=d(at.INSERT_RULES_TITLE,[{label:"\u4F4D\u7F6E",value:g,placeholder:"\u672A\u8BBE\u7F6E"},{label:"\u6DF1\u5EA6",value:v,placeholder:"\u672A\u8BBE\u7F6E"},{label:"\u987A\u5E8F",value:w,placeholder:"\u672A\u8BBE\u7F6E"}],{layout:"grid"}),_=d("\u6FC0\u6D3B\u903B\u8F91",[{label:"\u6982\u7387",value:k,placeholder:"100% (\u9ED8\u8BA4)"},{label:"\u5173\u952E\u8BCD\u903B\u8F91",value:s,placeholder:"\u4EFB\u4E00 AND (\u9ED8\u8BA4)"}],{layout:"grid"}),B=d("\u5339\u914D\u4E0E\u9012\u5F52",[{label:"\u5927\u5C0F\u5199\u654F\u611F",value:e?.case_sensitive?"\u5F00\u542F":"\u5173\u95ED",placeholder:"\u5173\u95ED"},{label:"\u5168\u8BCD\u5339\u914D",value:e?.match_whole_words?"\u5F00\u542F":"\u5173\u95ED",placeholder:"\u5173\u95ED"},{label:"\u9632\u6B62\u9012\u5F52",value:e?.prevent_recursion?"\u5F00\u542F":"\u5173\u95ED",placeholder:"\u5173\u95ED"},{label:"\u4E0D\u53EF\u88AB\u9012\u5F52",value:e?.exclude_recursion?"\u5F00\u542F":"\u5173\u95ED",placeholder:"\u5173\u95ED"}],{layout:"grid"});return`
    <div class="rlh-entry-viewer" data-mode="view">
      ${y}
      ${O}
      ${A}
      ${_}
      ${B}
    </div>
  `},Fr=(e,r)=>{let o=e?.find_regex??"",a=e?.replace_string??"",l=typeof r=="string"?r:"",n=o?Cr(l?Xe(o,l):I(o)):ur("\u6682\u65E0\u67E5\u627E\u6B63\u5219"),i=a?Cr(l?Xe(a,l):I(a)):ur("\u6682\u65E0\u66FF\u6362\u5185\u5BB9"),u=e?.destination??{},m=e?.source??{},h=e?.min_depth,d=e?.max_depth,g=[];u.display&&g.push("\u4EC5\u683C\u5F0F\u663E\u793A"),u.prompt&&g.push("\u4EC5\u683C\u5F0F\u63D0\u793A\u8BCD");let v=g.length?g.join(" / "):"\u683C\u5F0F\u4E0E\u63D0\u793A\u8BCD",M=Object.entries({user_input:"\u7528\u6237\u8F93\u5165",ai_output:"AI\u8F93\u51FA",slash_command:"\u659C\u6760\u547D\u4EE4",world_info:"\u4E16\u754C\u4E66"}).filter(([A])=>!!m?.[A]).map(([,A])=>A),C=M.length===0?"\u672A\u9009\u62E9\u4F5C\u7528\u8303\u56F4":M.length===4?"\u5168\u90E8\u6765\u6E90":M.join(" / "),T=h!=null&&h!=="",s=d!=null&&d!=="",k="\u65E0\u6DF1\u5EA6\u9650\u5236";T&&s?k=`${h} - ${d}`:T?k=`>= ${h}`:s&&(k=`<= ${d}`);let O=[{label:"\u8F93\u51FA\u8BBE\u7F6E",value:v},{label:"\u4F5C\u7528\u8303\u56F4",value:C},{label:"\u6DF1\u5EA6\u8303\u56F4",value:k}].map(A=>`
      <div class="rlh-editor-field rlh-viewer-field">
        <label>${A.label}</label>
        <div class="rlh-viewer-text">${I(String(A.value??""))}</div>
      </div>
    `).join("");return`
    <div class="rlh-regex-viewer" data-mode="view">
      <div class="rlh-editor-field rlh-viewer-field">
        <label>\u67E5\u627E\u6B63\u5219\u8868\u8FBE\u5F0F</label>
        <article class="rlh:prose rlh:dark:rlh:prose-invert max-w-none">${n}</article>
      </div>
      <div class="rlh-editor-field rlh-viewer-field">
        <label>\u66FF\u6362\u4E3A</label>
        <article class="rlh:prose rlh:dark:rlh:prose-invert max-w-none">${i}</article>
      </div>
      ${O}
    </div>
  `},je=(e,r,o="",a="",l={})=>{let n=te(),i=r==="lore",u=i?e.uid:e.id,m=i?e.name||"\u65E0\u6807\u9898\u6761\u76EE":e.script_name||"\u672A\u547D\u540D\u6B63\u5219",h=e.source==="card",d=l.collapseState??"expanded",g=l.isExpanded??!1,v=l.enableDrag??!0,w=l.selectionKey??(i?`lore:${o}:${u}`:`regex:${u}`),M=t.multiSelectTarget,C=t.multiSelectMode&&(M==="entry"&&i||M==="regex"&&!i),T=C&&t.selectedItems.has(w),s="";i?s=`
      <button class="rlh-action-btn-icon rlh-rename-btn" title="\u91CD\u547D\u540D\u5E76\u7F16\u8F91"><i class="fa-solid fa-pencil"></i></button>
      <button class="rlh-toggle-btn rlh-item-toggle" title="\u542F\u7528/\u7981\u7528\u6B64\u6761\u76EE"><i class="fa-solid fa-power-off"></i></button>
      <button class="rlh-action-btn-icon rlh-delete-entry-btn" title="\u5220\u9664\u6761\u76EE"><i class="fa-solid fa-trash-can"></i></button>
    `:h?s='<button class="rlh-toggle-btn rlh-item-toggle" title="\u542F\u7528/\u7981\u7528\u6B64\u6761\u76EE"><i class="fa-solid fa-power-off"></i></button>':s=`
      <button class="rlh-action-btn-icon rlh-rename-btn" title="\u91CD\u547D\u540D\u5E76\u7F16\u8F91"><i class="fa-solid fa-pencil"></i></button>
      <button class="rlh-toggle-btn rlh-item-toggle" title="\u542F\u7528/\u7981\u7528\u6B64\u6761\u76EE"><i class="fa-solid fa-power-off"></i></button>
    `;let k=v&&!h?'<span class="rlh-drag-handle" title="\u62D6\u62FD\u6392\u5E8F"><i class="fa-solid fa-grip-vertical"></i></span>':"",y=C?`<label class="rlh-selection-control"><input type="checkbox" class="rlh-multi-select-checkbox" data-select-key="${I(w)}" ${T?"checked":""}></label>`:"",O=h?"\u6B64\u6761\u76EE\u6765\u81EA\u89D2\u8272\u5361\uFF0C\u90E8\u5206\u64CD\u4F5C\u53D7\u9650":C?"\u70B9\u51FB\u9009\u62E9/\u53D6\u6D88\u9009\u62E9":"\u70B9\u51FB\u5C55\u5F00/\u7F16\u8F91",A=Xe(m,a),_="";if(i){let U=(e.position??"before_character_definition").toString(),j=Ie.position?.[U]??"\u9ED8\u8BA4\u4F4D\u7F6E",q=I(j),oe=Number(e.order),re=Number(e.display_index),de=Number.isFinite(oe)?`#${oe}`:Number.isFinite(re)?`#${re}`:"\u672A\u8BBE\u7F6E",be=I(de);_=`
          <div class="rlh-item-meta" title="\u63D2\u5165\u4E0E\u987A\u5E8F\u4FE1\u606F">
            <span class="rlh-item-meta-chip"><i class="fa-solid fa-map-pin"></i>\u63D2\u5165 ${q}</span>
            <span class="rlh-item-meta-chip"><i class="fa-solid fa-list-ol"></i>\u987A\u5E8F ${be}</span>
          </div>
        `}let B=n(`<div class="rlh-item-container ${h?"from-card":""}" data-type="${r}" data-id="${u}" ${i?`data-book-name="${I(o)}"`:""} data-select-key="${I(w)}">
      <div class="rlh-item-header" title="${O}">
        ${y}
        ${k}
        <div class="rlh-item-header-main">
          <span class="rlh-item-name">${A}</span>
          ${_}
        </div>
        <div class="rlh-item-controls">${s}</div>
      </div>
      <div class="rlh-collapsible-content"></div>
    </div>`);B.data("searchTerm",a),B.attr("data-search-term",typeof a=="string"?a:""),B.toggleClass("enabled",e.enabled),B.toggleClass("selected",T);let z=B.find(".rlh-collapsible-content"),R=l.initialMode;if(!R&&a&&(R="viewer"),g)B.removeClass("rlh-collapsed"),z.show(),B.attr("data-entry-mode","edit");else if(R==="viewer"){let U=i?Ur(e,a):Fr(e,a);z.html(U),z.show(),B.removeClass("rlh-collapsed"),B.attr("data-entry-mode","view")}else d==="collapsed"?(B.addClass("rlh-collapsed"),z.hide(),B.attr("data-entry-mode",R??"collapsed")):(B.removeClass("rlh-collapsed"),B.attr("data-entry-mode",R??"collapsed"));return B},pt=(e,r)=>{let o=te(),a=ie(),l=o(".rlh-entry-list-wrapper",a);if(l.length>0){l.find(".rlh-info-text").remove();let n=je(e,"lore",r,"",{isExpanded:!0});return l.prepend(n),n}return null},fr=()=>{let e=te(),r=ie();e("#rlh-selection-count",r).text(`\u5DF2\u9009\u62E9: ${t.selectedItems.size}`)},bt=(e,r,o,a,l,n)=>{let i="",u="",m="",h=d=>Object.entries(d).filter(([,g])=>g>0).map(([g,v])=>`<li>- ${I(g)}\uFF1A<strong>${v}</strong> \u4E2A</li>`).join("");if(n==="lorebook"){let d=new Set(e.map(w=>w.bookName)).size+(o?.length??0),g=e.length;i=`
      <div class="rlh-replace-stats">
        <p>- \u5171\u5339\u914D\u5230 ${d} \u672C\u4E16\u754C\u4E66\uFF0C\u5176\u4E2D ${g} \u4E2A\u6761\u76EE\u5C06\u88AB\u4FEE\u6539\u3002</p>
        <p>- \u547D\u4E2D\u8BE6\u60C5\uFF1A</p>
        <ul>
          <li>- \u4E66\u540D\uFF1A<strong>${r.bookName}</strong> \u4E2A</li>
          <li>- \u6761\u76EE\u540D\uFF1A<strong>${r.entryName}</strong> \u4E2A</li>
          <li>- \u5173\u952E\u8BCD\uFF1A<strong>${r.keywords}</strong> \u4E2A</li>
          <li>- \u5185\u5BB9\uFF1A<strong>${r.content}</strong> \u4E2A</li>
        </ul>
      </div>
    `,u=`<ul class="rlh-confirm-entry-list">${e.map(({bookName:w,entry:M,matchedFields:C})=>{let T=[];C&&(C.entryName&&T.push("\u6761\u76EE\u540D"),C.keywords>0&&T.push("\u5173\u952E\u8BCD"),C.content&&T.push("\u5185\u5BB9"));let s=T.join("\u3001"),k=I(M.name||"\u65E0\u6807\u9898\u6761\u76EE"),y=s?`\uFF08${s}\uFF09`:"";return`<li class="rlh-confirm-entry-item">${I(w)}: ${k}${y}</li>`}).join("")}</ul>`,o&&o.length>0&&(m=`
        <hr>
        <h4>\u4EC5\u4E66\u540D\u5339\u914D (\u4E0D\u4F1A\u88AB\u66FF\u6362):</h4>
        <div class="rlh-confirm-scroll-list rlh-confirm-scroll-list--secondary">
          <ul class="rlh-confirm-entry-list">${o.map(M=>`<li class="rlh-confirm-entry-item">${I(M)}</li>`).join("")}</ul>
        </div>
      `)}else if(n==="regex"){let d={\u540D\u79F0\u5339\u914D:r.name,\u5185\u5BB9\u5339\u914D:r.content},g=h(d);g&&(i=`<div class="rlh-replace-stats"><h4>\u66FF\u6362\u7EDF\u8BA1\u6458\u8981\uFF1A</h4><ul>${g}</ul></div>`),u=`<ul class="rlh-confirm-entry-list">${e.map(v=>`<li class="rlh-confirm-entry-item">${I(v.script_name||"\u672A\u547D\u540D\u6B63\u5219")}</li>`).join("")}</ul>`}return`
    <div class="rlh-replace-confirm-modal">
      <p>\u786E\u5B9A\u8981\u5C06 <strong>"${I(a)}"</strong> \u66FF\u6362\u4E3A <strong>"${I(l)}"</strong> \u5417\uFF1F</p>
      <p>\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\u3002</p>
      <hr>
      ${i}
      <hr>
      <h4>\u5C06\u8981\u4FEE\u6539\u7684\u6761\u76EE\u5217\u8868\uFF1A</h4>
      <div class="rlh-confirm-scroll-list rlh-overflow-y-auto rlh-max-h-48">
        ${u}
      </div>
      ${m}
    </div>
  `},Lr=()=>{let e=te(),r=ie(),o=e("#regex-lore-hub-save-status",r);if(!o.length)return;let a=t.saveStatus,l="",n="";switch(a){case"saving":l='<i class="fa-solid fa-spinner fa-spin"></i> \u6B63\u5728\u4FDD\u5B58...',n="saving";break;case"retrying":l=`<i class="fa-solid fa-triangle-exclamation fa-fade"></i> \u81EA\u52A8\u4FDD\u5B58\u5931\u8D25\uFF0C\u6B63\u5728\u91CD\u8BD5... (${t.saveRetryAttempt}/3)`,n="retrying";break;case"success":l='<i class="fa-solid fa-check-circle"></i> \u6570\u636E\u5DF2\u4FDD\u5B58',n="success";break;case"failed":l='<i class="fa-solid fa-circle-xmark"></i> \u81EA\u52A8\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u8FDE\u63A5\u6216\u624B\u52A8\u4FDD\u5B58\u3002',n="failed";break;case"idle":default:l="",n="idle";break}o.html(l),o.attr("class",`rlh-save-status ${n}`)},Yt=(e,r)=>{let o=le(e);if(!Array.isArray(o)||!o.length||!Array.isArray(r)||r.length!==o.length)return null;let a=new Map(o.map(n=>[String(n.uid??""),n])),l=[];return r.forEach(n=>{let i=String(n??"");a.has(i)&&(l.push(a.get(i)),a.delete(i))}),l.length?(a.forEach(n=>l.push(n)),l.forEach((n,i)=>{n.display_index=i,(n.order===void 0||n.order===null||Number.isNaN(Number(n.order)))&&(n.order=i)}),_e(e,l),l):null},zr=(e,r,o={})=>{let a=ge();if(!(o.enabled??!1)||!e?.length||!a?.Sortable)return;let n=e[0];!n||e.find(".rlh-item-container").length<2||a.Sortable.create(n,{animation:150,handle:".rlh-drag-handle",ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",onEnd:S(async u=>{let{oldIndex:m,newIndex:h}=u;if(m===h)return;let d=Array.from(n.querySelectorAll(".rlh-item-container")).map(g=>g.getAttribute("data-id")).filter(Boolean);Yt(r,d)&&await Ge()},"RegexLoreHub.Sortable")})};var ut=6,Ke=null,$e=null,Wr=()=>{if(!Ke&&!$e)return;let e=ge();if(Ke){let{type:r,id:o}=Ke;if(r==="idle"&&e?.cancelIdleCallback)e.cancelIdleCallback(o);else if(r==="raf"&&e?.cancelAnimationFrame)e.cancelAnimationFrame(o);else if(r==="timeout"){let a=e?.clearTimeout??(typeof clearTimeout=="function"?clearTimeout:null);a&&a(o)}Ke=null}$e&&($e.remove(),$e=null)},jr=(e,r)=>{let o=Array.isArray(e)?[...e]:[];return r==="status"?o.sort((a,l)=>{let n=Number(l.enabled)-Number(a.enabled);return n!==0?n:(a.name||"").localeCompare(l.name||"","zh")}):o.sort((a,l)=>(a.name||"\u65E0\u6807\u9898\u6761\u76EE").localeCompare(l.name||"\u65E0\u6807\u9898\u6761\u76EE","zh"))},mt=(e,r=!1)=>{let o=[],a=[],l={bookName:0,entryName:0,keywords:0,content:0};if(!e)return{matches:o,stats:l,booksMatchedByNameOnly:a};let n=t.allLorebooks,i=r?"":"i",u=new RegExp(e.replace(/[.*+?^${}()|[\/\\]/g,"\\$&"),i),m=new Set,h=new Set,d=new Set,g=new Set,v=new Set;for(let w of n){let M=le(w.name),C=u.test(w.name),T=!1;C&&m.add(w.name);for(let s of M){let k={bookName:!1,entryName:!1,keywords:0,content:!1},y=!1;if(u.test(s.name||"")&&(h.add(s.uid),k.entryName=!0,y=!0),Array.isArray(s.keys)){let O=s.keys.filter(A=>u.test(A)).length;O>0&&(k.keywords=O,d.add(s.uid),y=!0)}u.test(s.content||"")&&(g.add(s.uid),k.content=!0,y=!0),y&&(T=!0,v.has(s.uid)||(o.push({bookName:w.name,entry:s,matchedFields:k}),v.add(s.uid)))}C&&!T&&a.push(w.name)}return l.bookName=m.size,l.entryName=h.size,l.keywords=d.size,l.content=g.size,{matches:o,stats:l,booksMatchedByNameOnly:a}},ft=(e,r,o)=>{e.view==="global-lore-detail"?qt(e,r,o):Xt(e,r,o)},Xt=(e,r,o)=>{Wr();let a=te(),l=ie(),n=ge(),i=typeof r=="string"?r:"",u=We(e),m=[...t.allLorebooks];if(u==="status"?m.sort((s,k)=>{let y=Number(k.enabled)-Number(s.enabled);return y!==0?y:s.name.localeCompare(k.name,"zh")}):m.sort((s,k)=>s.name.localeCompare(k.name,"zh")),!m.length){o.html(`
      <div class="rlh-empty-state">
        <div class="rlh-empty-icon"><i class="fa-solid fa-book-bookmark"></i></div>
        <h4>\u6CA1\u6709\u4E16\u754C\u4E66</h4>
        <p>\u70B9\u51FB\u53F3\u4E0A\u89D2\u7684\u201C<i class="fa-solid fa-plus"></i>\u201D\u6309\u94AE\u6765\u521B\u5EFA\u4F60\u7684\u7B2C\u4E00\u4E2A\u4E16\u754C\u4E66\u5427\uFF01</p>
      </div>
    `);return}let h=i?m.filter(s=>t.searchFilters.bookName&&s.name.toLowerCase().includes(i)?!0:le(s.name).some(O=>mr(O,i))):m;if(!h.length){o.html('<p class="rlh-info-text">\u672A\u627E\u5230\u5339\u914D\u7684\u4E16\u754C\u4E66\u3002</p>');return}o.empty();let d=h.length,g=d<=ut?d:Math.min(ut,Math.max(3,Math.ceil(d/5))),v=0;$e=d>g?a('<p class="rlh-info-text-small" aria-live="polite"></p>'):null;let w=()=>{if(!$e)return;let s=Math.min(v,d);$e.text(`\u6B63\u5728\u52A0\u8F7D\u4E16\u754C\u4E66\u5217\u8868 (${s}/${d})\uFF0C\u8BF7\u7A0D\u5019...`).appendTo(o)},M=s=>{if(!s.length)return;let k=l&&typeof l.createDocumentFragment=="function"?l.createDocumentFragment():null;k?(s.forEach(y=>k.appendChild(y)),o.append(k)):s.forEach(y=>o.append(y))},C=()=>{let s=Math.min(v+g,d),k=[];for(let y=v;y<s;y++){let A=ht(h[y],r,!0,null).get(0);A&&k.push(A)}if(M(k),v=s,w(),v>=d&&$e){let y=$e;(n?.setTimeout??setTimeout)(()=>{$e===y&&(y.remove(),$e=null)},320)}},T=()=>{let s=()=>{Ke=null,C(),v<d&&T()};n?.requestIdleCallback?Ke={type:"idle",id:n.requestIdleCallback(s,{timeout:120})}:n?.requestAnimationFrame?Ke={type:"raf",id:n.requestAnimationFrame(s)}:Ke={type:"timeout",id:(n?.setTimeout??setTimeout)(s,16)}};C(),v<d?T():$e&&($e.remove(),$e=null)},qt=(e,r,o)=>{Wr();let a=te(),l=e?.activeBookName??t.activeBookName;if(!t.allLorebooks.find(w=>w.name===l)){o.html(`<p class="rlh-info-text">\u9519\u8BEF\uFF1A\u672A\u627E\u5230\u540D\u4E3A "${I(l)}" \u7684\u4E16\u754C\u4E66\u3002</p>`);return}if(t.loadingBookName===l){let w=`
        <div class="rlh-detail-view" data-book-name="${I(l)}">
          <header class="rlh-detail-header">
            <button class="rlh-action-btn-icon rlh-back-to-list-btn" title="\u8FD4\u56DE\u4E16\u754C\u4E66\u5217\u8868"><i class="fa-solid fa-arrow-left"></i></button>
            <h2>${I(l)}</h2>
            <div class="rlh-item-controls">
              <button class="rlh-toolbar-btn rlh-rename-book-btn" title="\u91CD\u547D\u540D\u4E16\u754C\u4E66">\u91CD\u547D\u540D</button>
              <button class="rlh-toolbar-btn rlh-delete-book-btn" title="\u5220\u9664\u4E16\u754C\u4E66">\u5220\u9664</button>
            </div>
          </header>
          <div class="rlh-detail-content">
            <p class="rlh-info-text">\u52A0\u8F7D\u4E2D...</p>
          </div>
        </div>
      `;o.html(w);return}o.append(`<div class="rlh-info-text-small">\u5F53\u524D\u4E16\u754C\u4E66\uFF1A${I(l)}</div>`);let i=We(e),u=Ve(e),m=jr(le(l),i),h=`
        <div class="rlh-detail-view" data-book-name="${I(l)}">
          <header class="rlh-detail-header">
            <button class="rlh-action-btn-icon rlh-back-to-list-btn" title="\u8FD4\u56DE\u4E16\u754C\u4E66\u5217\u8868"><i class="fa-solid fa-arrow-left"></i></button>
            <h2>${I(l)}</h2>
            <div class="rlh-item-controls">
              <button class="rlh-toolbar-btn rlh-rename-book-btn" title="\u91CD\u547D\u540D\u4E16\u754C\u4E66">\u91CD\u547D\u540D</button>
              <button class="rlh-toolbar-btn rlh-delete-book-btn" title="\u5220\u9664\u4E16\u754C\u4E66">\u5220\u9664</button>
            </div>
          </header>
          <div class="rlh-detail-content">
          </div>
        </div>
      `;o.html(h);let d=r?m.filter(w=>mr(w,r)):m,g=o.find(".rlh-detail-content");if(!d.length){let w=m.length?"\u65E0\u5339\u914D\u6761\u76EE":"\u8FD9\u672C\u4E66\u8FD8\u6CA1\u6709\u6761\u76EE\uFF0C\u70B9\u51FB\u5DE5\u5177\u680F\u7684\u201C\u65B0\u5EFA\u6761\u76EE\u201D\u6309\u94AE\uFF0C\u4E3A\u5B83\u6DFB\u52A0\u5185\u5BB9\u3002";g.html(`<p class="rlh-info-text">${w}</p>`);return}let v=`
    <p class="rlh-info-text-small">\u5171 ${m.length} \u4E2A\u6761\u76EE</p>
    <div class="rlh-entry-list-wrapper">
      ${d.map(w=>je(w,"lore",l,r,{collapseState:u,enableDrag:!1}).prop("outerHTML")).join("")}
    </div>
  `;g.html(v)};var gt=(e,r,o)=>{let a=te(),l=t.lorebooks.character,n=t.characterContext.name??"";if(!(t.characterContext.id!==null)){o.html('<p class="rlh-info-text">\u8BF7\u5148\u52A0\u8F7D\u4E00\u4E2A\u89D2\u8272\u4EE5\u7BA1\u7406\u89D2\u8272\u4E16\u754C\u4E66\u3002</p>');return}if(l.length===0){o.html('<p class="rlh-info-text">\u5F53\u524D\u89D2\u8272\u6CA1\u6709\u7ED1\u5B9A\u7684\u4E16\u754C\u4E66\u3002\u70B9\u51FB\u540C\u6B65\u6309\u94AE\u5237\u65B0\u3002</p>');return}let u=t.activeCharacterBook;(!u||!l.includes(u))&&(u=l[0],t.activeCharacterBook=u);let m=We(e),h=Ve(e);if(l.length>1){let v=l.map(w=>`<option value="${I(w)}"${w===u?" selected":""}>${I(w)}</option>`).join("");o.append(`<div class="rlh-book-switcher"><label>\u5F53\u524D\u89D2\u8272\u540D\uFF1A${I(n)}<select id="${_r}" class="rlh-input">${v}</select></label></div>`)}else o.append(`<div class="rlh-info-text-small">\u5F53\u524D\u89D2\u8272\u540D\uFF1A${I(n)}</div>`);let g=(v=>{let w=a(`<div class="rlh-book-group" data-book-name="${I(v)}">
        <div class="rlh-book-group-header">
          <h2 class="rlh-book-group-title">${I(v)}</h2>
          <div class="rlh-item-controls">
            <button class="rlh-toolbar-btn rlh-rename-book-btn" title="\u91CD\u547D\u540D\u4E16\u754C\u4E66">\u91CD\u547D\u540D</button>
            <button class="rlh-toolbar-btn rlh-delete-book-btn" title="\u5220\u9664\u4E16\u754C\u4E66">\u5220\u9664</button>
          </div>
        </div>
        <div class="rlh-entry-list-wrapper"></div>
      </div>`),M=w.find(".rlh-entry-list-wrapper"),C=t.allLorebooks.find(_=>_.name===v);if(C&&!C.entriesLoaded)return C.loadingEntries||(C.loadingEntries=!0,xe(v).finally(()=>{C.loadingEntries=!1,J()})),M.append('<p class="rlh-info-text">\u52A0\u8F7D\u4E2D...</p>'),w;let T=[...le(v)].sort((_,B)=>(_.display_index??Number.MAX_SAFE_INTEGER)-(B.display_index??Number.MAX_SAFE_INTEGER)),s=jr(T,m),k=!r||t.searchFilters.bookName&&v.toLowerCase().includes(r),y=r?s.filter(_=>mr(_,r)):s,O=k&&!r?s:y,A=!1;return O.length?O.forEach(_=>{M.append(je(_,"lore",v,r,{collapseState:h,enableDrag:A}))}):r?M.append('<p class="rlh-info-text-small">\u65E0\u5339\u914D\u6761\u76EE</p>'):M.append('<p class="rlh-info-text-small">\u8FD9\u672C\u4E16\u754C\u4E66\u6682\u65F6\u6CA1\u6709\u6761\u76EE\u3002</p>'),zr(M,v,{enabled:A}),w})(u);g?(g.attr("data-active","true"),o.append(g)):r?o.append('<p class="rlh-info-text">\u672A\u627E\u5230\u5339\u914D\u7684\u6761\u76EE\u3002</p>'):o.append('<p class="rlh-info-text">\u672A\u80FD\u52A0\u8F7D\u5F53\u524D\u4E16\u754C\u4E66\uFF0C\u8BF7\u5C1D\u8BD5\u5237\u65B0\u6570\u636E\u3002</p>')};var xt=(e,r,o)=>{let a=te(),l=t.chatLorebook,n=ge(),i=t.characterContext.name??"";if(!(n.SillyTavern?.getContext?.()?.chatId!==null)){o.html('<p class="rlh-info-text">\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A\u804A\u5929\u4EE5\u7BA1\u7406\u804A\u5929\u4E16\u754C\u4E66\u3002</p>');return}if(!l){o.html(`
      <div class="rlh-chat-lore-empty">
        <p class="rlh-info-text">\u5F53\u524D\u804A\u5929\u6CA1\u6709\u7ED1\u5B9A\u7684\u4E16\u754C\u4E66\u3002</p>
        <button class="rlh-action-btn" id="rlh-create-chat-lore-btn"><i class="fa-solid fa-plus"></i> \u521B\u5EFA\u5E76\u7ED1\u5B9A\u804A\u5929\u4E16\u754C\u4E66</button>
      </div>
    `);return}o.append(`<div class="rlh-info-text-small">\u5F53\u524D\u804A\u5929\u89D2\u8272\u540D\uFF1A${I(i)}</div>`);let m=We(e),h=Ve(e),d=a(`<div class="rlh-book-group" data-book-name="${I(l)}">
      <div class="rlh-book-group-header">
        <h2 class="rlh-book-group-title">${I(l)} (\u804A\u5929\u4E13\u7528)</h2>
        <div class="rlh-item-controls">
          <button class="rlh-toolbar-btn rlh-rename-book-btn" title="\u91CD\u547D\u540D\u4E16\u754C\u4E66">\u91CD\u547D\u540D</button>
          <button class="rlh-toolbar-btn rlh-unlink-chat-lore-btn" title="\u89E3\u9664\u7ED1\u5B9A">\u89E3\u9664\u7ED1\u5B9A</button>
        </div>
      </div>
      <div class="rlh-entry-list-wrapper"></div>
    </div>`),g=d.find(".rlh-entry-list-wrapper"),v=t.allLorebooks.find(s=>s.name===l);if(v&&!v.entriesLoaded){v.loadingEntries||(v.loadingEntries=!0,xe(l).finally(()=>{v.loadingEntries=!1,J()})),g.append('<p class="rlh-info-text">\u52A0\u8F7D\u4E2D...</p>'),o.append(d);return}let w=[...le(l)].sort((s,k)=>(s.display_index??Number.MAX_SAFE_INTEGER)-(k.display_index??Number.MAX_SAFE_INTEGER)),M=jr(w,m),C=r?M.filter(s=>mr(s,r)):M,T=!1;if(C.length)C.forEach(s=>{g.append(je(s,"lore",l,r,{collapseState:h,enableDrag:T}))});else{let s=M.length?"\u65E0\u5339\u914D\u6761\u76EE":"\u8FD9\u672C\u4E66\u8FD8\u6CA1\u6709\u6761\u76EE\u3002";g.append(`<p class="rlh-info-text-small">${s}</p>`)}zr(g,l,{enabled:T}),o.append(d)},vt=()=>Wr();var Vt=(e,r)=>{let o=Array.isArray(e)?[...e]:[];return r==="status"?o.sort((a,l)=>{let n=Number(l.enabled)-Number(a.enabled);return n!==0?n:(a.script_name||"").localeCompare(l.script_name||"","zh")}):r==="name"?o.sort((a,l)=>(a.script_name||"").localeCompare(l.script_name||"","zh")):o},yt=(e,r=!1)=>{let o=[],a={name:0,content:0};if(!e)return{matches:o,stats:a};let l=[...t.regexes.global,...t.regexes.character],n=r?"":"i",i=new RegExp(e.replace(/[.*+?^${}()|[\/\\]/g,"\\$&"),n),u=new Set,m=new Set,h=new Set;for(let d of l){let g=!1;i.test(d.script_name||"")&&(u.add(d.script_name),g=!0);let v=`${d.find_regex||""} ${d.replace_string||""}`;i.test(v)&&(m.add(d.script_name),g=!0),g&&!h.has(d.id)&&(o.push(d),h.add(d.id))}return a.name=u.size,a.content=m.size,{matches:o,stats:a}},Tr=(e,r,o,a,l)=>{let n=te(),i=ge(),u=We(e),m=Ve(e),h=Vt(r??[],u),d=l??(e.id==="char-regex"?"\u89D2\u8272\u6B63\u5219":"\u5168\u5C40\u6B63\u5219");if(e.id==="char-regex"){let T=i.SillyTavern?.getContext?.()||{};if(!(T.characterId!==void 0&&T.characterId!==null)){a.html('<p class="rlh-info-text">\u8BF7\u5148\u52A0\u8F7D\u4E00\u4E2A\u89D2\u8272\u4EE5\u7BA1\u7406\u89D2\u8272\u6B63\u5219\u3002</p>');return}}if(!h.length){a.html(`<p class="rlh-info-text">\u6CA1\u6709${d}\u3002\u70B9\u51FB\u540C\u6B65\u6309\u94AE\u5237\u65B0\u3002</p>`);return}let g=o?h.filter(T=>dt(T,o)):h;if(!g.length){a.html(`<p class="rlh-info-text">\u6CA1\u6709\u5339\u914D\u7684${d}\u3002</p>`);return}let v=`rlh-regex-list-${e.id}`,w=n(`<div id="${v}" class="rlh-regex-list"></div>`);a.append(w);let M=!o;g.forEach((T,s)=>{let k=je(T,"regex","",o,{collapseState:m,selectionKey:`regex:${T.id}`,enableDrag:M});k.find(".rlh-item-name").prepend(`<span class="rlh-order-indicator">#${s+1}</span> `),w.append(k)});let C=w[0];if(M&&C&&i.Sortable){let T=i.Sortable.create(C,{animation:150,handle:".rlh-drag-handle",forceFallback:!0,fallbackOnBody:!0,fallbackTolerance:6,delayOnTouchOnly:!0,touchStartThreshold:8,fallbackClass:"rlh-sorting-fallback",onStart:()=>{w.addClass("sorting-active")},onEnd:S(async s=>{w.removeClass("sorting-active");let{oldIndex:k,newIndex:y}=s;if(k===y)return;let O=e.id==="global-regex"?"global":"character",A=t.regexes[O];if(!Array.isArray(A))return;let[_]=A.splice(k,1);_&&(A.splice(y,0,_),Be(A),t.pendingRegexUpdates instanceof Set||(t.pendingRegexUpdates=new Set),t.pendingRegexUpdates.add(O),await Ge({silent:!0}),a.empty(),Tr(e,A,o,a,l))},"RegexLoreHub.RegexSortable")})}};var Qt=e=>e?.toString().trim().toLowerCase()??"",Ae=()=>{let e=t.activeTab,r=t.activeView,o={tab:e,view:r,id:`${e}`,instanceKey:`${e}`,activeBookName:t.activeBookName,type:"lore",scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u89C6\u56FE",replaceScopeLabel:"\u5728\u5F53\u524D\u89C6\u56FE\u4E2D\u66FF\u6362",searchPlaceholder:"\u641C\u7D22...",visibleFilters:["entryName","keywords","content"],filterLabels:lr,defaultFilters:{entryName:!0,keywords:!0,content:!0},showReplace:!0,showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!1,showPositionMenu:!1,sortOptions:[],multiSelectTarget:"entry",supportsMultiSelect:!0,primaryAction:{visible:!1}};if(e==="global-lore"){if(r==="global-lore-detail"){let a=t.activeBookName??"";return{...o,id:"global-lore-detail",instanceKey:a?`global-lore-detail:${a}`:"global-lore-detail",activeBookName:a,scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u4E16\u754C\u4E66",replaceScopeLabel:"\u5728\u5F53\u524D\u4E16\u754C\u4E66\u4E2D\u66FF\u6362",searchPlaceholder:"\u641C\u7D22...",visibleFilters:["bookName","entryName","keywords","content"],defaultFilters:{bookName:!1,entryName:!0,keywords:!0,content:!0},showRecursion:!0,showFixKeywords:!0,showCollapseToggle:!0,showPositionMenu:!0,sortOptions:["status","name"],multiSelectTarget:"entry",primaryAction:{visible:!0,icon:"fa-file-circle-plus",label:"\u65B0\u5EFA\u6761\u76EE",title:"\u65B0\u5EFA\u6761\u76EE",scope:"entry"}}}return{...o,id:"global-lore-list",instanceKey:"global-lore-list",activeBookName:null,scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u5168\u90E8\u4E16\u754C\u4E66",replaceScopeLabel:"\u5728\u5339\u914D\u5230\u7684\u4E16\u754C\u4E66\u6216\u6761\u76EE\u4E2D\u66FF\u6362",visibleFilters:["bookName","entryName","keywords","content"],defaultFilters:{bookName:!0,entryName:!0,keywords:!0,content:!0},showReplace:!0,showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!1,showPositionMenu:!1,showCleanOrphanBooks:!0,sortOptions:["status","name"],multiSelectTarget:"book",primaryAction:{visible:!0,icon:"fa-plus",label:"\u65B0\u5EFA\u4E16\u754C\u4E66",title:"\u65B0\u5EFA\u4E16\u754C\u4E66",scope:"book"}}}return e==="char-lore"?{...o,id:"char-lore",instanceKey:"char-lore",activeBookName:t.activeCharacterBook,scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u4E16\u754C\u4E66",replaceScopeLabel:"\u5728\u5F53\u524D\u4E16\u754C\u4E66\u4E2D\u66FF\u6362",visibleFilters:["entryName","keywords","content"],defaultFilters:{bookName:!1,entryName:!0,keywords:!0,content:!0},showRecursion:!0,showFixKeywords:!0,showCollapseToggle:!0,showPositionMenu:!0,sortOptions:["status","name"],multiSelectTarget:"entry",primaryAction:{visible:!0,icon:"fa-file-circle-plus",label:"\u65B0\u5EFA\u6761\u76EE",title:"\u65B0\u5EFA\u6761\u76EE",scope:"entry"}}:e==="chat-lore"?{...o,id:"chat-lore",instanceKey:"chat-lore",activeBookName:t.chatLorebook,scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u4E16\u754C\u4E66",replaceScopeLabel:"\u5728\u5F53\u524D\u4E16\u754C\u4E66\u4E2D\u66FF\u6362",visibleFilters:["entryName","keywords","content"],defaultFilters:{bookName:!1,entryName:!0,keywords:!0,content:!0},showRecursion:!0,showFixKeywords:!0,showCollapseToggle:!0,showPositionMenu:!0,sortOptions:["status","name"],multiSelectTarget:"entry",primaryAction:{visible:!0,icon:"fa-file-circle-plus",label:"\u65B0\u5EFA\u6761\u76EE",title:"\u65B0\u5EFA\u6761\u76EE",scope:"entry"}}:e==="global-regex"?{...o,id:"global-regex",instanceKey:"global-regex",type:"regex",scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u5168\u5C40\u6B63\u5219\u8868\u8FBE\u5F0F",replaceScopeLabel:"\u5728\u5168\u5C40\u6B63\u5219\u4E2D\u66FF\u6362",visibleFilters:["entryName","content"],filterLabels:{...lr,...Br},defaultFilters:{bookName:!1,entryName:!0,keywords:!1,content:!0},showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!0,showPositionMenu:!1,sortOptions:[],multiSelectTarget:"regex",supportsMultiSelect:!1,primaryAction:{visible:!1}}:e==="char-regex"?{...o,id:"char-regex",instanceKey:"char-regex",type:"regex",scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u89D2\u8272\u6B63\u5219\u8868\u8FBE\u5F0F",replaceScopeLabel:"\u5728\u89D2\u8272\u6B63\u5219\u4E2D\u66FF\u6362",visibleFilters:["entryName","content"],filterLabels:{...lr,...Br},defaultFilters:{bookName:!1,entryName:!0,keywords:!1,content:!0},showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!0,showPositionMenu:!1,sortOptions:[],multiSelectTarget:"regex",supportsMultiSelect:!1,primaryAction:{visible:!1}}:{...o,id:"unknown",instanceKey:"unknown",supportsMultiSelect:!1}},Jt=e=>{let r=e.id;r&&(t.searchFilterContextsInitialized.has(r)||((e.visibleFilters??[]).forEach(o=>{t.searchFilters[o]=!0}),t.searchFilterContextsInitialized.add(r)),(e.id==="char-lore"||e.id==="chat-lore")&&t.searchFilters.keywords===void 0&&(t.searchFilters.keywords=!0))},J=()=>{let e=te(),r=ie(),o=e(`#${ne}`,r),a=()=>{if(!o.length){let C=e([]);return{$toolbarRow:C,$toolbar:C,$replaceContainer:C,$content:C}}let d=o.find(".rlh-toolbar-shell").first();if(!d.length){let C=o.find(".rlh-tab-nav").first();d=e('<div class="rlh-toolbar-shell"></div>'),C.length?d.insertAfter(C):o.prepend(d)}let g=d.find(`#${hr}`);g.length||(g=e(`<div id="${hr}" class="rlh-toolbar-container"></div>`),d.append(g));let v=d.find(`#${pr}`);v.length||(v=e(`<div id="${pr}" class="rlh-replace-container"></div>`),d.append(v));let w=o.find(".rlh-content-pane").first();w.length||(w=e('<div class="rlh-content-pane"></div>'),w.insertAfter(d));let M=w.find(`#${ne}-content`);return M.length||(M=e(`<div id="${ne}-content"></div>`),w.append(M)),{$toolbarRow:d,$toolbar:g,$replaceContainer:v,$content:M}},l=Qt(t.globalSearch.term??"");[["bookName","#rlh-filter-book-name"],["entryName","#rlh-filter-entry-name"],["keywords","#rlh-filter-keywords"],["content","#rlh-filter-content"]].forEach(([d,g])=>{let v=o.find(g);v.length&&(t.searchFilters[d]=v.is(":checked"))});let{$toolbar:i,$replaceContainer:u,$content:m}=a();i.empty(),u.empty(),m.empty();let h=Ae();if(Jt(h),h.tab!=="global-lore"&&vt(),!h.supportsMultiSelect&&t.multiSelectMode&&(t.multiSelectMode=!1,t.selectedItems.clear()),t.multiSelectMode?t.multiSelectTarget!==h.multiSelectTarget&&(t.multiSelectTarget=h.multiSelectTarget,t.selectedItems.clear()):t.multiSelectTarget=h.multiSelectTarget,o.toggleClass("rlh-multi-select-mode",t.multiSelectMode),ct(h,{$toolbar:i,$replaceContainer:u}),Lr(),fr(),t.isLoadingTabData){m.html('<p class="rlh-info-text">\u52A0\u8F7D\u4E2D...</p>');return}switch(h.tab){case"global-lore":ft(h,l,m);break;case"char-lore":gt(h,l,m);break;case"chat-lore":xt(h,l,m);break;case"global-regex":Tr(h,t.regexes.global,l,m,"\u5168\u5C40\u6B63\u5219");break;case"char-regex":Tr(h,t.regexes.character,l,m,"\u89D2\u8272\u6B63\u5219");break;default:m.html('<p class="rlh-info-text">\u5F53\u524D\u89C6\u56FE\u672A\u5B9E\u73B0\u3002</p>');break}};var Ir=Object.freeze({and_any:0,not_all:1,not_any:2,and_all:3}),Nr=Object.freeze({0:"and_any",1:"not_all",2:"not_any",3:"and_all"}),Zt=Object.freeze({system:0,user:1,assistant:2}),kt=Object.freeze({0:"system",1:"user",2:"assistant"}),Gr=Object.freeze({before_character_definition:{type:"before_character_definition"},after_character_definition:{type:"after_character_definition"},before_example_messages:{type:"before_example_messages"},after_example_messages:{type:"after_example_messages"},before_author_note:{type:"before_author_note"},after_author_note:{type:"after_author_note"},at_depth_as_system:{type:"at_depth",role:"system"},at_depth_as_assistant:{type:"at_depth",role:"assistant"},at_depth_as_user:{type:"at_depth",role:"user"}}),eo=Object.freeze({0:"before_character_definition",1:"after_character_definition",2:"before_author_note",3:"after_author_note",4:"at_depth_as_system",5:"before_example_messages",6:"after_example_messages"}),Rr=Object.freeze({before_char:"before_character_definition",after_char:"after_character_definition",before_an:"before_author_note",after_an:"after_author_note",before_em:"before_example_messages",after_em:"after_example_messages",at_depth:"at_depth_as_system",depth_system:"at_depth_as_system",depth_character:"at_depth_as_assistant",depth_user:"at_depth_as_user"}),nr=e=>e?JSON.parse(JSON.stringify(e)):{},vr=e=>Array.isArray(e)?e.map(r=>{if(typeof r=="string")return r.trim();if(r instanceof RegExp)return r.source;if(r&&typeof r=="object"){if(typeof r.pattern=="string")return r.pattern.trim();if(typeof r.source=="string")return r.source.trim()}if(r!=null&&typeof r.toString=="function"){let o=r.toString();return typeof o=="string"?o.trim():""}return""}).filter(Boolean):[],ro=["order","displayIndex","display_index","sort_order","script_order"],Be=(e=[])=>{!Array.isArray(e)||e.length===0||e.forEach((r,o)=>{!r||typeof r!="object"||r.source==="card"||(ro.forEach(a=>{r[a]=o}),r?.position&&typeof r.position=="object"&&"order"in r.position&&(r.position.order=o))})},to=e=>{if(!Array.isArray(e)||e.length===0)return e;let r=new Map([["global",[]],["character",[]]]);return e.forEach(o=>{if(!o||typeof o!="object"||o.source==="card")return;let a=o.scope==="character"?"character":"global";r.get(a).push(o)}),r.forEach(o=>Be(o)),e},xr=e=>{if(e===!0||e===!1)return e;if(e==null)return!1;if(typeof e=="string"){let r=e.trim().toLowerCase();return["1","true","yes","on"].includes(r)}return!!e},Se=e=>{if(e===""||e===null||e===void 0)return null;let r=Number(e);return Number.isNaN(r)?null:r},$t=e=>{if(e==null)return"and_any";if(typeof e=="number"&&!Number.isNaN(e))return Nr[e]??Nr[e.toString()]??"and_any";let r=e.toString().trim().toLowerCase();return Ir[r]!==void 0?r:Nr[r]!==void 0?Nr[r]:"and_any"};var ir=e=>{if(typeof e=="string"){let r=e.trim().toLowerCase();if(Zt[r]!==void 0)return r}if(typeof e=="number"&&!Number.isNaN(e)){let r=kt[e]??kt[e.toString()];if(r)return r}return null},Xr=(e,r)=>{if(e==null)return"before_character_definition";if(typeof e=="object"&&e!==null){if(typeof e.type=="string"&&e.type){let o=(Rr[e.type]??e.type).trim();if(o==="at_depth"||o==="at_depth_as_system"){let a=ir(e.role??r)??"system";return a==="assistant"?"at_depth_as_assistant":a==="user"?"at_depth_as_user":"at_depth_as_system"}return o.startsWith("at_depth_as_"),o}if(typeof e.position=="number"&&!Number.isNaN(e.position))return Xr(e.position,e.role??r)}if(typeof e=="string"){let o=(Rr[e]??e).trim();if(o==="at_depth"){let a=ir(r)??"system";return a==="assistant"?"at_depth_as_assistant":a==="user"?"at_depth_as_user":"at_depth_as_system"}return o}if(typeof e=="number"&&!Number.isNaN(e)){if(e===4){let a=ir(r)??"system";return a==="assistant"?"at_depth_as_assistant":a==="user"?"at_depth_as_user":"at_depth_as_system"}let o=eo[e];if(o)return o}return"before_character_definition"};var Et=(e,{fallbackRole:r=null,fallbackDepth:o=null,fallbackOrder:a=null}={})=>{let l=ir(r),n={type:"before_character_definition",role:null,depth:null,order:Se(a),uiKey:"before_character_definition"},i=h=>{let d=Se(h);d!==null&&(n.order=d)},u=h=>{let d=Se(h);d!==null&&(n.depth=d)};if(i(a),u(o),e&&typeof e=="object"){if(typeof e.type=="string"&&e.type){let h=(Rr[e.type]??e.type).trim();n.type=h==="at_depth_as_system"?"at_depth":h;let d=ir(e.role)??l;return n.type==="at_depth"?(n.role=d??"system",u(e.depth),n.uiKey=n.role==="assistant"?"at_depth_as_assistant":n.role==="user"?"at_depth_as_user":"at_depth_as_system"):(n.role=null,n.depth=null,n.uiKey=n.type),i(e.order),n}if(typeof e.position=="number"&&!Number.isNaN(e.position)){let h=ir(e.role)??l,d=Xr(e.position,h);return n.uiKey=d,d.startsWith("at_depth")?(n.type="at_depth",n.role=h??"system",u(e.depth)):(n.type=d,n.role=null,n.depth=null),i(e.order),n}}let m=Xr(e,l);return n.uiKey=m,m.startsWith("at_depth")?(n.type="at_depth",n.role=m==="at_depth_as_assistant"?"assistant":m==="at_depth_as_user"?"user":"system",n.depth===null&&(n.depth=Se(o))):(n.type=m,n.role=null,n.depth=null),n},oo=(e,{depth:r,order:o,basePosition:a}={})=>{let l=Et(a??null),n=(Rr[e]??e??l.uiKey).toString().trim()||l.uiKey||"before_character_definition",i=Gr[n]??Gr[l.uiKey]??Gr.before_character_definition,u={type:i.type},m=Se(o),h=m!==null?m:l.order!==null&&l.order!==void 0?l.order:0;if(u.order=h,i.type==="at_depth"){let d=i.role??l.role??"system";u.role=d;let g=Se(r),v=g!==null?g:l.depth!==null&&l.depth!==void 0?l.depth:0;u.depth=v}return u},Pe=e=>{if(!e||typeof e!="object")return e;let r=nr(e);(!r.strategy||typeof r.strategy!="object")&&(r.strategy={});let o=r.strategy,a=vr(o.keys??r.keys??r.key??r.keywords);o.keys=[...a],r.keys=[...a],r.key=[...a],r.keywords=[...a];let l=vr(o.keys_secondary?.keys??r.keysecondary??r.key_secondary??[]);(!o.keys_secondary||typeof o.keys_secondary!="object")&&(o.keys_secondary={logic:"and_any",keys:[]}),o.keys_secondary.keys=[...l],r.keysecondary=[...l];let n=$t(o.keys_secondary.logic??r.logic??r.selectiveLogic);o.keys_secondary.logic=n,r.logic=n,r.selectiveLogic=Ir[n];let i=Et(r.position,{fallbackRole:r.role,fallbackDepth:r.depth,fallbackOrder:r.order??r.insertion_order??r.displayIndex});r.position=i.uiKey,r.depth=i.type==="at_depth"?i.depth??0:null,r.order=i.order??0,r.role=i.role;let u=Se(r.probability);return r.probability=u===null?100:u,(!r.recursion||typeof r.recursion!="object")&&(r.recursion={prevent_incoming:!1,prevent_outgoing:!1,delay_until:null}),r.prevent_recursion=xr(r.prevent_recursion??r.preventRecursion??r.recursion.prevent_outgoing),r.exclude_recursion=xr(r.exclude_recursion??r.excludeRecursion??r.recursion.prevent_incoming),r.recursion.prevent_outgoing=r.prevent_recursion,r.recursion.prevent_incoming=r.exclude_recursion,r.case_sensitive=xr(r.case_sensitive??r.caseSensitive??!1),r.caseSensitive=r.case_sensitive,r.match_whole_words=xr(r.match_whole_words??r.matchWholeWords??!1),r.matchWholeWords=r.match_whole_words,r.enabled=r.disable!==void 0?!r.disable:r.enabled??!0,r},lo=(e,r={})=>{let o=nr(r),a=nr(e),l=Se(a.uid);l!==null&&(o.uid=l),a.name!==void 0&&(o.name=a.name),a.comment!==void 0&&(o.comment=a.comment),a.content!==void 0&&(o.content=a.content),(!o.strategy||typeof o.strategy!="object")&&(o.strategy={});let n=o.strategy,i=vr(a.keys??n.keys??o.keys??o.key??o.keywords);n.keys=[...i],o.keys=[...i],o.key=[...i],o.keywords=[...i];let u=vr(a.keysecondary??n.keys_secondary?.keys??o.keysecondary);(!n.keys_secondary||typeof n.keys_secondary!="object")&&(n.keys_secondary={logic:"and_any",keys:[]}),n.keys_secondary.keys=[...u],o.keysecondary=[...u];let m=$t(a.logic??n.keys_secondary.logic??o.logic??o.selectiveLogic);n.keys_secondary.logic=m,o.logic=m,o.selectiveLogic=Ir[m],a.enabled!==void 0&&(o.enabled=!!a.enabled,o.disable=!o.enabled);let h=Se(a.probability);h!==null?(o.probability=h,o.useProbability=h!==100):o.probability!==void 0&&(o.useProbability=o.probability!==100);let d=Se(a.order),g=Se(a.depth),v=oo(a.position??o.position,{depth:g,order:d,basePosition:o.position});o.position=v,v.type==="at_depth"?(o.depth=v.depth??0,o.role=v.role??"system"):(o.depth=null,o.role=null),v.order!==void 0&&(o.order=v.order,o.insertion_order=v.order,o.displayIndex=v.order),(!o.recursion||typeof o.recursion!="object")&&(o.recursion={prevent_incoming:!1,prevent_outgoing:!1,delay_until:null});let w=o.recursion;a.prevent_recursion!==void 0&&(w.prevent_outgoing=!!a.prevent_recursion),a.exclude_recursion!==void 0&&(w.prevent_incoming=!!a.exclude_recursion),o.preventRecursion=w.prevent_outgoing,o.prevent_recursion=w.prevent_outgoing,o.excludeRecursion=w.prevent_incoming,o.exclude_recursion=w.prevent_incoming;let M=(s,k)=>s===void 0?k:xr(s),C=M(a.case_sensitive,o.caseSensitive??o.case_sensitive);C!==void 0&&(o.caseSensitive=C,o.case_sensitive=C);let T=M(a.match_whole_words,o.matchWholeWords??o.match_whole_words);return T!==void 0&&(o.matchWholeWords=T,o.match_whole_words=T),o},St=e=>{if(typeof e=="number"&&Number.isInteger(e))return e;let r=Number(e);return Number.isInteger(r)?r:null},ao=e=>vr(e),wt=e=>{if(!e)return!1;let r=String(e?.message??e??"").toLowerCase();return r.includes("\u672A\u627E\u5230\u540D\u4E3A")||r.includes("character")&&r.includes("not found")},H={createWorldbook:S(async e=>await pe().createWorldbook(e,[])),deleteWorldbook:S(async e=>await pe().deleteWorldbook(e)),getWorldbooks:S(async()=>await pe().getWorldbookNames()),getCharData:S(async()=>await pe().getCharData()),getRegexes:S(async()=>await pe().getTavernRegexes({scope:"all"})),replaceRegexes:S(async(e,r={})=>{let o=r?.scope??"all",a=Array.isArray(e)?e:[];to(a),await pe().replaceTavernRegexes(a,{scope:o})}),getGlobalWorldbookNames:S(async()=>await pe().getGlobalWorldbookNames()),rebindGlobalWorldbooks:S(async e=>await pe().rebindGlobalWorldbooks(e)),getCharWorldbookNames:S(async e=>{try{let r=e?.name;return r?await pe().getCharWorldbookNames(r):(console.warn("[RegexLoreHub] getCharWorldbookNames \u8C03\u7528\u7F3A\u5C11\u89D2\u8272\u540D\u79F0\u3002"),null)}catch(r){if(wt(r))return console.warn("[RegexLoreHub] \u672A\u627E\u5230\u6307\u5B9A\u89D2\u8272\u5361\uFF0C\u8DF3\u8FC7\u89D2\u8272\u4E16\u754C\u4E66\u52A0\u8F7D\u3002",r),null;throw r}}),getCurrentCharWorldbookNames:S(async()=>{try{return await pe().getCharWorldbookNames("current")}catch(e){if(wt(e))return console.warn("[RegexLoreHub] \u672A\u627E\u5230\u5F53\u524D\u89D2\u8272\u5361\uFF0C\u8DF3\u8FC7\u89D2\u8272\u4E16\u754C\u4E66\u52A0\u8F7D\u3002",e),null;throw e}}),getChatWorldbookName:S(async()=>await pe().getChatWorldbookName("current")),getOrCreateChatWorldbook:S(async e=>await pe().getOrCreateChatWorldbook("current",e)),rebindChatWorldbook:S(async e=>await pe().rebindChatWorldbook("current",e)),getWorldbook:S(async e=>await pe().getWorldbook(e)),updateWorldbookWith:S(async(e,r)=>await pe().updateWorldbookWith(e,r)),replaceWorldbook:S(async(e,r)=>await pe().replaceWorldbook(e,r)),createWorldbookEntries:S(async(e,r)=>await pe().createWorldbookEntries(e,r)),deleteWorldbookEntries:S(async(e,r)=>{let o=new Set(r);return await pe().deleteWorldbookEntries(e,a=>o.has(a.uid))}),saveSettings:S(async()=>await pe().builtin.saveSettings()),rebindCharWorldbooks:S(async e=>await pe().rebindCharWorldbooks("current",e)),get Character(){return pe().Character}},Me=S(async(e,r)=>{if(!Array.isArray(r)||r.length===0)return;let o=new Map,a=new Set;if(r.forEach(h=>{if(!h||typeof h!="object")return;let d=Se(h.uid);if(d===null)return;a.add(d);let g=o.get(d)??{};o.set(d,{...g,...h})}),a.size===0)return;let l=le(e),n=new Map(l.map(h=>[Se(h?.uid),h]).filter(([h])=>h!==null)),i=h=>h.map(d=>{let g=Se(d?.uid);if(g===null||!a.has(g))return d;let v=n.get(g);if(!v)return d;let w=nr(v),M=o.get(g);return M&&typeof M=="object"&&Object.entries(M).forEach(([C,T])=>{C==="uid"||C==="tempUid"||(Array.isArray(T)?w[C]=T.map(s=>typeof s=="object"&&s!==null?nr(s):s):T&&typeof T=="object"?w[C]=nr(T):w[C]=T)}),lo(w,d)}),u=await H.updateWorldbookWith(e,i),m=Array.isArray(u)?u.map(Pe):[];return _e(e,m),Qe(e),await H.saveSettings(),u}),no=e=>(t.pendingLorebookUpdates.has(e)||t.pendingLorebookUpdates.set(e,new Map),t.pendingLorebookUpdates.get(e)),Ct=(e,r,o={})=>{if(!e||!o||typeof o!="object")return;let a=St(r),l=String(r),n=no(e),i=n.get(l)??{uid:a,tempUid:a==null?l:null,data:{}};a!=null&&(i.uid=a),(!i.data||typeof i.data!="object")&&(i.data={});let u={...o};Array.isArray(u.keys)&&(u.keys=ao(u.keys)),Object.entries(u).forEach(([m,h])=>{h!==void 0&&(i.data[m]=h)}),n.set(l,i)},Lt=e=>{e!=null&&t.pendingRegexUpdates.add(e)},io=(e,r,o)=>{let a=St(o);if(!e||r==null||a==null)return;let l=t.pendingLorebookUpdates.get(e);if(!l||!(l instanceof Map))return;let n=String(r),i=l.get(n);if(!i)return;l.delete(n);let u=String(a),m=l.get(u)??{uid:a,tempUid:null,data:{}};m.uid=a,(!m.data||typeof m.data!="object")&&(m.data={}),i.data&&typeof i.data=="object"&&(m.data={...i.data,...m.data}),l.set(u,m)},gr=null,so=async()=>{let e=te(),r=ie(),o=ge(),a=pe(),l=e(`#${ne}-content`,r);yr();let i=(()=>{l.html(`
      <div class="rlh-loading">
        <div class="rlh-loading-spinner" aria-hidden="true"></div>
        <div class="rlh-loading-text">
          <p class="rlh-loading-title">\u6B63\u5728\u52A0\u8F7D\u6570\u636E...</p>
          <p class="rlh-loading-status">\u521D\u59CB\u5316...</p>
          <div class="rlh-loading-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div class="rlh-loading-bar-inner"></div>
          </div>
          <div class="rlh-loading-progress">0%</div>
          <p class="rlh-loading-detail"></p>
        </div>
      </div>
    `);let g=l.find(".rlh-loading-status"),v=l.find(".rlh-loading-detail"),w=l.find(".rlh-loading-progress"),M=l.find(".rlh-loading-bar-inner"),C=l.find(".rlh-loading-bar"),T=1,s=0,k=()=>{let y=Math.max(1,T),O=Math.min(s/y,1),A=Math.round(O*100);M.css("width",`${A}%`),C.attr("aria-valuenow",A),w.text(`${A}%`)};return k(),{setProgress(y,O,A,_){T=Math.max(1,O),s=Math.max(0,Math.min(y,T)),A&&g.text(A),_!==void 0&&v.text(_),k()},setStatus(y,O){y&&g.text(y),O!==void 0&&v.text(O)}}})(),u=4,m=0,h=(d,g)=>{m=Math.min(m+1,u),i.setProgress(m,u,d,g)};i.setProgress(m,u,"\u51C6\u5907\u52A0\u8F7D\u6570\u636E...","\u6B63\u5728\u68C0\u67E5\u8FD0\u884C\u73AF\u5883");try{if(!o.SillyTavern||!o.SillyTavern.getContext){console.warn("[RegexLoreHub] SillyTavern API not available, initializing with empty data"),t.regexes.global=[],t.regexes.character=[],t.allLorebooks=[],t.lorebooks.character=[],t.chatLorebook=null,Dr(),t.isDataLoaded=!0,J();return}h("\u83B7\u53D6\u57FA\u7840\u6570\u636E...","\u6B63\u5728\u5411 SillyTavern \u8BF7\u6C42\u6570\u636E");let d=o.SillyTavern?.getContext?.()||{},g=Array.isArray(d.characters)?d.characters:[],v=d.characterId!==void 0&&d.characterId!==null,w=d.chatId!==void 0&&d.chatId!==null,M=null,C=null,T=null,s=[H.getRegexes().catch(()=>[]),H.getGlobalWorldbookNames().catch(()=>[]),H.getWorldbooks().catch(()=>[])];v?(s.push(H.getCharData().catch(()=>null)),s.push(H.getCurrentCharWorldbookNames().catch(()=>null))):s.push(Promise.resolve(null),Promise.resolve(null)),w?s.push(H.getChatWorldbookName().catch(R=>(console.warn("[RegexLoreHub] Failed to get chat worldbook:",R),null))):s.push(Promise.resolve(null));let k=await Promise.allSettled(s);h("\u89E3\u6790\u6570\u636E\u7ED3\u6784...",`\u68C0\u6D4B\u5230 ${g.length} \u4E2A\u89D2\u8272\uFF0C\u6B63\u5728\u6574\u7406\u6570\u636E`);let y=k[0].status==="fulfilled"?k[0].value:[],O=k[1].status==="fulfilled"?k[1].value:[],A=k[2].status==="fulfilled"?k[2].value:[];M=k[3]?.status==="fulfilled"?k[3].value:null,C=k[4]?.status==="fulfilled"?k[4].value:null,T=k[5]?.status==="fulfilled"?k[5].value:null,yr({charData:M}),t.regexes.global=Array.isArray(y)?y.filter(R=>R.scope==="global"):[],Be(t.regexes.global),At(y,M),Dr(),t.pendingLorebookUpdates instanceof Map?t.pendingLorebookUpdates.clear():t.pendingLorebookUpdates=new Map,t.pendingRegexUpdates instanceof Set?t.pendingRegexUpdates.clear():t.pendingRegexUpdates=new Set,t.lorebookUsage.clear();let _=new Set(Array.isArray(A)?A:[]);if(Array.isArray(g)&&g.length>0)try{await Promise.all(g.map(async R=>{if(!(!R||!R.name))try{let U=null;try{let j=a.getCharWorldbookNames(R.name);j&&typeof j.then=="function"?U=await j:U=j}catch(j){console.warn(`[RegexLoreHub] Error getting worldbooks for character "${R.name}":`,j),U=null}if(U&&typeof U=="object"){let j=new Set;U.primary&&typeof U.primary=="string"&&j.add(U.primary),Array.isArray(U.additional)&&U.additional.forEach(q=>typeof q=="string"&&j.add(q)),j.forEach(q=>{typeof q=="string"&&(t.lorebookUsage.has(q)||t.lorebookUsage.set(q,[]),t.lorebookUsage.get(q).push(R.name),_.add(q),console.log(`[RegexLoreHub] Character "${R.name}" uses worldbook "${q}"`))})}}catch(U){console.warn(`[RegexLoreHub] Error processing character ${R.name}:`,U)}}))}catch(R){console.warn("[RegexLoreHub] Error processing characters:",R)}let B=new Set(Array.isArray(O)?O:[]);t.allLorebooks=(Array.isArray(A)?A:[]).map(R=>({name:R,enabled:B.has(R),entryCount:0,enabledEntryCount:0,entriesLoaded:!1}));let z=new Set;C&&typeof C=="object"&&(C.primary&&typeof C.primary=="string"&&z.add(C.primary),Array.isArray(C.additional)&&C.additional.forEach(R=>typeof R=="string"&&z.add(R))),t.lorebooks.character=Array.from(z),t.chatLorebook=typeof T=="string"?T:null,typeof T=="string"&&_.add(T),h("\u6784\u5EFA\u7D22\u5F15...","\u4E16\u754C\u4E66\u5217\u8868\u5DF2\u52A0\u8F7D"),t.isDataLoaded=!0,h("\u6E32\u67D3\u754C\u9762...","\u6570\u636E\u52A0\u8F7D\u5B8C\u6210"),J(),bo()}catch(d){throw console.error("[RegexLoreHub] Error in loadAllData:",d),l.html(`
                <div class="rlh-error-wrapper">
                    <p class="rlh-error-title">
                        <i class="fa-solid fa-exclamation-triangle"></i> \u6570\u636E\u52A0\u8F7D\u5931\u8D25
                    </p>
                    <p class="rlh-error-text">
                        \u8BF7\u68C0\u67E5\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\uFF0C\u6216\u5C1D\u8BD5\u5237\u65B0\u9875\u9762\u3002
                    </p>
                    <button class="rlh-modal-btn rlh-error-retry-btn" onclick="$('#${dr}').click()">
                        <i class="fa-solid fa-refresh"></i> \u91CD\u8BD5
                    </button>
                </div>
            `),d}},Ne=S(async(e=!1)=>{if(e)t.isDataLoaded=!1;else if(t.isDataLoaded)return;if(!(gr&&(await gr,!e))){gr=so();try{await gr}finally{gr=null}}}),Kr=!1,co=3,_t=e=>new Promise(r=>setTimeout(r,e)),Tt=()=>{let e=te(),r=ie();if(!e||!r)return{};let o=e(`#${$r}`,r);if(!o.length)return{};let a=o.find(`#${Er}`),l=o.find(`#${Sr}`),n=o.find(".rlh-prefetch-bar");return{$indicator:o,$text:a,$bar:l,$barContainer:n}},Nt=e=>{let{$indicator:r,$bar:o,$barContainer:a}=Tt();r&&(r.attr("data-visible",e?"true":"false"),r.attr("aria-hidden",e?"false":"true"),e||(o?.length&&o.css("width","0%"),a?.length&&a.attr("aria-valuenow",0)))},Rt=(e,r)=>{let{$indicator:o,$text:a,$bar:l,$barContainer:n}=Tt();if(!o)return;let i=r>0?r:1,u=Math.min(e,r),m=Math.round(u/i*100),h=`\u540E\u53F0\u52A0\u8F7D\u4E16\u754C\u4E66 (${u}/${r})\uFF0C\u4E0D\u5F71\u54CD\u5176\u4ED6\u64CD\u4F5C`;a?.length&&a.text(h),l?.length&&l.css("width",`${Math.min(m,100)}%`),n?.length&&n.attr("aria-valuenow",Math.min(m,100))},qr=()=>{Nt(!1)},ho=e=>{let r=te(),o=ie();if(!r||!o)return;let a=r(`#${ne}`,o);if(!a.length)return;let l=a.find(".rlh-book-group").filter((i,u)=>r(u).data("book-name")===e);if(!l.length)return;let n=t.allLorebooks.find(i=>i.name===e);n&&l.find(".rlh-book-stats").text(`\u6761\u76EE: ${n.enabledEntryCount} / ${n.entryCount}`)},po=e=>{if(e<=0){qr();return}Nt(!0),Rt(0,e)},bo=S(async()=>{if(Kr)return;let e=t.allLorebooks.filter(r=>!r.entriesLoaded);if(e.length===0){qr();return}Kr=!0,po(e.length);try{let r=0,o=[...e],a=async()=>{for(;o.length>0;){let n=o.shift();if(!n)break;try{await xe(n.name),ho(n.name)}finally{r+=1,Rt(r,e.length)}await _t(30)}},l=Math.min(co,o.length);await Promise.all(Array.from({length:l},()=>a()))}finally{await _t(260),qr(),Kr=!1}}),It=S(async()=>{let r=ge().SillyTavern?.getContext?.()||{},o=r.chatId!==void 0&&r.chatId!==null,a=[H.getCharData(),H.getCurrentCharWorldbookNames(),H.getRegexes()];o?a.push(H.getChatWorldbookName().catch(h=>(console.warn("[RegexLoreHub] Failed to get chat worldbook in refreshCharacterData:",h),null))):a.push(Promise.resolve(null));let[l,n,i,u]=await Promise.all(a);At(i,l),yr({charData:l}),uo(n),t.chatLorebook=u;let m=t.lorebooks.character.filter(h=>!Hr(h));m.length>0&&await Promise.all(m.map(async h=>{let d=await H.getWorldbook(h);_e(h,d.map(Pe))}))});function At(e,r){let o=e?.filter(i=>i.scope==="character")||[],a=[];if(r&&H.Character)try{a=(new H.Character(r).getRegexScripts()||[]).map((u,m)=>({id:u.id||`card-${Date.now()}-${m}`,script_name:u.scriptName||"\u672A\u547D\u540D\u5361\u5185\u6B63\u5219",find_regex:u.findRegex,replace_string:u.replaceString,enabled:!u.disabled,scope:"character",source:"card"}))}catch(i){console.warn("\u65E0\u6CD5\u89E3\u6790\u89D2\u8272\u5361\u6B63\u5219\u811A\u672C:",i)}let l=new Set(o.map(i=>`${i.script_name}::${i.find_regex}::${i.replace_string}`)),n=a.filter(i=>{let u=`${i.script_name}::${i.find_regex}::${i.replace_string}`;return!l.has(u)});t.regexes.character=[...o,...n],Be(t.regexes.character)}function uo(e){let r=[];e&&(e.primary&&r.push(e.primary),e.additional&&r.push(...e.additional)),t.lorebooks.character=[...new Set(r)]}var Qe=e=>{let r=le(e),o=t.allLorebooks.find(a=>a.name===e);o&&(o.entryCount=r.length,o.enabledEntryCount=r.filter(a=>a.enabled).length)},Mt=e=>{let r={uid:`temp-${Date.now()}`,name:"\u65B0\u6761\u76EE",comment:"",content:"",keys:[],key:[],keysecondary:[],enabled:!0,disable:!1,is_temp:!0,selective:!0,selectiveLogic:Ir.and_any,logic:"and_any",constant:!1,position:"before_character_definition",depth:null,order:0,probability:100,useProbability:!1,case_sensitive:!1,match_whole_words:!1,prevent_recursion:!1,exclude_recursion:!1},o=le(e);return o.unshift(r),_e(e,o),r},Ot=(e,r,o)=>{let a=le(e),l=a.findIndex(n=>n.uid===r);if(l!==-1){let n=Pe(o),i={...a[l],...n,is_temp:!1};a[l]=i,_e(e,a),io(e,r,i.uid)}else console.warn(`[RegexLoreHub] \u5728\u66F4\u65B0\u65F6\u627E\u4E0D\u5230\u4E34\u65F6\u6761\u76EE: ${r}`)},xe=S(async(e,r=!1)=>{let o=t.allLorebooks.find(a=>a.name===e);if(!(!o||Hr(e)&&!r))try{let a=await H.getWorldbook(e);a=a.map(Pe),_e(e,a),o.entriesLoaded=!0,Qe(e)}catch(a){console.error(`[RegexLoreHub] Failed to load entries for worldbook "${e}":`,a),o.entriesLoaded=!0}}),Ge=S(async(e={})=>{let{silent:r=!1}=e,o=3,a=3e3,l=0,n=d=>new Promise(g=>setTimeout(g,d)),i=()=>{r?Lr():J()},u=async()=>{if(!(t.pendingLorebookUpdates instanceof Map))return t.pendingLorebookUpdates=new Map,!1;let d=!1;for(let[g,v]of[...t.pendingLorebookUpdates.entries()]){if(!(v instanceof Map)||v.size===0)continue;let w=[],M=[];for(let[T,s]of v.entries()){let k=s?.uid;if(typeof k!="number"||Number.isNaN(k))continue;let y=s?.data;if(!y||Object.keys(y).length===0){M.push(T);continue}w.push({uid:k,...y}),M.push(T)}if(w.length===0){M.forEach(T=>v.delete(T)),v.size===0&&t.pendingLorebookUpdates.delete(g);continue}await Me(g,w)&&(d=!0,M.forEach(T=>v.delete(T)),v.size===0&&t.pendingLorebookUpdates.delete(g))}return d},m=async()=>{if(!(t.pendingRegexUpdates instanceof Set))return t.pendingRegexUpdates=new Set,!1;if(t.pendingRegexUpdates.size===0)return!1;Be(t.regexes.global),Be(t.regexes.character);let d=[...t.regexes.global,...t.regexes.character];return await H.replaceRegexes(d.filter(g=>g.source!=="card")),await H.saveSettings(),t.pendingRegexUpdates.clear(),!0},h=async()=>{console.log("[RegexLoreHub] \u6267\u884C\u7EDF\u4E00\u4FDD\u5B58\u64CD\u4F5C...");let d=await u(),g=await m();return console.log(!d&&!g?"[RegexLoreHub] \u6CA1\u6709\u5F85\u4FDD\u5B58\u7684\u66F4\u6539\u3002":"[RegexLoreHub] \u4FDD\u5B58\u64CD\u4F5C\u5B8C\u6210\u3002"),!0};for(;l<o;)try{t.saveRetryAttempt=l+1,t.saveStatus=l===0?"saving":"retrying",i(),await h(),t.saveStatus="success",t.saveRetryAttempt=0,i(),await n(1500),t.saveStatus="idle",i(),console.log("[RegexLoreHub] \u6240\u6709\u66F4\u6539\u5DF2\u6210\u529F\u4FDD\u5B58\u3002");return}catch(d){if(l++,console.error(`[RegexLoreHub] \u4FDD\u5B58\u5931\u8D25\uFF0C\u5C1D\u8BD5\u6B21\u6570 ${l}/${o}:`,d),l>=o)throw t.saveStatus="failed",i(),console.error("[RegexLoreHub] \u6240\u6709\u91CD\u8BD5\u5747\u5931\u8D25\uFF0C\u5DF2\u505C\u6B62\u4FDD\u5B58\u3002"),new Error("\u81EA\u52A8\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u8FDE\u63A5\u6216\u624B\u52A8\u4FDD\u5B58\u3002");await n(a)}}),Ee=e=>{if(typeof e!="string")return null;let r=e.trim();return r.length>0?r:null},Yr=e=>!e||typeof e!="object"?null:Ee(e.name)||Ee(e.display_name)||Ee(e.title)||Ee(e.metadata?.name)||Ee(e.filename)||Ee(e.external_id),mo=e=>!e||typeof e!="object"?null:Ee(e.name)||Ee(e.char_name)||Ee(e.display_name)||Ee(e.metadata?.name)||Ee(e.data?.name)||Ee(e.data?.char_name)||Ee(e.data?.display_name),fo=(e,r)=>{if(!e||r===void 0||r===null)return!1;let o=String(r);return[e.id,e.characterId,e.metadata?.characterId,e.metadata?.id,e.external_id,e.filename].map(l=>l==null?null:String(l)).some(l=>l&&l===o)},yr=({charData:e=null}={})=>{let o=ge().SillyTavern?.getContext?.()||{},a=Array.isArray(o.characters)?o.characters:[],l=o.characterId!==void 0&&o.characterId!==null?o.characterId:null,n=Ee(o.name)||Yr(o.character);if(!n&&l!==null){let i=a.find(u=>fo(u,l));i&&(n=Yr(i))}!n&&e&&(n=mo(e)),!n&&a.length===1&&(n=Yr(a[0])),t.characterContext.name=n??null,t.characterContext.id=l,console.log("[RegexLoreHub] Context synced with appState:",t.characterContext)};function Bt(e={}){let r=e.$??te(),o=e.parentDoc??ie(),a=e.parentWin??ge(),l=async(s,{showLoading:k=!0}={})=>{let y=(s??"").toString().trim();if(!y)return;let O=t.loadingBookName;try{k&&(t.loadingBookName=y,J()),await xe(y,!0)}finally{t.loadingBookName=O&&O!==y?O:null,J()}},n=S(async s=>{t.activeView="global-lore-detail",t.activeBookName=s,t.loadingBookName=s,J(),await xe(s),t.loadingBookName=null,J()}),i=S(async()=>{t.activeView="global-lore-list",t.activeBookName=null,t.selectedItems.clear(),t.globalSearch={term:"",replace:""};let s=r("#rlh-global-search-input",o);s.length&&s.val(""),J()}),u=S(async(s,k,y)=>{let O=t.lorebookUsage.get(s)||[];if(O.length===0)return;let A=a.SillyTavern.getContext(),_=A.characterId,B=0,z=O.length;y.update(`\u6B63\u5728\u66F4\u65B0 ${z} \u4E2A\u5173\u8054\u89D2\u8272... (0/${z})`);for(let R of O){try{let U=a.Character?.findCharacterIndex?.(R)??A.characters.findIndex(oe=>oe.name===R);if(U===-1){console.warn(`[RegexLoreHub] Character "${R}" not found, skipping...`);continue}console.log(`[RegexLoreHub] Switching to character "${R}" (index: ${U})`),await A.selectCharacterById(U);let j=await H.getCharWorldbookNames({name:R});if(!j){console.warn(`[RegexLoreHub] Failed to get worldbooks for character "${R}"`);continue}console.log(`[RegexLoreHub] Current worldbooks for "${R}":`,j);let q=!1;if(j.primary===s&&(console.log(`[RegexLoreHub] Updating primary lorebook from "${s}" to "${k}"`),j.primary=k,q=!0),j.additional){let oe=j.additional.indexOf(s);oe>-1&&(console.log(`[RegexLoreHub] Updating additional lorebook at index ${oe} from "${s}" to "${k}"`),j.additional[oe]=k,q=!0)}q?(console.log(`[RegexLoreHub] Saving updated lorebooks for "${R}":`,j),await H.rebindCharWorldbooks(j),console.log(`[RegexLoreHub] Successfully updated lorebooks for "${R}"`)):console.log(`[RegexLoreHub] No updates needed for character "${R}"`)}catch(U){console.error(`[RegexLoreHub] Failed to update lorebook for character "${R}":`,U)}B++,y.update(`\u6B63\u5728\u66F4\u65B0 ${z} \u4E2A\u5173\u8054\u89D2\u8272... (${B}/${z})`)}A.characterId!==_&&await A.selectCharacterById(_)}),m=S(async s=>{s.stopPropagation();let y=r(s.currentTarget).closest(".rlh-book-group, .rlh-detail-view"),O=y.hasClass("rlh-detail-view"),A=y.data("book-name")||t.activeBookName;if(!A)return;let _;try{_=await Y({type:"prompt",title:"\u91CD\u547D\u540D\u4E16\u754C\u4E66",text:"\u8BF7\u8F93\u5165\u65B0\u7684\u4E16\u754C\u4E66\u540D\u79F0\uFF1A",value:A})}catch{return}if(_=_.trim(),!_||_===A)return;if(t.allLorebooks.some(oe=>oe.name===_)){await Y({type:"alert",title:"\u91CD\u547D\u540D\u5931\u8D25",text:"\u8BE5\u540D\u79F0\u7684\u4E16\u754C\u4E66\u5DF2\u5B58\u5728\uFF0C\u8BF7\u9009\u62E9\u5176\u4ED6\u540D\u79F0\u3002"});return}let B=t.lorebookUsage.get(A)||[],z=t.chatLorebook===A,R=z?1:0,U=B.length+R;console.log(`[RegexLoreHub] Renaming lorebook "${A}" to "${_}", linked characters:`,B,"chat linked:",z);let j=`\u6B64\u64CD\u4F5C\u5C06\u66F4\u65B0 ${U} \u4E2A\u7ED1\u5B9A\u5173\u7CFB`;B.length>0&&(j+=`\uFF0C\u9700\u8981\u4E34\u65F6\u5207\u6362\u5230 ${B.length} \u4E2A\u5173\u8054\u89D2\u8272\u5361\u6765\u66F4\u65B0\u4E16\u754C\u4E66\u94FE\u63A5`),j+=`\uFF0C\u671F\u95F4\u8BF7\u52FF\u64CD\u4F5C\u3002

`,B.length>0&&(j+=`\u5173\u8054\u89D2\u8272\u5361\uFF1A${B.join(", ")}
`),z&&(j+=`\u5173\u8054\u804A\u5929\uFF1A\u5F53\u524D\u804A\u5929
`),t.activeTab==="global-lore"&&(j+=`
\u26A0\uFE0F \u91CD\u8981\u63D0\u793A\uFF1A\u7531\u4E8ESillyTavern API\u9650\u5236\uFF0C\u65E0\u6CD5\u76F4\u63A5\u5217\u51FA\u6240\u6709*\u804A\u5929\u4E16\u754C\u4E66*\u7ED1\u5B9A\u3002\u5982\u679C\u6B64\u4E16\u754C\u4E66\u4E0E*\u804A\u5929*\u7ED1\u5B9A\uFF0C\u91CD\u547D\u540D\u540E\u9700\u8981\u624B\u52A8\u68C0\u67E5\u90A3\u4E9B\u804A\u5929\u7ED1\u5B9A\u72B6\u6001\u3002
`),j+=`
\u662F\u5426\u7EE7\u7EED\uFF1F`;try{await Y({type:"confirm",title:"\u786E\u8BA4\u91CD\u547D\u540D",text:j})}catch{return}let q=qe("\u5F00\u59CB\u91CD\u547D\u540D...");try{if(q.update("\u6B63\u5728\u521B\u5EFA\u65B0\u4E16\u754C\u4E66..."),!await H.createWorldbook(_))throw new Error("\u521B\u5EFA\u65B0\u4E16\u754C\u4E66\u6587\u4EF6\u5931\u8D25\u3002");let re=[...le(A)];if(re.length>0){q.update("\u6B63\u5728\u590D\u5236\u6761\u76EE...");let c=re.map(f=>{let x={...f};return delete x.uid,x});await H.createWorldbookEntries(_,c)}await u(A,_,q),q.update("\u6B63\u5728\u66F4\u65B0\u5168\u5C40\u8BBE\u7F6E...");let de=await H.getGlobalWorldbookNames();if(de&&de.includes(A)){let c=de.map(x=>x===A?_:x);await H.rebindGlobalWorldbooks(c),console.log(`[RegexLoreHub] Updated global lorebook settings from "${A}" to "${_}"`);let f=await H.getGlobalWorldbookNames();(!f||!f.includes(_))&&console.warn(`[RegexLoreHub] Global lorebook settings update verification failed for "${_}"`)}if(t.chatLorebook===A){q.update("\u6B63\u5728\u66F4\u65B0\u804A\u5929\u7ED1\u5B9A..."),await H.rebindChatWorldbook(_),t.chatLorebook=_,console.log(`[RegexLoreHub] Updated chat lorebook from "${A}" to "${_}"`);try{let c=await H.getChatWorldbookName();c!==_&&(console.warn(`[RegexLoreHub] Chat lorebook update verification failed. Expected: "${_}", Got: "${c}"`),t.chatLorebook=c)}catch(c){console.warn("[RegexLoreHub] Failed to verify chat lorebook update:",c)}}if(q.update("\u6B63\u5728\u66F4\u65B0\u5185\u90E8\u6620\u5C04..."),t.lorebookUsage.has(A)){let c=t.lorebookUsage.get(A);t.lorebookUsage.delete(A),t.lorebookUsage.set(_,c),console.log(`[RegexLoreHub] Updated lorebookUsage mapping from "${A}" to "${_}"`)}q.update("\u6B63\u5728\u5220\u9664\u65E7\u4E16\u754C\u4E66..."),await H.deleteWorldbook(A),q.update("\u6B63\u5728\u5237\u65B0\u6570\u636E...");let be=t.chatLorebook;await Ne(!0),be&&t.chatLorebook!==be&&(console.log(`[RegexLoreHub] Restoring chat lorebook state after data refresh: "${be}"`),t.chatLorebook=be);try{let c=a.SillyTavern.getContext()||{};if(c.chatId!==void 0&&c.chatId!==null){let x=await H.getChatWorldbookName();x!==t.chatLorebook&&(console.log(`[RegexLoreHub] Final chat lorebook sync: "${x}"`),t.chatLorebook=x)}}catch(c){console.warn("[RegexLoreHub] Failed to sync final chat lorebook state:",c)}q.remove(),ce("\u4E16\u754C\u4E66\u91CD\u547D\u540D\u6210\u529F"),O?await n(_):J()}catch(oe){q.remove(),console.error("[RegexLoreHub] Rename failed:",oe),await Y({type:"alert",title:"\u91CD\u547D\u540D\u5931\u8D25",text:`\u64CD\u4F5C\u5931\u8D25: ${oe.message}`}),t.allLorebooks.some(de=>de.name===_)&&await H.deleteWorldbook(_);let re=t.chatLorebook;await Ne(!0),re&&t.chatLorebook!==re&&(console.log(`[RegexLoreHub] Restoring chat lorebook state after error recovery: "${re}"`),t.chatLorebook=re);try{let de=a.SillyTavern.getContext()||{};if(de.chatId!==void 0&&de.chatId!==null){let c=await H.getChatWorldbookName();c!==t.chatLorebook&&(console.log(`[RegexLoreHub] Final chat lorebook sync after error recovery: "${c}"`),t.chatLorebook=c)}}catch(de){console.warn("[RegexLoreHub] Failed to sync chat lorebook state after error recovery:",de)}}}),h=S(async(s,k="")=>{let y;try{y=await Y({type:"prompt",title:"\u65B0\u5EFA\u4E16\u754C\u4E66",text:"\u8BF7\u8F93\u5165\u65B0\u4E16\u754C\u4E66\u7684\u540D\u79F0:",value:k})}catch{return}if(y=y.trim(),!y)return;if(t.allLorebooks.some(A=>A.name===y))return await Y({type:"alert",title:"\u9519\u8BEF",text:"\u5DF2\u5B58\u5728\u540C\u540D\u4E16\u754C\u4E66\u3002"}),h(s,y);let O=s?r(s.currentTarget):null;O&&O.prop("disabled",!0).addClass("rlh-loading");try{await H.createWorldbook(y)?(t.allLorebooks.push({name:y,enabled:!1,entryCount:0,enabledEntryCount:0,entriesLoaded:!0}),await n(y)):await Y({type:"alert",title:"\u521B\u5EFA\u5931\u8D25",text:"\u521B\u5EFA\u4E16\u754C\u4E66\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"})}finally{O&&O.prop("disabled",!1).removeClass("rlh-loading")}}),d=S(async s=>{s.stopPropagation();let y=r(s.currentTarget).closest(".rlh-book-group, .rlh-detail-view"),O=y.data("book-name")||t.activeBookName;if(!O)return;let A=y.hasClass("rlh-detail-view");try{await Y({type:"confirm",title:"\u786E\u8BA4\u5220\u9664",text:`\u60A8\u786E\u5B9A\u8981\u6C38\u4E45\u5220\u9664\u4E16\u754C\u4E66 "${O}" \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`})}catch{return}await H.deleteWorldbook(O)?(t.allLorebooks=t.allLorebooks.filter(B=>B.name!==O),br(O),t.lorebookUsage instanceof Map&&t.lorebookUsage.has(O)&&t.lorebookUsage.delete(O),Array.isArray(t.lorebooks?.character)&&(t.lorebooks.character=t.lorebooks.character.filter(B=>B!==O)),t.chatLorebook===O&&(t.chatLorebook=null),t.activeCharacterBook===O&&(t.activeCharacterBook=null),t.activeBookName===O&&(t.activeBookName=null),A?await i():J(),ce("\u5220\u9664\u6210\u529F")):await Y({type:"alert",title:"\u5220\u9664\u5931\u8D25",text:"\u5220\u9664\u4E16\u754C\u4E66\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"})}),g=S(async s=>{let y=(r(s.currentTarget).data("book-name")??"").toString().trim(),O=Ae(),_=[y,O?.activeBookName??"",t.activeBookName??"",t.activeCharacterBook??"",t.chatLorebook??""].find(R=>typeof R=="string"&&R.trim().length>0)?.trim()??"";if(!_){await Y({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u9009\u62E9\u6216\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u3002"});return}let B=[...le(_)];if((!B||B.length===0)&&(await xe(_),B=[...le(_)]),!B||B.length===0){await Y({type:"alert",title:"\u63D0\u793A",text:"\u8BE5\u4E16\u754C\u4E66\u6CA1\u6709\u6761\u76EE\u53EF\u64CD\u4F5C\u3002"});return}try{await Y({type:"confirm",title:"\u786E\u8BA4\u64CD\u4F5C",text:`\u786E\u5B9A\u8981\u4E3A "${_}" \u4E2D\u7684\u6240\u6709\u6761\u76EE\u5F00\u542F\u201C\u9632\u6B62\u9012\u5F52\u201D\u548C\u201C\u4E0D\u53EF\u88AB\u9012\u5F52\u201D\u5417\uFF1F\u6B64\u64CD\u4F5C\u4F1A\u963B\u6B62\u4E16\u754C\u4E66\u6761\u76EE\u5F7C\u6B64\u89E6\u53D1\u3002`})}catch{return}let z=B.map(R=>({uid:R.uid,prevent_recursion:!0,exclude_recursion:!0}));await Me(_,z),B.forEach(R=>{R.prevent_recursion=!0,R.exclude_recursion=!0,(!R.recursion||typeof R.recursion!="object")&&(R.recursion={}),R.recursion.prevent_outgoing=!0,R.recursion.prevent_incoming=!0}),z.forEach(R=>{let U=r(`#rlh-panel-content .rlh-item-container[data-book-name="${_}"][data-id="${R.uid}"] .rlh-collapsible-content:visible`,o);U.length&&(U.find(".rlh-edit-prevent-recursion").prop("checked",!0),U.find(".rlh-edit-exclude-recursion").prop("checked",!0))}),ce("\u5DF2\u4E3A\u6240\u6709\u6761\u76EE\u5F00\u542F\u201C\u9632\u6B62\u9012\u5F52\u201D\u548C\u201C\u4E0D\u53EF\u88AB\u9012\u5F52\u201D"),await l(_)}),v=S(async s=>{let y=(r(s.currentTarget).data("book-name")??"").toString().trim(),O=Ae(),_=[y,O?.activeBookName??"",t.activeBookName??"",t.activeCharacterBook??"",t.chatLorebook??""].find(U=>typeof U=="string"&&U.trim().length>0)?.trim()??"";if(!_){await Y({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u9009\u62E9\u6216\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u3002"});return}let B=[...le(_)];if((!B||B.length===0)&&(await xe(_),B=[...le(_)]),!B||B.length===0){await Y({type:"alert",title:"\u63D0\u793A",text:"\u8BE5\u4E16\u754C\u4E66\u6CA1\u6709\u6761\u76EE\u53EF\u64CD\u4F5C\u3002"});return}try{await Y({type:"confirm",title:"\u786E\u8BA4\u64CD\u4F5C",text:`\u786E\u5B9A\u8981\u4E3A "${_}" \u4E2D\u7684\u6240\u6709\u6761\u76EE\u4FEE\u590D\u5173\u952E\u8BCD\uFF08\u5C06\u4E2D\u6587\u9017\u53F7\u66FF\u6362\u4E3A\u82F1\u6587\u9017\u53F7\uFF09\u5417\uFF1F`})}catch{return}let z=0,R=B.map(U=>{let j=(U.keys||[]).join(", "),oe=j.replace(//g,",").replace(/,+/g,",").trim().split(",").map(de=>de.trim()).filter(Boolean),re=oe.join(", ");return j!==re?(z++,{uid:U.uid,keys:oe}):null}).filter(Boolean);R.length>0?(await Me(_,R),R.forEach(U=>{let j=B.find(q=>q.uid===U.uid);j&&(j.keys=U.keys)}),R.forEach(U=>{let j=r(`#rlh-panel-content .rlh-item-container[data-book-name="${_}"][data-id="${U.uid}"] .rlh-collapsible-content:visible`,o);j.length&&j.find(".rlh-edit-keys").val(U.keys.join(", "))}),ce(`\u6210\u529F\u4FEE\u590D\u4E86 ${z} \u4E2A\u6761\u76EE\u7684\u5173\u952E\u8BCD`),await l(_)):await Y({type:"alert",title:"\u63D0\u793A",text:"\u6240\u6709\u6761\u76EE\u7684\u5173\u952E\u8BCD\u683C\u5F0F\u90FD\u6B63\u786E\uFF0C\u65E0\u9700\u4FEE\u590D\u3002"})}),w=S(async({bookName:s,positionValue:k})=>{let y=(k??"").toString().trim();if(!y)return;let O=Ae(),_=[s,O?.activeBookName??"",t.activeBookName??"",t.activeCharacterBook??"",t.chatLorebook??""].find(re=>typeof re=="string"&&re.trim().length>0)?.trim()??"";if(!_){await Y({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u9009\u62E9\u6216\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u3002"});return}let B=[...le(_)];if(B.length||(await xe(_),B=[...le(_)]),!B.length){await Y({type:"alert",title:"\u63D0\u793A",text:"\u8BE5\u4E16\u754C\u4E66\u6CA1\u6709\u6761\u76EE\u53EF\u64CD\u4F5C\u3002"});return}let z=Ie.position?.[y]??y,R=B.filter(re=>(re?.position??"").toString()!==y).map(re=>({uid:re.uid,position:y}));if(!R.length){await Y({type:"alert",title:"\u63D0\u793A",text:`\u6240\u6709\u6761\u76EE\u7684\u4F4D\u7F6E\u5DF2\u7ECF\u662F\u300C${z}\u300D\u3002`});return}try{await Y({type:"confirm",title:"\u786E\u8BA4\u64CD\u4F5C",text:`\u786E\u5B9A\u8981\u5C06 "${_}" \u4E2D\u7684 ${B.length} \u4E2A\u6761\u76EE\u5168\u90E8\u8BBE\u7F6E\u4E3A\u300C${z}\u300D\u5417\uFF1F`})}catch{return}await Me(_,R);let U=le(_),j=new Set(U.map(re=>(re?.position??"before_character_definition").toString())),q=j.size===1?j.values().next().value:null;R.forEach(re=>{let de=`#rlh-panel-content .rlh-item-container[data-book-name="${_}"][data-id="${re.uid}"]`,be=r(de,o);if(be.length){let c=be.find(".rlh-edit-position");c.length&&c.val(y).trigger("change")}});let oe=r(`#${He}`,o);if(oe.length){oe.attr("data-book-name",_);let re=r(`#${Oe}`,o);re.length&&(re.removeAttr("disabled"),re.attr("data-book-name",_)),oe.find(".rlh-position-option").each(function(){let be=r(this),c=(be.data("position-value")??"").toString(),f=q&&c===q;be.toggleClass("active",f),be.attr("aria-selected",f?"true":"false"),be.attr("data-book-name",_)})}ce(`\u5DF2\u66F4\u65B0 ${R.length} \u4E2A\u6761\u76EE\u7684\u4F4D\u7F6E\u4E3A\u300C${z}\u300D`),await l(_)}),M=S(async()=>{let s=await H.getOrCreateChatWorldbook();s?(ce(`\u5DF2\u521B\u5EFA\u5E76\u7ED1\u5B9A\u804A\u5929\u4E16\u754C\u4E66: ${s}`),await Ne(!0)):await Y({type:"alert",title:"\u64CD\u4F5C\u5931\u8D25",text:"\u65E0\u6CD5\u521B\u5EFA\u6216\u7ED1\u5B9A\u804A\u5929\u4E16\u754C\u4E66\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"})}),C=S(async()=>{let s=t.chatLorebook;if(s){try{await Y({type:"confirm",title:"\u786E\u8BA4\u89E3\u9664\u7ED1\u5B9A",text:`\u60A8\u786E\u5B9A\u8981\u89E3\u9664\u4E0E\u804A\u5929\u4E16\u754C\u4E66 "${s}" \u7684\u7ED1\u5B9A\u5417\uFF1F\u4E16\u754C\u4E66\u672C\u8EAB\u4E0D\u4F1A\u88AB\u5220\u9664\u3002`})}catch{return}await H.rebindChatWorldbook(null),t.chatLorebook=null,ce("\u5DF2\u89E3\u9664\u7ED1\u5B9A"),J()}}),T=S(async()=>{let s=t.activeBookName;s&&(t.loadingBookName=s,J(),await xe(s,!0),t.loadingBookName=null,J())});return{handleEnterLorebookDetail:n,handleExitLorebookDetail:i,handleRefreshLorebookDetail:T,handleCreateLorebook:h,handleDeleteLorebook:d,handleRenameBook:m,handleBatchSetRecursion:g,handleFixKeywords:v,applyUnifiedPosition:w,handleCreateChatLorebook:M,handleUnlinkChatLorebook:C}}function Dt(e={}){let r=e.$??te(),o=e.parentDoc??ie(),a=c=>{let f=String(c),x=t.regexes.global.find(N=>String(N.id)===f);return x||(t.regexes.character.find(N=>String(N.id)===f)??null)},l=(c,f,x)=>{if(!c||!f)return;let N=x;if(typeof N!="boolean"&&(N=N??""),f==="min_depth"||f==="max_depth"){let D=parseInt(N,10);N=Number.isNaN(D)?null:D}let F=f.split(".");if(F.length===1){c[F[0]]=N;return}let L=c;for(let D=0;D<F.length-1;D++){let X=F[D];(!L[X]||typeof L[X]!="object")&&(L[X]={}),L=L[X]}L[F[F.length-1]]=N},n=Pr(()=>Ge({silent:!0}),1e3),i=S(async c=>{let f=r(c.currentTarget),x=f.closest(".rlh-item-container"),N=x.data("type"),F=x.data("id"),L=Number(F),D=f.data("field");if(D){if(N==="lore"){let X=x.data("book-name"),Z=le(X).find(we=>{let fe=we?.uid;return typeof fe=="number"&&!Number.isNaN(L)?fe===L:String(fe)===String(F)});if(!Z)return;let ee;if(f.is(":checkbox"))ee=f.is(":checked");else if(f.is('[contenteditable="true"]')){let we=f.get(0);if(we){let fe=new Set(["div","p","li","ul","ol","blockquote","pre","h1","h2","h3","h4","h5","h6","table","tr"]),Le=[],sr=ve=>{ve&&Le.push(ve)},Ye=()=>{if(!Le.length){Le.push(`
`);return}Le[Le.length-1]?.endsWith(`
`)||Le.push(`
`)},Je=ve=>{if(!ve)return;let Ue=ve.nodeType;if(Ue===Node.TEXT_NODE){sr(ve.nodeValue||"");return}if(Ue!==Node.ELEMENT_NODE)return;let ye=ve.nodeName.toLowerCase();if(ye==="br"){Le.push(`
`);return}ye==="style"||ye==="script"||(ve.childNodes.forEach(Ze=>Je(Ze)),fe.has(ye)&&Ye())};Je(we),ee=Le.join(""),ee=ee.replace(/\u00a0/g," "),ee=ee.replace(/\r?\n/g,`
`)}else ee=""}else ee=f.val();if(D==="keys")Z.keys=ee.split(",").map(we=>we.trim()).filter(Boolean);else if(["depth","order","probability"].includes(D)){let we=parseInt(ee,10);Z[D]=isNaN(we)?f.attr("placeholder")==="\u4F8B\u5982: 0"?null:100:we}else Z[D]=ee;let me=Array.isArray(Z[D])?[...Z[D]]:Z[D];Ct(X,Z.uid??F,{[D]:me})}else if(N==="regex"){let X=a(F);if(!X)return;let V;f.is(":checkbox")?V=f.is(":checked"):V=f.val(),l(X,D,V),Lt(X.id)}n()}}),u=c=>{let f=Object.entries(Ie.position).map(([L,D])=>`<option value="${L}" ${c.position===L?"selected":""}>${D}</option>`).join(""),x=Object.entries(Ie.logic).map(([L,D])=>`<option value="${L}" ${c.logic===L?"selected":""}>${D}</option>`).join(""),N=Array.isArray(c.keys)?c.keys.join(", "):"",F=c.content||"";return`
      <div class="rlh-editor-wrapper" data-mode="edit">
        <div class="rlh-editor-field">
          <label>\u5173\u952E\u8BCD (\u9017\u53F7\u5206\u9694)</label>
          <input type="text" class="rlh-edit-keys" data-field="keys" value="${I(N)}">
        </div>
        <div class="rlh-editor-field">
          <label>\u5185\u5BB9</label>
          <div class="rlh-edit-content" data-field="content" contenteditable="true">${I(F)}</div>
        </div>
        <div class="rlh-editor-group"><h5>\u63D2\u5165\u89C4\u5219</h5>
          <div class="rlh-editor-grid">
            <div class="rlh-grid-item"><label>\u4F4D\u7F6E</label><select class="rlh-edit-position rlh-select-nudge" data-field="position">${f}</select></div>
            <div class="rlh-grid-item rlh-depth-container"><label>\u6DF1\u5EA6</label><input type="number" class="rlh-edit-depth" data-field="depth" placeholder="\u4F8B\u5982: 0" value="${c.depth??""}"></div>
            <div class="rlh-grid-item"><label>\u987A\u5E8F</label><input type="number" class="rlh-edit-order" data-field="order" placeholder="\u4F8B\u5982: 100" value="${c.order??""}"></div>
          </div>
        </div>
        <div class="rlh-editor-group"><h5>\u6FC0\u6D3B\u903B\u8F91</h5>
          <div class="rlh-editor-grid">
            <div class="rlh-grid-item"><label>\u6982\u7387 (%)</label><input type="number" class="rlh-edit-probability" data-field="probability" min="0" max="100" placeholder="100" value="${c.probability??""}"></div>
            <div class="rlh-grid-item"><label>\u5173\u952E\u8BCD\u903B\u8F91</label><select class="rlh-edit-logic rlh-select-nudge" data-field="logic">${x}</select></div>
          </div>
        </div>
        <div class="rlh-editor-group"><h5>\u5339\u914D\u4E0E\u9012\u5F52</h5>
          <div class="rlh-editor-options-row">
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-case-sensitive" data-field="case_sensitive" ${c.case_sensitive?"checked":""}> \u5927\u5C0F\u5199\u654F\u611F</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-match-whole" data-field="match_whole_words" ${c.match_whole_words?"checked":""}> \u5168\u8BCD\u5339\u914D</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-prevent-recursion" data-field="prevent_recursion" ${c.prevent_recursion?"checked":""}> \u9632\u6B62\u9012\u5F52</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-exclude-recursion" data-field="exclude_recursion" ${c.exclude_recursion?"checked":""}> \u4E0D\u53EF\u88AB\u9012\u5F52</label>
          </div>
        </div>
      </div>
    `},m=c=>{let f=c?.destination??{},x=c?.source??{},N=I(c?.find_regex??""),F=I(c?.replace_string??""),L=I(String(c?.min_depth??"")),D=I(String(c?.max_depth??""));return`
      <div class="rlh-editor-wrapper" data-mode="edit">
        <div class="rlh-editor-field">
          <label>\u67E5\u627E\u6B63\u5219\u8868\u8FBE\u5F0F</label>
          <textarea class="rlh-edit-find" data-field="find_regex">${N}</textarea>
        </div>
        <div class="rlh-editor-field">
          <label>\u66FF\u6362\u4E3A</label>
          <textarea class="rlh-edit-replace" data-field="replace_string">${F}</textarea>
        </div>
        <div class="rlh-editor-group">
          <h5>\u77ED\u6682</h5>
          <div class="rlh-editor-options-row">
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-dest-display" data-field="destination.display" ${f.display?"checked":""}> \u4EC5\u683C\u5F0F\u663E\u793A</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-dest-prompt" data-field="destination.prompt" ${f.prompt?"checked":""}> \u4EC5\u683C\u5F0F\u63D0\u793A\u8BCD</label>
          </div>
        </div>
        <div class="rlh-editor-group">
          <h5>\u4F5C\u7528\u8303\u56F4</h5>
          <div class="rlh-editor-options-row">
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-src-user" data-field="source.user_input" ${x.user_input?"checked":""}> \u7528\u6237\u8F93\u5165</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-src-ai" data-field="source.ai_output" ${x.ai_output?"checked":""}> AI\u8F93\u51FA</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-src-slash" data-field="source.slash_command" ${x.slash_command?"checked":""}> \u659C\u6760\u547D\u4EE4</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-src-world" data-field="source.world_info" ${x.world_info?"checked":""}> \u4E16\u754C\u4E66</label>
          </div>
        </div>
        <div class="rlh-editor-group">
          <h5>\u6DF1\u5EA6</h5>
          <div class="rlh-depth-inputs">
            <input type="number" class="rlh-edit-depth-min" data-field="min_depth" placeholder="\u6700\u5C0F\u6DF1\u5EA6" value="${L}">
            <input type="number" class="rlh-edit-depth-max" data-field="max_depth" placeholder="\u6700\u5927\u6DF1\u5EA6" value="${D}">
          </div>
        </div>
      </div>
    `},h=(c,f)=>{let x=c.find(".rlh-rename-btn").first();if(!x.length)return;let N=x.find("i").first();f==="edit"?(x.attr("title","\u9000\u51FA\u7F16\u8F91\u6A21\u5F0F"),x.attr("data-rename-mode","exit"),N.length&&N.removeClass("fa-pencil").addClass("fa-eye")):(x.attr("title","\u91CD\u547D\u540D\u5E76\u7F16\u8F91"),x.attr("data-rename-mode","rename"),N.length&&N.removeClass("fa-eye").addClass("fa-pencil"))},d=c=>{c.on("input.rlh change.rlh",'input, textarea, select, [contenteditable="true"]',i),c.find(".rlh-edit-position").trigger("change")},g=(c,f,x,{animate:N=!0,searchTerm:F}={})=>{let L=f.find(".rlh-collapsible-content").first();if(!L.length)return;let D=c==="view",X=typeof F=="string"?F:f.data("searchTerm")||"",V=D?Ur(x,X):u(x);D&&(f.data("searchTerm",X),f.attr("data-search-term",X)),L.stop(!0,!0),L.off("input.rlh change.rlh"),L.html(V),f.attr("data-entry-mode",c),L.attr("data-entry-mode",c),f.toggleClass("rlh-editing",!D),h(f,c);let Z=f.find(".rlh-item-name").first();Z.length&&(D?Z.show().removeAttr("aria-hidden"):Z.hide().attr("aria-hidden","true"));let ee=()=>{D||d(L)},me=we=>{let fe=L[0];if(!fe){we();return}let Le=280,sr=ye=>ye<.5?2*ye*ye:-1+(4-2*ye)*ye;fe.style.display="block",fe.style.overflow="hidden";let Ye=0,Je=fe.scrollHeight;fe.style.height=`${Ye}px`,fe.style.opacity="0";let ve=null,Ue=ye=>{ve||(ve=ye);let Ze=Math.min((ye-ve)/Le,1),kr=sr(Ze),Ar=Ye+(Je-Ye)*kr;fe.style.height=`${Ar}px`,fe.style.opacity=String(.6+.4*kr),Ze<1?requestAnimationFrame(Ue):(fe.style.height="",fe.style.opacity="",fe.style.overflow="",we())};requestAnimationFrame(Ue)};L.is(":visible")?ee():N?me(ee):(L.show(),ee())},v=(c,f,x,N={})=>{g("view",c,f,{...N,searchTerm:x})},w=(c,f,x={})=>{g("edit",c,f,x)},M=(c,f,x,{animate:N=!0}={})=>{let F=c.find(".rlh-collapsible-content").first();if(!F.length)return;let L=typeof x=="string"?x:"";c.data("searchTerm",L),c.attr("data-search-term",L);let D=Fr(f,L);F.stop(!0,!0),F.off("input.rlh change.rlh"),F.html(D),c.attr("data-entry-mode","view"),F.attr("data-entry-mode","view"),c.removeClass("rlh-editing"),h(c,"view"),F.is(":visible")||(N?F.slideDown(200):F.show())},C=(c,f,{animate:x=!0}={})=>{let N=c.find(".rlh-collapsible-content").first();if(!N.length)return;let F=m(f);N.stop(!0,!0),N.off("input.rlh change.rlh");let L=()=>{N.on("input.rlh change.rlh",'input, textarea, select, [contenteditable="true"]',i)};N.html(F),c.attr("data-entry-mode","edit"),N.attr("data-entry-mode","edit"),c.addClass("rlh-editing"),h(c,"edit"),N.is(":visible")?L():x?N.slideDown(200,L):(N.show(),L())},T=(c,f={})=>{let{animate:x=!1,silent:N=!1}=f;if(!c.length)return!1;if(t.multiSelectMode)return N||ce("\u8BF7\u5148\u9000\u51FA\u591A\u9009\u6A21\u5F0F\u540E\u518D\u7F16\u8F91\u3002","info"),!1;let F=c.data("book-name"),L=Number(c.data("id"));if(!F||Number.isNaN(L))return!1;let D=le(F).find(X=>X.uid===L);return D?(w(c,D,{animate:x}),!0):!1},s=(c,f={})=>{let{animate:x=!1}=f;if(!c.length)return!1;let N=c.data("book-name"),F=Number(c.data("id"));if(!N||Number.isNaN(F))return!1;let L=le(N).find(X=>X.uid===F);if(!L)return!1;let D=c.data("searchTerm")||"";return v(c,L,D,{animate:x}),!0},k=(c,f={})=>{let{animate:x=!1,silent:N=!1}=f;if(!c.length)return!1;if(t.multiSelectMode)return N||ce("\u8BF7\u5148\u9000\u51FA\u591A\u9009\u6A21\u5F0F\u540E\u518D\u7F16\u8F91\u3002","info"),!1;let F=c.data("id"),L=a(F);return L?(C(c,L,{animate:x}),!0):!1},y=(c,f={})=>{let{animate:x=!1}=f;if(!c.length)return!1;let N=c.data("id"),F=a(N);if(!F)return!1;let L=c.data("searchTerm")||"";return M(c,F,L,{animate:x}),!0},O=S(async c=>{c.preventDefault(),c.stopPropagation();let f=r(c.currentTarget).closest(".rlh-item-container");T(f,{animate:!1})}),A=S(async c=>{c.preventDefault(),c.stopPropagation();let f=r(c.currentTarget).closest(".rlh-item-container");s(f,{animate:!1})}),_=S(async c=>{c.preventDefault(),c.stopPropagation();let f=r(c.currentTarget).closest(".rlh-item-container");k(f,{animate:!1})}),B=S(async c=>{c.preventDefault(),c.stopPropagation();let f=r(c.currentTarget).closest(".rlh-item-container");y(f,{animate:!1})}),z=S(async c=>{c.stopPropagation();let f=r(c.currentTarget),x=f.closest(".rlh-book-group, .rlh-item-container");if(x.hasClass("renaming"))return;let N=!x.hasClass("enabled"),F=x.parent();if(f.hasClass("rlh-global-toggle")){f.addClass("rlh-loading");try{let D=x.data("book-name"),X=new Set(await H.getGlobalWorldbookNames()||[]);N?X.add(D):X.delete(D),await H.rebindGlobalWorldbooks(Array.from(X)),await H.saveSettings();let V=t.allLorebooks.find(Z=>Z.name===D);V&&(V.enabled=N)}finally{f.removeClass("rlh-loading")}}else{let D=x.data("type"),X=x.data("id");if(D==="lore"){let V=x.data("book-name");await Me(V,[{uid:Number(X),enabled:N}]);let Z=le(V).find(ee=>ee.uid===Number(X));Z&&(Z.enabled=N)}else{let V=await H.getRegexes(),Z=V.find(ee=>ee.id===X);if(Z){Z.enabled=N,await H.replaceRegexes(V.filter(me=>me.source!=="card")),await H.saveSettings();let ee=t.regexes.global.find(me=>me.id===X)||t.regexes.character.find(me=>me.id===X);ee&&(ee.enabled=N)}}}ce(N?"\u5DF2\u542F\u7528":"\u5DF2\u7981\u7528"),x.toggleClass("enabled",N);let L=F.children().get();L.sort((D,X)=>{let V=r(D).hasClass("enabled"),Z=r(X).hasClass("enabled");if(V!==Z)return Z-V;let ee=r(D).find(".rlh-item-name").text().trim(),me=r(X).find(".rlh-item-name").text().trim();return ee.localeCompare(me)}),F.append(L)}),R=S(async c=>{c.stopPropagation();let x=r(c.currentTarget).closest(".rlh-item-container");if(!x.length)return;let N=x.data("type");if(x.attr("data-entry-mode")==="edit"){U(x),N==="lore"?s(x,{animate:!1}):y(x,{animate:!1});return}if(t.multiSelectMode){ce("\u8BF7\u5148\u9000\u51FA\u591A\u9009\u6A21\u5F0F\u540E\u518D\u7F16\u8F91\u3002","info");return}let L=x.find(".rlh-item-header").first(),D=L.find(".rlh-item-name").first(),X=D.clone().children().remove().end().text().trim(),V=`<div class="rlh-rename-ui"><div class="rlh-rename-input-wrapper"><input type="text" class="rlh-rename-input" value="${I(X)}" /><button class="rlh-action-btn-icon rlh-rename-save-btn" title="\u786E\u8BA4"><i class="fa-solid fa-check"></i></button></div></div>`,Z=!1;N==="lore"?Z=T(x,{animate:!1,silent:!0}):Z=k(x,{animate:!1,silent:!0}),Z&&(L.find(".rlh-rename-ui").length||(x.addClass("renaming"),L.append(V)),D.attr("aria-hidden","true").hide(),L.find(".rlh-rename-input").focus().select())}),U=(c,f=null)=>{let x=c.find(".rlh-item-header").first(),N=x.find(".rlh-item-name").first();f&&N.text(f),x.find(".rlh-rename-ui").remove(),c.attr("data-entry-mode")==="edit"?N.hide().attr("aria-hidden","true"):N.show().removeAttr("aria-hidden"),c.removeClass("renaming")},j=S(async c=>{c.stopPropagation();let f=r(c.currentTarget).closest(".rlh-item-container"),x=f.data("type"),N=()=>{x==="lore"?s(f,{animate:!1}):y(f,{animate:!1})},L=f.find(".rlh-rename-input").val().trim(),D=f.find(".rlh-item-name").first().text().trim();if(!L||L===D){U(f,D),N();return}let X=f.data("id");if(x==="lore"){let V=f.data("book-name");await Me(V,[{uid:Number(X),name:L}]);let ee=[...le(V)].find(me=>me.uid===Number(X));ee&&(ee.name=L)}else{let V=await H.getRegexes(),Z=V.find(ee=>ee.id===X);if(Z){Z.script_name=L,await H.replaceRegexes(V.filter(me=>me.source!=="card")),await H.saveSettings();let ee=t.regexes.global.find(me=>me.id===X)||t.regexes.character.find(me=>me.id===X);ee&&(ee.script_name=L)}}U(f,L),N(),ce("\u91CD\u547D\u540D\u6210\u529F")}),q=S(async c=>{if(c.key==="Enter")r(c.currentTarget).siblings(".rlh-rename-save-btn").click();else if(c.key==="Escape"){c.preventDefault();let f=r(c.currentTarget).closest(".rlh-item-container");U(f)}}),oe=S(async c=>{c.stopPropagation();let f=r(c.currentTarget),N=f.closest(".rlh-editor-wrapper").find("textarea, .rlh-edit-content");f.find("i").hasClass("fa-expand")?(f.attr("title","\u6536\u7F29").find("i").removeClass("fa-expand").addClass("fa-compress"),N.each(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})):(f.attr("title","\u5C55\u5F00").find("i").removeClass("fa-compress").addClass("fa-expand"),N.css("height",""))}),re=Pr(S(async c=>{let x=r(c.currentTarget).data("book-name"),F=Ae().activeBookName??t.activeBookName??t.activeCharacterBook??t.chatLorebook??"",L=x||F;if(!L){await Y({type:"alert",title:"\u521B\u5EFA\u5931\u8D25",text:"\u5F53\u524D\u6CA1\u6709\u9009\u4E2D\u7684\u4E16\u754C\u4E66\uFF0C\u65E0\u6CD5\u521B\u5EFA\u6761\u76EE\u3002"});return}let D=Mt(L),X=pt(D,L);if(X&&X.length){let V=X.find(".rlh-rename-btn");V.length&&V.trigger("click")}try{let V=await H.createWorldbookEntries(L,[{name:D.name,enabled:D.enabled,keys:D.keys}]);if(V&&V.new_entries&&V.new_entries.length>0){_e(L,V.worldbook.map(Pe));let Z=V.new_entries[0];if(Z){Ot(L,D.uid,Z);let ee=r(`#rlh-panel .rlh-item-container[data-id="${D.uid}"]`,o);ee.length&&(ee.attr("data-id",Z.uid),ee.data("id",Z.uid))}Qe(L),ce("\u65B0\u6761\u76EE\u5DF2\u521B\u5EFA")}else throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u4E0D\u6B63\u786E")}catch(V){console.error("[RegexLoreHub] Create entry failed:",V),Y({type:"alert",title:"\u521B\u5EFA\u5931\u8D25",text:`\u521B\u5EFA\u65B0\u6761\u76EE\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u4F46\u60A8\u4ECD\u53EF\u7F16\u8F91\u5F53\u524D\u5185\u5BB9\u5E76\u624B\u52A8\u4FDD\u5B58\u3002\u9519\u8BEF: ${V.message}`})}}),300),de=S(async c=>{c.stopPropagation();let f=r(c.currentTarget).closest(".rlh-item-container"),x=f.data("book-name"),N=Number(f.data("id")),F=f.find(".rlh-item-name").text().trim();try{await Y({type:"confirm",title:"\u786E\u8BA4\u5220\u9664",text:`\u60A8\u786E\u5B9A\u8981\u5220\u9664\u6761\u76EE "${F}" \u5417\uFF1F`})}catch{return}let L=await H.deleteWorldbookEntries(x,[N]);L&&L.deleted_entries&&L.deleted_entries.length>0?(_e(x,L.worldbook.map(Pe)),Qe(x),f.slideUp(300,()=>f.remove()),ce("\u5220\u9664\u6210\u529F")):await Y({type:"alert",title:"\u5220\u9664\u5931\u8D25",text:"\u5220\u9664\u6761\u76EE\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"})}),be=S(async c=>{let f=r(c.currentTarget),x=f.closest(".rlh-editor-grid").find(".rlh-depth-container");f.val().startsWith("at_depth")?x.slideDown(200):x.slideUp(200)});return{handleToggleState:z,handleEditorInput:i,renderLoreEntryViewer:v,renderLoreEntryEditor:w,renderRegexViewer:M,renderRegexEditor:C,handleEntryEnterEdit:O,handleEntryExitEdit:A,handleRegexEnterEdit:_,handleRegexExitEdit:B,handleRename:R,handleConfirmRename:j,handleRenameKeydown:q,handleEditorExpandToggle:oe,handleCreateEntry:re,handleDeleteEntry:de,handlePositionChange:be}}var go=(e,r,o,a,l,n)=>{let i=bt(e,r,o,a,l,n);return Y({type:"confirm",title:"\u786E\u8BA4\u66FF\u6362",html:i})},Ht=S(async e=>{let r=te(),o=ie(),a=r(`#${ne}`,o);if(!a.length)return;let l=a.find(`#${Re.TOOLBAR_SHELL}`);if(l.length||(l=a.find(".rlh-toolbar-shell").first(),l.length&&l.attr("id",Re.TOOLBAR_SHELL)),!l.length)return;let n=!l.hasClass("rlh-toolbar-shell--collapsed");e?.preventDefault?.(),e?.stopPropagation?.(),l.toggleClass("rlh-toolbar-shell--collapsed",n),l.attr("aria-hidden",String(n)),t.isToolbarCollapsed=n;let i=e?.currentTarget?r(e.currentTarget):a.find(`#${Re.TOGGLE_TOOLBAR_BTN}`);i.length&&(i.text(n?"\u5C55\u5F00\u5DE5\u5177\u680F":"\u6298\u53E0\u5DE5\u5177\u680F"),i.attr("aria-expanded",String(!n)),i.attr("title",n?"\u5C55\u5F00\u5DE5\u5177\u680F":"\u6298\u53E0\u5DE5\u5177\u680F"))});function Pt(e={}){let r=e.$??te(),o=e.parentDoc??ie(),a=e.lorebookHandlers,l=e.itemHandlers,n=()=>{switch(t.multiSelectTarget){case"book":return"book:";case"entry":return"lore:";case"regex":return"regex:";default:return""}},i=p=>{let b=String(p??""),$=b.indexOf(":");if($===-1)return{type:b,raw:""};let E=b.slice(0,$),Q=b.slice($+1);if(E==="book")return{type:E,bookName:Q};if(E==="lore"){let K=Q.lastIndexOf(":");return K===-1?{type:E,bookName:Q,entryId:null}:{type:E,bookName:Q.slice(0,K),entryId:Q.slice(K+1)}}return E==="regex"?{type:E,regexId:Q}:{type:E,raw:Q}},u=()=>{if(!t.multiSelectMode)return[];let p=r(`#${ne}`,o);if(!p.length)return[];let b;switch(t.multiSelectTarget){case"book":b=".rlh-book-group[data-select-key]";break;case"entry":b='.rlh-item-container[data-select-key][data-type="lore"]';break;case"regex":b='.rlh-item-container[data-select-key][data-type="regex"]';break;default:b="[data-select-key]";break}let $=[];return p.find(b).each((E,Q)=>{let K=r(Q);if(!K.is(":visible"))return;let P=K.data("select-key");P&&$.push(String(P))}),$},m=()=>{if(!t.selectedItems||t.selectedItems.size===0)return!1;let p=n();if(!p)return t.selectedItems.size>0;for(let b of t.selectedItems)if(b.startsWith(p))return!0;return!1},h=p=>{if(!p||!p.length)return null;if(p.hasClass("rlh-book-group")){if(t.multiSelectTarget!=="book")return null;let b=p.data("book-name");return b?`book:${b}`:null}if(p.hasClass("rlh-item-container")){let b=p.data("type"),$=p.data("id");if(b==="lore"&&t.multiSelectTarget==="entry"){let E=p.data("book-name");return E!=null&&$!=null?`lore:${E}:${$}`:null}if(b==="regex"&&t.multiSelectTarget==="regex")return $!=null?`regex:${$}`:null}return null},d=p=>{let b=h(p);return b?(t.selectedItems.has(b)?(t.selectedItems.delete(b),p.removeClass("selected"),p.find(".rlh-multi-select-checkbox").prop("checked",!1)):(t.selectedItems.add(b),p.addClass("selected"),p.find(".rlh-multi-select-checkbox").prop("checked",!0)),fr(),!0):!1},g=S(async p=>{let b=r(p.currentTarget),$=b.val();b.attr("id")==="rlh-global-search-input"?t.globalSearch.term=$:b.attr("id")==="rlh-global-replace-input"&&(t.globalSearch.replace=$),b.attr("id")==="rlh-global-search-input"&&J()}),v=S(async p=>{if(p.key==="Enter"){p.preventDefault();let b=p.currentTarget.value??"";t.globalSearch.term=b,J()}}),w=S(async()=>{let p=r(`#${Fe}`,o);p.length&&p.val(""),t.globalSearch.term="",J()}),M=S(async()=>{let p=r(`#${Fe}`,o).val(),b=r(`#${rr}`,o).val(),$=Ae();if(!p){await Y({type:"alert",title:"\u66FF\u6362\u5931\u8D25",text:"\u8BF7\u5148\u8F93\u5165\u641C\u7D22\u8BCD\u3002"});return}if($.view==="global-lore-list"){let P=t.allLorebooks.filter(G=>!G.entriesLoaded);if(P.length>0){let G=qe(`\u6B63\u5728\u52A0\u8F7D ${P.length} \u672C\u4E16\u754C\u4E66\u7684\u6761\u76EE...`);try{await Promise.all(P.map(W=>xe(W.name))),G.remove()}catch(W){G.remove(),console.error("[RegexLoreHub] Failed to load entries before replace:",W),await Y({type:"alert",title:"\u52A0\u8F7D\u5931\u8D25",text:"\u5728\u6267\u884C\u66FF\u6362\u524D\u52A0\u8F7D\u4E16\u754C\u4E66\u6761\u76EE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"});return}}}let E,Q,K;if($.type==="lore")if($.view==="global-lore-list"||$.view==="global-lore-detail")({matches:E,stats:Q,booksMatchedByNameOnly:K}=mt(p));else{await Y({type:"alert",title:"\u64CD\u4F5C\u65E0\u6548",text:"\u5F53\u524D\u89C6\u56FE\u4E0D\u652F\u6301\u66FF\u6362\u529F\u80FD\u3002"});return}else if($.type==="regex")({matches:E,stats:Q}=yt(p));else{await Y({type:"alert",title:"\u64CD\u4F5C\u65E0\u6548",text:"\u672A\u77E5\u7684\u89C6\u56FE\u7C7B\u578B\uFF0C\u65E0\u6CD5\u6267\u884C\u66FF\u6362\u3002"});return}if((!E||E.length===0)&&(!K||K.length===0)){await Y({type:"alert",title:"\u65E0\u5339\u914D\u9879",text:"\u672A\u627E\u5230\u53EF\u66FF\u6362\u7684\u6761\u76EE\u3002"});return}try{let P=$.type==="lore"?"lorebook":"regex";await go(E,Q,K,p,b,P);let G=qe("\u6B63\u5728\u6267\u884C\u66FF\u6362...");try{await L(E,p,b),G.remove(),ce("\u66FF\u6362\u5B8C\u6210"),J()}catch(W){G.remove(),console.error("[RegexLoreHub] Replace error:",W),await Y({type:"alert",title:"\u66FF\u6362\u5931\u8D25",text:"\u66FF\u6362\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u3002"})}}catch{console.log("[RegexLoreHub] Replace operation cancelled by user.")}}),C=S(async()=>{let p=Ae();if(!p.showCollapseToggle)return;let b=ar(p),E=(t.collapseStateByContext.get(b)??"expanded")==="collapsed"?"expanded":"collapsed";it(p,E),r(`#${ne}-content .rlh-item-container:visible, #${ne}-content .rlh-book-group:visible`,o).each(function(){let P=r(this),W=P.find(".rlh-collapsible-content").first().is(":visible"),ae=P.find(".rlh-item-header, .rlh-global-book-header").first();E==="expanded"&&!W?ae.trigger("click.rlh",{bulk:!0}):E==="collapsed"&&W&&ae.trigger("click.rlh",{bulk:!0})});let K=r(`#${tr}`,o);if(K.length){let P=E==="collapsed"?"fa-expand-arrows-alt":"fa-compress-arrows-alt",G=E==="collapsed"?"\u5168\u90E8\u5C55\u5F00":"\u5168\u90E8\u6298\u53E0";K.attr("data-collapse-state",E),K.find("i").removeClass("fa-expand-arrows-alt fa-compress-arrows-alt").addClass(P),K.find("span").text(G)}}),T=!1;function s(){return{$menu:r(`#${or}`,o),$button:r(`#${ze}`,o)}}function k(p){if(!T)return;let b=r(p.target);b.closest(`#${or}`).length||b.closest(`#${ze}`).length||_()}function y(p){if(p.key!=="Escape")return;let{$button:b}=s();_(),b.length&&b.trigger("focus")}function O(){T||(r(o).on("click.rlhSortMenu",k),r(o).on("keydown.rlhSortMenu",y),T=!0)}function A(){T&&(r(o).off("click.rlhSortMenu",k),r(o).off("keydown.rlhSortMenu",y),T=!1)}function _(){let{$menu:p,$button:b}=s();p.length&&(p.attr("data-open","false").removeClass("open"),b.length&&b.attr("aria-expanded","false"),A())}function B(){let{$menu:p,$button:b}=s();p.length&&(p.attr("data-open","true").addClass("open"),b.length&&b.attr("aria-expanded","true"),O())}let z=S(async p=>{p.preventDefault(),p.stopPropagation();let{$menu:b}=s();if(!b.length)return;b.attr("data-open")==="true"?_():B()}),R=S(async p=>{p.preventDefault();let b=r(p.currentTarget).data("sort-value");if(!b)return;_();let $=Ae();st($,b),J()}),U=!1;function j(){return{$menu:r(`#${He}`,o),$button:r(`#${Oe}`,o)}}function q(p){if(!U)return;let b=r(p.target);b.closest(`#${He}`).length||b.closest(`#${Oe}`).length||be()}function oe(p){if(p.key!=="Escape")return;let{$button:b}=j();be(),b.length&&b.trigger("focus")}function re(){U||(r(o).on("click.rlhPositionMenu",q),r(o).on("keydown.rlhPositionMenu",oe),U=!0)}function de(){U&&(r(o).off("click.rlhPositionMenu",q),r(o).off("keydown.rlhPositionMenu",oe),U=!1)}function be(){let{$menu:p,$button:b}=j();p.length&&(p.attr("data-open","false").removeClass("open"),b.length&&b.attr("aria-expanded","false"),de())}function c(){let{$menu:p,$button:b}=j();p.length&&(b.is("[disabled]")||(p.attr("data-open","true").addClass("open"),b.length&&b.attr("aria-expanded","true"),re()))}let f=S(async p=>{p.preventDefault(),p.stopPropagation();let{$menu:b}=j();if(!b.length)return;b.attr("data-open")==="true"?be():c()}),x=S(async p=>{p.preventDefault();let b=r(p.currentTarget),$=(b.data("position-value")??"").toString().trim(),E=(b.data("book-name")??b.closest(`#${He}`).data("book-name")??"").toString().trim();be(),$&&a?.applyUnifiedPosition&&await a.applyUnifiedPosition({bookName:E,positionValue:$})}),N=S(async p=>{let b=(r(p.currentTarget).val()??"").toString().trim();!b||t.activeCharacterBook===b||(t.activeCharacterBook=b,J())}),F=S(async p=>{let b=r(p.currentTarget),$=b.data("select-key");if(!$)return;if(!t.multiSelectMode){b.prop("checked",!1);return}let E=b.is(":checked");E?t.selectedItems.add($):t.selectedItems.delete($),b.closest("[data-select-key]").toggleClass("selected",E),fr()}),L=async(p,b,$)=>{let E=lt(b,!1),Q=new Map,K=(P,G)=>{if(!Array.isArray(P)||!Array.isArray(G)||P.length!==G.length)return!1;for(let W=0;W<P.length;W+=1)if(P[W]!==G[W])return!1;return!0};for(let P of p){let{bookName:G,entry:W}=P??{};if(!G||!W)throw new Error("\u4EC5\u652F\u6301\u4E16\u754C\u4E66\u6761\u76EE\u7684\u6279\u91CF\u66FF\u6362\u3002");let ae=Number(W?.uid);if(!Number.isFinite(ae))continue;let he={uid:ae},ue=!1;if(Array.isArray(W.keys)){let se=W.keys.map(er=>er.replace(E,$));K(W.keys,se)||(he.keys=se,ue=!0)}if(typeof W.content=="string"){let se=W.content.replace(E,$);se!==W.content&&(he.content=se,ue=!0)}if(typeof W.name=="string"){let se=W.name.replace(E,$);se!==W.name&&(he.name=se,ue=!0)}if(typeof W.comment=="string"){let se=W.comment.replace(E,$);se!==W.comment&&(he.comment=se,ue=!0)}ue&&(Q.has(G)||Q.set(G,[]),Q.get(G).push(he))}for(let[P,G]of Q.entries())G.length!==0&&await Me(P,G)},D=S(async()=>{r(`#${ne}`,o).is(":visible")?X():await V()}),X=async()=>{ce("\u6B63\u5728\u540E\u53F0\u4FDD\u5B58\u6570\u636E...","info"),Ge().then(()=>{ce("\u6570\u636E\u4FDD\u5B58\u6210\u529F\uFF01","success")}).catch($=>{console.error("[RegexLoreHub] Background save failed:",$),ce("\u540E\u53F0\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u65E5\u5FD7\u3002","error")});let p=r(`#${ne}`,o),b=r("body",o);p.hide(),r(`#${De}`,o).removeClass("active"),b.off("mousedown.rlh-outside-click")},V=async()=>{let p=r(`#${ne}`,o),b=r("body",o);p.css("display","flex"),r(`#${De}`,o).addClass("active"),b.on("mousedown.rlh-outside-click",function($){r($.target).closest(`#${ne}`).length===0&&r($.target).closest(`#${De}`).length===0&&X()}),t.isDataLoaded?J():await Ne()},Z=S(async p=>{t.isLoadingTabData=!0,J();try{await It();let b=$=>{if(!$)return null;Array.isArray(t.allLorebooks)||(t.allLorebooks=[]);let E=t.allLorebooks.find(Q=>Q.name===$);return E||(E={name:$,enabled:!1,entryCount:0,enabledEntryCount:0,entriesLoaded:!1},t.allLorebooks.push(E)),E};if(p==="char-lore"){let $=Array.isArray(t.lorebooks.character)?t.lorebooks.character:[];for(let E of $)b(E),await xe(E,!0)}else if(p==="chat-lore"){let $=t.chatLorebook;$&&(b($),await xe($,!0))}}catch(b){console.error(`[RegexLoreHub] Error refreshing tab ${p}:`,b),S(()=>{throw b})()}finally{t.isLoadingTabData=!1,J()}}),ee=S(async p=>{let b=r(p.currentTarget).data("tab");if(b==="global-lore"&&t.activeView==="global-lore-detail"){await a.handleExitLorebookDetail();return}t.activeTab=b,r(`#${ne} .rlh-tab`,o).removeClass("active"),r(p.currentTarget).addClass("active"),r(`#${wr}`,o).toggle(t.activeTab==="global-lore"),t.selectedItems.clear(),b==="char-lore"&&!t.charLoreInitialSynced&&(await Ne(),t.charLoreInitialSynced=!0),b==="char-lore"||b==="chat-lore"?await Z(b):J()}),me=S(async p=>{t.multiSelectMode=!t.multiSelectMode,t.selectedItems.clear(),r("#rlh-multi-select-btn",o).toggleClass("active",t.multiSelectMode),r("#rlh-multi-select-controls",o).toggleClass("active",t.multiSelectMode),J()}),we=S(async()=>{if(!t.multiSelectMode)return;let p=u();p.length&&(p.forEach(b=>t.selectedItems.add(b)),J())}),fe=S(async()=>{if(!t.multiSelectMode)return;let p=n(),b=!1;if(p)[...t.selectedItems].forEach(E=>{E.startsWith(p)&&(t.selectedItems.delete(E),b=!0)});else{if(t.selectedItems.size===0)return;t.selectedItems.clear(),b=!0}b&&J()}),Le=S(async()=>{if(!t.multiSelectMode)return;let p=u();p.length&&(p.forEach(b=>{t.selectedItems.has(b)?t.selectedItems.delete(b):t.selectedItems.add(b)}),J())}),sr=S(async()=>{if(t.multiSelectMode){if(!m())return await Y({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u9009\u62E9\u8981\u542F\u7528\u7684\u9879\u76EE\u3002"});await Ue(!0),ce("\u6279\u91CF\u542F\u7528\u6210\u529F")}}),Ye=S(async()=>{if(t.multiSelectMode){if(!m())return await Y({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u9009\u62E9\u8981\u7981\u7528\u7684\u9879\u76EE\u3002"});await Ue(!1),ce("\u6279\u91CF\u7981\u7528\u6210\u529F")}}),Je=S(async()=>{if(!t.multiSelectMode)return;let p=new Set,b=new Map,$=new Set,E=0;for(let G of t.selectedItems){let{type:W,bookName:ae,entryId:he,regexId:ue}=i(G);if(W==="book"&&ae)p.add(ae);else if(W==="lore"&&ae){let se=Number(he);if(!Number.isFinite(se))continue;b.has(ae)||b.set(ae,[]),b.get(ae).push(se),E++}else if(W==="regex"){let se=ue!=null&&ue!==""?String(ue):"";se&&$.add(se)}}if(p.size===0&&E===0&&$.size===0)return await Y({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u9009\u62E9\u8981\u5220\u9664\u7684\u9879\u76EE\u3002"});let Q="\u60A8\u786E\u5B9A\u8981\u6C38\u4E45\u5220\u9664",K=[];p.size>0&&K.push(`\u9009\u4E2D\u7684 ${p.size} \u672C\u4E16\u754C\u4E66`),E>0&&K.push(`${E} \u4E2A\u6761\u76EE`),$.size>0&&K.push(`${$.size} \u4E2A\u6B63\u5219`),Q+=` ${K.join("\u548C")} \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`;try{await Y({type:"confirm",title:"\u786E\u8BA4\u5220\u9664",text:Q})}catch{return}let P=qe("\u5F00\u59CB\u5220\u9664...");try{let G=0,W=0,ae=0,he=0,ue=0,se=Array.from(b.entries());for(let[Ce,Te]of se){if(p.has(Ce)){he+=Te.length;continue}P.update(`\u6B63\u5728\u5220\u9664\u6761\u76EE... (${he}/${E})`);let ke=await H.deleteWorldbookEntries(Ce,Te);he+=Te.length,ke&&ke.deleted_entries&&ke.deleted_entries.length>0&&(W+=ke.deleted_entries.length,_e(Ce,ke.worldbook.map(Pe)),Te.forEach(Wt=>t.selectedItems.delete(`lore:${Ce}:${Wt}`)))}let er=Array.from(p);for(let Ce of er){if(P.update(`\u6B63\u5728\u5220\u9664\u4E16\u754C\u4E66... (${ue+1}/${er.length})`),await H.deleteWorldbook(Ce)){G++,t.allLorebooks=t.allLorebooks.filter(Te=>Te.name!==Ce),br(Ce),t.selectedItems.delete(`book:${Ce}`);for(let Te of t.selectedItems)Te.startsWith(`lore:${Ce}:`)&&t.selectedItems.delete(Te)}ue++}if($.size>0){P.update(`\u6B63\u5728\u5220\u9664 ${$.size} \u4E2A\u6B63\u5219...`);let Ce=await H.getRegexes(),Te=Ce.filter(ke=>!$.has(String(ke.id)));await H.replaceRegexes(Te.filter(ke=>ke.source!=="card")),await H.saveSettings(),ae=Ce.length-Te.length,t.regexes.global=t.regexes.global.filter(ke=>!$.has(String(ke.id))),t.regexes.character=t.regexes.character.filter(ke=>!$.has(String(ke.id))),Be(t.regexes.global),Be(t.regexes.character),$.forEach(ke=>t.selectedItems.delete(`regex:${ke}`))}P.remove();let cr=[];G>0&&cr.push(`\u6210\u529F\u5220\u9664 ${G} \u672C\u4E16\u754C\u4E66`),W>0&&cr.push(`\u6210\u529F\u5220\u9664 ${W} \u4E2A\u6761\u76EE`),ae>0&&cr.push(`\u6210\u529F\u5220\u9664 ${ae} \u4E2A\u6B63\u5219`),cr.length>0?(ce(cr.join("\uFF0C")),t.multiSelectMode?me():J()):await Y({type:"alert",title:"\u5220\u9664\u5931\u8D25",text:"\u5220\u9664\u9879\u76EE\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"})}catch(G){P.remove(),console.error("[RegexLoreHub] Batch delete failed:",G),await Y({type:"alert",title:"\u5220\u9664\u5931\u8D25",text:`\u64CD\u4F5C\u5931\u8D25: ${G.message}`}),await Ne(!0)}}),ve=S(async()=>{if(!Array.isArray(t.allLorebooks)||t.allLorebooks.length===0){await Y({type:"alert",title:"\u63D0\u793A",text:"\u6CA1\u6709\u627E\u5230\u53EF\u4EE5\u6E05\u7406\u7684\u4E16\u754C\u4E66\u3002"});return}let p=t.allLorebooks.filter(K=>{let P=t.lorebookUsage instanceof Map?t.lorebookUsage.get(K.name):[],G=Array.isArray(P)?P:[];return!K.enabled&&G.length===0}).map(K=>K.name);if(p.length===0){await Y({type:"alert",title:"\u63D0\u793A",text:"\u6CA1\u6709\u627E\u5230\u672A\u542F\u7528\u4E14\u672A\u7ED1\u5B9A\u89D2\u8272\u5361\u7684\u4E16\u754C\u4E66\u3002"});return}t.multiSelectMode=!0,t.multiSelectTarget="book",t.selectedItems.clear(),p.forEach(K=>t.selectedItems.add("book:"+K)),J();let b="\u5C06\u5220\u9664 "+p.length+" \u672C\u672A\u542F\u7528\u4E14\u672A\u7ED1\u5B9A\u89D2\u8272\u5361\u7684\u4E16\u754C\u4E66\u3002\u56E0API\u9650\u5236\uFF0C\u65E0\u6CD5\u76F4\u63A5\u83B7\u53D6\u804A\u5929\u7ED1\u5B9A\u4E16\u754C\u4E66\uFF0C\u5B58\u5728\u8BEF\u5220\u8BE5\u4E16\u754C\u4E66\u7684\u53EF\u80FD\u3002\u786E\u5B9A\u7EE7\u7EED\u5417\uFF1F";try{await Y({type:"confirm",title:"\u786E\u8BA4\u6E05\u7406\u5B64\u7ACB\u4E16\u754C\u4E66",text:b})}catch{return}let $=qe("\u5F00\u59CB\u6E05\u7406\u5B64\u7ACB\u4E16\u754C\u4E66..."),E=[],Q=0;try{for(let K=0;K<p.length;K+=1){let P=p[K];$.update("\u6B63\u5728\u5220\u9664\u7B2C "+(K+1)+" / "+p.length+" \u672C\u4E16\u754C\u4E66..."),await H.deleteWorldbook(P)?(Q+=1,t.allLorebooks=t.allLorebooks.filter(ae=>ae.name!==P),br(P),t.lorebookUsage instanceof Map&&t.lorebookUsage.has(P)&&t.lorebookUsage.delete(P),Array.isArray(t.lorebooks?.character)&&(t.lorebooks.character=t.lorebooks.character.filter(ae=>ae!==P)),t.chatLorebook===P&&(t.chatLorebook=null),t.activeCharacterBook===P&&(t.activeCharacterBook=null),t.activeBookName===P&&(t.activeBookName=null),t.selectedItems.delete("book:"+P),[...t.selectedItems].forEach(ae=>{ae.startsWith("lore:"+P+":")&&t.selectedItems.delete(ae)})):E.push(P)}}catch(K){$.remove(),console.error("[RegexLoreHub] Clean orphan lorebooks failed:",K),await Y({type:"alert",title:"\u64CD\u4F5C\u5931\u8D25",text:"\u6E05\u7406\u5B64\u7ACB\u4E16\u754C\u4E66\u65F6\u53D1\u751F\u9519\u8BEF\uFF1A"+(K?.message||K)}),await Ne(!0);return}$.remove(),Q>0&&ce("\u5DF2\u5220\u9664 "+Q+" \u672C\u5B64\u7ACB\u4E16\u754C\u4E66"),E.length>0?(t.selectedItems.clear(),E.forEach(K=>t.selectedItems.add("book:"+K)),await Y({type:"alert",title:"\u90E8\u5206\u5220\u9664\u5931\u8D25",text:"\u4EE5\u4E0B\u4E16\u754C\u4E66\u672A\u80FD\u5220\u9664\uFF1A"+E.join("\u3001")})):(t.selectedItems.clear(),t.multiSelectMode=!1),J()}),Ue=S(async p=>{let b=new Set,$=new Map,E=new Set,Q=!1,K=!1;for(let P of t.selectedItems){let{type:G,bookName:W,entryId:ae,regexId:he}=i(P);if(G==="book"&&W)b.add(W);else if(G==="lore"&&W){let ue=Number(ae);if(!Number.isFinite(ue))continue;$.has(W)||$.set(W,[]),$.get(W).push(ue)}else if(G==="regex"){let ue=he!=null&&he!==""?String(he):"";ue&&E.add(ue)}}if(b.size>0){let P=new Set(await H.getGlobalWorldbookNames()||[]);b.forEach(G=>p?P.add(G):P.delete(G)),await H.rebindGlobalWorldbooks(Array.from(P)),K=!0,b.forEach(G=>{let W=t.allLorebooks.find(ae=>ae.name===G);W&&(W.enabled=p)})}if($.size>0)for(let[P,G]of $){let W=[...le(P)];if(W){let ae=G.map(he=>{let ue=W.find(se=>se.uid===he);return ue?(ue.enabled=p,{uid:he,enabled:p}):null}).filter(Boolean);ae.length>0&&await Me(P,ae)}}if(await H.saveSettings(),E.size>0){let P=await H.getRegexes();P.forEach(G=>{E.has(String(G.id))&&(G.enabled=p)}),await H.replaceRegexes(P.filter(G=>G.source!=="card")),Q=!0,[t.regexes.global,t.regexes.character].forEach(G=>G.forEach(W=>{E.has(String(W.id))&&(W.enabled=p)}))}(K||Q)&&await H.saveSettings(),t.selectedItems.clear(),J()}),ye=S(async(p,b)=>{let $=r(p.target),E=r(p.currentTarget).closest(".rlh-item-container, .rlh-book-group");if($.closest(".rlh-item-controls, .rlh-rename-ui").length>0||t.multiSelectMode&&d(E))return;if(!t.multiSelectMode&&t.activeTab==="global-lore"&&t.activeView==="global-lore-list"&&E.is(".rlh-book-group")&&$.closest(".rlh-book-title-wrapper").length>0){let K=E.data("book-name");K&&a?.handleEnterLorebookDetail&&await a.handleEnterLorebookDetail(K);return}if(E.hasClass("from-card")||E.hasClass("renaming"))return;let Q=E.find(".rlh-collapsible-content").first();if(E.is(".rlh-book-group")&&t.activeTab!=="global-lore"){Q.slideToggle(200);return}if(E.is(".rlh-item-container")){if(Q.is(":visible")){Q.stop(!0,!0).slideUp(200,()=>{Q.off("input.rlh"),Q.empty(),Q.attr("data-entry-mode","collapsed")}),E.attr("data-entry-mode","collapsed");return}b?.bulk||E.siblings(".rlh-item-container").find(".rlh-collapsible-content:visible").slideUp(200).empty();let K=E.data("type"),P=E.data("id"),G=E.data("searchTerm"),W=E.attr("data-search-term"),ae=typeof G=="string"&&G.length>0?G:typeof W=="string"&&W.length>0?W:"";if(K==="lore"){let he=E.data("book-name"),se=[...le(he)].find(er=>er.uid===Number(P));if(!se)return;l.renderLoreEntryViewer(E,se,ae,{animate:!0});return}if(K==="regex"){let he=[...t.regexes.global,...t.regexes.character].find(se=>se.id===P);if(!he)return;E.attr("data-entry-mode")==="edit"?l.renderRegexEditor(E,he,{animate:!0}):l.renderRegexViewer(E,he,ae,{animate:!0});return}}}),Ze=S(async p=>{if(!t.multiSelectMode||r(p.target).closest(".rlh-item-controls, .rlh-rename-ui, .rlh-action-btn, .rlh-action-btn-icon, .rlh-toggle-btn, .rlh-selection-control, .rlh-multi-select-checkbox, .rlh-item-header, .rlh-global-book-header").length>0)return;let $=r(p.currentTarget).closest(".rlh-item-container, .rlh-book-group");$.length&&d($)&&(p.stopPropagation(),p.preventDefault())}),kr=S(async p=>{p.stopPropagation();let b=r(p.currentTarget),$=b.closest(".rlh-book-group"),E=!$.hasClass("editing-entries");$.toggleClass("editing-entries"),E?(t.multiSelectMode||(t.multiSelectMode=!0,r("#rlh-multi-select-btn",o).addClass("active"),r("#rlh-multi-select-controls",o).addClass("active"),r(`#${ne}`,o).addClass("rlh-multi-select-mode")),$.find(".rlh-collapsible-content").first().slideDown(200),b.attr("title","\u5B8C\u6210\u7F16\u8F91").find("i").removeClass("fa-pen-to-square").addClass("fa-check-square"),b.addClass("active")):(b.attr("title","\u7F16\u8F91/\u9009\u62E9\u6761\u76EE").find("i").removeClass("fa-check-square").addClass("fa-pen-to-square"),b.removeClass("active"))}),Ar=S(async p=>{let $=r(p.currentTarget).find("i");$.addClass("fa-spin");let E=null;t.activeView==="global-lore-detail"&&t.activeBookName&&(E=le(t.activeBookName),console.log(`[RegexLoreHub] \u5168\u5C40\u5237\u65B0\u65F6\u7F13\u5B58\u8BE6\u60C5\u89C6\u56FE\u6761\u76EE: ${t.activeBookName}`)),yr(),await Ne(!0),E&&t.activeView==="global-lore-detail"&&t.activeBookName&&(_e(t.activeBookName,E),Qe(t.activeBookName),console.log(`[RegexLoreHub] \u6062\u590D\u8BE6\u60C5\u89C6\u56FE\u6761\u76EE: ${t.activeBookName}`),xe(t.activeBookName,!0).catch(Q=>{console.warn(`[RegexLoreHub] \u6062\u590D\u540E\u5237\u65B0\u6761\u76EE\u5931\u8D25: ${t.activeBookName}`,Q)}),J()),setTimeout(()=>$.removeClass("fa-spin"),500)}),zt=S(async p=>{if(t.activeView==="global-lore-list")a?.handleCreateLorebook&&await a.handleCreateLorebook(p);else if(t.activeView==="global-lore-detail"){if(!t.activeBookName)return;if(l?.handleCreateEntry){let b={currentTarget:r(`<button data-book-name="${t.activeBookName}"></button>`)};await l.handleCreateEntry(b)}}});return{handleGlobalSearch:g,handleSearchClear:w,handleSearchInputKeydown:v,handleReplace:M,handleToolbarToggleCollapse:C,handleSortMenuToggle:z,handleSortOptionSelect:R,handlePositionMenuToggle:f,handlePositionOptionSelect:x,handleCharacterBookSwitch:N,handleSelectionCheckboxChange:F,togglePanel:D,switchTab:ee,toggleMultiSelectMode:me,handleSelectAll:we,handleSelectNone:fe,handleSelectInvert:Le,handleBatchEnable:sr,handleBatchDisable:Ye,handleBatchDelete:Je,handleCleanOrphanLorebooks:ve,handleHeaderClick:ye,handleMultiSelectContainerClick:Ze,handleEditEntriesToggle:kr,handleRefresh:Ar,handlePrimaryCreateButtonClick:zt}}function Ut(){let e=te(),r=ie(),o=ge(),a={$:e,parentDoc:r,parentWin:o},l=Bt(a),n=Dt(a),i=Pt({...a,lorebookHandlers:l,itemHandlers:n});return{...l,...n,...i}}var Vr=`
/*! tailwindcss v4.1.13 | MIT License | https://tailwindcss.com */
@layer theme{:root,:host{--rlh-font-sans:ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--rlh-spacing:.25rem;--rlh-text-sm:.875rem;--rlh-text-sm--line-height:calc(1.25/.875);--rlh-text-base:1rem;--rlh-text-base--line-height:calc(1.5/1);--rlh-font-weight-medium:500;--rlh-radius-lg:.5rem;--rlh-radius-xl:.75rem;--rlh-ease-out:cubic-bezier(0,0,.2,1);--rlh-blur-xl:24px;--rlh-default-transition-duration:.15s;--rlh-default-transition-timing-function:cubic-bezier(.4,0,.2,1)}}@layer utilities;@layer base{#regex-lore-hub-panel *{text-shadow:none!important}#regex-lore-hub-panel{--rlh-panel-radius:20px;--rlh-focus-ring:0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-focus-ring:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}#regex-lore-hub-panel{--rlh-bg-color:#f5f7fb;--rlh-surface-color:#fffd;--rlh-text-color:#0f172a;--rlh-em-color:#475569;--rlh-border-color:#bfc8f5;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)12%,transparent)}}#regex-lore-hub-panel{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)20%,transparent)}}#regex-lore-hub-panel{--rlh-shadow-color:#0f172a2e;--rlh-header-bg:#eef2ffd9;--rlh-input-bg:#ffffffeb;--rlh-accent-color:#4f46e5;--rlh-green:#10b981;--rlh-red:#ef4444;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)18%,transparent)}}#regex-lore-hub-panel{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)18%,transparent)}}#regex-lore-hub-panel.dark{--rlh-bg-color:#101827;--rlh-surface-color:#111827cc;--rlh-text-color:#f9fafb;--rlh-em-color:#94a3b8;--rlh-border-color:#1f2933;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)14%,transparent)}}#regex-lore-hub-panel.dark{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)22%,transparent)}}#regex-lore-hub-panel.dark{--rlh-shadow-color:#02061780;--rlh-header-bg:#0f172ae6;--rlh-input-bg:#1f2937d9;--rlh-accent-color:#6366f1;--rlh-green:#22d3ee;--rlh-red:#f43f5e;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)20%,transparent)}}#regex-lore-hub-panel.dark{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)20%,transparent)}}@keyframes rlhFadeInUp{0%{opacity:0;transform:translateY(18px)scale(.98)}65%{opacity:1;transform:translateY(-4px)scale(1.01)}to{opacity:1;transform:translateY(0)scale(1)}}@keyframes rlhSoftPulse{}@keyframes rlhToastIn{0%{opacity:0;transform:translate(-50%)translateY(28px)scale(.96)}60%{opacity:1;transform:translate(-50%)translateY(-4px)scale(1.02)}to{opacity:1;transform:translate(-50%)translateY(0)scale(1)}}@keyframes rlhHighlightPulse{0%{background-color:#fde68a}50%{background-color:#facc15}to{background-color:#fde68a}}}@layer components{#regex-lore-hub-panel{z-index:10000;width:100%;height:100dvh;min-height:100svh;color:var(--rlh-text-color);background:var(--rlh-bg-color);justify-content:center;align-items:center;padding:clamp(.8rem,1.5vw,1.3rem);display:none;position:fixed;inset:0}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{background:color-mix(in srgb,var(--rlh-bg-color)92%,transparent)}}#regex-lore-hub-panel{-webkit-backdrop-filter:blur(24px);backdrop-filter:blur(24px);font-family:Inter,Segoe UI,Microsoft YaHei,sans-serif;transition:opacity .25s}@media (max-width:1024px){#regex-lore-hub-panel{justify-content:flex-start;align-items:stretch}}#regex-lore-hub-panel .rlh-shell{border-radius:var(--rlh-panel-radius);background:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);width:min(1250px,100%);height:100%;box-shadow:0 32px 120px -60px var(--rlh-shadow-color);flex-direction:column;gap:clamp(.45rem,1vw,.75rem);margin:0 auto;padding:clamp(.75rem,1.4vw,1.15rem);animation:.45s cubic-bezier(.22,.7,.36,1) both rlhFadeInUp;display:flex;position:relative;overflow:hidden}#regex-lore-hub-panel .rlh-shell:before{content:"";background:radial-gradient(circle at top right,var(--rlh-accent-color)0%,transparent 60%),radial-gradient(circle at bottom left,var(--rlh-green)0%,transparent 65%);position:absolute;inset:-140px}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-shell:before{background:radial-gradient(circle at top right,color-mix(in srgb,var(--rlh-accent-color)24%,transparent)0%,transparent 60%),radial-gradient(circle at bottom left,color-mix(in srgb,var(--rlh-green)18%,transparent)0%,transparent 65%)}}#regex-lore-hub-panel .rlh-shell:before{opacity:.32;pointer-events:none}@media (max-width:768px){#regex-lore-hub-panel .rlh-shell{border-radius:14px;padding:.55rem}}@media (min-width:1360px){#regex-lore-hub-panel .rlh-shell{border-radius:20px;padding:1.05rem 1.3rem}}.rlh-shell-header{justify-content:space-between;align-items:center;gap:.55rem;padding-block:.08rem;display:flex}.rlh-shell-title{flex-direction:column;gap:.18rem;display:flex}.rlh-shell-title h4{color:var(--rlh-text-color);margin:0;font-size:clamp(1rem,2vw,1.3rem);font-weight:600;line-height:1.2}.rlh-shell-meta{color:var(--rlh-em-color);align-items:center;gap:.35rem;font-size:.75rem;line-height:1.2;display:inline-flex;margin:0!important}.rlh-shell-version{background:var(--rlh-accent-color);border-radius:9999px;align-items:center;padding:.1rem .55rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-shell-version{background:color-mix(in srgb,var(--rlh-accent-color)16%,transparent)}}.rlh-shell-version{color:var(--rlh-text-color);font-size:.78rem;font-weight:600}.rlh-shell-dot{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-shell-dot{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-shell-dot{font-size:.75rem;line-height:1}.rlh-shell-updated{color:var(--rlh-em-color);font-size:.78rem}.rlh-shell-actions{align-items:center;gap:.4rem;display:flex}.rlh-shell-right{align-items:center;gap:.6rem;margin-left:auto;display:flex}.rlh-prefetch-indicator{text-align:right;flex-direction:column;align-items:flex-end;gap:.35rem;width:clamp(200px,34vw,320px);display:none}.rlh-prefetch-indicator[data-visible=true]{display:flex}.rlh-prefetch-text{color:var(--rlh-em-color);white-space:normal;font-size:.78rem}#rlh-prefetch-progress-text{width:100%}.rlh-prefetch-bar{background:var(--rlh-accent-color);border-radius:9999px;width:100%;height:4px;position:relative}@supports (color:color-mix(in lab, red, red)){.rlh-prefetch-bar{background:color-mix(in srgb,var(--rlh-accent-color)20%,transparent)}}.rlh-prefetch-bar{overflow:hidden}.rlh-prefetch-bar-inner{border-radius:inherit;background:var(--rlh-accent-color);width:0%;height:100%;transition:width .25s;display:block}.rlh-icon-button,.rlh-close-button{width:2.25rem;height:2.25rem;color:var(--rlh-text-color);cursor:pointer;background-color:#0000;border:1px solid #0000;border-radius:9999px;justify-content:center;align-items:center;transition:color .2s,background-color .2s,border-color .2s;display:inline-flex}.rlh-icon-button:hover,.rlh-close-button:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-icon-button:hover,.rlh-close-button:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-theme-toggle{border:1px solid var(--rlh-accent-color);border-radius:9999px;align-items:center;gap:.35rem;padding:.4rem .9rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle{border:1px solid color-mix(in srgb,var(--rlh-accent-color)28%,transparent)}}.rlh-theme-toggle{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle{background-color:color-mix(in srgb,var(--rlh-accent-color)12%,transparent)}}.rlh-theme-toggle{color:var(--rlh-text-color);cursor:pointer;font-size:.85rem;font-weight:500;transition:background-color .2s,color .2s,border-color .2s}.rlh-theme-toggle:hover{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)18%,transparent)}}.rlh-tab-nav{background-color:var(--rlh-header-bg);flex-wrap:wrap;gap:.4rem;padding:.35rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-tab-nav{background-color:color-mix(in srgb,var(--rlh-header-bg)85%,transparent)}}.rlh-tab-nav{border:1px solid var(--rlh-border-color);border-radius:9999px}@supports (color:color-mix(in lab, red, red)){.rlh-tab-nav{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-tab{color:var(--rlh-em-color);cursor:pointer;border-radius:9999px;justify-content:center;align-items:center;gap:.55rem;padding:.4rem 1.1rem;font-size:.9rem;font-weight:500;transition:color .2s,background-color .2s,transform .2s;display:inline-flex}.rlh-tab:hover{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color)}.rlh-tab.active{background-color:var(--rlh-selected-bg);color:var(--rlh-text-color);box-shadow:inset 0 0 0 1px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-tab.active{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)60%,transparent)}}.rlh-tab-text-short{display:none}@media (max-width:640px){.rlh-tab-text-full{display:none}.rlh-tab-text-short{display:inline}}.rlh-main-area{flex-direction:column;flex:auto;gap:clamp(.6rem,1.4vw,1rem);width:100%;min-height:0;padding:0;display:flex}.rlh-toolbar-shell{flex-direction:column;gap:clamp(.6rem,1.3vw,.95rem);width:100%;display:flex}.rlh-toolbar-container,.rlh-replace-container{flex-direction:column;gap:clamp(.65rem,1.1vw,.9rem);display:flex}.rlh-toolbar-inner{background-color:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:clamp(.125rem,.3vw,.25rem);padding:clamp(.25rem,.5vw,.4rem);display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{background-color:color-mix(in srgb,var(--rlh-surface-color)95%,var(--rlh-accent-color)5%)}}.rlh-toolbar-inner{border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{border:1px solid color-mix(in srgb,var(--rlh-accent-color)24%,var(--rlh-border-color))}}.rlh-toolbar-inner{box-shadow:0 16px 42px -34px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{box-shadow:0 16px 42px -34px color-mix(in srgb,var(--rlh-shadow-color)78%,transparent)}}@media (max-width:768px){.rlh-toolbar-inner{border-radius:14px;padding:.55rem}.rlh-toolbar-section{gap:.4rem;padding:.45rem}}@media (min-width:1360px){.rlh-toolbar-inner{gap:1.1rem;padding:1.05rem 1.3rem}.rlh-toolbar-section{gap:.8rem;padding:.6rem .8rem}}.rlh-toolbar-section{background-color:#0000;border:none;border-radius:12px;flex-direction:column;gap:clamp(.1rem,.3vw,.2rem);padding:clamp(.1rem,.25vw,.2rem);display:flex}.rlh-toolbar-section--search,.rlh-toolbar-section--actions,.rlh-toolbar-section--multiselect{background-color:#0000}.rlh-toolbar-section--actions{flex-direction:row;align-items:center}.rlh-search-section-grid{flex-wrap:nowrap;align-items:stretch;gap:clamp(.25rem,.7vw,.5rem);display:flex}.rlh-search-section-main{flex:18rem;min-width:0}.rlh-search-section-multiselect{flex:0 14rem;justify-content:flex-start;align-items:flex-start;min-width:10rem;max-width:20rem;padding:5px 0 0;display:flex}.rlh-search-section-multiselect .rlh-multi-select-module{flex-direction:column;align-items:flex-start;gap:.25rem;width:100%;display:flex}.rlh-toolbar-section--actions .rlh-toolbar-actions{flex-wrap:wrap;justify-content:flex-start;align-items:center;gap:clamp(.25rem,.6vw,.45rem);width:100%;display:flex;overflow:visible}.rlh-toolbar-section--actions .rlh-toolbar-actions>*{flex-shrink:0}@media (max-width:960px){.rlh-search-section-grid{flex-direction:column}.rlh-search-section-main,.rlh-search-section-multiselect{flex:100%;max-width:none}.rlh-search-box{grid-template-columns:minmax(0,1fr);grid-template-areas:"row""replace""meta"}.rlh-replace-body{grid-template-columns:minmax(0,1fr) auto}}.rlh-content-pane{flex-direction:column;flex:auto;gap:clamp(.8rem,1.6vw,1.2rem);min-height:0;padding:0;display:flex}.rlh-content-pane>*{min-width:0}@media (max-width:768px){.rlh-content-pane{gap:.6rem}}.rlh-toolbar-btn{border:1px solid var(--rlh-accent-color);border-radius:12px;justify-content:flex-start;align-items:center;gap:.35rem;padding:.125rem .75rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{border:1px solid color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}.rlh-toolbar-btn{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-toolbar-btn{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{color:color-mix(in srgb,var(--rlh-text-color)90%,var(--rlh-accent-color)10%)}}.rlh-toolbar-btn{cursor:pointer;box-shadow:inset 0 0 0 1px var(--rlh-accent-color);font-size:.9rem;font-weight:500}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)25%,transparent)}}.rlh-toolbar-btn{transition:color .2s,background-color .2s,border-color .2s,box-shadow .2s,transform .2s}.rlh-toolbar-icon-btn{border:1px solid var(--rlh-accent-color);border-radius:12px;justify-content:center;align-items:center;width:2.1rem;height:2.1rem;padding:0;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{border:1px solid color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}.rlh-toolbar-icon-btn{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-toolbar-icon-btn{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{color:color-mix(in srgb,var(--rlh-text-color)90%,var(--rlh-accent-color)10%)}}.rlh-toolbar-icon-btn{cursor:pointer;line-height:1;transition:color .2s,background-color .2s,border-color .2s,box-shadow .2s,transform .2s}.rlh-toolbar-icon-btn i{font-size:.95rem}.rlh-toolbar-icon-btn:hover{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)92%,var(--rlh-accent-color)20%)}}.rlh-toolbar-icon-btn:hover{color:var(--rlh-text-color)}.rlh-toolbar-icon-btn:focus{box-shadow:0 0 0 2px var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:focus{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-search-row .rlh-toolbar-icon-btn,.rlh-replace-body .rlh-toolbar-icon-btn{width:2rem;height:2rem}.rlh-toolbar-btn i{font-size:.95rem}.rlh-toggle-btn i,.rlh-action-btn-icon i,.rlh-toolbar-btn i{transition:transform .25s}.rlh-toolbar-btn span{white-space:nowrap}.rlh-toggle-btn:hover i,.rlh-action-btn-icon:hover i,.rlh-toolbar-btn:hover i{transform:translateY(-1px)scale(1.08)}.rlh-toolbar-group--leading .rlh-toolbar-btn,.rlh-toolbar-group--actions .rlh-toolbar-btn{width:100%}.rlh-toolbar-btn:hover{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)26%,var(--rlh-surface-color))}}.rlh-toolbar-btn:hover{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-border-color)30%)}}.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px var(--rlh-accent-color),0 10px 22px -16px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent),0 10px 22px -16px var(--rlh-shadow-color)}}.rlh-toolbar-btn:hover{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{color:color-mix(in srgb,var(--rlh-text-color)85%,var(--rlh-accent-color)15%)}}.rlh-toolbar-btn:hover{transform:translateY(-1px)scale(1.01)}.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{cursor:not-allowed;opacity:.55;box-shadow:none;border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{border-color:color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{color:color-mix(in srgb,var(--rlh-text-color)75%,var(--rlh-accent-color)5%)}}.rlh-toolbar-btn:focus-visible{box-shadow:0 0 0 2px var(--rlh-accent-color),inset 0 0 0 1.5px var(--rlh-accent-color);outline:none;animation:1.1s ease-out rlhSoftPulse}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:focus-visible{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)40%,transparent),inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-toolbar-btn.active{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{background-color:color-mix(in srgb,var(--rlh-accent-color)32%,var(--rlh-surface-color))}}.rlh-toolbar-btn.active{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{border-color:color-mix(in srgb,var(--rlh-accent-color)75%,var(--rlh-border-color)25%)}}.rlh-toolbar-btn.active{box-shadow:inset 0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)50%,transparent)}}.rlh-toolbar-btn.active{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-search-field{border:1px solid var(--rlh-border-color);border-radius:12px;align-items:center;gap:0;width:100%;min-width:0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-field{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-field{background-color:var(--rlh-input-bg);transition:border-color .2s,box-shadow .2s,color .2s;overflow:hidden}.rlh-search-row{grid-area:row;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:.125rem;width:100%;display:grid}.rlh-search-box{border:1px solid var(--rlh-border-color);border-radius:12px;grid-template-columns:minmax(0,1fr) auto;grid-template-areas:"row replace""meta meta";gap:.125rem;padding:.2rem .3rem;display:grid}@supports (color:color-mix(in lab, red, red)){.rlh-search-box{border:1px solid color-mix(in srgb,var(--rlh-border-color)45%,transparent)}}.rlh-search-box{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-box{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,transparent)}}.rlh-search-box{box-shadow:0 8px 28px -24px var(--rlh-shadow-color)}.rlh-search-field .rlh-search-input{min-width:0;color:inherit;background:0 0;border:none;flex:auto;padding:.4rem .6rem;font-size:.92rem}.rlh-search-field .rlh-search-input:focus{box-shadow:none;border:none;outline:none}.rlh-search-field:focus-within{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-field:focus-within{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-search-field:focus-within{box-shadow:var(--rlh-focus-ring);color:var(--rlh-text-color)}.rlh-search-meta{color:var(--rlh-em-color);flex-direction:row;grid-area:meta;align-items:center;gap:.4rem;font-size:.85rem;display:flex}.rlh-search-scope{color:var(--rlh-accent-color);font-weight:500}@supports (color:color-mix(in lab, red, red)){.rlh-search-scope{color:color-mix(in srgb,var(--rlh-accent-color)65%,var(--rlh-text-color))}}.rlh-sort-menu,.rlh-position-menu{align-items:center;width:auto;min-width:0;margin-left:auto;display:inline-flex;position:relative}.rlh-sort-menu-list,.rlh-position-menu-list{background-color:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);border-radius:14px;min-width:10rem;padding:.5rem;list-style:none;position:absolute;top:calc(100% + .5rem);right:0}@supports (color:color-mix(in lab, red, red)){.rlh-sort-menu-list,.rlh-position-menu-list{border:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-sort-menu-list,.rlh-position-menu-list{box-shadow:0 24px 60px -36px var(--rlh-shadow-color);z-index:99;opacity:0;visibility:hidden;pointer-events:none;transition:opacity var(--rlh-default-transition-duration)var(--rlh-default-transition-timing-function),transform var(--rlh-default-transition-duration)var(--rlh-default-transition-timing-function),visibility 0s linear var(--rlh-default-transition-duration);will-change:opacity,transform;flex-direction:column;gap:.35rem;display:flex;transform:translateY(6px)scale(.98)}.rlh-toolbar-group--actions .rlh-sort-menu-list,.rlh-toolbar-group--actions .rlh-position-menu-list{left:0;right:auto}.rlh-sort-menu.open .rlh-sort-menu-list,.rlh-position-menu.open .rlh-position-menu-list{opacity:1;visibility:visible;pointer-events:auto;transition-delay:0s,0s,0s;transform:translateY(0)scale(1)}.rlh-sort-option,.rlh-position-option{width:100%;color:var(--rlh-text-color);cursor:pointer;background-color:#0000;border:1px solid #0000;border-radius:10px;justify-content:space-between;align-items:center;gap:.4rem;padding:.4rem .6rem;font-size:.9rem;transition:background-color .2s,border-color .2s,color .2s;display:flex}.rlh-sort-option:hover,.rlh-position-option:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option:hover,.rlh-position-option:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-sort-option.active,.rlh-position-option.active{background-color:var(--rlh-selected-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option.active,.rlh-position-option.active{border-color:color-mix(in srgb,var(--rlh-accent-color)60%,transparent)}}.rlh-sort-option.active,.rlh-position-option.active{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option.active,.rlh-position-option.active{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-replace-body{grid-area:replace;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:.25rem;width:100%;display:grid}.rlh-info-text{color:var(--rlh-em-color);font-size:.9rem}@supports (color:color-mix(in lab, red, red)){.rlh-info-text{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-info-text{margin:.5rem 0}.rlh-info-text-small{color:var(--rlh-em-color);font-size:.75rem}@supports (color:color-mix(in lab, red, red)){.rlh-info-text-small{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-chat-lore-empty{text-align:center;background-color:var(--rlh-hover-bg);border-radius:16px;flex-direction:column;justify-content:center;align-items:center;gap:1rem;padding:2rem 1.5rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-chat-lore-empty{background-color:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}.rlh-chat-lore-empty{border:1px dashed var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-chat-lore-empty{border:1px dashed color-mix(in srgb,var(--rlh-border-color)75%,transparent)}}.rlh-detail-view{background-color:var(--rlh-surface-color);border-radius:18px;flex-direction:column;gap:.6rem;padding:.6rem .8rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-detail-view{background-color:color-mix(in srgb,var(--rlh-surface-color)94%,transparent)}}.rlh-detail-view{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-detail-view{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-detail-view{box-shadow:0 24px 70px -50px var(--rlh-shadow-color)}@media (max-width:768px){.rlh-detail-view{gap:.6rem;padding:.6rem .8rem}.rlh-detail-header{gap:.4rem;padding:.4rem .6rem}.rlh-detail-content{gap:.4rem}.rlh-entry-list-wrapper{gap:.4rem;padding:.4rem 0}.rlh-detail-header h2{font-size:1rem;line-height:1.1}}.rlh-detail-header{grid-template-columns:auto 1fr auto;align-items:center;gap:.4rem;padding:.4rem .6rem;display:grid}.rlh-detail-header h2{color:var(--rlh-text-color);text-align:center;white-space:nowrap;text-overflow:ellipsis;min-width:0;margin:0;padding-inline:.5rem;font-size:1.1rem;font-weight:600;overflow:hidden}.rlh-detail-header .rlh-back-to-list-btn{justify-self:start}.rlh-detail-header .rlh-item-controls{justify-self:end;align-items:center;gap:.4rem;display:inline-flex}.rlh-detail-content,.rlh-entry-list-wrapper{flex-direction:column;gap:.4rem;display:flex}.rlh-entry-list-wrapper .rlh-item-container{animation:.3s ease-out both rlhFadeListItem}@keyframes rlhFadeListItem{0%{opacity:0;transform:translateY(6px)scale(.95)}to{opacity:1;transform:translateY(0)scale(1)}}.rlh-regex-list{flex-direction:column;gap:.45rem;display:flex;position:relative}.rlh-regex-list.sorting-active{border:1.5px dashed var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{border:1.5px dashed color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}.rlh-regex-list.sorting-active{box-shadow:0 0 0 3px var(--rlh-accent-color),0 20px 50px -30px var(--rlh-shadow-color);border-radius:14px;padding:.35rem .45rem}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-accent-color)12%,transparent),0 20px 50px -30px var(--rlh-shadow-color)}}.rlh-regex-list.sorting-active{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{background:color-mix(in srgb,var(--rlh-hover-bg)45%,transparent)}}.rlh-regex-list.sorting-active .rlh-item-container{border-radius:12px}.rlh-regex-list .sortable-ghost{opacity:.2;transform:scale(.98)}.rlh-regex-list .sortable-chosen{box-shadow:0 18px 40px -28px var(--rlh-shadow-color);transform:rotate(.4deg)}.rlh-sorting-fallback{opacity:.7!important;transform:scale(1.02)!important}.rlh-entry-list-wrapper>*{margin:0}.rlh-order-indicator{background-color:var(--rlh-hover-bg);min-width:1.75rem;color:var(--rlh-accent-color);border-radius:9999px;justify-content:center;align-items:center;padding:.1rem .5rem;font-size:.75rem;font-weight:600;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-order-indicator{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-selection-control{justify-content:center;align-items:center;margin-right:.35rem;display:inline-flex}.rlh-selection-control input{cursor:pointer;width:1rem;height:1rem;accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-selection-control input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}.rlh-drag-handle{color:var(--rlh-em-color);justify-content:center;align-items:center;margin-right:.35rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-drag-handle{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-drag-handle{cursor:grab}.rlh-drag-handle:active{cursor:grabbing}.rlh-editor-group{border-top:1px solid var(--rlh-border-color);flex-direction:column;gap:.6rem;padding:.75rem 0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-editor-group{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-editor-group:first-of-type{border-top:none;padding-top:0}.rlh-editor-group h5{color:var(--rlh-em-color);font-size:.85rem;font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-editor-group h5{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-editor-grid{grid-template-columns:repeat(auto-fit,minmax(14rem,1fr));gap:.6rem;display:grid}.rlh-grid-item,.rlh-depth-container{flex-direction:column;gap:.4rem;display:flex}.rlh-depth-inputs{flex-wrap:wrap;gap:.6rem;display:flex}.rlh-editor-options-row{flex-wrap:wrap;gap:.4rem;display:flex}.rlh-editor-option-item{background-color:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.35rem;padding:.35rem .65rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-editor-option-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}.rlh-editor-option-item{color:var(--rlh-em-color);font-size:.85rem}.rlh-editor-option-item input{accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-editor-option-item input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}.rlh-select-nudge{min-width:8rem}.rlh-rename-ui{width:100%}.rlh-rename-input-wrapper{border:1px solid var(--rlh-border-color);border-radius:12px;align-items:center;gap:.4rem;width:100%;padding:.4rem .6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-rename-input-wrapper{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-rename-input-wrapper{background-color:var(--rlh-input-bg)}.rlh-rename-input{color:var(--rlh-text-color);background:0 0;border:none;outline:none;flex:1;font-size:.9rem}.rlh-rename-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)75%,transparent)}}.rlh-rename-save-btn{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-save-btn{border-color:color-mix(in srgb,var(--rlh-green)55%,transparent)}}.rlh-rename-cancel-btn{color:var(--rlh-red);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-cancel-btn{border-color:color-mix(in srgb,var(--rlh-red)55%,transparent)}}.rlh-global-toggle,.rlh-item-toggle{transition:background-color .2s,border-color .2s,color .2s}.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{border-color:color-mix(in srgb,var(--rlh-green)65%,transparent)}}.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{background-color:var(--rlh-green-bg)}.rlh-clickable-header{cursor:pointer}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{box-shadow:0 36px 120px -60px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{box-shadow:0 36px 120px -60px color-mix(in srgb,var(--rlh-accent-color)30%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{color:color-mix(in srgb,var(--rlh-accent-color)65%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{font-size:.75rem}.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{box-shadow:0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-item-container.rlh-collapsed .rlh-item-header,.rlh-book-group.rlh-collapsed .rlh-global-book-header{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.rlh-collapsed .rlh-item-header,.rlh-book-group.rlh-collapsed .rlh-global-book-header{background-color:color-mix(in srgb,var(--rlh-hover-bg)45%,transparent)}}.sortable-ghost{opacity:.75;background-color:var(--rlh-selected-bg)}@supports (color:color-mix(in lab, red, red)){.sortable-ghost{background-color:color-mix(in srgb,var(--rlh-selected-bg)85%,transparent)}}.sortable-ghost{border:1px dashed var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.sortable-ghost{border:1px dashed color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}.rlh-search-controls{flex-wrap:wrap;align-items:center;gap:.7rem;display:flex}#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{border:1px solid var(--rlh-border-color);border-radius:12px;width:100%;min-width:0;padding:.4rem .6rem}@supports (color:color-mix(in lab, red, red)){#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);font-size:.92rem;transition:border-color .2s,box-shadow .2s}#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{box-shadow:var(--rlh-focus-ring)}#rlh-search-input::placeholder,.rlh-search-input::placeholder,#rlh-replace-input::placeholder,.rlh-replace-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){#rlh-search-input::placeholder,.rlh-search-input::placeholder,#rlh-replace-input::placeholder,.rlh-replace-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-multi-select-module{flex-direction:column;align-items:flex-start;gap:.25rem;display:flex}.rlh-search-action-btn,.rlh-multi-select-action-btn{border:1px solid var(--rlh-border-color);border-radius:10px;justify-content:center;align-items:center;gap:.2rem;padding:.3rem .5rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-action-btn,.rlh-multi-select-action-btn{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-action-btn,.rlh-multi-select-action-btn{color:var(--rlh-text-color);cursor:pointer;background:0 0;font-size:.78rem;line-height:1;transition:color .2s,background-color .2s,border-color .2s,transform .2s}.rlh-multi-select-action-btn:active{transform:scale(.95)}.rlh-search-action-btn:hover,.rlh-multi-select-action-btn:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-action-btn:hover,.rlh-multi-select-action-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-multi-select-actions{flex-wrap:nowrap;align-items:center;gap:.3rem;display:inline-flex}.rlh-multi-select-action-btn.enable{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.enable{border-color:color-mix(in srgb,var(--rlh-green)60%,transparent)}}.rlh-multi-select-action-btn.enable{background-color:var(--rlh-green-bg)}.rlh-multi-select-action-btn.disable{color:var(--rlh-red);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.disable{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-multi-select-action-btn.disable{background-color:var(--rlh-red-bg)}#rlh-search-filters-container,.rlh-filter-list{flex-wrap:wrap;gap:.6rem;display:flex}.rlh-filter-item{background-color:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.4rem;padding:.4rem .65rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)65%,transparent)}}.rlh-filter-item{color:var(--rlh-em-color);font-size:.85rem}.rlh-filter-item input{accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}#rlh-multi-select-controls{align-items:center;gap:.35rem;display:none}#rlh-multi-select-controls.active{flex-wrap:wrap;display:flex}@media (max-width:960px){.rlh-multi-select-module{align-items:stretch;gap:.35rem}#rlh-multi-select-controls{flex-wrap:wrap;justify-content:flex-start;align-items:flex-start}.rlh-multi-select-actions{flex-wrap:wrap;justify-content:flex-start}}.rlh-content-pane{-webkit-overflow-scrolling:touch;scrollbar-gutter:stable both-edges;flex-direction:column;flex:auto;gap:1rem;min-height:0;padding-right:.25rem;display:flex;overflow:hidden auto}#regex-lore-hub-panel-content{-webkit-overflow-scrolling:touch;scrollbar-gutter:stable both-edges;scroll-behavior:smooth;flex:auto;min-height:clamp(18rem,48vh,32rem);padding-right:clamp(.25rem,.8vw,.5rem);display:block;overflow:hidden auto}#regex-lore-hub-panel-content>*+*{margin-top:clamp(.8rem,1.4vw,1.1rem)}#regex-lore-hub-panel-content::-webkit-scrollbar{width:6px}#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{background-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{border-radius:9999px}.rlh-book-group,.rlh-item-container{border:1px solid var(--rlh-border-color);border-radius:16px;flex-direction:column;min-height:0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-book-group,.rlh-item-container{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{background-color:color-mix(in srgb,var(--rlh-surface-color)94%,transparent)}}.rlh-book-group,.rlh-item-container{box-shadow:0 18px 50px -40px var(--rlh-shadow-color);overflow:hidden}.rlh-book-group-header{justify-content:center;align-items:center;padding:.85rem 1rem;display:flex;position:relative}.rlh-book-group-title{color:var(--rlh-text-color);text-align:center;white-space:nowrap;text-overflow:ellipsis;max-width:calc(100% - 8rem);margin:0;font-size:1.1rem;font-weight:600;overflow:hidden}.rlh-book-group-header .rlh-item-controls{align-items:center;gap:.4rem;display:inline-flex;position:absolute;top:50%;right:1rem;transform:translateY(-50%)}.rlh-global-book-header,.rlh-item-header{cursor:pointer;justify-content:flex-start;align-items:center;gap:.6rem;padding:.85rem 1rem;transition:background-color .2s,border-color .2s;display:flex}.rlh-global-book-header{flex-wrap:wrap;align-items:flex-start}.rlh-global-book-header .rlh-book-title-wrapper{flex:auto;min-width:0}.rlh-global-book-header .rlh-item-name{white-space:normal;word-break:break-word;flex:0 auto;min-width:0}.rlh-global-book-header .rlh-book-stats{white-space:nowrap}.rlh-global-book-header .rlh-item-controls{flex:none;margin-top:.1rem;margin-left:auto}.rlh-global-book-header.enabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{color:color-mix(in srgb,var(--rlh-text-color)70%,var(--rlh-accent-color)30%)}}.rlh-global-book-header.enabled{background:linear-gradient(135deg,var(--rlh-accent-color)0%,var(--rlh-accent-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{background:linear-gradient(135deg,color-mix(in srgb,var(--rlh-accent-color)32%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-accent-color)18%,var(--rlh-surface-color))100%)}}.rlh-global-book-header.enabled{box-shadow:0 18px 45px -30px var(--rlh-accent-color),inset 0 0 0 1px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{box-shadow:0 18px 45px -30px color-mix(in srgb,var(--rlh-accent-color)50%,transparent),inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-global-book-header.enabled .rlh-item-name{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled .rlh-item-name{color:color-mix(in srgb,var(--rlh-accent-color)85%,var(--rlh-text-color))}}.rlh-global-book-header.enabled .rlh-book-stats{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled .rlh-book-stats{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-em-color))}}.rlh-global-book-header.enabled:hover{background:linear-gradient(135deg,var(--rlh-accent-color)0%,var(--rlh-accent-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled:hover{background:linear-gradient(135deg,color-mix(in srgb,var(--rlh-accent-color)38%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-accent-color)22%,var(--rlh-surface-color))100%)}}.rlh-global-book-header:hover,.rlh-item-header:hover{background-color:var(--rlh-hover-bg)}.rlh-item-header-main{flex:auto;align-items:center;gap:.5rem;min-width:0;display:flex}.rlh-item-name{color:var(--rlh-text-color);flex-shrink:0;font-size:.95rem;font-weight:500}@media (max-width:720px){.rlh-item-header{flex-wrap:wrap;align-items:flex-start;gap:.45rem;padding:.7rem .75rem}.rlh-item-header-main{flex-direction:column;align-items:flex-start;gap:.3rem;width:100%}.rlh-item-name{text-overflow:ellipsis;white-space:nowrap;flex:auto;min-width:0;max-width:100%;overflow:hidden}.rlh-book-group-header{justify-content:flex-start;align-items:flex-start}.rlh-book-group-title{text-align:left;width:100%;max-width:100%}.rlh-item-controls{flex-direction:row;justify-content:flex-end;align-self:flex-start;align-items:center;gap:.18rem;width:auto}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{border-width:1px;border-radius:.6rem;width:1.55rem;height:1.55rem;padding:0}.rlh-item-controls .rlh-toggle-btn i,.rlh-item-controls .rlh-action-btn-icon i{font-size:.75rem}.rlh-detail-header .rlh-item-controls{justify-self:flex-end}.rlh-book-group-header .rlh-item-controls{justify-content:flex-end;align-items:center;margin-top:.25rem;margin-left:auto;position:static;transform:none}.rlh-item-meta{gap:.25rem;font-size:.74rem}.rlh-item-meta-chip{gap:.2rem;padding:.12rem .45rem}}.rlh-item-meta{color:var(--rlh-em-color);flex-wrap:wrap;align-items:center;gap:.35rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta{color:color-mix(in srgb,var(--rlh-em-color)92%,transparent)}}.rlh-item-meta{font-size:.78rem}.rlh-item-meta-chip{background:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.25rem;padding:.15rem .55rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)70%,transparent)}}.rlh-item-meta-chip{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip{border:1px solid color-mix(in srgb,var(--rlh-border-color)50%,transparent)}}.rlh-item-meta-chip{line-height:1.2}.rlh-item-meta-chip i{color:var(--rlh-accent-color);font-size:.7rem}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip i{color:color-mix(in srgb,var(--rlh-accent-color)75%,var(--rlh-em-color))}}#regex-lore-hub-panel.dark .rlh-item-meta-chip{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}#regex-lore-hub-panel.dark .rlh-item-meta-chip{border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-item-meta-chip{border-color:color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-item-controls{flex-wrap:wrap;align-items:center;gap:.35rem;margin-left:auto;display:inline-flex}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{flex-shrink:0}@media (max-width:960px){.rlh-item-controls{gap:.28rem}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:2rem;height:2rem}}@media (max-width:900px) and (min-width:721px){.rlh-item-controls{flex-direction:column;align-items:flex-end;gap:.22rem;width:auto}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:1.75rem;height:1.75rem}.rlh-item-name{flex:auto;min-width:0;max-width:100%}}.rlh-toggle-btn,.rlh-action-btn-icon{border:1px solid var(--rlh-border-color);border-radius:9999px;justify-content:center;align-items:center;width:2.25rem;height:2.25rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toggle-btn,.rlh-action-btn-icon{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-toggle-btn,.rlh-action-btn-icon{color:var(--rlh-em-color);cursor:pointer;background:0 0;transition:color .2s,background-color .2s,border-color .2s,transform .2s}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{transform:translateY(-1px)scale(1.03)}.rlh-item-container.enabled .rlh-item-name,.rlh-book-group.enabled .rlh-item-name{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.enabled .rlh-item-name,.rlh-book-group.enabled .rlh-item-name{color:color-mix(in srgb,var(--rlh-accent-color)80%,var(--rlh-text-color))}}.rlh-collapsible-content{border-top:1px solid var(--rlh-border-color);margin-top:.75rem;padding:0 1rem 1rem;display:none}@supports (color:color-mix(in lab, red, red)){.rlh-collapsible-content{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-collapsible-content{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-collapsible-content{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,transparent)}}.rlh-entry-actions{border-bottom:1px dashed var(--rlh-border-color);flex-wrap:wrap;gap:.6rem;padding:.9rem 1rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-entry-actions{border-bottom:1px dashed color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-action-btn{background-color:var(--rlh-accent-color);color:#fff;cursor:pointer;border:none;border-radius:12px;justify-content:center;align-items:center;gap:.4rem;padding:.55rem 1rem;font-size:.9rem;font-weight:500;transition:transform .2s,opacity .2s;display:inline-flex}.rlh-action-btn:hover{opacity:.9}.rlh-action-btn.rlh-maximize-btn{border:1px solid var(--rlh-em-color);background:0 0}@supports (color:color-mix(in lab, red, red)){.rlh-action-btn.rlh-maximize-btn{border:1px solid color-mix(in srgb,var(--rlh-em-color)45%,transparent)}}.rlh-action-btn.rlh-maximize-btn{color:var(--rlh-em-color)}.rlh-editor-wrapper{flex-direction:column;gap:1rem;display:flex}.rlh-editor-field{flex-direction:column;gap:.35rem;display:flex}.rlh-editor-field label{background-color:var(--rlh-header-bg);padding:.55rem .85rem;display:block}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field label{background-color:color-mix(in srgb,var(--rlh-header-bg)82%,transparent)}}.rlh-editor-field label{border-bottom:1px solid var(--rlh-border-color);border-radius:12px 12px 0 0}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field label{border-bottom:1px solid color-mix(in srgb,var(--rlh-border-color)68%,transparent)}}.rlh-editor-field label{color:var(--rlh-text-color);margin:0;font-size:.875rem;font-weight:600;line-height:1.3}.rlh-editor-field label+*{border-top-left-radius:0;border-top-right-radius:0;margin-top:0}.rlh-viewer-field{gap:0}.rlh-regex-viewer{grid-template-columns:repeat(auto-fit,minmax(14rem,1fr));gap:.75rem;display:grid}.rlh-regex-viewer>.rlh-editor-field:nth-child(-n+2){grid-column:1/-1}.rlh-entry-viewer{flex-direction:column;gap:.75rem;display:flex}.rlh-viewer-field label{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-field label{background-color:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}.rlh-viewer-field label{border-bottom-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-field label{border-bottom-color:color-mix(in srgb,var(--rlh-accent-color)28%,transparent)}}.rlh-viewer-text{border:1px solid var(--rlh-border-color);padding:.6rem .85rem}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-text{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-viewer-text{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);border-top:none;border-radius:0 0 12px 12px;line-height:1.5}.rlh-viewer-text>article{margin:0}.rlh-editor-field .rlh-edit-content,.rlh-editor-field article{border-top:none;border-radius:0 0 12px 12px;margin-top:0}#regex-lore-hub-panel.dark .rlh-editor-field label{background-color:var(--rlh-header-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-editor-field label{background-color:color-mix(in srgb,var(--rlh-header-bg)70%,transparent)}}#regex-lore-hub-panel.dark .rlh-editor-field label{border-bottom-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-editor-field label{border-bottom-color:color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-field label{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-field label{background-color:color-mix(in srgb,var(--rlh-hover-bg)70%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-field label{border-bottom-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-field label{border-bottom-color:color-mix(in srgb,var(--rlh-accent-color)32%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-text{border-color:color-mix(in srgb,var(--rlh-border-color)50%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{background-color:var(--rlh-input-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-text{background-color:color-mix(in srgb,var(--rlh-input-bg)90%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{border-top:none}.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{border:1px solid var(--rlh-border-color);border-radius:12px;width:100%;padding:.55rem .75rem}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);transition:border-color .2s,box-shadow .2s}.rlh-editor-field label+:is(input,textarea,select){border-top:none;border-radius:0 0 12px 12px}.rlh-editor-field textarea{resize:vertical;min-height:8rem}.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{box-shadow:var(--rlh-focus-ring)}.rlh-toast-notification,.rlh-progress-toast{background-color:var(--rlh-accent-color);color:#fff;box-shadow:0 24px 120px -40px var(--rlh-shadow-color);opacity:0;pointer-events:none;z-index:10002;border-radius:9999px;padding:.9rem 1.3rem;font-size:.9rem;font-weight:500;transition:opacity .25s,transform .25s;position:fixed;bottom:clamp(1rem,4vw,2rem);left:50%;transform:translate(-50%)translateY(20px)}.rlh-progress-toast{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-progress-toast{background-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-toast-notification.visible,.rlh-progress-toast.visible{opacity:1;animation:.38s cubic-bezier(.3,.7,.4,1.1) both rlhToastIn;transform:translate(-50%)translateY(0)}.rlh-modal-overlay{z-index:10003;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);background:#0206178c;justify-content:center;align-items:center;display:flex;position:fixed;inset:0}.rlh-modal-content{background:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);width:min(420px,90%);box-shadow:0 30px 120px -60px var(--rlh-shadow-color);border-radius:16px;margin:auto;overflow:hidden}.rlh-modal-header{border-bottom:1px solid var(--rlh-border-color);padding:1rem 1.25rem;font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-modal-header{border-bottom:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-body{color:var(--rlh-em-color);flex-direction:column;gap:.6rem;padding:1.1rem 1.25rem;display:flex}.rlh-modal-footer{border-top:1px solid var(--rlh-border-color);justify-content:flex-end;gap:.6rem;padding:.9rem 1.25rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-modal-footer{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-btn{border:1px solid var(--rlh-border-color);border-radius:12px;padding:.55rem 1.1rem}@supports (color:color-mix(in lab, red, red)){.rlh-modal-btn{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-btn{color:var(--rlh-text-color);cursor:pointer;background:0 0;font-weight:500;transition:background-color .2s,border-color .2s}.rlh-modal-btn:hover{background-color:var(--rlh-hover-bg)}.rlh-modal-btn.rlh-modal-ok{background-color:var(--rlh-accent-color);color:#fff;border-color:#0000}.rlh-modal-btn.rlh-modal-cancel{background-color:var(--rlh-red-bg);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-modal-btn.rlh-modal-cancel{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-modal-btn.rlh-modal-cancel{color:var(--rlh-red)}.rlh-loading{background:var(--rlh-surface-color);border-radius:20px;align-items:center;gap:1.25rem;padding:1.4rem 1.6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-loading{background:color-mix(in srgb,var(--rlh-surface-color)96%,transparent)}}.rlh-loading{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-loading{border:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-loading{box-shadow:0 24px 80px -50px var(--rlh-shadow-color)}.rlh-loading-spinner{border:3px solid var(--rlh-em-color);border-radius:9999px;width:2.6rem;height:2.6rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-spinner{border:3px solid color-mix(in srgb,var(--rlh-em-color)35%,transparent)}}.rlh-loading-spinner{border-top-color:var(--rlh-accent-color);animation:.9s linear infinite rlh-spin}.rlh-loading-text{flex-direction:column;flex:1;gap:.55rem;display:flex}.rlh-loading-title{color:var(--rlh-text-color);font-size:.95rem;font-weight:600}.rlh-loading-status{color:var(--rlh-text-color);font-size:.9rem}.rlh-loading-detail{color:var(--rlh-em-color);font-size:.82rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-detail{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-loading-bar{background:var(--rlh-hover-bg);border-radius:9999px;width:100%;height:.4rem;position:relative}@supports (color:color-mix(in lab, red, red)){.rlh-loading-bar{background:color-mix(in srgb,var(--rlh-hover-bg)75%,transparent)}}.rlh-loading-bar{overflow:hidden}.rlh-loading-bar-inner{background:linear-gradient(90deg,var(--rlh-accent-color),var(--rlh-accent-color));width:0%;height:100%}@supports (color:color-mix(in lab, red, red)){.rlh-loading-bar-inner{background:linear-gradient(90deg,var(--rlh-accent-color),color-mix(in srgb,var(--rlh-accent-color)70%,transparent))}}.rlh-loading-bar-inner{transition:width .3s}.rlh-loading-progress{color:var(--rlh-em-color);font-size:.75rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-progress{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-menu-icon{width:1.1rem;height:1.1rem;color:var(--rlh-accent-color);justify-content:center;align-items:center;display:inline-flex}@keyframes rlh-spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.rlh-edit-content{border:1px solid var(--rlh-border-color);border-radius:0 0 12px 12px;min-height:6rem;padding:.75rem}@supports (color:color-mix(in lab, red, red)){.rlh-edit-content{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-edit-content{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);white-space:pre-wrap}.rlh-error-wrapper{text-align:center;border:1px dashed var(--rlh-red);border-radius:16px;padding:1.5rem}@supports (color:color-mix(in lab, red, red)){.rlh-error-wrapper{border:1px dashed color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-error-wrapper{background-color:var(--rlh-red-bg)}.rlh-error-title{color:var(--rlh-red);margin-bottom:.75rem;font-weight:600}.rlh-error-text{color:var(--rlh-em-color);font-size:.9rem}.rlh-error-retry-btn{border:1px solid var(--rlh-red);color:var(--rlh-red);cursor:pointer;background-color:#0000;border-radius:9999px;margin-top:1rem;padding:.55rem 1.1rem;transition:background-color .2s}.rlh-error-retry-btn:hover{background-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-error-retry-btn:hover{background-color:color-mix(in srgb,var(--rlh-red)18%,transparent)}}.rlh-error-retry-btn:hover{color:#fff}.rlh-search-card,.rlh-filters-card{background:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:.9rem;padding:1rem 1.1rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-card,.rlh-filters-card{background:color-mix(in srgb,var(--rlh-surface-color)92%,transparent)}}.rlh-search-card,.rlh-filters-card{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-card,.rlh-filters-card{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-card,.rlh-filters-card{box-shadow:0 20px 60px -40px var(--rlh-shadow-color)}.rlh-section-title{letter-spacing:.08em;text-transform:uppercase;color:var(--rlh-em-color);font-size:.75rem;font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-section-title{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-toast-notification.success{background-color:var(--rlh-green)}.rlh-toast-notification.error{background-color:var(--rlh-red)}.rlh-toast-notification.info{background-color:var(--rlh-accent-color)}@media (prefers-reduced-motion:reduce){#regex-lore-hub-panel .rlh-shell,.rlh-toolbar-btn:focus-visible{animation:none}.rlh-toast-notification.visible,.rlh-progress-toast.visible{transition:opacity .2s,transform .2s;animation:none}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover,.rlh-toolbar-btn:hover,.rlh-toggle-btn:hover i,.rlh-action-btn-icon:hover i,.rlh-toolbar-btn:hover i{transform:none}}.rlh-breadcrumbs{align-items:center;gap:.4rem;margin-bottom:.5rem;font-size:.9rem;display:flex}.rlh-breadcrumb-item{color:var(--rlh-em-color);text-decoration:none;transition:color .2s}.rlh-breadcrumb-item:hover{color:var(--rlh-accent-color)}.rlh-breadcrumb-item.active{color:var(--rlh-text-color);pointer-events:none;font-weight:500}.rlh-breadcrumb-separator{color:var(--rlh-em-color)}.rlh-empty-state{text-align:center;background-color:var(--rlh-hover-bg);border-radius:16px;flex-direction:column;justify-content:center;align-items:center;margin-top:1rem;padding:2rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-empty-state{background-color:color-mix(in srgb,var(--rlh-hover-bg)50%,transparent)}}.rlh-empty-state{border:1px dashed var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-empty-state{border:1px dashed color-mix(in srgb,var(--rlh-border-color)80%,transparent)}}.rlh-empty-icon{color:var(--rlh-accent-color);background-color:var(--rlh-selected-bg);border-radius:9999px;justify-content:center;align-items:center;width:4rem;height:4rem;margin-bottom:1rem;font-size:2rem;display:flex}.rlh-empty-state h4{color:var(--rlh-text-color);margin-bottom:.5rem;font-size:1.1rem;font-weight:600}.rlh-empty-state p{color:var(--rlh-em-color);max-width:300px}.rlh-book-group{transition:box-shadow .2s,border-color .2s;position:relative}.rlh-book-group.enabled{border-left:3px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{border-left:3px solid color-mix(in srgb,var(--rlh-accent-color)80%,transparent)}}.rlh-book-group.enabled{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color))}}.rlh-book-group.enabled{background:linear-gradient(160deg,var(--rlh-accent-color)0%,var(--rlh-surface-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{background:linear-gradient(160deg,color-mix(in srgb,var(--rlh-accent-color)20%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-surface-color)96%,transparent)100%)}}.rlh-book-group.enabled{box-shadow:0 26px 70px -46px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{box-shadow:0 26px 70px -46px color-mix(in srgb,var(--rlh-accent-color)58%,transparent)}}.rlh-book-title-wrapper{flex-direction:column;flex:1;gap:.2rem;display:flex}.rlh-book-stats{color:var(--rlh-em-color);font-size:.75rem}.rlh-book-summary{background-color:var(--rlh-hover-bg);padding:.5rem 1rem;font-size:.85rem}@supports (color:color-mix(in lab, red, red)){.rlh-book-summary{background-color:color-mix(in srgb,var(--rlh-hover-bg)40%,transparent)}}.rlh-book-summary{border-top:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-summary{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-used-by-chars span{background-color:var(--rlh-selected-bg);border-radius:9999px;margin:.1rem;padding:.1rem .5rem;font-size:.75rem;display:inline-block}.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{border:1px solid var(--rlh-border-color);border-radius:12px;padding:.45rem .65rem}@supports (color:color-mix(in lab, red, red)){.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{background-color:var(--rlh-input-bg);color:var(--rlh-text-color)}.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{box-shadow:var(--rlh-focus-ring)}.rlh-loading{pointer-events:none;opacity:.5;position:relative}.rlh-loading>i{visibility:hidden}.rlh-loading:after{content:"";border:2px solid oklch(70.7% .022 261.325);border-top-color:oklch(62.3% .214 259.815);border-radius:50%;width:16px;height:16px;margin-top:-8px;margin-left:-8px;animation:.8s linear infinite rlh-spin;position:absolute;top:50%;left:50%}.rlh-highlight{color:#1f2937;background-color:#facc15;animation:.5s ease-out rlhHighlightPulse}}.rlh-toolbar-toggle-btn{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color);border:1px solid var(--rlh-border-color);cursor:pointer;border-radius:8px;justify-content:center;align-items:center;padding:.5rem 1rem;transition:background-color .2s,color .2s;display:inline-flex}.rlh-toolbar-toggle-btn:hover{background-color:var(--rlh-selected-bg);color:var(--rlh-accent-color)}#regex-lore-hub-toolbar-shell{transition:max-height .3s ease-in-out}.rlh-toolbar-shell--collapsed{max-height:0;margin-top:0;margin-bottom:0;padding-top:0;padding-bottom:0;overflow:hidden}
`;function Ft(e){let r=te(),o=ie(),a=ge(),l=e();function n(){let m=o.getElementById(`${ne}-styles`);if(m){m.textContent=Vr;return}let h=o.createElement("style");h.id=`${ne}-styles`,h.textContent=Vr,o.head.appendChild(h)}function i(m){if(a.Sortable){m();return}let h=a.document.createElement("script");h.src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js",h.onload=()=>{console.log("[RegexLoreHub] SortableJS loaded successfully."),m()},h.onerror=()=>{console.error("[RegexLoreHub] Failed to load SortableJS."),Y({type:"alert",title:"\u9519\u8BEF",text:"\u65E0\u6CD5\u52A0\u8F7D\u62D6\u62FD\u6392\u5E8F\u5E93\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5\u6216\u6D4F\u89C8\u5668\u63A7\u5236\u53F0\u3002"})},a.document.head.appendChild(h)}function u(){if(console.log("[RegexLoreHub] Initializing UI and button..."),r(`#${ne}`,o).length>0){console.log("[RegexLoreHub] Panel already exists. Skipping UI creation.");return}n();let m=`
      <div id="${ne}">

        <div class="rlh-shell">

          <header class="rlh-shell-header">

            <div class="rlh-shell-title">

              <h4>${Mr}</h4>

              <p class="rlh-shell-meta"><span class="rlh-shell-version">v3.0</span><span class="rlh-shell-dot">\xB7</span><span class="rlh-shell-updated">\u66F4\u65B0\u4E8E 2025 \u5E74 9 \u6708 30 \u65E5</span></p>

            </div>

            <div class="rlh-shell-right">

              <div id="${$r}" class="rlh-prefetch-indicator" data-visible="false" aria-hidden="true">

                <div id="${Er}" class="rlh-prefetch-text" aria-live="polite">\u540E\u53F0\u52A0\u8F7D\u4E16\u754C\u4E66 (0/0)\uFF0C\u4E0D\u5F71\u54CD\u5176\u4ED6\u64CD\u4F5C</div>

                <div class="rlh-prefetch-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">

                  <span id="${Sr}" class="rlh-prefetch-bar-inner"></span>

                </div>

              </div>

              <button type="button" id="${Re.TOGGLE_TOOLBAR_BTN}" class="rlh-toolbar-toggle-btn" title="\u6298\u53E0\u5DE5\u5177\u680F" aria-controls="${Re.TOOLBAR_SHELL}" aria-expanded="true">\u6298\u53E0\u5DE5\u5177\u680F</button>

              <div class="rlh-shell-actions">

                <button type="button" id="${dr}" class="rlh-icon-button rlh-refresh-button" title="\u5237\u65B0\u6570\u636E">

                  <i class="fa-solid fa-arrows-rotate"></i>

                </button>

                <button type="button" id="${Or}" class="rlh-icon-button rlh-close-button" title="\u5173\u95ED\u9762\u677F">

                  <i class="fa-solid fa-xmark"></i>

                </button>

              </div>

            </div>

          </header>





          <nav class="rlh-tab-nav">

            <div class="rlh-tab active" data-tab="global-lore"><span class="rlh-tab-text-full">\u5168\u5C40\u4E16\u754C\u4E66</span><span class="rlh-tab-text-short">\u5168\u5C40\u4E66</span></div>

            <div class="rlh-tab" data-tab="char-lore"><span class="rlh-tab-text-full">\u89D2\u8272\u4E16\u754C\u4E66</span><span class="rlh-tab-text-short">\u89D2\u8272\u4E66</span></div>

            <div class="rlh-tab" data-tab="chat-lore"><span class="rlh-tab-text-full">\u804A\u5929\u4E16\u754C\u4E66</span><span class="rlh-tab-text-short">\u804A\u5929\u4E66</span></div>

            <div class="rlh-tab" data-tab="global-regex"><span class="rlh-tab-text-full">\u5168\u5C40\u6B63\u5219</span><span class="rlh-tab-text-short">\u5168\u5C40\u6B63\u5219</span></div>

            <div class="rlh-tab" data-tab="char-regex"><span class="rlh-tab-text-full">\u89D2\u8272\u6B63\u5219</span><span class="rlh-tab-text-short">\u89D2\u8272\u6B63\u5219</span></div>

          </nav>

          <div id="${Re.TOOLBAR_SHELL}" class="rlh-toolbar-shell">

            <div id="${hr}" class="rlh-toolbar-container"></div>

            <div id="${pr}" class="rlh-replace-container"></div>

          </div>

          <div class="rlh-content-pane">

            <div id="${ne}-content"></div>

          </div>

          <footer class="rlh-shell-footer">

            <div id="regex-lore-hub-save-status" class="rlh-save-status"></div>

          </footer>

        </div>

      </div>`;r("body",o).append(m);let h=`<div id="${De}" class="list-group-item flex-container flexGap5 interactable" title="${Mr}"><span class="rlh-menu-icon"><i class="fa-solid fa-layer-group"></i></span><span>${Zr}</span></div>`,d=r("#extensionsMenu",o);d.find(`#${De}`).length===0&&(d.append(h),console.log(`[RegexLoreHub] Button #${De} appended to #extensionsMenu.`));let g=r(`#${ne}`,o);if(g.addClass("dark"),r("body",o).off(".rlh").on("click.rlh",`#${De}`,l.togglePanel),g.off(".rlh").on("click.rlh",`#${Or}`,l.togglePanel).on("click.rlh",".rlh-tab",l.switchTab).on("click.rlh",".rlh-item-header, .rlh-global-book-header",l.handleHeaderClick).on("click.rlh",".rlh-item-container",l.handleMultiSelectContainerClick).on("click.rlh",".rlh-book-group",l.handleMultiSelectContainerClick).on("click.rlh",".rlh-back-to-list-btn",l.handleExitLorebookDetail).on("click.rlh",".rlh-toggle-btn",l.handleToggleState).on("click.rlh",".rlh-refresh-detail-btn",l.handleRefreshLorebookDetail).on("click.rlh",".rlh-entry-edit-btn",l.handleEntryEnterEdit).on("click.rlh",".rlh-entry-view-btn",l.handleEntryExitEdit).on("click.rlh",".rlh-regex-edit-btn",l.handleRegexEnterEdit).on("click.rlh",".rlh-regex-view-btn",l.handleRegexExitEdit).on("keydown.rlh",`#${Fe}`,l.handleSearchInputKeydown).on("click.rlh","#rlh-search-clear-btn",l.handleSearchClear).on("input.rlh",`#${Fe}, #${rr}`,l.handleGlobalSearch).on("change.rlh","#rlh-search-filters-container input",J).on("change.rlh",`#${_r}`,l.handleCharacterBookSwitch).on("click.rlh",`#${tr}`,l.handleToolbarToggleCollapse).on("click.rlh",`#${ze}`,l.handleSortMenuToggle).on("click.rlh",".rlh-sort-option",l.handleSortOptionSelect).on("click.rlh",`#${Oe}`,l.handlePositionMenuToggle).on("click.rlh",".rlh-position-option",l.handlePositionOptionSelect).on("change.rlh",".rlh-multi-select-checkbox",l.handleSelectionCheckboxChange).on("click.rlh",`#${dr}`,l.handleRefresh).on("click.rlh","#rlh-multi-select-btn",l.toggleMultiSelectMode).on("click.rlh","#rlh-select-all-btn",l.handleSelectAll).on("click.rlh","#rlh-select-none-btn",l.handleSelectNone).on("click.rlh","#rlh-select-invert-btn",l.handleSelectInvert).on("click.rlh","#rlh-batch-enable-btn",l.handleBatchEnable).on("click.rlh","#rlh-batch-disable-btn",l.handleBatchDisable).on("click.rlh","#rlh-batch-delete-btn",l.handleBatchDelete).on("click.rlh",".rlh-clean-orphan-books-btn",l.handleCleanOrphanLorebooks).on("click.rlh",`#${wr}`,l.handlePrimaryCreateButtonClick).on("click.rlh",".rlh-rename-book-btn",l.handleRenameBook).on("click.rlh",".rlh-edit-entries-btn",l.handleEditEntriesToggle).on("click.rlh",".rlh-delete-book-btn",l.handleDeleteLorebook).on("click.rlh",".rlh-create-entry-btn",l.handleCreateEntry).on("click.rlh","#regex-lore-hub-create-lorebook-btn",l.handleCreateLorebook).on("click.rlh",".rlh-delete-entry-btn",l.handleDeleteEntry).on("click.rlh",".rlh-batch-recursion-btn",l.handleBatchSetRecursion).on("click.rlh",".rlh-fix-keywords-btn",l.handleFixKeywords).on("click.rlh",".rlh-rename-btn",l.handleRename).on("click.rlh",".rlh-rename-save-btn",l.handleConfirmRename).on("keydown.rlh",".rlh-rename-input",l.handleRenameKeydown).on("change.rlh",".rlh-edit-position",l.handlePositionChange).on("click.rlh","#rlh-create-chat-lore-btn",l.handleCreateChatLorebook).on("click.rlh",".rlh-unlink-chat-lore-btn",l.handleUnlinkChatLorebook).on("click.rlh",`#${Re.TOGGLE_TOOLBAR_BTN}`,Ht).on("click.rlh","#rlh-replace-btn",l.handleReplace),t.isToolbarCollapsed){r(`#${Re.TOOLBAR_SHELL}`,o).addClass("rlh-toolbar-shell--collapsed");let M=r(`#${Re.TOGGLE_TOOLBAR_BTN}`,o);M.length&&M.text("\u5C55\u5F00\u5DE5\u5177\u680F").attr("aria-expanded","false").attr("title","\u5C55\u5F00\u5DE5\u5177\u680F")}console.log("[RegexLoreHub] All UI and events initialized."),Ne()}i(u)}var Qr=null,Jr=null;function xo(e,r){Qr=e,Jr=r}function te(){if(Qr)return Qr;let e=window.parent||window;return e?.jQuery?e.jQuery:null}function pe(){if(Jr)return Jr;let e=window.parent||window;return e?.TavernHelper?e.TavernHelper:null}function vo(e){let r="#extensionsMenu",a=0;console.log(`[RegexLoreHub] Starting readiness check. Polling for DOM element "${r}" AND core APIs (TavernHelper, jQuery).`);let l=setInterval(()=>{let n=window.parent?.document,i=window.parent,u=!!n&&n.querySelector(r)!==null,m=!!(i&&i.TavernHelper)&&typeof i.TavernHelper.getCharData=="function"&&!!i.jQuery;if(u&&m){clearInterval(l),console.log(`[RegexLoreHub] SUCCESS: Both DOM ("${r}") and Core APIs are ready. Initializing script.`);try{let h=e(i.jQuery,i.TavernHelper);h?.catch&&h.catch(d=>{console.error("[RegexLoreHub] FATAL: Error during main callback execution.",d)})}catch(h){console.error("[RegexLoreHub] FATAL: Error during main callback execution.",h)}}else a++,a>100&&(clearInterval(l),console.error("[RegexLoreHub] FATAL: Readiness check timed out."),u||console.error(`[RegexLoreHub] -> Failure: DOM element "${r}" not found.`),m||console.error(`[RegexLoreHub] -> Failure: Core APIs not available. TavernHelper: ${!!i?.TavernHelper}, jQuery: ${!!i?.jQuery}`))},150)}async function yo(e,r){xo(e,r);try{await Ft(Ut)}catch(o){console.error("[RegexLoreHub] FATAL: Failed to bootstrap application.",o)}}vo(yo);
//# sourceMappingURL=bundle.js.map

var ke="regex-lore-hub-panel",tr="regex-lore-hub-button";var Tt="\u4E16\u754C\u4E66&\u6B63\u5219\u7BA1\u7406\u5668",so="\u4E16\u754C\u4E66&\u6B63\u5219\u7BA1\u7406\u5668",Lt="rlh-close-btn",nr="rlh-search-input",Dr="rlh-refresh-btn",Hr="rlh-core-toolbar",Ur="rlh-replace-tool-container";var Sr="rlh-replace-input",_r="rlh-toggle-collapse-btn",co="rlh-toggle-recursion-btn",ho="rlh-fix-keywords-btn",Er="rlh-sort-menu",ir="rlh-sort-menu-btn",or="rlh-position-menu",Qe="rlh-position-menu-btn",$r="rlh-unified-status-menu",sr="rlh-unified-status-btn",tt="rlh-create-primary-btn",ot="rlh-character-book-switch",lt="rlh-prefetch-indicator",at="rlh-prefetch-progress-text",nt="rlh-prefetch-progress-bar",Pr="rlh-theme-menu-wrapper",cr="rlh-theme-menu",zr="rlh-theme-toggle-btn",Ct="rlh-theme-toggle-label",Tr="rlh-theme-option",Ye={TOOLBAR_SHELL:"regex-lore-hub-toolbar-shell",TOGGLE_TOOLBAR_BTN:"regex-lore-hub-toggle-toolbar-btn"},Nt=e=>!e||typeof e!="string"?"":e.replace(/\\/g,"/").replace(/\/+$/,""),Bl=()=>{try{let e=new URL("./",import.meta.url).href;return Nt(e)}catch(e){return console.warn("[RegexLoreHub] \u65E0\u6CD5\u89E3\u6790\u811A\u672C\u6839\u8DEF\u5F84\uFF1A",e),""}},Ol=()=>{try{let e=window.parent||window,r=e?.document;if(!r)return"";let t=r.querySelectorAll("script[src]");for(let a of t){let l=a.getAttribute("src");if(!(!l||!/regex[-_]lore[-_]hub/i.test(l)))try{let n=new URL(l,e.location?.href||window.location.href),i=Nt(n.href);if(!i)continue;let h=i.replace(/\/[^/]*$/,"");if(h)return h}catch(n){console.warn("[RegexLoreHub] \u5BBF\u4E3B\u811A\u672C\u6839\u8DEF\u5F84\u89E3\u6790\u5931\u8D25\uFF1A",n)}}}catch(e){console.warn("[RegexLoreHub] \u65E0\u6CD5\u4ECE\u5BBF\u4E3B DOM \u63A8\u65AD\u6839\u8DEF\u5F84\uFF1A",e)}return""},St=Nt(Ol())||Bl(),po=[["focusRing","--rlh-focus-ring"],["background","--rlh-bg-color"],["surface","--rlh-surface-color"],["text","--rlh-text-color"],["textMuted","--rlh-em-color"],["border","--rlh-border-color"],["hover","--rlh-hover-bg"],["selected","--rlh-selected-bg"],["shadow","--rlh-shadow-color"],["header","--rlh-header-bg"],["input","--rlh-input-bg"],["accent","--rlh-accent-color"],["positive","--rlh-green"],["negative","--rlh-red"],["positiveBg","--rlh-green-bg"],["negativeBg","--rlh-red-bg"],["statusConstant","--rlh-status-constant"],["statusSelective","--rlh-status-selective"],["statusVectorized","--rlh-status-vectorized"],["buttonPrimary","--rlh-primary-btn-text-color"],["buttonDanger","--rlh-danger-btn-text-color"],["buttonSecondary","--rlh-secondary-btn-text-color"]],uo={};po.forEach(([e,r])=>{uo[e]=r});var _t=Object.freeze({...uo}),Ta=Object.freeze(po.map(([e])=>e));var It=e=>e==null?"":String(e).trim().toLowerCase(),Dl=e=>{if(!e)return[];let r=Array.isArray(e)?e:[e],t=[];return r.forEach(a=>{if(!a&&a!==0)return;let l=String(a).trim();l&&(t.includes(l)||t.push(l))}),t},rr=new Map,gr=[],Et=new Set,ye={activeId:"dark",fallbackId:"dark",pendingApplyId:null,appliedClasses:[],colorScheme:"dark",activeSnapshot:null},Hl=e=>(rr.set(e.id,e),gr.includes(e.id)||gr.push(e.id),gr.sort((r,t)=>{let a=rr.get(r),l=rr.get(t);return!a||!l?0:a.order!==l.order?a.order-l.order:a.id.localeCompare(l.id)}),e),Ul=e=>{if(!e||typeof e!="object")throw new Error("\u4E3B\u9898\u914D\u7F6E\u5FC5\u987B\u662F\u5BF9\u8C61");let r=It(e.id??e.themeId??e.name);if(!r)throw new Error("\u4E3B\u9898\u914D\u7F6E\u7F3A\u5C11 id");let t=typeof e.label=="string"&&e.label.trim()?e.label.trim():r,a=typeof e.description=="string"?e.description.trim():"",l=typeof e.order=="number"&&!Number.isNaN(e.order)?e.order:gr.length,n=Dl(e.panelClassList??e.classList),i=e.colorScheme==="dark"?"dark":"light",h=e.metadata&&typeof e.metadata=="object"?{...e.metadata}:{};return Object.freeze({id:r,label:t,description:a,order:l,panelClassList:Object.freeze(n),colorScheme:i,metadata:Object.freeze(h)})},bo=e=>{try{let r=we();if(!r)return!1;let t=r.getElementById(ke);if(!t)return!1;Array.isArray(ye.appliedClasses)&&ye.appliedClasses.length&&ye.appliedClasses.forEach(l=>{l&&t.classList.remove(l)});let a=Array.isArray(e.panelClassList)?[...e.panelClassList]:[];return a.forEach(l=>{l&&t.classList.add(l)}),ye.appliedClasses=a,t.dataset.rlhTheme=e.id,e.colorScheme?t.dataset.rlhThemeScheme=e.colorScheme:delete t.dataset.rlhThemeScheme,!0}catch(r){return console.warn("[RegexLoreHub] \u5E94\u7528\u4E3B\u9898\u5230\u9762\u677F\u5931\u8D25\uFF1A",r),!1}},Pl=(e,r,t)=>{let a={theme:e,previous:r,reason:t||"manual"};Et.forEach(l=>{if(typeof l=="function")try{l(a)}catch(n){console.warn("[RegexLoreHub] \u4E3B\u9898\u76D1\u542C\u5668\u6267\u884C\u5931\u8D25\uFF1A",n)}});try{let l=$e(),n=l?.CustomEvent||(typeof CustomEvent=="function"?CustomEvent:null);l&&typeof l.dispatchEvent=="function"&&n?l.dispatchEvent(new n("RegexLoreHubThemeChange",{detail:a})):typeof window<"u"&&typeof window.dispatchEvent=="function"&&n&&window.dispatchEvent(new n("RegexLoreHubThemeChange",{detail:a}))}catch(l){console.warn("[RegexLoreHub] \u6D3E\u53D1\u4E3B\u9898\u4E8B\u4EF6\u5931\u8D25\uFF1A",l)}},Br=()=>{let e=rr.get(ye.activeId);if(e)return ye.activeSnapshot=e,ye.colorScheme=e.colorScheme,e;let r=rr.get(ye.fallbackId);if(r)return ye.activeId=r.id,ye.activeSnapshot=r,ye.colorScheme=r.colorScheme,r;let t=gr.length?rr.get(gr[0]):null;return t&&(ye.fallbackId=t.id,ye.activeId=t.id,ye.activeSnapshot=t,ye.colorScheme=t.colorScheme),t??null},jr=e=>{try{let r=Ul(e);return Hl(r),ye.fallbackId||(ye.fallbackId=r.id),ye.activeId||(ye.activeId=r.id),ye.activeId===r.id&&(ye.activeSnapshot=r,ye.colorScheme=r.colorScheme),r}catch(r){return console.error("[RegexLoreHub] \u6CE8\u518C\u4E3B\u9898\u5931\u8D25\uFF1A",r),null}},zl=e=>{let r=It(e);return r?rr.get(r)??null:null},mo=()=>gr.map(e=>rr.get(e)).filter(Boolean),Fr=()=>Br(),go=e=>{let r=zl(e);return r&&typeof r.label=="string"&&r.label.trim()?r.label.trim():typeof e=="string"&&e.trim()?e.trim():""},Wr=(e,r={})=>{let{reason:t="manual",applyToDom:a=!0,silent:l=!1}=r??{},n=It(e),i=n==="default"?"gruvbox-light-hard":n,h=i&&rr.get(i)||Br();if(!h)return null;let m=Br(),b=!m||m.id!==h.id;if(ye.activeId=h.id,ye.activeSnapshot=h,ye.colorScheme=h.colorScheme,a){let p=bo(h);ye.pendingApplyId=p?null:h.id}else ye.pendingApplyId=h.id;return b&&!l&&Pl(h,m,t),h},fo=()=>{let e=Br();if(!e)return!1;let r=bo(e);return ye.pendingApplyId=r?null:e.id,r},xo=e=>typeof e!="function"?()=>{}:(Et.add(e),()=>Et.delete(e));jr({id:"dark",label:"\u6697\u8272",description:"\u6DF1\u8272\u754C\u9762\uFF0C\u7EE7\u627F\u73B0\u6709 dark \u6837\u5F0F\u3002",order:0,panelClassList:["dark","rlh-theme-dark"],colorScheme:"dark"});jr({id:"gruvbox-light-hard",label:"Gruvbox",description:"\u91C7\u7528 Gruvbox Light Hard \u8C03\u8272\u677F\u7684\u6D45\u8272\u4E3B\u9898\u3002",order:1,panelClassList:["rlh-theme-gruvbox"],colorScheme:"light",metadata:{family:"gruvbox",variant:"light-hard"}});jr({id:"gruvbox-dark",label:"\u7425\u73C0\u591C\u822A",description:"\u9AD8\u5BF9\u6BD4 Gruvbox \u6697\u8272\u4E3B\u9898\uFF0C\u9002\u5408\u591C\u95F4\u548C\u9AD8\u5BF9\u6BD4\u9700\u6C42\u3002",order:2,panelClassList:["rlh-theme-gruvbox-dark","dark"],colorScheme:"dark",metadata:{family:"gruvbox",variant:"dark",contrast:"high"}});jr({id:"slate-dim",label:"\u77F3\u677F\u5FAE\u5149",description:"\u84DD\u7EFF\u5FAE\u5149\u4F4E\u4EAE\u5EA6\u62A4\u773C\u4E3B\u9898\uFF0C\u9002\u5408\u957F\u65F6\u95F4\u9605\u8BFB\u3002",order:3,panelClassList:["rlh-theme-slate-dim","dark"],colorScheme:"dark",metadata:{family:"slate",variant:"dim",intent:"long-reading"}});jr({id:"aurora",label:"\u6781\u5149\u6F84\u84DD",description:"\u84DD\u7EFF\u6E10\u53D8\u54C1\u724C\u6D45\u8272\u4E3B\u9898\uFF0C\u9002\u5408\u5C55\u793A\u4E0E\u5206\u4EAB\u3002",order:4,panelClassList:["rlh-theme-aurora"],colorScheme:"light",metadata:{family:"aurora",variant:"light",intent:"brand-showcase"}});Br();var jl=[{id:"constant",label:"\u6C38\u4E45\u6FC0\u6D3B",shortLabel:"\u6C38\u4E45",description:"\u5FFD\u7565\u5173\u952E\u8BCD\u9650\u5236\uFF0C\u53EA\u8981\u6761\u76EE\u542F\u7528\u4E14\u6EE1\u8DB3\u6982\u7387\u5C31\u59CB\u7EC8\u5C1D\u8BD5\u6FC0\u6D3B\u3002",strategyType:"constant",toastLabel:"\u6C38\u4E45\u6FC0\u6D3B",accentVar:_t.statusConstant,badgeClass:"rlh-status-badge--constant",order:0},{id:"selective",label:"\u5173\u952E\u8BCD\u89E6\u53D1",shortLabel:"\u5173\u952E\u8BCD",description:"\u5339\u914D\u4E3B\u8981/\u6B21\u8981\u5173\u952E\u8BCD\u540E\u6FC0\u6D3B\uFF0C\u53EF\u7ED3\u5408\u6982\u7387\u4E0E\u626B\u63CF\u6DF1\u5EA6\u63A7\u5236\u89E6\u53D1\u3002",strategyType:"selective",toastLabel:"\u5173\u952E\u8BCD\u89E6\u53D1",accentVar:_t.statusSelective,badgeClass:"rlh-status-badge--selective",order:1},{id:"vectorized",label:"\u5411\u91CF\u5316",shortLabel:"\u5411\u91CF",description:"\u4F9D\u8D56\u5411\u91CF\u76F8\u4F3C\u5EA6\u6FC0\u6D3B\uFF0C\u9002\u7528\u4E8E\u8BED\u4E49\u53EC\u56DE\u573A\u666F\u3002",strategyType:"vectorized",toastLabel:"\u5411\u91CF\u5316",accentVar:_t.statusVectorized,badgeClass:"rlh-status-badge--vectorized",order:2}],vo=jl.map(e=>Object.freeze({...e,id:String(e.id).toLowerCase(),strategyType:String(e.strategyType??e.id).toLowerCase(),toastLabel:e.toastLabel??e.label,shortLabel:e.shortLabel??e.label})),$t={};vo.forEach(e=>{$t[e.id]=e,$t[e.strategyType]=e});var Rt=Object.freeze($t),it=Object.freeze([...vo].sort((e,r)=>e.order-r.order)),Re=Rt.constant,st=Re?.id??"constant",Gr=e=>{if(!e&&e!==0)return null;let r=String(e).trim().toLowerCase();return Rt[r]?.id??null},qe=e=>{let r=Gr(e);return r?Rt[r]??null:null};var Xe={position:{before_character_definition:"\u89D2\u8272\u5B9A\u4E49\u524D",after_character_definition:"\u89D2\u8272\u5B9A\u4E49\u540E",before_example_messages:"\u804A\u5929\u793A\u4F8B\u524D",after_example_messages:"\u804A\u5929\u793A\u4F8B\u540E",before_author_note:"\u4F5C\u8005\u7B14\u8BB0\u524D",after_author_note:"\u4F5C\u8005\u7B14\u8BB0\u540E",at_depth_as_system:"@D \u2699 \u7CFB\u7EDF",at_depth_as_assistant:"@D \u{1F5E8}\uFE0F \u89D2\u8272",at_depth_as_user:"@D \u{1F464} \u7528\u6237"},logic:{and_any:"\u4EFB\u4E00 AND",and_all:"\u6240\u6709 AND",not_any:"\u4EFB\u4E00 NOT",not_all:"\u6240\u6709 NOT"}},Lr={bookName:"\u4E66\u540D",entryName:"\u6761\u76EE\u540D",keywords:"\u5173\u952E\u8BCD",content:"\u5185\u5BB9"},At={entryName:"\u540D\u79F0",content:"\u5185\u5BB9"},yo={bookName:{id:"rlh-filter-book-name"},entryName:{id:"rlh-filter-entry-name"},keywords:{id:"rlh-filter-keywords"},content:{id:"rlh-filter-content"}},ko={status:{value:"status",label:"\u6309\u542F\u7528\u72B6\u6001"},name:{value:"name",label:"\u540D\u79F0\u6392\u5E8F"}},o={regexes:{global:[],character:[]},lorebooks:{character:[]},chatLorebook:null,allLorebooks:[],theme:ye,lorebookEntries:new Map,pendingLorebookUpdates:new Map,pendingRegexUpdates:new Set,lorebookUsage:new Map,activeTab:"global-lore",activeView:"global-lore-list",activeBookName:null,activeCharacterBook:null,charLoreInitialSynced:!1,pendingHighlightEntry:null,isDataLoaded:!1,isLoadingTabData:!1,loadingBookName:null,searchFilters:{bookName:!0,entryName:!0,keywords:!0,content:!0},multiSelectMode:!1,multiSelectTarget:"book",selectedItems:new Set,globalSearch:{term:"",replace:""},searchFilterContextsInitialized:new Set,collapseStateByContext:new Map,sortModeByContext:new Map,characterContext:{name:null,id:null},saveStatus:"idle",saveRetryAttempt:0,isToolbarCollapsed:!0,isDragSortDisabled:!1,paths:{rlhRoot:St,vendor:St?`${St}/vendor`:""}},ct=e=>!e&&e!==0?"":typeof e=="string"?e.trim():e&&typeof e=="object"&&typeof e.name=="string"?e.name.trim():String(e??"").trim(),ao=(e,r)=>{if(!e||!r&&r!==0)return;let t=typeof r=="string"?r.trim():String(r).trim();t&&e.add(t)},Or=e=>e==null?"":encodeURIComponent(String(e)),ze=e=>{if(e==null)return"";try{return decodeURIComponent(String(e))}catch{return String(e)}},Ze=e=>{let r=ct(e);return r?`book:${Or(r)}`:""},Kr=(e,r)=>{let t=ct(e);if(!t)return"";let a=r??"";return`lore:${Or(t)}:${Or(a)}`},fr=e=>{let r=ct(e);return r?`lore:${Or(r)}:`:"lore:"},Vr=e=>`regex:${Or(e??"")}`,wo=e=>{let r=new Set,t=new Set,a=typeof e=="string"?{name:e}:e??{},l=ct(a),n=m=>ao(r,m),i=m=>ao(t,m);if(a&&typeof a=="object"&&(Array.isArray(a.characters)?a.characters.forEach(n):a.characters&&typeof a.characters=="object"&&Object.values(a.characters).forEach(n),Array.isArray(a.charIds)?a.charIds.forEach(i):Array.isArray(a.characterIds)?a.characterIds.forEach(i):a.charIds&&typeof a.charIds=="object"&&Object.values(a.charIds).forEach(i)),l&&o.lorebookUsage instanceof Map&&o.lorebookUsage.has(l)){let m=o.lorebookUsage.get(l);Array.isArray(m)&&m.forEach(n)}let h=r.size+t.size;return{name:l,characters:[...r],charIds:[...t],bindingCount:h}};var no="RegexLoreHubAnalytics",Fl="select_unbound_lorebooks",Wl="v3.3",Gl=500,io=new Map,Mt=(e={})=>{try{let r=Date.now(),t=typeof e.category=="string"?e.category.trim():"",a=typeof e.action=="string"?e.action.trim():"",l=t||"unknown",n=a||"unknown",i=`${l}::${n}`,h=io.get(i)??0;if(r-h<Gl)return;io.set(i,r);let m=typeof o.activeView=="string"?o.activeView.trim():"",b=typeof e.feature=="string"&&e.feature.trim()?e.feature.trim():Fl,p=typeof e.view=="string"&&e.view.trim()?e.view.trim():m||"unknown",f={source:"regex-lore-hub",timestamp:r,version:Wl,...e,category:l,action:n,feature:b,view:p},v=$e(),w=v?.CustomEvent||(typeof CustomEvent=="function"?CustomEvent:null);if(v&&typeof v.dispatchEvent=="function"&&w){v.dispatchEvent(new w(no,{detail:f}));return}if(typeof window<"u"&&typeof window.dispatchEvent=="function"&&w){window.dispatchEvent(new w(no,{detail:f}));return}console.info("[RegexLoreHub] Analytics event captured:",f)}catch(r){console.warn("[RegexLoreHub] emitAnalyticsEvent \u8C03\u7528\u5931\u8D25\uFF1A",r)}},ne=e=>{try{(!o.lorebookEntries||!(o.lorebookEntries instanceof Map))&&(console.warn("[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing..."),o.lorebookEntries=new Map),typeof o.lorebookEntries.get!="function"&&(console.warn("[RegexLoreHub] appState.lorebookEntries.get is not a function, reinitializing..."),o.lorebookEntries=new Map);let r=o.lorebookEntries.get(e);return Array.isArray(r)?r:[]}catch(r){return console.error("[RegexLoreHub] Error in safeGetLorebookEntries:",r),o.lorebookEntries=new Map,[]}},Oe=(e,r)=>{try{(!o.lorebookEntries||!(o.lorebookEntries instanceof Map))&&(console.warn("[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing..."),o.lorebookEntries=new Map),typeof o.lorebookEntries.set!="function"&&(console.warn("[RegexLoreHub] appState.lorebookEntries.set is not a function, reinitializing..."),o.lorebookEntries=new Map),o.lorebookEntries.set(e,Array.isArray(r)?r:[])}catch(t){console.error("[RegexLoreHub] Error in safeSetLorebookEntries:",t),o.lorebookEntries=new Map,o.lorebookEntries.set(e,Array.isArray(r)?r:[])}},Yr=e=>{try{if(!o.lorebookEntries||!(o.lorebookEntries instanceof Map)){console.warn("[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing..."),o.lorebookEntries=new Map;return}if(typeof o.lorebookEntries.delete!="function"){console.warn("[RegexLoreHub] appState.lorebookEntries.delete is not a function, reinitializing..."),o.lorebookEntries=new Map;return}o.lorebookEntries.delete(e)}catch(r){console.error("[RegexLoreHub] Error in safeDeleteLorebookEntries:",r),o.lorebookEntries=new Map}},Bt=()=>{try{if(!o.lorebookEntries||!(o.lorebookEntries instanceof Map)){console.warn("[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing..."),o.lorebookEntries=new Map;return}if(typeof o.lorebookEntries.clear!="function"){console.warn("[RegexLoreHub] appState.lorebookEntries.clear is not a function, reinitializing..."),o.lorebookEntries=new Map;return}o.lorebookEntries.clear()}catch(e){console.error("[RegexLoreHub] Error in safeClearLorebookEntries:",e),o.lorebookEntries=new Map}},Ot=e=>{try{return!o.lorebookEntries||!(o.lorebookEntries instanceof Map)?(console.warn("[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing..."),o.lorebookEntries=new Map,!1):typeof o.lorebookEntries.has!="function"?(console.warn("[RegexLoreHub] appState.lorebookEntries.has is not a function, reinitializing..."),o.lorebookEntries=new Map,!1):o.lorebookEntries.has(e)}catch(r){return console.error("[RegexLoreHub] Error in safeHasLorebookEntries:",r),o.lorebookEntries=new Map,!1}};function $e(){return window.parent||window}function we(){return $e().document}var D=e=>{if(typeof e!="string")return String(e);let r=we().createElement("div");return r.textContent=e,r.innerHTML},xr=(e,r)=>{if(!r||!e)return D(e);let t=D(e),a=D(r),l=new Set([".","*","+","?","^","$","{","}","(",")","|","[","]","\\\\"]),n="";for(let h of a)n+=l.has(h)?"\\"+h:h;let i=new RegExp(`(${n})`,"gi");return t.replace(i,'<mark class="rlh-highlight">$1</mark>')},ve=(e,r="success",t=2e3)=>{let a=xe(),l=we();if(!a||!l)return;let n=a(`#${ke}`,l);if(n.length===0)return;n.find(".rlh-toast-notification").remove();let i={success:"fa-check-circle",error:"fa-times-circle",info:"fa-info-circle"}[r],h=`
    <div class="rlh-toast-notification ${r}">
      <i class="fa-solid ${i}"></i> ${D(e)}
    </div>
  `,m=a(h);n.append(m),setTimeout(()=>m.addClass("visible"),10),setTimeout(()=>{m.removeClass("visible"),setTimeout(()=>m.remove(),300)},t)},lr=(e="\u6B63\u5728\u5904\u7406...")=>{let r=xe(),t=we();if(!r||!t)return{update:()=>{},remove:()=>{}};let a=r(`#${ke}`,t);if(a.length===0)return{update:()=>{},remove:()=>{}};a.find(".rlh-progress-toast").remove();let l=`<div class="rlh-progress-toast"><i class="fa-solid fa-spinner fa-spin"></i> <span class="rlh-progress-text">${D(e)}</span></div>`,n=r(l);return a.append(n),setTimeout(()=>n.addClass("visible"),10),{update:m=>{n.find(".rlh-progress-text").html(D(m))},remove:()=>{n.removeClass("visible"),setTimeout(()=>n.remove(),300)}}},Q=e=>{let r=xe(),t=we();return!r||!t?Promise.reject():new Promise((a,l)=>{let{type:n="alert",title:i="\u901A\u77E5",text:h="",html:m="",placeholder:b="",value:p="",danger:f=!1}=e||{},v="",w=f?" rlh-btn-danger":"";n==="alert"?v=`<button class="rlh-modal-btn rlh-modal-ok${w}">\u786E\u5B9A</button>`:n==="confirm"?v=`<button class="rlh-modal-btn rlh-modal-cancel">\u53D6\u6D88</button><button class="rlh-modal-btn rlh-modal-ok${w}">\u786E\u8BA4</button>`:n==="prompt"&&(v=`<button class="rlh-modal-btn rlh-modal-cancel">\u53D6\u6D88</button><button class="rlh-modal-btn rlh-modal-ok${w}">\u786E\u5B9A</button>`);let E=n==="prompt"?`<input type="text" class="rlh-modal-input" placeholder="${D(b)}" value="${D(p)}">`:"",T=m||`<p>${D(h)}</p>`,A=`<div class="rlh-modal-overlay"><div class="rlh-modal-content"><div class="rlh-modal-header">${D(i)}</div><div class="rlh-modal-body">${T}${E}</div><div class="rlh-modal-footer">${v}</div></div></div>`,s=r(A).hide(),g=r(`#${ke}`,t);g.length>0?g.append(s):r("body",t).append(s),s.fadeIn(200);let x=s.find(".rlh-modal-input");n==="prompt"&&x.focus().select();let R=(I,S)=>{s.fadeOut(200,()=>{s.remove(),I?a(S):l()})};s.on("click",".rlh-modal-ok",()=>{let I=n==="prompt"?x.val():!0;if(n==="prompt"&&!String(I).trim()){x.addClass("rlh-input-error"),setTimeout(()=>x.removeClass("rlh-input-error"),500);return}R(!0,I)}),s.on("click",".rlh-modal-cancel",()=>R(!1)),n==="prompt"&&x.on("keydown",I=>{I.key==="Enter"?s.find(".rlh-modal-ok").click():I.key==="Escape"&&s.find(".rlh-modal-cancel").click()})})},B=(e,r="RegexLoreHub",t={})=>{let{notify:a="toast",toastType:l="error",toastDuration:n=4e3,toastMessage:i="\u64CD\u4F5C\u53D1\u751F\u5F02\u5E38\uFF0C\u8BF7\u67E5\u770B\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u3002",modalTitle:h="\u811A\u672C\u5F02\u5E38",modalText:m="\u64CD\u4F5C\u4E2D\u53D1\u751F\u672A\u77E5\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u3002"}=t??{};return async(...b)=>{try{return await e(...b)}catch(p){if(!p)return;if(console.error(`[${r}] Error:`,p),a==="modal"){await Q({type:"alert",title:h,text:m});return}a==="toast"&&ve(i,l,n)}}};function Dt(e,r){let t;return function(...a){let l=this;clearTimeout(t),t=setTimeout(()=>e.apply(l,a),r)}}var So=(e,r)=>{let t=e.replace(/[.*+?^${}()|[\]\/\\]/g,"\\$&"),a=r?"g":"gi";return new RegExp(t,a)},_o={INSERT_RULES_TITLE:"\u63D2\u5165\u89C4\u5219"};var Cr=e=>e.instanceKey||e.id||"default",vr=e=>{let r=Cr(e);return o.collapseStateByContext.get(r)??"expanded"},Eo=(e,r)=>{let t=Cr(e);o.collapseStateByContext.set(t,r)},dr=e=>{let r=Array.isArray(e.sortOptions)?e.sortOptions:[];if(!r.length)return null;let t=Cr(e),a=o.sortModeByContext.get(t);if(a&&r.includes(a))return a;let l=r[0];return o.sortModeByContext.set(t,l),l},$o=(e,r)=>{if(!(e.sortOptions??[]).includes(r))return;let a=Cr(e);o.sortModeByContext.set(a,r)},Xr=e=>D(String(e??"")),ht=e=>qe(e)??Re,pt=(e,{shortLabel:r=!1,withIcon:t=!0}={})=>{let a=ht(e),l=r?a.shortLabel:a.label,n=t?'<i class="fa-solid fa-circle"></i>':"";return`<span class="rlh-status-badge ${a.badgeClass??""}" data-status-id="${Xr(a.id)}">${n}<span class="rlh-status-badge__text">${D(l)}</span></span>`},Kl=()=>it.map(e=>{let r=pt(e.id,{shortLabel:!0});return`<li role="presentation"><button type="button" class="rlh-unified-status-option" data-status-id="${Xr(e.id)}" role="option" aria-selected="false">${r}<span class="rlh-unified-status-option__label">${D(e.label)}</span></button></li>`}).join(""),Vl=(e,r)=>{let t=e.visibleFilters??[];if(!t.length)return"";let a=t.map(l=>{let n=yo[l];if(!n)return"";let i=e.filterLabels?.[l]??Lr[l]??l,h=r[l];return`<label class="rlh-filter-item"><input type="checkbox" id="${n.id}" data-filter-key="${l}" ${h?"checked":""}>${i}</label>`}).filter(Boolean).join("");return a?`<div class="rlh-filter-list" id="rlh-search-filters-container">${a}</div>`:""},Yl=(e,r)=>{let t=Array.isArray(e.sortOptions)?e.sortOptions:[];if(!t.length)return"";let a=t.map(n=>{let i=ko[n];if(!i)return"";let h=i.value===r;return`<li role="presentation"><button type="button" class="rlh-sort-option${h?" active":""}" data-sort-value="${i.value}" role="option" aria-selected="${h?"true":"false"}">${i.label}</button></li>`}).filter(Boolean).join("");if(!a)return"";let l=`${Er}-list`;return`<div class="rlh-sort-menu" id="${Er}" data-open="false"><button type="button" id="${ir}" class="rlh-toolbar-btn rlh-btn-secondary" data-current-sort="${r??""}" aria-haspopup="listbox" aria-expanded="false" aria-controls="${l}"><i class="fa-solid fa-sort"></i><span>\u6392\u5E8F</span></button><ul class="rlh-sort-menu-list" id="${l}" role="listbox" aria-labelledby="${ir}">${a}</ul></div>`},ql=e=>{if(!e.showPositionMenu)return"";let r=new Map;o.selectedItems.forEach(T=>{if(typeof T!="string"||!T.startsWith("lore:"))return;let A=T.lastIndexOf(":");if(A===-1)return;let s=T.slice(5,A),g=T.slice(A+1),x=ze(s),R=ze(g);!x||R===""||(r.has(x)||r.set(x,[]),r.get(x).push(R))});let t=e.activeBookName?.toString().trim()??"";!t&&r.size===1&&(t=[...r.keys()][0]??"");let a=t?ne(t):[],l=a.length>0,n=o.multiSelectMode&&o.multiSelectTarget==="entry",i=t?r.get(t)??[]:[],h=!!t&&(n?i.length>0:l),m;t?!l&&!n?m=`\u300C${t}\u300D\u6682\u65E0\u6761\u76EE\u53EF\u8C03\u6574`:n?m=i.length>0?`\u591A\u9009\u6A21\u5F0F\uFF1A\u5C06\u5BF9\u5DF2\u9009\u4E2D\u7684 ${i.length} \u4E2A\u6761\u76EE\u7EDF\u4E00\u4F4D\u7F6E`:"\u5DF2\u5F00\u542F\u591A\u9009\uFF0C\u8BF7\u5148\u52FE\u9009\u8981\u8C03\u6574\u4F4D\u7F6E\u7684\u6761\u76EE":m=`\u5C06\u5BF9\u300C${t}\u300D\u4E2D\u7684\u6240\u6709\u6761\u76EE\u7EDF\u4E00\u4F4D\u7F6E`:m=r.size>0?"\u591A\u9009\u6A21\u5F0F\uFF1A\u672A\u80FD\u8BC6\u522B\u9009\u4E2D\u7684\u6761\u76EE\u5F52\u5C5E\uFF0C\u8BF7\u91CD\u65B0\u9009\u62E9":"\u8BF7\u5148\u6253\u5F00\u9700\u8981\u7EDF\u4E00\u4F4D\u7F6E\u7684\u4E16\u754C\u4E66";let b=new Set(a.map(T=>(T?.position??"before_character_definition").toString())),p=b.size===1?b.values().next().value:null,f=`${or}-list`,v=['type="button"',`id="${Qe}"`,'class="rlh-toolbar-btn rlh-btn-secondary"','aria-haspopup="listbox"','aria-expanded="false"',`aria-controls="${f}"`,`title="${D(m)}"`];h||v.push("disabled"),t&&v.push(`data-book-name="${D(t)}"`);let w=Object.entries(Xe.position).map(([T,A])=>{let s=l&&p===T,g=['type="button"',`class="rlh-position-option${s?" active":""}"`,`data-position-value="${D(T)}"`,'role="option"',`aria-selected="${s?"true":"false"}"`];return t&&g.push(`data-book-name="${D(t)}"`),`<li role="presentation"><button ${g.join(" ")}>${D(A)}</button></li>`}).join(""),E=['class="rlh-position-menu"',`id="${or}"`,'data-open="false"'];return t&&E.push(`data-book-name="${D(t)}"`),`<div ${E.join(" ")}><button ${v.join(" ")}><i class="fa-solid fa-map-pin"></i><span>\u7EDF\u4E00\u4F4D\u7F6E</span></button><ul class="rlh-position-menu-list" id="${f}" role="listbox" aria-labelledby="${Qe}">${w}</ul></div>`},To=(e,{$toolbar:r,$replaceContainer:t})=>{let a=vr(e),l=e.sortOptions?.length??0?dr(e):null,n=["rlh-toolbar-btn"];o.multiSelectMode&&n.push("active"),e.supportsMultiSelect||n.push("disabled");let i=['type="button"','id="rlh-multi-select-btn"',`class="${n.join(" ")}"`,`data-target="${e.supportsMultiSelect?e.multiSelectTarget:""}"`];e.supportsMultiSelect||i.push("disabled");let h=`<button ${i.join(" ")}><i class="fa-solid fa-check-double"></i><span>\u591A\u9009\u6A21\u5F0F</span></button>`,m=["rlh-multi-select-controls"];o.multiSelectMode&&m.push("active");let b=e.supportsMultiSelect?`
        <div id="rlh-multi-select-controls" class="${m.join(" ")}">
          <div class="rlh-multi-select-actions">
            <button class="rlh-multi-select-action-btn" id="rlh-select-all-btn" title="\u5168\u9009">\u5168</button>
            <button class="rlh-multi-select-action-btn" id="rlh-select-none-btn" title="\u6E05\u9664">\u6E05</button>
            <button class="rlh-multi-select-action-btn" id="rlh-select-invert-btn" title="\u53CD\u9009">\u53CD</button>
            <button class="rlh-multi-select-action-btn enable" id="rlh-batch-enable-btn" title="\u542F\u7528">\u5F00</button>
            <button class="rlh-multi-select-action-btn disable" id="rlh-batch-disable-btn" title="\u7981\u7528">\u5173</button>
            <button class="rlh-multi-select-action-btn disable rlh-btn-danger" id="rlh-batch-delete-btn" title="\u5220\u9664">\u5220</button>
          </div>
          <span class="rlh-selection-count" id="rlh-selection-count">\u5DF2\u9009\u62E9: ${o.selectedItems.size}</span>
        </div>
      `:"",p=`
        <div class="rlh-multi-select-module">
          ${h}
          ${b}
        </div>
      `,f=e.supportsMultiSelect&&e.multiSelectTarget==="entry"?(()=>{let L=`${$r}`,C=`${$r}-list`,N=Kl(),H=["rlh-unified-status"];o.multiSelectMode&&H.push("is-multiselect");let z=new Map;o.selectedItems.forEach(be=>{if(typeof be!="string"||!be.startsWith("lore:"))return;let de=be.lastIndexOf(":");if(de===-1)return;let Ge=be.slice(5,de),Le=be.slice(de+1),Ke=ze(Ge),br=ze(Le);!Ke||br===""||(z.has(Ke)||z.set(Ke,[]),z.get(Ke).push(br))});let M=[e.activeBookName,o.activeBookName,o.activeCharacterBook,o.chatLorebook].find(be=>typeof be=="string"&&be.trim().length>0)?.toString().trim()??"";!M&&z.size===1&&(M=[...z.keys()][0]??"");let ee=(M?ne(M):[]).length>0,ae=o.multiSelectMode&&o.multiSelectTarget==="entry",te=M?z.get(M)??[]:[],fe=Array.from(z.values()).reduce((be,de)=>be+(Array.isArray(de)?de.length:0),0),_e=!!M&&(ae?te.length>0:ee),G;return M?!ee&&!ae?G=`\u300C${M}\u300D\u6682\u65E0\u6761\u76EE\u53EF\u8C03\u6574`:ae?G=te.length>0?`\u591A\u9009\u6A21\u5F0F\uFF1A\u5C06\u5BF9\u5DF2\u9009\u4E2D\u7684 ${te.length} \u4E2A\u6761\u76EE\u7EDF\u4E00\u72B6\u6001`:"\u5DF2\u5F00\u542F\u591A\u9009\uFF0C\u8BF7\u5148\u52FE\u9009\u8981\u8C03\u6574\u72B6\u6001\u7684\u6761\u76EE":G=`\u5C06\u5BF9\u300C${M||"\u5F53\u524D\u4E16\u754C\u4E66"}\u300D\u7684\u6240\u6709\u6761\u76EE\u7EDF\u4E00\u72B6\u6001`:G=z.size>0?"\u591A\u9009\u6A21\u5F0F\uFF1A\u672A\u80FD\u8BC6\u522B\u9009\u4E2D\u7684\u6761\u76EE\u5F52\u5C5E\uFF0C\u8BF7\u91CD\u65B0\u9009\u62E9":"\u8BF7\u5148\u6253\u5F00\u9700\u8981\u7EDF\u4E00\u72B6\u6001\u7684\u4E16\u754C\u4E66",`
            <div class="${H.join(" ")}" id="${L}" data-open="false">
              <button type="button" id="${sr}" class="rlh-toolbar-btn" aria-haspopup="listbox" aria-expanded="false" aria-controls="${C}" ${_e?"":"disabled"} title="${D(G)}">
                <i class="fa-solid fa-layer-group"></i><span>\u7EDF\u4E00\u72B6\u6001</span>
              </button>
              <ul class="rlh-unified-status-menu" id="${C}" role="listbox">
                ${N}
              </ul>
            </div>
          `})():"",v="";e.showCollapseToggle&&(v=`<button type="button" id="${_r}" class="rlh-toolbar-btn" data-collapse-state="${a}"><i class="fa-solid ${a==="collapsed"?"fa-expand-arrows-alt":"fa-compress-arrows-alt"}"></i><span>${a==="collapsed"?"\u5168\u90E8\u5C55\u5F00":"\u5168\u90E8\u6298\u53E0"}</span></button>`);let w=e.showRecursion?(()=>{let L=e.activeBookName??"",C=['type="button"',`id="${co}"`,'class="rlh-toolbar-btn rlh-btn-secondary rlh-batch-recursion-btn"'];return L?C.push(`data-book-name="${D(L)}"`):C.push("disabled"),`<button ${C.join(" ")}><i class="fa-solid fa-shield-halved"></i><span>\u5168\u5F00\u9632\u9012\u5F52</span></button>`})():"",E=e.showFixKeywords?(()=>{let L=e.activeBookName??"",C=['type="button"',`id="${ho}"`,'class="rlh-toolbar-btn rlh-btn-secondary rlh-fix-keywords-btn"'];return L?C.push(`data-book-name="${D(L)}"`):C.push("disabled"),`<button ${C.join(" ")}><i class="fa-solid fa-check-double"></i><span>\u4FEE\u590D\u5173\u952E\u8BCD</span></button>`})():"",T=ql(e),A=Yl(e,l),s=Vl(e,o.searchFilters),g=D(e.scopeLabel),x=D(e.searchPlaceholder),R=Xr(o.globalSearch.term??""),K=`<div class="rlh-search-row">${`<label class="rlh-search-field">
          <input type="search" id="${nr}" class="rlh-search-input" placeholder="${x}" value="${R}" autocomplete="off" />
        </label>`}<button type="button" id="rlh-search-clear-btn" class="rlh-toolbar-icon-btn rlh-btn-secondary" title="\u6E05\u7A7A"><i class="fa-solid fa-eraser"></i></button></div>`,ce=Xr(o.globalSearch.replace??""),q=e.showReplace?`<div class="rlh-replace-body"><input type="text" id="${Sr}" class="rlh-replace-input" placeholder="\u66FF\u6362\u4E3A..." value="${ce}" /><button type="button" id="rlh-replace-btn" class="rlh-toolbar-icon-btn rlh-btn-secondary rlh-replace-action" title="\u66FF\u6362"><i class="fa-solid fa-repeat"></i></button></div>`:"",Z=`<div class="rlh-search-meta">
          ${s}
          <span class="rlh-search-scope">${g}</span>
        </div>`,W=`<div class="rlh-search-box">${K}${q}${Z}</div>`,le="";if(e.primaryAction?.visible&&e.primaryAction.scope==="entry"){let L=e.activeBookName??"",C=!L,N=["rlh-toolbar-btn","rlh-btn-primary","rlh-create-entry-btn"];C&&N.push("disabled");let H=['type="button"',`class="${N.join(" ")}"`],z=e.primaryAction.title??e.primaryAction.label??"";z&&H.push(`title="${D(z)}"`),C?H.push("disabled"):H.push(`data-book-name="${D(L)}"`);let J=e.primaryAction.icon?e.primaryAction.icon:"fa-file-circle-plus",M=D(e.primaryAction.label??"\u65B0\u5EFA\u6761\u76EE");le=`<button ${H.join(" ")}><i class="fa-solid ${J}"></i><span>${M}</span></button>`}let pe="";if(e.primaryAction?.visible&&e.primaryAction.scope==="book"){let C=['type="button"','id="regex-lore-hub-create-lorebook-btn"',`class="${["rlh-toolbar-btn","rlh-btn-primary","rlh-create-book-btn"].join(" ")}"`],N=e.primaryAction.title??e.primaryAction.label??"";N&&C.push(`title="${D(N)}"`);let H=e.primaryAction.icon?e.primaryAction.icon:"fa-plus",z=D(e.primaryAction.label??"\u65B0\u5EFA\u4E16\u754C\u4E66");pe=`<button ${C.join(" ")}><i class="fa-solid ${H}"></i><span>${z}</span></button>`}let ue=e.id==="global-lore-list"?'<button type="button" class="rlh-toolbar-btn rlh-btn-secondary rlh-select-unbound" title="\u4E00\u952E\u9009\u4E2D\u672A\u7ED1\u5B9A\u4EFB\u4F55\u89D2\u8272\u5361\u7684\u4E16\u754C\u4E66"><i class="fa-solid fa-link-slash"></i><span>\u9009\u62E9\u5B64\u7ACB\u4E16\u754C\u4E66</span></button>':"",oe=`
    <div class="rlh-toolbar-section rlh-toolbar-section--search">
      <div class="rlh-search-section-grid">
        <div class="rlh-search-section-main">
          ${W}
        </div>
        <div class="rlh-search-section-multiselect">
          ${p}
        </div>
      </div>
    </div>
  `,ie=[pe,ue,le,e.showCollapseToggle?v:"",w,E,f,T,A].filter(Boolean),u=ie.length?`
        <div class="rlh-toolbar-section rlh-toolbar-section--actions">
          <div class="rlh-toolbar-actions">
            ${ie.join("")}
          </div>
        </div>
      `:"",O=`
    <div class="rlh-toolbar-inner">
      ${[oe,u].filter(Boolean).join("")}
    </div>

  `;if(r.html(O),e.supportsMultiSelect&&e.multiSelectTarget==="entry"){let C=[e.activeBookName,o.activeBookName,o.activeCharacterBook,o.chatLorebook].find(te=>typeof te=="string"&&te.trim().length>0)?.toString().trim()??"",N=C?ne(C):[],H=N.length>0,z=o.multiSelectMode&&o.multiSelectTarget==="entry",J=fr(C),M=z&&N.length>0&&[...o.selectedItems].some(te=>typeof te=="string"&&te.startsWith(J)),j=H&&(!z||M),ee=H?z?M?"\u591A\u9009\u6A21\u5F0F\uFF1A\u4EC5\u5BF9\u9009\u4E2D\u7684\u6761\u76EE\u7EDF\u4E00\u72B6\u6001":"\u5DF2\u5F00\u542F\u591A\u9009\uFF0C\u8BF7\u5148\u52FE\u9009\u8981\u8C03\u6574\u72B6\u6001\u7684\u6761\u76EE":`\u5C06\u5BF9\u300C${C||"\u5F53\u524D\u4E16\u754C\u4E66"}\u300D\u7684\u6240\u6709\u6761\u76EE\u7EDF\u4E00\u72B6\u6001`:C?`\u300C${C}\u300D\u6682\u65E0\u6761\u76EE\u53EF\u8C03\u6574`:"\u8BF7\u5148\u6253\u5F00\u9700\u8981\u7EDF\u4E00\u72B6\u6001\u7684\u4E16\u754C\u4E66",ae=$(`#${sr}`,r);ae.length&&(ae.attr("title",ee),j?ae.removeAttr("disabled"):ae.attr("disabled","disabled"))}t.empty()},yr=(e,r)=>{let t=r.toLowerCase();return!!(!t||o.searchFilters.entryName&&(e.name||"").toLowerCase().includes(t)||o.searchFilters.keywords&&e.keys.join(" ").toLowerCase().includes(t)||o.searchFilters.content&&e.content&&e.content.toLowerCase().includes(t))},Lo=(e,r)=>{let t=r.toLowerCase();return!!(o.searchFilters.entryName&&(e.script_name||"").toLowerCase().includes(t)||o.searchFilters.content&&(e.find_regex||"").toLowerCase().includes(t)||o.searchFilters.content&&(e.replace_string||"").toLowerCase().includes(t))},Co=(e,r,t,a)=>{let l=xe(),n=o.lorebookUsage.get(e.name)||[],i=n.length>0?`<div class="rlh-used-by-chars">\u4F7F\u7528\u8005: ${n.map(g=>`<span>${D(g)}</span>`).join(", ")}</div>`:"",h=xr(e.name,r),m=o.multiSelectMode&&o.multiSelectTarget==="book",b=Ze(e.name),p=typeof b=="string"&&b.length>0,f=m&&p&&o.selectedItems.has(b),v=m?`<label class="rlh-selection-control"><input type="checkbox" class="rlh-multi-select-checkbox" data-select-key="${D(b)}" ${f?"checked":""}></label>`:"",w=l(`
      <div class="rlh-book-group" data-book-name="${D(e.name)}" data-select-key="${D(b)}">
          <div class="rlh-global-book-header rlh-clickable-header">
              ${v}
              <div class="rlh-book-title-wrapper">
                  <span class="rlh-item-name">${h}</span>
                  <div class="rlh-book-stats">\u6761\u76EE: ${e.enabledEntryCount} / ${e.entryCount}</div>
              </div>
              <div class="rlh-item-controls">
                  <button class="rlh-action-btn-icon rlh-btn-secondary rlh-rename-book-btn" title="\u91CD\u547D\u540D\u4E16\u754C\u4E66"><i class="fa-solid fa-pen-to-square"></i></button>
                  <button class="rlh-toggle-btn rlh-btn-secondary rlh-global-toggle" title="\u542F\u7528/\u7981\u7528\u6574\u4E2A\u4E16\u754C\u4E66"><i class="fa-solid fa-power-off"></i></button>
                  <button class="rlh-action-btn-icon rlh-btn-danger rlh-delete-book-btn" title="\u5220\u9664\u4E16\u754C\u4E66"><i class="fa-solid fa-folder-minus"></i></button>
              </div>
          </div>
          ${n.length>0?`<div class="rlh-book-summary">${i}</div>`:""}
          <div class="rlh-collapsible-content"></div>
      </div>
    `);w.toggleClass("enabled",e.enabled),w.find(".rlh-global-book-header").toggleClass("enabled",e.enabled),w.toggleClass("selected",f);let E=w.find(".rlh-collapsible-content"),T=l(`<div class="rlh-entry-actions"><button class="rlh-action-btn rlh-btn-primary rlh-create-entry-btn" data-book-name="${D(e.name)}"><i class="fa-solid fa-plus"></i> \u65B0\u5EFA\u6761\u76EE</button><button class="rlh-action-btn rlh-btn-secondary rlh-batch-recursion-btn" data-book-name="${D(e.name)}"><i class="fa-solid fa-shield-halved"></i> \u5168\u5F00\u9632\u9012\u5F52</button><button class="rlh-action-btn rlh-btn-secondary rlh-fix-keywords-btn" data-book-name="${D(e.name)}"><i class="fa-solid fa-check-double"></i> \u4FEE\u590D\u5173\u952E\u8BCD</button></div>`);E.append(T);let A=[...ne(e.name)].sort((g,x)=>(g.display_index??Number.MAX_SAFE_INTEGER)-(x.display_index??Number.MAX_SAFE_INTEGER)),s=t?A:a||[];if(s&&s.length>0){let g=l('<div class="rlh-entry-list-wrapper"></div>');s.forEach(x=>g.append(hr(x,"lore",e.name,r,{enableDrag:!1}))),E.append(g)}else r&&E.append('<div class="rlh-info-text-small">\u65E0\u5339\u914D\u9879</div>');return w},dt=e=>typeof e=="string"?e.replace(/\r?\n/g,"<br>"):e,qr=e=>`<span class="rlh-viewer-empty">${D(e)}</span>`,ut=(e,r)=>{let t=ht(e?.statusId),a=pt(t.id),n=(Array.isArray(e?.keys)?e.keys:[]).join(", "),i=n?dt(r?xr(n,r):D(n)):qr("\u6682\u65E0\u5173\u952E\u8BCD"),h=e?.content??"",m=h?dt(r?xr(h,r):D(h)):qr("\u6682\u65E0\u5185\u5BB9"),b=W=>W!=null&&W!=="",p=(W,le="\u672A\u8BBE\u7F6E")=>b(W)?D(String(W)):qr(le),f=W=>{if(!W)return"";let{label:le,value:pe,placeholder:ue,html:oe}=W,ie=oe!==void 0?oe:p(pe,ue);return`
      <div class="rlh-editor-field rlh-viewer-field">
        <label>${le}</label>
        <div class="rlh-viewer-text">${ie}</div>
      </div>
    `},v=(W,le,pe={})=>{if(!le.length)return"";let ue=pe.layout??"grid",oe=W?`<h5>${W}</h5>`:"",ie="";return ue==="grid"?ie=`
        <div class="rlh-editor-grid">${le.map(k=>`
          <div class="rlh-grid-item">${f(k)}</div>`).join("")}
        </div>
      `:ie=le.map(f).join(""),`
      <div class="rlh-editor-group rlh-viewer-group">
        ${oe}
        ${ie}
      </div>
    `},w=(()=>{let W=e?.position;return b(W)?typeof W=="object"&&W!==null&&typeof W.type=="string"&&W.type?Xe.position?.[W.type]??W.type:typeof W=="string"?Xe.position?.[W]??W:null:null})(),E=b(e?.depth)?e.depth:null,T=b(e?.order)?e.order:null,A=b(e?.logic),s=A?e.logic:"and_any",g=Xe.logic?.[s]??s,x=A?g:`${g} (\u9ED8\u8BA4)`,R=b(e?.probability)?`${e.probability}%`:"100% (\u9ED8\u8BA4)",I=f({label:"\u5173\u952E\u8BCD",html:i}),S=f({label:"\u5185\u5BB9",html:`<article class="rlh:prose rlh:dark:rlh:prose-invert max-w-none">${m}</article>`}),K=v(_o.INSERT_RULES_TITLE,[{label:"\u4F4D\u7F6E",value:w,placeholder:"\u672A\u8BBE\u7F6E"},{label:"\u6DF1\u5EA6",value:E,placeholder:"\u672A\u8BBE\u7F6E"},{label:"\u987A\u5E8F",value:T,placeholder:"\u672A\u8BBE\u7F6E"}],{layout:"grid"}),ce=v("\u6FC0\u6D3B\u903B\u8F91",[{label:"\u6982\u7387",value:R,placeholder:"100% (\u9ED8\u8BA4)"},{label:"\u5173\u952E\u8BCD\u903B\u8F91",value:x,placeholder:"\u4EFB\u4E00 AND (\u9ED8\u8BA4)"}],{layout:"grid"}),q=v("\u5339\u914D\u4E0E\u9012\u5F52",[{label:"\u5927\u5C0F\u5199\u654F\u611F",value:e?.case_sensitive?"\u5F00\u542F":"\u5173\u95ED",placeholder:"\u5173\u95ED"},{label:"\u5168\u8BCD\u5339\u914D",value:e?.match_whole_words?"\u5F00\u542F":"\u5173\u95ED",placeholder:"\u5173\u95ED"},{label:"\u9632\u6B62\u9012\u5F52",value:e?.prevent_recursion?"\u5F00\u542F":"\u5173\u95ED",placeholder:"\u5173\u95ED"},{label:"\u4E0D\u53EF\u88AB\u9012\u5F52",value:e?.exclude_recursion?"\u5F00\u542F":"\u5173\u95ED",placeholder:"\u5173\u95ED"}],{layout:"grid"});return`
    <div class="rlh-entry-viewer" data-mode="view">
      ${v("\u72B6\u6001",[{label:"\u5F53\u524D\u72B6\u6001",html:a}],{layout:"grid"})}
      ${I}
      ${S}
      ${K}
      ${ce}
      ${q}
    </div>
  `},Ht=(e,r)=>{let t=e?.find_regex??"",a=e?.replace_string??"",l=typeof r=="string"?r:"",n=t?dt(l?xr(t,l):D(t)):qr("\u6682\u65E0\u67E5\u627E\u6B63\u5219"),i=a?dt(l?xr(a,l):D(a)):qr("\u6682\u65E0\u66FF\u6362\u5185\u5BB9"),h=e?.destination??{},m=e?.source??{},b=e?.min_depth,p=e?.max_depth,f=[];h.display&&f.push("\u4EC5\u683C\u5F0F\u663E\u793A"),h.prompt&&f.push("\u4EC5\u683C\u5F0F\u63D0\u793A\u8BCD");let v=f.length?f.join(" / "):"\u683C\u5F0F\u4E0E\u63D0\u793A\u8BCD",E=Object.entries({user_input:"\u7528\u6237\u8F93\u5165",ai_output:"AI\u8F93\u51FA",slash_command:"\u659C\u6760\u547D\u4EE4",world_info:"\u4E16\u754C\u4E66"}).filter(([I])=>!!m?.[I]).map(([,I])=>I),T=E.length===0?"\u672A\u9009\u62E9\u4F5C\u7528\u8303\u56F4":E.length===4?"\u5168\u90E8\u6765\u6E90":E.join(" / "),A=b!=null&&b!=="",s=p!=null&&p!=="",g="\u65E0\u6DF1\u5EA6\u9650\u5236";A&&s?g=`${b} - ${p}`:A?g=`>= ${b}`:s&&(g=`<= ${p}`);let R=[{label:"\u8F93\u51FA\u8BBE\u7F6E",value:v},{label:"\u4F5C\u7528\u8303\u56F4",value:T},{label:"\u6DF1\u5EA6\u8303\u56F4",value:g}].map(I=>`
      <div class="rlh-editor-field rlh-viewer-field">
        <label>${I.label}</label>
        <div class="rlh-viewer-text">${D(String(I.value??""))}</div>
      </div>
    `).join("");return`
    <div class="rlh-regex-viewer" data-mode="view">
      <div class="rlh-editor-field rlh-viewer-field">
        <label>\u67E5\u627E\u6B63\u5219\u8868\u8FBE\u5F0F</label>
        <article class="rlh:prose rlh:dark:rlh:prose-invert max-w-none">${n}</article>
      </div>
      <div class="rlh-editor-field rlh-viewer-field">
        <label>\u66FF\u6362\u4E3A</label>
        <article class="rlh:prose rlh:dark:rlh:prose-invert max-w-none">${i}</article>
      </div>
      ${R}
    </div>
  `},hr=(e,r,t="",a="",l={})=>{let n=xe(),i=r==="lore",h=i?e.uid:e.id,m=i?e.name||"\u65E0\u6807\u9898\u6761\u76EE":e.script_name||"\u672A\u547D\u540D\u6B63\u5219",b=e.source==="card",p=l.collapseState??"expanded",f=l.isExpanded??!1,w=(l.enableDrag??!0)&&!b,E=w&&o.isDragSortDisabled,T=E?"\u62D6\u62FD\u529F\u80FD\u4E0D\u53EF\u7528\uFF1A\u6392\u5E8F\u811A\u672C\u672A\u52A0\u8F7D":"\u62D6\u62FD\u6392\u5E8F",A=E?' data-disabled="true" aria-disabled="true" style="cursor: not-allowed; opacity: 0.6;"':"",s=w?`<span class="rlh-drag-handle${E?" rlh-drag-handle--disabled":""}" title="${D(T)}"${A}><i class="fa-solid fa-grip-vertical"></i></span>`:"",g=l.selectionKey??(i?Kr(t,h):Vr(h)),x=o.multiSelectTarget,R=o.multiSelectMode&&(x==="entry"&&i||x==="regex"&&!i),I=R&&o.selectedItems.has(g),S="";i?S=`
      <button class="rlh-action-btn-icon rlh-btn-secondary rlh-rename-btn" title="\u91CD\u547D\u540D\u5E76\u7F16\u8F91"><i class="fa-solid fa-pencil"></i></button>
      <button class="rlh-toggle-btn rlh-btn-secondary rlh-item-toggle" title="\u542F\u7528/\u7981\u7528\u6B64\u6761\u76EE"><i class="fa-solid fa-power-off"></i></button>
      <button class="rlh-action-btn-icon rlh-btn-danger rlh-delete-entry-btn" title="\u5220\u9664\u6761\u76EE"><i class="fa-solid fa-trash-can"></i></button>
    `:b?S='<button class="rlh-toggle-btn rlh-btn-secondary rlh-item-toggle" title="\u542F\u7528/\u7981\u7528\u6B64\u6761\u76EE"><i class="fa-solid fa-power-off"></i></button>':S=`
      <button class="rlh-action-btn-icon rlh-btn-secondary rlh-rename-btn" title="\u91CD\u547D\u540D\u5E76\u7F16\u8F91"><i class="fa-solid fa-pencil"></i></button>
      <button class="rlh-toggle-btn rlh-btn-secondary rlh-item-toggle" title="\u542F\u7528/\u7981\u7528\u6B64\u6761\u76EE"><i class="fa-solid fa-power-off"></i></button>
    `;let K=R?`<label class="rlh-selection-control"><input type="checkbox" class="rlh-multi-select-checkbox" data-select-key="${D(g)}" ${I?"checked":""}></label>`:"",ce=b?"\u6B64\u6761\u76EE\u6765\u81EA\u89D2\u8272\u5361\uFF0C\u90E8\u5206\u64CD\u4F5C\u53D7\u9650":R?"\u70B9\u51FB\u9009\u62E9/\u53D6\u6D88\u9009\u62E9":"\u70B9\u51FB\u5C55\u5F00/\u7F16\u8F91",q=xr(m,a),Z=i?ht(e.statusId):null,W=i?pt(Z.id,{shortLabel:!0}):"",le=b?'<span class="rlh-source-badge" title="\u6B64\u6761\u76EE\u6765\u81EA\u89D2\u8272\u5361\uFF0C\u64CD\u4F5C\u80FD\u529B\u53D7\u9650"><i class="fa-solid fa-id-card"></i><span>\u6765\u81EA\u5361</span></span>':"",pe="";if(i){let k=(e.position??"before_character_definition").toString(),O=Xe.position?.[k]??"\u9ED8\u8BA4\u4F4D\u7F6E",L=D(O),C=Number(e.order),N=Number(e.display_index),H=Number.isFinite(C)?`#${C}`:Number.isFinite(N)?`#${N}`:"\u672A\u8BBE\u7F6E",z=D(H);pe=`
          <div class="rlh-item-meta" title="\u63D2\u5165\u4E0E\u987A\u5E8F\u4FE1\u606F">
            <span class="rlh-item-meta-chip"><i class="fa-solid fa-map-pin"></i>\u63D2\u5165 ${L}</span>
            <span class="rlh-item-meta-chip"><i class="fa-solid fa-list-ol"></i>\u987A\u5E8F ${z}</span>
          </div>
        `}else{let k=e?.destination??{},O=e?.source??{},L=e?.min_depth,C=e?.max_depth,N=[];k.display&&N.push("\u683C\u5F0F\u663E\u793A"),k.prompt&&N.push("\u683C\u5F0F\u63D0\u793A\u8BCD");let H=N.length>0?N.join("/"):"\u9ED8\u8BA4\u8F93\u51FA",J=Object.entries({user_input:"\u7528\u6237\u8F93\u5165",ai_output:"AI\u8F93\u51FA",slash_command:"\u659C\u6760\u547D\u4EE4",world_info:"\u4E16\u754C\u4E66"}).filter(([te])=>!!O?.[te]).map(([,te])=>te),M;J.length===0?M="\u672A\u8BBE\u8303\u56F4":J.length===4?M="\u5168\u90E8\u6765\u6E90":M=J.length<=2?J.join("/"):`${J[0]}\u7B49${J.length}\u9879`;let j=L!=null&&L!=="",ee=C!=null&&C!=="",ae="\u65E0\u9650\u5236";j&&ee?ae=`${L} - ${C}`:j?ae=`\u2265 ${L}`:ee&&(ae=`\u2264 ${C}`),pe=`
      <div class="rlh-item-meta" title="\u4F5C\u7528\u8303\u56F4\u4E0E\u6267\u884C\u53C2\u6570">
        <span class="rlh-item-meta-chip"><i class="fa-solid fa-bullseye"></i>\u8303\u56F4: ${D(M)}</span>
        <span class="rlh-item-meta-chip"><i class="fa-solid fa-layer-group"></i>\u6DF1\u5EA6: ${D(ae)}</span>
        <span class="rlh-item-meta-chip"><i class="fa-solid fa-arrow-right"></i>\u8F93\u51FA: ${D(H)}</span>
      </div>
    `}let ue=w?` data-drag-enabled="${E?"false":"true"}"${E?' data-drag-disabled="true"':""}`:"",oe=n(`<div class="rlh-item-container ${b?"from-card":""}" data-type="${r}" data-id="${h}" ${i?`data-book-name="${D(t)}"`:""} data-select-key="${D(g)}"${i?` data-status-id="${Xr(Z.id)}"`:""}${ue}>
      <div class="rlh-item-header" title="${ce}">
        ${K}
        ${s}
        <div class="rlh-item-header-main">
          <div class="rlh-item-title-row">
            <span class="rlh-item-name">${q}</span>
            ${W}
            ${le}
          </div>
          ${pe}
        </div>
        <div class="rlh-item-controls">${S}</div>
      </div>
      <div class="rlh-collapsible-content"></div>
    </div>`);oe.data("searchTerm",a),oe.attr("data-search-term",typeof a=="string"?a:""),oe.toggleClass("enabled",e.enabled),oe.toggleClass("selected",I);let ie=oe.find(".rlh-collapsible-content"),u=l.initialMode;if(!u&&a&&(u="viewer"),f)oe.removeClass("rlh-collapsed"),ie.show(),oe.attr("data-entry-mode","edit");else if(u==="viewer"){let k=i?ut(e,a):Ht(e,a);ie.html(k),ie.show(),oe.removeClass("rlh-collapsed"),oe.attr("data-entry-mode","view")}else p==="collapsed"?(oe.addClass("rlh-collapsed"),ie.hide(),oe.attr("data-entry-mode",u??"collapsed")):(oe.removeClass("rlh-collapsed"),oe.attr("data-entry-mode",u??"collapsed"));return oe},No=(e,r)=>{let t=xe(),a=we(),l=t(".rlh-entry-list-wrapper",a);if(l.length>0){l.find(".rlh-info-text").remove();let n=hr(e,"lore",r,"",{isExpanded:!0,enableDrag:!1});return l.prepend(n),n}return null},bt=()=>{let e=xe(),r=we();e("#rlh-selection-count",r).text(`\u5DF2\u9009\u62E9: ${o.selectedItems.size}`)},mt=(e,r,t)=>{let a=xe(),l=we(),i=r!=null?Number(r):NaN,h=Number.isInteger(i),m=E=>{if(E==null)return!1;if(h){let T=Number(E);if(Number.isInteger(T))return T===i}return String(E)===String(r)},b=a('.rlh-item-container[data-type="lore"]',l).filter((E,T)=>{let A=a(T),s=A.data("book-name")??A.attr("data-book-name");if(String(s)!==String(e))return!1;let g=A.data("id");return m(g)?!0:m(A.attr("data-id"))}).first();if(!b.length)return;let p=ht(t),f=pt(p.id,{shortLabel:!0});b.attr("data-status-id",p.id);let v=b.find(".rlh-item-title-row").first();if(v.length){let E=v.find(".rlh-status-badge").first();E.length?E.replaceWith(f):v.append(f)}let w=b.find(".rlh-collapsible-content");if(w.length&&b.attr("data-entry-mode")==="view"){let T=ne(e).find(A=>Number(A?.uid)===numericId);if(T){let A=ut(T,b.data("searchTerm")??"");w.html(A)}}},Io=(e,r,t,a,l,n)=>{let i="",h="",m="",b=p=>Object.entries(p).filter(([,f])=>f>0).map(([f,v])=>`<li>- ${D(f)}\uFF1A<strong>${v}</strong> \u4E2A</li>`).join("");if(n?.type==="lorebook"){let p=n?.bookNames?.length===1?`\u5F53\u524D\u4E16\u754C\u4E66\u300C${D(n.bookNames[0])}\u300D`:"\u5339\u914D\u5230\u7684\u4E16\u754C\u4E66",f=new Set(e.map(E=>E.bookName)).size+(t?.length??0),v=e.length;i=`
      <div class="rlh-replace-stats">
        <p>- \u5171\u5339\u914D\u5230 ${f} \u672C\u4E16\u754C\u4E66\uFF0C\u5176\u4E2D ${v} \u4E2A\u6761\u76EE\u5C06\u88AB\u4FEE\u6539\u3002</p>
        <p>- \u66FF\u6362\u8303\u56F4\uFF1A${p}</p>
        <p>- \u547D\u4E2D\u8BE6\u60C5\uFF1A</p>
        <ul>
          <li>- \u4E66\u540D\uFF1A<strong>${r.bookName}</strong> \u4E2A</li>
          <li>- \u6761\u76EE\u540D\uFF1A<strong>${r.entryName}</strong> \u4E2A</li>
          <li>- \u5173\u952E\u8BCD\uFF1A<strong>${r.keywords}</strong> \u4E2A</li>
          <li>- \u5185\u5BB9\uFF1A<strong>${r.content}</strong> \u4E2A</li>
        </ul>
      </div>
    `,h=`<ul class="rlh-confirm-entry-list">${e.map(({bookName:E,entry:T,matchedFields:A})=>{let s=[];A&&(A.entryName&&s.push("\u6761\u76EE\u540D"),A.keywords>0&&s.push("\u5173\u952E\u8BCD"),A.content&&s.push("\u5185\u5BB9"));let g=s.join("\u3001"),x=D(T.name||"\u65E0\u6807\u9898\u6761\u76EE"),R=g?`\uFF08${g}\uFF09`:"";return`<li class="rlh-confirm-entry-item">${D(E)}: ${x}${R}</li>`}).join("")}</ul>`,t&&t.length>0&&(m=`
        <hr>
        <h4>\u4EC5\u4E66\u540D\u5339\u914D (\u4E0D\u4F1A\u88AB\u66FF\u6362):</h4>
        <div class="rlh-confirm-scroll-list rlh-confirm-scroll-list--secondary">
          <ul class="rlh-confirm-entry-list">${t.map(T=>`<li class="rlh-confirm-entry-item">${D(T)}</li>`).join("")}</ul>
        </div>
      `)}else if(n==="regex"){let p={\u540D\u79F0\u5339\u914D:r.name,\u5185\u5BB9\u5339\u914D:r.content},f=b(p);f&&(i=`<div class="rlh-replace-stats"><h4>\u66FF\u6362\u7EDF\u8BA1\u6458\u8981\uFF1A</h4><ul>${f}</ul></div>`),h=`<ul class="rlh-confirm-entry-list">${e.map(v=>`<li class="rlh-confirm-entry-item">${D(v.script_name||"\u672A\u547D\u540D\u6B63\u5219")}</li>`).join("")}</ul>`}return`
    <div class="rlh-replace-confirm-modal">
      <p>\u786E\u5B9A\u8981\u5C06 <strong>"${D(a)}"</strong> \u66FF\u6362\u4E3A <strong>"${D(l)}"</strong> \u5417\uFF1F</p>
      <p>\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\u3002</p>
      <hr>
      ${i}
      <hr>
      <h4>\u5C06\u8981\u4FEE\u6539\u7684\u6761\u76EE\u5217\u8868\uFF1A</h4>
      <div class="rlh-confirm-scroll-list">
        ${h}
      </div>
      ${m}
    </div>
  `},gt=()=>{let e=xe(),r=we(),t=e("#regex-lore-hub-save-status",r);if(!t.length)return;let a=o.saveStatus,l="",n="";switch(a){case"saving":l='<i class="fa-solid fa-spinner fa-spin"></i> \u6B63\u5728\u4FDD\u5B58...',n="saving";break;case"retrying":l=`<i class="fa-solid fa-triangle-exclamation fa-fade"></i> \u81EA\u52A8\u4FDD\u5B58\u5931\u8D25\uFF0C\u6B63\u5728\u91CD\u8BD5... (${o.saveRetryAttempt}/3)`,n="retrying";break;case"success":l='<i class="fa-solid fa-check-circle"></i> \u6570\u636E\u5DF2\u4FDD\u5B58',n="success";break;case"failed":l='<i class="fa-solid fa-circle-xmark"></i> \u81EA\u52A8\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u8FDE\u63A5\u6216\u624B\u52A8\u4FDD\u5B58\u3002',n="failed";break;case"idle":default:l="",n="idle";break}t.html(l),t.attr("class",`rlh-save-status ${n}`)},Xl=(e,r)=>{let t=ne(e);if(!Array.isArray(t)||!t.length||!Array.isArray(r)||r.length!==t.length)return null;let a=new Map(t.map(n=>[String(n.uid??""),n])),l=[];return r.forEach(n=>{let i=String(n??"");a.has(i)&&(l.push(a.get(i)),a.delete(i))}),l.length?(a.forEach(n=>l.push(n)),l.forEach((n,i)=>{n.display_index=i,(n.order===void 0||n.order===null||Number.isNaN(Number(n.order)))&&(n.order=i)}),Oe(e,l),l):null},Ut=(e,r,t={})=>{let a=$e(),l=t.enabled??!1,n=!!e?.length,i=()=>{n&&(e.attr("data-drag-disabled","true"),e.find(".rlh-drag-disabled-tip").length||e.prepend('<p class="rlh-info-text-small rlh-drag-disabled-tip">\u62D6\u62FD\u6392\u5E8F\u529F\u80FD\u6682\u65F6\u4E0D\u53EF\u7528\u3002</p>'))};if(!l||!n){n&&(e.removeAttr("data-drag-disabled"),e.find(".rlh-drag-disabled-tip").remove());return}if(o.isDragSortDisabled){i();return}if(!a?.Sortable)return;let h=e[0];!h||e.find(".rlh-item-container").length<2||(e.removeAttr("data-drag-disabled"),e.find(".rlh-drag-disabled-tip").remove(),a.Sortable.create(h,{animation:150,handle:".rlh-drag-handle",ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",onEnd:B(async b=>{let{oldIndex:p,newIndex:f}=b;if(p===f)return;let v=Array.from(h.querySelectorAll(".rlh-item-container")).map(w=>w.getAttribute("data-id")).filter(Boolean);Xl(r,v)&&await pr()},"RegexLoreHub.Sortable")}))};var Ro=6,ur=null,De=null,Pt=()=>{if(!ur&&!De)return;let e=$e();if(ur){let{type:r,id:t}=ur;if(r==="idle"&&e?.cancelIdleCallback)e.cancelIdleCallback(t);else if(r==="raf"&&e?.cancelAnimationFrame)e.cancelAnimationFrame(t);else if(r==="timeout"){let a=e?.clearTimeout??(typeof clearTimeout=="function"?clearTimeout:null);a&&a(t)}ur=null}De&&(De.remove(),De=null)},zt=(e,r)=>{let t=Array.isArray(e)?[...e]:[];return r==="status"?t.sort((a,l)=>{let n=Number(l.enabled)-Number(a.enabled);return n!==0?n:(a.name||"").localeCompare(l.name||"","zh")}):t.sort((a,l)=>(a.name||"\u65E0\u6807\u9898\u6761\u76EE").localeCompare(l.name||"\u65E0\u6807\u9898\u6761\u76EE","zh"))},Jr=(e,r=!1,t={})=>{let a=[],l=[],n={bookName:0,entryName:0,keywords:0,content:0},i=typeof e=="string"?e:"";if(!i)return{matches:a,stats:n,booksMatchedByNameOnly:l};let{bookNames:h}=t,m=Array.isArray(h)?[...new Set(h.map(g=>typeof g=="string"?g.trim():"").filter(g=>!!g))]:[],b=Array.isArray(o.allLorebooks)?o.allLorebooks:[],p=m.length?b.filter(g=>m.includes(g.name)):b.slice();if(m.length){let g=new Set(p.map(x=>x.name));m.forEach(x=>{g.has(x)||p.push({name:x})})}let f=r?"":"i",v=new RegExp(i.replace(/[.*+?^${}()|[\/\\]/g,"\\$&"),f),w=new Set,E=new Set,T=new Set,A=new Set,s=new Set;for(let g of p){let x=g?.name??"";if(!x)continue;let R=ne(x),I=v.test(x),S=!1;I&&w.add(x);for(let K of R){let ce={bookName:!1,entryName:!1,keywords:0,content:!1},q=!1;if(v.test(K.name||"")&&(E.add(K.uid),ce.entryName=!0,q=!0),Array.isArray(K.keys)){let Z=K.keys.filter(W=>v.test(W)).length;Z>0&&(ce.keywords=Z,T.add(K.uid),q=!0)}v.test(K.content||"")&&(A.add(K.uid),ce.content=!0,q=!0),q&&(S=!0,s.has(K.uid)||(a.push({bookName:x,entry:K,matchedFields:ce}),s.add(K.uid)))}I&&!S&&l.push(x)}return n.bookName=w.size,n.entryName=E.size,n.keywords=T.size,n.content=A.size,{matches:a,stats:n,booksMatchedByNameOnly:l}},Ao=(e,r,t)=>{e.view==="global-lore-detail"?Ql(e,r,t):Jl(e,r,t)},Jl=(e,r,t)=>{Pt();let a=xe(),l=we(),n=$e(),i=typeof r=="string"?r:"",h=dr(e),m=[...o.allLorebooks];if(h==="status"?m.sort((s,g)=>{let x=Number(g.enabled)-Number(s.enabled);return x!==0?x:s.name.localeCompare(g.name,"zh")}):m.sort((s,g)=>s.name.localeCompare(g.name,"zh")),!m.length){t.html(`
      <div class="rlh-empty-state">
        <div class="rlh-empty-icon"><i class="fa-solid fa-book-bookmark"></i></div>
        <h4>\u6CA1\u6709\u4E16\u754C\u4E66</h4>
        <p>\u70B9\u51FB\u53F3\u4E0A\u89D2\u7684\u201C<i class="fa-solid fa-plus"></i>\u201D\u6309\u94AE\u6765\u521B\u5EFA\u4F60\u7684\u7B2C\u4E00\u4E2A\u4E16\u754C\u4E66\u5427\uFF01</p>
      </div>
    `);return}let b=i?m.filter(s=>o.searchFilters.bookName&&s.name.toLowerCase().includes(i)?!0:ne(s.name).some(R=>yr(R,i))):m;if(!b.length){t.html('<p class="rlh-info-text">\u672A\u627E\u5230\u5339\u914D\u7684\u4E16\u754C\u4E66\u3002</p>');return}t.empty();let p=b.length,f=p<=Ro?p:Math.min(Ro,Math.max(3,Math.ceil(p/5))),v=0;De=p>f?a('<p class="rlh-info-text-small" aria-live="polite"></p>'):null;let w=()=>{if(!De)return;let s=Math.min(v,p);De.text(`\u6B63\u5728\u52A0\u8F7D\u4E16\u754C\u4E66\u5217\u8868 (${s}/${p})\uFF0C\u8BF7\u7A0D\u5019...`).appendTo(t)},E=s=>{if(!s.length)return;let g=l&&typeof l.createDocumentFragment=="function"?l.createDocumentFragment():null;g?(s.forEach(x=>g.appendChild(x)),t.append(g)):s.forEach(x=>t.append(x))},T=()=>{let s=Math.min(v+f,p),g=[];for(let x=v;x<s;x++){let I=Co(b[x],r,!0,null).get(0);I&&g.push(I)}if(E(g),v=s,w(),v>=p&&De){let x=De;(n?.setTimeout??setTimeout)(()=>{De===x&&(x.remove(),De=null)},320)}},A=()=>{let s=()=>{ur=null,T(),v<p&&A()};n?.requestIdleCallback?ur={type:"idle",id:n.requestIdleCallback(s,{timeout:120})}:n?.requestAnimationFrame?ur={type:"raf",id:n.requestAnimationFrame(s)}:ur={type:"timeout",id:(n?.setTimeout??setTimeout)(s,16)}};T(),v<p?A():De&&(De.remove(),De=null)},Ql=(e,r,t)=>{Pt();let a=xe(),l=e?.activeBookName??o.activeBookName;if(!o.allLorebooks.find(w=>w.name===l)){t.html(`<p class="rlh-info-text">\u9519\u8BEF\uFF1A\u672A\u627E\u5230\u540D\u4E3A "${D(l)}" \u7684\u4E16\u754C\u4E66\u3002</p>`);return}if(o.loadingBookName===l){let w=`
        <div class="rlh-detail-view" data-book-name="${D(l)}">
          <header class="rlh-detail-header">
            <button class="rlh-action-btn-icon rlh-back-to-list-btn" title="\u8FD4\u56DE\u4E16\u754C\u4E66\u5217\u8868"><i class="fa-solid fa-arrow-left"></i></button>
            <h2>${D(l)}</h2>
            <div class="rlh-item-controls">
              <button class="rlh-toolbar-btn rlh-rename-book-btn" title="\u91CD\u547D\u540D\u4E16\u754C\u4E66">\u91CD\u547D\u540D</button>
              <button class="rlh-toolbar-btn rlh-btn-danger rlh-delete-book-btn" title="\u5220\u9664\u4E16\u754C\u4E66">\u5220\u9664</button>
            </div>
          </header>
          <div class="rlh-detail-content">
            <p class="rlh-info-text">\u52A0\u8F7D\u4E2D...</p>
          </div>
        </div>
      `;t.html(w);return}t.append(`<div class="rlh-info-text-small">\u5F53\u524D\u4E16\u754C\u4E66\uFF1A${D(l)}</div>`);let i=dr(e),h=vr(e),m=zt(ne(l),i),b=`
        <div class="rlh-detail-view" data-book-name="${D(l)}">
          <header class="rlh-detail-header">
            <button class="rlh-action-btn-icon rlh-back-to-list-btn" title="\u8FD4\u56DE\u4E16\u754C\u4E66\u5217\u8868"><i class="fa-solid fa-arrow-left"></i></button>
            <h2>${D(l)}</h2>
            <div class="rlh-item-controls">
              <button class="rlh-toolbar-btn rlh-rename-book-btn" title="\u91CD\u547D\u540D\u4E16\u754C\u4E66">\u91CD\u547D\u540D</button>
              <button class="rlh-toolbar-btn rlh-btn-danger rlh-delete-book-btn" title="\u5220\u9664\u4E16\u754C\u4E66">\u5220\u9664</button>
            </div>
          </header>
          <div class="rlh-detail-content">
          </div>
        </div>
      `;t.html(b);let p=r?m.filter(w=>yr(w,r)):m,f=t.find(".rlh-detail-content");if(!p.length){let w=m.length?"\u65E0\u5339\u914D\u6761\u76EE":"\u8FD9\u672C\u4E66\u8FD8\u6CA1\u6709\u6761\u76EE\uFF0C\u70B9\u51FB\u5DE5\u5177\u680F\u7684\u201C\u65B0\u5EFA\u6761\u76EE\u201D\u6309\u94AE\uFF0C\u4E3A\u5B83\u6DFB\u52A0\u5185\u5BB9\u3002";f.html(`<p class="rlh-info-text">${w}</p>`);return}let v=`
    <p class="rlh-info-text-small">\u5171 ${m.length} \u4E2A\u6761\u76EE</p>
    <div class="rlh-entry-list-wrapper">
      ${p.map(w=>hr(w,"lore",l,r,{collapseState:h,enableDrag:!1}).prop("outerHTML")).join("")}
    </div>
  `;f.html(v)},Mo=(e,r,t)=>{let a=xe(),l=o.lorebooks.character,n=o.characterContext.name??"";if(!(o.characterContext.id!==null)){t.html('<p class="rlh-info-text">\u8BF7\u5148\u52A0\u8F7D\u4E00\u4E2A\u89D2\u8272\u4EE5\u7BA1\u7406\u89D2\u8272\u4E16\u754C\u4E66\u3002</p>');return}if(l.length===0){t.html('<p class="rlh-info-text">\u5F53\u524D\u89D2\u8272\u6CA1\u6709\u7ED1\u5B9A\u7684\u4E16\u754C\u4E66\u3002\u70B9\u51FB\u540C\u6B65\u6309\u94AE\u5237\u65B0\u3002</p>');return}let h=o.activeCharacterBook;(!h||!l.includes(h))&&(h=l[0],o.activeCharacterBook=h);let m=dr(e),b=vr(e);if(l.length>1){let v=l.map(w=>`<option value="${D(w)}"${w===h?" selected":""}>${D(w)}</option>`).join("");t.append(`<div class="rlh-book-switcher"><label>\u5F53\u524D\u89D2\u8272\u540D\uFF1A${D(n)}<select id="${ot}" class="rlh-input">${v}</select></label></div>`)}else t.append(`<div class="rlh-info-text-small">\u5F53\u524D\u89D2\u8272\u540D\uFF1A${D(n)}</div>`);let f=(v=>{let w=a(`<div class="rlh-book-group" data-book-name="${D(v)}">
        <div class="rlh-book-group-header">
          <h2 class="rlh-book-group-title">${D(v)}</h2>
          <div class="rlh-item-controls">
            <button class="rlh-toolbar-btn rlh-rename-book-btn" title="\u91CD\u547D\u540D\u4E16\u754C\u4E66">\u91CD\u547D\u540D</button>
            <button class="rlh-toolbar-btn rlh-btn-danger rlh-delete-book-btn" title="\u5220\u9664\u4E16\u754C\u4E66">\u5220\u9664</button>
          </div>
        </div>
        <div class="rlh-entry-list-wrapper"></div>
      </div>`),E=w.find(".rlh-entry-list-wrapper"),T=o.allLorebooks.find(S=>S.name===v);if(T&&!T.entriesLoaded)return T.loadingEntries||(T.loadingEntries=!0,Ie(v).finally(()=>{T.loadingEntries=!1,se()})),E.append('<p class="rlh-info-text">\u52A0\u8F7D\u4E2D...</p>'),w;let A=[...ne(v)].sort((S,K)=>(S.display_index??Number.MAX_SAFE_INTEGER)-(K.display_index??Number.MAX_SAFE_INTEGER)),s=zt(A,m),g=!r||o.searchFilters.bookName&&v.toLowerCase().includes(r),x=r?s.filter(S=>yr(S,r)):s,R=g&&!r?s:x,I=!1;return R.length?R.forEach(S=>{E.append(hr(S,"lore",v,r,{collapseState:b,enableDrag:I}))}):r?E.append('<p class="rlh-info-text-small">\u65E0\u5339\u914D\u6761\u76EE</p>'):E.append('<p class="rlh-info-text-small">\u8FD9\u672C\u4E16\u754C\u4E66\u6682\u65F6\u6CA1\u6709\u6761\u76EE\u3002</p>'),Ut(E,v,{enabled:I}),w})(h);f?(f.attr("data-active","true"),t.append(f)):r?t.append('<p class="rlh-info-text">\u672A\u627E\u5230\u5339\u914D\u7684\u6761\u76EE\u3002</p>'):t.append('<p class="rlh-info-text">\u672A\u80FD\u52A0\u8F7D\u5F53\u524D\u4E16\u754C\u4E66\uFF0C\u8BF7\u5C1D\u8BD5\u5237\u65B0\u6570\u636E\u3002</p>')};var Bo=(e,r,t)=>{let a=xe(),l=o.chatLorebook,n=$e(),i=o.characterContext.name??"";if(!(n.SillyTavern?.getContext?.()?.chatId!==null)){t.html('<p class="rlh-info-text">\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A\u804A\u5929\u4EE5\u7BA1\u7406\u804A\u5929\u4E16\u754C\u4E66\u3002</p>');return}if(!l){t.html(`
      <div class="rlh-chat-lore-empty">
        <p class="rlh-info-text">\u5F53\u524D\u804A\u5929\u6CA1\u6709\u7ED1\u5B9A\u7684\u4E16\u754C\u4E66\u3002</p>
        <button class="rlh-action-btn rlh-btn-primary" id="rlh-create-chat-lore-btn"><i class="fa-solid fa-plus"></i> \u521B\u5EFA\u5E76\u7ED1\u5B9A\u804A\u5929\u4E16\u754C\u4E66</button>
      </div>
    `);return}t.append(`<div class="rlh-info-text-small">\u5F53\u524D\u804A\u5929\u89D2\u8272\u540D\uFF1A${D(i)}</div>`);let m=dr(e),b=vr(e),p=a(`<div class="rlh-book-group" data-book-name="${D(l)}">
      <div class="rlh-book-group-header">
        <h2 class="rlh-book-group-title">${D(l)} (\u804A\u5929\u4E13\u7528)</h2>
        <div class="rlh-item-controls">
          <button class="rlh-toolbar-btn rlh-rename-book-btn" title="\u91CD\u547D\u540D\u4E16\u754C\u4E66">\u91CD\u547D\u540D</button>
          <button class="rlh-toolbar-btn rlh-unlink-chat-lore-btn" title="\u89E3\u9664\u7ED1\u5B9A">\u89E3\u9664\u7ED1\u5B9A</button>
        </div>
      </div>
      <div class="rlh-entry-list-wrapper"></div>
    </div>`),f=p.find(".rlh-entry-list-wrapper"),v=o.allLorebooks.find(s=>s.name===l);if(v&&!v.entriesLoaded){v.loadingEntries||(v.loadingEntries=!0,Ie(l).finally(()=>{v.loadingEntries=!1,se()})),f.append('<p class="rlh-info-text">\u52A0\u8F7D\u4E2D...</p>'),t.append(p);return}let w=[...ne(l)].sort((s,g)=>(s.display_index??Number.MAX_SAFE_INTEGER)-(g.display_index??Number.MAX_SAFE_INTEGER)),E=zt(w,m),T=r?E.filter(s=>yr(s,r)):E,A=!1;if(T.length)T.forEach(s=>{f.append(hr(s,"lore",l,r,{collapseState:b,enableDrag:A}))});else{let s=E.length?"\u65E0\u5339\u914D\u6761\u76EE":"\u8FD9\u672C\u4E66\u8FD8\u6CA1\u6709\u6761\u76EE\u3002";f.append(`<p class="rlh-info-text-small">${s}</p>`)}Ut(f,l,{enabled:A}),t.append(p)},Oo=()=>Pt();var Zl=(e,r)=>{let t=Array.isArray(e)?[...e]:[];return r==="status"?t.sort((a,l)=>{let n=Number(l.enabled)-Number(a.enabled);return n!==0?n:(a.script_name||"").localeCompare(l.script_name||"","zh")}):r==="name"?t.sort((a,l)=>(a.script_name||"").localeCompare(l.script_name||"","zh")):t},Do=(e,r=!1)=>{let t=[],a={name:0,content:0};if(!e)return{matches:t,stats:a};let l=[...o.regexes.global,...o.regexes.character],n=r?"":"i",i=new RegExp(e.replace(/[.*+?^${}()|[\/\\]/g,"\\$&"),n),h=new Set,m=new Set,b=new Set;for(let p of l){let f=!1;i.test(p.script_name||"")&&(h.add(p.script_name),f=!0);let v=`${p.find_regex||""} ${p.replace_string||""}`;i.test(v)&&(m.add(p.script_name),f=!0),f&&!b.has(p.id)&&(t.push(p),b.add(p.id))}return a.name=h.size,a.content=m.size,{matches:t,stats:a}},ft=(e,r,t,a,l)=>{let n=xe(),i=$e(),h=dr(e),m=vr(e),b=Zl(r??[],h),p=l??(e.id==="char-regex"?"\u89D2\u8272\u6B63\u5219":"\u5168\u5C40\u6B63\u5219");if(e.id==="char-regex"){let s=i.SillyTavern?.getContext?.()||{};if(!(s.characterId!==void 0&&s.characterId!==null)){a.html('<p class="rlh-info-text">\u8BF7\u5148\u52A0\u8F7D\u4E00\u4E2A\u89D2\u8272\u4EE5\u7BA1\u7406\u89D2\u8272\u6B63\u5219\u3002</p>');return}}if(!b.length){a.html(`<p class="rlh-info-text">\u6CA1\u6709${p}\u3002\u70B9\u51FB\u540C\u6B65\u6309\u94AE\u5237\u65B0\u3002</p>`);return}let f=t?b.filter(s=>Lo(s,t)):b;if(!f.length){a.html(`<p class="rlh-info-text">\u6CA1\u6709\u5339\u914D\u7684${p}\u3002</p>`);return}let v=`rlh-regex-list-${e.id}`,w=n(`<div id="${v}" class="rlh-regex-list"></div>`);a.append(w);let E=!t;f.forEach((s,g)=>{let x=hr(s,"regex","",t,{collapseState:m,enableDrag:E});x.find(".rlh-item-name").prepend(`<span class="rlh-order-indicator">#${g+1}</span> `),w.append(x)});let T=w[0],A="rlh-drag-disabled-banner";if(a.find(`.${A}`).remove(),E&&o.isDragSortDisabled?(w.attr("data-drag-disabled","true"),a.prepend(`<p class="rlh-info-text-small ${A}">\u63D0\u793A\uFF1A\u62D6\u62FD\u6392\u5E8F\u529F\u80FD\u6682\u65F6\u4E0D\u53EF\u7528\uFF0C\u8BF7\u4F7F\u7528\u6309\u94AE\u8C03\u6574\u987A\u5E8F\u3002</p>`)):w.removeAttr("data-drag-disabled"),E&&!o.isDragSortDisabled&&T&&i.Sortable){let s=i.Sortable.create(T,{animation:150,handle:".rlh-drag-handle",forceFallback:!0,fallbackOnBody:!0,fallbackTolerance:6,delayOnTouchOnly:!0,touchStartThreshold:8,fallbackClass:"rlh-sorting-fallback",onStart:()=>{w.addClass("sorting-active")},onEnd:B(async g=>{w.removeClass("sorting-active");let{oldIndex:x,newIndex:R}=g;if(x===R)return;let I=e.id==="global-regex"?"global":"character",S=o.regexes[I];if(!Array.isArray(S))return;let[K]=S.splice(x,1);K&&(S.splice(R,0,K),er(S),o.pendingRegexUpdates instanceof Set||(o.pendingRegexUpdates=new Set),o.pendingRegexUpdates.add(I),await pr({silent:!0}),a.empty(),ft(e,S,t,a,l))},"RegexLoreHub.RegexSortable")})}};var ea=e=>e?.toString().trim().toLowerCase()??"",Ae=()=>{let e=o.activeTab,r=o.activeView,t={tab:e,view:r,id:`${e}`,instanceKey:`${e}`,activeBookName:o.activeBookName,type:"lore",scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u89C6\u56FE",replaceScopeLabel:"\u5728\u5F53\u524D\u89C6\u56FE\u4E2D\u66FF\u6362",searchPlaceholder:"\u641C\u7D22...",visibleFilters:["entryName","keywords","content"],filterLabels:Lr,defaultFilters:{entryName:!0,keywords:!0,content:!0},showReplace:!0,showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!1,showPositionMenu:!1,sortOptions:[],multiSelectTarget:"entry",supportsMultiSelect:!0,primaryAction:{visible:!1}};if(e==="global-lore"){if(r==="global-lore-detail"){let a=o.activeBookName??"";return{...t,id:"global-lore-detail",instanceKey:a?`global-lore-detail:${a}`:"global-lore-detail",activeBookName:a,scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u4E16\u754C\u4E66",replaceScopeLabel:"\u5728\u5F53\u524D\u4E16\u754C\u4E66\u4E2D\u66FF\u6362",searchPlaceholder:"\u641C\u7D22...",visibleFilters:["bookName","entryName","keywords","content"],defaultFilters:{bookName:!1,entryName:!0,keywords:!0,content:!0},showRecursion:!0,showFixKeywords:!0,showCollapseToggle:!0,showPositionMenu:!0,sortOptions:["status","name"],multiSelectTarget:"entry",primaryAction:{visible:!0,icon:"fa-file-circle-plus",label:"\u65B0\u5EFA\u6761\u76EE",title:"\u65B0\u5EFA\u6761\u76EE",scope:"entry"}}}return{...t,id:"global-lore-list",instanceKey:"global-lore-list",activeBookName:null,scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u5168\u90E8\u4E16\u754C\u4E66",replaceScopeLabel:"\u5728\u5339\u914D\u5230\u7684\u4E16\u754C\u4E66\u6216\u6761\u76EE\u4E2D\u66FF\u6362",visibleFilters:["bookName","entryName","keywords","content"],defaultFilters:{bookName:!0,entryName:!0,keywords:!0,content:!0},showReplace:!0,showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!1,showPositionMenu:!1,showCleanOrphanBooks:!0,sortOptions:["status","name"],multiSelectTarget:"book",primaryAction:{visible:!0,icon:"fa-plus",label:"\u65B0\u5EFA\u4E16\u754C\u4E66",title:"\u65B0\u5EFA\u4E16\u754C\u4E66",scope:"book"}}}if(e==="char-lore"){let a=o.activeCharacterBook;if(!a){let n=(Array.isArray(o.lorebooks?.character)?o.lorebooks.character:[]).find(i=>typeof i=="string"&&i.trim().length);n&&(a=n,o.activeCharacterBook=n)}return{...t,id:"char-lore",instanceKey:"char-lore",activeBookName:a,scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u4E16\u754C\u4E66",replaceScopeLabel:"\u5728\u5F53\u524D\u4E16\u754C\u4E66\u4E2D\u66FF\u6362",visibleFilters:["entryName","keywords","content"],defaultFilters:{bookName:!1,entryName:!0,keywords:!0,content:!0},showRecursion:!0,showFixKeywords:!0,showCollapseToggle:!0,showPositionMenu:!0,sortOptions:["status","name"],multiSelectTarget:"entry",primaryAction:{visible:!0,icon:"fa-file-circle-plus",label:"\u65B0\u5EFA\u6761\u76EE",title:"\u65B0\u5EFA\u6761\u76EE",scope:"entry"}}}return e==="chat-lore"?{...t,id:"chat-lore",instanceKey:"chat-lore",activeBookName:o.chatLorebook,scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u4E16\u754C\u4E66",replaceScopeLabel:"\u5728\u5F53\u524D\u4E16\u754C\u4E66\u4E2D\u66FF\u6362",visibleFilters:["entryName","keywords","content"],defaultFilters:{bookName:!1,entryName:!0,keywords:!0,content:!0},showRecursion:!0,showFixKeywords:!0,showCollapseToggle:!0,showPositionMenu:!0,sortOptions:["status","name"],multiSelectTarget:"entry",primaryAction:{visible:!0,icon:"fa-file-circle-plus",label:"\u65B0\u5EFA\u6761\u76EE",title:"\u65B0\u5EFA\u6761\u76EE",scope:"entry"}}:e==="global-regex"?{...t,id:"global-regex",instanceKey:"global-regex",type:"regex",scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u5168\u5C40\u6B63\u5219\u8868\u8FBE\u5F0F",replaceScopeLabel:"\u5728\u5168\u5C40\u6B63\u5219\u4E2D\u66FF\u6362",visibleFilters:["entryName","content"],filterLabels:{...Lr,...At},defaultFilters:{bookName:!1,entryName:!0,keywords:!1,content:!0},showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!0,showPositionMenu:!1,sortOptions:[],multiSelectTarget:"regex",supportsMultiSelect:!0,primaryAction:{visible:!1}}:e==="char-regex"?{...t,id:"char-regex",instanceKey:"char-regex",type:"regex",scopeLabel:"\u641C\u7D22\u8303\u56F4\uFF1A\u89D2\u8272\u6B63\u5219\u8868\u8FBE\u5F0F",replaceScopeLabel:"\u5728\u89D2\u8272\u6B63\u5219\u4E2D\u66FF\u6362",visibleFilters:["entryName","content"],filterLabels:{...Lr,...At},defaultFilters:{bookName:!1,entryName:!0,keywords:!1,content:!0},showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!0,showPositionMenu:!1,sortOptions:[],multiSelectTarget:"regex",supportsMultiSelect:!1,primaryAction:{visible:!1}}:{...t,id:"unknown",instanceKey:"unknown",supportsMultiSelect:!1}},ra=e=>{let r=e.id;r&&(o.searchFilterContextsInitialized.has(r)||((e.visibleFilters??[]).forEach(t=>{o.searchFilters[t]=!0}),o.searchFilterContextsInitialized.add(r)),(e.id==="char-lore"||e.id==="chat-lore")&&o.searchFilters.keywords===void 0&&(o.searchFilters.keywords=!0))},se=()=>{let e=xe(),r=we(),t=e(`#${ke}`,r),a=()=>{if(!t.length){let T=e([]);return{$toolbarRow:T,$toolbar:T,$replaceContainer:T,$content:T}}let p=t.find(".rlh-toolbar-shell").first();if(!p.length){let T=t.find(".rlh-tab-nav").first();p=e('<div class="rlh-toolbar-shell"></div>'),T.length?p.insertAfter(T):t.prepend(p)}let f=p.find(`#${Hr}`);f.length||(f=e(`<div id="${Hr}" class="rlh-toolbar-container"></div>`),p.append(f));let v=p.find(`#${Ur}`);v.length||(v=e(`<div id="${Ur}" class="rlh-replace-container"></div>`),p.append(v));let w=t.find(".rlh-content-pane").first();w.length||(w=e('<div class="rlh-content-pane"></div>'),w.insertAfter(p));let E=w.find(`#${ke}-content`);return E.length||(E=e(`<div id="${ke}-content"></div>`),w.append(E)),{$toolbarRow:p,$toolbar:f,$replaceContainer:v,$content:E}},l=ea(o.globalSearch.term??"");[["bookName","#rlh-filter-book-name"],["entryName","#rlh-filter-entry-name"],["keywords","#rlh-filter-keywords"],["content","#rlh-filter-content"]].forEach(([p,f])=>{let v=t.find(f);v.length&&(o.searchFilters[p]=v.is(":checked"))});let{$toolbar:i,$replaceContainer:h,$content:m}=a();i.empty(),h.empty(),m.empty();let b=Ae();if(ra(b),b.tab!=="global-lore"&&Oo(),!b.supportsMultiSelect&&o.multiSelectMode&&(o.multiSelectMode=!1,o.selectedItems.clear()),o.multiSelectMode?o.multiSelectTarget!==b.multiSelectTarget&&(o.multiSelectTarget=b.multiSelectTarget,o.selectedItems.clear()):o.multiSelectTarget=b.multiSelectTarget,t.toggleClass("rlh-multi-select-mode",o.multiSelectMode),To(b,{$toolbar:i,$replaceContainer:h}),gt(),bt(),o.isLoadingTabData){m.html('<p class="rlh-info-text">\u52A0\u8F7D\u4E2D...</p>');return}switch(b.tab){case"global-lore":Ao(b,l,m);break;case"char-lore":Mo(b,l,m);break;case"chat-lore":Bo(b,l,m);break;case"global-regex":ft(b,o.regexes.global,l,m,"\u5168\u5C40\u6B63\u5219");break;case"char-regex":ft(b,o.regexes.character,l,m,"\u89D2\u8272\u6B63\u5219");break;default:m.html('<p class="rlh-info-text">\u5F53\u524D\u89C6\u56FE\u672A\u5B9E\u73B0\u3002</p>');break}};var yt=Object.freeze({and_any:0,not_all:1,not_any:2,and_all:3}),xt=Object.freeze({0:"and_any",1:"not_all",2:"not_any",3:"and_all"}),ta=Object.freeze({system:0,user:1,assistant:2}),Ho=Object.freeze({0:"system",1:"user",2:"assistant"}),jt=Object.freeze({before_character_definition:{type:"before_character_definition"},after_character_definition:{type:"after_character_definition"},before_example_messages:{type:"before_example_messages"},after_example_messages:{type:"after_example_messages"},before_author_note:{type:"before_author_note"},after_author_note:{type:"after_author_note"},at_depth_as_system:{type:"at_depth",role:"system"},at_depth_as_assistant:{type:"at_depth",role:"assistant"},at_depth_as_user:{type:"at_depth",role:"user"}}),oa=Object.freeze({0:"before_character_definition",1:"after_character_definition",2:"before_author_note",3:"after_author_note",4:"at_depth_as_system",5:"before_example_messages",6:"after_example_messages"}),vt=Object.freeze({before_char:"before_character_definition",after_char:"after_character_definition",before_an:"before_author_note",after_an:"after_author_note",before_em:"before_example_messages",after_em:"after_example_messages",at_depth:"at_depth_as_system",depth_system:"at_depth_as_system",depth_character:"at_depth_as_assistant",depth_user:"at_depth_as_user"}),Fo="regexLoreHub",Wo="regexLoreHub.themeId",Go=B(async()=>{let e=null;try{let t=Se()?.extensionSettings;if(t&&typeof t=="object"){let a=t[Fo]??t.regexLoreHub??t.RegexLoreHub??null;if(a&&typeof a=="object"){let l=a.themeId??a.theme??a.theme_id??a.themeName;typeof l=="string"&&l.trim()&&(e=l.trim())}}}catch(r){console.warn("[RegexLoreHub] \u8BFB\u53D6 extensionSettings \u4E3B\u9898\u504F\u597D\u5931\u8D25\uFF1A",r)}if(!e)try{let t=$e()?.localStorage?.getItem(Wo);typeof t=="string"&&t.trim()&&(e=t.trim())}catch(r){console.warn("[RegexLoreHub] \u8BFB\u53D6 localStorage \u4E3B\u9898\u504F\u597D\u5931\u8D25\uFF1A",r)}return e??null},"RegexLoreHubThemeStorage"),Ko=B(async e=>{let r=typeof e=="string"?e.trim():"";if(!r)return!1;let t=!1;try{let a=Se(),l=a?.extensionSettings;if(l&&typeof l=="object"){let n=Fo,i=l[n]&&typeof l[n]=="object"?l[n]:l[n]={};i.themeId=r,t=!0,a?.builtin?.saveSettings&&await a.builtin.saveSettings()}}catch(a){console.warn("[RegexLoreHub] \u5199\u5165 extensionSettings \u4E3B\u9898\u504F\u597D\u5931\u8D25\uFF1A",a)}try{$e()?.localStorage?.setItem(Wo,r),t=!0}catch(a){console.warn("[RegexLoreHub] \u5199\u5165 localStorage \u4E3B\u9898\u504F\u597D\u5931\u8D25\uFF1A",a)}return t},"RegexLoreHubThemeStorage"),kr=e=>e?JSON.parse(JSON.stringify(e)):{},et=e=>Array.isArray(e)?e.map(r=>{if(typeof r=="string")return r.trim();if(r instanceof RegExp)return r.source;if(r&&typeof r=="object"){if(typeof r.pattern=="string")return r.pattern.trim();if(typeof r.source=="string")return r.source.trim()}if(r!=null&&typeof r.toString=="function"){let t=r.toString();return typeof t=="string"?t.trim():""}return""}).filter(Boolean):[],la=["order","displayIndex","display_index","sort_order","script_order"],er=(e=[])=>{!Array.isArray(e)||e.length===0||e.forEach((r,t)=>{!r||typeof r!="object"||r.source==="card"||(la.forEach(a=>{r[a]=t}),r?.position&&typeof r.position=="object"&&"order"in r.position&&(r.position.order=t))})},aa=e=>{if(!Array.isArray(e)||e.length===0)return e;let r=new Map([["global",[]],["character",[]]]);return e.forEach(t=>{if(!t||typeof t!="object"||t.source==="card")return;let a=t.scope==="character"?"character":"global";r.get(a).push(t)}),r.forEach(t=>er(t)),e},Zr=e=>{if(e===!0||e===!1)return e;if(e==null)return!1;if(typeof e=="string"){let r=e.trim().toLowerCase();return["1","true","yes","on"].includes(r)}return!!e},Ue=e=>{if(e===""||e===null||e===void 0)return null;let r=Number(e);return Number.isNaN(r)?null:r},Vo=e=>{if(e==null)return"and_any";if(typeof e=="number"&&!Number.isNaN(e))return xt[e]??xt[e.toString()]??"and_any";let r=e.toString().trim().toLowerCase();return yt[r]!==void 0?r:xt[r]!==void 0?xt[r]:"and_any"};var Rr=e=>{if(typeof e=="string"){let r=e.trim().toLowerCase();if(ta[r]!==void 0)return r}if(typeof e=="number"&&!Number.isNaN(e)){let r=Ho[e]??Ho[e.toString()];if(r)return r}return null},Gt=(e,r)=>{if(e==null)return"before_character_definition";if(typeof e=="object"&&e!==null){if(typeof e.type=="string"&&e.type){let t=(vt[e.type]??e.type).trim();if(t==="at_depth"||t==="at_depth_as_system"){let a=Rr(e.role??r)??"system";return a==="assistant"?"at_depth_as_assistant":a==="user"?"at_depth_as_user":"at_depth_as_system"}return t.startsWith("at_depth_as_"),t}if(typeof e.position=="number"&&!Number.isNaN(e.position))return Gt(e.position,e.role??r)}if(typeof e=="string"){let t=(vt[e]??e).trim();if(t==="at_depth"){let a=Rr(r)??"system";return a==="assistant"?"at_depth_as_assistant":a==="user"?"at_depth_as_user":"at_depth_as_system"}return t}if(typeof e=="number"&&!Number.isNaN(e)){if(e===4){let a=Rr(r)??"system";return a==="assistant"?"at_depth_as_assistant":a==="user"?"at_depth_as_user":"at_depth_as_system"}let t=oa[e];if(t)return t}return"before_character_definition"};var Yo=(e,{fallbackRole:r=null,fallbackDepth:t=null,fallbackOrder:a=null}={})=>{let l=Rr(r),n={type:"before_character_definition",role:null,depth:null,order:Ue(a),uiKey:"before_character_definition"},i=b=>{let p=Ue(b);p!==null&&(n.order=p)},h=b=>{let p=Ue(b);p!==null&&(n.depth=p)};if(i(a),h(t),e&&typeof e=="object"){if(typeof e.type=="string"&&e.type){let b=(vt[e.type]??e.type).trim();n.type=b==="at_depth_as_system"?"at_depth":b;let p=Rr(e.role)??l;return n.type==="at_depth"?(n.role=p??"system",h(e.depth),n.uiKey=n.role==="assistant"?"at_depth_as_assistant":n.role==="user"?"at_depth_as_user":"at_depth_as_system"):(n.role=null,n.depth=null,n.uiKey=n.type),i(e.order),n}if(typeof e.position=="number"&&!Number.isNaN(e.position)){let b=Rr(e.role)??l,p=Gt(e.position,b);return n.uiKey=p,p.startsWith("at_depth")?(n.type="at_depth",n.role=b??"system",h(e.depth)):(n.type=p,n.role=null,n.depth=null),i(e.order),n}}let m=Gt(e,l);return n.uiKey=m,m.startsWith("at_depth")?(n.type="at_depth",n.role=m==="at_depth_as_assistant"?"assistant":m==="at_depth_as_user"?"user":"system",n.depth===null&&(n.depth=Ue(t))):(n.type=m,n.role=null,n.depth=null),n},na=(e,{depth:r,order:t,basePosition:a}={})=>{let l=Yo(a??null),n=(vt[e]??e??l.uiKey).toString().trim()||l.uiKey||"before_character_definition",i=jt[n]??jt[l.uiKey]??jt.before_character_definition,h={type:i.type},m=Ue(t),b=m!==null?m:l.order!==null&&l.order!==void 0?l.order:0;if(h.order=b,i.type==="at_depth"){let p=i.role??l.role??"system";h.role=p;let f=Ue(r),v=f!==null?f:l.depth!==null&&l.depth!==void 0?l.depth:0;h.depth=v}return h},ar=e=>{if(!e||typeof e!="object")return e;let r=kr(e);(!r.strategy||typeof r.strategy!="object")&&(r.strategy={});let t=r.strategy,a=qe(Yt(r))??Re;t.type=a.strategyType,r.type=a.strategyType,r.statusId=a.id;let l=et(t.keys??r.keys??r.key??r.keywords);t.keys=[...l],r.keys=[...l],r.key=[...l],r.keywords=[...l];let n=et(t.keys_secondary?.keys??r.keysecondary??r.key_secondary??[]);(!t.keys_secondary||typeof t.keys_secondary!="object")&&(t.keys_secondary={logic:"and_any",keys:[]}),t.keys_secondary.keys=[...n],r.keysecondary=[...n];let i=Vo(t.keys_secondary.logic??r.logic??r.selectiveLogic);t.keys_secondary.logic=i,r.logic=i,r.selectiveLogic=yt[i];let h=Yo(r.position,{fallbackRole:r.role,fallbackDepth:r.depth,fallbackOrder:r.order??r.insertion_order??r.displayIndex});r.position=h.uiKey,r.depth=h.type==="at_depth"?h.depth??0:null,r.order=h.order??0,r.role=h.role;let m=Ue(r.probability);return r.probability=m===null?100:m,(!r.recursion||typeof r.recursion!="object")&&(r.recursion={prevent_incoming:!1,prevent_outgoing:!1,delay_until:null}),r.prevent_recursion=Zr(r.prevent_recursion??r.preventRecursion??r.recursion.prevent_outgoing),r.exclude_recursion=Zr(r.exclude_recursion??r.excludeRecursion??r.recursion.prevent_incoming),r.recursion.prevent_outgoing=r.prevent_recursion,r.recursion.prevent_incoming=r.exclude_recursion,r.case_sensitive=Zr(r.case_sensitive??r.caseSensitive??!1),r.caseSensitive=r.case_sensitive,r.match_whole_words=Zr(r.match_whole_words??r.matchWholeWords??!1),r.matchWholeWords=r.match_whole_words,r.enabled=r.disable!==void 0?!r.disable:r.enabled??!0,r},ia=(e,r={})=>{let t=kr(r),a=kr(e),l=qe(a.statusId??a.strategy?.type??a.type)??Re;(!t.strategy||typeof t.strategy!="object")&&(t.strategy={}),t.strategy.type=l.strategyType,t.type=l.strategyType,t.statusId=l.id,a.statusId=l.id,(!a.strategy||typeof a.strategy!="object")&&(a.strategy={}),a.strategy.type=l.strategyType,a.type=l.strategyType;let n=Ue(a.uid);n!==null&&(t.uid=n),a.name!==void 0&&(t.name=a.name),a.comment!==void 0&&(t.comment=a.comment),a.content!==void 0&&(t.content=a.content),(!t.strategy||typeof t.strategy!="object")&&(t.strategy={});let i=t.strategy,h=et(a.keys??i.keys??t.keys??t.key??t.keywords);i.keys=[...h],t.keys=[...h],t.key=[...h],t.keywords=[...h];let m=et(a.keysecondary??i.keys_secondary?.keys??t.keysecondary);(!i.keys_secondary||typeof i.keys_secondary!="object")&&(i.keys_secondary={logic:"and_any",keys:[]}),i.keys_secondary.keys=[...m],t.keysecondary=[...m];let b=Vo(a.logic??i.keys_secondary.logic??t.logic??t.selectiveLogic);i.keys_secondary.logic=b,t.logic=b,t.selectiveLogic=yt[b],a.enabled!==void 0&&(t.enabled=!!a.enabled,t.disable=!t.enabled);let p=Ue(a.probability);p!==null?(t.probability=p,t.useProbability=p!==100):t.probability!==void 0&&(t.useProbability=t.probability!==100);let f=Ue(a.order),v=Ue(a.depth),w=na(a.position??t.position,{depth:v,order:f,basePosition:t.position});t.position=w,w.type==="at_depth"?(t.depth=w.depth??0,t.role=w.role??"system"):(t.depth=null,t.role=null),w.order!==void 0&&(t.order=w.order,t.insertion_order=w.order,t.displayIndex=w.order),(!t.recursion||typeof t.recursion!="object")&&(t.recursion={prevent_incoming:!1,prevent_outgoing:!1,delay_until:null});let E=t.recursion;a.prevent_recursion!==void 0&&(E.prevent_outgoing=!!a.prevent_recursion),a.exclude_recursion!==void 0&&(E.prevent_incoming=!!a.exclude_recursion),t.preventRecursion=E.prevent_outgoing,t.prevent_recursion=E.prevent_outgoing,t.excludeRecursion=E.prevent_incoming,t.exclude_recursion=E.prevent_incoming;let T=(g,x)=>g===void 0?x:Zr(g),A=T(a.case_sensitive,t.caseSensitive??t.case_sensitive);A!==void 0&&(t.caseSensitive=A,t.case_sensitive=A);let s=T(a.match_whole_words,t.matchWholeWords??t.match_whole_words);return s!==void 0&&(t.matchWholeWords=s,t.match_whole_words=s),t},Ar=e=>{if(typeof e=="number"&&Number.isInteger(e))return e;let r=Number(e);return Number.isInteger(r)?r:null},Yt=e=>{if(!e||typeof e!="object")return st;let r=e?.strategy?.type??e?.type;return Gr(r)??st},Kt=e=>e&&typeof e=="object"?{uid:Ar(e.uid??e.id??e.entryUid??e.entry_id??null),tempUid:e.tempUid??e.temp_uid??null,name:e.name??""}:{uid:Ar(e),tempUid:null,name:""},Uo=(e,r={})=>{let t=Kt(e),a=Kt(r);return{uid:t.uid??a.uid??null,tempUid:e?.tempUid??e?.temp_uid??a.tempUid??null,name:e?.name??a.name??"",previousStatus:Yt(e??{})}},sa=e=>{let r=Kt(e);return{uid:r.uid,tempUid:r.tempUid,name:r.name,previousStatus:null}},Nr=(e,r={})=>({uid:e?.uid??null,tempUid:e?.tempUid??null,name:e?.name??"",previousStatus:e?.previousStatus??null,newStatus:r.newStatus??null,alreadyApplied:!!r.alreadyApplied,reason:r.reason??null,error:r.error??null}),Ir=Object.freeze({UNSAVED_ENTRY:"UNSAVED_ENTRY",DUPLICATE_SELECTION:"DUPLICATE_SELECTION",ENTRY_NOT_FOUND:"ENTRY_NOT_FOUND",API_ERROR:"API_ERROR",STATUS_NOT_APPLIED:"STATUS_NOT_APPLIED"}),ca=e=>et(e),Po=e=>{if(!e)return!1;let r=String(e?.message??e??"").toLowerCase();return r.includes("\u672A\u627E\u5230\u540D\u4E3A")||r.includes("character")&&r.includes("not found")},Y={createWorldbook:B(async e=>await Se().createWorldbook(e,[])),deleteWorldbook:B(async e=>await Se().deleteWorldbook(e)),getWorldbooks:B(async()=>await Se().getWorldbookNames()),getCharData:B(async()=>await Se().getCharData()),getRegexes:B(async()=>await Se().getTavernRegexes({scope:"all"})),replaceRegexes:B(async(e,r={})=>{let t=r?.scope??"all",a=Array.isArray(e)?e:[];aa(a),await Se().replaceTavernRegexes(a,{scope:t})}),getGlobalWorldbookNames:B(async()=>await Se().getGlobalWorldbookNames()),rebindGlobalWorldbooks:B(async e=>await Se().rebindGlobalWorldbooks(e)),getCharWorldbookNames:B(async e=>{try{let r=e?.name;return r?await Se().getCharWorldbookNames(r):(console.warn("[RegexLoreHub] getCharWorldbookNames \u8C03\u7528\u7F3A\u5C11\u89D2\u8272\u540D\u79F0\u3002"),null)}catch(r){if(Po(r))return console.warn("[RegexLoreHub] \u672A\u627E\u5230\u6307\u5B9A\u89D2\u8272\u5361\uFF0C\u8DF3\u8FC7\u89D2\u8272\u4E16\u754C\u4E66\u52A0\u8F7D\u3002",r),null;throw r}}),getCurrentCharWorldbookNames:B(async()=>{try{return await Se().getCharWorldbookNames("current")}catch(e){if(Po(e))return console.warn("[RegexLoreHub] \u672A\u627E\u5230\u5F53\u524D\u89D2\u8272\u5361\uFF0C\u8DF3\u8FC7\u89D2\u8272\u4E16\u754C\u4E66\u52A0\u8F7D\u3002",e),null;throw e}}),getChatWorldbookName:B(async()=>await Se().getChatWorldbookName("current")),getOrCreateChatWorldbook:B(async e=>await Se().getOrCreateChatWorldbook("current",e)),rebindChatWorldbook:B(async e=>await Se().rebindChatWorldbook("current",e)),getWorldbook:B(async e=>await Se().getWorldbook(e)),updateWorldbookWith:B(async(e,r)=>await Se().updateWorldbookWith(e,r)),replaceWorldbook:B(async(e,r)=>await Se().replaceWorldbook(e,r)),createWorldbookEntries:B(async(e,r)=>await Se().createWorldbookEntries(e,r)),deleteWorldbookEntries:B(async(e,r)=>{let t=new Set(r);return await Se().deleteWorldbookEntries(e,a=>t.has(a.uid))}),saveSettings:B(async()=>await Se().builtin.saveSettings()),rebindCharWorldbooks:B(async e=>await Se().rebindCharWorldbooks("current",e)),get Character(){return Se().Character}},Fe=B(async(e,r)=>{if(!Array.isArray(r)||r.length===0)return;let t=new Map,a=new Set;if(r.forEach(b=>{if(!b||typeof b!="object")return;let p=Ue(b.uid);if(p===null)return;a.add(p);let f=t.get(p)??{};t.set(p,{...f,...b})}),a.size===0)return;let l=ne(e),n=new Map(l.map(b=>[Ue(b?.uid),b]).filter(([b])=>b!==null)),i=b=>b.map(p=>{let f=Ue(p?.uid);if(f===null||!a.has(f))return p;let v=n.get(f);if(!v)return p;let w=kr(v),E=t.get(f);return E&&typeof E=="object"&&Object.entries(E).forEach(([T,A])=>{T==="uid"||T==="tempUid"||(Array.isArray(A)?w[T]=A.map(s=>typeof s=="object"&&s!==null?kr(s):s):A&&typeof A=="object"?w[T]=kr(A):w[T]=A)}),ia(w,p)}),h=await Y.updateWorldbookWith(e,i),m=Array.isArray(h)?h.map(ar):[];return Oe(e,m),wr(e),await Y.saveSettings(),h}),zo=(e,r,t,a,l)=>{let n=r.length,i=t.length,h=a.length,m=r.filter(v=>v.alreadyApplied).length,b=n-m,p=a.filter(v=>v.reason===Ir.UNSAVED_ENTRY).length,f="skipped";return n>0&&i===0?f="success":n>0&&i>0?f="partial":i>0&&(f="failed"),{status:f,successCount:n,failedCount:i,ignoredCount:h,alreadyAppliedCount:m,appliedCount:b,ignoredUnsavedCount:p,requestedCount:l,targetStatusId:e.id,targetStatusLabel:e.label}},qo=async(e,r,t,a={})=>{let l=Array.isArray(r)?r.filter(s=>s!=null):r!=null?[r]:[],n=l.length,i=qe(t);if(!i)return{ok:!1,targetStatusId:Gr(t),targetStatusLabel:"",targetStrategyType:null,success:[],failed:[],ignored:[],summary:{status:"failed",successCount:0,failedCount:0,ignoredCount:0,alreadyAppliedCount:0,appliedCount:0,ignoredUnsavedCount:0,requestedCount:n,targetStatusId:Gr(t),targetStatusLabel:""},errorCode:"INVALID_STATUS"};if(!e||typeof e!="string"){let s=Re;return{ok:!1,targetStatusId:s.id,targetStatusLabel:s.label,targetStrategyType:s.strategyType,success:[],failed:[],ignored:[],summary:zo(s,[],[],[],n),errorCode:"INVALID_BOOK_NAME"}}let h=ne(e),m=new Map(h.map(s=>[Ar(s?.uid),s])),b=new Set,p=[],f=[],v=[],w=[],E=new Map;l.forEach(s=>{let g=sa(s);if(g.uid===null){v.push(Nr(g,{reason:Ir.UNSAVED_ENTRY}));return}if(b.has(g.uid)){let S=m.get(g.uid),K=S?Uo(S,g):g;v.push(Nr(K,{reason:Ir.DUPLICATE_SELECTION}));return}b.add(g.uid);let x=m.get(g.uid);if(!x){f.push(Nr(g,{reason:Ir.ENTRY_NOT_FOUND}));return}let R=Uo(x,g);if(R.previousStatus===i.id){p.push(Nr(R,{newStatus:i.id,alreadyApplied:!0}));return}let I=kr(x.strategy??{});I.type=i.strategyType,w.push({uid:R.uid,statusId:i.id,strategy:I,type:i.strategyType}),E.set(R.uid,R)});let T;if(w.length>0&&(T=await Fe(e,w)),E.size>0){let s=ne(e),g=new Map(s.map(R=>[Ar(R?.uid),R])),x=w.length>0&&!Array.isArray(T);E.forEach(R=>{let I=g.get(R.uid),S=Yt(I);if(!I||S!==i.id){f.push(Nr(R,{reason:x?Ir.API_ERROR:Ir.STATUS_NOT_APPLIED}));return}p.push(Nr(R,{newStatus:i.id}))})}let A=zo(i,p,f,v,n);return{ok:A.status==="success",targetStatusId:i.id,targetStatusLabel:i.label,targetStrategyType:i.strategyType,targetToastLabel:i.toastLabel??i.label,success:p,failed:f,ignored:v,summary:A,options:a}};var da=e=>(o.pendingLorebookUpdates.has(e)||o.pendingLorebookUpdates.set(e,new Map),o.pendingLorebookUpdates.get(e)),qt=(e,r,t={})=>{if(!e||!t||typeof t!="object")return;let a=Ar(r),l=String(r),n=da(e),i=n.get(l)??{uid:a,tempUid:a==null?l:null,data:{}};a!=null&&(i.uid=a),(!i.data||typeof i.data!="object")&&(i.data={});let h={...t};Array.isArray(h.keys)&&(h.keys=ca(h.keys)),Object.entries(h).forEach(([m,b])=>{b!==void 0&&(i.data[m]=b)}),n.set(l,i)},Xo=e=>{e!=null&&o.pendingRegexUpdates.add(e)},ha=(e,r,t)=>{let a=Ar(t);if(!e||r==null||a==null)return;let l=o.pendingLorebookUpdates.get(e);if(!l||!(l instanceof Map))return;let n=String(r),i=l.get(n);if(!i)return;l.delete(n);let h=String(a),m=l.get(h)??{uid:a,tempUid:null,data:{}};m.uid=a,(!m.data||typeof m.data!="object")&&(m.data={}),i.data&&typeof i.data=="object"&&(m.data={...i.data,...m.data}),l.set(h,m)},Qr=null,pa=async()=>{let e=xe(),r=we(),t=$e(),a=Se(),l=e(`#${ke}-content`,r);rt();let i=(()=>{l.html(`
      <div class="rlh-loading">
        <div class="rlh-loading-spinner" aria-hidden="true"></div>
        <div class="rlh-loading-text">
          <p class="rlh-loading-title">\u6B63\u5728\u52A0\u8F7D\u6570\u636E...</p>
          <p class="rlh-loading-status">\u521D\u59CB\u5316...</p>
          <div class="rlh-loading-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div class="rlh-loading-bar-inner"></div>
          </div>
          <div class="rlh-loading-progress">0%</div>
          <p class="rlh-loading-detail"></p>
        </div>
      </div>
    `);let f=l.find(".rlh-loading-status"),v=l.find(".rlh-loading-detail"),w=l.find(".rlh-loading-progress"),E=l.find(".rlh-loading-bar-inner"),T=l.find(".rlh-loading-bar"),A=1,s=0,g=()=>{let x=Math.max(1,A),R=Math.min(s/x,1),I=Math.round(R*100);E.css("width",`${I}%`),T.attr("aria-valuenow",I),w.text(`${I}%`)};return g(),{setProgress(x,R,I,S){A=Math.max(1,R),s=Math.max(0,Math.min(x,A)),I&&f.text(I),S!==void 0&&v.text(S),g()},setStatus(x,R){x&&f.text(x),R!==void 0&&v.text(R)}}})(),h=4,m=0,b=(p,f)=>{m=Math.min(m+1,h),i.setProgress(m,h,p,f)};i.setProgress(m,h,"\u51C6\u5907\u52A0\u8F7D\u6570\u636E...","\u6B63\u5728\u68C0\u67E5\u8FD0\u884C\u73AF\u5883");try{if(!t.SillyTavern||!t.SillyTavern.getContext){console.warn("[RegexLoreHub] SillyTavern API not available, initializing with empty data"),o.regexes.global=[],o.regexes.character=[],o.allLorebooks=[],o.lorebooks.character=[],o.chatLorebook=null,Bt(),o.isDataLoaded=!0,se();return}b("\u83B7\u53D6\u57FA\u7840\u6570\u636E...","\u6B63\u5728\u5411 SillyTavern \u8BF7\u6C42\u6570\u636E");let p=t.SillyTavern?.getContext?.()||{},f=Array.isArray(p.characters)?p.characters:[],v=p.characterId!==void 0&&p.characterId!==null,w=p.chatId!==void 0&&p.chatId!==null,E=null,T=null,A=null,s=[Y.getRegexes().catch(()=>[]),Y.getGlobalWorldbookNames().catch(()=>[]),Y.getWorldbooks().catch(()=>[])];v?(s.push(Y.getCharData().catch(()=>null)),s.push(Y.getCurrentCharWorldbookNames().catch(()=>null))):s.push(Promise.resolve(null),Promise.resolve(null)),w?s.push(Y.getChatWorldbookName().catch(q=>(console.warn("[RegexLoreHub] Failed to get chat worldbook:",q),null))):s.push(Promise.resolve(null));let g=await Promise.allSettled(s);b("\u89E3\u6790\u6570\u636E\u7ED3\u6784...",`\u68C0\u6D4B\u5230 ${f.length} \u4E2A\u89D2\u8272\uFF0C\u6B63\u5728\u6574\u7406\u6570\u636E`);let x=g[0].status==="fulfilled"?g[0].value:[],R=g[1].status==="fulfilled"?g[1].value:[],I=g[2].status==="fulfilled"?g[2].value:[];E=g[3]?.status==="fulfilled"?g[3].value:null,T=g[4]?.status==="fulfilled"?g[4].value:null,A=g[5]?.status==="fulfilled"?g[5].value:null,rt({charData:E}),o.regexes.global=Array.isArray(x)?x.filter(q=>q.scope==="global"):[],er(o.regexes.global),tl(x,E),Bt(),o.pendingLorebookUpdates instanceof Map?o.pendingLorebookUpdates.clear():o.pendingLorebookUpdates=new Map,o.pendingRegexUpdates instanceof Set?o.pendingRegexUpdates.clear():o.pendingRegexUpdates=new Set,o.lorebookUsage.clear();let S=new Set(Array.isArray(I)?I:[]);if(Array.isArray(f)&&f.length>0)try{await Promise.all(f.map(async q=>{if(!(!q||!q.name))try{let Z=null;try{let W=a.getCharWorldbookNames(q.name);W&&typeof W.then=="function"?Z=await W:Z=W}catch(W){console.warn(`[RegexLoreHub] Error getting worldbooks for character "${q.name}":`,W),Z=null}if(Z&&typeof Z=="object"){let W=new Set;Z.primary&&typeof Z.primary=="string"&&W.add(Z.primary),Array.isArray(Z.additional)&&Z.additional.forEach(le=>typeof le=="string"&&W.add(le)),W.forEach(le=>{typeof le=="string"&&(o.lorebookUsage.has(le)||o.lorebookUsage.set(le,[]),o.lorebookUsage.get(le).push(q.name),S.add(le),console.log(`[RegexLoreHub] Character "${q.name}" uses worldbook "${le}"`))})}}catch(Z){console.warn(`[RegexLoreHub] Error processing character ${q.name}:`,Z)}}))}catch(q){console.warn("[RegexLoreHub] Error processing characters:",q)}let K=new Set(Array.isArray(R)?R:[]);o.allLorebooks=(Array.isArray(I)?I:[]).map(q=>({name:q,enabled:K.has(q),entryCount:0,enabledEntryCount:0,entriesLoaded:!1}));let ce=new Set;T&&typeof T=="object"&&(T.primary&&typeof T.primary=="string"&&ce.add(T.primary),Array.isArray(T.additional)&&T.additional.forEach(q=>typeof q=="string"&&ce.add(q))),o.lorebooks.character=Array.from(ce),o.chatLorebook=typeof A=="string"?A:null,typeof A=="string"&&S.add(A),b("\u6784\u5EFA\u7D22\u5F15...","\u4E16\u754C\u4E66\u5217\u8868\u5DF2\u52A0\u8F7D"),o.isDataLoaded=!0,b("\u6E32\u67D3\u754C\u9762...","\u6570\u636E\u52A0\u8F7D\u5B8C\u6210"),se(),ga()}catch(p){throw console.error("[RegexLoreHub] Error in loadAllData:",p),l.html(`
                <div class="rlh-error-wrapper">
                    <p class="rlh-error-title">
                        <i class="fa-solid fa-exclamation-triangle"></i> \u6570\u636E\u52A0\u8F7D\u5931\u8D25
                    </p>
                    <p class="rlh-error-text">
                        \u8BF7\u68C0\u67E5\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\uFF0C\u6216\u5C1D\u8BD5\u5237\u65B0\u9875\u9762\u3002
                    </p>
                    <button class="rlh-modal-btn rlh-error-retry-btn" onclick="$('#${Dr}').click()">
                        <i class="fa-solid fa-refresh"></i> \u91CD\u8BD5
                    </button>
                </div>
            `),p}},We=B(async(e=!1)=>{if(e)o.isDataLoaded=!1;else if(o.isDataLoaded)return;if(!(Qr&&(await Qr,!e))){Qr=pa();try{await Qr}finally{Qr=null}}}),Ft=!1,ua=3,jo=e=>new Promise(r=>setTimeout(r,e)),Jo=()=>{let e=xe(),r=we();if(!e||!r)return{};let t=e(`#${lt}`,r);if(!t.length)return{};let a=t.find(`#${at}`),l=t.find(`#${nt}`),n=t.find(".rlh-prefetch-bar");return{$indicator:t,$text:a,$bar:l,$barContainer:n}},Qo=e=>{let{$indicator:r,$bar:t,$barContainer:a}=Jo();r&&(r.attr("data-visible",e?"true":"false"),r.attr("aria-hidden",e?"false":"true"),e||(t?.length&&t.css("width","0%"),a?.length&&a.attr("aria-valuenow",0)))},Zo=(e,r)=>{let{$indicator:t,$text:a,$bar:l,$barContainer:n}=Jo();if(!t)return;let i=r>0?r:1,h=Math.min(e,r),m=Math.round(h/i*100),b=`\u52A0\u8F7D\u4E2D (${h}/${r})`;a?.length&&a.text(b),l?.length&&l.css("width",`${Math.min(m,100)}%`),n?.length&&n.attr("aria-valuenow",Math.min(m,100))},Vt=()=>{Qo(!1)},ba=e=>{let r=xe(),t=we();if(!r||!t)return;let a=r(`#${ke}`,t);if(!a.length)return;let l=a.find(".rlh-book-group").filter((i,h)=>r(h).data("book-name")===e);if(!l.length)return;let n=o.allLorebooks.find(i=>i.name===e);n&&l.find(".rlh-book-stats").text(`\u6761\u76EE: ${n.enabledEntryCount} / ${n.entryCount}`)},ma=e=>{if(e<=0){Vt();return}Qo(!0),Zo(0,e)},ga=B(async()=>{if(Ft)return;let e=o.allLorebooks.filter(r=>!r.entriesLoaded);if(e.length===0){Vt();return}Ft=!0,ma(e.length);try{let r=0,t=[...e],a=async()=>{for(;t.length>0;){let n=t.shift();if(!n)break;try{await Ie(n.name),ba(n.name)}finally{r+=1,Zo(r,e.length)}await jo(30)}},l=Math.min(ua,t.length);await Promise.all(Array.from({length:l},()=>a()))}finally{await jo(260),Vt(),Ft=!1}}),el=()=>{let e=Array.isArray(o.allLorebooks)?o.allLorebooks:[],r=new Map,t=new Set,a=0;return e.forEach(l=>{let n=wo(l);n.name&&(a+=1,r.set(n.name,n),n.bindingCount===0&&t.add(n.name))}),{totalBooks:a,unboundNames:t,statsByName:r}},rl=B(async()=>{let r=$e().SillyTavern?.getContext?.()||{},t=r.chatId!==void 0&&r.chatId!==null,a=[Y.getCharData(),Y.getCurrentCharWorldbookNames(),Y.getRegexes()];t?a.push(Y.getChatWorldbookName().catch(b=>(console.warn("[RegexLoreHub] Failed to get chat worldbook in refreshCharacterData:",b),null))):a.push(Promise.resolve(null));let[l,n,i,h]=await Promise.all(a);tl(i,l),rt({charData:l}),fa(n),o.chatLorebook=h;let m=o.lorebooks.character.filter(b=>!Ot(b));m.length>0&&await Promise.all(m.map(async b=>{let p=await Y.getWorldbook(b);Oe(b,p.map(ar))}))});function tl(e,r){let t=e?.filter(i=>i.scope==="character")||[],a=[];if(r&&Y.Character)try{a=(new Y.Character(r).getRegexScripts()||[]).map((h,m)=>({id:h.id||`card-${Date.now()}-${m}`,script_name:h.scriptName||"\u672A\u547D\u540D\u5361\u5185\u6B63\u5219",find_regex:h.findRegex,replace_string:h.replaceString,enabled:!h.disabled,scope:"character",source:"card"}))}catch(i){console.warn("\u65E0\u6CD5\u89E3\u6790\u89D2\u8272\u5361\u6B63\u5219\u811A\u672C:",i)}let l=new Set(t.map(i=>`${i.script_name}::${i.find_regex}::${i.replace_string}`)),n=a.filter(i=>{let h=`${i.script_name}::${i.find_regex}::${i.replace_string}`;return!l.has(h)});o.regexes.character=[...t,...n],er(o.regexes.character)}function fa(e){let r=[];e&&(e.primary&&r.push(e.primary),e.additional&&r.push(...e.additional)),o.lorebooks.character=[...new Set(r)]}var wr=e=>{let r=ne(e),t=o.allLorebooks.find(a=>a.name===e);t&&(t.entryCount=r.length,t.enabledEntryCount=r.filter(a=>a.enabled).length)},ol=e=>{let r={uid:`temp-${Date.now()}`,name:"\u65B0\u6761\u76EE",comment:"",content:"",keys:[],key:[],keysecondary:[],statusId:st,enabled:!0,disable:!1,is_temp:!0,selective:!0,selectiveLogic:yt.and_any,logic:"and_any",constant:!1,position:"before_character_definition",depth:null,order:0,probability:100,useProbability:!1,case_sensitive:!1,match_whole_words:!1,prevent_recursion:!1,exclude_recursion:!1,type:Re?.strategyType??"constant",strategy:{type:Re?.strategyType??"constant",keys:[],keys_secondary:{logic:"and_any",keys:[]},scan_depth:"same_as_global"}},t=ne(e);return t.unshift(r),Oe(e,t),r},ll=(e,r,t)=>{let a=ne(e),l=a.findIndex(n=>n.uid===r);if(l!==-1){let n=ar(t),i={...a[l],...n,is_temp:!1};a[l]=i,Oe(e,a),ha(e,r,i.uid)}else console.warn(`[RegexLoreHub] \u5728\u66F4\u65B0\u65F6\u627E\u4E0D\u5230\u4E34\u65F6\u6761\u76EE: ${r}`)},Ie=B(async(e,r=!1)=>{let t=o.allLorebooks.find(a=>a.name===e);if(!(!t||Ot(e)&&!r))try{let a=await Y.getWorldbook(e);a=a.map(ar),Oe(e,a),t.entriesLoaded=!0,wr(e)}catch(a){console.error(`[RegexLoreHub] Failed to load entries for worldbook "${e}":`,a),t.entriesLoaded=!0}}),pr=B(async(e={})=>{let{silent:r=!1}=e,t=3,a=3e3,l=0,n=p=>new Promise(f=>setTimeout(f,p)),i=()=>{r?gt():se()},h=async()=>{if(!(o.pendingLorebookUpdates instanceof Map))return o.pendingLorebookUpdates=new Map,!1;let p=!1;for(let[f,v]of[...o.pendingLorebookUpdates.entries()]){if(!(v instanceof Map)||v.size===0)continue;let w=[],E=[];for(let[A,s]of v.entries()){let g=s?.uid;if(typeof g!="number"||Number.isNaN(g))continue;let x=s?.data;if(!x||Object.keys(x).length===0){E.push(A);continue}w.push({uid:g,...x}),E.push(A)}if(w.length===0){E.forEach(A=>v.delete(A)),v.size===0&&o.pendingLorebookUpdates.delete(f);continue}await Fe(f,w)&&(p=!0,E.forEach(A=>v.delete(A)),v.size===0&&o.pendingLorebookUpdates.delete(f))}return p},m=async()=>{if(!(o.pendingRegexUpdates instanceof Set))return o.pendingRegexUpdates=new Set,!1;if(o.pendingRegexUpdates.size===0)return!1;er(o.regexes.global),er(o.regexes.character);let p=[...o.regexes.global,...o.regexes.character];return await Y.replaceRegexes(p.filter(f=>f.source!=="card")),await Y.saveSettings(),o.pendingRegexUpdates.clear(),!0},b=async()=>{console.log("[RegexLoreHub] \u6267\u884C\u7EDF\u4E00\u4FDD\u5B58\u64CD\u4F5C...");let p=await h(),f=await m();return console.log(!p&&!f?"[RegexLoreHub] \u6CA1\u6709\u5F85\u4FDD\u5B58\u7684\u66F4\u6539\u3002":"[RegexLoreHub] \u4FDD\u5B58\u64CD\u4F5C\u5B8C\u6210\u3002"),!0};for(;l<t;)try{o.saveRetryAttempt=l+1,o.saveStatus=l===0?"saving":"retrying",i(),await b(),o.saveStatus="success",o.saveRetryAttempt=0,i(),await n(1500),o.saveStatus="idle",i(),console.log("[RegexLoreHub] \u6240\u6709\u66F4\u6539\u5DF2\u6210\u529F\u4FDD\u5B58\u3002");return}catch(p){if(l++,console.error(`[RegexLoreHub] \u4FDD\u5B58\u5931\u8D25\uFF0C\u5C1D\u8BD5\u6B21\u6570 ${l}/${t}:`,p),l>=t)throw o.saveStatus="failed",i(),console.error("[RegexLoreHub] \u6240\u6709\u91CD\u8BD5\u5747\u5931\u8D25\uFF0C\u5DF2\u505C\u6B62\u4FDD\u5B58\u3002"),new Error("\u81EA\u52A8\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u8FDE\u63A5\u6216\u624B\u52A8\u4FDD\u5B58\u3002");await n(a)}}),He=e=>{if(typeof e!="string")return null;let r=e.trim();return r.length>0?r:null},Wt=e=>!e||typeof e!="object"?null:He(e.name)||He(e.display_name)||He(e.title)||He(e.metadata?.name)||He(e.filename)||He(e.external_id),xa=e=>!e||typeof e!="object"?null:He(e.name)||He(e.char_name)||He(e.display_name)||He(e.metadata?.name)||He(e.data?.name)||He(e.data?.char_name)||He(e.data?.display_name),va=(e,r)=>{if(!e||r===void 0||r===null)return!1;let t=String(r);return[e.id,e.characterId,e.metadata?.characterId,e.metadata?.id,e.external_id,e.filename].map(l=>l==null?null:String(l)).some(l=>l&&l===t)},rt=({charData:e=null}={})=>{let t=$e().SillyTavern?.getContext?.()||{},a=Array.isArray(t.characters)?t.characters:[],l=t.characterId!==void 0&&t.characterId!==null?t.characterId:null,n=He(t.name)||Wt(t.character);if(!n&&l!==null){let i=a.find(h=>va(h,l));i&&(n=Wt(i))}!n&&e&&(n=xa(e)),!n&&a.length===1&&(n=Wt(a[0])),o.characterContext.name=n??null,o.characterContext.id=l,console.log("[RegexLoreHub] Context synced with appState:",o.characterContext)};function al(e={}){let r=e.$??xe(),t=e.parentDoc??we(),a=e.parentWin??$e(),l=async(s,{showLoading:g=!0}={})=>{let x=(s??"").toString().trim();if(!x)return;let R=o.loadingBookName;try{g&&(o.loadingBookName=x,se()),await Ie(x,!0)}finally{o.loadingBookName=R&&R!==x?R:null,se()}},n=B(async s=>{o.activeView="global-lore-detail",o.activeBookName=s,o.loadingBookName=s,se(),await Ie(s),o.loadingBookName=null,se()}),i=B(async()=>{o.activeView="global-lore-list",o.activeBookName=null,o.selectedItems.clear(),o.globalSearch={term:"",replace:""};let s=r("#rlh-global-search-input",t);s.length&&s.val(""),se()}),h=async(s,g,x,R={})=>{let I=o.lorebookUsage.get(s)||[];if(I.length===0)return;let S=a.SillyTavern.getContext(),K=S.characterId,ce=0,q=I.length,{currentAttempt:Z=1,totalAttempts:W=1}=R;x?.update?.(`\u6B63\u5728\u66F4\u65B0 ${q} \u4E2A\u5173\u8054\u89D2\u8272... (${ce}/${q})\uFF08\u5C1D\u8BD5 ${Z}/${W}\uFF09`);let le=[];try{for(let pe of I){try{let ue=a.Character?.findCharacterIndex?.(pe)??S.characters.findIndex(u=>u.name===pe);if(ue===-1){console.warn(`[RegexLoreHub] Character "${pe}" not found, skipping...`);continue}console.log(`[RegexLoreHub] Switching to character "${pe}" (index: ${ue})`),await S.selectCharacterById(ue);let oe=await Y.getCharWorldbookNames({name:pe});if(!oe){console.warn(`[RegexLoreHub] Failed to get worldbooks for character "${pe}"`),le.push({name:pe,error:new Error("\u65E0\u6CD5\u83B7\u53D6\u4E16\u754C\u4E66\u5217\u8868")});continue}console.log(`[RegexLoreHub] Current worldbooks for "${pe}":`,oe);let ie=!1;if(oe.primary===s&&(console.log(`[RegexLoreHub] Updating primary lorebook from "${s}" to "${g}"`),oe.primary=g,ie=!0),Array.isArray(oe.additional)){let u=oe.additional.indexOf(s);u>-1&&(console.log(`[RegexLoreHub] Updating additional lorebook at index ${u} from "${s}" to "${g}"`),oe.additional[u]=g,ie=!0)}ie?(console.log(`[RegexLoreHub] Saving updated lorebooks for "${pe}":`,oe),await Y.rebindCharWorldbooks(oe),console.log(`[RegexLoreHub] Successfully updated lorebooks for "${pe}"`)):console.log(`[RegexLoreHub] No updates needed for character "${pe}"`)}catch(ue){console.error(`[RegexLoreHub] Failed to update lorebook for character "${pe}":`,ue),le.push({name:pe,error:ue})}ce++,x?.update?.(`\u6B63\u5728\u66F4\u65B0 ${q} \u4E2A\u5173\u8054\u89D2\u8272... (${ce}/${q})\uFF08\u5C1D\u8BD5 ${Z}/${W}\uFF09`)}}finally{S.characterId!==K&&await S.selectCharacterById(K)}if(le.length>0){let pe=le.map(oe=>oe.name).join(", "),ue=new Error(`\u4EE5\u4E0B\u89D2\u8272\u7684\u4E16\u754C\u4E66\u7ED1\u5B9A\u672A\u6210\u529F\u66F4\u65B0\uFF1A${pe}`);throw ue.details=le,ue}},m=B(async s=>{s.stopPropagation();let x=r(s.currentTarget).closest(".rlh-book-group, .rlh-detail-view"),R=x.hasClass("rlh-detail-view"),I=x.data("book-name")||o.activeBookName;if(!I)return;let S;try{S=await Q({type:"prompt",title:"\u91CD\u547D\u540D\u4E16\u754C\u4E66",text:"\u8BF7\u8F93\u5165\u65B0\u7684\u4E16\u754C\u4E66\u540D\u79F0\uFF1A",value:I})}catch{return}if(S=S.trim(),!S||S===I)return;if(o.allLorebooks.some(M=>M.name===S)){await Q({type:"alert",title:"\u91CD\u547D\u540D\u5931\u8D25",text:"\u8BE5\u540D\u79F0\u7684\u4E16\u754C\u4E66\u5DF2\u5B58\u5728\uFF0C\u8BF7\u9009\u62E9\u5176\u4ED6\u540D\u79F0\u3002"});return}let K=o.lorebookUsage.get(I)||[],ce=o.chatLorebook===I,q=ce?1:0,Z=K.length+q;console.log(`[RegexLoreHub] Renaming lorebook "${I}" to "${S}", linked characters:`,K,"chat linked:",ce);let W=`\u6B64\u64CD\u4F5C\u5C06\u66F4\u65B0 ${Z} \u4E2A\u7ED1\u5B9A\u5173\u7CFB`;K.length>0&&(W+=`\uFF0C\u9700\u8981\u4E34\u65F6\u5207\u6362\u5230 ${K.length} \u4E2A\u5173\u8054\u89D2\u8272\u5361\u6765\u66F4\u65B0\u4E16\u754C\u4E66\u94FE\u63A5`),W+=`\uFF0C\u671F\u95F4\u8BF7\u52FF\u64CD\u4F5C\u3002

`,K.length>0&&(W+=`\u5173\u8054\u89D2\u8272\u5361\uFF1A${K.join(", ")}
`),ce&&(W+=`\u5173\u8054\u804A\u5929\uFF1A\u5F53\u524D\u804A\u5929
`),o.activeTab==="global-lore"&&(W+=`
\u26A0\uFE0F \u91CD\u8981\u63D0\u793A\uFF1A\u7531\u4E8ESillyTavern API\u9650\u5236\uFF0C\u65E0\u6CD5\u76F4\u63A5\u5217\u51FA\u6240\u6709*\u804A\u5929\u4E16\u754C\u4E66*\u7ED1\u5B9A\u3002\u5982\u679C\u6B64\u4E16\u754C\u4E66\u4E0E*\u804A\u5929*\u7ED1\u5B9A\uFF0C\u91CD\u547D\u540D\u540E\u9700\u8981\u624B\u52A8\u68C0\u67E5\u90A3\u4E9B\u804A\u5929\u7ED1\u5B9A\u72B6\u6001\u3002
`),W+=`
\u662F\u5426\u7EE7\u7EED\uFF1F`;try{await Q({type:"confirm",title:"\u786E\u8BA4\u91CD\u547D\u540D",text:W})}catch{return}let le={maxAttempts:3,delayMs:600},pe=M=>new Promise(j=>setTimeout(j,M)),ue=[],oe=(M,j)=>{let ee={id:`cleanup-${ue.length+1}`,description:M,action:j,status:"pending",lastError:null};return ue.push(ee),ee},ie=M=>M==="success"?"\u5DF2\u5B8C\u6210":M==="failed"?"\u5931\u8D25":M==="running"?"\u6267\u884C\u4E2D":"\u5F85\u6267\u884C",u=async(M=!1)=>{for(let j of ue)if(!(M&&j.status==="success"))try{j.status="running",await j.action(),j.status="success",j.lastError=null}catch(ee){j.status="failed",j.lastError=ee}},k=M=>{let j=ue.length?`<ul class="rlh-cleanup-task-list">${ue.map(ee=>`<li class="rlh-cleanup-task" data-task-id="${ee.id}" data-status="${ee.status}">
                  <span class="rlh-cleanup-task-title">${D(ee.description)}</span>
                  <span class="rlh-cleanup-task-status">${D(ie(ee.status))}</span>
                  ${ee.lastError?`<div class="rlh-cleanup-task-error">${D(ee.lastError.message??String(ee.lastError))}</div>`:""}
                </li>`).join("")}</ul>`:'<p class="rlh-cleanup-empty">\u6CA1\u6709\u9700\u8981\u6267\u884C\u7684\u6E05\u7406\u4EFB\u52A1\u3002</p>';return`
        <div class="rlh-cleanup-modal">
          <p class="rlh-cleanup-error">${D(M)}</p>
          ${j}
          ${ue.length?'<button type="button" class="rlh-modal-btn rlh-cleanup-retry">\u91CD\u8BD5\u6E05\u7406</button>':""}
          <p class="rlh-cleanup-hint">\u5982\u6E05\u7406\u591A\u6B21\u5931\u8D25\uFF0C\u8BF7\u67E5\u770B\u63A7\u5236\u53F0\u6216\u5728 SillyTavern \u4E2D\u624B\u52A8\u6062\u590D\u3002</p>
        </div>
      `},O=async M=>{let j=Q({type:"alert",title:"\u91CD\u547D\u540D\u5931\u8D25",html:k(M)});setTimeout(()=>{let ee=r(".rlh-modal-overlay",t).last();if(ee.length===0)return;let ae=()=>{ue.forEach(fe=>{let _e=ee.find(`[data-task-id="${fe.id}"]`);if(_e.length===0)return;_e.attr("data-status",fe.status),_e.find(".rlh-cleanup-task-status").text(ie(fe.status));let G=_e.find(".rlh-cleanup-task-error");fe.lastError?G.length?G.text(fe.lastError.message??String(fe.lastError)):_e.append(`<div class="rlh-cleanup-task-error">${D(fe.lastError.message??String(fe.lastError))}</div>`):G.length&&G.remove()})};ae();let te=ee.find(".rlh-cleanup-retry");te.length&&te.on("click",async fe=>{fe.preventDefault(),!te.prop("disabled")&&(te.prop("disabled",!0).text("\u6B63\u5728\u91CD\u8BD5..."),await u(!0),ae(),te.prop("disabled",!1).text("\u91CD\u8BD5\u6E05\u7406"))})},0),await j},L=async(M,{description:j,onAttempt:ee,onError:ae}={})=>{let te=0,fe;for(;te<le.maxAttempts;){te+=1,ee?.(te,le.maxAttempts);try{return await M(te,le.maxAttempts)}catch(_e){if(fe=_e,console.warn(`[RegexLoreHub] ${j} \u7B2C ${te} \u6B21\u5C1D\u8BD5\u5931\u8D25:`,_e),ae?.(_e,te,le.maxAttempts),te>=le.maxAttempts)break;await pe(le.delayMs)}}throw fe??new Error(`${j} \u5931\u8D25`)},C=lr("\u5F00\u59CB\u91CD\u547D\u540D..."),N=o.chatLorebook,H=null,z=!1,J=!1;try{if(C.update("\u6B63\u5728\u521B\u5EFA\u65B0\u4E16\u754C\u4E66..."),!await Y.createWorldbook(S))throw new Error("\u521B\u5EFA\u65B0\u4E16\u754C\u4E66\u6587\u4EF6\u5931\u8D25\u3002");oe(`\u5220\u9664\u65B0\u5EFA\u7684\u4E16\u754C\u4E66 "${S}"`,async()=>{if(!(await Y.getWorldbooks()??[]).includes(S))return;if(await Y.deleteWorldbook(S),(await Y.getWorldbooks()??[]).includes(S))throw new Error("\u65B0\u4E16\u754C\u4E66\u4ECD\u5B58\u5728\uFF0C\u5220\u9664\u5931\u8D25\u3002")});let j=[...ne(I)];if(j.length>0){let G=j.map(be=>{let de={...be};return delete de.uid,delete de.tempUid,delete de.temp_uid,de});await L(async()=>{await Y.replaceWorldbook(S,G);let be=await Y.getWorldbook(S),de=Array.isArray(be)?be.length:0;if(de!==G.length)throw new Error(`\u590D\u5236\u6761\u76EE\u6821\u9A8C\u5931\u8D25\uFF08\u671F\u671B ${G.length} \u6761\uFF0C\u5B9E\u9645 ${de} \u6761\uFF09\u3002`)},{description:"\u590D\u5236\u6761\u76EE",onAttempt:(be,de)=>{let Ge=be>1?`\uFF08\u5C1D\u8BD5 ${be}/${de}\uFF09`:"";C.update(`\u6B63\u5728\u590D\u5236\u6761\u76EE...${Ge}`)}})}K.length>0&&(await L(async(G,be)=>await h(I,S,C,{currentAttempt:G,totalAttempts:be}),{description:"\u66F4\u65B0\u89D2\u8272\u7ED1\u5B9A",onAttempt:(G,be)=>{let de=G>1?`\uFF08\u5C1D\u8BD5 ${G}/${be}\uFF09`:"";C.update(`\u6B63\u5728\u66F4\u65B0\u89D2\u8272\u7ED1\u5B9A...${de}`)}}),oe(`\u6062\u590D ${K.length} \u4E2A\u89D2\u8272\u7684\u4E16\u754C\u4E66\u7ED1\u5B9A`,async()=>{await h(S,I,null,{currentAttempt:1,totalAttempts:1})})),C.update("\u6B63\u5728\u66F4\u65B0\u5168\u5C40\u8BBE\u7F6E...");let ee=await Y.getGlobalWorldbookNames(),ae=Array.isArray(ee)&&ee.includes(I),te=null;if(ae&&(H=[...ee],te=H.map(G=>G===I?S:G),await L(async()=>{await Y.rebindGlobalWorldbooks(te);let G=await Y.getGlobalWorldbookNames();if(!Array.isArray(G)||!G.includes(S)||G.includes(I))throw new Error("\u5168\u5C40\u4E16\u754C\u4E66\u5217\u8868\u66F4\u65B0\u6821\u9A8C\u5931\u8D25\u3002")},{description:"\u66F4\u65B0\u5168\u5C40\u8BBE\u7F6E",onAttempt:(G,be)=>{let de=G>1?`\uFF08\u5C1D\u8BD5 ${G}/${be}\uFF09`:"";C.update(`\u6B63\u5728\u66F4\u65B0\u5168\u5C40\u8BBE\u7F6E...${de}`)}}),oe("\u56DE\u6EDA\u5168\u5C40\u4E16\u754C\u4E66\u7ED1\u5B9A",async()=>{if(!Array.isArray(H))return;await Y.rebindGlobalWorldbooks(H);let G=await Y.getGlobalWorldbookNames();if(!Array.isArray(G)||G.includes(S)||!G.includes(I))throw new Error("\u5168\u5C40\u4E16\u754C\u4E66\u56DE\u6EDA\u6821\u9A8C\u5931\u8D25\u3002")}),z=!0),ce&&(await L(async()=>{await Y.rebindChatWorldbook(S);let G=await Y.getChatWorldbookName();if(G!==S)throw new Error(`\u804A\u5929\u4E16\u754C\u4E66\u4ECD\u4E3A ${G??"\u672A\u7ED1\u5B9A"}`)},{description:"\u66F4\u65B0\u804A\u5929\u7ED1\u5B9A",onAttempt:(G,be)=>{let de=G>1?`\uFF08\u5C1D\u8BD5 ${G}/${be}\uFF09`:"";C.update(`\u6B63\u5728\u66F4\u65B0\u804A\u5929\u7ED1\u5B9A...${de}`)}}),o.chatLorebook=S,oe("\u6062\u590D\u804A\u5929\u4E16\u754C\u4E66\u7ED1\u5B9A",async()=>{await Y.rebindChatWorldbook(I);let G=await Y.getChatWorldbookName();if(G!==I)throw new Error(`\u804A\u5929\u4E16\u754C\u4E66\u4ECD\u4E3A ${G??"\u672A\u7ED1\u5B9A"}`);o.chatLorebook=I}),J=!0),C.update("\u6B63\u5728\u66F4\u65B0\u5185\u90E8\u6620\u5C04..."),o.lorebookUsage.has(I)){let G=o.lorebookUsage.get(I);o.lorebookUsage.delete(I),o.lorebookUsage.set(S,G),console.log(`[RegexLoreHub] Updated lorebookUsage mapping from "${I}" to "${S}"`)}await L(async()=>{if(await Y.deleteWorldbook(I),(await Y.getWorldbooks()??[]).includes(I))throw new Error("\u65E7\u4E16\u754C\u4E66\u4ECD\u5B58\u5728\uFF0C\u5220\u9664\u5931\u8D25\u3002")},{description:"\u5220\u9664\u65E7\u4E16\u754C\u4E66",onAttempt:(G,be)=>{let de=G>1?`\uFF08\u5C1D\u8BD5 ${G}/${be}\uFF09`:"";C.update(`\u6B63\u5728\u5220\u9664\u65E7\u4E16\u754C\u4E66...${de}`)}}),ue.length=0,C.update("\u6B63\u5728\u5237\u65B0\u6570\u636E...");let fe=o.chatLorebook;await We(!0),fe&&o.chatLorebook!==fe&&(console.log(`[RegexLoreHub] Restoring chat lorebook state after data refresh: "${fe}"`),o.chatLorebook=fe);let _e=o.allLorebooks.map(G=>G.name);if(_e.includes(S)||console.warn(`[RegexLoreHub] \u9A8C\u8BC1\u5931\u8D25\uFF1A\u5237\u65B0\u540E\u672A\u627E\u5230\u65B0\u4E16\u754C\u4E66 "${S}"\u3002`),_e.includes(I)&&console.warn(`[RegexLoreHub] \u9A8C\u8BC1\u5931\u8D25\uFF1A\u5237\u65B0\u540E\u65E7\u4E16\u754C\u4E66 "${I}" \u4ECD\u7136\u5B58\u5728\u3002`),z){let G=await Y.getGlobalWorldbookNames();(!Array.isArray(G)||!G.includes(S))&&console.warn(`[RegexLoreHub] \u9A8C\u8BC1\u5931\u8D25\uFF1A\u5168\u5C40\u4E16\u754C\u4E66\u672A\u5305\u542B "${S}"\u3002`,G),Array.isArray(G)&&G.includes(I)&&console.warn(`[RegexLoreHub] \u9A8C\u8BC1\u5931\u8D25\uFF1A\u5168\u5C40\u4E16\u754C\u4E66\u4ECD\u5305\u542B "${I}"\u3002`,G)}if(J)try{let G=await Y.getChatWorldbookName();G!==S&&(console.warn(`[RegexLoreHub] \u9A8C\u8BC1\u5931\u8D25\uFF1A\u804A\u5929\u4E16\u754C\u4E66\u672A\u66F4\u65B0\u4E3A "${S}"\uFF0C\u5F53\u524D\u503C "${G??"\u672A\u7ED1\u5B9A"}"\u3002`),o.chatLorebook=G)}catch(G){console.warn("[RegexLoreHub] \u9A8C\u8BC1\u804A\u5929\u4E16\u754C\u4E66\u72B6\u6001\u5931\u8D25:",G)}C.remove(),ve("\u4E16\u754C\u4E66\u91CD\u547D\u540D\u6210\u529F"),R?await n(S):se()}catch(M){C.remove(),console.error("[RegexLoreHub] Rename failed:",M),ue.length>0?(await u(),await O(M?.message??"\u91CD\u547D\u540D\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF\u3002")):await Q({type:"alert",title:"\u91CD\u547D\u540D\u5931\u8D25",text:`\u64CD\u4F5C\u5931\u8D25: ${M?.message??"\u672A\u77E5\u9519\u8BEF"}`}),await We(!0),N&&o.chatLorebook!==N&&(console.log(`[RegexLoreHub] Restoring chat lorebook state after error recovery: "${N}"`),o.chatLorebook=N);try{let j=a.SillyTavern.getContext()||{};if(j.chatId!==void 0&&j.chatId!==null){let ae=await Y.getChatWorldbookName();ae!==o.chatLorebook&&(console.log(`[RegexLoreHub] Final chat lorebook sync after error recovery: "${ae}"`),o.chatLorebook=ae)}}catch(j){console.warn("[RegexLoreHub] Failed to sync chat lorebook state after error recovery:",j)}}}),b=B(async(s,g="")=>{let x;try{x=await Q({type:"prompt",title:"\u65B0\u5EFA\u4E16\u754C\u4E66",text:"\u8BF7\u8F93\u5165\u65B0\u4E16\u754C\u4E66\u7684\u540D\u79F0:",value:g})}catch{return}if(x=x.trim(),!x)return;if(o.allLorebooks.some(I=>I.name===x))return await Q({type:"alert",title:"\u9519\u8BEF",text:"\u5DF2\u5B58\u5728\u540C\u540D\u4E16\u754C\u4E66\u3002"}),b(s,x);let R=s?r(s.currentTarget):null;R&&R.prop("disabled",!0).addClass("rlh-loading");try{await Y.createWorldbook(x)?(o.allLorebooks.push({name:x,enabled:!1,entryCount:0,enabledEntryCount:0,entriesLoaded:!0}),await n(x)):await Q({type:"alert",title:"\u521B\u5EFA\u5931\u8D25",text:"\u521B\u5EFA\u4E16\u754C\u4E66\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"})}finally{R&&R.prop("disabled",!1).removeClass("rlh-loading")}}),p=B(async s=>{s.stopPropagation();let x=r(s.currentTarget).closest(".rlh-book-group, .rlh-detail-view"),R=x.data("book-name")||o.activeBookName;if(!R)return;let I=x.hasClass("rlh-detail-view");try{await Q({type:"confirm",title:"\u786E\u8BA4\u5220\u9664",text:`\u60A8\u786E\u5B9A\u8981\u6C38\u4E45\u5220\u9664\u4E16\u754C\u4E66 "${R}" \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`,danger:!0})}catch{return}await Y.deleteWorldbook(R)?(o.allLorebooks=o.allLorebooks.filter(K=>K.name!==R),Yr(R),o.lorebookUsage instanceof Map&&o.lorebookUsage.has(R)&&o.lorebookUsage.delete(R),Array.isArray(o.lorebooks?.character)&&(o.lorebooks.character=o.lorebooks.character.filter(K=>K!==R)),o.chatLorebook===R&&(o.chatLorebook=null),o.activeCharacterBook===R&&(o.activeCharacterBook=null),o.activeBookName===R&&(o.activeBookName=null),I?await i():se(),ve("\u5220\u9664\u6210\u529F")):await Q({type:"alert",title:"\u5220\u9664\u5931\u8D25",text:"\u5220\u9664\u4E16\u754C\u4E66\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"})}),f=B(async s=>{let x=(r(s.currentTarget).data("book-name")??"").toString().trim(),R=Ae(),S=[x,R?.activeBookName??"",o.activeBookName??"",o.activeCharacterBook??"",o.chatLorebook??""].find(q=>typeof q=="string"&&q.trim().length>0)?.trim()??"";if(!S){await Q({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u9009\u62E9\u6216\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u3002"});return}let K=[...ne(S)];if((!K||K.length===0)&&(await Ie(S),K=[...ne(S)]),!K||K.length===0){await Q({type:"alert",title:"\u63D0\u793A",text:"\u8BE5\u4E16\u754C\u4E66\u6CA1\u6709\u6761\u76EE\u53EF\u64CD\u4F5C\u3002"});return}try{await Q({type:"confirm",title:"\u786E\u8BA4\u64CD\u4F5C",text:`\u786E\u5B9A\u8981\u4E3A "${S}" \u4E2D\u7684\u6240\u6709\u6761\u76EE\u5F00\u542F\u201C\u9632\u6B62\u9012\u5F52\u201D\u548C\u201C\u4E0D\u53EF\u88AB\u9012\u5F52\u201D\u5417\uFF1F\u6B64\u64CD\u4F5C\u4F1A\u963B\u6B62\u4E16\u754C\u4E66\u6761\u76EE\u5F7C\u6B64\u89E6\u53D1\u3002`})}catch{return}let ce=K.map(q=>({uid:q.uid,prevent_recursion:!0,exclude_recursion:!0}));await Fe(S,ce),K.forEach(q=>{q.prevent_recursion=!0,q.exclude_recursion=!0,(!q.recursion||typeof q.recursion!="object")&&(q.recursion={}),q.recursion.prevent_outgoing=!0,q.recursion.prevent_incoming=!0}),ce.forEach(q=>{let Z=r(`#rlh-panel-content .rlh-item-container[data-book-name="${S}"][data-id="${q.uid}"] .rlh-collapsible-content:visible`,t);Z.length&&(Z.find(".rlh-edit-prevent-recursion").prop("checked",!0),Z.find(".rlh-edit-exclude-recursion").prop("checked",!0))}),ve("\u5DF2\u4E3A\u6240\u6709\u6761\u76EE\u5F00\u542F\u201C\u9632\u6B62\u9012\u5F52\u201D\u548C\u201C\u4E0D\u53EF\u88AB\u9012\u5F52\u201D"),await l(S)}),v=B(async s=>{let x=(r(s.currentTarget).data("book-name")??"").toString().trim(),R=Ae(),S=[x,R?.activeBookName??"",o.activeBookName??"",o.activeCharacterBook??"",o.chatLorebook??""].find(Z=>typeof Z=="string"&&Z.trim().length>0)?.trim()??"";if(!S){await Q({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u9009\u62E9\u6216\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u3002"});return}let K=[...ne(S)];if((!K||K.length===0)&&(await Ie(S),K=[...ne(S)]),!K||K.length===0){await Q({type:"alert",title:"\u63D0\u793A",text:"\u8BE5\u4E16\u754C\u4E66\u6CA1\u6709\u6761\u76EE\u53EF\u64CD\u4F5C\u3002"});return}try{await Q({type:"confirm",title:"\u786E\u8BA4\u64CD\u4F5C",text:`\u786E\u5B9A\u8981\u4E3A "${S}" \u4E2D\u7684\u6240\u6709\u6761\u76EE\u4FEE\u590D\u5173\u952E\u8BCD\uFF08\u5C06\u4E2D\u6587\u9017\u53F7\u66FF\u6362\u4E3A\u82F1\u6587\u9017\u53F7\uFF09\u5417\uFF1F`})}catch{return}let ce=0,q=K.map(Z=>{let W=(Z.keys||[]).join(", "),pe=W.replace(//g,",").replace(/,+/g,",").trim().split(",").map(oe=>oe.trim()).filter(Boolean),ue=pe.join(", ");return W!==ue?(ce++,{uid:Z.uid,keys:pe}):null}).filter(Boolean);q.length>0?(await Fe(S,q),q.forEach(Z=>{let W=K.find(le=>le.uid===Z.uid);W&&(W.keys=Z.keys)}),q.forEach(Z=>{let W=r(`#rlh-panel-content .rlh-item-container[data-book-name="${S}"][data-id="${Z.uid}"] .rlh-collapsible-content:visible`,t);W.length&&W.find(".rlh-edit-keys").val(Z.keys.join(", "))}),ve(`\u6210\u529F\u4FEE\u590D\u4E86 ${ce} \u4E2A\u6761\u76EE\u7684\u5173\u952E\u8BCD`),await l(S)):await Q({type:"alert",title:"\u63D0\u793A",text:"\u6240\u6709\u6761\u76EE\u7684\u5173\u952E\u8BCD\u683C\u5F0F\u90FD\u6B63\u786E\uFF0C\u65E0\u9700\u4FEE\u590D\u3002"})}),w=B(async({bookName:s,positionValue:g})=>{let x=(g??"").toString().trim();if(!x)return;let R=Ae(),S=[s,R?.activeBookName??"",o.activeBookName??"",o.activeCharacterBook??"",o.chatLorebook??""].find(ie=>typeof ie=="string"&&ie.trim().length>0)?.trim()??"";if(!S){await Q({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u9009\u62E9\u6216\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u3002"});return}let K=[...ne(S)];if(K.length||(await Ie(S),K=[...ne(S)]),!K.length){await Q({type:"alert",title:"\u63D0\u793A",text:"\u8BE5\u4E16\u754C\u4E66\u6CA1\u6709\u6761\u76EE\u53EF\u64CD\u4F5C\u3002"});return}let ce=o.multiSelectMode&&o.multiSelectTarget==="entry",q=K;if(ce){let ie=fr(S),u=new Set;if(o.selectedItems.forEach(k=>{if(typeof k!="string"||!k.startsWith(ie))return;let O=k.slice(ie.length),L=ze(O),C=Number(L);Number.isFinite(C)&&u.add(C)}),u.size===0){await Q({type:"alert",title:"\u63D0\u793A",text:"\u5DF2\u5F00\u542F\u591A\u9009\uFF0C\u8BF7\u5148\u52FE\u9009\u8981\u7EDF\u4E00\u4F4D\u7F6E\u7684\u6761\u76EE\u3002"});return}if(q=K.filter(k=>u.has(Number(k?.uid))),!q.length){await Q({type:"alert",title:"\u63D0\u793A",text:"\u672A\u80FD\u5339\u914D\u5230\u5DF2\u9009\u62E9\u7684\u6761\u76EE\uFF0C\u8BF7\u91CD\u65B0\u9009\u62E9\u540E\u518D\u8BD5\u3002"});return}}let Z=Xe.position?.[x]??x,W=q.filter(ie=>(ie?.position??"").toString()!==x).map(ie=>({uid:ie.uid,position:x}));if(!W.length){await Q({type:"alert",title:"\u63D0\u793A",text:`${ce?"\u6240\u9009\u6761\u76EE":"\u6240\u6709\u6761\u76EE"}\u7684\u4F4D\u7F6E\u5DF2\u7ECF\u662F\u300C${Z}\u300D\u3002`});return}try{let ie=q.length,u=ce?"\u9009\u4E2D\u7684\u6761\u76EE":`"${S}" \u4E2D\u7684\u6761\u76EE`;await Q({type:"confirm",title:"\u786E\u8BA4\u64CD\u4F5C",text:`\u786E\u5B9A\u8981\u5C06 ${u}\uFF08\u5171 ${ie} \u4E2A\uFF09\u8BBE\u7F6E\u4E3A\u300C${Z}\u300D\u5417\uFF1F`})}catch{return}await Fe(S,W);let le=ne(S),pe=new Set(le.map(ie=>(ie?.position??"before_character_definition").toString())),ue=pe.size===1?pe.values().next().value:null;W.forEach(ie=>{let u=`#rlh-panel-content .rlh-item-container[data-book-name="${S}"][data-id="${ie.uid}"]`,k=r(u,t);if(k.length){let O=k.find(".rlh-edit-position");O.length&&O.val(x).trigger("change")}});let oe=r(`#${or}`,t);if(oe.length){oe.attr("data-book-name",S);let ie=r(`#${Qe}`,t);ie.length&&(ie.removeAttr("disabled"),ie.attr("data-book-name",S)),oe.find(".rlh-position-option").each(function(){let k=r(this),O=(k.data("position-value")??"").toString(),L=ue&&O===ue;k.toggleClass("active",L),k.attr("aria-selected",L?"true":"false"),k.attr("data-book-name",S)})}ve(`\u5DF2\u66F4\u65B0 ${W.length} \u4E2A\u6761\u76EE\u7684\u4F4D\u7F6E\u4E3A\u300C${Z}\u300D`),await l(S)}),E=B(async()=>{let s=await Y.getOrCreateChatWorldbook();s?(ve(`\u5DF2\u521B\u5EFA\u5E76\u7ED1\u5B9A\u804A\u5929\u4E16\u754C\u4E66: ${s}`),await We(!0)):await Q({type:"alert",title:"\u64CD\u4F5C\u5931\u8D25",text:"\u65E0\u6CD5\u521B\u5EFA\u6216\u7ED1\u5B9A\u804A\u5929\u4E16\u754C\u4E66\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"})}),T=B(async()=>{let s=o.chatLorebook;if(s){try{await Q({type:"confirm",title:"\u786E\u8BA4\u89E3\u9664\u7ED1\u5B9A",text:`\u60A8\u786E\u5B9A\u8981\u89E3\u9664\u4E0E\u804A\u5929\u4E16\u754C\u4E66 "${s}" \u7684\u7ED1\u5B9A\u5417\uFF1F\u4E16\u754C\u4E66\u672C\u8EAB\u4E0D\u4F1A\u88AB\u5220\u9664\u3002`})}catch{return}await Y.rebindChatWorldbook(null),o.chatLorebook=null,ve("\u5DF2\u89E3\u9664\u7ED1\u5B9A"),se()}}),A=B(async()=>{let s=o.activeBookName;s&&(o.loadingBookName=s,se(),await Ie(s,!0),o.loadingBookName=null,se())});return{handleEnterLorebookDetail:n,handleExitLorebookDetail:i,handleRefreshLorebookDetail:A,handleCreateLorebook:b,handleDeleteLorebook:p,handleRenameBook:m,handleBatchSetRecursion:f,handleFixKeywords:v,applyUnifiedPosition:w,handleCreateChatLorebook:E,handleUnlinkChatLorebook:T}}function nl(e={}){let r=e.$??xe(),t=e.parentDoc??we(),a=u=>{let k=String(u),O=o.regexes.global.find(L=>String(L.id)===k);return O||(o.regexes.character.find(L=>String(L.id)===k)??null)},l=(u,k,O)=>{if(!u||!k)return;let L=O;if(typeof L!="boolean"&&(L=L??""),k==="min_depth"||k==="max_depth"){let H=parseInt(L,10);L=Number.isNaN(H)?null:H}let C=k.split(".");if(C.length===1){u[C[0]]=L;return}let N=u;for(let H=0;H<C.length-1;H++){let z=C[H];(!N[z]||typeof N[z]!="object")&&(N[z]={}),N=N[z]}N[C[C.length-1]]=L},n=Dt(()=>pr({silent:!0}),1e3),i=B(async u=>{let k=r(u.currentTarget),O=k.closest(".rlh-item-container"),L=O.data("type"),C=O.data("id"),N=Number(C),H=k.data("field");if(H){if(L==="lore"){let z=O.data("book-name"),M=ne(z).find(ae=>{let te=ae?.uid;return typeof te=="number"&&!Number.isNaN(N)?te===N:String(te)===String(C)});if(!M)return;let j;if(k.is(":checkbox"))j=k.is(":checked");else if(k.is('[contenteditable="true"]')){let ae=k.get(0);if(ae){let te=new Set(["div","p","li","ul","ol","blockquote","pre","h1","h2","h3","h4","h5","h6","table","tr"]),fe=[],_e=de=>{de&&fe.push(de)},G=()=>{if(!fe.length){fe.push(`
`);return}fe[fe.length-1]?.endsWith(`
`)||fe.push(`
`)},be=de=>{if(!de)return;let Ge=de.nodeType;if(Ge===Node.TEXT_NODE){_e(de.nodeValue||"");return}if(Ge!==Node.ELEMENT_NODE)return;let Le=de.nodeName.toLowerCase();if(Le==="br"){fe.push(`
`);return}Le==="style"||Le==="script"||(de.childNodes.forEach(Ke=>be(Ke)),te.has(Le)&&G())};be(ae),j=fe.join(""),j=j.replace(/\u00a0/g," "),j=j.replace(/\r?\n/g,`
`)}else j=""}else j=k.val();if(H==="statusId"){let ae=qe(j)??Re;M.statusId=ae.id,(!M.strategy||typeof M.strategy!="object")&&(M.strategy={}),M.strategy.type=ae.strategyType,M.type=ae.strategyType,qt(z,M.uid??C,{statusId:ae.id,strategy:{...M.strategy??{},type:ae.strategyType},type:ae.strategyType}),mt(z,M.uid??C,ae.id),n();return}if(H==="keys")M.keys=j.split(",").map(ae=>ae.trim()).filter(Boolean);else if(["depth","order","probability"].includes(H)){let ae=parseInt(j,10);M[H]=isNaN(ae)?k.attr("placeholder")==="\u4F8B\u5982: 0"?null:100:ae}else M[H]=j;let ee=Array.isArray(M[H])?[...M[H]]:M[H];qt(z,M.uid??C,{[H]:ee})}else if(L==="regex"){let z=a(C);if(!z)return;let J;k.is(":checkbox")?J=k.is(":checked"):J=k.val(),l(z,H,J),Xo(z.id)}n()}}),h=u=>{let k=Object.entries(Xe.position).map(([J,M])=>`<option value="${J}" ${u.position===J?"selected":""}>${M}</option>`).join(""),O=Object.entries(Xe.logic).map(([J,M])=>`<option value="${J}" ${u.logic===J?"selected":""}>${M}</option>`).join(""),L=Array.isArray(u.keys)?u.keys.join(", "):"",C=u.content||"",N=u.statusId??Re.id;u.statusId=N;let H=qe(N)??Re;return(!u.strategy||typeof u.strategy!="object")&&(u.strategy={}),u.strategy.type=H.strategyType,u.type=H.strategyType,`
      <div class="rlh-editor-wrapper" data-mode="edit">
        <div class="rlh-editor-group"><h5>\u72B6\u6001</h5>
          <div class="rlh-editor-grid">
            <div class="rlh-grid-item"><label>\u6FC0\u6D3B\u72B6\u6001</label><select class="rlh-edit-status rlh-select-nudge" data-field="statusId">${it.map(J=>{let M=N===J.id?"selected":"";return`<option value="${J.id}" ${M}>${J.label}</option>`}).join("")}</select></div>
          </div>
        </div>
        <div class="rlh-editor-field">
          <label>\u5173\u952E\u8BCD (\u9017\u53F7\u5206\u9694)</label>
          <input type="text" class="rlh-edit-keys" data-field="keys" value="${D(L)}">
        </div>
        <div class="rlh-editor-field">
          <label>\u5185\u5BB9</label>
          <div class="rlh-edit-content" data-field="content" contenteditable="true">${D(C)}</div>
        </div>
        <div class="rlh-editor-group"><h5>\u63D2\u5165\u89C4\u5219</h5>
          <div class="rlh-editor-grid">
            <div class="rlh-grid-item"><label>\u4F4D\u7F6E</label><select class="rlh-edit-position rlh-select-nudge" data-field="position">${k}</select></div>
            <div class="rlh-grid-item rlh-depth-container"><label>\u6DF1\u5EA6</label><input type="number" class="rlh-edit-depth" data-field="depth" placeholder="\u4F8B\u5982: 0" value="${u.depth??""}"></div>
            <div class="rlh-grid-item"><label>\u987A\u5E8F</label><input type="number" class="rlh-edit-order" data-field="order" placeholder="\u4F8B\u5982: 100" value="${u.order??""}"></div>
          </div>
        </div>
        <div class="rlh-editor-group"><h5>\u6FC0\u6D3B\u903B\u8F91</h5>
          <div class="rlh-editor-grid">
            <div class="rlh-grid-item"><label>\u6982\u7387 (%)</label><input type="number" class="rlh-edit-probability" data-field="probability" min="0" max="100" placeholder="100" value="${u.probability??""}"></div>
            <div class="rlh-grid-item"><label>\u5173\u952E\u8BCD\u903B\u8F91</label><select class="rlh-edit-logic rlh-select-nudge" data-field="logic">${O}</select></div>
          </div>
        </div>
        <div class="rlh-editor-group"><h5>\u5339\u914D\u4E0E\u9012\u5F52</h5>
          <div class="rlh-editor-options-row">
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-case-sensitive" data-field="case_sensitive" ${u.case_sensitive?"checked":""}> \u5927\u5C0F\u5199\u654F\u611F</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-match-whole" data-field="match_whole_words" ${u.match_whole_words?"checked":""}> \u5168\u8BCD\u5339\u914D</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-prevent-recursion" data-field="prevent_recursion" ${u.prevent_recursion?"checked":""}> \u9632\u6B62\u9012\u5F52</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-exclude-recursion" data-field="exclude_recursion" ${u.exclude_recursion?"checked":""}> \u4E0D\u53EF\u88AB\u9012\u5F52</label>
          </div>
        </div>
      </div>
    `},m=u=>{let k=u?.destination??{},O=u?.source??{},L=D(u?.find_regex??""),C=D(u?.replace_string??""),N=D(String(u?.min_depth??"")),H=D(String(u?.max_depth??""));return`
      <div class="rlh-editor-wrapper" data-mode="edit">
        <div class="rlh-editor-field">
          <label>\u67E5\u627E\u6B63\u5219\u8868\u8FBE\u5F0F</label>
          <textarea class="rlh-edit-find" data-field="find_regex">${L}</textarea>
        </div>
        <div class="rlh-editor-field">
          <label>\u66FF\u6362\u4E3A</label>
          <textarea class="rlh-edit-replace" data-field="replace_string">${C}</textarea>
        </div>
        <div class="rlh-editor-group">
          <h5>\u77ED\u6682</h5>
          <div class="rlh-editor-options-row">
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-dest-display" data-field="destination.display" ${k.display?"checked":""}> \u4EC5\u683C\u5F0F\u663E\u793A</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-dest-prompt" data-field="destination.prompt" ${k.prompt?"checked":""}> \u4EC5\u683C\u5F0F\u63D0\u793A\u8BCD</label>
          </div>
        </div>
        <div class="rlh-editor-group">
          <h5>\u4F5C\u7528\u8303\u56F4</h5>
          <div class="rlh-editor-options-row">
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-src-user" data-field="source.user_input" ${O.user_input?"checked":""}> \u7528\u6237\u8F93\u5165</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-src-ai" data-field="source.ai_output" ${O.ai_output?"checked":""}> AI\u8F93\u51FA</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-src-slash" data-field="source.slash_command" ${O.slash_command?"checked":""}> \u659C\u6760\u547D\u4EE4</label>
            <label class="rlh-editor-option-item"><input type="checkbox" class="rlh-edit-src-world" data-field="source.world_info" ${O.world_info?"checked":""}> \u4E16\u754C\u4E66</label>
          </div>
        </div>
        <div class="rlh-editor-group">
          <h5>\u6DF1\u5EA6</h5>
          <div class="rlh-depth-inputs">
            <input type="number" class="rlh-edit-depth-min" data-field="min_depth" placeholder="\u6700\u5C0F\u6DF1\u5EA6" value="${N}">
            <input type="number" class="rlh-edit-depth-max" data-field="max_depth" placeholder="\u6700\u5927\u6DF1\u5EA6" value="${H}">
          </div>
        </div>
      </div>
    `},b=(u,k)=>{let O=u.find(".rlh-rename-btn").first();if(!O.length)return;let L=O.find("i").first();k==="edit"?(O.attr("title","\u9000\u51FA\u7F16\u8F91\u6A21\u5F0F"),O.attr("data-rename-mode","exit"),L.length&&L.removeClass("fa-pencil").addClass("fa-eye")):(O.attr("title","\u91CD\u547D\u540D\u5E76\u7F16\u8F91"),O.attr("data-rename-mode","rename"),L.length&&L.removeClass("fa-eye").addClass("fa-pencil"))},p=u=>{u.on("input.rlh change.rlh",'input, textarea, select, [contenteditable="true"]',i),u.find(".rlh-edit-position").trigger("change")},f=(u,k,O,{animate:L=!0,searchTerm:C}={})=>{let N=k.find(".rlh-collapsible-content").first();if(!N.length)return;let H=u==="view",z=typeof C=="string"?C:k.data("searchTerm")||"",J=H?ut(O,z):h(O);H&&(k.data("searchTerm",z),k.attr("data-search-term",z)),N.stop(!0,!0),N.off("input.rlh change.rlh"),N.html(J),k.attr("data-entry-mode",u),N.attr("data-entry-mode",u),k.toggleClass("rlh-editing",!H),b(k,u);let M=k.find(".rlh-item-name").first();M.length&&(H?M.show().removeAttr("aria-hidden"):M.hide().attr("aria-hidden","true"));let j=()=>{H||p(N)},ee=ae=>{let te=N[0];if(!te){ae();return}let fe=280,_e=Le=>Le<.5?2*Le*Le:-1+(4-2*Le)*Le;te.style.display="block",te.style.overflow="hidden";let G=0,be=te.scrollHeight;te.style.height=`${G}px`,te.style.opacity="0";let de=null,Ge=Le=>{de||(de=Le);let Ke=Math.min((Le-de)/fe,1),br=_e(Ke),wt=G+(be-G)*br;te.style.height=`${wt}px`,te.style.opacity=String(.6+.4*br),Ke<1?requestAnimationFrame(Ge):(te.style.height="",te.style.opacity="",te.style.overflow="",ae())};requestAnimationFrame(Ge)};N.is(":visible")?j():L?ee(j):(N.show(),j())},v=(u,k,O,L={})=>{f("view",u,k,{...L,searchTerm:O})},w=(u,k,O={})=>{f("edit",u,k,O)},E=(u,k,O,{animate:L=!0}={})=>{let C=u.find(".rlh-collapsible-content").first();if(!C.length)return;let N=typeof O=="string"?O:"";u.data("searchTerm",N),u.attr("data-search-term",N);let H=Ht(k,N);C.stop(!0,!0),C.off("input.rlh change.rlh"),C.html(H),u.attr("data-entry-mode","view"),C.attr("data-entry-mode","view"),u.removeClass("rlh-editing"),b(u,"view");let z=u.find(".rlh-item-name").first();z.length&&z.show().removeAttr("aria-hidden"),C.is(":visible")||(L?C.slideDown(200):C.show())},T=(u,k,{animate:O=!0}={})=>{let L=u.find(".rlh-collapsible-content").first();if(!L.length)return;let C=m(k);L.stop(!0,!0),L.off("input.rlh change.rlh");let N=()=>{L.on("input.rlh change.rlh",'input, textarea, select, [contenteditable="true"]',i)};L.html(C),u.attr("data-entry-mode","edit"),L.attr("data-entry-mode","edit"),u.addClass("rlh-editing"),b(u,"edit");let H=u.find(".rlh-item-name").first();H.length&&H.hide().attr("aria-hidden","true"),L.is(":visible")?N():O?L.slideDown(200,N):(L.show(),N())},A=(u,k={})=>{let{animate:O=!1,silent:L=!1}=k;if(!u.length)return!1;if(o.multiSelectMode)return L||ve("\u8BF7\u5148\u9000\u51FA\u591A\u9009\u6A21\u5F0F\u540E\u518D\u7F16\u8F91\u3002","info"),!1;let C=u.data("book-name"),N=Number(u.data("id"));if(!C||Number.isNaN(N))return!1;let H=ne(C).find(z=>z.uid===N);return H?(w(u,H,{animate:O}),!0):!1},s=(u,k={})=>{let{animate:O=!1}=k;if(!u.length)return!1;let L=u.data("book-name"),C=Number(u.data("id"));if(!L||Number.isNaN(C))return!1;let N=ne(L).find(z=>z.uid===C);if(!N)return!1;let H=u.data("searchTerm")||"";return v(u,N,H,{animate:O}),!0},g=(u,k={})=>{let{animate:O=!1,silent:L=!1}=k;if(!u.length)return!1;if(o.multiSelectMode)return L||ve("\u8BF7\u5148\u9000\u51FA\u591A\u9009\u6A21\u5F0F\u540E\u518D\u7F16\u8F91\u3002","info"),!1;let C=u.data("id"),N=a(C);return N?(T(u,N,{animate:O}),!0):!1},x=(u,k={})=>{let{animate:O=!1}=k;if(!u.length)return!1;let L=u.data("id"),C=a(L);if(!C)return!1;let N=u.data("searchTerm")||"";return E(u,C,N,{animate:O}),!0},R=B(async u=>{u.preventDefault(),u.stopPropagation();let k=r(u.currentTarget).closest(".rlh-item-container");A(k,{animate:!1})}),I=B(async u=>{u.preventDefault(),u.stopPropagation();let k=r(u.currentTarget).closest(".rlh-item-container");s(k,{animate:!1})}),S=B(async u=>{u.preventDefault(),u.stopPropagation();let k=r(u.currentTarget).closest(".rlh-item-container");g(k,{animate:!1})}),K=B(async u=>{u.preventDefault(),u.stopPropagation();let k=r(u.currentTarget).closest(".rlh-item-container");x(k,{animate:!1})}),ce=B(async u=>{u.stopPropagation();let k=r(u.currentTarget),O=k.closest(".rlh-book-group, .rlh-item-container");if(O.hasClass("renaming"))return;let L=!O.hasClass("enabled"),C=O.parent();if(k.hasClass("rlh-global-toggle")){k.addClass("rlh-loading");try{let H=O.data("book-name"),z=new Set(await Y.getGlobalWorldbookNames()||[]);L?z.add(H):z.delete(H),await Y.rebindGlobalWorldbooks(Array.from(z)),await Y.saveSettings();let J=o.allLorebooks.find(M=>M.name===H);J&&(J.enabled=L)}finally{k.removeClass("rlh-loading")}}else{let H=O.data("type"),z=O.data("id");if(H==="lore"){let J=O.data("book-name");await Fe(J,[{uid:Number(z),enabled:L}]);let M=ne(J).find(j=>j.uid===Number(z));M&&(M.enabled=L)}else{let J=await Y.getRegexes(),M=J.find(j=>j.id===z);if(M){M.enabled=L,await Y.replaceRegexes(J.filter(ee=>ee.source!=="card")),await Y.saveSettings();let j=o.regexes.global.find(ee=>ee.id===z)||o.regexes.character.find(ee=>ee.id===z);j&&(j.enabled=L)}}}ve(L?"\u5DF2\u542F\u7528":"\u5DF2\u7981\u7528"),O.toggleClass("enabled",L);let N=C.children().get();N.sort((H,z)=>{let J=r(H).hasClass("enabled"),M=r(z).hasClass("enabled");if(J!==M)return M-J;let j=r(H).find(".rlh-item-name").text().trim(),ee=r(z).find(".rlh-item-name").text().trim();return j.localeCompare(ee)}),C.append(N)}),q=B(async u=>{u.stopPropagation();let O=r(u.currentTarget).closest(".rlh-item-container");if(!O.length)return;let L=O.data("type");if(O.attr("data-entry-mode")==="edit"){Z(O),L==="lore"?s(O,{animate:!1}):x(O,{animate:!1});return}if(o.multiSelectMode){ve("\u8BF7\u5148\u9000\u51FA\u591A\u9009\u6A21\u5F0F\u540E\u518D\u7F16\u8F91\u3002","info");return}let N=O.find(".rlh-item-header").first(),z=N.find(".rlh-item-name").first().clone().children().remove().end().text().trim(),J=`<div class="rlh-rename-ui"><div class="rlh-rename-input-wrapper"><input type="text" class="rlh-rename-input" value="${D(z)}" /><button class="rlh-action-btn-icon rlh-rename-save-btn" title="\u786E\u8BA4"><i class="fa-solid fa-check"></i></button></div></div>`,M=!1;L==="lore"?M=A(O,{animate:!1,silent:!0}):M=g(O,{animate:!1,silent:!0}),M&&(N.find(".rlh-rename-ui").length||(O.addClass("renaming"),N.append(J)),N.find(".rlh-rename-input").focus().select())}),Z=(u,k=null)=>{let O=u.find(".rlh-item-header").first(),L=O.find(".rlh-item-name").first();k&&L.text(k),O.find(".rlh-rename-ui").remove(),L.length&&u.attr("data-entry-mode")!=="edit"&&L.show().removeAttr("aria-hidden"),u.removeClass("renaming")},W=B(async u=>{u.stopPropagation();let k=r(u.currentTarget).closest(".rlh-item-container"),O=k.data("type"),L=()=>{O==="lore"?s(k,{animate:!1}):x(k,{animate:!1})},N=k.find(".rlh-rename-input").val().trim(),H=k.find(".rlh-item-name").first().text().trim();if(!N||N===H){Z(k,H),L();return}let z=k.data("id");if(O==="lore"){let J=k.data("book-name");await Fe(J,[{uid:Number(z),name:N}]);let j=[...ne(J)].find(ee=>ee.uid===Number(z));j&&(j.name=N)}else{let J=await Y.getRegexes(),M=J.find(j=>j.id===z);if(M){M.script_name=N,await Y.replaceRegexes(J.filter(ee=>ee.source!=="card")),await Y.saveSettings();let j=o.regexes.global.find(ee=>ee.id===z)||o.regexes.character.find(ee=>ee.id===z);j&&(j.script_name=N)}}Z(k,N),L(),ve("\u91CD\u547D\u540D\u6210\u529F")}),le=B(async u=>{if(u.key==="Enter")r(u.currentTarget).siblings(".rlh-rename-save-btn").click();else if(u.key==="Escape"){u.preventDefault();let k=r(u.currentTarget).closest(".rlh-item-container");Z(k)}}),pe=B(async u=>{u.stopPropagation();let k=r(u.currentTarget),L=k.closest(".rlh-editor-wrapper").find("textarea, .rlh-edit-content");k.find("i").hasClass("fa-expand")?(k.attr("title","\u6536\u7F29").find("i").removeClass("fa-expand").addClass("fa-compress"),L.each(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})):(k.attr("title","\u5C55\u5F00").find("i").removeClass("fa-compress").addClass("fa-expand"),L.css("height",""))}),ue=Dt(B(async u=>{let O=r(u.currentTarget).data("book-name"),C=Ae().activeBookName??o.activeBookName??o.activeCharacterBook??o.chatLorebook??"",N=O||C;if(!N){await Q({type:"alert",title:"\u521B\u5EFA\u5931\u8D25",text:"\u5F53\u524D\u6CA1\u6709\u9009\u4E2D\u7684\u4E16\u754C\u4E66\uFF0C\u65E0\u6CD5\u521B\u5EFA\u6761\u76EE\u3002"});return}let H=ol(N),z=No(H,N);if(z&&z.length){let J=z.find(".rlh-rename-btn");J.length&&J.trigger("click")}try{let J=await Y.createWorldbookEntries(N,[{name:H.name,enabled:H.enabled,keys:H.keys}]);if(J&&J.new_entries&&J.new_entries.length>0){Oe(N,J.worldbook.map(ar));let M=J.new_entries[0];if(M){ll(N,H.uid,M);let j=r(`#rlh-panel .rlh-item-container[data-id="${H.uid}"]`,t);j.length&&(j.attr("data-id",M.uid),j.data("id",M.uid))}wr(N),ve("\u65B0\u6761\u76EE\u5DF2\u521B\u5EFA")}else throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u4E0D\u6B63\u786E")}catch(J){console.error("[RegexLoreHub] Create entry failed:",J),Q({type:"alert",title:"\u521B\u5EFA\u5931\u8D25",text:`\u521B\u5EFA\u65B0\u6761\u76EE\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u4F46\u60A8\u4ECD\u53EF\u7F16\u8F91\u5F53\u524D\u5185\u5BB9\u5E76\u624B\u52A8\u4FDD\u5B58\u3002\u9519\u8BEF: ${J.message}`})}}),300),oe=B(async u=>{u.stopPropagation();let k=r(u.currentTarget).closest(".rlh-item-container"),O=k.data("book-name"),L=Number(k.data("id")),C=k.find(".rlh-item-name").text().trim();try{await Q({type:"confirm",title:"\u786E\u8BA4\u5220\u9664",text:`\u60A8\u786E\u5B9A\u8981\u5220\u9664\u6761\u76EE "${C}" \u5417\uFF1F`,danger:!0})}catch{return}let N=await Y.deleteWorldbookEntries(O,[L]);N&&N.deleted_entries&&N.deleted_entries.length>0?(Oe(O,N.worldbook.map(ar)),wr(O),k.slideUp(300,()=>k.remove()),ve("\u5220\u9664\u6210\u529F")):await Q({type:"alert",title:"\u5220\u9664\u5931\u8D25",text:"\u5220\u9664\u6761\u76EE\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"})}),ie=B(async u=>{let k=r(u.currentTarget),O=k.closest(".rlh-editor-grid").find(".rlh-depth-container");k.val().startsWith("at_depth")?O.slideDown(200):O.slideUp(200)});return{handleToggleState:ce,handleEditorInput:i,renderLoreEntryViewer:v,renderLoreEntryEditor:w,renderRegexViewer:E,renderRegexEditor:T,handleEntryEnterEdit:R,handleEntryExitEdit:I,handleRegexEnterEdit:S,handleRegexExitEdit:K,handleRename:q,handleConfirmRename:W,handleRenameKeydown:le,handleEditorExpandToggle:pe,handleCreateEntry:ue,handleDeleteEntry:oe,handlePositionChange:ie}}var ya=(e,r,t,a,l,n)=>{let i=Io(e,r,t,a,l,n);return Q({type:"confirm",title:"\u786E\u8BA4\u66FF\u6362",html:i,danger:!0})},il=B(async e=>{let r=xe(),t=we(),a=r(`#${ke}`,t);if(!a.length)return;let l=a.find(`#${Ye.TOOLBAR_SHELL}`);if(l.length||(l=a.find(".rlh-toolbar-shell").first(),l.length&&l.attr("id",Ye.TOOLBAR_SHELL)),!l.length)return;let n=!l.hasClass("rlh-toolbar-shell--collapsed");e?.preventDefault?.(),e?.stopPropagation?.(),l.toggleClass("rlh-toolbar-shell--collapsed",n),l.attr("aria-hidden",String(n)),o.isToolbarCollapsed=n;let i=e?.currentTarget?r(e.currentTarget):a.find(`#${Ye.TOGGLE_TOOLBAR_BTN}`);i.length&&(i.text("\u5DE5\u5177\u680F"),i.attr("aria-expanded",String(!n)),i.attr("title","\u5DE5\u5177\u680F"))});function sl(e={}){let r=e.$??xe(),t=e.parentDoc??we(),a=e.lorebookHandlers,l=e.itemHandlers,n=()=>{switch(o.multiSelectTarget){case"book":return"book:";case"entry":return"lore:";case"regex":return"regex:";default:return""}},i=c=>{let d=String(c??""),y=d.indexOf(":");if(y===-1)return{type:d,raw:""};let _=d.slice(0,y),V=d.slice(y+1);if(_==="book")return{type:_,bookName:ze(V)};if(_==="lore"){let F=V.lastIndexOf(":");if(F===-1)return{type:_,bookName:ze(V),entryId:null};let P=V.slice(0,F),U=V.slice(F+1);return{type:_,bookName:ze(P),entryId:ze(U)}}return _==="regex"?{type:_,regexId:ze(V)}:{type:_,raw:V}},h=()=>({$menu:r(`#${$r}`,t),$button:r(`#${sr}`,t)}),m=()=>{let c=new Map;for(let d of o.selectedItems){let{type:y,bookName:_,entryId:V}=i(d);if(y==="lore"&&_){let F=Number(V),P=Number.isFinite(F)?F:V;if(P==null||P==="")continue;c.has(_)||c.set(_,[]),c.get(_).push(P)}}return c},b=!1;function p(){let{$menu:c,$button:d}=h();c.length&&c.attr("data-open","false"),d.length&&d.attr("aria-expanded","false"),b&&(r(t).off("click.rlhUnifiedStatus",f),b=!1)}function f(c){let{$menu:d,$button:y}=h();if(!d.length)return;let _=r(c.target);_.closest(`#${$r}`).length||y.length&&_.closest(`#${sr}`).length||p()}function v(){let{$menu:c,$button:d}=h();!c.length||!d.length||(c.attr("data-open","true"),d.attr("aria-expanded","true"),b||(r(t).on("click.rlhUnifiedStatus",f),b=!0))}let w=()=>{let{$menu:c,$button:d}=h();if(!d.length)return;let y=Ae();if(!(y?.type==="lore")){d.attr("disabled","disabled").attr("title","\u7EDF\u4E00\u72B6\u6001\u4EC5\u5728\u6761\u76EE\u89C6\u56FE\u53EF\u7528"),c.length&&c.attr("data-open")==="true"&&p();return}let F=[y?.activeBookName,o.activeBookName,o.activeCharacterBook,o.chatLorebook].find(Ce=>typeof Ce=="string"&&Ce.trim().length>0)?.toString().trim()??"",P=m();!F&&P.size===1&&(F=[...P.keys()][0]??"");let X=(F?ne(F):[]).length>0,re=o.multiSelectMode&&o.multiSelectTarget==="entry",me=0;P.forEach(Ce=>{Array.isArray(Ce)&&(me+=Ce.length)});let ge=re?me>0:X,he;re?he=me>0?`\u591A\u9009\u6A21\u5F0F\uFF1A\u5C06\u5BF9\u5DF2\u9009\u4E2D\u7684 ${me} \u4E2A\u6761\u76EE\u7EDF\u4E00\u72B6\u6001`:"\u5DF2\u5F00\u542F\u591A\u9009\uFF0C\u8BF7\u5148\u52FE\u9009\u8981\u8C03\u6574\u72B6\u6001\u7684\u6761\u76EE":X?he=`\u5C06\u5BF9\u300C${F||"\u5F53\u524D\u4E16\u754C\u4E66"}\u300D\u7684\u6240\u6709\u6761\u76EE\u7EDF\u4E00\u72B6\u6001`:he=F?`\u300C${F}\u300D\u6682\u65E0\u6761\u76EE\u53EF\u8C03\u6574`:"\u8BF7\u5148\u6253\u5F00\u9700\u8981\u7EDF\u4E00\u72B6\u6001\u7684\u4E16\u754C\u4E66",d.attr("title",he),ge?d.removeAttr("disabled"):(d.attr("disabled","disabled"),c.length&&c.attr("data-open")==="true"&&p())},E=()=>{let{$menu:c,$button:d}=_e();if(!d.length)return;let V=[Ae()?.activeBookName,o.activeBookName,o.activeCharacterBook,o.chatLorebook].find(he=>typeof he=="string"&&he.trim().length>0)?.toString().trim()??"",F=m();!V&&F.size===1&&(V=[...F.keys()][0]??"");let U=(V?ne(V):[]).length>0,X=o.multiSelectMode&&o.multiSelectTarget==="entry",re=0;F.forEach(he=>{Array.isArray(he)&&(re+=he.length)});let me=X?re>0:U,ge;X?ge=re>0?`\u591A\u9009\u6A21\u5F0F\uFF1A\u5C06\u5BF9\u5DF2\u9009\u4E2D\u7684 ${re} \u4E2A\u6761\u76EE\u7EDF\u4E00\u4F4D\u7F6E`:"\u5DF2\u5F00\u542F\u591A\u9009\uFF0C\u8BF7\u5148\u52FE\u9009\u8981\u8C03\u6574\u4F4D\u7F6E\u7684\u6761\u76EE":U?ge=`\u5C06\u5BF9\u300C${V||"\u5F53\u524D\u4E16\u754C\u4E66"}\u300D\u7684\u6240\u6709\u6761\u76EE\u7EDF\u4E00\u4F4D\u7F6E`:ge=V?`\u300C${V}\u300D\u6682\u65E0\u6761\u76EE\u53EF\u8C03\u6574`:"\u8BF7\u5148\u6253\u5F00\u9700\u8981\u7EDF\u4E00\u4F4D\u7F6E\u7684\u4E16\u754C\u4E66",d.attr("title",ge),me?d.removeAttr("disabled"):(d.attr("disabled","disabled"),c.length&&c.attr("data-open","false"))},T=()=>{bt(),w(),E()},A=()=>{if(!o.multiSelectMode)return[];let c=r(`#${ke}`,t);if(!c.length)return[];let d;switch(o.multiSelectTarget){case"book":d=".rlh-book-group[data-select-key]";break;case"entry":d='.rlh-item-container[data-select-key][data-type="lore"]';break;case"regex":d='.rlh-item-container[data-select-key][data-type="regex"]';break;default:d="[data-select-key]";break}let y=[];return c.find(d).each((_,V)=>{let F=r(V);if(!F.is(":visible"))return;let P=F.data("select-key");P&&y.push(String(P))}),y},s=()=>{if(!o.selectedItems||o.selectedItems.size===0)return!1;let c=n();if(!c)return o.selectedItems.size>0;for(let d of o.selectedItems)if(d.startsWith(c))return!0;return!1},g=c=>{if(!c||!c.length)return null;if(c.hasClass("rlh-book-group")){if(o.multiSelectTarget!=="book")return null;let d=c.data("book-name");return d?Ze(d):null}if(c.hasClass("rlh-item-container")){let d=c.data("type"),y=c.data("id");if(d==="lore"&&o.multiSelectTarget==="entry"){let _=c.data("book-name");return _!=null&&y!=null?Kr(_,y):null}if(d==="regex"&&o.multiSelectTarget==="regex")return y!=null?Vr(y):null}return null},x=c=>{let d=g(c);return d?(o.selectedItems.has(d)?(o.selectedItems.delete(d),c.removeClass("selected"),c.find(".rlh-multi-select-checkbox").prop("checked",!1)):(o.selectedItems.add(d),c.addClass("selected"),c.find(".rlh-multi-select-checkbox").prop("checked",!0)),T(),!0):!1},R=B(async c=>{let d=r(c.currentTarget),y=d.val();d.attr("id")==="rlh-global-search-input"?o.globalSearch.term=y:d.attr("id")==="rlh-global-replace-input"&&(o.globalSearch.replace=y),d.attr("id")==="rlh-global-search-input"&&se()}),I=B(async c=>{if(c.key==="Enter"){c.preventDefault();let d=c.currentTarget.value??"";o.globalSearch.term=d,se()}}),S=(c=[])=>{let d=new Set;return c.forEach(y=>{if(typeof y!="string")return;let _=y.trim();_&&d.add(_)}),Array.from(d)},K=async c=>{let d=S(c);if(!d.length)return!0;let y=d.filter(V=>{if(o.allLorebooks.find(U=>U.name===V)?.entriesLoaded)return!1;let P=ne(V);return!Array.isArray(P)||P.length===0});if(!y.length)return!0;let _=lr(`\u6B63\u5728\u52A0\u8F7D ${y.length} \u672C\u4E16\u754C\u4E66\u7684\u6761\u76EE...`);try{return await Promise.all(y.map(V=>Ie(V))),_.remove(),!0}catch(V){return _.remove(),console.error("[RegexLoreHub] Failed to load entries before replace:",V),await Q({type:"alert",title:"\u52A0\u8F7D\u5931\u8D25",text:"\u5728\u6267\u884C\u66FF\u6362\u524D\u52A0\u8F7D\u4E16\u754C\u4E66\u6761\u76EE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"}),!1}},ce=B(async()=>{let c=r(`#${nr}`,t);c.length&&c.val(""),o.globalSearch.term="",se()}),q=B(async()=>{let c=r(`#${nr}`,t).val(),d=r(`#${Sr}`,t).val(),y=Ae();if(!c){await Q({type:"alert",title:"\u66FF\u6362\u5931\u8D25",text:"\u8BF7\u5148\u8F93\u5165\u641C\u7D22\u8BCD\u3002"});return}if(y.view==="global-lore-list"){let U=o.allLorebooks.filter(X=>!X.entriesLoaded);if(U.length>0){let X=lr(`\u6B63\u5728\u52A0\u8F7D ${U.length} \u672C\u4E16\u754C\u4E66\u7684\u6761\u76EE...`);try{await Promise.all(U.map(re=>Ie(re.name))),X.remove()}catch(re){X.remove(),console.error("[RegexLoreHub] Failed to load entries before replace:",re),await Q({type:"alert",title:"\u52A0\u8F7D\u5931\u8D25",text:"\u5728\u6267\u884C\u66FF\u6362\u524D\u52A0\u8F7D\u4E16\u754C\u4E66\u6761\u76EE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"});return}}}let _,V,F,P;if(y.type==="lore")if(P={type:"lorebook",bookNames:[]},y.view==="global-lore-list")({matches:_,stats:V,booksMatchedByNameOnly:F}=Jr(c));else if(y.view==="global-lore-detail"){let U=S([y.activeBookName]);if(!U.length){await Q({type:"alert",title:"\u64CD\u4F5C\u65E0\u6548",text:"\u8BF7\u5148\u9009\u62E9\u8981\u66FF\u6362\u7684\u4E16\u754C\u4E66\u3002"});return}if(!await K(U))return;({matches:_,stats:V,booksMatchedByNameOnly:F}=Jr(c,!1,{bookNames:U})),P.bookNames=U}else if(y.id==="char-lore"){let U=S([y.activeBookName,o.activeCharacterBook]);if(!U.length){await Q({type:"alert",title:"\u64CD\u4F5C\u65E0\u6548",text:"\u5F53\u524D\u6CA1\u6709\u53EF\u7528\u7684\u89D2\u8272\u4E16\u754C\u4E66\uFF0C\u65E0\u6CD5\u6267\u884C\u66FF\u6362\u3002"});return}if(!await K(U))return;({matches:_,stats:V,booksMatchedByNameOnly:F}=Jr(c,!1,{bookNames:U})),P.bookNames=U}else if(y.id==="chat-lore"){let U=S([y.activeBookName,o.chatLorebook]);if(!U.length){await Q({type:"alert",title:"\u64CD\u4F5C\u65E0\u6548",text:"\u5F53\u524D\u6CA1\u6709\u53EF\u7528\u7684\u804A\u5929\u4E16\u754C\u4E66\uFF0C\u65E0\u6CD5\u6267\u884C\u66FF\u6362\u3002"});return}if(!await K(U))return;({matches:_,stats:V,booksMatchedByNameOnly:F}=Jr(c,!1,{bookNames:U})),P.bookNames=U}else{await Q({type:"alert",title:"\u64CD\u4F5C\u65E0\u6548",text:"\u5F53\u524D\u89C6\u56FE\u4E0D\u652F\u6301\u66FF\u6362\u529F\u80FD\u3002"});return}else if(y.type==="regex")({matches:_,stats:V}=Do(c)),P="regex";else{await Q({type:"alert",title:"\u64CD\u4F5C\u65E0\u6548",text:"\u672A\u77E5\u7684\u89C6\u56FE\u7C7B\u578B\uFF0C\u65E0\u6CD5\u6267\u884C\u66FF\u6362\u3002"});return}if((!_||_.length===0)&&(!F||F.length===0)){await Q({type:"alert",title:"\u65E0\u5339\u914D\u9879",text:"\u672A\u627E\u5230\u53EF\u66FF\u6362\u7684\u6761\u76EE\u3002"});return}try{await ya(_,V,F,c,d,P);let U=lr("\u6B63\u5728\u6267\u884C\u66FF\u6362...");try{await fl(_,c,d),U.remove(),ve("\u66FF\u6362\u5B8C\u6210"),se()}catch(X){U.remove(),console.error("[RegexLoreHub] Replace error:",X),await Q({type:"alert",title:"\u66FF\u6362\u5931\u8D25",text:"\u66FF\u6362\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u3002"})}}catch{console.log("[RegexLoreHub] Replace operation cancelled by user.")}}),Z=B(async()=>{let c=Ae();if(!c.showCollapseToggle)return;let d=Cr(c),_=(o.collapseStateByContext.get(d)??"expanded")==="collapsed"?"expanded":"collapsed";Eo(c,_),r(`#${ke}-content .rlh-item-container:visible, #${ke}-content .rlh-book-group:visible`,t).each(function(){let P=r(this),X=P.find(".rlh-collapsible-content").first().is(":visible"),re=P.find(".rlh-item-header, .rlh-global-book-header").first();_==="expanded"&&!X?re.trigger("click.rlh",{bulk:!0}):_==="collapsed"&&X&&re.trigger("click.rlh",{bulk:!0})});let F=r(`#${_r}`,t);if(F.length){let P=_==="collapsed"?"fa-expand-arrows-alt":"fa-compress-arrows-alt",U=_==="collapsed"?"\u5168\u90E8\u5C55\u5F00":"\u5168\u90E8\u6298\u53E0";F.attr("data-collapse-state",_),F.find("i").removeClass("fa-expand-arrows-alt fa-compress-arrows-alt").addClass(P),F.find("span").text(U)}}),W=!1;function le(){return{$menu:r(`#${Er}`,t),$button:r(`#${ir}`,t)}}function pe(c){if(!W)return;let d=r(c.target);d.closest(`#${Er}`).length||d.closest(`#${ir}`).length||u()}function ue(c){if(c.key!=="Escape")return;let{$button:d}=le();u(),d.length&&d.trigger("focus")}function oe(){W||(r(t).on("click.rlhSortMenu",pe),r(t).on("keydown.rlhSortMenu",ue),W=!0)}function ie(){W&&(r(t).off("click.rlhSortMenu",pe),r(t).off("keydown.rlhSortMenu",ue),W=!1)}function u(){let{$menu:c,$button:d}=le();c.length&&(c.attr("data-open","false").removeClass("open"),d.length&&d.attr("aria-expanded","false"),ie())}function k(){let{$menu:c,$button:d}=le();c.length&&(c.attr("data-open","true").addClass("open"),d.length&&d.attr("aria-expanded","true"),oe())}let O=B(async c=>{c.preventDefault(),c.stopPropagation();let{$menu:d}=le();if(!d.length)return;d.attr("data-open")==="true"?u():k()}),L=B(async c=>{c.preventDefault();let d=r(c.currentTarget).data("sort-value");if(!d)return;u();let y=Ae();$o(y,d),se()}),C=!1,N=()=>({$wrapper:r(`#${Pr}`,t),$menu:r(`#${cr}`,t),$button:r(`#${zr}`,t)});function H(c){if(!C)return;let{$wrapper:d}=N();if(!d.length)return;let y=c?.target??null;y&&d[0]?.contains(y)||j()}function z(c){if(c.key!=="Escape")return;let{$button:d}=N();j(),d.length&&d.trigger("focus")}function J(){C||(r(t).on("click.rlhThemeMenu",H),r(t).on("keydown.rlhThemeMenu",z),C=!0)}function M(){C&&(r(t).off("click.rlhThemeMenu",H),r(t).off("keydown.rlhThemeMenu",z),C=!1)}function j(){let{$wrapper:c,$menu:d,$button:y}=N();c.length&&c.removeClass("open"),d.length&&d.attr("data-open","false"),y.length&&y.attr("aria-expanded","false"),M()}function ee(){let{$wrapper:c,$menu:d,$button:y}=N();!c.length||!d.length||(c.addClass("open"),d.attr("data-open","true"),y.length&&y.attr("aria-expanded","true"),J())}let ae=B(c=>{c.preventDefault(),c.stopPropagation();let{$wrapper:d}=N();if(!d.length)return;d.hasClass("open")?j():ee()}),te=B(async c=>{c.preventDefault();let d=r(c.currentTarget);if(!d.hasClass(Tr)){j();return}let y=d.data("themeId"),_=typeof y=="string"||typeof y=="number"?String(y).trim():"";if(!_){j();return}let V=Fr();if(!V||V.id!==_){let F=Wr(_,{reason:"user"});F&&await Ko(F.id)}j()}),fe=!1;function _e(){return{$menu:r(`#${or}`,t),$button:r(`#${Qe}`,t)}}function G(c){if(!fe)return;let d=r(c.target);d.closest(`#${or}`).length||d.closest(`#${Qe}`).length||Le()}function be(c){if(c.key!=="Escape")return;let{$button:d}=_e();Le(),d.length&&d.trigger("focus")}function de(){fe||(r(t).on("click.rlhPositionMenu",G),r(t).on("keydown.rlhPositionMenu",be),fe=!0)}function Ge(){fe&&(r(t).off("click.rlhPositionMenu",G),r(t).off("keydown.rlhPositionMenu",be),fe=!1)}function Le(){let{$menu:c,$button:d}=_e();c.length&&(c.attr("data-open","false").removeClass("open"),d.length&&d.attr("aria-expanded","false"),Ge())}function Ke(){let{$menu:c,$button:d}=_e();c.length&&(d.is("[disabled]")||(c.attr("data-open","true").addClass("open"),d.length&&d.attr("aria-expanded","true"),de()))}let br=B(async c=>{c.preventDefault(),c.stopPropagation(),T();let{$menu:d}=_e();if(!d.length)return;d.attr("data-open")==="true"?Le():Ke()}),wt=B(async c=>{c.preventDefault();let d=r(c.currentTarget),y=(d.data("position-value")??"").toString().trim(),_=(d.data("book-name")??d.closest(`#${or}`).data("book-name")??"").toString().trim();Le(),y&&a?.applyUnifiedPosition&&await a.applyUnifiedPosition({bookName:_,positionValue:y})}),ul=B(async c=>{c.preventDefault(),c.stopPropagation(),T();let{$menu:d,$button:y}=h();if(!d.length||!y.length||y.is(":disabled"))return;d.attr("data-open")==="true"?p():v()}),bl=B(async c=>{c.preventDefault();let y=(r(c.currentTarget).data("status-id")??"").toString().trim();if(!y)return;p();let _=o.multiSelectMode&&o.multiSelectTarget==="entry",V=m();if(_&&V.size===0){await Q({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5DF2\u4FDD\u5B58\u7684\u6761\u76EE\u3002"}),T();return}if(!_){let Pe=[Ae()?.activeBookName,o.activeBookName,o.activeCharacterBook,o.chatLorebook].find(Je=>typeof Je=="string"&&Je.trim().length>0)?.toString().trim()??"";if(!Pe){await Q({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u4EE5\u4FBF\u6267\u884C\u7EDF\u4E00\u72B6\u6001\u3002"}),T();return}let mr=[...ne(Pe)];if(mr.length||(await Ie(Pe),mr=[...ne(Pe)]),!mr.length){await Q({type:"alert",title:"\u63D0\u793A",text:`\u300C${Pe}\u300D\u6682\u65E0\u6761\u76EE\u53EF\u64CD\u4F5C\u3002`}),T();return}let je=[];if(mr.forEach(Je=>{let Te=Number(Je?.uid);Number.isFinite(Te)&&je.push(Te)}),!je.length){await Q({type:"alert",title:"\u63D0\u793A",text:"\u5F53\u524D\u6CA1\u6709\u5DF2\u4FDD\u5B58\u7684\u6761\u76EE\u53EF\u64CD\u4F5C\u3002"}),T();return}V=new Map([[Pe,je]])}let F=qe(y)??Re,P=F.toastLabel??F.label,U=Array.from(V.values()).reduce((Be,Mr)=>Be+Mr.length,0),X=lr(`\u6B63\u5728\u66F4\u65B0 ${U} \u4E2A\u6761\u76EE\u7684\u72B6\u6001...`),re=0,me=0,ge=0,he=0,Ce=0,Ve=[];try{let Be=Ae(),Mr=0;for(let[Pe,mr]of V.entries()){Mr+=1,X.update(`\u6B63\u5728\u66F4\u65B0\u300C${Pe}\u300D (${Mr}/${V.size})`);let je=await qo(Pe,mr,F.id,{context:Be?.id??"unknown"}).catch(Te=>(console.error("[RegexLoreHub] \u6279\u91CF\u72B6\u6001\u66F4\u65B0\u5F02\u5E38:",Te),Ve.push({bookName:Pe,reason:Te?.message??"\u672A\u77E5\u9519\u8BEF"}),ge+=mr.length,null));if(!je)continue;let Je=je.summary??{appliedCount:0,alreadyAppliedCount:0,failedCount:0,ignoredCount:0,ignoredUnsavedCount:0};re+=Je.appliedCount??0,me+=Je.alreadyAppliedCount??0,ge+=Je.failedCount??0,he+=Je.ignoredCount??0,Ce+=Je.ignoredUnsavedCount??0,Array.isArray(je.failed)&&je.failed.forEach(Te=>{Ve.push({bookName:Pe,name:Te.name??`#${Te.uid??Te.tempUid??"\u672A\u77E5"}`,reason:Te.reason??"\u672A\u8BF4\u660E"})}),Array.isArray(je.ignored)&&je.ignored.filter(Te=>Te.reason&&Te.reason!=="UNSAVED_ENTRY").forEach(Te=>{Ve.push({bookName:Pe,name:Te.name??`#${Te.uid??Te.tempUid??"\u672A\u77E5"}`,reason:Te.reason})}),Array.isArray(je.success)&&je.success.forEach(Te=>{let lo=Te.uid??Te.tempUid;lo!=null&&mt(Pe,lo,F.id)})}}finally{X.remove()}let Ne=Math.max(he-Ce,0),Me="";if(re>0&&ge===0&&Ce===0&&Ne===0)Me=`${re} \u4E2A\u6761\u76EE\u7684\u72B6\u6001\u5DF2\u66F4\u65B0\u4E3A\u300C${P}\u300D`,me>0&&(Me+=`\uFF08\u5176\u4E2D ${me} \u4E2A\u539F\u672C\u5DF2\u5904\u4E8E\u8BE5\u72B6\u6001\uFF09`);else{let Be=[];re>0&&Be.push(`${re} \u4E2A\u6761\u76EE\u66F4\u65B0\u4E3A\u300C${P}\u300D`),me>0&&Be.push(`${me} \u4E2A\u539F\u672C\u5DF2\u5904\u4E8E\u8BE5\u72B6\u6001`),ge>0&&Be.push(`${ge} \u4E2A\u6761\u76EE\u66F4\u65B0\u5931\u8D25`),Ce>0&&Be.push(`\u5FFD\u7565 ${Ce} \u4E2A\u672A\u4FDD\u5B58\u6761\u76EE`),Ne>0&&Be.push(`\u8DF3\u8FC7 ${Ne} \u4E2A\u6761\u76EE`),Me=Be.length>0?Be.join("\uFF1B"):"\u672A\u6267\u884C\u4EFB\u4F55\u72B6\u6001\u66F4\u65B0\uFF0C\u8BF7\u786E\u8BA4\u5DF2\u9009\u62E9\u6709\u6548\u6761\u76EE\u3002"}let Ee="success";ge>0?Ee=re>0?"warning":"error":(Ce>0||Ne>0)&&(Ee="info"),ve(Me,Ee),Ve.length&&console.warn("[RegexLoreHub] \u72B6\u6001\u66F4\u65B0\u8BE6\u60C5\uFF08\u4EC5\u65E5\u5FD7\uFF09:",Ve),T()}),ml=B(async c=>{let d=(r(c.currentTarget).val()??"").toString().trim();!d||o.activeCharacterBook===d||(o.activeCharacterBook=d,se())}),gl=B(async c=>{let d=r(c.currentTarget),y=d.data("select-key");if(!y)return;if(!o.multiSelectMode){d.prop("checked",!1);return}let _=d.is(":checked");_?o.selectedItems.add(y):o.selectedItems.delete(y),d.closest("[data-select-key]").toggleClass("selected",_),T()}),fl=async(c,d,y)=>{let _=So(d,!1),V=new Map,F=(P,U)=>{if(!Array.isArray(P)||!Array.isArray(U)||P.length!==U.length)return!1;for(let X=0;X<P.length;X+=1)if(P[X]!==U[X])return!1;return!0};for(let P of c){let{bookName:U,entry:X}=P??{};if(!U||!X)throw new Error("\u4EC5\u652F\u6301\u4E16\u754C\u4E66\u6761\u76EE\u7684\u6279\u91CF\u66FF\u6362\u3002");let re=Number(X?.uid);if(!Number.isFinite(re))continue;let me={uid:re},ge=!1;if(Array.isArray(X.keys)){let he=X.keys.map(Ce=>Ce.replace(_,y));F(X.keys,he)||(me.keys=he,ge=!0)}if(typeof X.content=="string"){let he=X.content.replace(_,y);he!==X.content&&(me.content=he,ge=!0)}if(typeof X.name=="string"){let he=X.name.replace(_,y);he!==X.name&&(me.name=he,ge=!0)}if(typeof X.comment=="string"){let he=X.comment.replace(_,y);he!==X.comment&&(me.comment=he,ge=!0)}ge&&(V.has(U)||V.set(U,[]),V.get(U).push(me))}for(let[P,U]of V.entries())U.length!==0&&await Fe(P,U)},xl=B(async()=>{r(`#${ke}`,t).is(":visible")?ro():await vl()}),ro=async()=>{ve("\u6B63\u5728\u540E\u53F0\u4FDD\u5B58\u6570\u636E...","info"),pr().then(()=>{ve("\u6570\u636E\u4FDD\u5B58\u6210\u529F\uFF01","success")}).catch(y=>{console.error("[RegexLoreHub] Background save failed:",y),ve("\u540E\u53F0\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u65E5\u5FD7\u3002","error")});let c=r(`#${ke}`,t),d=r("body",t);c.hide(),r(`#${tr}`,t).removeClass("active"),d.off("mousedown.rlh-outside-click")},vl=async()=>{let c=r(`#${ke}`,t),d=r("body",t);c.css("display","flex"),r(`#${tr}`,t).addClass("active"),d.on("mousedown.rlh-outside-click",function(y){r(y.target).closest(`#${ke}`).length===0&&r(y.target).closest(`#${tr}`).length===0&&ro()}),o.isDataLoaded?se():await We()},yl=B(async c=>{o.isLoadingTabData=!0,se();try{await rl();let d=y=>{if(!y)return null;Array.isArray(o.allLorebooks)||(o.allLorebooks=[]);let _=o.allLorebooks.find(V=>V.name===y);return _||(_={name:y,enabled:!1,entryCount:0,enabledEntryCount:0,entriesLoaded:!1},o.allLorebooks.push(_)),_};if(c==="char-lore"){let y=Array.isArray(o.lorebooks.character)?o.lorebooks.character:[];for(let _ of y)d(_),await Ie(_,!0)}else if(c==="chat-lore"){let y=o.chatLorebook;y&&(d(y),await Ie(y,!0))}}catch(d){console.error(`[RegexLoreHub] Error refreshing tab ${c}:`,d),B(()=>{throw d})()}finally{o.isLoadingTabData=!1,se()}}),kl=c=>{switch(c){case"char-lore":o.activeView="char-lore";break;case"chat-lore":o.activeView="chat-lore";break;case"global-regex":o.activeView="global-regex";break;case"char-regex":o.activeView="char-regex";break;case"global-lore":default:o.activeView!=="global-lore-detail"&&(o.activeView="global-lore-list");break}},wl=B(async c=>{let d=r(c.currentTarget).data("tab");if(d==="global-lore"&&o.activeView==="global-lore-detail"){await a.handleExitLorebookDetail();return}o.activeTab=d,kl(d),r(`#${ke} .rlh-tab`,t).removeClass("active"),r(c.currentTarget).addClass("active"),r(`#${tt}`,t).toggle(o.activeTab==="global-lore"),o.selectedItems.clear(),d==="char-lore"&&!o.charLoreInitialSynced&&(await We(),o.charLoreInitialSynced=!0),d==="char-lore"||d==="chat-lore"?await yl(d):se()}),to=B(async c=>{o.multiSelectMode=!o.multiSelectMode,o.selectedItems.clear(),r("#rlh-multi-select-btn",t).toggleClass("active",o.multiSelectMode),r("#rlh-multi-select-controls",t).toggleClass("active",o.multiSelectMode),se(),T()}),Sl=B(async()=>{if(!o.multiSelectMode)return;let c=A();c.length&&(c.forEach(d=>o.selectedItems.add(d)),se(),T())}),_l=B(async()=>{if(!o.multiSelectMode)return;let c=n(),d=!1;if(c)[...o.selectedItems].forEach(_=>{_.startsWith(c)&&(o.selectedItems.delete(_),d=!0)});else{if(o.selectedItems.size===0)return;o.selectedItems.clear(),d=!0}d&&(se(),T())}),El=B(async()=>{if(!o.multiSelectMode)return;let c=A();c.length&&(c.forEach(d=>{o.selectedItems.has(d)?o.selectedItems.delete(d):o.selectedItems.add(d)}),se(),T())}),$l=B(async()=>{if(o.multiSelectMode){if(!s())return await Q({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u9009\u62E9\u8981\u542F\u7528\u7684\u9879\u76EE\u3002"});await oo(!0),ve("\u6279\u91CF\u542F\u7528\u6210\u529F")}}),Tl=B(async()=>{if(o.multiSelectMode){if(!s())return await Q({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u9009\u62E9\u8981\u7981\u7528\u7684\u9879\u76EE\u3002"});await oo(!1),ve("\u6279\u91CF\u7981\u7528\u6210\u529F")}}),Ll=B(async()=>{if(!o.multiSelectMode)return;let c=new Set,d=new Map,y=new Set,_=0;for(let U of o.selectedItems){let{type:X,bookName:re,entryId:me,regexId:ge}=i(U);if(X==="book"&&re)c.add(re);else if(X==="lore"&&re){let he=Number(me);if(!Number.isFinite(he))continue;d.has(re)||d.set(re,[]),d.get(re).push(he),_++}else if(X==="regex"){let he=ge!=null&&ge!==""?String(ge):"";he&&y.add(he)}}if(c.size===0&&_===0&&y.size===0)return await Q({type:"alert",title:"\u63D0\u793A",text:"\u8BF7\u5148\u9009\u62E9\u8981\u5220\u9664\u7684\u9879\u76EE\u3002"});let V="\u60A8\u786E\u5B9A\u8981\u6C38\u4E45\u5220\u9664",F=[];c.size>0&&F.push(`\u9009\u4E2D\u7684 ${c.size} \u672C\u4E16\u754C\u4E66`),_>0&&F.push(`${_} \u4E2A\u6761\u76EE`),y.size>0&&F.push(`${y.size} \u4E2A\u6B63\u5219`),V+=` ${F.join("\u548C")} \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`;try{await Q({type:"confirm",title:"\u786E\u8BA4\u5220\u9664",text:V,danger:!0})}catch{return}let P=lr("\u5F00\u59CB\u5220\u9664...");try{let U=0,X=0,re=0,me=0,ge=0,he=Array.from(d.entries());for(let[Ne,Me]of he){if(c.has(Ne)){me+=Me.length;continue}P.update(`\u6B63\u5728\u5220\u9664\u6761\u76EE... (${me}/${_})`);let Ee=await Y.deleteWorldbookEntries(Ne,Me);me+=Me.length,Ee&&Ee.deleted_entries&&Ee.deleted_entries.length>0&&(X+=Ee.deleted_entries.length,Oe(Ne,Ee.worldbook.map(ar)),Me.forEach(Be=>o.selectedItems.delete(Kr(Ne,Be))))}let Ce=Array.from(c);for(let Ne of Ce){if(P.update(`\u6B63\u5728\u5220\u9664\u4E16\u754C\u4E66... (${ge+1}/${Ce.length})`),await Y.deleteWorldbook(Ne)){U++,o.allLorebooks=o.allLorebooks.filter(Ee=>Ee.name!==Ne),Yr(Ne),o.selectedItems.delete(Ze(Ne));let Me=fr(Ne);for(let Ee of[...o.selectedItems])Ee.startsWith(Me)&&o.selectedItems.delete(Ee)}ge++}if(y.size>0){P.update(`\u6B63\u5728\u5220\u9664 ${y.size} \u4E2A\u6B63\u5219...`);let Ne=await Y.getRegexes(),Me=Ne.filter(Ee=>!y.has(String(Ee.id)));await Y.replaceRegexes(Me.filter(Ee=>Ee.source!=="card")),await Y.saveSettings(),re=Ne.length-Me.length,o.regexes.global=o.regexes.global.filter(Ee=>!y.has(String(Ee.id))),o.regexes.character=o.regexes.character.filter(Ee=>!y.has(String(Ee.id))),er(o.regexes.global),er(o.regexes.character),y.forEach(Ee=>o.selectedItems.delete(Vr(Ee)))}P.remove();let Ve=[];U>0&&Ve.push(`\u6210\u529F\u5220\u9664 ${U} \u672C\u4E16\u754C\u4E66`),X>0&&Ve.push(`\u6210\u529F\u5220\u9664 ${X} \u4E2A\u6761\u76EE`),re>0&&Ve.push(`\u6210\u529F\u5220\u9664 ${re} \u4E2A\u6B63\u5219`),Ve.length>0?(ve(Ve.join("\uFF0C")),o.multiSelectMode?to():se()):await Q({type:"alert",title:"\u5220\u9664\u5931\u8D25",text:"\u5220\u9664\u9879\u76EE\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002"})}catch(U){P.remove(),console.error("[RegexLoreHub] Batch delete failed:",U),await Q({type:"alert",title:"\u5220\u9664\u5931\u8D25",text:`\u64CD\u4F5C\u5931\u8D25: ${U.message}`}),await We(!0)}}),Cl=B(async()=>{if(!Array.isArray(o.allLorebooks)||o.allLorebooks.length===0){await Q({type:"alert",title:"\u63D0\u793A",text:"\u6CA1\u6709\u627E\u5230\u53EF\u4EE5\u6E05\u7406\u7684\u4E16\u754C\u4E66\u3002"});return}let c=o.allLorebooks.filter(F=>{let P=o.lorebookUsage instanceof Map?o.lorebookUsage.get(F.name):[],U=Array.isArray(P)?P:[];return!F.enabled&&U.length===0}).map(F=>F.name);if(c.length===0){await Q({type:"alert",title:"\u63D0\u793A",text:"\u6CA1\u6709\u627E\u5230\u672A\u542F\u7528\u4E14\u672A\u7ED1\u5B9A\u89D2\u8272\u5361\u7684\u4E16\u754C\u4E66\u3002"});return}o.multiSelectMode=!0,o.multiSelectTarget="book",o.selectedItems.clear(),c.forEach(F=>o.selectedItems.add(Ze(F))),se();let d="\u5C06\u5220\u9664 "+c.length+" \u672C\u672A\u542F\u7528\u4E14\u672A\u7ED1\u5B9A\u89D2\u8272\u5361\u7684\u4E16\u754C\u4E66\u3002\u56E0API\u9650\u5236\uFF0C\u65E0\u6CD5\u76F4\u63A5\u83B7\u53D6\u804A\u5929\u7ED1\u5B9A\u4E16\u754C\u4E66\uFF0C\u5B58\u5728\u8BEF\u5220\u8BE5\u4E16\u754C\u4E66\u7684\u53EF\u80FD\u3002\u786E\u5B9A\u7EE7\u7EED\u5417\uFF1F";try{await Q({type:"confirm",title:"\u786E\u8BA4\u6E05\u7406\u5B64\u7ACB\u4E16\u754C\u4E66",text:d,danger:!0})}catch{return}let y=lr("\u5F00\u59CB\u6E05\u7406\u5B64\u7ACB\u4E16\u754C\u4E66..."),_=[],V=0;try{for(let F=0;F<c.length;F+=1){let P=c[F];if(y.update("\u6B63\u5728\u5220\u9664\u7B2C "+(F+1)+" / "+c.length+" \u672C\u4E16\u754C\u4E66..."),await Y.deleteWorldbook(P)){V+=1,o.allLorebooks=o.allLorebooks.filter(re=>re.name!==P),Yr(P),o.lorebookUsage instanceof Map&&o.lorebookUsage.has(P)&&o.lorebookUsage.delete(P),Array.isArray(o.lorebooks?.character)&&(o.lorebooks.character=o.lorebooks.character.filter(re=>re!==P)),o.chatLorebook===P&&(o.chatLorebook=null),o.activeCharacterBook===P&&(o.activeCharacterBook=null),o.activeBookName===P&&(o.activeBookName=null),o.selectedItems.delete(Ze(P));let X=fr(P);for(let re of[...o.selectedItems])re.startsWith(X)&&o.selectedItems.delete(re)}else _.push(P)}}catch(F){y.remove(),console.error("[RegexLoreHub] Clean orphan lorebooks failed:",F),await Q({type:"alert",title:"\u64CD\u4F5C\u5931\u8D25",text:"\u6E05\u7406\u5B64\u7ACB\u4E16\u754C\u4E66\u65F6\u53D1\u751F\u9519\u8BEF\uFF1A"+(F?.message||F)}),await We(!0);return}y.remove(),V>0&&ve("\u5DF2\u5220\u9664 "+V+" \u672C\u5B64\u7ACB\u4E16\u754C\u4E66"),_.length>0?(o.selectedItems.clear(),_.forEach(F=>o.selectedItems.add(Ze(F))),await Q({type:"alert",title:"\u90E8\u5206\u5220\u9664\u5931\u8D25",text:"\u4EE5\u4E0B\u4E16\u754C\u4E66\u672A\u80FD\u5220\u9664\uFF1A"+_.join("\u3001")})):(o.selectedItems.clear(),o.multiSelectMode=!1),se()}),oo=B(async c=>{let d=new Set,y=new Map,_=new Set,V=!1,F=!1;for(let P of o.selectedItems){let{type:U,bookName:X,entryId:re,regexId:me}=i(P);if(U==="book"&&X)d.add(X);else if(U==="lore"&&X){let ge=Number(re);if(!Number.isFinite(ge))continue;y.has(X)||y.set(X,[]),y.get(X).push(ge)}else if(U==="regex"){let ge=me!=null&&me!==""?String(me):"";ge&&_.add(ge)}}if(d.size>0){let P=new Set(await Y.getGlobalWorldbookNames()||[]);d.forEach(U=>c?P.add(U):P.delete(U)),await Y.rebindGlobalWorldbooks(Array.from(P)),F=!0,d.forEach(U=>{let X=o.allLorebooks.find(re=>re.name===U);X&&(X.enabled=c)})}if(y.size>0)for(let[P,U]of y){let X=[...ne(P)];if(X){let re=U.map(me=>{let ge=X.find(he=>he.uid===me);return ge?(ge.enabled=c,{uid:me,enabled:c}):null}).filter(Boolean);re.length>0&&await Fe(P,re)}}if(await Y.saveSettings(),_.size>0){let P=await Y.getRegexes();P.forEach(U=>{_.has(String(U.id))&&(U.enabled=c)}),await Y.replaceRegexes(P.filter(U=>U.source!=="card")),V=!0,[o.regexes.global,o.regexes.character].forEach(U=>U.forEach(X=>{_.has(String(X.id))&&(X.enabled=c)}))}(F||V)&&await Y.saveSettings(),o.selectedItems.clear(),se()}),Nl=B(async(c,d)=>{let y=r(c.target),_=r(c.currentTarget).closest(".rlh-item-container, .rlh-book-group");if(y.closest(".rlh-item-controls, .rlh-rename-ui").length>0||o.multiSelectMode&&x(_))return;if(!o.multiSelectMode&&o.activeTab==="global-lore"&&o.activeView==="global-lore-list"&&_.is(".rlh-book-group")&&y.closest(".rlh-book-title-wrapper").length>0){let F=_.data("book-name");F&&a?.handleEnterLorebookDetail&&await a.handleEnterLorebookDetail(F);return}if(_.hasClass("from-card")||_.hasClass("renaming"))return;let V=_.find(".rlh-collapsible-content").first();if(_.is(".rlh-book-group")&&o.activeTab!=="global-lore"){V.slideToggle(200);return}if(_.is(".rlh-item-container")){if(V.is(":visible")){V.stop(!0,!0).slideUp(200,()=>{V.off("input.rlh"),V.empty(),V.attr("data-entry-mode","collapsed")}),_.attr("data-entry-mode","collapsed");return}d?.bulk||_.siblings(".rlh-item-container").find(".rlh-collapsible-content:visible").slideUp(200).empty();let F=_.data("type"),P=_.data("id"),U=_.data("searchTerm"),X=_.attr("data-search-term"),re=typeof U=="string"&&U.length>0?U:typeof X=="string"&&X.length>0?X:"";if(F==="lore"){let me=_.data("book-name"),he=[...ne(me)].find(Ce=>Ce.uid===Number(P));if(!he)return;l.renderLoreEntryViewer(_,he,re,{animate:!0});return}if(F==="regex"){let me=[...o.regexes.global,...o.regexes.character].find(he=>he.id===P);if(!me)return;_.attr("data-entry-mode")==="edit"?l.renderRegexEditor(_,me,{animate:!0}):l.renderRegexViewer(_,me,re,{animate:!0});return}}}),Il=B(async c=>{if(!o.multiSelectMode||r(c.target).closest(".rlh-item-controls, .rlh-rename-ui, .rlh-action-btn, .rlh-action-btn-icon, .rlh-toggle-btn, .rlh-selection-control, .rlh-multi-select-checkbox, .rlh-item-header, .rlh-global-book-header").length>0)return;let y=r(c.currentTarget).closest(".rlh-item-container, .rlh-book-group");y.length&&x(y)&&(c.stopPropagation(),c.preventDefault())}),Rl=B(async c=>{c.stopPropagation();let d=r(c.currentTarget),y=d.closest(".rlh-book-group"),_=!y.hasClass("editing-entries");y.toggleClass("editing-entries"),_?(o.multiSelectMode||(o.multiSelectMode=!0,r("#rlh-multi-select-btn",t).addClass("active"),r("#rlh-multi-select-controls",t).addClass("active"),r(`#${ke}`,t).addClass("rlh-multi-select-mode")),y.find(".rlh-collapsible-content").first().slideDown(200),d.attr("title","\u5B8C\u6210\u7F16\u8F91").find("i").removeClass("fa-pen-to-square").addClass("fa-check-square"),d.addClass("active")):(d.attr("title","\u7F16\u8F91/\u9009\u62E9\u6761\u76EE").find("i").removeClass("fa-check-square").addClass("fa-pen-to-square"),d.removeClass("active"))}),Al=B(async c=>{let y=r(c.currentTarget).find("i");y.addClass("fa-spin");let _=null;o.activeView==="global-lore-detail"&&o.activeBookName&&(_=ne(o.activeBookName),console.log(`[RegexLoreHub] \u5168\u5C40\u5237\u65B0\u65F6\u7F13\u5B58\u8BE6\u60C5\u89C6\u56FE\u6761\u76EE: ${o.activeBookName}`)),rt(),await We(!0),_&&o.activeView==="global-lore-detail"&&o.activeBookName&&(Oe(o.activeBookName,_),wr(o.activeBookName),console.log(`[RegexLoreHub] \u6062\u590D\u8BE6\u60C5\u89C6\u56FE\u6761\u76EE: ${o.activeBookName}`),Ie(o.activeBookName,!0).catch(V=>{console.warn(`[RegexLoreHub] \u6062\u590D\u540E\u5237\u65B0\u6761\u76EE\u5931\u8D25: ${o.activeBookName}`,V)}),se()),setTimeout(()=>y.removeClass("fa-spin"),500)}),Ml=B(async c=>{if(o.activeView==="global-lore-list")a?.handleCreateLorebook&&await a.handleCreateLorebook(c);else if(o.activeView==="global-lore-detail"){if(!o.activeBookName)return;if(l?.handleCreateEntry){let d={currentTarget:r(`<button data-book-name="${o.activeBookName}"></button>`)};await l.handleCreateEntry(d)}}});return{handleGlobalSearch:R,handleSearchClear:ce,handleSearchInputKeydown:I,handleReplace:q,handleToolbarToggleCollapse:Z,handleSortMenuToggle:O,handleSortOptionSelect:L,handleThemeMenuToggle:ae,handleThemeOptionSelect:te,handlePositionMenuToggle:br,handlePositionOptionSelect:wt,handleUnifiedStatusMenuToggle:ul,handleUnifiedStatusOptionSelect:bl,handleCharacterBookSwitch:ml,handleSelectionCheckboxChange:gl,togglePanel:xl,switchTab:wl,toggleMultiSelectMode:to,handleSelectAll:Sl,handleSelectNone:_l,handleSelectInvert:El,handleBatchEnable:$l,handleBatchDisable:Tl,handleBatchDelete:Ll,handleCleanOrphanLorebooks:Cl,handleHeaderClick:Nl,handleMultiSelectContainerClick:Il,handleEditEntriesToggle:Rl,handleRefresh:Al,handlePrimaryCreateButtonClick:Ml}}var Xt=e=>!e&&e!==0?"":typeof e=="string"?e.trim():e&&typeof e=="object"&&typeof e.name=="string"?e.name.trim():String(e??"").trim(),cl=()=>typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now(),dl=()=>({handleSelectUnboundBooks:B(async r=>{if(r?.preventDefault?.(),r?.stopPropagation?.(),o.activeView!=="global-lore-list"){ve("\u8BE5\u64CD\u4F5C\u4EC5\u5728\u5168\u5C40\u4E16\u754C\u4E66\u5217\u8868\u89C6\u56FE\u53EF\u7528","info");return}if(o.activeTab!=="global-lore"){ve("\u8BE5\u64CD\u4F5C\u4EC5\u5728\u5168\u5C40\u4E16\u754C\u4E66\u5217\u8868\u53EF\u7528","info");return}let t=cl(),{totalBooks:a,unboundNames:l,statsByName:n}=el(),i=Array.isArray(o.allLorebooks)?o.allLorebooks:[],h=typeof o.globalSearch?.term=="string"?o.globalSearch.term.trim():"",m=h.toLowerCase(),b=Xt(o.activeBookName),v=(!!(m&&m.length)?i.filter(s=>{let g=Xt(s);if(!g)return!1;if(o.searchFilters.bookName&&g.toLowerCase().includes(m))return!0;let R=ne(g);return!Array.isArray(R)||R.length===0?!1:R.some(I=>yr(I,m))}):i).map(s=>{let g=Xt(s);return{book:s,name:g}}).filter(({name:s})=>typeof s=="string"&&s.length>0),w=v.map(({name:s})=>s),E=v.filter(({book:s,name:g})=>{if(!g||b&&g===b||s&&s.enabled)return!1;if(l.has(g))return!0;let x=n.get(g);return x?x.bindingCount===0:!1}).map(({name:s})=>s);if(E.length===0){ve("\u6CA1\u6709\u672A\u7ED1\u5B9A\u7684\u4E16\u754C\u4E66","info"),Mt({category:"lorebook",action:"select_unbound",value:0,label:"global_unbound_select",feature:"select_unbound_lorebooks",view:o.activeView,meta:{searchTerm:h,visibleBookCount:w.length,totalBookCount:a,unboundTotal:l.size}});return}o.multiSelectMode=!0,o.multiSelectTarget="book",o.selectedItems.clear(),E.forEach(s=>{let g=Ze(s);g&&o.selectedItems.add(g)});let T=cl(),A=Math.max(0,Math.round(T-t));se(),ve(`\u5DF2\u9009\u4E2D ${E.length} \u672C\u672A\u7ED1\u5B9A\u7684\u4E16\u754C\u4E66\uFF0C\u8BF7\u786E\u8BA4\u8FD9\u4E9B\u4E16\u754C\u4E66\u672A\u5728\u804A\u5929\u4E2D\u4F7F\u7528\uFF0C\u907F\u514D\u8BEF\u5220\u804A\u5929\u4E16\u754C\u4E66\u3002`,"success"),console.log(`[RegexLoreHub] \u9009\u62E9\u5B64\u7ACB\u4E16\u754C\u4E66\uFF1A\u5339\u914D ${E.length} / \u53EF\u89C1 ${w.length} / \u5168\u91CF ${a}\uFF0C\u8017\u65F6 ${A}ms\u3002`),Mt({category:"lorebook",action:"select_unbound",value:E.length,label:"global_unbound_select",feature:"select_unbound_lorebooks",view:o.activeView,meta:{searchTerm:h,visibleBookCount:w.length,totalBookCount:a,unboundTotal:l.size,selectionCount:E.length,durationMs:A}})})});function hl(){let e=xe(),r=we(),t=$e(),a={$:e,parentDoc:r,parentWin:t},l=al(a),n=nl(a),i=sl({...a,lorebookHandlers:l,itemHandlers:n}),h=dl();return{...l,...n,...i,...h}}var Jt=`
/*! tailwindcss v4.1.16 | MIT License | https://tailwindcss.com */
@layer theme{:root,:host{--rlh-default-transition-duration:.15s;--rlh-default-transition-timing-function:cubic-bezier(.4,0,.2,1)}}@layer utilities{.rlh:opacity-50{opacity:.5}}@layer base{#regex-lore-hub-panel *{text-shadow:none!important}#regex-lore-hub-panel{--rlh-panel-radius:20px;--rlh-focus-ring:0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-focus-ring:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)32%,transparent)}}#regex-lore-hub-panel{--rlh-bg-color:#f7f9fd;--rlh-surface-color:#ffffffeb;--rlh-text-color:#0f172a;--rlh-em-color:#475569;--rlh-border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-border-color:color-mix(in srgb,var(--rlh-accent-color)6%,#d7ddfb 94%)}}#regex-lore-hub-panel{--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)6%,transparent)}}#regex-lore-hub-panel{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)10%,transparent)}}#regex-lore-hub-panel{--rlh-shadow-color:#0f172a1f;--rlh-header-bg:#eef2ffeb;--rlh-input-bg:#fffffff2;--rlh-accent-color:#7c81f6;--rlh-green:#10b981;--rlh-red:#ef4444;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)18%,transparent)}}#regex-lore-hub-panel{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)18%,transparent)}}#regex-lore-hub-panel{--rlh-status-constant:#22c55e;--rlh-status-selective:#3b82f6;--rlh-status-vectorized:#a855f7;--rlh-primary-btn-text-color:#fff;--rlh-danger-btn-text-color:#fff;--rlh-disabled-muted-base:#94a3b8;--rlh-disabled-text-strength:55%;--rlh-disabled-text-color:var(--rlh-disabled-muted-base)}#regex-lore-hub-panel input,#regex-lore-hub-panel select,#regex-lore-hub-panel textarea,#regex-lore-hub-panel button{color:var(--rlh-text-color)!important}#regex-lore-hub-panel input,#regex-lore-hub-panel select,#regex-lore-hub-panel textarea{background-color:var(--rlh-input-bg)!important;border-color:var(--rlh-border-color)!important}#regex-lore-hub-panel input::placeholder,#regex-lore-hub-panel textarea::placeholder{color:var(--rlh-text-color);opacity:.6}#regex-lore-hub-panel.dark{--rlh-bg-color:#101827;--rlh-surface-color:#111827cc;--rlh-text-color:#f9fafb;--rlh-em-color:#cbd5e1;--rlh-border-color:#2d3748;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)14%,transparent)}}#regex-lore-hub-panel.dark{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)22%,transparent)}}#regex-lore-hub-panel.dark{--rlh-shadow-color:#02061780;--rlh-header-bg:#0f172ae6;--rlh-input-bg:#1f2937d9;--rlh-accent-color:#6366f1;--rlh-green:#10b981;--rlh-red:#fb7185;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)20%,transparent)}}#regex-lore-hub-panel.dark{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)20%,transparent)}}#regex-lore-hub-panel.dark{--rlh-status-constant:#34d399;--rlh-status-selective:#60a5fa;--rlh-status-vectorized:#c084fc;--rlh-primary-btn-text-color:#fff;--rlh-danger-btn-text-color:#fff;--rlh-disabled-muted-base:#64748b;--rlh-disabled-text-strength:45%}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-bg-color:#f9f5d7;--rlh-surface-color:#fbf1c7eb;--rlh-text-color:#3c3836;--rlh-em-color:#7c6f64;--rlh-border-color:#d5ab7e;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)16%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)26%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-shadow-color:#3c383633;--rlh-header-bg:#ebdbb2d9;--rlh-input-bg:#fbf1c7e6;--rlh-accent-color:#d65d0e;--rlh-green:#98971a;--rlh-red:#cc241d;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)18%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)18%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-status-constant:#98971a;--rlh-status-selective:#458588;--rlh-status-vectorized:#b16286;--rlh-primary-btn-text-color:#fbf1c7;--rlh-danger-btn-text-color:#fbf1c7;--rlh-disabled-muted-base:#282828;--rlh-disabled-text-strength:60%}#regex-lore-hub-panel.rlh-theme-gruvbox-dark{--rlh-bg-color:#1d2021;--rlh-surface-color:#282828;--rlh-text-color:#ebdbb2;--rlh-em-color:#bdae93;--rlh-border-color:#3c3836;--rlh-hover-bg:#fe80191f;--rlh-selected-bg:#fe801938;--rlh-shadow-color:#08080899;--rlh-header-bg:#282828eb;--rlh-input-bg:#282828eb;--rlh-accent-color:#fe8019;--rlh-green:#b8bb26;--rlh-red:#fb4934;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox-dark{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)22%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox-dark{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox-dark{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)22%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox-dark{--rlh-status-constant:#b8bb26;--rlh-status-selective:#83a598;--rlh-status-vectorized:#d3869b;--rlh-primary-btn-text-color:#ebdbb2;--rlh-danger-btn-text-color:#ebdbb2;--rlh-disabled-muted-base:#bdae93;--rlh-disabled-text-strength:55%}#regex-lore-hub-panel.rlh-theme-slate-dim{--rlh-bg-color:#1f2933;--rlh-surface-color:#27323f;--rlh-text-color:#e2e8f0;--rlh-em-color:#cbd5e1;--rlh-border-color:#324558;--rlh-hover-bg:#38b2ac1a;--rlh-selected-bg:#38b2ac2e;--rlh-shadow-color:#060c1480;--rlh-header-bg:#27323ff0;--rlh-input-bg:#27323feb;--rlh-accent-color:#38b2ac;--rlh-green:#34d399;--rlh-red:#f97316;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-slate-dim{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)20%,transparent)}}#regex-lore-hub-panel.rlh-theme-slate-dim{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-slate-dim{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)20%,transparent)}}#regex-lore-hub-panel.rlh-theme-slate-dim{--rlh-status-constant:#38b2ac;--rlh-status-selective:#38bdf8;--rlh-status-vectorized:#a855f7;--rlh-primary-btn-text-color:#fff;--rlh-danger-btn-text-color:#fff;--rlh-disabled-muted-base:#94a3b8;--rlh-disabled-text-strength:50%}#regex-lore-hub-panel.rlh-theme-aurora{--rlh-bg-color:#e8f8f7;--rlh-surface-color:#f3fffe;--rlh-text-color:#1d2a2a;--rlh-em-color:#4b5d5d;--rlh-border-color:#c4e5e3;--rlh-hover-bg:#00a6a61a;--rlh-selected-bg:#00a6a62e;--rlh-shadow-color:#09262d29;--rlh-header-bg:#e8f8f7f2;--rlh-input-bg:#f3fffef2;--rlh-accent-color:#00a6a6;--rlh-green:#16a34a;--rlh-red:#dc2626;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-aurora{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)18%,transparent)}}#regex-lore-hub-panel.rlh-theme-aurora{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-aurora{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)18%,transparent)}}#regex-lore-hub-panel.rlh-theme-aurora{--rlh-status-constant:#16a34a;--rlh-status-selective:#0284c7;--rlh-status-vectorized:#0f766e;--rlh-primary-btn-text-color:#1d2a2a;--rlh-danger-btn-text-color:#fff;--rlh-disabled-muted-base:#4b5d5d;--rlh-disabled-text-strength:50%}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-disabled-text-color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-disabled-text-color:color-mix(in srgb,var(--rlh-text-color)var(--rlh-disabled-text-strength,60%),var(--rlh-disabled-muted-base))}}}@keyframes rlhFadeInUp{0%{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}@keyframes rlhSoftPulse{}@keyframes rlhToastIn{0%{opacity:0;transform:translate(-50%)translateY(28px)scale(.96)}60%{opacity:1;transform:translate(-50%)translateY(-4px)scale(1.02)}to{opacity:1;transform:translate(-50%)translateY(0)scale(1)}}@keyframes rlhHighlightPulse{0%{background-color:#fde68a}50%{background-color:#facc15}to{background-color:#fde68a}}}@layer components{.rlh-h1{color:var(--rlh-text-color);margin:0 0 .75rem;font-size:clamp(1.125rem,2.2vw,1.5rem);font-weight:600;line-height:1.2}.rlh-h2{color:var(--rlh-text-color);margin:1rem 0 .625rem;font-size:clamp(1rem,1.8vw,1.25rem);font-weight:600;line-height:1.25}.rlh-h3{color:var(--rlh-text-color);text-transform:none;letter-spacing:normal;margin:.75rem 0 .5rem;font-size:.95rem;font-weight:600;line-height:1.3}.rlh-body{color:var(--rlh-text-color);margin:.5rem 0;font-size:.9rem;line-height:1.5}.rlh-muted{color:var(--rlh-em-color);margin:.375rem 0;font-size:.8125rem;line-height:1.4}#regex-lore-hub-panel{z-index:10000;width:100%;height:100%;color:var(--rlh-text-color);background:var(--rlh-bg-color);justify-content:center;align-items:stretch;padding:clamp(.8rem,1.5vw,1.3rem);display:none;position:absolute;inset:0}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{background:color-mix(in srgb,var(--rlh-bg-color)92%,transparent)}}#regex-lore-hub-panel{-webkit-backdrop-filter:blur(24px);backdrop-filter:blur(24px);font-family:Inter,Segoe UI,Microsoft YaHei,sans-serif;transition:opacity .25s}@media (max-width:1024px){#regex-lore-hub-panel{justify-content:flex-start;align-items:stretch}}#regex-lore-hub-panel .rlh-shell{border-radius:var(--rlh-panel-radius);background:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);width:min(1250px,100%);height:100%;box-shadow:0 2px 8px -4px var(--rlh-shadow-color);flex-direction:column;gap:clamp(.45rem,1vw,.75rem);max-height:100%;margin:0 auto;padding:clamp(.6rem,1.2vw,.95rem);animation:.3s ease-out both rlhFadeInUp;display:flex;position:relative;overflow:hidden auto}#regex-lore-hub-panel .rlh-shell:before{content:"";background:radial-gradient(circle at top right,var(--rlh-accent-color)0%,transparent 60%),radial-gradient(circle at bottom left,var(--rlh-green)0%,transparent 65%);position:absolute;inset:-140px}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-shell:before{background:radial-gradient(circle at top right,color-mix(in srgb,var(--rlh-accent-color)24%,transparent)0%,transparent 60%),radial-gradient(circle at bottom left,color-mix(in srgb,var(--rlh-green)18%,transparent)0%,transparent 65%)}}#regex-lore-hub-panel .rlh-shell:before{opacity:.32;pointer-events:none}@media (max-width:640px){#regex-lore-hub-panel .rlh-shell{border-radius:14px;padding:.55rem}}@media (min-width:1360px){#regex-lore-hub-panel .rlh-shell{border-radius:20px;padding:1.05rem 1.3rem}}.rlh-shell-header{justify-content:space-between;align-items:center;gap:.55rem;padding-block:.08rem;display:flex}.rlh-shell-title{flex-direction:column;gap:.18rem;display:flex}.rlh-shell-title h4{color:var(--rlh-text-color);margin:0;font-size:clamp(1rem,2vw,1.3rem);font-weight:600;line-height:1.2}.rlh-shell-meta{color:var(--rlh-em-color);align-items:center;gap:.35rem;font-size:max(.8125rem,13px);line-height:1.2;display:inline-flex;margin:0!important}.rlh-shell-version{background:var(--rlh-accent-color);border-radius:9999px;align-items:center;padding:.1rem .55rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-shell-version{background:color-mix(in srgb,var(--rlh-accent-color)16%,transparent)}}.rlh-shell-version{color:var(--rlh-text-color);font-size:.78rem;font-weight:600}.rlh-shell-updated{color:var(--rlh-em-color);font-size:.78rem}.rlh-shell-actions{align-items:center;gap:.4rem;display:flex}.rlh-shell-right{align-items:center;gap:.6rem;margin-left:auto;display:flex}.rlh-prefetch-indicator{text-align:right;flex-direction:column;align-items:flex-end;gap:.35rem;width:clamp(200px,34vw,320px);display:none}.rlh-prefetch-indicator[data-visible=true]{display:flex}.rlh-prefetch-text{color:var(--rlh-em-color);white-space:normal;font-size:.78rem}#rlh-prefetch-progress-text{width:100%}.rlh-prefetch-bar{background:var(--rlh-accent-color);border-radius:9999px;width:100%;height:4px;position:relative}@supports (color:color-mix(in lab, red, red)){.rlh-prefetch-bar{background:color-mix(in srgb,var(--rlh-accent-color)20%,transparent)}}.rlh-prefetch-bar{overflow:hidden}.rlh-prefetch-bar-inner{border-radius:inherit;background:var(--rlh-accent-color);width:0%;height:100%;transition:width .25s;display:block}.rlh-icon-button,.rlh-close-button{border:1px solid var(--rlh-border-color);border-radius:9999px;justify-content:center;align-items:center;width:2.25rem;height:2.25rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-icon-button,.rlh-close-button{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-icon-button,.rlh-close-button{background-color:var(--rlh-surface-color);color:var(--rlh-text-color);cursor:pointer;transition:color .2s,background-color .2s,border-color .2s}.rlh-icon-button:hover,.rlh-close-button:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-icon-button:hover,.rlh-close-button:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-theme-toggle{border:1px solid var(--rlh-accent-color);border-radius:9999px;align-items:center;gap:.35rem;padding:.4rem .9rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle{border:1px solid color-mix(in srgb,var(--rlh-accent-color)28%,transparent)}}.rlh-theme-toggle{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle{background-color:color-mix(in srgb,var(--rlh-accent-color)12%,transparent)}}.rlh-theme-toggle{color:var(--rlh-text-color);cursor:pointer;font-size:.85rem;font-weight:500;transition:background-color .2s,color .2s,border-color .2s}.rlh-theme-toggle:hover{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)18%,transparent)}}.rlh-theme-toggle .rlh-theme-toggle-label{white-space:nowrap}.rlh-theme-toggle-caret{margin-left:.45rem;font-size:.78rem;transition:transform .2s}.rlh-theme-menu{align-items:center;display:inline-flex;position:relative}.rlh-theme-menu-list{min-width:12rem;padding:.55rem}.rlh-theme-option{justify-content:space-between;align-items:center;gap:.6rem;width:100%;padding:.45rem .65rem;display:flex}.rlh-theme-option-text{flex-direction:column;align-items:flex-start;gap:.18rem;display:flex}.rlh-theme-option-meta{color:var(--rlh-em-color);font-size:.78rem}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option-meta{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-theme-option-check{color:var(--rlh-accent-color);opacity:0;transition:opacity .18s,transform .18s;transform:scale(.92)}.rlh-theme-option[data-active=true] .rlh-theme-option-check{opacity:1;transform:scale(1)}.rlh-theme-option[data-active=true]{background-color:var(--rlh-selected-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option[data-active=true]{background-color:color-mix(in srgb,var(--rlh-selected-bg)72%,transparent)}}.rlh-theme-option[data-active=true]{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option[data-active=true]{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-theme-option[data-active=true]{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option[data-active=true]{color:color-mix(in srgb,var(--rlh-text-color)88%,var(--rlh-accent-color)12%)}}.rlh-theme-option[data-active=true] .rlh-theme-option-meta{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option[data-active=true] .rlh-theme-option-meta{color:color-mix(in srgb,var(--rlh-em-color)65%,var(--rlh-accent-color)20%)}}.rlh-theme-menu.open .rlh-theme-toggle-caret{transform:rotate(180deg)}.rlh-tab-nav{background-color:var(--rlh-header-bg);flex-wrap:wrap;gap:.4rem;padding:.35rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-tab-nav{background-color:color-mix(in srgb,var(--rlh-header-bg)85%,transparent)}}.rlh-tab-nav{border:1px solid var(--rlh-border-color);border-radius:9999px}@supports (color:color-mix(in lab, red, red)){.rlh-tab-nav{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-tab{color:var(--rlh-em-color);cursor:pointer;border-radius:9999px;justify-content:center;align-items:center;gap:.55rem;padding:.4rem 1.1rem;font-size:.9rem;font-weight:500;transition:color .2s,background-color .2s,transform .2s;display:inline-flex}.rlh-tab:hover{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color)}.rlh-tab.active{background-color:var(--rlh-selected-bg);color:var(--rlh-text-color);box-shadow:inset 0 0 0 1px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-tab.active{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)60%,transparent)}}.rlh-tab-text-short{display:none}@media (max-width:640px){.rlh-tab-nav{gap:.3rem;padding:.3rem}.rlh-tab{gap:.4rem;padding:.32rem .85rem;font-size:.85rem}.rlh-tab-text-full{display:none}.rlh-tab-text-short{display:inline}#regex-lore-hub-panel{padding:.55rem}#regex-lore-hub-panel .rlh-shell{gap:.5rem;padding:.45rem .55rem}.rlh-main-area{gap:.55rem}.rlh-toolbar-shell,.rlh-toolbar-container,.rlh-replace-container{gap:.5rem}.rlh-toolbar-inner{gap:.22rem;padding:.45rem}.rlh-toolbar-section{gap:.3rem;padding:.3rem}.rlh-toolbar-btn{border-radius:10px;padding:.08rem .55rem;font-size:.84rem}.rlh-toolbar-btn i,.rlh-toolbar-btn span{font-size:.82rem}#regex-lore-hub-panel-content{padding-right:.3rem}#regex-lore-hub-panel-content>*+*{margin-top:.65rem}.rlh-shell-title h4{font-size:.92rem}.rlh-shell-meta{font-size:.76rem}.rlh-book-group-header,.rlh-item-header{padding:.7rem .75rem}.rlh-book-group-title{font-size:.95rem}.rlh-item-name{font-size:.86rem}.rlh-item-meta{font-size:.7rem}.rlh-book-group,.rlh-item-container{box-shadow:0 10px 28px -26px var(--rlh-shadow-color);background-color:var(--rlh-surface-color);border-radius:10px}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{background-color:color-mix(in srgb,var(--rlh-surface-color)97%,transparent)}}.rlh-entry-actions{gap:.35rem;padding:.55rem .65rem}.rlh-action-btn{border-radius:10px;padding:.36rem .6rem;font-size:.82rem}.rlh-toggle-btn i,.rlh-action-btn-icon i{font-size:.78rem}.rlh-detail-view{box-shadow:0 18px 48px -38px var(--rlh-shadow-color);border-radius:14px;gap:.45rem;padding:.45rem .6rem}.rlh-detail-header{padding:.32rem .5rem}.rlh-detail-content{gap:.32rem}.rlh-entry-list-wrapper{gap:.28rem;padding:.25rem 0}.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{border-radius:8px;padding:.35rem .46rem}.rlh-global-book-header,.rlh-item-header{gap:.45rem;padding:.6rem .7rem}.rlh-book-group-header{padding:.6rem .7rem}.rlh-item-header-main{gap:.3rem}.rlh-item-title-row{gap:.28rem}.rlh-status-badge{padding:.12rem .46rem}#regex-lore-hub-panel #rlh-search-filters-container,#regex-lore-hub-panel .rlh-filter-list{gap:.3rem}#regex-lore-hub-panel .rlh-filter-item{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-filter-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)65%,transparent)}}#regex-lore-hub-panel .rlh-filter-item{border-radius:10px;gap:.4rem;padding:.3rem .6rem;font-size:.8rem}}.rlh-main-area{flex-direction:column;flex:auto;gap:clamp(.6rem,1.4vw,1rem);width:100%;min-height:0;padding:0;display:flex}.rlh-toolbar-shell{flex-direction:column;gap:clamp(.6rem,1.3vw,.95rem);width:100%;display:flex}.rlh-toolbar-container,.rlh-replace-container{flex-direction:column;gap:clamp(.65rem,1.1vw,.9rem);display:flex}.rlh-toolbar-inner{background-color:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:clamp(.125rem,.3vw,.25rem);padding:clamp(.25rem,.5vw,.4rem);display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{background-color:color-mix(in srgb,var(--rlh-surface-color)95%,var(--rlh-accent-color)5%)}}.rlh-toolbar-inner{border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{border:1px solid color-mix(in srgb,var(--rlh-accent-color)24%,var(--rlh-border-color))}}.rlh-toolbar-inner{box-shadow:0 2px 8px -4px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{box-shadow:0 2px 8px -4px color-mix(in srgb,var(--rlh-shadow-color)70%,transparent)}}@media (max-width:640px){.rlh-toolbar-inner{border-radius:14px;padding:.55rem}.rlh-toolbar-section{gap:.4rem;padding:.45rem}}@media (min-width:1360px){.rlh-toolbar-inner{gap:1.1rem;padding:1.05rem 1.3rem}.rlh-toolbar-section{gap:.8rem;padding:.6rem .8rem}}.rlh-toolbar-section{background-color:#0000;border:none;border-radius:12px;flex-direction:column;gap:clamp(.1rem,.3vw,.2rem);padding:clamp(.1rem,.25vw,.2rem);display:flex}.rlh-toolbar-section--search,.rlh-toolbar-section--actions,.rlh-toolbar-section--multiselect{background-color:#0000}.rlh-toolbar-section--actions{flex-direction:row;align-items:center}.rlh-search-section-grid{flex-wrap:nowrap;align-items:stretch;gap:clamp(.25rem,.7vw,.5rem);display:flex}.rlh-search-section-main{flex:18rem;min-width:0}.rlh-search-section-multiselect{flex:0 14rem;justify-content:flex-start;align-items:flex-start;min-width:10rem;max-width:20rem;padding:5px 0 0;display:flex}.rlh-search-section-multiselect .rlh-multi-select-module{flex-direction:column;align-items:flex-start;gap:.25rem;width:100%;display:flex}.rlh-toolbar-section--actions .rlh-toolbar-actions{flex-wrap:wrap;justify-content:flex-start;align-items:center;gap:clamp(.25rem,.6vw,.45rem);width:100%;display:flex;overflow:visible}.rlh-toolbar-section--actions .rlh-toolbar-actions>*{flex-shrink:0}@media (max-width:1024px){.rlh-search-section-grid{flex-direction:column}.rlh-search-section-main,.rlh-search-section-multiselect{flex:100%;max-width:none}.rlh-search-box{grid-template-columns:minmax(0,1fr);grid-template-areas:"row""replace""meta"}.rlh-replace-body{grid-template-columns:minmax(0,1fr) auto}}.rlh-content-pane{flex-direction:column;flex:auto;gap:clamp(.8rem,1.6vw,1.2rem);min-height:0;padding:0;display:flex;overflow:visible}.rlh-content-pane>*{min-width:0}@media (max-width:1024px){.rlh-content-pane{gap:.6rem}}.rlh-toolbar-btn{border:1px solid var(--rlh-accent-color);border-radius:12px;justify-content:flex-start;align-items:center;gap:.35rem;padding:.125rem .75rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{border:1px solid color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-toolbar-btn{color:var(--rlh-text-color);cursor:pointer;box-shadow:inset 0 0 0 1px var(--rlh-accent-color);font-size:.85rem;font-weight:500}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)25%,transparent)}}.rlh-toolbar-btn{transition:color .2s,background-color .2s,border-color .2s,box-shadow .2s,transform .2s}.rlh-toolbar-icon-btn{border:1px solid var(--rlh-accent-color);border-radius:12px;justify-content:center;align-items:center;width:2.1rem;height:2.1rem;padding:0;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{border:1px solid color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}.rlh-toolbar-icon-btn{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-toolbar-icon-btn{color:var(--rlh-text-color);cursor:pointer;line-height:1;transition:color .2s,background-color .2s,border-color .2s,box-shadow .2s,transform .2s}.rlh-toolbar-icon-btn i{font-size:.95rem}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)92%,var(--rlh-accent-color)20%)}}.rlh-toolbar-icon-btn:focus{box-shadow:0 0 0 2px var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:focus{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-search-row .rlh-toolbar-icon-btn,.rlh-replace-body .rlh-toolbar-icon-btn{width:2rem;height:2rem}.rlh-toolbar-btn i{font-size:.95rem}.rlh-toggle-btn i,.rlh-action-btn-icon i,.rlh-toolbar-btn i{transition:transform .25s}.rlh-toolbar-btn span{white-space:nowrap}.rlh-toggle-btn:hover i,.rlh-action-btn-icon:hover i,.rlh-toolbar-btn:hover i{transform:translateY(-1px)scale(1.08)}.rlh-toolbar-group--leading .rlh-toolbar-btn,.rlh-toolbar-group--actions .rlh-toolbar-btn{width:100%}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)26%,var(--rlh-surface-color))}}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-border-color)30%)}}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent),0 10px 22px -16px var(--rlh-shadow-color)}}.rlh-toolbar-btn:hover{color:var(--rlh-text-color);transform:translateY(-1px)scale(1.01)}.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{cursor:not-allowed;opacity:.55;box-shadow:none;border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{border-color:color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{color:color-mix(in srgb,var(--rlh-text-color)55%,var(--rlh-surface-color)45%)}}.rlh-toolbar-btn:focus-visible{box-shadow:0 0 0 2px var(--rlh-accent-color),inset 0 0 0 1.5px var(--rlh-accent-color);outline:none;animation:1.1s ease-out rlhSoftPulse}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:focus-visible{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)40%,transparent),inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-toolbar-btn.active{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{background-color:color-mix(in srgb,var(--rlh-accent-color)32%,var(--rlh-surface-color))}}.rlh-toolbar-btn.active{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{border-color:color-mix(in srgb,var(--rlh-accent-color)75%,var(--rlh-border-color)25%)}}.rlh-toolbar-btn.active{box-shadow:inset 0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)50%,transparent)}}.rlh-toolbar-btn.active{color:var(--rlh-text-color)}#regex-lore-hub-panel .rlh-toolbar-btn,#regex-lore-hub-panel .rlh-toolbar-btn:hover,#regex-lore-hub-panel .rlh-toolbar-btn.active{color:var(--rlh-text-color)!important}#regex-lore-hub-panel .rlh-toolbar-btn:disabled,#regex-lore-hub-panel .rlh-toolbar-btn.disabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-toolbar-btn:disabled,#regex-lore-hub-panel .rlh-toolbar-btn.disabled{color:color-mix(in srgb,var(--rlh-text-color)55%,var(--rlh-surface-color)45%)}}#regex-lore-hub-panel .rlh-toolbar-icon-btn,#regex-lore-hub-panel .rlh-action-btn-icon,#regex-lore-hub-panel .rlh-toggle-btn,#regex-lore-hub-panel .rlh-icon-button,#regex-lore-hub-panel .rlh-close-button,#regex-lore-hub-panel .rlh-search-action-btn,#regex-lore-hub-panel .rlh-multi-select-action-btn{color:var(--rlh-text-color)!important}#regex-lore-hub-panel .rlh-multi-select-action-btn.enable{color:var(--rlh-green)!important}#regex-lore-hub-panel .rlh-multi-select-action-btn.rlh-btn-danger,#regex-lore-hub-panel .rlh-multi-select-action-btn.disable.rlh-btn-danger{background-color:var(--rlh-red)!important;border-color:var(--rlh-red)!important;color:var(--rlh-danger-btn-text-color)!important}#regex-lore-hub-panel .rlh-multi-select-action-btn.rlh-btn-danger:hover,#regex-lore-hub-panel .rlh-multi-select-action-btn.disable.rlh-btn-danger:hover{background-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-multi-select-action-btn.rlh-btn-danger:hover,#regex-lore-hub-panel .rlh-multi-select-action-btn.disable.rlh-btn-danger:hover{background-color:color-mix(in srgb,var(--rlh-red)85%,black 15%)!important}}#regex-lore-hub-panel .rlh-multi-select-action-btn.rlh-btn-danger:hover,#regex-lore-hub-panel .rlh-multi-select-action-btn.disable.rlh-btn-danger:hover{border-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-multi-select-action-btn.rlh-btn-danger:hover,#regex-lore-hub-panel .rlh-multi-select-action-btn.disable.rlh-btn-danger:hover{border-color:color-mix(in srgb,var(--rlh-red)85%,black 15%)!important}}#regex-lore-hub-panel .rlh-multi-select-action-btn.disable:not(.rlh-btn-danger){color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-multi-select-action-btn.disable:not(.rlh-btn-danger){color:color-mix(in srgb,var(--rlh-text-color)55%,var(--rlh-surface-color)45%)}}#regex-lore-hub-panel .rlh-multi-select-action-btn.disable:not(.rlh-btn-danger){border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-multi-select-action-btn.disable:not(.rlh-btn-danger){border-color:color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}#regex-lore-hub-panel .rlh-multi-select-action-btn.disable:not(.rlh-btn-danger){background-color:var(--rlh-surface-color)}#regex-lore-hub-panel .rlh-rename-save-btn{color:var(--rlh-green)!important}#regex-lore-hub-panel .rlh-rename-cancel-btn{color:var(--rlh-red)!important}#regex-lore-hub-panel .rlh-toolbar-toggle-btn{color:var(--rlh-text-color)!important}#regex-lore-hub-panel .rlh-toolbar-toggle-btn:hover{color:var(--rlh-accent-color)!important}#regex-lore-hub-panel .rlh-action-btn{color:var(--rlh-primary-btn-text-color)!important}#regex-lore-hub-panel .rlh-action-btn.rlh-maximize-btn,#regex-lore-hub-panel .rlh-modal-btn{color:var(--rlh-text-color)!important}#regex-lore-hub-panel .rlh-modal-btn.rlh-modal-ok{color:var(--rlh-primary-btn-text-color)!important}#regex-lore-hub-panel .rlh-modal-btn.rlh-modal-cancel,#regex-lore-hub-panel .rlh-error-retry-btn{color:var(--rlh-red)!important}#regex-lore-hub-panel .rlh-error-retry-btn:hover{color:var(--rlh-danger-btn-text-color)!important}.rlh-input{border:1px solid var(--rlh-border-color);border-radius:10px;padding:.45rem .65rem}@supports (color:color-mix(in lab, red, red)){.rlh-input{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-input{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);transition:border-color .2s,box-shadow .2s}.rlh-input:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-input:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-input:focus{box-shadow:var(--rlh-focus-ring)}.rlh-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-input.rlh-input-error,.rlh-editor-field input.rlh-input-error,.rlh-editor-field textarea.rlh-input-error,.rlh-editor-field select.rlh-input-error{border-color:var(--rlh-red)!important;background-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){.rlh-input.rlh-input-error,.rlh-editor-field input.rlh-input-error,.rlh-editor-field textarea.rlh-input-error,.rlh-editor-field select.rlh-input-error{background-color:color-mix(in srgb,var(--rlh-red)8%,var(--rlh-input-bg))!important}}.rlh-input.rlh-input-error,.rlh-editor-field input.rlh-input-error,.rlh-editor-field textarea.rlh-input-error,.rlh-editor-field select.rlh-input-error{box-shadow:0 0 0 3px var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-input.rlh-input-error,.rlh-editor-field input.rlh-input-error,.rlh-editor-field textarea.rlh-input-error,.rlh-editor-field select.rlh-input-error{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-red)20%,transparent)}}.rlh-input.rlh-input-error:hover,.rlh-editor-field input.rlh-input-error:hover,.rlh-editor-field textarea.rlh-input-error:hover,.rlh-editor-field select.rlh-input-error:hover{background-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){.rlh-input.rlh-input-error:hover,.rlh-editor-field input.rlh-input-error:hover,.rlh-editor-field textarea.rlh-input-error:hover,.rlh-editor-field select.rlh-input-error:hover{background-color:color-mix(in srgb,var(--rlh-red)12%,var(--rlh-input-bg))!important}}.rlh-input.rlh-input-error:focus,.rlh-editor-field input.rlh-input-error:focus,.rlh-editor-field textarea.rlh-input-error:focus,.rlh-editor-field select.rlh-input-error:focus{border-color:var(--rlh-red)!important;background-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){.rlh-input.rlh-input-error:focus,.rlh-editor-field input.rlh-input-error:focus,.rlh-editor-field textarea.rlh-input-error:focus,.rlh-editor-field select.rlh-input-error:focus{background-color:color-mix(in srgb,var(--rlh-red)8%,var(--rlh-input-bg))!important}}.rlh-input.rlh-input-error:focus,.rlh-editor-field input.rlh-input-error:focus,.rlh-editor-field textarea.rlh-input-error:focus,.rlh-editor-field select.rlh-input-error:focus{box-shadow:0 0 0 3px var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-input.rlh-input-error:focus,.rlh-editor-field input.rlh-input-error:focus,.rlh-editor-field textarea.rlh-input-error:focus,.rlh-editor-field select.rlh-input-error:focus{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-red)30%,transparent)}}.rlh-search-field{border:1px solid var(--rlh-border-color);border-radius:10px;align-items:center;gap:0;width:100%;min-width:0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-field{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-field{background-color:var(--rlh-input-bg);transition:border-color .2s,box-shadow .2s,color .2s;overflow:hidden}.rlh-search-row{grid-area:row;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:.125rem;width:100%;display:grid}.rlh-search-box{border:1px solid var(--rlh-border-color);border-radius:10px;grid-template-columns:minmax(0,1fr) auto;grid-template-areas:"row replace""meta meta";gap:.125rem;padding:.2rem .3rem;display:grid}@supports (color:color-mix(in lab, red, red)){.rlh-search-box{border:1px solid color-mix(in srgb,var(--rlh-border-color)45%,transparent)}}.rlh-search-box{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-box{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,transparent)}}.rlh-search-box{box-shadow:0 1px 4px -2px var(--rlh-shadow-color)}.rlh-search-field .rlh-search-input{min-width:0;color:inherit;background:0 0;border:none;flex:auto;padding:.45rem .65rem;font-size:1rem}.rlh-search-field .rlh-search-input:focus{box-shadow:none;border:none;outline:none}.rlh-search-field:focus-within{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-field:focus-within{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-search-field:focus-within{box-shadow:var(--rlh-focus-ring);color:var(--rlh-text-color)}.rlh-search-meta{color:var(--rlh-em-color);flex-direction:row;grid-area:meta;align-items:center;gap:.4rem;font-size:.85rem;display:flex}.rlh-search-scope{color:var(--rlh-accent-color);font-weight:500}@supports (color:color-mix(in lab, red, red)){.rlh-search-scope{color:color-mix(in srgb,var(--rlh-accent-color)65%,var(--rlh-text-color))}}@media (max-width:1024px){.rlh-search-section-grid{flex-direction:column}.rlh-search-section-main,.rlh-search-section-multiselect{flex:100%;max-width:none}.rlh-search-box{grid-template-columns:minmax(0,1fr);grid-template-areas:"row""replace""meta"}.rlh-replace-body{grid-template-columns:minmax(0,1fr) auto}.rlh-search-meta{flex-wrap:wrap;justify-content:flex-start;gap:.35rem}}.rlh-sort-menu,.rlh-position-menu{align-items:center;width:auto;min-width:0;margin-left:auto;display:inline-flex;position:relative}.rlh-unified-status{align-items:stretch;min-width:0;display:inline-flex;position:relative}.rlh-unified-status-menu{border:1px solid var(--rlh-border-color);border-radius:12px;flex-direction:column;gap:.15rem;min-width:12rem;padding:.5rem;display:flex;position:absolute;top:calc(100% + .5rem);right:0}@supports (color:color-mix(in lab, red, red)){.rlh-unified-status-menu{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-unified-status-menu{background:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-unified-status-menu{background:color-mix(in srgb,var(--rlh-surface-color)95%,transparent)}}.rlh-unified-status-menu{box-shadow:0 24px 60px -28px var(--rlh-shadow-color);opacity:0;pointer-events:none;z-index:30;transition:opacity .18s,transform .18s;transform:translateY(8px)}.rlh-unified-status[data-open=true] .rlh-unified-status-menu{opacity:1;pointer-events:auto;transform:translate(0)}.rlh-unified-status-option{width:100%;color:inherit;cursor:pointer;background:0 0;border:none;border-radius:10px;justify-content:space-between;align-items:center;gap:.6rem;padding:.45rem .5rem;font-size:.85rem;font-weight:500;transition:background-color .18s,color .18s;display:flex}.rlh-unified-status-option:hover,.rlh-unified-status-option:focus-visible{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-unified-status-option:hover,.rlh-unified-status-option:focus-visible{background:color-mix(in srgb,var(--rlh-hover-bg)75%,transparent)}}.rlh-unified-status-option:hover,.rlh-unified-status-option:focus-visible{outline:none}.rlh-unified-status-option__label{text-align:right;flex:auto;min-width:0}.rlh-sort-menu-list,.rlh-position-menu-list{background-color:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);border-radius:14px;min-width:10rem;padding:.5rem;list-style:none;position:absolute;top:calc(100% + .5rem);right:0}@supports (color:color-mix(in lab, red, red)){.rlh-sort-menu-list,.rlh-position-menu-list{border:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-sort-menu-list,.rlh-position-menu-list{box-shadow:0 24px 60px -36px var(--rlh-shadow-color);z-index:99;opacity:0;visibility:hidden;pointer-events:none;transition:opacity var(--rlh-default-transition-duration)var(--rlh-default-transition-timing-function),transform var(--rlh-default-transition-duration)var(--rlh-default-transition-timing-function),visibility 0s linear var(--rlh-default-transition-duration);will-change:opacity,transform;flex-direction:column;gap:.35rem;display:flex;transform:translateY(6px)scale(.98)}.rlh-toolbar-group--actions .rlh-sort-menu-list,.rlh-toolbar-group--actions .rlh-position-menu-list{left:0;right:auto}.rlh-sort-menu.open .rlh-sort-menu-list,.rlh-position-menu.open .rlh-position-menu-list{opacity:1;visibility:visible;pointer-events:auto;transition-delay:0s,0s,0s;transform:translateY(0)scale(1)}.rlh-sort-option,.rlh-position-option{width:100%;color:var(--rlh-text-color);cursor:pointer;background-color:#0000;border:1px solid #0000;border-radius:10px;justify-content:space-between;align-items:center;gap:.4rem;padding:.4rem .6rem;font-size:.9rem;transition:background-color .2s,border-color .2s,color .2s;display:flex}.rlh-sort-option:hover,.rlh-position-option:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option:hover,.rlh-position-option:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-sort-option.active,.rlh-position-option.active{background-color:var(--rlh-selected-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option.active,.rlh-position-option.active{border-color:color-mix(in srgb,var(--rlh-accent-color)60%,transparent)}}.rlh-sort-option.active,.rlh-position-option.active{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option.active,.rlh-position-option.active{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-replace-body{grid-area:replace;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:.25rem;width:100%;display:grid}.rlh-info-text{color:var(--rlh-em-color);font-size:.9rem}@supports (color:color-mix(in lab, red, red)){.rlh-info-text{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-info-text{margin:.5rem 0}.rlh-info-text-small{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}@supports (color:color-mix(in lab, red, red)){.rlh-info-text-small{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-chat-lore-empty{text-align:center;background-color:var(--rlh-hover-bg);border-radius:16px;flex-direction:column;justify-content:center;align-items:center;gap:1rem;padding:2rem 1.5rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-chat-lore-empty{background-color:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}.rlh-chat-lore-empty{border:1px dashed var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-chat-lore-empty{border:1px dashed color-mix(in srgb,var(--rlh-border-color)75%,transparent)}}.rlh-detail-view{background-color:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:.5rem;padding:.45rem .55rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-detail-view{background-color:color-mix(in srgb,var(--rlh-surface-color)96%,transparent)}}.rlh-detail-view{box-shadow:0 18px 52px -44px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-detail-view{box-shadow:0 18px 52px -44px color-mix(in srgb,var(--rlh-shadow-color)90%,transparent)}}@media (max-width:1024px){.rlh-detail-view{gap:.45rem;padding:.45rem .55rem}.rlh-detail-header{gap:.3rem;padding:.28rem .45rem}.rlh-detail-content{gap:.3rem}.rlh-entry-list-wrapper{gap:.25rem;padding:.2rem 0}.rlh-detail-header h2{font-size:.9rem;line-height:1.08}}.rlh-detail-header{grid-template-columns:auto 1fr auto;align-items:center;gap:.35rem;padding:.35rem .5rem;display:grid}.rlh-detail-header h2{color:var(--rlh-text-color);text-align:center;white-space:nowrap;text-overflow:ellipsis;min-width:0;margin:0;padding-inline:.5rem;font-size:clamp(1rem,1.8vw,1.25rem);font-weight:600;line-height:1.25;overflow:hidden}.rlh-detail-header .rlh-back-to-list-btn{justify-self:start}.rlh-detail-header .rlh-item-controls{justify-self:end;align-items:center;gap:.4rem;display:inline-flex}.rlh-detail-content,.rlh-entry-list-wrapper{flex-direction:column;gap:.4rem;display:flex}.rlh-entry-list-wrapper .rlh-item-container{animation:.3s ease-out both rlhFadeListItem}@keyframes rlhFadeListItem{0%{opacity:0;transform:translateY(6px)scale(.95)}to{opacity:1;transform:translateY(0)scale(1)}}.rlh-regex-list{flex-direction:column;gap:.45rem;display:flex;position:relative}.rlh-regex-list.sorting-active{border:1.5px dashed var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{border:1.5px dashed color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}.rlh-regex-list.sorting-active{box-shadow:0 0 0 3px var(--rlh-accent-color),0 20px 50px -30px var(--rlh-shadow-color);border-radius:14px;padding:.35rem .45rem}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-accent-color)12%,transparent),0 20px 50px -30px var(--rlh-shadow-color)}}.rlh-regex-list.sorting-active{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{background:color-mix(in srgb,var(--rlh-hover-bg)45%,transparent)}}.rlh-regex-list.sorting-active .rlh-item-container{border-radius:12px}.rlh-regex-list .sortable-ghost{opacity:.2;transform:scale(.98)}.rlh-regex-list .sortable-chosen{box-shadow:0 18px 40px -28px var(--rlh-shadow-color);transform:rotate(.4deg)}.rlh-sorting-fallback{opacity:.7!important;transform:scale(1.02)!important}.rlh-entry-list-wrapper>*{margin:0}.rlh-order-indicator{background-color:var(--rlh-hover-bg);min-width:1.75rem;color:var(--rlh-accent-color);border-radius:9999px;justify-content:center;align-items:center;padding:.1rem .5rem;font-size:max(.8125rem,13px);font-weight:600;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-order-indicator{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-selection-control{justify-content:center;align-items:center;margin-right:.35rem;display:inline-flex}.rlh-selection-control input{cursor:pointer;width:1rem;height:1rem;accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-selection-control input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}.rlh-selection-control input{transition:transform .15s}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-control input{width:1.1rem;height:1.1rem;accent-color:var(--rlh-accent-color)}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-control input:checked{box-shadow:0 0 0 3px var(--rlh-accent-color);transform:scale(1.1)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-control input:checked{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-accent-color)25%,transparent)}}.rlh-drag-handle{color:var(--rlh-em-color);justify-content:center;align-items:center;margin-right:.35rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-drag-handle{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-drag-handle{cursor:grab}.rlh-drag-handle:active{cursor:grabbing}.rlh-editor-group{border-top:1px solid var(--rlh-border-color);flex-direction:column;gap:.6rem;padding:.75rem 0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-editor-group{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-editor-group:first-of-type{border-top:none;padding-top:0}.rlh-editor-group h5{color:var(--rlh-text-color);text-transform:none;letter-spacing:normal;margin:.75rem 0 .5rem;font-size:.95rem;font-weight:600;line-height:1.3}.rlh-editor-grid{grid-template-columns:repeat(auto-fit,minmax(14rem,1fr));gap:.6rem;display:grid}.rlh-grid-item,.rlh-depth-container{flex-direction:column;gap:.4rem;display:flex}.rlh-depth-inputs{flex-wrap:wrap;gap:.6rem;display:flex}.rlh-editor-options-row{flex-wrap:wrap;gap:.4rem;display:flex}.rlh-editor-option-item{background-color:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.35rem;padding:.35rem .65rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-editor-option-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}.rlh-editor-option-item{color:var(--rlh-em-color);font-size:.85rem}.rlh-editor-option-item input{accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-editor-option-item input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}.rlh-select-nudge{min-width:8rem}.rlh-rename-ui{width:100%}.rlh-rename-input-wrapper{border:1px solid var(--rlh-border-color);border-radius:12px;align-items:center;gap:.4rem;width:100%;padding:.4rem .6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-rename-input-wrapper{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-rename-input-wrapper{background-color:var(--rlh-input-bg)}.rlh-rename-input{color:var(--rlh-text-color);background:0 0;border:none;outline:none;flex:1;font-size:.9rem}.rlh-rename-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)75%,transparent)}}.rlh-rename-save-btn{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-save-btn{border-color:color-mix(in srgb,var(--rlh-green)55%,transparent)}}.rlh-rename-cancel-btn{color:var(--rlh-red);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-cancel-btn{border-color:color-mix(in srgb,var(--rlh-red)55%,transparent)}}.rlh-global-toggle,.rlh-item-toggle{transition:background-color .2s,border-color .2s,color .2s}.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{border-color:color-mix(in srgb,var(--rlh-green)65%,transparent)}}.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{background-color:var(--rlh-green-bg)}.rlh-clickable-header{cursor:pointer}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{box-shadow:0 4px 16px -8px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{box-shadow:0 4px 16px -8px color-mix(in srgb,var(--rlh-accent-color)35%,var(--rlh-shadow-color))}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{color:color-mix(in srgb,var(--rlh-accent-color)65%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{font-size:max(.8125rem,13px)}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group:hover,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container:hover{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group:hover,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-selected-bg)12%)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group:hover,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container:hover{box-shadow:0 6px 18px -10px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group:hover,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container:hover{box-shadow:0 6px 18px -10px color-mix(in srgb,var(--rlh-accent-color)50%,var(--rlh-shadow-color))}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-global-book-header:hover,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-header:hover{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-global-book-header:hover,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-header:hover{background-color:color-mix(in srgb,var(--rlh-hover-bg)75%,var(--rlh-selected-bg)25%)}}@media (hover:none){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group:active,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container:active{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group:active,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container:active{background-color:color-mix(in srgb,var(--rlh-surface-color)85%,var(--rlh-selected-bg)15%)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group:active,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container:active{box-shadow:0 8px 24px -12px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group:active,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container:active{box-shadow:0 8px 24px -12px color-mix(in srgb,var(--rlh-accent-color)55%,var(--rlh-shadow-color))}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group.selected:active,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container.selected:active{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group.selected:active,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container.selected:active{background-color:color-mix(in srgb,var(--rlh-surface-color)80%,var(--rlh-selected-bg)20%)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group.selected:active,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container.selected:active{box-shadow:0 10px 28px -14px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group.selected:active,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container.selected:active{box-shadow:0 10px 28px -14px color-mix(in srgb,var(--rlh-accent-color)60%,var(--rlh-shadow-color))}}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group.selected,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container.selected{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group.selected,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container.selected{background-color:color-mix(in srgb,var(--rlh-surface-color)85%,var(--rlh-selected-bg)15%)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group.selected,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container.selected{border-left:4px solid var(--rlh-accent-color);box-shadow:0 6px 20px -10px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-book-group.selected,#regex-lore-hub-panel.rlh-multi-select-mode .rlh-item-container.selected{box-shadow:0 6px 20px -10px color-mix(in srgb,var(--rlh-accent-color)55%,var(--rlh-shadow-color))}}.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{box-shadow:0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-item-container.rlh-collapsed .rlh-item-header,.rlh-book-group.rlh-collapsed .rlh-global-book-header{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.rlh-collapsed .rlh-item-header,.rlh-book-group.rlh-collapsed .rlh-global-book-header{background-color:color-mix(in srgb,var(--rlh-hover-bg)45%,transparent)}}.sortable-ghost{opacity:.75;background-color:var(--rlh-selected-bg)}@supports (color:color-mix(in lab, red, red)){.sortable-ghost{background-color:color-mix(in srgb,var(--rlh-selected-bg)85%,transparent)}}.sortable-ghost{border:1px dashed var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.sortable-ghost{border:1px dashed color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}.rlh-search-controls{flex-wrap:wrap;align-items:center;gap:.7rem;display:flex}#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{border:1px solid var(--rlh-border-color);border-radius:10px;width:100%;min-width:0;padding:.45rem .65rem}@supports (color:color-mix(in lab, red, red)){#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);font-size:1rem;transition:border-color .2s,box-shadow .2s}#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{box-shadow:var(--rlh-focus-ring)}#rlh-search-input::placeholder,.rlh-search-input::placeholder,#rlh-replace-input::placeholder,.rlh-replace-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){#rlh-search-input::placeholder,.rlh-search-input::placeholder,#rlh-replace-input::placeholder,.rlh-replace-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}#rlh-search-input.rlh-input-error,.rlh-search-input.rlh-input-error,#rlh-replace-input.rlh-input-error,.rlh-replace-input.rlh-input-error{border-color:var(--rlh-red)!important;background-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){#rlh-search-input.rlh-input-error,.rlh-search-input.rlh-input-error,#rlh-replace-input.rlh-input-error,.rlh-replace-input.rlh-input-error{background-color:color-mix(in srgb,var(--rlh-red)8%,var(--rlh-input-bg))!important}}#rlh-search-input.rlh-input-error,.rlh-search-input.rlh-input-error,#rlh-replace-input.rlh-input-error,.rlh-replace-input.rlh-input-error{box-shadow:0 0 0 3px var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#rlh-search-input.rlh-input-error,.rlh-search-input.rlh-input-error,#rlh-replace-input.rlh-input-error,.rlh-replace-input.rlh-input-error{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-red)20%,transparent)}}#rlh-search-input.rlh-input-error:hover,.rlh-search-input.rlh-input-error:hover,#rlh-replace-input.rlh-input-error:hover,.rlh-replace-input.rlh-input-error:hover{background-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){#rlh-search-input.rlh-input-error:hover,.rlh-search-input.rlh-input-error:hover,#rlh-replace-input.rlh-input-error:hover,.rlh-replace-input.rlh-input-error:hover{background-color:color-mix(in srgb,var(--rlh-red)12%,var(--rlh-input-bg))!important}}#rlh-search-input.rlh-input-error:focus,.rlh-search-input.rlh-input-error:focus,#rlh-replace-input.rlh-input-error:focus,.rlh-replace-input.rlh-input-error:focus{border-color:var(--rlh-red)!important;background-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){#rlh-search-input.rlh-input-error:focus,.rlh-search-input.rlh-input-error:focus,#rlh-replace-input.rlh-input-error:focus,.rlh-replace-input.rlh-input-error:focus{background-color:color-mix(in srgb,var(--rlh-red)8%,var(--rlh-input-bg))!important}}#rlh-search-input.rlh-input-error:focus,.rlh-search-input.rlh-input-error:focus,#rlh-replace-input.rlh-input-error:focus,.rlh-replace-input.rlh-input-error:focus{box-shadow:0 0 0 3px var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#rlh-search-input.rlh-input-error:focus,.rlh-search-input.rlh-input-error:focus,#rlh-replace-input.rlh-input-error:focus,.rlh-replace-input.rlh-input-error:focus{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-red)30%,transparent)}}.rlh-multi-select-module{flex-direction:column;align-items:flex-start;gap:.25rem;display:flex}.rlh-search-action-btn,.rlh-multi-select-action-btn{border:1px solid var(--rlh-border-color);border-radius:10px;justify-content:center;align-items:center;gap:.2rem;padding:.3rem .5rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-action-btn,.rlh-multi-select-action-btn{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-action-btn,.rlh-multi-select-action-btn{background:var(--rlh-surface-color);color:var(--rlh-text-color);cursor:pointer;font-size:.78rem;line-height:1;transition:color .2s,background-color .2s,border-color .2s,transform .2s}.rlh-multi-select-action-btn:active{transform:scale(.95)}.rlh-search-action-btn:hover,.rlh-multi-select-action-btn:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-action-btn:hover,.rlh-multi-select-action-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-multi-select-actions{flex-wrap:nowrap;align-items:center;gap:.3rem;display:inline-flex}.rlh-multi-select-action-btn.enable{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.enable{border-color:color-mix(in srgb,var(--rlh-green)60%,transparent)}}.rlh-multi-select-action-btn.enable{background-color:var(--rlh-green-bg)}.rlh-multi-select-action-btn.disable{color:var(--rlh-red);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.disable{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-multi-select-action-btn.disable{background-color:var(--rlh-red-bg)}#rlh-search-filters-container,.rlh-filter-list{flex-wrap:wrap;gap:.6rem;display:flex}.rlh-filter-item{background-color:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.4rem;padding:.4rem .65rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)65%,transparent)}}.rlh-filter-item{color:var(--rlh-em-color);font-size:.85rem}.rlh-filter-item input[type=checkbox]{appearance:none;border:1px solid var(--rlh-border-color);border-radius:4px;width:14px;height:14px}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item input[type=checkbox]{border:1px solid color-mix(in srgb,var(--rlh-border-color)70%,transparent)}}.rlh-filter-item input[type=checkbox]{background-color:var(--rlh-input-bg);cursor:pointer;box-sizing:border-box;flex-shrink:0;justify-content:center;align-items:center;transition:border-color .2s,background-color .2s;display:inline-flex;position:relative}.rlh-filter-item input[type=checkbox]:before{content:none!important;display:none!important}.rlh-filter-item input[type=checkbox]:after{content:"";transform-origin:50%;background-color:#0000;border-radius:2px;width:8px;height:8px;transition:transform .14s ease-out,background-color .14s ease-out;transform:scale(0)}.rlh-filter-item input[type=checkbox]:checked{border-color:var(--rlh-accent-color);background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item input[type=checkbox]:checked{background-color:color-mix(in srgb,var(--rlh-accent-color)16%,var(--rlh-input-bg))}}.rlh-filter-item input[type=checkbox]:checked:after{background-color:var(--rlh-accent-color);transform:scale(1)}.rlh-filter-item input[type=checkbox]:focus-visible{outline:2px solid var(--rlh-accent-color);outline-offset:2px}#rlh-multi-select-controls{align-items:center;gap:.35rem;display:none}#rlh-multi-select-controls.active{flex-wrap:wrap;display:flex}@media (max-width:960px){.rlh-multi-select-module{align-items:stretch;gap:.35rem}#rlh-multi-select-controls{flex-wrap:wrap;justify-content:flex-start;align-items:flex-start}.rlh-multi-select-actions{flex-wrap:wrap;justify-content:flex-start}}#regex-lore-hub-panel-content{-webkit-overflow-scrolling:touch;scrollbar-gutter:stable both-edges;scroll-behavior:smooth;flex:auto;min-height:clamp(18rem,48vh,32rem);padding-right:clamp(.25rem,.8vw,.5rem);display:block;overflow:visible}#regex-lore-hub-panel-content>*+*{margin-top:clamp(.8rem,1.4vw,1.1rem)}#regex-lore-hub-panel-content::-webkit-scrollbar{width:6px}#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{background-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{border-radius:9999px}.rlh-book-group,.rlh-item-container{background-color:var(--rlh-surface-color);border-radius:16px;flex-direction:column;min-height:0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{background-color:color-mix(in srgb,var(--rlh-surface-color)96%,transparent)}}.rlh-book-group,.rlh-item-container{box-shadow:0 2px 8px -4px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{box-shadow:0 2px 8px -4px color-mix(in srgb,var(--rlh-shadow-color)70%,transparent)}}.rlh-book-group,.rlh-item-container{transition:background-color .2s,box-shadow .2s,border-left-color .2s;position:relative;overflow:hidden}.rlh-book-group.selected,.rlh-item-container.selected{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.selected,.rlh-item-container.selected{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,var(--rlh-selected-bg)10%)}}.rlh-book-group.selected,.rlh-item-container.selected{border-left:3px solid var(--rlh-accent-color);box-shadow:0 4px 12px -6px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.selected,.rlh-item-container.selected{box-shadow:0 4px 12px -6px color-mix(in srgb,var(--rlh-accent-color)40%,var(--rlh-shadow-color))}}.rlh-book-group:not(.enabled),.rlh-item-container:not(.enabled){opacity:.8;background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group:not(.enabled),.rlh-item-container:not(.enabled){background-color:color-mix(in srgb,var(--rlh-surface-color)92%,#94a3b8 8%)}}.rlh-book-group:not(.enabled),.rlh-item-container:not(.enabled){border-left:3px solid #94a3b8}@supports (color:color-mix(in lab, red, red)){.rlh-book-group:not(.enabled),.rlh-item-container:not(.enabled){border-left:3px solid color-mix(in srgb,#94a3b8 60%,var(--rlh-border-color))}}.rlh-book-group:not(.enabled),.rlh-item-container:not(.enabled){box-shadow:0 4px 16px -12px #64748b}@supports (color:color-mix(in lab, red, red)){.rlh-book-group:not(.enabled),.rlh-item-container:not(.enabled){box-shadow:0 4px 16px -12px color-mix(in srgb,#64748b 70%,var(--rlh-shadow-color))}}.rlh-book-group:not(.enabled) .rlh-item-name,.rlh-item-container:not(.enabled) .rlh-item-name,.rlh-book-group:not(.enabled) .rlh-item-meta,.rlh-item-container:not(.enabled) .rlh-item-meta{color:var(--rlh-disabled-text-color)}.rlh-book-group:not(.enabled):hover,.rlh-item-container:not(.enabled):hover{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group:not(.enabled):hover,.rlh-item-container:not(.enabled):hover{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,#94a3b8 10%)}}.rlh-book-group:hover,.rlh-item-container:hover{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group:hover,.rlh-item-container:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)92%,var(--rlh-hover-bg)8%)}}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.selected:hover,.rlh-item-container.selected:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)85%,var(--rlh-selected-bg)15%)}}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.selected:hover,.rlh-item-container.selected:hover{box-shadow:0 6px 16px -8px color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-shadow-color))}}.rlh-book-group.selected:hover,.rlh-item-container.selected:hover{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.selected:hover,.rlh-item-container.selected:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)85%,var(--rlh-selected-bg)15%)}}.rlh-book-group.selected:hover,.rlh-item-container.selected:hover{box-shadow:0 6px 16px -8px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.selected:hover,.rlh-item-container.selected:hover{box-shadow:0 6px 16px -8px color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-shadow-color))}}@media (hover:none){.rlh-book-group:active,.rlh-item-container:active{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group:active,.rlh-item-container:active{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,var(--rlh-selected-bg)10%)}}.rlh-book-group.selected:active,.rlh-item-container.selected:active{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.selected:active,.rlh-item-container.selected:active{background-color:color-mix(in srgb,var(--rlh-surface-color)82%,var(--rlh-selected-bg)18%)}}.rlh-book-group.selected:active,.rlh-item-container.selected:active{box-shadow:0 8px 20px -10px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.selected:active,.rlh-item-container.selected:active{box-shadow:0 8px 20px -10px color-mix(in srgb,var(--rlh-accent-color)50%,var(--rlh-shadow-color))}}}.rlh-book-group-header{justify-content:center;align-items:center;padding:.7rem .8rem;display:flex;position:relative}.rlh-book-group-title{color:var(--rlh-text-color);text-align:center;white-space:nowrap;text-overflow:ellipsis;max-width:calc(100% - 8rem);margin:0;font-size:clamp(1rem,1.8vw,1.25rem);font-weight:600;line-height:1.25;overflow:hidden}.rlh-book-group-header .rlh-item-controls{align-items:center;gap:.4rem;display:inline-flex;position:absolute;top:50%;right:1rem;transform:translateY(-50%)}.rlh-global-book-header,.rlh-item-header{cursor:pointer;justify-content:flex-start;align-items:center;gap:.5rem;padding:.7rem .8rem;transition:background-color .2s,border-color .2s;display:flex}.rlh-global-book-header{flex-wrap:wrap;align-items:flex-start}.rlh-global-book-header .rlh-book-title-wrapper{flex:auto;min-width:0}.rlh-global-book-header .rlh-item-name{white-space:normal;word-break:break-word;flex:0 auto;min-width:0}.rlh-global-book-header .rlh-book-stats{white-space:nowrap}.rlh-global-book-header .rlh-item-controls{flex:none;margin-top:.1rem;margin-left:auto}.rlh-global-book-header.enabled{background-color:var(--rlh-selected-bg);border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{border:1px solid color-mix(in srgb,var(--rlh-accent-color)30%,var(--rlh-border-color))}}.rlh-global-book-header.enabled{box-shadow:0 8px 24px -20px var(--rlh-shadow-color)}.rlh-global-book-header.enabled .rlh-item-name{color:var(--rlh-text-color);font-weight:600}.rlh-global-book-header.enabled .rlh-book-stats{color:var(--rlh-em-color);font-weight:500}.rlh-global-book-header.enabled:hover{background-color:var(--rlh-selected-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled:hover{background-color:color-mix(in srgb,var(--rlh-selected-bg)85%,var(--rlh-accent-color)15%)}}.rlh-global-book-header:hover,.rlh-item-header:hover{background-color:var(--rlh-hover-bg)}.rlh-item-header-main{flex:auto;align-items:center;gap:.5rem;min-width:0;display:flex}.rlh-item-title-row{flex-wrap:wrap;align-items:center;gap:.45rem;display:inline-flex}.rlh-status-badge{--badge-color:var(--rlh-accent-color);letter-spacing:.01em;background:var(--badge-color);border-radius:999px;align-items:center;gap:.35rem;padding:.15rem .55rem;font-size:.75rem;font-weight:600;line-height:1;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-status-badge{background:color-mix(in srgb,var(--badge-color)18%,transparent)}}.rlh-status-badge{color:var(--badge-color)}@supports (color:color-mix(in lab, red, red)){.rlh-status-badge{color:color-mix(in srgb,var(--badge-color)80%,white 5%)}}.rlh-status-badge{white-space:nowrap}.rlh-status-badge i{font-size:.55rem}.rlh-status-badge__text{display:inline-block;transform:translateY(.5px)}.rlh-status-badge--constant{--badge-color:var(--rlh-status-constant)}.rlh-status-badge--selective{--badge-color:var(--rlh-status-selective)}.rlh-status-badge--vectorized{--badge-color:var(--rlh-status-vectorized)}.rlh-item-name{color:var(--rlh-text-color);flex-shrink:0;font-size:.95rem;font-weight:500}@media (max-width:720px){.rlh-item-header{flex-wrap:wrap;align-items:flex-start;gap:.45rem;padding:.7rem .75rem}.rlh-item-header-main{flex-direction:column;align-items:flex-start;gap:.3rem;width:100%}.rlh-item-name{text-overflow:ellipsis;white-space:nowrap;flex:auto;min-width:0;max-width:100%;overflow:hidden}.rlh-book-group-header{justify-content:flex-start;align-items:flex-start}.rlh-book-group-title{text-align:left;width:100%;max-width:100%}.rlh-item-controls{flex-direction:row;justify-content:flex-end;align-self:flex-start;align-items:center;gap:.18rem;width:auto}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{border-width:1px;border-radius:.6rem;width:1.55rem;height:1.55rem;padding:0}.rlh-item-controls .rlh-toggle-btn i,.rlh-item-controls .rlh-action-btn-icon i{font-size:max(.8125rem,13px)}.rlh-detail-header .rlh-item-controls{justify-self:flex-end}.rlh-book-group-header .rlh-item-controls{justify-content:flex-end;align-items:center;margin-top:.25rem;margin-left:auto;position:static;transform:none}.rlh-item-meta{gap:.25rem;font-size:.74rem}.rlh-item-meta-chip{gap:.2rem;padding:.12rem .45rem}}.rlh-item-meta{color:var(--rlh-em-color);flex-wrap:wrap;align-items:center;gap:.35rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta{color:color-mix(in srgb,var(--rlh-em-color)92%,transparent)}}.rlh-item-meta{font-size:.78rem}.rlh-item-meta-chip{background:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.25rem;padding:.15rem .55rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)70%,transparent)}}.rlh-item-meta-chip{line-height:1.2}.rlh-source-badge{color:#92400e;white-space:nowrap;background:#f59e0b33;border-radius:9999px;align-items:center;gap:.25rem;padding:.12rem .5rem;font-size:.75rem;font-weight:500;line-height:1.2;display:inline-flex}.rlh-source-badge i{font-size:.75rem}.rlh-item-container.from-card{background:#f59e0b;border-left:3px solid #f59e0b99}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.from-card{background:color-mix(in srgb,#f59e0b 4%,var(--rlh-surface-color))}}.rlh-item-container.from-card:before{content:"";z-index:1;border-top:16px solid #f59e0b73;border-left:16px solid #0000;width:0;height:0;position:absolute;top:0;right:0}.rlh-item-container.from-card:after{content:"\u9650";color:#78350f;z-index:2;font-size:.65rem;font-weight:600;position:absolute;top:2px;right:2px}.rlh-item-container.from-card .rlh-item-controls .rlh-action-btn-icon:not(.rlh-toggle-btn){opacity:.5;cursor:not-allowed}.rlh-item-container.from-card .rlh-item-controls .rlh-action-btn-icon:not(.rlh-toggle-btn):hover{background:initial;border-color:var(--rlh-border-color)}.rlh-item-container.from-card:hover{background:#f59e0b}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.from-card:hover{background:color-mix(in srgb,#f59e0b 6%,var(--rlh-surface-color))}}.rlh-item-meta-chip i{color:var(--rlh-accent-color);font-size:.7rem}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip i{color:color-mix(in srgb,var(--rlh-accent-color)75%,var(--rlh-em-color))}}#regex-lore-hub-panel.dark .rlh-item-meta-chip{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-meta-chip{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}#regex-lore-hub-panel.dark .rlh-source-badge{color:#fbbf24;background:#f59e0b40}#regex-lore-hub-panel.dark .rlh-item-container.from-card{background:#f59e0b;border-left-color:#f59e0bb3}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-item-container.from-card{background:color-mix(in srgb,#f59e0b 8%,var(--rlh-surface-color))}}#regex-lore-hub-panel.dark .rlh-item-container.from-card:after{color:#fbbf24}#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-source-badge{color:#fe8019;background:#d65d0e40}#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-container.from-card{background:#d65d0e;border-left-color:#d65d0eb3}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-container.from-card{background:color-mix(in srgb,#d65d0e 8%,var(--rlh-surface-color))}}#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-container.from-card:after{color:#fe8019}#regex-lore-hub-panel.dark .rlh-book-group:not(.enabled),#regex-lore-hub-panel.dark .rlh-item-container:not(.enabled){background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-book-group:not(.enabled),#regex-lore-hub-panel.dark .rlh-item-container:not(.enabled){background-color:color-mix(in srgb,var(--rlh-surface-color)90%,#475569 10%)}}#regex-lore-hub-panel.dark .rlh-book-group:not(.enabled),#regex-lore-hub-panel.dark .rlh-item-container:not(.enabled){border-left-color:#475569}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-book-group:not(.enabled),#regex-lore-hub-panel.dark .rlh-item-container:not(.enabled){border-left-color:color-mix(in srgb,#475569 70%,var(--rlh-border-color))}}#regex-lore-hub-panel.dark .rlh-book-group:not(.enabled),#regex-lore-hub-panel.dark .rlh-item-container:not(.enabled){box-shadow:0 4px 16px -12px #000}#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-book-group:not(.enabled),#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-container:not(.enabled){background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-book-group:not(.enabled),#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-container:not(.enabled){background-color:color-mix(in srgb,var(--rlh-surface-color)90%,#50463e 10%)}}#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-book-group:not(.enabled),#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-container:not(.enabled){border-left-color:#50463e}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-book-group:not(.enabled),#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-container:not(.enabled){border-left-color:color-mix(in srgb,#50463e 70%,var(--rlh-border-color))}}#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-book-group:not(.enabled),#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-container:not(.enabled){box-shadow:0 4px 16px -12px #50463e}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-book-group:not(.enabled),#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-container:not(.enabled){box-shadow:0 4px 16px -12px color-mix(in srgb,#50463e 80%,var(--rlh-shadow-color))}}#regex-lore-hub-panel.dark .rlh-book-group.selected,#regex-lore-hub-panel.dark .rlh-item-container.selected{box-shadow:0 18px 54px -42px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-book-group.selected,#regex-lore-hub-panel.dark .rlh-item-container.selected{box-shadow:0 18px 54px -42px color-mix(in srgb,var(--rlh-accent-color)50%,#000)}}#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-book-group.selected,#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-container.selected{box-shadow:0 18px 54px -42px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-book-group.selected,#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-container.selected{box-shadow:0 18px 54px -42px color-mix(in srgb,var(--rlh-accent-color)55%,var(--rlh-shadow-color))}}.rlh-item-controls{flex-wrap:wrap;align-items:center;gap:.35rem;margin-left:auto;display:inline-flex}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{flex-shrink:0}@media (max-width:960px){.rlh-item-controls{gap:.28rem}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:2rem;height:2rem}}.rlh-btn{cursor:pointer;-webkit-user-select:none;user-select:none;border:1px solid #0000;border-radius:12px;justify-content:center;align-items:center;gap:.4rem;padding:.5rem .85rem;font-size:.9rem;font-weight:500;text-decoration:none;transition:all .2s;display:inline-flex}.rlh-btn:disabled,.rlh-btn.disabled{cursor:not-allowed;opacity:.55}.rlh-btn-primary{background-color:var(--rlh-accent-color);color:var(--rlh-primary-btn-text-color);border-color:var(--rlh-accent-color);box-shadow:0 4px 12px -8px var(--rlh-shadow-color)}.rlh-btn-primary:hover{opacity:.9;box-shadow:0 8px 20px -12px var(--rlh-shadow-color);transform:translateY(-1px)}.rlh-btn-primary:disabled,.rlh-btn-primary.disabled{opacity:.55;box-shadow:none;transform:none}.rlh-btn-secondary{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-btn-secondary{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-btn-secondary{color:var(--rlh-secondary-btn-text-color,var(--rlh-text-color));border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-btn-secondary{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}.rlh-btn-secondary{box-shadow:inset 0 0 0 1px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-btn-secondary{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)25%,transparent)}}.rlh-btn-secondary:hover{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-btn-secondary:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)92%,var(--rlh-accent-color)20%)}}.rlh-btn-secondary:hover{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-btn-secondary:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-border-color)30%)}}.rlh-btn-secondary:hover{box-shadow:inset 0 0 0 1.5px var(--rlh-accent-color),0 10px 22px -16px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-btn-secondary:hover{box-shadow:inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent),0 10px 22px -16px var(--rlh-shadow-color)}}.rlh-btn-secondary:hover{transform:translateY(-1px)scale(1.01)}.rlh-btn-secondary:disabled,.rlh-btn-secondary.disabled{opacity:.55;box-shadow:none;transform:none}.rlh-btn-danger{background-color:var(--rlh-red);color:var(--rlh-danger-btn-text-color);border-color:var(--rlh-red);box-shadow:0 4px 12px -8px var(--rlh-shadow-color)}.rlh-btn-danger:hover{background-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-btn-danger:hover{background-color:color-mix(in srgb,var(--rlh-red)85%,black 15%)}}.rlh-btn-danger:hover{border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-btn-danger:hover{border-color:color-mix(in srgb,var(--rlh-red)85%,black 15%)}}.rlh-btn-danger:hover{box-shadow:0 8px 20px -12px var(--rlh-shadow-color);transform:translateY(-1px)}.rlh-btn-danger:disabled,.rlh-btn-danger.disabled{opacity:.55;box-shadow:none;transform:none}.rlh-btn-sm{border-radius:10px;padding:.35rem .6rem;font-size:.85rem}.rlh-btn-lg{border-radius:14px;padding:.65rem 1.1rem;font-size:1rem}.rlh-btn-icon{border-radius:9999px;width:2.25rem;height:2.25rem;padding:0}.rlh-btn-icon.rlh-btn-sm{width:1.75rem;height:1.75rem}.rlh-btn-icon.rlh-btn-lg{width:2.75rem;height:2.75rem}.rlh-action-btn{background-color:var(--rlh-accent-color)!important;color:var(--rlh-primary-btn-text-color)!important;border:none!important}.rlh-action-btn.rlh-btn-danger{background-color:var(--rlh-red)!important;color:var(--rlh-danger-btn-text-color)!important}.rlh-toolbar-btn{background-color:var(--rlh-surface-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)!important}}.rlh-toolbar-btn{color:var(--rlh-text-color)!important;border-color:var(--rlh-accent-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)!important}}.rlh-toolbar-btn{box-shadow:inset 0 0 0 1px var(--rlh-accent-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)25%,transparent)!important}}.rlh-toolbar-btn:hover{background-color:var(--rlh-surface-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)92%,var(--rlh-accent-color)20%)!important}}.rlh-toolbar-btn:hover{border-color:var(--rlh-accent-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-border-color)30%)!important}}.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px var(--rlh-accent-color),0 10px 22px -16px var(--rlh-shadow-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent),0 10px 22px -16px var(--rlh-shadow-color)!important}}.rlh-action-btn-icon,.rlh-toggle-btn,.rlh-icon-button,.rlh-close-button{background-color:var(--rlh-surface-color);width:2.25rem;height:2.25rem;color:var(--rlh-text-color);border-color:var(--rlh-border-color);border-radius:9999px;padding:0}@supports (color:color-mix(in lab, red, red)){.rlh-action-btn-icon,.rlh-toggle-btn,.rlh-icon-button,.rlh-close-button{border-color:color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-action-btn-icon:hover,.rlh-toggle-btn:hover,.rlh-icon-button:hover,.rlh-close-button:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-action-btn-icon:hover,.rlh-toggle-btn:hover,.rlh-icon-button:hover,.rlh-close-button:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-action-btn-icon:hover,.rlh-toggle-btn:hover,.rlh-icon-button:hover,.rlh-close-button:hover{color:var(--rlh-text-color)}.rlh-action-btn-icon.rlh-btn-danger,.rlh-toggle-btn.rlh-btn-danger,.rlh-icon-button.rlh-btn-danger,.rlh-close-button.rlh-btn-danger{background-color:var(--rlh-red-bg)!important;border-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){.rlh-action-btn-icon.rlh-btn-danger,.rlh-toggle-btn.rlh-btn-danger,.rlh-icon-button.rlh-btn-danger,.rlh-close-button.rlh-btn-danger{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)!important}}.rlh-action-btn-icon.rlh-btn-danger,.rlh-toggle-btn.rlh-btn-danger,.rlh-icon-button.rlh-btn-danger,.rlh-close-button.rlh-btn-danger{color:var(--rlh-red)!important}.rlh-action-btn-icon.rlh-btn-danger:hover,.rlh-toggle-btn.rlh-btn-danger:hover,.rlh-icon-button.rlh-btn-danger:hover,.rlh-close-button.rlh-btn-danger:hover{background-color:var(--rlh-red)!important;color:var(--rlh-danger-btn-text-color)!important}.rlh-toolbar-icon-btn{background-color:var(--rlh-surface-color)!important;border-radius:12px!important;width:2.1rem!important;height:2.1rem!important;padding:0!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)!important}}.rlh-toolbar-icon-btn{color:var(--rlh-text-color)!important;border-color:var(--rlh-accent-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)!important}}.rlh-toolbar-icon-btn:hover{background-color:var(--rlh-surface-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)92%,var(--rlh-accent-color)20%)!important}}.rlh-toolbar-icon-btn:hover{color:var(--rlh-text-color)!important}.rlh-multi-select-action-btn{background:var(--rlh-surface-color);color:var(--rlh-text-color);border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn{border-color:color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-multi-select-action-btn:hover{background-color:var(--rlh-hover-bg)!important;border-color:var(--rlh-accent-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)!important}}.rlh-modal-btn.rlh-modal-ok{background-color:var(--rlh-accent-color)!important;color:var(--rlh-primary-btn-text-color)!important;border:none!important}.rlh-modal-btn.rlh-modal-ok.rlh-btn-danger{background-color:var(--rlh-red)!important}.rlh-multi-select-action-btn.rlh-btn-danger,.rlh-multi-select-action-btn.disable.rlh-btn-danger{background-color:var(--rlh-red)!important;border-color:var(--rlh-red)!important;color:var(--rlh-danger-btn-text-color)!important}.rlh-multi-select-action-btn.rlh-btn-danger:hover{background-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.rlh-btn-danger:hover{background-color:color-mix(in srgb,var(--rlh-red)85%,black 15%)!important}}.rlh-multi-select-action-btn.rlh-btn-danger:hover{border-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.rlh-btn-danger:hover{border-color:color-mix(in srgb,var(--rlh-red)85%,black 15%)!important}}.rlh-toolbar-btn.rlh-btn-danger{background-color:var(--rlh-red)!important;border-color:var(--rlh-red)!important;color:var(--rlh-danger-btn-text-color)!important;box-shadow:none!important}.rlh-toolbar-btn.rlh-btn-danger:hover{background-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.rlh-btn-danger:hover{background-color:color-mix(in srgb,var(--rlh-red)85%,black 15%)!important}}.rlh-toolbar-btn.rlh-btn-danger:hover{border-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.rlh-btn-danger:hover{border-color:color-mix(in srgb,var(--rlh-red)85%,black 15%)!important}}.rlh-toolbar-btn.rlh-btn-danger:hover{box-shadow:0 8px 20px -12px var(--rlh-shadow-color)!important}.rlh-toolbar-btn.rlh-btn-danger:disabled,.rlh-toolbar-btn.rlh-btn-danger.disabled{background-color:var(--rlh-red)!important;opacity:.55!important}@media (max-width:900px) and (min-width:721px){.rlh-item-controls{flex-direction:column;align-items:flex-end;gap:.22rem;width:auto}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:1.75rem;height:1.75rem}.rlh-item-name{flex:auto;min-width:0;max-width:100%}}.rlh-toggle-btn,.rlh-action-btn-icon{border:1px solid var(--rlh-border-color);border-radius:9999px;justify-content:center;align-items:center;width:2.25rem;height:2.25rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toggle-btn,.rlh-action-btn-icon{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-toggle-btn,.rlh-action-btn-icon{background:var(--rlh-surface-color);color:var(--rlh-text-color);cursor:pointer;transition:color .2s,background-color .2s,border-color .2s,transform .2s}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{transform:translateY(-1px)scale(1.03)}.rlh-item-container.enabled .rlh-item-name,.rlh-book-group.enabled .rlh-item-name{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.enabled .rlh-item-name,.rlh-book-group.enabled .rlh-item-name{color:color-mix(in srgb,var(--rlh-accent-color)80%,var(--rlh-text-color))}}.rlh-collapsible-content{background-color:var(--rlh-hover-bg);margin-top:.75rem;padding:0 .6rem .8rem;display:none}@supports (color:color-mix(in lab, red, red)){.rlh-collapsible-content{background-color:color-mix(in srgb,var(--rlh-hover-bg)35%,transparent)}}.rlh-collapsible-content{border-radius:12px}.rlh-entry-actions{background-color:var(--rlh-hover-bg);flex-wrap:wrap;gap:.45rem;padding:.6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-entry-actions{background-color:color-mix(in srgb,var(--rlh-hover-bg)40%,transparent)}}.rlh-entry-actions{border-radius:12px}.rlh-action-btn{background-color:var(--rlh-accent-color);color:var(--rlh-primary-btn-text-color);cursor:pointer;border:none;border-radius:12px;justify-content:center;align-items:center;gap:.4rem;padding:.5rem .85rem;font-size:.9rem;font-weight:500;transition:transform .2s,opacity .2s;display:inline-flex}.rlh-action-btn:hover{opacity:.9}.rlh-action-btn.rlh-maximize-btn{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-action-btn.rlh-maximize-btn{background:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}.rlh-action-btn.rlh-maximize-btn{color:var(--rlh-em-color);border:none}@supports (color:color-mix(in lab, red, red)){.rlh-action-btn.rlh-maximize-btn{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-editor-wrapper{flex-direction:column;gap:1rem;display:flex}.rlh-editor-field{flex-direction:column;gap:.25rem;display:flex}.rlh-editor-field label{color:var(--rlh-em-color);background:0 0;border:none;border-radius:0;padding:0;font-weight:600;display:block}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field label{color:color-mix(in srgb,var(--rlh-em-color)82%,transparent)}}.rlh-editor-field label{margin:0;font-size:.82rem;line-height:1.2}.rlh-editor-field label+*{border-top-left-radius:10px;border-top-right-radius:10px;margin-top:0}.rlh-viewer-field{background-color:var(--rlh-hover-bg);border-radius:12px;gap:.25rem;padding:.28rem .4rem}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-field{background-color:color-mix(in srgb,var(--rlh-hover-bg)35%,transparent)}}.rlh-regex-viewer{grid-template-columns:repeat(auto-fit,minmax(14rem,1fr));gap:.75rem;display:grid}.rlh-regex-viewer>.rlh-editor-field:nth-child(-n+2){grid-column:1/-1}.rlh-entry-viewer{flex-direction:column;gap:.75rem;display:flex}.rlh-viewer-field label{color:var(--rlh-em-color);background:0 0}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-field label{color:color-mix(in srgb,var(--rlh-em-color)82%,transparent)}}.rlh-viewer-text{color:var(--rlh-text-color);white-space:pre-wrap;background-color:#0000;border:none;border-radius:8px;padding:.32rem .45rem;line-height:1.5}.rlh-viewer-text>article{margin:0}.rlh-editor-field .rlh-edit-content,.rlh-editor-field article{border-radius:10px;margin-top:0}#regex-lore-hub-panel.dark .rlh-editor-field label{color:var(--rlh-em-color);background:0 0}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-editor-field label{color:color-mix(in srgb,var(--rlh-em-color)90%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-field label{color:var(--rlh-em-color);background:0 0}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-field label{color:color-mix(in srgb,var(--rlh-em-color)95%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{background-color:#0000}.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{width:100%}.rlh-editor-field select option{background-color:var(--rlh-surface-color);color:var(--rlh-text-color);padding:.45rem .65rem}.rlh-editor-field select option:checked{background-color:var(--rlh-accent-color);color:var(--rlh-text-on-accent)}.rlh-editor-field select option:hover{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field select option:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)20%,var(--rlh-surface-color))}}.rlh-input-error{border-color:var(--rlh-red)!important;background-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){.rlh-input-error{background-color:color-mix(in srgb,var(--rlh-red)8%,var(--rlh-input-bg))!important}}.rlh-input-error{box-shadow:0 0 0 3px var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-input-error{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-red)20%,transparent)}}.rlh-input-error:hover{background-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){.rlh-input-error:hover{background-color:color-mix(in srgb,var(--rlh-red)12%,var(--rlh-input-bg))!important}}.rlh-input-error:focus{background-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){.rlh-input-error:focus{background-color:color-mix(in srgb,var(--rlh-red)8%,var(--rlh-input-bg))!important}}.rlh-input-error:focus{box-shadow:0 0 0 3px var(--rlh-red);border-color:var(--rlh-red)!important}@supports (color:color-mix(in lab, red, red)){.rlh-input-error:focus{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-red)30%,transparent)}}.rlh-error-text{color:var(--rlh-red);margin-top:.25rem;font-size:.875rem;line-height:1.4;display:block}.rlh-error-message{background-color:var(--rlh-red);align-items:center;gap:.5rem;padding:.5rem .75rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-error-message{background-color:color-mix(in srgb,var(--rlh-red)10%,transparent)}}.rlh-error-message{border:1px solid var(--rlh-red);color:var(--rlh-red);border-radius:8px;font-size:.875rem;line-height:1.4}.rlh-error-icon{flex-shrink:0;width:1rem;height:1rem;display:inline-block}.rlh-editor-field label+:is(input,textarea,select){border-top:none;border-radius:0 0 10px 10px}.rlh-editor-field textarea{resize:vertical;min-height:8rem}.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{box-shadow:var(--rlh-focus-ring)}.rlh-toast-notification,.rlh-progress-toast{background-color:var(--rlh-accent-color);color:var(--rlh-primary-btn-text-color);box-shadow:0 24px 120px -40px var(--rlh-shadow-color);opacity:0;pointer-events:none;z-index:10002;border-radius:9999px;padding:.9rem 1.3rem;font-size:.9rem;font-weight:500;transition:opacity .25s,transform .25s;position:fixed;bottom:clamp(1rem,4vw,2rem);left:50%;transform:translate(-50%)translateY(20px)}.rlh-progress-toast{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-progress-toast{background-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-toast-notification.visible,.rlh-progress-toast.visible{opacity:1;animation:.38s cubic-bezier(.3,.7,.4,1.1) both rlhToastIn;transform:translate(-50%)translateY(0)}.rlh-modal-overlay{z-index:10003;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);background:#0206178c;justify-content:center;align-items:center;display:flex;position:fixed;inset:0}.rlh-modal-content{background:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);width:min(420px,90%);box-shadow:0 30px 120px -60px var(--rlh-shadow-color);border-radius:16px;margin:auto;overflow:hidden}.rlh-modal-header{border-bottom:1px solid var(--rlh-border-color);padding:1rem 1.25rem;font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-modal-header{border-bottom:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-body{color:var(--rlh-em-color);flex-direction:column;gap:.6rem;padding:1.1rem 1.25rem;display:flex}.rlh-modal-footer{border-top:1px solid var(--rlh-border-color);justify-content:flex-end;gap:.6rem;padding:.9rem 1.25rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-modal-footer{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-btn{border:1px solid var(--rlh-border-color);border-radius:12px;padding:.55rem 1.1rem}@supports (color:color-mix(in lab, red, red)){.rlh-modal-btn{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-btn{background:var(--rlh-surface-color);color:var(--rlh-text-color);cursor:pointer;font-weight:500;transition:background-color .2s,border-color .2s}.rlh-modal-btn:hover{background-color:var(--rlh-hover-bg)}.rlh-modal-btn.rlh-modal-ok{background-color:var(--rlh-accent-color);border-color:var(--rlh-accent-color);color:var(--rlh-primary-btn-text-color)}.rlh-modal-btn.rlh-modal-cancel{background-color:var(--rlh-red-bg);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-modal-btn.rlh-modal-cancel{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-modal-btn.rlh-modal-cancel{color:var(--rlh-red)}.rlh-loading{background:var(--rlh-surface-color);border-radius:20px;align-items:center;gap:1.25rem;padding:1.4rem 1.6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-loading{background:color-mix(in srgb,var(--rlh-surface-color)96%,transparent)}}.rlh-loading{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-loading{border:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-loading{box-shadow:0 24px 80px -50px var(--rlh-shadow-color)}.rlh-loading-spinner{border:3px solid var(--rlh-em-color);border-radius:9999px;width:2.6rem;height:2.6rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-spinner{border:3px solid color-mix(in srgb,var(--rlh-em-color)35%,transparent)}}.rlh-loading-spinner{border-top-color:var(--rlh-accent-color);animation:.9s linear infinite rlh-spin}.rlh-loading-text{flex-direction:column;flex:1;gap:.55rem;display:flex}.rlh-loading-title{color:var(--rlh-text-color);font-size:.95rem;font-weight:600}.rlh-loading-status{color:var(--rlh-text-color);font-size:.9rem}.rlh-loading-detail{color:var(--rlh-em-color);font-size:.82rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-detail{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-loading-bar{background:var(--rlh-hover-bg);border-radius:9999px;width:100%;height:.4rem;position:relative}@supports (color:color-mix(in lab, red, red)){.rlh-loading-bar{background:color-mix(in srgb,var(--rlh-hover-bg)75%,transparent)}}.rlh-loading-bar{overflow:hidden}.rlh-loading-bar-inner{background:linear-gradient(90deg,var(--rlh-accent-color),var(--rlh-accent-color));width:0%;height:100%}@supports (color:color-mix(in lab, red, red)){.rlh-loading-bar-inner{background:linear-gradient(90deg,var(--rlh-accent-color),color-mix(in srgb,var(--rlh-accent-color)70%,transparent))}}.rlh-loading-bar-inner{transition:width .3s}.rlh-loading-progress{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}@supports (color:color-mix(in lab, red, red)){.rlh-loading-progress{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-menu-icon{width:1.1rem;height:1.1rem;color:var(--rlh-accent-color);justify-content:center;align-items:center;display:inline-flex}@keyframes rlh-spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.rlh-edit-content{border:1px solid var(--rlh-border-color);border-radius:0 0 12px 12px;min-height:6rem;padding:.75rem}@supports (color:color-mix(in lab, red, red)){.rlh-edit-content{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-edit-content{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);white-space:pre-wrap}.rlh-error-wrapper{text-align:center;border:1px dashed var(--rlh-red);border-radius:16px;padding:1.5rem}@supports (color:color-mix(in lab, red, red)){.rlh-error-wrapper{border:1px dashed color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-error-wrapper{background-color:var(--rlh-red-bg)}.rlh-error-title{color:var(--rlh-red);margin-bottom:.75rem;font-weight:600}.rlh-error-text{color:var(--rlh-em-color);font-size:.9rem}.rlh-error-retry-btn{border:1px solid var(--rlh-red);color:var(--rlh-red);cursor:pointer;background-color:#0000;border-radius:9999px;margin-top:1rem;padding:.55rem 1.1rem;transition:background-color .2s}.rlh-error-retry-btn:hover{background-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-error-retry-btn:hover{background-color:color-mix(in srgb,var(--rlh-red)18%,transparent)}}.rlh-error-retry-btn:hover{color:var(--rlh-danger-btn-text-color)}.rlh-search-card,.rlh-filters-card{background:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:.9rem;padding:1rem 1.1rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-card,.rlh-filters-card{background:color-mix(in srgb,var(--rlh-surface-color)92%,transparent)}}.rlh-search-card,.rlh-filters-card{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-card,.rlh-filters-card{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-card,.rlh-filters-card{box-shadow:0 20px 60px -40px var(--rlh-shadow-color)}.rlh-section-title{color:var(--rlh-text-color);letter-spacing:.02em;text-transform:none;margin:.625rem 0 .375rem;font-size:.85rem;font-weight:600;line-height:1.4}.rlh-toast-notification.success{background-color:var(--rlh-green)}.rlh-toast-notification.error{background-color:var(--rlh-red)}.rlh-toast-notification.info{background-color:var(--rlh-accent-color)}@media (prefers-reduced-motion:reduce){#regex-lore-hub-panel .rlh-shell,.rlh-toolbar-btn:focus-visible{animation:none}.rlh-toast-notification.visible,.rlh-progress-toast.visible{transition:opacity .2s,transform .2s;animation:none}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover,.rlh-toolbar-btn:hover,.rlh-toggle-btn:hover i,.rlh-action-btn-icon:hover i,.rlh-toolbar-btn:hover i{transform:none}}.rlh-breadcrumbs{align-items:center;gap:.4rem;margin-bottom:.5rem;font-size:.9rem;display:flex}.rlh-breadcrumb-item{color:var(--rlh-em-color);text-decoration:none;transition:color .2s}.rlh-breadcrumb-item:hover{color:var(--rlh-accent-color)}.rlh-breadcrumb-item.active{color:var(--rlh-text-color);pointer-events:none;font-weight:500}.rlh-breadcrumb-separator{color:var(--rlh-em-color)}.rlh-empty-state{text-align:center;background-color:var(--rlh-hover-bg);border-radius:16px;flex-direction:column;justify-content:center;align-items:center;margin-top:1rem;padding:2rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-empty-state{background-color:color-mix(in srgb,var(--rlh-hover-bg)50%,transparent)}}.rlh-empty-state{border:1px dashed var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-empty-state{border:1px dashed color-mix(in srgb,var(--rlh-border-color)80%,transparent)}}.rlh-empty-icon{color:var(--rlh-accent-color);background-color:var(--rlh-selected-bg);border-radius:9999px;justify-content:center;align-items:center;width:4rem;height:4rem;margin-bottom:1rem;font-size:2rem;display:flex}.rlh-empty-state h4{color:var(--rlh-text-color);margin-bottom:.5rem;font-size:1.1rem;font-weight:600}.rlh-empty-state p{color:var(--rlh-em-color);max-width:300px}.rlh-book-group{transition:box-shadow .2s,background-color .2s;position:relative}.rlh-book-group.enabled{background-color:var(--rlh-selected-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{background-color:color-mix(in srgb,var(--rlh-selected-bg)90%,transparent)}}.rlh-book-group.enabled{border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{border:1px solid color-mix(in srgb,var(--rlh-accent-color)35%,var(--rlh-border-color))}}.rlh-book-group.enabled{box-shadow:0 8px 24px -20px var(--rlh-shadow-color);position:relative}.rlh-book-group.enabled:before{content:"";background-color:var(--rlh-accent-color);border-radius:4px 0 0 4px;width:3px;position:absolute;top:0;bottom:0;left:0}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled:before{background-color:color-mix(in srgb,var(--rlh-accent-color)60%,var(--rlh-border-color))}}.rlh-book-group.enabled:before{pointer-events:none}.rlh-item-container.enabled{box-shadow:0 8px 24px -20px var(--rlh-shadow-color);border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.enabled{border:1px solid color-mix(in srgb,var(--rlh-accent-color)25%,var(--rlh-border-color))}}.rlh-book-title-wrapper{flex-direction:column;flex:1;gap:.2rem;display:flex}.rlh-book-stats{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}.rlh-book-summary{background-color:var(--rlh-hover-bg);padding:.4rem .65rem;font-size:.85rem}@supports (color:color-mix(in lab, red, red)){.rlh-book-summary{background-color:color-mix(in srgb,var(--rlh-hover-bg)40%,transparent)}}.rlh-used-by-chars span{background-color:var(--rlh-selected-bg);border-radius:9999px;margin:.1rem;padding:.1rem .5rem;font-size:max(.8125rem,13px);display:inline-block}.rlh-loading{pointer-events:none;opacity:.5;position:relative}.rlh-loading>i{visibility:hidden}.rlh-loading:after{content:"";border:2px solid oklch(70.7% .022 261.325);border-top-color:oklch(62.3% .214 259.815);border-radius:50%;width:16px;height:16px;margin-top:-8px;margin-left:-8px;animation:.8s linear infinite rlh-spin;position:absolute;top:50%;left:50%}.rlh-highlight{color:#1f2937;background-color:#facc15;animation:.5s ease-out rlhHighlightPulse}.rlh-replace-confirm-modal{color:var(--rlh-text-color);flex-direction:column;gap:.6rem;display:flex}.rlh-replace-stats{background:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-replace-stats{background:color-mix(in srgb,var(--rlh-accent-color)6%,transparent)}}.rlh-replace-stats{border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-replace-stats{border:1px solid color-mix(in srgb,var(--rlh-accent-color)22%,transparent)}}.rlh-replace-stats{border-radius:10px;padding:.6rem .8rem}.rlh-replace-stats h4{color:var(--rlh-text-color);margin:0 0 .4rem;font-weight:600}.rlh-replace-stats ul{margin:0;padding-left:1.1rem}.rlh-confirm-scroll-list{border:1px solid var(--rlh-border-color);background:var(--rlh-surface-color);border-radius:10px;max-height:12rem;padding:.4rem .25rem;overflow-y:auto}.rlh-confirm-entry-list{margin:0;padding:.25rem .25rem .25rem .5rem;list-style:none}.rlh-confirm-entry-item{border-radius:8px;padding:.35rem .5rem;transition:background-color .15s}.rlh-confirm-entry-item:hover{background:var(--rlh-hover-bg)}.rlh-toolbar-btn:focus-visible,.rlh-icon-button:focus-visible,.rlh-close-button:focus-visible,.rlh-toggle-btn:focus-visible,.rlh-action-btn-icon:focus-visible,.rlh-toolbar-icon-btn:focus-visible{outline-offset:2px;outline:3px solid var(--rlh-accent-color)!important;box-shadow:0 0 0 5px var(--rlh-accent-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:focus-visible,.rlh-icon-button:focus-visible,.rlh-close-button:focus-visible,.rlh-toggle-btn:focus-visible,.rlh-action-btn-icon:focus-visible,.rlh-toolbar-icon-btn:focus-visible{box-shadow:0 0 0 5px color-mix(in srgb,var(--rlh-accent-color)20%,transparent)!important}}input:focus-visible,select:focus-visible,textarea:focus-visible,[contenteditable]:focus-visible{outline:3px solid var(--rlh-accent-color);outline-offset:2px}}.rlh-toolbar-toggle-btn{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color);border:1px solid var(--rlh-border-color);cursor:pointer;border-radius:8px;justify-content:center;align-items:center;padding:.5rem 1rem;transition:background-color .2s,color .2s;display:inline-flex}.rlh-toolbar-toggle-btn:hover{background-color:var(--rlh-selected-bg);color:var(--rlh-accent-color)}#regex-lore-hub-toolbar-shell{transition:max-height .3s ease-in-out}.rlh-toolbar-shell--collapsed{max-height:0;margin-top:0;margin-bottom:0;padding-top:0;padding-bottom:0;overflow:hidden}@media (max-width:640px){.rlh-toggle-btn,.rlh-action-btn-icon,.rlh-toolbar-icon-btn,.rlh-icon-button,.rlh-close-button{width:clamp(32px,9.5vw,40px);min-width:clamp(32px,9.5vw,40px);height:clamp(32px,9.5vw,40px);min-height:clamp(32px,9.5vw,40px);padding:.28rem}.rlh-multi-select-action-btn{min-width:clamp(40px,12vw,52px);min-height:clamp(34px,10vw,44px);padding:.38rem .6rem}.rlh-item-controls{gap:.25rem}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:clamp(26px,8.5vw,34px);height:clamp(26px,8.5vw,34px)}}
`;var ka=(()=>{try{return new URL("../vendor/Sortable.min.js",import.meta.url).href}catch(e){return console.error("[RegexLoreHub] \u8BA1\u7B97 SortableJS \u672C\u5730\u8DEF\u5F84\u5931\u8D25\uFF1A",e),""}})(),Qt=e=>!e||typeof e!="string"?"":e.trim().replace(/\\/g,"/").replace(/\/+$/,""),kt=(e,r)=>{let t=Qt(e);if(!t)return"";let a=r.replace(/^\/+/,"");return`${t}/${a}`},wa=(e,r)=>{let t=[],a=l=>{if(!l||typeof l!="string")return;let n=l.trim();n&&(t.includes(n)||t.push(n))};a(kt(o.paths?.vendor,"Sortable.min.js")),a(kt(o.paths?.rlhRoot,"vendor/Sortable.min.js"));try{a(new URL("../vendor/Sortable.min.js",import.meta.url).href)}catch(l){console.warn("[RegexLoreHub] \u57FA\u4E8E\u6A21\u5757\u8DEF\u5F84\u63A8\u5BFC Sortable \u8D44\u6E90\u5931\u8D25\uFF1A",l)}try{e&&e.querySelectorAll("script[src]").forEach(n=>{let i=n.getAttribute("src");if(!(!i||!/regex[-_]lore[-_]hub/i.test(i)))try{let h=new URL(i,r?.location?.href||window.location.href),m=Qt(h.href.replace(/\/[^/]*$/,""));a(kt(m,"vendor/Sortable.min.js")),a(kt(m,"src/vendor/Sortable.min.js"))}catch(h){console.warn("[RegexLoreHub] \u5BBF\u4E3B\u811A\u672C\u8DEF\u5F84\u63A8\u5BFC\u5931\u8D25\uFF1A",h)}})}catch(l){console.warn("[RegexLoreHub] \u904D\u5386\u5BBF\u4E3B\u811A\u672C\u8282\u70B9\u5931\u8D25\uFF1A",l)}return a(ka),a("https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"),t.filter(Boolean)};async function pl(e){let r=xe(),t=we(),a=$e();try{let f=await Go();f?Wr(f,{applyToDom:!1,silent:!0,reason:"restore"})||console.warn("[RegexLoreHub] \u65E0\u6CD5\u6062\u590D\u5B58\u50A8\u7684\u4E3B\u9898\uFF0CID:",f):Wr("dark",{applyToDom:!1,silent:!0,reason:"initial-default"})}catch(f){console.warn("[RegexLoreHub] \u8BFB\u53D6\u4E3B\u9898\u504F\u597D\u5931\u8D25\uFF1A",f)}let l=e(),n=f=>f==="dark"?"\u6697\u8272":f==="light"?"\u4EAE\u8272":"\u81EA\u5B9A\u4E49",i=()=>{let f=r(`#${cr}`,t);if(!f.length)return;let w=Fr()?.id??"",T=mo().map(A=>{let s=typeof A?.id=="string"?A.id.trim():"",g=s&&s===w,x=D(go(s)),R=D(n(A?.colorScheme));return`
          <button type="button" class="rlh-sort-option ${Tr}" data-theme-id="${D(s)}" role="menuitemradio" aria-checked="${g?"true":"false"}" data-active="${g}">
            <span class="rlh-theme-option-text">
              <span class="rlh-theme-option-name">${x}</span>
              <span class="rlh-theme-option-meta">${R}</span>
            </span>
            <span class="rlh-theme-option-check"><i class="fa-solid fa-check" aria-hidden="true"></i></span>
          </button>`}).join("");f.html(T)},h=f=>{let w=(f??Fr())?.id??"",E=r(`#${Ct}`,t);E.length&&E.text("\u4E3B\u9898");let T=r(`#${Pr}`,t);T.length&&T.attr("data-active-theme",w),r(`#${cr}`,t).find(`.${Tr}`).each((s,g)=>{let x=r(g),I=String(x.data("themeId")??"").trim()===w&&!!w;x.attr("data-active",String(I)),x.attr("aria-checked",String(I))})};xo(({theme:f})=>{i(),h(f)});function m(){let f=t.getElementById(`${ke}-styles`);if(f){f.textContent=Jt;return}let v=t.createElement("style");v.id=`${ke}-styles`,v.textContent=Jt,t.head.appendChild(v)}function b(f){if(o.isDragSortDisabled=!1,a.Sortable){if(typeof f=="function")try{f()}catch(s){console.error("[RegexLoreHub] \u521D\u59CB\u5316\u56DE\u8C03\u6267\u884C\u5931\u8D25\uFF1A",s)}return}let v=!1,w=()=>{if(!v&&(v=!0,typeof f=="function"))try{f()}catch(s){console.error("[RegexLoreHub] \u521D\u59CB\u5316\u56DE\u8C03\u6267\u884C\u5931\u8D25\uFF1A",s)}},E=wa(t,a),T=s=>{if(!t){o.isDragSortDisabled=!0,console.error("[RegexLoreHub] \u65E0\u6CD5\u52A0\u8F7D SortableJS\uFF1A\u5BBF\u4E3B\u6587\u6863\u4E0D\u53EF\u8BBF\u95EE\u3002",s),w();return}let g=E.length?`\u5C1D\u8BD5\u8DEF\u5F84\uFF1A${E.join(", ")}`:"\u672A\u627E\u5230\u53EF\u7528\u5019\u9009\u8DEF\u5F84\u3002";(async()=>{if(typeof(a.fetch||window.fetch)!="function")throw s||new Error("fetch not available");let R=a.fetch?a.fetch.bind(a):window.fetch.bind(window),I=(()=>{try{return new URL("../vendor/Sortable.min.js",import.meta.url).href}catch(q){return console.warn("[RegexLoreHub] \u5185\u8054\u56DE\u9000\u8DEF\u5F84\u89E3\u6790\u5931\u8D25\uFF1A",q),""}})()||E[0]||"";if(!I)throw s||new Error("missing inline url");let S=await R(I,{cache:"no-cache"});if(!S.ok)throw new Error(`HTTP ${S.status} ${S.statusText}`);let K=await S.text(),ce=t.createElement("script");ce.textContent=K,t.head.appendChild(ce),console.warn("[RegexLoreHub] SortableJS \u5DF2\u901A\u8FC7\u5185\u8054\u6A21\u5F0F\u52A0\u8F7D\u3002"),o.isDragSortDisabled=!1,w()})().catch(R=>{o.isDragSortDisabled=!0,console.error("[RegexLoreHub] Failed to load SortableJS.",R??s),Q({type:"alert",title:"\u9519\u8BEF",text:`\u65E0\u6CD5\u52A0\u8F7D\u62D6\u62FD\u6392\u5E8F\u5E93\uFF0C\u8BF7\u68C0\u67E5\u8D44\u6E90\u8DEF\u5F84\u914D\u7F6E\u3002${g}`}).catch(()=>{}),w()}).finally(()=>{})};if(!E.length){T(new Error("Sortable candidate URLs not found."));return}let A=s=>{if(s>=E.length){T(new Error("All Sortable candidates failed."));return}let g=E[s],x=a.document.createElement("script");x.src=g,x.dataset.rlhSortableCandidate=String(s),x.onload=()=>{o.isDragSortDisabled=!1,console.log("[RegexLoreHub] SortableJS loaded successfully.",g),o.paths=o.paths||{},o.paths.vendor=Qt(g.replace(/\/Sortable\.min\.js(?:\?.*)?$/,"")),o.paths.rlhRoot=o.paths.vendor?.replace(/\/vendor$/,"")||o.paths.rlhRoot||"",w()},x.onerror=R=>{x.remove(),console.warn("[RegexLoreHub] SortableJS \u52A0\u8F7D\u5931\u8D25\uFF0C\u5C1D\u8BD5\u4E0B\u4E00\u4E2A\u5019\u9009\u3002",g,R?.error),A(s+1)},a.document.head.appendChild(x)};A(0)}function p(){if(console.log("[RegexLoreHub] Initializing UI and button..."),r(`#${ke}`,t).length>0){console.log("[RegexLoreHub] Panel already exists. Skipping UI creation.");return}m();let f=`
      <div id="${ke}">

        <div class="rlh-shell">

          <header class="rlh-shell-header">

            <div class="rlh-shell-title">

              <h4>${Tt}</h4>

              <p class="rlh-shell-meta"><span class="rlh-shell-version">v3.3</span></p>

            </div>

            <div class="rlh-shell-right">

              <div id="${lt}" class="rlh-prefetch-indicator" data-visible="false" aria-hidden="true">

                <div id="${at}" class="rlh-prefetch-text" aria-live="polite">\u52A0\u8F7D\u4E2D (0/0)</div>

                <div class="rlh-prefetch-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">

                  <span id="${nt}" class="rlh-prefetch-bar-inner"></span>

                </div>

              </div>

              <button type="button" id="${Ye.TOGGLE_TOOLBAR_BTN}" class="rlh-toolbar-toggle-btn" title="\u6298\u53E0\u5DE5\u5177\u680F" aria-controls="${Ye.TOOLBAR_SHELL}" aria-expanded="true">\u6298\u53E0\u5DE5\u5177\u680F</button>

              <div class="rlh-shell-actions">

                <div id="${Pr}" class="rlh-theme-menu rlh-sort-menu" data-open="false">

                  <button type="button" id="${zr}" class="rlh-theme-toggle" title="\u5207\u6362\u4E3B\u9898" aria-haspopup="true" aria-expanded="false" aria-controls="${cr}">

                    <i class="fa-solid fa-palette" aria-hidden="true"></i>

                    <span id="${Ct}" class="rlh-theme-toggle-label">\u4E3B\u9898</span>

                    <i class="fa-solid fa-caret-down rlh-theme-toggle-caret" aria-hidden="true"></i>

                  </button>

                  <div id="${cr}" class="rlh-sort-menu-list rlh-theme-menu-list" role="menu"></div>

                </div>

                <button type="button" id="${Dr}" class="rlh-icon-button rlh-refresh-button" title="\u5237\u65B0\u6570\u636E">

                  <i class="fa-solid fa-arrows-rotate"></i>

                </button>

                <button type="button" id="${Lt}" class="rlh-icon-button rlh-close-button" title="\u5173\u95ED\u9762\u677F">

                  <i class="fa-solid fa-xmark"></i>

                </button>

              </div>

            </div>

          </header>





          <nav class="rlh-tab-nav">

            <div class="rlh-tab active" data-tab="global-lore"><span class="rlh-tab-text-full">\u5168\u5C40\u4E16\u754C\u4E66</span><span class="rlh-tab-text-short">\u5168\u5C40\u4E66</span></div>

            <div class="rlh-tab" data-tab="char-lore"><span class="rlh-tab-text-full">\u89D2\u8272\u4E16\u754C\u4E66</span><span class="rlh-tab-text-short">\u89D2\u8272\u4E66</span></div>

            <div class="rlh-tab" data-tab="chat-lore"><span class="rlh-tab-text-full">\u804A\u5929\u4E16\u754C\u4E66</span><span class="rlh-tab-text-short">\u804A\u5929\u4E66</span></div>

            <div class="rlh-tab" data-tab="global-regex"><span class="rlh-tab-text-full">\u5168\u5C40\u6B63\u5219</span><span class="rlh-tab-text-short">\u5168\u5C40\u6B63\u5219</span></div>

            <div class="rlh-tab" data-tab="char-regex"><span class="rlh-tab-text-full">\u89D2\u8272\u6B63\u5219</span><span class="rlh-tab-text-short">\u89D2\u8272\u6B63\u5219</span></div>

          </nav>

          <div id="${Ye.TOOLBAR_SHELL}" class="rlh-toolbar-shell">

            <div id="${Hr}" class="rlh-toolbar-container"></div>

            <div id="${Ur}" class="rlh-replace-container"></div>

          </div>

          <div class="rlh-content-pane">

            <div id="${ke}-content"></div>

          </div>

          <footer class="rlh-shell-footer">

            <div id="regex-lore-hub-save-status" class="rlh-save-status"></div>

          </footer>

        </div>

      </div>`;r("body",t).append(f),fo(),i(),h();let v=`<div id="${tr}" class="list-group-item flex-container flexGap5 interactable" title="${Tt}"><span class="rlh-menu-icon"><i class="fa-solid fa-layer-group"></i></span><span>${so}</span></div>`,w=r("#extensionsMenu",t);w.find(`#${tr}`).length===0&&(w.append(v),console.log(`[RegexLoreHub] Button #${tr} appended to #extensionsMenu.`));let E=r(`#${ke}`,t);if(r("body",t).off(".rlh").on("click.rlh",`#${tr}`,l.togglePanel),E.off(".rlh").on("click.rlh",`#${Lt}`,l.togglePanel).on("click.rlh",".rlh-tab",l.switchTab).on("click.rlh",".rlh-item-header, .rlh-global-book-header",l.handleHeaderClick).on("click.rlh",".rlh-item-container",l.handleMultiSelectContainerClick).on("click.rlh",".rlh-book-group",l.handleMultiSelectContainerClick).on("click.rlh",".rlh-back-to-list-btn",l.handleExitLorebookDetail).on("click.rlh",".rlh-toggle-btn",l.handleToggleState).on("click.rlh",".rlh-refresh-detail-btn",l.handleRefreshLorebookDetail).on("click.rlh",".rlh-entry-edit-btn",l.handleEntryEnterEdit).on("click.rlh",".rlh-entry-view-btn",l.handleEntryExitEdit).on("click.rlh",".rlh-regex-edit-btn",l.handleRegexEnterEdit).on("click.rlh",".rlh-regex-view-btn",l.handleRegexExitEdit).on("keydown.rlh",`#${nr}`,l.handleSearchInputKeydown).on("click.rlh","#rlh-search-clear-btn",l.handleSearchClear).on("input.rlh",`#${nr}, #${Sr}`,l.handleGlobalSearch).on("change.rlh","#rlh-search-filters-container input",se).on("change.rlh",`#${ot}`,l.handleCharacterBookSwitch).on("click.rlh",`#${_r}`,l.handleToolbarToggleCollapse).on("click.rlh",`#${ir}`,l.handleSortMenuToggle).on("click.rlh",".rlh-sort-option",l.handleSortOptionSelect).on("click.rlh",`#${zr}`,l.handleThemeMenuToggle).on("click.rlh",`#${cr} .${Tr}`,l.handleThemeOptionSelect).on("click.rlh",`#${Qe}`,l.handlePositionMenuToggle).on("click.rlh",".rlh-position-option",l.handlePositionOptionSelect).on("click.rlh",`#${sr}`,l.handleUnifiedStatusMenuToggle).on("click.rlh",".rlh-unified-status-option",l.handleUnifiedStatusOptionSelect).on("change.rlh",".rlh-multi-select-checkbox",l.handleSelectionCheckboxChange).on("click.rlh",`#${Dr}`,l.handleRefresh).on("click.rlh","#rlh-multi-select-btn",l.toggleMultiSelectMode).on("click.rlh","#rlh-select-all-btn",l.handleSelectAll).on("click.rlh","#rlh-select-none-btn",l.handleSelectNone).on("click.rlh","#rlh-select-invert-btn",l.handleSelectInvert).on("click.rlh",".rlh-select-unbound",l.handleSelectUnboundBooks).on("click.rlh","#rlh-batch-enable-btn",l.handleBatchEnable).on("click.rlh","#rlh-batch-disable-btn",l.handleBatchDisable).on("click.rlh","#rlh-batch-delete-btn",l.handleBatchDelete).on("click.rlh",".rlh-clean-orphan-books-btn",l.handleCleanOrphanLorebooks).on("click.rlh",`#${tt}`,l.handlePrimaryCreateButtonClick).on("click.rlh",".rlh-rename-book-btn",l.handleRenameBook).on("click.rlh",".rlh-edit-entries-btn",l.handleEditEntriesToggle).on("click.rlh",".rlh-delete-book-btn",l.handleDeleteLorebook).on("click.rlh",".rlh-create-entry-btn",l.handleCreateEntry).on("click.rlh","#regex-lore-hub-create-lorebook-btn",l.handleCreateLorebook).on("click.rlh",".rlh-delete-entry-btn",l.handleDeleteEntry).on("click.rlh",".rlh-batch-recursion-btn",l.handleBatchSetRecursion).on("click.rlh",".rlh-fix-keywords-btn",l.handleFixKeywords).on("click.rlh",".rlh-rename-btn",l.handleRename).on("click.rlh",".rlh-rename-save-btn",l.handleConfirmRename).on("keydown.rlh",".rlh-rename-input",l.handleRenameKeydown).on("change.rlh",".rlh-edit-position",l.handlePositionChange).on("click.rlh","#rlh-create-chat-lore-btn",l.handleCreateChatLorebook).on("click.rlh",".rlh-unlink-chat-lore-btn",l.handleUnlinkChatLorebook).on("click.rlh",`#${Ye.TOGGLE_TOOLBAR_BTN}`,il).on("click.rlh","#rlh-replace-btn",l.handleReplace),o.isToolbarCollapsed){r(`#${Ye.TOOLBAR_SHELL}`,t).addClass("rlh-toolbar-shell--collapsed");let s=r(`#${Ye.TOGGLE_TOOLBAR_BTN}`,t);s.length&&s.text("\u5DE5\u5177\u680F").attr("aria-expanded","false").attr("title","\u5DE5\u5177\u680F")}console.log("[RegexLoreHub] All UI and events initialized."),We()}b(p)}var Zt=null,eo=null;function Sa(e,r){Zt=e,eo=r}function xe(){if(Zt)return Zt;let e=window.parent||window;return e?.jQuery?e.jQuery:null}function Se(){if(eo)return eo;let e=window.parent||window;return e?.TavernHelper?e.TavernHelper:null}function _a(e){let r="#extensionsMenu",a=0;console.log(`[RegexLoreHub] Starting readiness check. Polling for DOM element "${r}" AND core APIs (TavernHelper, jQuery).`);let l=setInterval(()=>{let n=window.parent?.document,i=window.parent,h=!!n&&n.querySelector(r)!==null,m=!!(i&&i.TavernHelper)&&typeof i.TavernHelper.getCharData=="function"&&!!i.jQuery;if(h&&m){clearInterval(l),console.log(`[RegexLoreHub] SUCCESS: Both DOM ("${r}") and Core APIs are ready. Initializing script.`);try{let b=e(i.jQuery,i.TavernHelper);b?.catch&&b.catch(p=>{console.error("[RegexLoreHub] FATAL: Error during main callback execution.",p)})}catch(b){console.error("[RegexLoreHub] FATAL: Error during main callback execution.",b)}}else a++,a>100&&(clearInterval(l),console.error("[RegexLoreHub] FATAL: Readiness check timed out."),h||console.error(`[RegexLoreHub] -> Failure: DOM element "${r}" not found.`),m||console.error(`[RegexLoreHub] -> Failure: Core APIs not available. TavernHelper: ${!!i?.TavernHelper}, jQuery: ${!!i?.jQuery}`))},150)}async function Ea(e,r){Sa(e,r);try{await pl(hl)}catch(t){console.error("[RegexLoreHub] FATAL: Failed to bootstrap application.",t)}}_a(Ea);
//# sourceMappingURL=bundle.js.map

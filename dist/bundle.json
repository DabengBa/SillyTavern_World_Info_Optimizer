{
  "id": "0266db8e-add9-49c0-bfca-3b237bbb1eaf",
  "name": "世界书&正则管理器",
  "content": "var ke=\"regex-lore-hub-panel\",tr=\"regex-lore-hub-button\";var $t=\"\\u4E16\\u754C\\u4E66&\\u6B63\\u5219\\u7BA1\\u7406\\u5668\",so=\"\\u4E16\\u754C\\u4E66&\\u6B63\\u5219\\u7BA1\\u7406\\u5668\",Tt=\"rlh-close-btn\",nr=\"rlh-search-input\",Dr=\"rlh-refresh-btn\",Hr=\"rlh-core-toolbar\",Ur=\"rlh-replace-tool-container\";var Sr=\"rlh-replace-input\",_r=\"rlh-toggle-collapse-btn\",co=\"rlh-toggle-recursion-btn\",ho=\"rlh-fix-keywords-btn\",Er=\"rlh-sort-menu\",ir=\"rlh-sort-menu-btn\",or=\"rlh-position-menu\",Qe=\"rlh-position-menu-btn\",$r=\"rlh-unified-status-menu\",sr=\"rlh-unified-status-btn\",rt=\"rlh-create-primary-btn\",tt=\"rlh-character-book-switch\",ot=\"rlh-prefetch-indicator\",lt=\"rlh-prefetch-progress-text\",at=\"rlh-prefetch-progress-bar\",Pr=\"rlh-theme-menu-wrapper\",cr=\"rlh-theme-menu\",zr=\"rlh-theme-toggle-btn\",Lt=\"rlh-theme-toggle-label\",Tr=\"rlh-theme-option\",Ye={TOOLBAR_SHELL:\"regex-lore-hub-toolbar-shell\",TOGGLE_TOOLBAR_BTN:\"regex-lore-hub-toggle-toolbar-btn\"},Ct=e=>!e||typeof e!=\"string\"?\"\":e.replace(/\\\\/g,\"/\").replace(/\\/+$/,\"\"),Bl=()=>{try{let e=new URL(\"./\",import.meta.url).href;return Ct(e)}catch(e){return console.warn(\"[RegexLoreHub] \\u65E0\\u6CD5\\u89E3\\u6790\\u811A\\u672C\\u6839\\u8DEF\\u5F84\\uFF1A\",e),\"\"}},Ol=()=>{try{let e=window.parent||window,r=e?.document;if(!r)return\"\";let t=r.querySelectorAll(\"script[src]\");for(let a of t){let l=a.getAttribute(\"src\");if(!(!l||!/regex[-_]lore[-_]hub/i.test(l)))try{let n=new URL(l,e.location?.href||window.location.href),i=Ct(n.href);if(!i)continue;let h=i.replace(/\\/[^/]*$/,\"\");if(h)return h}catch(n){console.warn(\"[RegexLoreHub] \\u5BBF\\u4E3B\\u811A\\u672C\\u6839\\u8DEF\\u5F84\\u89E3\\u6790\\u5931\\u8D25\\uFF1A\",n)}}}catch(e){console.warn(\"[RegexLoreHub] \\u65E0\\u6CD5\\u4ECE\\u5BBF\\u4E3B DOM \\u63A8\\u65AD\\u6839\\u8DEF\\u5F84\\uFF1A\",e)}return\"\"},wt=Ct(Ol())||Bl(),po=[[\"focusRing\",\"--rlh-focus-ring\"],[\"background\",\"--rlh-bg-color\"],[\"surface\",\"--rlh-surface-color\"],[\"text\",\"--rlh-text-color\"],[\"textMuted\",\"--rlh-em-color\"],[\"border\",\"--rlh-border-color\"],[\"hover\",\"--rlh-hover-bg\"],[\"selected\",\"--rlh-selected-bg\"],[\"shadow\",\"--rlh-shadow-color\"],[\"header\",\"--rlh-header-bg\"],[\"input\",\"--rlh-input-bg\"],[\"accent\",\"--rlh-accent-color\"],[\"positive\",\"--rlh-green\"],[\"negative\",\"--rlh-red\"],[\"positiveBg\",\"--rlh-green-bg\"],[\"negativeBg\",\"--rlh-red-bg\"],[\"statusConstant\",\"--rlh-status-constant\"],[\"statusSelective\",\"--rlh-status-selective\"],[\"statusVectorized\",\"--rlh-status-vectorized\"]],uo={};po.forEach(([e,r])=>{uo[e]=r});var St=Object.freeze({...uo}),Ta=Object.freeze(po.map(([e])=>e));var Nt=e=>e==null?\"\":String(e).trim().toLowerCase(),Dl=e=>{if(!e)return[];let r=Array.isArray(e)?e:[e],t=[];return r.forEach(a=>{if(!a&&a!==0)return;let l=String(a).trim();l&&(t.includes(l)||t.push(l))}),t},rr=new Map,fr=[],_t=new Set,ye={activeId:\"dark\",fallbackId:\"dark\",pendingApplyId:null,appliedClasses:[],colorScheme:\"dark\",activeSnapshot:null},Hl=e=>(rr.set(e.id,e),fr.includes(e.id)||fr.push(e.id),fr.sort((r,t)=>{let a=rr.get(r),l=rr.get(t);return!a||!l?0:a.order!==l.order?a.order-l.order:a.id.localeCompare(l.id)}),e),Ul=e=>{if(!e||typeof e!=\"object\")throw new Error(\"\\u4E3B\\u9898\\u914D\\u7F6E\\u5FC5\\u987B\\u662F\\u5BF9\\u8C61\");let r=Nt(e.id??e.themeId??e.name);if(!r)throw new Error(\"\\u4E3B\\u9898\\u914D\\u7F6E\\u7F3A\\u5C11 id\");let t=typeof e.label==\"string\"&&e.label.trim()?e.label.trim():r,a=typeof e.description==\"string\"?e.description.trim():\"\",l=typeof e.order==\"number\"&&!Number.isNaN(e.order)?e.order:fr.length,n=Dl(e.panelClassList??e.classList),i=e.colorScheme===\"dark\"?\"dark\":\"light\",h=e.metadata&&typeof e.metadata==\"object\"?{...e.metadata}:{};return Object.freeze({id:r,label:t,description:a,order:l,panelClassList:Object.freeze(n),colorScheme:i,metadata:Object.freeze(h)})},bo=e=>{try{let r=we();if(!r)return!1;let t=r.getElementById(ke);if(!t)return!1;Array.isArray(ye.appliedClasses)&&ye.appliedClasses.length&&ye.appliedClasses.forEach(l=>{l&&t.classList.remove(l)});let a=Array.isArray(e.panelClassList)?[...e.panelClassList]:[];return a.forEach(l=>{l&&t.classList.add(l)}),ye.appliedClasses=a,t.dataset.rlhTheme=e.id,e.colorScheme?t.dataset.rlhThemeScheme=e.colorScheme:delete t.dataset.rlhThemeScheme,!0}catch(r){return console.warn(\"[RegexLoreHub] \\u5E94\\u7528\\u4E3B\\u9898\\u5230\\u9762\\u677F\\u5931\\u8D25\\uFF1A\",r),!1}},Pl=(e,r,t)=>{let a={theme:e,previous:r,reason:t||\"manual\"};_t.forEach(l=>{if(typeof l==\"function\")try{l(a)}catch(n){console.warn(\"[RegexLoreHub] \\u4E3B\\u9898\\u76D1\\u542C\\u5668\\u6267\\u884C\\u5931\\u8D25\\uFF1A\",n)}});try{let l=$e(),n=l?.CustomEvent||(typeof CustomEvent==\"function\"?CustomEvent:null);l&&typeof l.dispatchEvent==\"function\"&&n?l.dispatchEvent(new n(\"RegexLoreHubThemeChange\",{detail:a})):typeof window<\"u\"&&typeof window.dispatchEvent==\"function\"&&n&&window.dispatchEvent(new n(\"RegexLoreHubThemeChange\",{detail:a}))}catch(l){console.warn(\"[RegexLoreHub] \\u6D3E\\u53D1\\u4E3B\\u9898\\u4E8B\\u4EF6\\u5931\\u8D25\\uFF1A\",l)}},Br=()=>{let e=rr.get(ye.activeId);if(e)return ye.activeSnapshot=e,ye.colorScheme=e.colorScheme,e;let r=rr.get(ye.fallbackId);if(r)return ye.activeId=r.id,ye.activeSnapshot=r,ye.colorScheme=r.colorScheme,r;let t=fr.length?rr.get(fr[0]):null;return t&&(ye.fallbackId=t.id,ye.activeId=t.id,ye.activeSnapshot=t,ye.colorScheme=t.colorScheme),t??null},mo=e=>{try{let r=Ul(e);return Hl(r),ye.fallbackId||(ye.fallbackId=r.id),ye.activeId||(ye.activeId=r.id),ye.activeId===r.id&&(ye.activeSnapshot=r,ye.colorScheme=r.colorScheme),r}catch(r){return console.error(\"[RegexLoreHub] \\u6CE8\\u518C\\u4E3B\\u9898\\u5931\\u8D25\\uFF1A\",r),null}},zl=e=>{let r=Nt(e);return r?rr.get(r)??null:null},fo=()=>fr.map(e=>rr.get(e)).filter(Boolean),Fr=()=>Br(),It=e=>{let r=zl(e);return r&&typeof r.label==\"string\"&&r.label.trim()?r.label.trim():typeof e==\"string\"&&e.trim()?e.trim():\"\"},jr=(e,r={})=>{let{reason:t=\"manual\",applyToDom:a=!0,silent:l=!1}=r??{},n=Nt(e),i=n===\"default\"?\"gruvbox-light-hard\":n,h=i&&rr.get(i)||Br();if(!h)return null;let m=Br(),b=!m||m.id!==h.id;if(ye.activeId=h.id,ye.activeSnapshot=h,ye.colorScheme=h.colorScheme,a){let p=bo(h);ye.pendingApplyId=p?null:h.id}else ye.pendingApplyId=h.id;return b&&!l&&Pl(h,m,t),h},go=()=>{let e=Br();if(!e)return!1;let r=bo(e);return ye.pendingApplyId=r?null:e.id,r},xo=e=>typeof e!=\"function\"?()=>{}:(_t.add(e),()=>_t.delete(e));mo({id:\"dark\",label:\"\\u6697\\u8272\\u4E3B\\u9898\",description:\"\\u6DF1\\u8272\\u754C\\u9762\\uFF0C\\u7EE7\\u627F\\u73B0\\u6709 dark \\u6837\\u5F0F\\u3002\",order:0,panelClassList:[\"dark\",\"rlh-theme-dark\"],colorScheme:\"dark\"});mo({id:\"gruvbox-light-hard\",label:\"Gruvbox\",description:\"\\u91C7\\u7528 Gruvbox Light Hard \\u8C03\\u8272\\u677F\\u7684\\u6D45\\u8272\\u4E3B\\u9898\\u3002\",order:1,panelClassList:[\"rlh-theme-gruvbox\"],colorScheme:\"light\",metadata:{family:\"gruvbox\",variant:\"light-hard\"}});Br();var Fl=[{id:\"constant\",label:\"\\u6C38\\u4E45\\u6FC0\\u6D3B\",shortLabel:\"\\u6C38\\u4E45\",description:\"\\u5FFD\\u7565\\u5173\\u952E\\u8BCD\\u9650\\u5236\\uFF0C\\u53EA\\u8981\\u6761\\u76EE\\u542F\\u7528\\u4E14\\u6EE1\\u8DB3\\u6982\\u7387\\u5C31\\u59CB\\u7EC8\\u5C1D\\u8BD5\\u6FC0\\u6D3B\\u3002\",strategyType:\"constant\",toastLabel:\"\\u6C38\\u4E45\\u6FC0\\u6D3B\",accentVar:St.statusConstant,badgeClass:\"rlh-status-badge--constant\",order:0},{id:\"selective\",label:\"\\u5173\\u952E\\u8BCD\\u89E6\\u53D1\",shortLabel:\"\\u5173\\u952E\\u8BCD\",description:\"\\u5339\\u914D\\u4E3B\\u8981/\\u6B21\\u8981\\u5173\\u952E\\u8BCD\\u540E\\u6FC0\\u6D3B\\uFF0C\\u53EF\\u7ED3\\u5408\\u6982\\u7387\\u4E0E\\u626B\\u63CF\\u6DF1\\u5EA6\\u63A7\\u5236\\u89E6\\u53D1\\u3002\",strategyType:\"selective\",toastLabel:\"\\u5173\\u952E\\u8BCD\\u89E6\\u53D1\",accentVar:St.statusSelective,badgeClass:\"rlh-status-badge--selective\",order:1},{id:\"vectorized\",label:\"\\u5411\\u91CF\\u5316\",shortLabel:\"\\u5411\\u91CF\",description:\"\\u4F9D\\u8D56\\u5411\\u91CF\\u76F8\\u4F3C\\u5EA6\\u6FC0\\u6D3B\\uFF0C\\u9002\\u7528\\u4E8E\\u8BED\\u4E49\\u53EC\\u56DE\\u573A\\u666F\\u3002\",strategyType:\"vectorized\",toastLabel:\"\\u5411\\u91CF\\u5316\",accentVar:St.statusVectorized,badgeClass:\"rlh-status-badge--vectorized\",order:2}],vo=Fl.map(e=>Object.freeze({...e,id:String(e.id).toLowerCase(),strategyType:String(e.strategyType??e.id).toLowerCase(),toastLabel:e.toastLabel??e.label,shortLabel:e.shortLabel??e.label})),Et={};vo.forEach(e=>{Et[e.id]=e,Et[e.strategyType]=e});var Rt=Object.freeze(Et),nt=Object.freeze([...vo].sort((e,r)=>e.order-r.order)),Re=Rt.constant,it=Re?.id??\"constant\",Wr=e=>{if(!e&&e!==0)return null;let r=String(e).trim().toLowerCase();return Rt[r]?.id??null},qe=e=>{let r=Wr(e);return r?Rt[r]??null:null};var Xe={position:{before_character_definition:\"\\u89D2\\u8272\\u5B9A\\u4E49\\u524D\",after_character_definition:\"\\u89D2\\u8272\\u5B9A\\u4E49\\u540E\",before_example_messages:\"\\u804A\\u5929\\u793A\\u4F8B\\u524D\",after_example_messages:\"\\u804A\\u5929\\u793A\\u4F8B\\u540E\",before_author_note:\"\\u4F5C\\u8005\\u7B14\\u8BB0\\u524D\",after_author_note:\"\\u4F5C\\u8005\\u7B14\\u8BB0\\u540E\",at_depth_as_system:\"@D \\u2699 \\u7CFB\\u7EDF\",at_depth_as_assistant:\"@D \\u{1F5E8}\\uFE0F \\u89D2\\u8272\",at_depth_as_user:\"@D \\u{1F464} \\u7528\\u6237\"},logic:{and_any:\"\\u4EFB\\u4E00 AND\",and_all:\"\\u6240\\u6709 AND\",not_any:\"\\u4EFB\\u4E00 NOT\",not_all:\"\\u6240\\u6709 NOT\"}},Lr={bookName:\"\\u4E66\\u540D\",entryName:\"\\u6761\\u76EE\\u540D\",keywords:\"\\u5173\\u952E\\u8BCD\",content:\"\\u5185\\u5BB9\"},At={entryName:\"\\u540D\\u79F0\",content:\"\\u5185\\u5BB9\"},yo={bookName:{id:\"rlh-filter-book-name\"},entryName:{id:\"rlh-filter-entry-name\"},keywords:{id:\"rlh-filter-keywords\"},content:{id:\"rlh-filter-content\"}},ko={status:{value:\"status\",label:\"\\u6309\\u542F\\u7528\\u72B6\\u6001\"},name:{value:\"name\",label:\"\\u540D\\u79F0\\u6392\\u5E8F\"}},o={regexes:{global:[],character:[]},lorebooks:{character:[]},chatLorebook:null,allLorebooks:[],theme:ye,lorebookEntries:new Map,pendingLorebookUpdates:new Map,pendingRegexUpdates:new Set,lorebookUsage:new Map,activeTab:\"global-lore\",activeView:\"global-lore-list\",activeBookName:null,activeCharacterBook:null,charLoreInitialSynced:!1,pendingHighlightEntry:null,isDataLoaded:!1,isLoadingTabData:!1,loadingBookName:null,searchFilters:{bookName:!0,entryName:!0,keywords:!0,content:!0},multiSelectMode:!1,multiSelectTarget:\"book\",selectedItems:new Set,globalSearch:{term:\"\",replace:\"\"},searchFilterContextsInitialized:new Set,collapseStateByContext:new Map,sortModeByContext:new Map,characterContext:{name:null,id:null},saveStatus:\"idle\",saveRetryAttempt:0,isToolbarCollapsed:!0,isDragSortDisabled:!1,paths:{rlhRoot:wt,vendor:wt?`${wt}/vendor`:\"\"}},st=e=>!e&&e!==0?\"\":typeof e==\"string\"?e.trim():e&&typeof e==\"object\"&&typeof e.name==\"string\"?e.name.trim():String(e??\"\").trim(),ao=(e,r)=>{if(!e||!r&&r!==0)return;let t=typeof r==\"string\"?r.trim():String(r).trim();t&&e.add(t)},Or=e=>e==null?\"\":encodeURIComponent(String(e)),ze=e=>{if(e==null)return\"\";try{return decodeURIComponent(String(e))}catch{return String(e)}},Ze=e=>{let r=st(e);return r?`book:${Or(r)}`:\"\"},Gr=(e,r)=>{let t=st(e);if(!t)return\"\";let a=r??\"\";return`lore:${Or(t)}:${Or(a)}`},gr=e=>{let r=st(e);return r?`lore:${Or(r)}:`:\"lore:\"},Kr=e=>`regex:${Or(e??\"\")}`,wo=e=>{let r=new Set,t=new Set,a=typeof e==\"string\"?{name:e}:e??{},l=st(a),n=m=>ao(r,m),i=m=>ao(t,m);if(a&&typeof a==\"object\"&&(Array.isArray(a.characters)?a.characters.forEach(n):a.characters&&typeof a.characters==\"object\"&&Object.values(a.characters).forEach(n),Array.isArray(a.charIds)?a.charIds.forEach(i):Array.isArray(a.characterIds)?a.characterIds.forEach(i):a.charIds&&typeof a.charIds==\"object\"&&Object.values(a.charIds).forEach(i)),l&&o.lorebookUsage instanceof Map&&o.lorebookUsage.has(l)){let m=o.lorebookUsage.get(l);Array.isArray(m)&&m.forEach(n)}let h=r.size+t.size;return{name:l,characters:[...r],charIds:[...t],bindingCount:h}};var no=\"RegexLoreHubAnalytics\",jl=\"select_unbound_lorebooks\",Wl=\"v3.2\",Gl=500,io=new Map,Mt=(e={})=>{try{let r=Date.now(),t=typeof e.category==\"string\"?e.category.trim():\"\",a=typeof e.action==\"string\"?e.action.trim():\"\",l=t||\"unknown\",n=a||\"unknown\",i=`${l}::${n}`,h=io.get(i)??0;if(r-h<Gl)return;io.set(i,r);let m=typeof o.activeView==\"string\"?o.activeView.trim():\"\",b=typeof e.feature==\"string\"&&e.feature.trim()?e.feature.trim():jl,p=typeof e.view==\"string\"&&e.view.trim()?e.view.trim():m||\"unknown\",f={source:\"regex-lore-hub\",timestamp:r,version:Wl,...e,category:l,action:n,feature:b,view:p},v=$e(),w=v?.CustomEvent||(typeof CustomEvent==\"function\"?CustomEvent:null);if(v&&typeof v.dispatchEvent==\"function\"&&w){v.dispatchEvent(new w(no,{detail:f}));return}if(typeof window<\"u\"&&typeof window.dispatchEvent==\"function\"&&w){window.dispatchEvent(new w(no,{detail:f}));return}console.info(\"[RegexLoreHub] Analytics event captured:\",f)}catch(r){console.warn(\"[RegexLoreHub] emitAnalyticsEvent \\u8C03\\u7528\\u5931\\u8D25\\uFF1A\",r)}},ne=e=>{try{(!o.lorebookEntries||!(o.lorebookEntries instanceof Map))&&(console.warn(\"[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...\"),o.lorebookEntries=new Map),typeof o.lorebookEntries.get!=\"function\"&&(console.warn(\"[RegexLoreHub] appState.lorebookEntries.get is not a function, reinitializing...\"),o.lorebookEntries=new Map);let r=o.lorebookEntries.get(e);return Array.isArray(r)?r:[]}catch(r){return console.error(\"[RegexLoreHub] Error in safeGetLorebookEntries:\",r),o.lorebookEntries=new Map,[]}},Oe=(e,r)=>{try{(!o.lorebookEntries||!(o.lorebookEntries instanceof Map))&&(console.warn(\"[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...\"),o.lorebookEntries=new Map),typeof o.lorebookEntries.set!=\"function\"&&(console.warn(\"[RegexLoreHub] appState.lorebookEntries.set is not a function, reinitializing...\"),o.lorebookEntries=new Map),o.lorebookEntries.set(e,Array.isArray(r)?r:[])}catch(t){console.error(\"[RegexLoreHub] Error in safeSetLorebookEntries:\",t),o.lorebookEntries=new Map,o.lorebookEntries.set(e,Array.isArray(r)?r:[])}},Vr=e=>{try{if(!o.lorebookEntries||!(o.lorebookEntries instanceof Map)){console.warn(\"[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...\"),o.lorebookEntries=new Map;return}if(typeof o.lorebookEntries.delete!=\"function\"){console.warn(\"[RegexLoreHub] appState.lorebookEntries.delete is not a function, reinitializing...\"),o.lorebookEntries=new Map;return}o.lorebookEntries.delete(e)}catch(r){console.error(\"[RegexLoreHub] Error in safeDeleteLorebookEntries:\",r),o.lorebookEntries=new Map}},Bt=()=>{try{if(!o.lorebookEntries||!(o.lorebookEntries instanceof Map)){console.warn(\"[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...\"),o.lorebookEntries=new Map;return}if(typeof o.lorebookEntries.clear!=\"function\"){console.warn(\"[RegexLoreHub] appState.lorebookEntries.clear is not a function, reinitializing...\"),o.lorebookEntries=new Map;return}o.lorebookEntries.clear()}catch(e){console.error(\"[RegexLoreHub] Error in safeClearLorebookEntries:\",e),o.lorebookEntries=new Map}},Ot=e=>{try{return!o.lorebookEntries||!(o.lorebookEntries instanceof Map)?(console.warn(\"[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...\"),o.lorebookEntries=new Map,!1):typeof o.lorebookEntries.has!=\"function\"?(console.warn(\"[RegexLoreHub] appState.lorebookEntries.has is not a function, reinitializing...\"),o.lorebookEntries=new Map,!1):o.lorebookEntries.has(e)}catch(r){return console.error(\"[RegexLoreHub] Error in safeHasLorebookEntries:\",r),o.lorebookEntries=new Map,!1}};function $e(){return window.parent||window}function we(){return $e().document}var O=e=>{if(typeof e!=\"string\")return String(e);let r=we().createElement(\"div\");return r.textContent=e,r.innerHTML},xr=(e,r)=>{if(!r||!e)return O(e);let t=O(e),a=O(r),l=new Set([\".\",\"*\",\"+\",\"?\",\"^\",\"$\",\"{\",\"}\",\"(\",\")\",\"|\",\"[\",\"]\",\"\\\\\\\\\"]),n=\"\";for(let h of a)n+=l.has(h)?\"\\\\\"+h:h;let i=new RegExp(`(${n})`,\"gi\");return t.replace(i,'<mark class=\"rlh-highlight\">$1</mark>')},ve=(e,r=\"success\",t=2e3)=>{let a=xe(),l=we();if(!a||!l)return;let n=a(`#${ke}`,l);if(n.length===0)return;n.find(\".rlh-toast-notification\").remove();let i={success:\"fa-check-circle\",error:\"fa-times-circle\",info:\"fa-info-circle\"}[r],h=`\n    <div class=\"rlh-toast-notification ${r}\">\n      <i class=\"fa-solid ${i}\"></i> ${O(e)}\n    </div>\n  `,m=a(h);n.append(m),setTimeout(()=>m.addClass(\"visible\"),10),setTimeout(()=>{m.removeClass(\"visible\"),setTimeout(()=>m.remove(),300)},t)},lr=(e=\"\\u6B63\\u5728\\u5904\\u7406...\")=>{let r=xe(),t=we();if(!r||!t)return{update:()=>{},remove:()=>{}};let a=r(`#${ke}`,t);if(a.length===0)return{update:()=>{},remove:()=>{}};a.find(\".rlh-progress-toast\").remove();let l=`<div class=\"rlh-progress-toast\"><i class=\"fa-solid fa-spinner fa-spin\"></i> <span class=\"rlh-progress-text\">${O(e)}</span></div>`,n=r(l);return a.append(n),setTimeout(()=>n.addClass(\"visible\"),10),{update:m=>{n.find(\".rlh-progress-text\").html(O(m))},remove:()=>{n.removeClass(\"visible\"),setTimeout(()=>n.remove(),300)}}},J=e=>{let r=xe(),t=we();return!r||!t?Promise.reject():new Promise((a,l)=>{let{type:n=\"alert\",title:i=\"\\u901A\\u77E5\",text:h=\"\",html:m=\"\",placeholder:b=\"\",value:p=\"\"}=e||{},f=\"\";n===\"alert\"?f='<button class=\"rlh-modal-btn rlh-modal-ok\">\\u786E\\u5B9A</button>':n===\"confirm\"?f='<button class=\"rlh-modal-btn rlh-modal-cancel\">\\u53D6\\u6D88</button><button class=\"rlh-modal-btn rlh-modal-ok\">\\u786E\\u8BA4</button>':n===\"prompt\"&&(f='<button class=\"rlh-modal-btn rlh-modal-cancel\">\\u53D6\\u6D88</button><button class=\"rlh-modal-btn rlh-modal-ok\">\\u786E\\u5B9A</button>');let v=n===\"prompt\"?`<input type=\"text\" class=\"rlh-modal-input\" placeholder=\"${O(b)}\" value=\"${O(p)}\">`:\"\",w=m||`<p>${O(h)}</p>`,T=`<div class=\"rlh-modal-overlay\"><div class=\"rlh-modal-content\"><div class=\"rlh-modal-header\">${O(i)}</div><div class=\"rlh-modal-body\">${w}${v}</div><div class=\"rlh-modal-footer\">${f}</div></div></div>`,k=r(T).hide(),I=r(`#${ke}`,t);I.length>0?I.append(k):r(\"body\",t).append(k),k.fadeIn(200);let s=k.find(\".rlh-modal-input\");n===\"prompt\"&&s.focus().select();let g=(x,C)=>{k.fadeOut(200,()=>{k.remove(),x?a(C):l()})};k.on(\"click\",\".rlh-modal-ok\",()=>{let x=n===\"prompt\"?s.val():!0;if(n===\"prompt\"&&!String(x).trim()){s.addClass(\"rlh-input-error\"),setTimeout(()=>s.removeClass(\"rlh-input-error\"),500);return}g(!0,x)}),k.on(\"click\",\".rlh-modal-cancel\",()=>g(!1)),n===\"prompt\"&&s.on(\"keydown\",x=>{x.key===\"Enter\"?k.find(\".rlh-modal-ok\").click():x.key===\"Escape\"&&k.find(\".rlh-modal-cancel\").click()})})},A=(e,r=\"RegexLoreHub\",t={})=>{let{notify:a=\"toast\",toastType:l=\"error\",toastDuration:n=4e3,toastMessage:i=\"\\u64CD\\u4F5C\\u53D1\\u751F\\u5F02\\u5E38\\uFF0C\\u8BF7\\u67E5\\u770B\\u63A7\\u5236\\u53F0\\u83B7\\u53D6\\u8BE6\\u7EC6\\u4FE1\\u606F\\u3002\",modalTitle:h=\"\\u811A\\u672C\\u5F02\\u5E38\",modalText:m=\"\\u64CD\\u4F5C\\u4E2D\\u53D1\\u751F\\u672A\\u77E5\\u9519\\u8BEF\\uFF0C\\u8BF7\\u68C0\\u67E5\\u5F00\\u53D1\\u8005\\u63A7\\u5236\\u53F0\\u83B7\\u53D6\\u8BE6\\u7EC6\\u4FE1\\u606F\\u3002\"}=t??{};return async(...b)=>{try{return await e(...b)}catch(p){if(!p)return;if(console.error(`[${r}] Error:`,p),a===\"modal\"){await J({type:\"alert\",title:h,text:m});return}a===\"toast\"&&ve(i,l,n)}}};function Dt(e,r){let t;return function(...a){let l=this;clearTimeout(t),t=setTimeout(()=>e.apply(l,a),r)}}var So=(e,r)=>{let t=e.replace(/[.*+?^${}()|[\\]\\/\\\\]/g,\"\\\\$&\"),a=r?\"g\":\"gi\";return new RegExp(t,a)},_o={INSERT_RULES_TITLE:\"\\u63D2\\u5165\\u89C4\\u5219\"};var Cr=e=>e.instanceKey||e.id||\"default\",vr=e=>{let r=Cr(e);return o.collapseStateByContext.get(r)??\"expanded\"},Eo=(e,r)=>{let t=Cr(e);o.collapseStateByContext.set(t,r)},dr=e=>{let r=Array.isArray(e.sortOptions)?e.sortOptions:[];if(!r.length)return null;let t=Cr(e),a=o.sortModeByContext.get(t);if(a&&r.includes(a))return a;let l=r[0];return o.sortModeByContext.set(t,l),l},$o=(e,r)=>{if(!(e.sortOptions??[]).includes(r))return;let a=Cr(e);o.sortModeByContext.set(a,r)},qr=e=>O(String(e??\"\")),dt=e=>qe(e)??Re,ht=(e,{shortLabel:r=!1,withIcon:t=!0}={})=>{let a=dt(e),l=r?a.shortLabel:a.label,n=t?'<i class=\"fa-solid fa-circle\"></i>':\"\";return`<span class=\"rlh-status-badge ${a.badgeClass??\"\"}\" data-status-id=\"${qr(a.id)}\">${n}<span class=\"rlh-status-badge__text\">${O(l)}</span></span>`},Kl=()=>nt.map(e=>{let r=ht(e.id,{shortLabel:!0});return`<li role=\"presentation\"><button type=\"button\" class=\"rlh-unified-status-option\" data-status-id=\"${qr(e.id)}\" role=\"option\" aria-selected=\"false\">${r}<span class=\"rlh-unified-status-option__label\">${O(e.label)}</span></button></li>`}).join(\"\"),Vl=(e,r)=>{let t=e.visibleFilters??[];if(!t.length)return\"\";let a=t.map(l=>{let n=yo[l];if(!n)return\"\";let i=e.filterLabels?.[l]??Lr[l]??l,h=r[l];return`<label class=\"rlh-filter-item\"><input type=\"checkbox\" id=\"${n.id}\" data-filter-key=\"${l}\" ${h?\"checked\":\"\"}>${i}</label>`}).filter(Boolean).join(\"\");return a?`<div class=\"rlh-filter-list\" id=\"rlh-search-filters-container\">${a}</div>`:\"\"},Yl=(e,r)=>{let t=Array.isArray(e.sortOptions)?e.sortOptions:[];if(!t.length)return\"\";let a=t.map(n=>{let i=ko[n];if(!i)return\"\";let h=i.value===r;return`<li role=\"presentation\"><button type=\"button\" class=\"rlh-sort-option${h?\" active\":\"\"}\" data-sort-value=\"${i.value}\" role=\"option\" aria-selected=\"${h?\"true\":\"false\"}\">${i.label}</button></li>`}).filter(Boolean).join(\"\");if(!a)return\"\";let l=`${Er}-list`;return`<div class=\"rlh-sort-menu\" id=\"${Er}\" data-open=\"false\"><button type=\"button\" id=\"${ir}\" class=\"rlh-toolbar-btn\" data-current-sort=\"${r??\"\"}\" aria-haspopup=\"listbox\" aria-expanded=\"false\" aria-controls=\"${l}\"><i class=\"fa-solid fa-sort\"></i><span>\\u6392\\u5E8F</span></button><ul class=\"rlh-sort-menu-list\" id=\"${l}\" role=\"listbox\" aria-labelledby=\"${ir}\">${a}</ul></div>`},ql=e=>{if(!e.showPositionMenu)return\"\";let r=new Map;o.selectedItems.forEach(k=>{if(typeof k!=\"string\"||!k.startsWith(\"lore:\"))return;let I=k.lastIndexOf(\":\");if(I===-1)return;let s=k.slice(5,I),g=k.slice(I+1),x=ze(s),C=ze(g);!x||C===\"\"||(r.has(x)||r.set(x,[]),r.get(x).push(C))});let t=e.activeBookName?.toString().trim()??\"\";!t&&r.size===1&&(t=[...r.keys()][0]??\"\");let a=t?ne(t):[],l=a.length>0,n=o.multiSelectMode&&o.multiSelectTarget===\"entry\",i=t?r.get(t)??[]:[],h=!!t&&(n?i.length>0:l),m;t?!l&&!n?m=`\\u300C${t}\\u300D\\u6682\\u65E0\\u6761\\u76EE\\u53EF\\u8C03\\u6574`:n?m=i.length>0?`\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u5C06\\u5BF9\\u5DF2\\u9009\\u4E2D\\u7684 ${i.length} \\u4E2A\\u6761\\u76EE\\u7EDF\\u4E00\\u4F4D\\u7F6E`:\"\\u5DF2\\u5F00\\u542F\\u591A\\u9009\\uFF0C\\u8BF7\\u5148\\u52FE\\u9009\\u8981\\u8C03\\u6574\\u4F4D\\u7F6E\\u7684\\u6761\\u76EE\":m=`\\u5C06\\u5BF9\\u300C${t}\\u300D\\u4E2D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u7EDF\\u4E00\\u4F4D\\u7F6E`:m=r.size>0?\"\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u672A\\u80FD\\u8BC6\\u522B\\u9009\\u4E2D\\u7684\\u6761\\u76EE\\u5F52\\u5C5E\\uFF0C\\u8BF7\\u91CD\\u65B0\\u9009\\u62E9\":\"\\u8BF7\\u5148\\u6253\\u5F00\\u9700\\u8981\\u7EDF\\u4E00\\u4F4D\\u7F6E\\u7684\\u4E16\\u754C\\u4E66\";let b=new Set(a.map(k=>(k?.position??\"before_character_definition\").toString())),p=b.size===1?b.values().next().value:null,f=`${or}-list`,v=['type=\"button\"',`id=\"${Qe}\"`,'class=\"rlh-toolbar-btn\"','aria-haspopup=\"listbox\"','aria-expanded=\"false\"',`aria-controls=\"${f}\"`,`title=\"${O(m)}\"`];h||v.push(\"disabled\"),t&&v.push(`data-book-name=\"${O(t)}\"`);let w=Object.entries(Xe.position).map(([k,I])=>{let s=l&&p===k,g=['type=\"button\"',`class=\"rlh-position-option${s?\" active\":\"\"}\"`,`data-position-value=\"${O(k)}\"`,'role=\"option\"',`aria-selected=\"${s?\"true\":\"false\"}\"`];return t&&g.push(`data-book-name=\"${O(t)}\"`),`<li role=\"presentation\"><button ${g.join(\" \")}>${O(I)}</button></li>`}).join(\"\"),T=['class=\"rlh-position-menu\"',`id=\"${or}\"`,'data-open=\"false\"'];return t&&T.push(`data-book-name=\"${O(t)}\"`),`<div ${T.join(\" \")}><button ${v.join(\" \")}><i class=\"fa-solid fa-map-pin\"></i><span>\\u7EDF\\u4E00\\u4F4D\\u7F6E</span></button><ul class=\"rlh-position-menu-list\" id=\"${f}\" role=\"listbox\" aria-labelledby=\"${Qe}\">${w}</ul></div>`},To=(e,{$toolbar:r,$replaceContainer:t})=>{let a=vr(e),l=e.sortOptions?.length??0?dr(e):null,n=[\"rlh-toolbar-btn\"];o.multiSelectMode&&n.push(\"active\"),e.supportsMultiSelect||n.push(\"disabled\");let i=['type=\"button\"','id=\"rlh-multi-select-btn\"',`class=\"${n.join(\" \")}\"`,`data-target=\"${e.supportsMultiSelect?e.multiSelectTarget:\"\"}\"`];e.supportsMultiSelect||i.push(\"disabled\");let h=`<button ${i.join(\" \")}><i class=\"fa-solid fa-check-double\"></i><span>\\u591A\\u9009\\u6A21\\u5F0F</span></button>`,m=[\"rlh-multi-select-controls\"];o.multiSelectMode&&m.push(\"active\");let b=e.supportsMultiSelect?`\n        <div id=\"rlh-multi-select-controls\" class=\"${m.join(\" \")}\">\n          <div class=\"rlh-multi-select-actions\">\n            <button class=\"rlh-multi-select-action-btn\" id=\"rlh-select-all-btn\" title=\"\\u5168\\u9009\">\\u5168</button>\n            <button class=\"rlh-multi-select-action-btn\" id=\"rlh-select-none-btn\" title=\"\\u6E05\\u9664\">\\u6E05</button>\n            <button class=\"rlh-multi-select-action-btn\" id=\"rlh-select-invert-btn\" title=\"\\u53CD\\u9009\">\\u53CD</button>\n            <button class=\"rlh-multi-select-action-btn enable\" id=\"rlh-batch-enable-btn\" title=\"\\u542F\\u7528\">\\u5F00</button>\n            <button class=\"rlh-multi-select-action-btn disable\" id=\"rlh-batch-disable-btn\" title=\"\\u7981\\u7528\">\\u5173</button>\n            <button class=\"rlh-multi-select-action-btn disable\" id=\"rlh-batch-delete-btn\" title=\"\\u5220\\u9664\">\\u5220</button>\n          </div>\n          <span class=\"rlh-selection-count\" id=\"rlh-selection-count\">\\u5DF2\\u9009\\u62E9: ${o.selectedItems.size}</span>\n        </div>\n      `:\"\",p=`\n        <div class=\"rlh-multi-select-module\">\n          ${h}\n          ${b}\n        </div>\n      `,f=e.supportsMultiSelect&&e.multiSelectTarget===\"entry\"?(()=>{let L=`${$r}`,N=`${$r}-list`,R=Kl(),H=[\"rlh-unified-status\"];o.multiSelectMode&&H.push(\"is-multiselect\");let F=new Map;o.selectedItems.forEach(be=>{if(typeof be!=\"string\"||!be.startsWith(\"lore:\"))return;let de=be.lastIndexOf(\":\");if(de===-1)return;let Ge=be.slice(5,de),Le=be.slice(de+1),Ke=ze(Ge),br=ze(Le);!Ke||br===\"\"||(F.has(Ke)||F.set(Ke,[]),F.get(Ke).push(br))});let B=[e.activeBookName,o.activeBookName,o.activeCharacterBook,o.chatLorebook].find(be=>typeof be==\"string\"&&be.trim().length>0)?.toString().trim()??\"\";!B&&F.size===1&&(B=[...F.keys()][0]??\"\");let te=(B?ne(B):[]).length>0,ie=o.multiSelectMode&&o.multiSelectTarget===\"entry\",ae=B?F.get(B)??[]:[],ge=Array.from(F.values()).reduce((be,de)=>be+(Array.isArray(de)?de.length:0),0),_e=!!B&&(ie?ae.length>0:te),G;return B?!te&&!ie?G=`\\u300C${B}\\u300D\\u6682\\u65E0\\u6761\\u76EE\\u53EF\\u8C03\\u6574`:ie?G=ae.length>0?`\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u5C06\\u5BF9\\u5DF2\\u9009\\u4E2D\\u7684 ${ae.length} \\u4E2A\\u6761\\u76EE\\u7EDF\\u4E00\\u72B6\\u6001`:\"\\u5DF2\\u5F00\\u542F\\u591A\\u9009\\uFF0C\\u8BF7\\u5148\\u52FE\\u9009\\u8981\\u8C03\\u6574\\u72B6\\u6001\\u7684\\u6761\\u76EE\":G=`\\u5C06\\u5BF9\\u300C${B||\"\\u5F53\\u524D\\u4E16\\u754C\\u4E66\"}\\u300D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u7EDF\\u4E00\\u72B6\\u6001`:G=F.size>0?\"\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u672A\\u80FD\\u8BC6\\u522B\\u9009\\u4E2D\\u7684\\u6761\\u76EE\\u5F52\\u5C5E\\uFF0C\\u8BF7\\u91CD\\u65B0\\u9009\\u62E9\":\"\\u8BF7\\u5148\\u6253\\u5F00\\u9700\\u8981\\u7EDF\\u4E00\\u72B6\\u6001\\u7684\\u4E16\\u754C\\u4E66\",`\n            <div class=\"${H.join(\" \")}\" id=\"${L}\" data-open=\"false\">\n              <button type=\"button\" id=\"${sr}\" class=\"rlh-toolbar-btn\" aria-haspopup=\"listbox\" aria-expanded=\"false\" aria-controls=\"${N}\" ${_e?\"\":\"disabled\"} title=\"${O(G)}\">\n                <i class=\"fa-solid fa-layer-group\"></i><span>\\u7EDF\\u4E00\\u72B6\\u6001</span>\n              </button>\n              <ul class=\"rlh-unified-status-menu\" id=\"${N}\" role=\"listbox\">\n                ${R}\n              </ul>\n            </div>\n          `})():\"\",v=\"\";e.showCollapseToggle&&(v=`<button type=\"button\" id=\"${_r}\" class=\"rlh-toolbar-btn\" data-collapse-state=\"${a}\"><i class=\"fa-solid ${a===\"collapsed\"?\"fa-expand-arrows-alt\":\"fa-compress-arrows-alt\"}\"></i><span>${a===\"collapsed\"?\"\\u5168\\u90E8\\u5C55\\u5F00\":\"\\u5168\\u90E8\\u6298\\u53E0\"}</span></button>`);let w=e.showRecursion?(()=>{let L=e.activeBookName??\"\",N=['type=\"button\"',`id=\"${co}\"`,'class=\"rlh-toolbar-btn rlh-batch-recursion-btn\"'];return L?N.push(`data-book-name=\"${O(L)}\"`):N.push(\"disabled\"),`<button ${N.join(\" \")}><i class=\"fa-solid fa-shield-halved\"></i><span>\\u5168\\u5F00\\u9632\\u9012\\u5F52</span></button>`})():\"\",T=e.showFixKeywords?(()=>{let L=e.activeBookName??\"\",N=['type=\"button\"',`id=\"${ho}\"`,'class=\"rlh-toolbar-btn rlh-fix-keywords-btn\"'];return L?N.push(`data-book-name=\"${O(L)}\"`):N.push(\"disabled\"),`<button ${N.join(\" \")}><i class=\"fa-solid fa-check-double\"></i><span>\\u4FEE\\u590D\\u5173\\u952E\\u8BCD</span></button>`})():\"\",k=ql(e),I=Yl(e,l),s=Vl(e,o.searchFilters),g=O(e.scopeLabel),x=O(e.searchPlaceholder),C=qr(o.globalSearch.term??\"\"),K=`<div class=\"rlh-search-row\">${`<label class=\"rlh-search-field\">\n          <input type=\"search\" id=\"${nr}\" class=\"rlh-search-input\" placeholder=\"${x}\" value=\"${C}\" autocomplete=\"off\" />\n        </label>`}<button type=\"button\" id=\"rlh-search-clear-btn\" class=\"rlh-toolbar-icon-btn\" title=\"\\u6E05\\u7A7A\"><i class=\"fa-solid fa-eraser\"></i></button></div>`,ce=qr(o.globalSearch.replace??\"\"),q=e.showReplace?`<div class=\"rlh-replace-body\"><input type=\"text\" id=\"${Sr}\" class=\"rlh-replace-input\" placeholder=\"\\u66FF\\u6362\\u4E3A...\" value=\"${ce}\" /><button type=\"button\" id=\"rlh-replace-btn\" class=\"rlh-toolbar-icon-btn rlh-replace-action\" title=\"\\u66FF\\u6362\"><i class=\"fa-solid fa-repeat\"></i></button></div>`:\"\",Z=`<div class=\"rlh-search-meta\">\n          ${s}\n          <span class=\"rlh-search-scope\">${g}</span>\n        </div>`,W=`<div class=\"rlh-search-box\">${K}${q}${Z}</div>`,oe=\"\";if(e.primaryAction?.visible&&e.primaryAction.scope===\"entry\"){let L=e.activeBookName??\"\",N=!L,R=[\"rlh-toolbar-btn\",\"rlh-create-entry-btn\"];N&&R.push(\"disabled\");let H=['type=\"button\"',`class=\"${R.join(\" \")}\"`],F=e.primaryAction.title??e.primaryAction.label??\"\";F&&H.push(`title=\"${O(F)}\"`),N?H.push(\"disabled\"):H.push(`data-book-name=\"${O(L)}\"`);let Q=e.primaryAction.icon?e.primaryAction.icon:\"fa-file-circle-plus\",B=O(e.primaryAction.label??\"\\u65B0\\u5EFA\\u6761\\u76EE\");oe=`<button ${H.join(\" \")}><i class=\"fa-solid ${Q}\"></i><span>${B}</span></button>`}let ue=\"\";if(e.primaryAction?.visible&&e.primaryAction.scope===\"book\"){let N=['type=\"button\"','id=\"regex-lore-hub-create-lorebook-btn\"',`class=\"${[\"rlh-toolbar-btn\",\"rlh-create-book-btn\"].join(\" \")}\"`],R=e.primaryAction.title??e.primaryAction.label??\"\";R&&N.push(`title=\"${O(R)}\"`);let H=e.primaryAction.icon?e.primaryAction.icon:\"fa-plus\",F=O(e.primaryAction.label??\"\\u65B0\\u5EFA\\u4E16\\u754C\\u4E66\");ue=`<button ${N.join(\" \")}><i class=\"fa-solid ${H}\"></i><span>${F}</span></button>`}let re=e.id===\"global-lore-list\"?'<button type=\"button\" class=\"rlh-toolbar-btn rlh-select-unbound\" title=\"\\u4E00\\u952E\\u9009\\u4E2D\\u672A\\u7ED1\\u5B9A\\u4EFB\\u4F55\\u89D2\\u8272\\u5361\\u7684\\u4E16\\u754C\\u4E66\"><i class=\"fa-solid fa-link-slash\"></i><span>\\u9009\\u62E9\\u5B64\\u7ACB\\u4E16\\u754C\\u4E66</span></button>':\"\",pe=`\n    <div class=\"rlh-toolbar-section rlh-toolbar-section--search\">\n      <div class=\"rlh-search-section-grid\">\n        <div class=\"rlh-search-section-main\">\n          ${W}\n        </div>\n        <div class=\"rlh-search-section-multiselect\">\n          ${p}\n        </div>\n      </div>\n    </div>\n  `,le=[ue,re,oe,e.showCollapseToggle?v:\"\",w,T,f,k,I].filter(Boolean),u=le.length?`\n        <div class=\"rlh-toolbar-section rlh-toolbar-section--actions\">\n          <div class=\"rlh-toolbar-actions\">\n            ${le.join(\"\")}\n          </div>\n        </div>\n      `:\"\",M=`\n    <div class=\"rlh-toolbar-inner\">\n      ${[pe,u].filter(Boolean).join(\"\")}\n    </div>\n\n  `;if(r.html(M),e.supportsMultiSelect&&e.multiSelectTarget===\"entry\"){let N=[e.activeBookName,o.activeBookName,o.activeCharacterBook,o.chatLorebook].find(ae=>typeof ae==\"string\"&&ae.trim().length>0)?.toString().trim()??\"\",R=N?ne(N):[],H=R.length>0,F=o.multiSelectMode&&o.multiSelectTarget===\"entry\",Q=gr(N),B=F&&R.length>0&&[...o.selectedItems].some(ae=>typeof ae==\"string\"&&ae.startsWith(Q)),j=H&&(!F||B),te=H?F?B?\"\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u4EC5\\u5BF9\\u9009\\u4E2D\\u7684\\u6761\\u76EE\\u7EDF\\u4E00\\u72B6\\u6001\":\"\\u5DF2\\u5F00\\u542F\\u591A\\u9009\\uFF0C\\u8BF7\\u5148\\u52FE\\u9009\\u8981\\u8C03\\u6574\\u72B6\\u6001\\u7684\\u6761\\u76EE\":`\\u5C06\\u5BF9\\u300C${N||\"\\u5F53\\u524D\\u4E16\\u754C\\u4E66\"}\\u300D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u7EDF\\u4E00\\u72B6\\u6001`:N?`\\u300C${N}\\u300D\\u6682\\u65E0\\u6761\\u76EE\\u53EF\\u8C03\\u6574`:\"\\u8BF7\\u5148\\u6253\\u5F00\\u9700\\u8981\\u7EDF\\u4E00\\u72B6\\u6001\\u7684\\u4E16\\u754C\\u4E66\",ie=$(`#${sr}`,r);ie.length&&(ie.attr(\"title\",te),j?ie.removeAttr(\"disabled\"):ie.attr(\"disabled\",\"disabled\"))}t.empty()},yr=(e,r)=>{let t=r.toLowerCase();return!!(!t||o.searchFilters.entryName&&(e.name||\"\").toLowerCase().includes(t)||o.searchFilters.keywords&&e.keys.join(\" \").toLowerCase().includes(t)||o.searchFilters.content&&e.content&&e.content.toLowerCase().includes(t))},Lo=(e,r)=>{let t=r.toLowerCase();return!!(o.searchFilters.entryName&&(e.script_name||\"\").toLowerCase().includes(t)||o.searchFilters.content&&(e.find_regex||\"\").toLowerCase().includes(t)||o.searchFilters.content&&(e.replace_string||\"\").toLowerCase().includes(t))},Co=(e,r,t,a)=>{let l=xe(),n=o.lorebookUsage.get(e.name)||[],i=n.length>0?`<div class=\"rlh-used-by-chars\">\\u4F7F\\u7528\\u8005: ${n.map(g=>`<span>${O(g)}</span>`).join(\", \")}</div>`:\"\",h=xr(e.name,r),m=o.multiSelectMode&&o.multiSelectTarget===\"book\",b=Ze(e.name),p=typeof b==\"string\"&&b.length>0,f=m&&p&&o.selectedItems.has(b),v=m?`<label class=\"rlh-selection-control\"><input type=\"checkbox\" class=\"rlh-multi-select-checkbox\" data-select-key=\"${O(b)}\" ${f?\"checked\":\"\"}></label>`:\"\",w=l(`\n      <div class=\"rlh-book-group\" data-book-name=\"${O(e.name)}\" data-select-key=\"${O(b)}\">\n          <div class=\"rlh-global-book-header rlh-clickable-header\">\n              ${v}\n              <div class=\"rlh-book-title-wrapper\">\n                  <span class=\"rlh-item-name\">${h}</span>\n                  <div class=\"rlh-book-stats\">\\u6761\\u76EE: ${e.enabledEntryCount} / ${e.entryCount}</div>\n              </div>\n              <div class=\"rlh-item-controls\">\n                  <button class=\"rlh-action-btn-icon rlh-rename-book-btn\" title=\"\\u91CD\\u547D\\u540D\\u4E16\\u754C\\u4E66\"><i class=\"fa-solid fa-pen-to-square\"></i></button>\n                  <button class=\"rlh-toggle-btn rlh-global-toggle\" title=\"\\u542F\\u7528/\\u7981\\u7528\\u6574\\u4E2A\\u4E16\\u754C\\u4E66\"><i class=\"fa-solid fa-power-off\"></i></button>\n                  <button class=\"rlh-action-btn-icon rlh-delete-book-btn\" title=\"\\u5220\\u9664\\u4E16\\u754C\\u4E66\"><i class=\"fa-solid fa-folder-minus\"></i></button>\n              </div>\n          </div>\n          ${n.length>0?`<div class=\"rlh-book-summary\">${i}</div>`:\"\"}\n          <div class=\"rlh-collapsible-content\"></div>\n      </div>\n    `);w.toggleClass(\"enabled\",e.enabled),w.find(\".rlh-global-book-header\").toggleClass(\"enabled\",e.enabled),w.toggleClass(\"selected\",f);let T=w.find(\".rlh-collapsible-content\"),k=l(`<div class=\"rlh-entry-actions\"><button class=\"rlh-action-btn rlh-create-entry-btn\" data-book-name=\"${O(e.name)}\"><i class=\"fa-solid fa-plus\"></i> \\u65B0\\u5EFA\\u6761\\u76EE</button><button class=\"rlh-action-btn rlh-batch-recursion-btn\" data-book-name=\"${O(e.name)}\"><i class=\"fa-solid fa-shield-halved\"></i> \\u5168\\u5F00\\u9632\\u9012\\u5F52</button><button class=\"rlh-action-btn rlh-fix-keywords-btn\" data-book-name=\"${O(e.name)}\"><i class=\"fa-solid fa-check-double\"></i> \\u4FEE\\u590D\\u5173\\u952E\\u8BCD</button></div>`);T.append(k);let I=[...ne(e.name)].sort((g,x)=>(g.display_index??Number.MAX_SAFE_INTEGER)-(x.display_index??Number.MAX_SAFE_INTEGER)),s=t?I:a||[];if(s&&s.length>0){let g=l('<div class=\"rlh-entry-list-wrapper\"></div>');s.forEach(x=>g.append(hr(x,\"lore\",e.name,r,{enableDrag:!1}))),T.append(g)}else r&&T.append('<div class=\"rlh-info-text-small\">\\u65E0\\u5339\\u914D\\u9879</div>');return w},ct=e=>typeof e==\"string\"?e.replace(/\\r?\\n/g,\"<br>\"):e,Yr=e=>`<span class=\"rlh-viewer-empty\">${O(e)}</span>`,pt=(e,r)=>{let t=dt(e?.statusId),a=ht(t.id),n=(Array.isArray(e?.keys)?e.keys:[]).join(\", \"),i=n?ct(r?xr(n,r):O(n)):Yr(\"\\u6682\\u65E0\\u5173\\u952E\\u8BCD\"),h=e?.content??\"\",m=h?ct(r?xr(h,r):O(h)):Yr(\"\\u6682\\u65E0\\u5185\\u5BB9\"),b=W=>W!=null&&W!==\"\",p=(W,oe=\"\\u672A\\u8BBE\\u7F6E\")=>b(W)?O(String(W)):Yr(oe),f=W=>{if(!W)return\"\";let{label:oe,value:ue,placeholder:re,html:pe}=W,le=pe!==void 0?pe:p(ue,re);return`\n      <div class=\"rlh-editor-field rlh-viewer-field\">\n        <label>${oe}</label>\n        <div class=\"rlh-viewer-text\">${le}</div>\n      </div>\n    `},v=(W,oe,ue={})=>{if(!oe.length)return\"\";let re=ue.layout??\"grid\",pe=W?`<h5>${W}</h5>`:\"\",le=\"\";return re===\"grid\"?le=`\n        <div class=\"rlh-editor-grid\">${oe.map(_=>`\n          <div class=\"rlh-grid-item\">${f(_)}</div>`).join(\"\")}\n        </div>\n      `:le=oe.map(f).join(\"\"),`\n      <div class=\"rlh-editor-group rlh-viewer-group\">\n        ${pe}\n        ${le}\n      </div>\n    `},w=(()=>{let W=e?.position;return b(W)?typeof W==\"object\"&&W!==null&&typeof W.type==\"string\"&&W.type?Xe.position?.[W.type]??W.type:typeof W==\"string\"?Xe.position?.[W]??W:null:null})(),T=b(e?.depth)?e.depth:null,k=b(e?.order)?e.order:null,I=b(e?.logic),s=I?e.logic:\"and_any\",g=Xe.logic?.[s]??s,x=I?g:`${g} (\\u9ED8\\u8BA4)`,C=b(e?.probability)?`${e.probability}%`:\"100% (\\u9ED8\\u8BA4)\",D=f({label:\"\\u5173\\u952E\\u8BCD\",html:i}),S=f({label:\"\\u5185\\u5BB9\",html:`<article class=\"rlh:prose rlh:dark:rlh:prose-invert max-w-none\">${m}</article>`}),K=v(_o.INSERT_RULES_TITLE,[{label:\"\\u4F4D\\u7F6E\",value:w,placeholder:\"\\u672A\\u8BBE\\u7F6E\"},{label:\"\\u6DF1\\u5EA6\",value:T,placeholder:\"\\u672A\\u8BBE\\u7F6E\"},{label:\"\\u987A\\u5E8F\",value:k,placeholder:\"\\u672A\\u8BBE\\u7F6E\"}],{layout:\"grid\"}),ce=v(\"\\u6FC0\\u6D3B\\u903B\\u8F91\",[{label:\"\\u6982\\u7387\",value:C,placeholder:\"100% (\\u9ED8\\u8BA4)\"},{label:\"\\u5173\\u952E\\u8BCD\\u903B\\u8F91\",value:x,placeholder:\"\\u4EFB\\u4E00 AND (\\u9ED8\\u8BA4)\"}],{layout:\"grid\"}),q=v(\"\\u5339\\u914D\\u4E0E\\u9012\\u5F52\",[{label:\"\\u5927\\u5C0F\\u5199\\u654F\\u611F\",value:e?.case_sensitive?\"\\u5F00\\u542F\":\"\\u5173\\u95ED\",placeholder:\"\\u5173\\u95ED\"},{label:\"\\u5168\\u8BCD\\u5339\\u914D\",value:e?.match_whole_words?\"\\u5F00\\u542F\":\"\\u5173\\u95ED\",placeholder:\"\\u5173\\u95ED\"},{label:\"\\u9632\\u6B62\\u9012\\u5F52\",value:e?.prevent_recursion?\"\\u5F00\\u542F\":\"\\u5173\\u95ED\",placeholder:\"\\u5173\\u95ED\"},{label:\"\\u4E0D\\u53EF\\u88AB\\u9012\\u5F52\",value:e?.exclude_recursion?\"\\u5F00\\u542F\":\"\\u5173\\u95ED\",placeholder:\"\\u5173\\u95ED\"}],{layout:\"grid\"});return`\n    <div class=\"rlh-entry-viewer\" data-mode=\"view\">\n      ${v(\"\\u72B6\\u6001\",[{label:\"\\u5F53\\u524D\\u72B6\\u6001\",html:a}],{layout:\"grid\"})}\n      ${D}\n      ${S}\n      ${K}\n      ${ce}\n      ${q}\n    </div>\n  `},Ht=(e,r)=>{let t=e?.find_regex??\"\",a=e?.replace_string??\"\",l=typeof r==\"string\"?r:\"\",n=t?ct(l?xr(t,l):O(t)):Yr(\"\\u6682\\u65E0\\u67E5\\u627E\\u6B63\\u5219\"),i=a?ct(l?xr(a,l):O(a)):Yr(\"\\u6682\\u65E0\\u66FF\\u6362\\u5185\\u5BB9\"),h=e?.destination??{},m=e?.source??{},b=e?.min_depth,p=e?.max_depth,f=[];h.display&&f.push(\"\\u4EC5\\u683C\\u5F0F\\u663E\\u793A\"),h.prompt&&f.push(\"\\u4EC5\\u683C\\u5F0F\\u63D0\\u793A\\u8BCD\");let v=f.length?f.join(\" / \"):\"\\u683C\\u5F0F\\u4E0E\\u63D0\\u793A\\u8BCD\",T=Object.entries({user_input:\"\\u7528\\u6237\\u8F93\\u5165\",ai_output:\"AI\\u8F93\\u51FA\",slash_command:\"\\u659C\\u6760\\u547D\\u4EE4\",world_info:\"\\u4E16\\u754C\\u4E66\"}).filter(([D])=>!!m?.[D]).map(([,D])=>D),k=T.length===0?\"\\u672A\\u9009\\u62E9\\u4F5C\\u7528\\u8303\\u56F4\":T.length===4?\"\\u5168\\u90E8\\u6765\\u6E90\":T.join(\" / \"),I=b!=null&&b!==\"\",s=p!=null&&p!==\"\",g=\"\\u65E0\\u6DF1\\u5EA6\\u9650\\u5236\";I&&s?g=`${b} - ${p}`:I?g=`>= ${b}`:s&&(g=`<= ${p}`);let C=[{label:\"\\u8F93\\u51FA\\u8BBE\\u7F6E\",value:v},{label:\"\\u4F5C\\u7528\\u8303\\u56F4\",value:k},{label:\"\\u6DF1\\u5EA6\\u8303\\u56F4\",value:g}].map(D=>`\n      <div class=\"rlh-editor-field rlh-viewer-field\">\n        <label>${D.label}</label>\n        <div class=\"rlh-viewer-text\">${O(String(D.value??\"\"))}</div>\n      </div>\n    `).join(\"\");return`\n    <div class=\"rlh-regex-viewer\" data-mode=\"view\">\n      <div class=\"rlh-editor-field rlh-viewer-field\">\n        <label>\\u67E5\\u627E\\u6B63\\u5219\\u8868\\u8FBE\\u5F0F</label>\n        <article class=\"rlh:prose rlh:dark:rlh:prose-invert max-w-none\">${n}</article>\n      </div>\n      <div class=\"rlh-editor-field rlh-viewer-field\">\n        <label>\\u66FF\\u6362\\u4E3A</label>\n        <article class=\"rlh:prose rlh:dark:rlh:prose-invert max-w-none\">${i}</article>\n      </div>\n      ${C}\n    </div>\n  `},hr=(e,r,t=\"\",a=\"\",l={})=>{let n=xe(),i=r===\"lore\",h=i?e.uid:e.id,m=i?e.name||\"\\u65E0\\u6807\\u9898\\u6761\\u76EE\":e.script_name||\"\\u672A\\u547D\\u540D\\u6B63\\u5219\",b=e.source===\"card\",p=l.collapseState??\"expanded\",f=l.isExpanded??!1,w=(l.enableDrag??!0)&&!b,T=w&&o.isDragSortDisabled,k=T?\"\\u62D6\\u62FD\\u529F\\u80FD\\u4E0D\\u53EF\\u7528\\uFF1A\\u6392\\u5E8F\\u811A\\u672C\\u672A\\u52A0\\u8F7D\":\"\\u62D6\\u62FD\\u6392\\u5E8F\",I=T?' data-disabled=\"true\" aria-disabled=\"true\" style=\"cursor: not-allowed; opacity: 0.6;\"':\"\",s=w?`<span class=\"rlh-drag-handle${T?\" rlh-drag-handle--disabled\":\"\"}\" title=\"${O(k)}\"${I}><i class=\"fa-solid fa-grip-vertical\"></i></span>`:\"\",g=l.selectionKey??(i?Gr(t,h):Kr(h)),x=o.multiSelectTarget,C=o.multiSelectMode&&(x===\"entry\"&&i||x===\"regex\"&&!i),D=C&&o.selectedItems.has(g),S=\"\";i?S=`\n      <button class=\"rlh-action-btn-icon rlh-rename-btn\" title=\"\\u91CD\\u547D\\u540D\\u5E76\\u7F16\\u8F91\"><i class=\"fa-solid fa-pencil\"></i></button>\n      <button class=\"rlh-toggle-btn rlh-item-toggle\" title=\"\\u542F\\u7528/\\u7981\\u7528\\u6B64\\u6761\\u76EE\"><i class=\"fa-solid fa-power-off\"></i></button>\n      <button class=\"rlh-action-btn-icon rlh-delete-entry-btn\" title=\"\\u5220\\u9664\\u6761\\u76EE\"><i class=\"fa-solid fa-trash-can\"></i></button>\n    `:b?S='<button class=\"rlh-toggle-btn rlh-item-toggle\" title=\"\\u542F\\u7528/\\u7981\\u7528\\u6B64\\u6761\\u76EE\"><i class=\"fa-solid fa-power-off\"></i></button>':S=`\n      <button class=\"rlh-action-btn-icon rlh-rename-btn\" title=\"\\u91CD\\u547D\\u540D\\u5E76\\u7F16\\u8F91\"><i class=\"fa-solid fa-pencil\"></i></button>\n      <button class=\"rlh-toggle-btn rlh-item-toggle\" title=\"\\u542F\\u7528/\\u7981\\u7528\\u6B64\\u6761\\u76EE\"><i class=\"fa-solid fa-power-off\"></i></button>\n    `;let K=C?`<label class=\"rlh-selection-control\"><input type=\"checkbox\" class=\"rlh-multi-select-checkbox\" data-select-key=\"${O(g)}\" ${D?\"checked\":\"\"}></label>`:\"\",ce=b?\"\\u6B64\\u6761\\u76EE\\u6765\\u81EA\\u89D2\\u8272\\u5361\\uFF0C\\u90E8\\u5206\\u64CD\\u4F5C\\u53D7\\u9650\":C?\"\\u70B9\\u51FB\\u9009\\u62E9/\\u53D6\\u6D88\\u9009\\u62E9\":\"\\u70B9\\u51FB\\u5C55\\u5F00/\\u7F16\\u8F91\",q=xr(m,a),Z=i?dt(e.statusId):null,W=i?ht(Z.id,{shortLabel:!0}):\"\",oe=\"\";if(i){let u=(e.position??\"before_character_definition\").toString(),_=Xe.position?.[u]??\"\\u9ED8\\u8BA4\\u4F4D\\u7F6E\",M=O(_),L=Number(e.order),N=Number(e.display_index),R=Number.isFinite(L)?`#${L}`:Number.isFinite(N)?`#${N}`:\"\\u672A\\u8BBE\\u7F6E\",H=O(R);oe=`\n          <div class=\"rlh-item-meta\" title=\"\\u63D2\\u5165\\u4E0E\\u987A\\u5E8F\\u4FE1\\u606F\">\n            <span class=\"rlh-item-meta-chip\"><i class=\"fa-solid fa-map-pin\"></i>\\u63D2\\u5165 ${M}</span>\n            <span class=\"rlh-item-meta-chip\"><i class=\"fa-solid fa-list-ol\"></i>\\u987A\\u5E8F ${H}</span>\n          </div>\n        `}let ue=w?` data-drag-enabled=\"${T?\"false\":\"true\"}\"${T?' data-drag-disabled=\"true\"':\"\"}`:\"\",re=n(`<div class=\"rlh-item-container ${b?\"from-card\":\"\"}\" data-type=\"${r}\" data-id=\"${h}\" ${i?`data-book-name=\"${O(t)}\"`:\"\"} data-select-key=\"${O(g)}\"${i?` data-status-id=\"${qr(Z.id)}\"`:\"\"}${ue}>\n      <div class=\"rlh-item-header\" title=\"${ce}\">\n        ${K}\n        ${s}\n        <div class=\"rlh-item-header-main\">\n          <div class=\"rlh-item-title-row\">\n            <span class=\"rlh-item-name\">${q}</span>\n            ${W}\n          </div>\n          ${oe}\n        </div>\n        <div class=\"rlh-item-controls\">${S}</div>\n      </div>\n      <div class=\"rlh-collapsible-content\"></div>\n    </div>`);re.data(\"searchTerm\",a),re.attr(\"data-search-term\",typeof a==\"string\"?a:\"\"),re.toggleClass(\"enabled\",e.enabled),re.toggleClass(\"selected\",D);let pe=re.find(\".rlh-collapsible-content\"),le=l.initialMode;if(!le&&a&&(le=\"viewer\"),f)re.removeClass(\"rlh-collapsed\"),pe.show(),re.attr(\"data-entry-mode\",\"edit\");else if(le===\"viewer\"){let u=i?pt(e,a):Ht(e,a);pe.html(u),pe.show(),re.removeClass(\"rlh-collapsed\"),re.attr(\"data-entry-mode\",\"view\")}else p===\"collapsed\"?(re.addClass(\"rlh-collapsed\"),pe.hide(),re.attr(\"data-entry-mode\",le??\"collapsed\")):(re.removeClass(\"rlh-collapsed\"),re.attr(\"data-entry-mode\",le??\"collapsed\"));return re},No=(e,r)=>{let t=xe(),a=we(),l=t(\".rlh-entry-list-wrapper\",a);if(l.length>0){l.find(\".rlh-info-text\").remove();let n=hr(e,\"lore\",r,\"\",{isExpanded:!0,enableDrag:!1});return l.prepend(n),n}return null},ut=()=>{let e=xe(),r=we();e(\"#rlh-selection-count\",r).text(`\\u5DF2\\u9009\\u62E9: ${o.selectedItems.size}`)},bt=(e,r,t)=>{let a=xe(),l=we(),i=r!=null?Number(r):NaN,h=Number.isInteger(i),m=T=>{if(T==null)return!1;if(h){let k=Number(T);if(Number.isInteger(k))return k===i}return String(T)===String(r)},b=a('.rlh-item-container[data-type=\"lore\"]',l).filter((T,k)=>{let I=a(k),s=I.data(\"book-name\")??I.attr(\"data-book-name\");if(String(s)!==String(e))return!1;let g=I.data(\"id\");return m(g)?!0:m(I.attr(\"data-id\"))}).first();if(!b.length)return;let p=dt(t),f=ht(p.id,{shortLabel:!0});b.attr(\"data-status-id\",p.id);let v=b.find(\".rlh-item-title-row\").first();if(v.length){let T=v.find(\".rlh-status-badge\").first();T.length?T.replaceWith(f):v.append(f)}let w=b.find(\".rlh-collapsible-content\");if(w.length&&b.attr(\"data-entry-mode\")===\"view\"){let k=ne(e).find(I=>Number(I?.uid)===numericId);if(k){let I=pt(k,b.data(\"searchTerm\")??\"\");w.html(I)}}},Io=(e,r,t,a,l,n)=>{let i=\"\",h=\"\",m=\"\",b=p=>Object.entries(p).filter(([,f])=>f>0).map(([f,v])=>`<li>- ${O(f)}\\uFF1A<strong>${v}</strong> \\u4E2A</li>`).join(\"\");if(n?.type===\"lorebook\"){let p=n?.bookNames?.length===1?`\\u5F53\\u524D\\u4E16\\u754C\\u4E66\\u300C${O(n.bookNames[0])}\\u300D`:\"\\u5339\\u914D\\u5230\\u7684\\u4E16\\u754C\\u4E66\",f=new Set(e.map(T=>T.bookName)).size+(t?.length??0),v=e.length;i=`\n      <div class=\"rlh-replace-stats\">\n        <p>- \\u5171\\u5339\\u914D\\u5230 ${f} \\u672C\\u4E16\\u754C\\u4E66\\uFF0C\\u5176\\u4E2D ${v} \\u4E2A\\u6761\\u76EE\\u5C06\\u88AB\\u4FEE\\u6539\\u3002</p>\n        <p>- \\u66FF\\u6362\\u8303\\u56F4\\uFF1A${p}</p>\n        <p>- \\u547D\\u4E2D\\u8BE6\\u60C5\\uFF1A</p>\n        <ul>\n          <li>- \\u4E66\\u540D\\uFF1A<strong>${r.bookName}</strong> \\u4E2A</li>\n          <li>- \\u6761\\u76EE\\u540D\\uFF1A<strong>${r.entryName}</strong> \\u4E2A</li>\n          <li>- \\u5173\\u952E\\u8BCD\\uFF1A<strong>${r.keywords}</strong> \\u4E2A</li>\n          <li>- \\u5185\\u5BB9\\uFF1A<strong>${r.content}</strong> \\u4E2A</li>\n        </ul>\n      </div>\n    `,h=`<ul class=\"rlh-confirm-entry-list\">${e.map(({bookName:T,entry:k,matchedFields:I})=>{let s=[];I&&(I.entryName&&s.push(\"\\u6761\\u76EE\\u540D\"),I.keywords>0&&s.push(\"\\u5173\\u952E\\u8BCD\"),I.content&&s.push(\"\\u5185\\u5BB9\"));let g=s.join(\"\\u3001\"),x=O(k.name||\"\\u65E0\\u6807\\u9898\\u6761\\u76EE\"),C=g?`\\uFF08${g}\\uFF09`:\"\";return`<li class=\"rlh-confirm-entry-item\">${O(T)}: ${x}${C}</li>`}).join(\"\")}</ul>`,t&&t.length>0&&(m=`\n        <hr>\n        <h4>\\u4EC5\\u4E66\\u540D\\u5339\\u914D (\\u4E0D\\u4F1A\\u88AB\\u66FF\\u6362):</h4>\n        <div class=\"rlh-confirm-scroll-list rlh-confirm-scroll-list--secondary\">\n          <ul class=\"rlh-confirm-entry-list\">${t.map(k=>`<li class=\"rlh-confirm-entry-item\">${O(k)}</li>`).join(\"\")}</ul>\n        </div>\n      `)}else if(n===\"regex\"){let p={\\u540D\\u79F0\\u5339\\u914D:r.name,\\u5185\\u5BB9\\u5339\\u914D:r.content},f=b(p);f&&(i=`<div class=\"rlh-replace-stats\"><h4>\\u66FF\\u6362\\u7EDF\\u8BA1\\u6458\\u8981\\uFF1A</h4><ul>${f}</ul></div>`),h=`<ul class=\"rlh-confirm-entry-list\">${e.map(v=>`<li class=\"rlh-confirm-entry-item\">${O(v.script_name||\"\\u672A\\u547D\\u540D\\u6B63\\u5219\")}</li>`).join(\"\")}</ul>`}return`\n    <div class=\"rlh-replace-confirm-modal\">\n      <p>\\u786E\\u5B9A\\u8981\\u5C06 <strong>\"${O(a)}\"</strong> \\u66FF\\u6362\\u4E3A <strong>\"${O(l)}\"</strong> \\u5417\\uFF1F</p>\n      <p>\\u6B64\\u64CD\\u4F5C\\u4E0D\\u53EF\\u64A4\\u9500\\u3002</p>\n      <hr>\n      ${i}\n      <hr>\n      <h4>\\u5C06\\u8981\\u4FEE\\u6539\\u7684\\u6761\\u76EE\\u5217\\u8868\\uFF1A</h4>\n      <div class=\"rlh-confirm-scroll-list\">\n        ${h}\n      </div>\n      ${m}\n    </div>\n  `},mt=()=>{let e=xe(),r=we(),t=e(\"#regex-lore-hub-save-status\",r);if(!t.length)return;let a=o.saveStatus,l=\"\",n=\"\";switch(a){case\"saving\":l='<i class=\"fa-solid fa-spinner fa-spin\"></i> \\u6B63\\u5728\\u4FDD\\u5B58...',n=\"saving\";break;case\"retrying\":l=`<i class=\"fa-solid fa-triangle-exclamation fa-fade\"></i> \\u81EA\\u52A8\\u4FDD\\u5B58\\u5931\\u8D25\\uFF0C\\u6B63\\u5728\\u91CD\\u8BD5... (${o.saveRetryAttempt}/3)`,n=\"retrying\";break;case\"success\":l='<i class=\"fa-solid fa-check-circle\"></i> \\u6570\\u636E\\u5DF2\\u4FDD\\u5B58',n=\"success\";break;case\"failed\":l='<i class=\"fa-solid fa-circle-xmark\"></i> \\u81EA\\u52A8\\u4FDD\\u5B58\\u5931\\u8D25\\uFF0C\\u8BF7\\u68C0\\u67E5\\u8FDE\\u63A5\\u6216\\u624B\\u52A8\\u4FDD\\u5B58\\u3002',n=\"failed\";break;case\"idle\":default:l=\"\",n=\"idle\";break}t.html(l),t.attr(\"class\",`rlh-save-status ${n}`)},Xl=(e,r)=>{let t=ne(e);if(!Array.isArray(t)||!t.length||!Array.isArray(r)||r.length!==t.length)return null;let a=new Map(t.map(n=>[String(n.uid??\"\"),n])),l=[];return r.forEach(n=>{let i=String(n??\"\");a.has(i)&&(l.push(a.get(i)),a.delete(i))}),l.length?(a.forEach(n=>l.push(n)),l.forEach((n,i)=>{n.display_index=i,(n.order===void 0||n.order===null||Number.isNaN(Number(n.order)))&&(n.order=i)}),Oe(e,l),l):null},Ut=(e,r,t={})=>{let a=$e(),l=t.enabled??!1,n=!!e?.length,i=()=>{n&&(e.attr(\"data-drag-disabled\",\"true\"),e.find(\".rlh-drag-disabled-tip\").length||e.prepend('<p class=\"rlh-info-text-small rlh-drag-disabled-tip\">\\u62D6\\u62FD\\u6392\\u5E8F\\u529F\\u80FD\\u6682\\u65F6\\u4E0D\\u53EF\\u7528\\u3002</p>'))};if(!l||!n){n&&(e.removeAttr(\"data-drag-disabled\"),e.find(\".rlh-drag-disabled-tip\").remove());return}if(o.isDragSortDisabled){i();return}if(!a?.Sortable)return;let h=e[0];!h||e.find(\".rlh-item-container\").length<2||(e.removeAttr(\"data-drag-disabled\"),e.find(\".rlh-drag-disabled-tip\").remove(),a.Sortable.create(h,{animation:150,handle:\".rlh-drag-handle\",ghostClass:\"sortable-ghost\",chosenClass:\"sortable-chosen\",onEnd:A(async b=>{let{oldIndex:p,newIndex:f}=b;if(p===f)return;let v=Array.from(h.querySelectorAll(\".rlh-item-container\")).map(w=>w.getAttribute(\"data-id\")).filter(Boolean);Xl(r,v)&&await pr()},\"RegexLoreHub.Sortable\")}))};var Ro=6,ur=null,De=null,Pt=()=>{if(!ur&&!De)return;let e=$e();if(ur){let{type:r,id:t}=ur;if(r===\"idle\"&&e?.cancelIdleCallback)e.cancelIdleCallback(t);else if(r===\"raf\"&&e?.cancelAnimationFrame)e.cancelAnimationFrame(t);else if(r===\"timeout\"){let a=e?.clearTimeout??(typeof clearTimeout==\"function\"?clearTimeout:null);a&&a(t)}ur=null}De&&(De.remove(),De=null)},zt=(e,r)=>{let t=Array.isArray(e)?[...e]:[];return r===\"status\"?t.sort((a,l)=>{let n=Number(l.enabled)-Number(a.enabled);return n!==0?n:(a.name||\"\").localeCompare(l.name||\"\",\"zh\")}):t.sort((a,l)=>(a.name||\"\\u65E0\\u6807\\u9898\\u6761\\u76EE\").localeCompare(l.name||\"\\u65E0\\u6807\\u9898\\u6761\\u76EE\",\"zh\"))},Xr=(e,r=!1,t={})=>{let a=[],l=[],n={bookName:0,entryName:0,keywords:0,content:0},i=typeof e==\"string\"?e:\"\";if(!i)return{matches:a,stats:n,booksMatchedByNameOnly:l};let{bookNames:h}=t,m=Array.isArray(h)?[...new Set(h.map(g=>typeof g==\"string\"?g.trim():\"\").filter(g=>!!g))]:[],b=Array.isArray(o.allLorebooks)?o.allLorebooks:[],p=m.length?b.filter(g=>m.includes(g.name)):b.slice();if(m.length){let g=new Set(p.map(x=>x.name));m.forEach(x=>{g.has(x)||p.push({name:x})})}let f=r?\"\":\"i\",v=new RegExp(i.replace(/[.*+?^${}()|[\\/\\\\]/g,\"\\\\$&\"),f),w=new Set,T=new Set,k=new Set,I=new Set,s=new Set;for(let g of p){let x=g?.name??\"\";if(!x)continue;let C=ne(x),D=v.test(x),S=!1;D&&w.add(x);for(let K of C){let ce={bookName:!1,entryName:!1,keywords:0,content:!1},q=!1;if(v.test(K.name||\"\")&&(T.add(K.uid),ce.entryName=!0,q=!0),Array.isArray(K.keys)){let Z=K.keys.filter(W=>v.test(W)).length;Z>0&&(ce.keywords=Z,k.add(K.uid),q=!0)}v.test(K.content||\"\")&&(I.add(K.uid),ce.content=!0,q=!0),q&&(S=!0,s.has(K.uid)||(a.push({bookName:x,entry:K,matchedFields:ce}),s.add(K.uid)))}D&&!S&&l.push(x)}return n.bookName=w.size,n.entryName=T.size,n.keywords=k.size,n.content=I.size,{matches:a,stats:n,booksMatchedByNameOnly:l}},Ao=(e,r,t)=>{e.view===\"global-lore-detail\"?Ql(e,r,t):Jl(e,r,t)},Jl=(e,r,t)=>{Pt();let a=xe(),l=we(),n=$e(),i=typeof r==\"string\"?r:\"\",h=dr(e),m=[...o.allLorebooks];if(h===\"status\"?m.sort((s,g)=>{let x=Number(g.enabled)-Number(s.enabled);return x!==0?x:s.name.localeCompare(g.name,\"zh\")}):m.sort((s,g)=>s.name.localeCompare(g.name,\"zh\")),!m.length){t.html(`\n      <div class=\"rlh-empty-state\">\n        <div class=\"rlh-empty-icon\"><i class=\"fa-solid fa-book-bookmark\"></i></div>\n        <h4>\\u6CA1\\u6709\\u4E16\\u754C\\u4E66</h4>\n        <p>\\u70B9\\u51FB\\u53F3\\u4E0A\\u89D2\\u7684\\u201C<i class=\"fa-solid fa-plus\"></i>\\u201D\\u6309\\u94AE\\u6765\\u521B\\u5EFA\\u4F60\\u7684\\u7B2C\\u4E00\\u4E2A\\u4E16\\u754C\\u4E66\\u5427\\uFF01</p>\n      </div>\n    `);return}let b=i?m.filter(s=>o.searchFilters.bookName&&s.name.toLowerCase().includes(i)?!0:ne(s.name).some(C=>yr(C,i))):m;if(!b.length){t.html('<p class=\"rlh-info-text\">\\u672A\\u627E\\u5230\\u5339\\u914D\\u7684\\u4E16\\u754C\\u4E66\\u3002</p>');return}t.empty();let p=b.length,f=p<=Ro?p:Math.min(Ro,Math.max(3,Math.ceil(p/5))),v=0;De=p>f?a('<p class=\"rlh-info-text-small\" aria-live=\"polite\"></p>'):null;let w=()=>{if(!De)return;let s=Math.min(v,p);De.text(`\\u6B63\\u5728\\u52A0\\u8F7D\\u4E16\\u754C\\u4E66\\u5217\\u8868 (${s}/${p})\\uFF0C\\u8BF7\\u7A0D\\u5019...`).appendTo(t)},T=s=>{if(!s.length)return;let g=l&&typeof l.createDocumentFragment==\"function\"?l.createDocumentFragment():null;g?(s.forEach(x=>g.appendChild(x)),t.append(g)):s.forEach(x=>t.append(x))},k=()=>{let s=Math.min(v+f,p),g=[];for(let x=v;x<s;x++){let D=Co(b[x],r,!0,null).get(0);D&&g.push(D)}if(T(g),v=s,w(),v>=p&&De){let x=De;(n?.setTimeout??setTimeout)(()=>{De===x&&(x.remove(),De=null)},320)}},I=()=>{let s=()=>{ur=null,k(),v<p&&I()};n?.requestIdleCallback?ur={type:\"idle\",id:n.requestIdleCallback(s,{timeout:120})}:n?.requestAnimationFrame?ur={type:\"raf\",id:n.requestAnimationFrame(s)}:ur={type:\"timeout\",id:(n?.setTimeout??setTimeout)(s,16)}};k(),v<p?I():De&&(De.remove(),De=null)},Ql=(e,r,t)=>{Pt();let a=xe(),l=e?.activeBookName??o.activeBookName;if(!o.allLorebooks.find(w=>w.name===l)){t.html(`<p class=\"rlh-info-text\">\\u9519\\u8BEF\\uFF1A\\u672A\\u627E\\u5230\\u540D\\u4E3A \"${O(l)}\" \\u7684\\u4E16\\u754C\\u4E66\\u3002</p>`);return}if(o.loadingBookName===l){let w=`\n        <div class=\"rlh-detail-view\" data-book-name=\"${O(l)}\">\n          <header class=\"rlh-detail-header\">\n            <button class=\"rlh-action-btn-icon rlh-back-to-list-btn\" title=\"\\u8FD4\\u56DE\\u4E16\\u754C\\u4E66\\u5217\\u8868\"><i class=\"fa-solid fa-arrow-left\"></i></button>\n            <h2>${O(l)}</h2>\n            <div class=\"rlh-item-controls\">\n              <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\\u91CD\\u547D\\u540D\\u4E16\\u754C\\u4E66\">\\u91CD\\u547D\\u540D</button>\n              <button class=\"rlh-toolbar-btn rlh-delete-book-btn\" title=\"\\u5220\\u9664\\u4E16\\u754C\\u4E66\">\\u5220\\u9664</button>\n            </div>\n          </header>\n          <div class=\"rlh-detail-content\">\n            <p class=\"rlh-info-text\">\\u52A0\\u8F7D\\u4E2D...</p>\n          </div>\n        </div>\n      `;t.html(w);return}t.append(`<div class=\"rlh-info-text-small\">\\u5F53\\u524D\\u4E16\\u754C\\u4E66\\uFF1A${O(l)}</div>`);let i=dr(e),h=vr(e),m=zt(ne(l),i),b=`\n        <div class=\"rlh-detail-view\" data-book-name=\"${O(l)}\">\n          <header class=\"rlh-detail-header\">\n            <button class=\"rlh-action-btn-icon rlh-back-to-list-btn\" title=\"\\u8FD4\\u56DE\\u4E16\\u754C\\u4E66\\u5217\\u8868\"><i class=\"fa-solid fa-arrow-left\"></i></button>\n            <h2>${O(l)}</h2>\n            <div class=\"rlh-item-controls\">\n              <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\\u91CD\\u547D\\u540D\\u4E16\\u754C\\u4E66\">\\u91CD\\u547D\\u540D</button>\n              <button class=\"rlh-toolbar-btn rlh-delete-book-btn\" title=\"\\u5220\\u9664\\u4E16\\u754C\\u4E66\">\\u5220\\u9664</button>\n            </div>\n          </header>\n          <div class=\"rlh-detail-content\">\n          </div>\n        </div>\n      `;t.html(b);let p=r?m.filter(w=>yr(w,r)):m,f=t.find(\".rlh-detail-content\");if(!p.length){let w=m.length?\"\\u65E0\\u5339\\u914D\\u6761\\u76EE\":\"\\u8FD9\\u672C\\u4E66\\u8FD8\\u6CA1\\u6709\\u6761\\u76EE\\uFF0C\\u70B9\\u51FB\\u5DE5\\u5177\\u680F\\u7684\\u201C\\u65B0\\u5EFA\\u6761\\u76EE\\u201D\\u6309\\u94AE\\uFF0C\\u4E3A\\u5B83\\u6DFB\\u52A0\\u5185\\u5BB9\\u3002\";f.html(`<p class=\"rlh-info-text\">${w}</p>`);return}let v=`\n    <p class=\"rlh-info-text-small\">\\u5171 ${m.length} \\u4E2A\\u6761\\u76EE</p>\n    <div class=\"rlh-entry-list-wrapper\">\n      ${p.map(w=>hr(w,\"lore\",l,r,{collapseState:h,enableDrag:!1}).prop(\"outerHTML\")).join(\"\")}\n    </div>\n  `;f.html(v)},Mo=(e,r,t)=>{let a=xe(),l=o.lorebooks.character,n=o.characterContext.name??\"\";if(!(o.characterContext.id!==null)){t.html('<p class=\"rlh-info-text\">\\u8BF7\\u5148\\u52A0\\u8F7D\\u4E00\\u4E2A\\u89D2\\u8272\\u4EE5\\u7BA1\\u7406\\u89D2\\u8272\\u4E16\\u754C\\u4E66\\u3002</p>');return}if(l.length===0){t.html('<p class=\"rlh-info-text\">\\u5F53\\u524D\\u89D2\\u8272\\u6CA1\\u6709\\u7ED1\\u5B9A\\u7684\\u4E16\\u754C\\u4E66\\u3002\\u70B9\\u51FB\\u540C\\u6B65\\u6309\\u94AE\\u5237\\u65B0\\u3002</p>');return}let h=o.activeCharacterBook;(!h||!l.includes(h))&&(h=l[0],o.activeCharacterBook=h);let m=dr(e),b=vr(e);if(l.length>1){let v=l.map(w=>`<option value=\"${O(w)}\"${w===h?\" selected\":\"\"}>${O(w)}</option>`).join(\"\");t.append(`<div class=\"rlh-book-switcher\"><label>\\u5F53\\u524D\\u89D2\\u8272\\u540D\\uFF1A${O(n)}<select id=\"${tt}\" class=\"rlh-input\">${v}</select></label></div>`)}else t.append(`<div class=\"rlh-info-text-small\">\\u5F53\\u524D\\u89D2\\u8272\\u540D\\uFF1A${O(n)}</div>`);let f=(v=>{let w=a(`<div class=\"rlh-book-group\" data-book-name=\"${O(v)}\">\n        <div class=\"rlh-book-group-header\">\n          <h2 class=\"rlh-book-group-title\">${O(v)}</h2>\n          <div class=\"rlh-item-controls\">\n            <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\\u91CD\\u547D\\u540D\\u4E16\\u754C\\u4E66\">\\u91CD\\u547D\\u540D</button>\n            <button class=\"rlh-toolbar-btn rlh-delete-book-btn\" title=\"\\u5220\\u9664\\u4E16\\u754C\\u4E66\">\\u5220\\u9664</button>\n          </div>\n        </div>\n        <div class=\"rlh-entry-list-wrapper\"></div>\n      </div>`),T=w.find(\".rlh-entry-list-wrapper\"),k=o.allLorebooks.find(S=>S.name===v);if(k&&!k.entriesLoaded)return k.loadingEntries||(k.loadingEntries=!0,Ie(v).finally(()=>{k.loadingEntries=!1,se()})),T.append('<p class=\"rlh-info-text\">\\u52A0\\u8F7D\\u4E2D...</p>'),w;let I=[...ne(v)].sort((S,K)=>(S.display_index??Number.MAX_SAFE_INTEGER)-(K.display_index??Number.MAX_SAFE_INTEGER)),s=zt(I,m),g=!r||o.searchFilters.bookName&&v.toLowerCase().includes(r),x=r?s.filter(S=>yr(S,r)):s,C=g&&!r?s:x,D=!1;return C.length?C.forEach(S=>{T.append(hr(S,\"lore\",v,r,{collapseState:b,enableDrag:D}))}):r?T.append('<p class=\"rlh-info-text-small\">\\u65E0\\u5339\\u914D\\u6761\\u76EE</p>'):T.append('<p class=\"rlh-info-text-small\">\\u8FD9\\u672C\\u4E16\\u754C\\u4E66\\u6682\\u65F6\\u6CA1\\u6709\\u6761\\u76EE\\u3002</p>'),Ut(T,v,{enabled:D}),w})(h);f?(f.attr(\"data-active\",\"true\"),t.append(f)):r?t.append('<p class=\"rlh-info-text\">\\u672A\\u627E\\u5230\\u5339\\u914D\\u7684\\u6761\\u76EE\\u3002</p>'):t.append('<p class=\"rlh-info-text\">\\u672A\\u80FD\\u52A0\\u8F7D\\u5F53\\u524D\\u4E16\\u754C\\u4E66\\uFF0C\\u8BF7\\u5C1D\\u8BD5\\u5237\\u65B0\\u6570\\u636E\\u3002</p>')};var Bo=(e,r,t)=>{let a=xe(),l=o.chatLorebook,n=$e(),i=o.characterContext.name??\"\";if(!(n.SillyTavern?.getContext?.()?.chatId!==null)){t.html('<p class=\"rlh-info-text\">\\u8BF7\\u5148\\u6253\\u5F00\\u4E00\\u4E2A\\u804A\\u5929\\u4EE5\\u7BA1\\u7406\\u804A\\u5929\\u4E16\\u754C\\u4E66\\u3002</p>');return}if(!l){t.html(`\n      <div class=\"rlh-chat-lore-empty\">\n        <p class=\"rlh-info-text\">\\u5F53\\u524D\\u804A\\u5929\\u6CA1\\u6709\\u7ED1\\u5B9A\\u7684\\u4E16\\u754C\\u4E66\\u3002</p>\n        <button class=\"rlh-action-btn\" id=\"rlh-create-chat-lore-btn\"><i class=\"fa-solid fa-plus\"></i> \\u521B\\u5EFA\\u5E76\\u7ED1\\u5B9A\\u804A\\u5929\\u4E16\\u754C\\u4E66</button>\n      </div>\n    `);return}t.append(`<div class=\"rlh-info-text-small\">\\u5F53\\u524D\\u804A\\u5929\\u89D2\\u8272\\u540D\\uFF1A${O(i)}</div>`);let m=dr(e),b=vr(e),p=a(`<div class=\"rlh-book-group\" data-book-name=\"${O(l)}\">\n      <div class=\"rlh-book-group-header\">\n        <h2 class=\"rlh-book-group-title\">${O(l)} (\\u804A\\u5929\\u4E13\\u7528)</h2>\n        <div class=\"rlh-item-controls\">\n          <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\\u91CD\\u547D\\u540D\\u4E16\\u754C\\u4E66\">\\u91CD\\u547D\\u540D</button>\n          <button class=\"rlh-toolbar-btn rlh-unlink-chat-lore-btn\" title=\"\\u89E3\\u9664\\u7ED1\\u5B9A\">\\u89E3\\u9664\\u7ED1\\u5B9A</button>\n        </div>\n      </div>\n      <div class=\"rlh-entry-list-wrapper\"></div>\n    </div>`),f=p.find(\".rlh-entry-list-wrapper\"),v=o.allLorebooks.find(s=>s.name===l);if(v&&!v.entriesLoaded){v.loadingEntries||(v.loadingEntries=!0,Ie(l).finally(()=>{v.loadingEntries=!1,se()})),f.append('<p class=\"rlh-info-text\">\\u52A0\\u8F7D\\u4E2D...</p>'),t.append(p);return}let w=[...ne(l)].sort((s,g)=>(s.display_index??Number.MAX_SAFE_INTEGER)-(g.display_index??Number.MAX_SAFE_INTEGER)),T=zt(w,m),k=r?T.filter(s=>yr(s,r)):T,I=!1;if(k.length)k.forEach(s=>{f.append(hr(s,\"lore\",l,r,{collapseState:b,enableDrag:I}))});else{let s=T.length?\"\\u65E0\\u5339\\u914D\\u6761\\u76EE\":\"\\u8FD9\\u672C\\u4E66\\u8FD8\\u6CA1\\u6709\\u6761\\u76EE\\u3002\";f.append(`<p class=\"rlh-info-text-small\">${s}</p>`)}Ut(f,l,{enabled:I}),t.append(p)},Oo=()=>Pt();var Zl=(e,r)=>{let t=Array.isArray(e)?[...e]:[];return r===\"status\"?t.sort((a,l)=>{let n=Number(l.enabled)-Number(a.enabled);return n!==0?n:(a.script_name||\"\").localeCompare(l.script_name||\"\",\"zh\")}):r===\"name\"?t.sort((a,l)=>(a.script_name||\"\").localeCompare(l.script_name||\"\",\"zh\")):t},Do=(e,r=!1)=>{let t=[],a={name:0,content:0};if(!e)return{matches:t,stats:a};let l=[...o.regexes.global,...o.regexes.character],n=r?\"\":\"i\",i=new RegExp(e.replace(/[.*+?^${}()|[\\/\\\\]/g,\"\\\\$&\"),n),h=new Set,m=new Set,b=new Set;for(let p of l){let f=!1;i.test(p.script_name||\"\")&&(h.add(p.script_name),f=!0);let v=`${p.find_regex||\"\"} ${p.replace_string||\"\"}`;i.test(v)&&(m.add(p.script_name),f=!0),f&&!b.has(p.id)&&(t.push(p),b.add(p.id))}return a.name=h.size,a.content=m.size,{matches:t,stats:a}},ft=(e,r,t,a,l)=>{let n=xe(),i=$e(),h=dr(e),m=vr(e),b=Zl(r??[],h),p=l??(e.id===\"char-regex\"?\"\\u89D2\\u8272\\u6B63\\u5219\":\"\\u5168\\u5C40\\u6B63\\u5219\");if(e.id===\"char-regex\"){let s=i.SillyTavern?.getContext?.()||{};if(!(s.characterId!==void 0&&s.characterId!==null)){a.html('<p class=\"rlh-info-text\">\\u8BF7\\u5148\\u52A0\\u8F7D\\u4E00\\u4E2A\\u89D2\\u8272\\u4EE5\\u7BA1\\u7406\\u89D2\\u8272\\u6B63\\u5219\\u3002</p>');return}}if(!b.length){a.html(`<p class=\"rlh-info-text\">\\u6CA1\\u6709${p}\\u3002\\u70B9\\u51FB\\u540C\\u6B65\\u6309\\u94AE\\u5237\\u65B0\\u3002</p>`);return}let f=t?b.filter(s=>Lo(s,t)):b;if(!f.length){a.html(`<p class=\"rlh-info-text\">\\u6CA1\\u6709\\u5339\\u914D\\u7684${p}\\u3002</p>`);return}let v=`rlh-regex-list-${e.id}`,w=n(`<div id=\"${v}\" class=\"rlh-regex-list\"></div>`);a.append(w);let T=!t;f.forEach((s,g)=>{let x=hr(s,\"regex\",\"\",t,{collapseState:m,enableDrag:T});x.find(\".rlh-item-name\").prepend(`<span class=\"rlh-order-indicator\">#${g+1}</span> `),w.append(x)});let k=w[0],I=\"rlh-drag-disabled-banner\";if(a.find(`.${I}`).remove(),T&&o.isDragSortDisabled?(w.attr(\"data-drag-disabled\",\"true\"),a.prepend(`<p class=\"rlh-info-text-small ${I}\">\\u63D0\\u793A\\uFF1A\\u62D6\\u62FD\\u6392\\u5E8F\\u529F\\u80FD\\u6682\\u65F6\\u4E0D\\u53EF\\u7528\\uFF0C\\u8BF7\\u4F7F\\u7528\\u6309\\u94AE\\u8C03\\u6574\\u987A\\u5E8F\\u3002</p>`)):w.removeAttr(\"data-drag-disabled\"),T&&!o.isDragSortDisabled&&k&&i.Sortable){let s=i.Sortable.create(k,{animation:150,handle:\".rlh-drag-handle\",forceFallback:!0,fallbackOnBody:!0,fallbackTolerance:6,delayOnTouchOnly:!0,touchStartThreshold:8,fallbackClass:\"rlh-sorting-fallback\",onStart:()=>{w.addClass(\"sorting-active\")},onEnd:A(async g=>{w.removeClass(\"sorting-active\");let{oldIndex:x,newIndex:C}=g;if(x===C)return;let D=e.id===\"global-regex\"?\"global\":\"character\",S=o.regexes[D];if(!Array.isArray(S))return;let[K]=S.splice(x,1);K&&(S.splice(C,0,K),er(S),o.pendingRegexUpdates instanceof Set||(o.pendingRegexUpdates=new Set),o.pendingRegexUpdates.add(D),await pr({silent:!0}),a.empty(),ft(e,S,t,a,l))},\"RegexLoreHub.RegexSortable\")})}};var ea=e=>e?.toString().trim().toLowerCase()??\"\",Ae=()=>{let e=o.activeTab,r=o.activeView,t={tab:e,view:r,id:`${e}`,instanceKey:`${e}`,activeBookName:o.activeBookName,type:\"lore\",scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u5F53\\u524D\\u89C6\\u56FE\",replaceScopeLabel:\"\\u5728\\u5F53\\u524D\\u89C6\\u56FE\\u4E2D\\u66FF\\u6362\",searchPlaceholder:\"\\u641C\\u7D22...\",visibleFilters:[\"entryName\",\"keywords\",\"content\"],filterLabels:Lr,defaultFilters:{entryName:!0,keywords:!0,content:!0},showReplace:!0,showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!1,showPositionMenu:!1,sortOptions:[],multiSelectTarget:\"entry\",supportsMultiSelect:!0,primaryAction:{visible:!1}};if(e===\"global-lore\"){if(r===\"global-lore-detail\"){let a=o.activeBookName??\"\";return{...t,id:\"global-lore-detail\",instanceKey:a?`global-lore-detail:${a}`:\"global-lore-detail\",activeBookName:a,scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u5F53\\u524D\\u4E16\\u754C\\u4E66\",replaceScopeLabel:\"\\u5728\\u5F53\\u524D\\u4E16\\u754C\\u4E66\\u4E2D\\u66FF\\u6362\",searchPlaceholder:\"\\u641C\\u7D22...\",visibleFilters:[\"bookName\",\"entryName\",\"keywords\",\"content\"],defaultFilters:{bookName:!1,entryName:!0,keywords:!0,content:!0},showRecursion:!0,showFixKeywords:!0,showCollapseToggle:!0,showPositionMenu:!0,sortOptions:[\"status\",\"name\"],multiSelectTarget:\"entry\",primaryAction:{visible:!0,icon:\"fa-file-circle-plus\",label:\"\\u65B0\\u5EFA\\u6761\\u76EE\",title:\"\\u65B0\\u5EFA\\u6761\\u76EE\",scope:\"entry\"}}}return{...t,id:\"global-lore-list\",instanceKey:\"global-lore-list\",activeBookName:null,scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u5168\\u90E8\\u4E16\\u754C\\u4E66\",replaceScopeLabel:\"\\u5728\\u5339\\u914D\\u5230\\u7684\\u4E16\\u754C\\u4E66\\u6216\\u6761\\u76EE\\u4E2D\\u66FF\\u6362\",visibleFilters:[\"bookName\",\"entryName\",\"keywords\",\"content\"],defaultFilters:{bookName:!0,entryName:!0,keywords:!0,content:!0},showReplace:!0,showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!1,showPositionMenu:!1,showCleanOrphanBooks:!0,sortOptions:[\"status\",\"name\"],multiSelectTarget:\"book\",primaryAction:{visible:!0,icon:\"fa-plus\",label:\"\\u65B0\\u5EFA\\u4E16\\u754C\\u4E66\",title:\"\\u65B0\\u5EFA\\u4E16\\u754C\\u4E66\",scope:\"book\"}}}if(e===\"char-lore\"){let a=o.activeCharacterBook;if(!a){let n=(Array.isArray(o.lorebooks?.character)?o.lorebooks.character:[]).find(i=>typeof i==\"string\"&&i.trim().length);n&&(a=n,o.activeCharacterBook=n)}return{...t,id:\"char-lore\",instanceKey:\"char-lore\",activeBookName:a,scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u5F53\\u524D\\u4E16\\u754C\\u4E66\",replaceScopeLabel:\"\\u5728\\u5F53\\u524D\\u4E16\\u754C\\u4E66\\u4E2D\\u66FF\\u6362\",visibleFilters:[\"entryName\",\"keywords\",\"content\"],defaultFilters:{bookName:!1,entryName:!0,keywords:!0,content:!0},showRecursion:!0,showFixKeywords:!0,showCollapseToggle:!0,showPositionMenu:!0,sortOptions:[\"status\",\"name\"],multiSelectTarget:\"entry\",primaryAction:{visible:!0,icon:\"fa-file-circle-plus\",label:\"\\u65B0\\u5EFA\\u6761\\u76EE\",title:\"\\u65B0\\u5EFA\\u6761\\u76EE\",scope:\"entry\"}}}return e===\"chat-lore\"?{...t,id:\"chat-lore\",instanceKey:\"chat-lore\",activeBookName:o.chatLorebook,scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u5F53\\u524D\\u4E16\\u754C\\u4E66\",replaceScopeLabel:\"\\u5728\\u5F53\\u524D\\u4E16\\u754C\\u4E66\\u4E2D\\u66FF\\u6362\",visibleFilters:[\"entryName\",\"keywords\",\"content\"],defaultFilters:{bookName:!1,entryName:!0,keywords:!0,content:!0},showRecursion:!0,showFixKeywords:!0,showCollapseToggle:!0,showPositionMenu:!0,sortOptions:[\"status\",\"name\"],multiSelectTarget:\"entry\",primaryAction:{visible:!0,icon:\"fa-file-circle-plus\",label:\"\\u65B0\\u5EFA\\u6761\\u76EE\",title:\"\\u65B0\\u5EFA\\u6761\\u76EE\",scope:\"entry\"}}:e===\"global-regex\"?{...t,id:\"global-regex\",instanceKey:\"global-regex\",type:\"regex\",scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u5168\\u5C40\\u6B63\\u5219\\u8868\\u8FBE\\u5F0F\",replaceScopeLabel:\"\\u5728\\u5168\\u5C40\\u6B63\\u5219\\u4E2D\\u66FF\\u6362\",visibleFilters:[\"entryName\",\"content\"],filterLabels:{...Lr,...At},defaultFilters:{bookName:!1,entryName:!0,keywords:!1,content:!0},showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!0,showPositionMenu:!1,sortOptions:[],multiSelectTarget:\"regex\",supportsMultiSelect:!0,primaryAction:{visible:!1}}:e===\"char-regex\"?{...t,id:\"char-regex\",instanceKey:\"char-regex\",type:\"regex\",scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u89D2\\u8272\\u6B63\\u5219\\u8868\\u8FBE\\u5F0F\",replaceScopeLabel:\"\\u5728\\u89D2\\u8272\\u6B63\\u5219\\u4E2D\\u66FF\\u6362\",visibleFilters:[\"entryName\",\"content\"],filterLabels:{...Lr,...At},defaultFilters:{bookName:!1,entryName:!0,keywords:!1,content:!0},showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!0,showPositionMenu:!1,sortOptions:[],multiSelectTarget:\"regex\",supportsMultiSelect:!1,primaryAction:{visible:!1}}:{...t,id:\"unknown\",instanceKey:\"unknown\",supportsMultiSelect:!1}},ra=e=>{let r=e.id;r&&(o.searchFilterContextsInitialized.has(r)||((e.visibleFilters??[]).forEach(t=>{o.searchFilters[t]=!0}),o.searchFilterContextsInitialized.add(r)),(e.id===\"char-lore\"||e.id===\"chat-lore\")&&o.searchFilters.keywords===void 0&&(o.searchFilters.keywords=!0))},se=()=>{let e=xe(),r=we(),t=e(`#${ke}`,r),a=()=>{if(!t.length){let k=e([]);return{$toolbarRow:k,$toolbar:k,$replaceContainer:k,$content:k}}let p=t.find(\".rlh-toolbar-shell\").first();if(!p.length){let k=t.find(\".rlh-tab-nav\").first();p=e('<div class=\"rlh-toolbar-shell\"></div>'),k.length?p.insertAfter(k):t.prepend(p)}let f=p.find(`#${Hr}`);f.length||(f=e(`<div id=\"${Hr}\" class=\"rlh-toolbar-container\"></div>`),p.append(f));let v=p.find(`#${Ur}`);v.length||(v=e(`<div id=\"${Ur}\" class=\"rlh-replace-container\"></div>`),p.append(v));let w=t.find(\".rlh-content-pane\").first();w.length||(w=e('<div class=\"rlh-content-pane\"></div>'),w.insertAfter(p));let T=w.find(`#${ke}-content`);return T.length||(T=e(`<div id=\"${ke}-content\"></div>`),w.append(T)),{$toolbarRow:p,$toolbar:f,$replaceContainer:v,$content:T}},l=ea(o.globalSearch.term??\"\");[[\"bookName\",\"#rlh-filter-book-name\"],[\"entryName\",\"#rlh-filter-entry-name\"],[\"keywords\",\"#rlh-filter-keywords\"],[\"content\",\"#rlh-filter-content\"]].forEach(([p,f])=>{let v=t.find(f);v.length&&(o.searchFilters[p]=v.is(\":checked\"))});let{$toolbar:i,$replaceContainer:h,$content:m}=a();i.empty(),h.empty(),m.empty();let b=Ae();if(ra(b),b.tab!==\"global-lore\"&&Oo(),!b.supportsMultiSelect&&o.multiSelectMode&&(o.multiSelectMode=!1,o.selectedItems.clear()),o.multiSelectMode?o.multiSelectTarget!==b.multiSelectTarget&&(o.multiSelectTarget=b.multiSelectTarget,o.selectedItems.clear()):o.multiSelectTarget=b.multiSelectTarget,t.toggleClass(\"rlh-multi-select-mode\",o.multiSelectMode),To(b,{$toolbar:i,$replaceContainer:h}),mt(),ut(),o.isLoadingTabData){m.html('<p class=\"rlh-info-text\">\\u52A0\\u8F7D\\u4E2D...</p>');return}switch(b.tab){case\"global-lore\":Ao(b,l,m);break;case\"char-lore\":Mo(b,l,m);break;case\"chat-lore\":Bo(b,l,m);break;case\"global-regex\":ft(b,o.regexes.global,l,m,\"\\u5168\\u5C40\\u6B63\\u5219\");break;case\"char-regex\":ft(b,o.regexes.character,l,m,\"\\u89D2\\u8272\\u6B63\\u5219\");break;default:m.html('<p class=\"rlh-info-text\">\\u5F53\\u524D\\u89C6\\u56FE\\u672A\\u5B9E\\u73B0\\u3002</p>');break}};var vt=Object.freeze({and_any:0,not_all:1,not_any:2,and_all:3}),gt=Object.freeze({0:\"and_any\",1:\"not_all\",2:\"not_any\",3:\"and_all\"}),ta=Object.freeze({system:0,user:1,assistant:2}),Ho=Object.freeze({0:\"system\",1:\"user\",2:\"assistant\"}),Ft=Object.freeze({before_character_definition:{type:\"before_character_definition\"},after_character_definition:{type:\"after_character_definition\"},before_example_messages:{type:\"before_example_messages\"},after_example_messages:{type:\"after_example_messages\"},before_author_note:{type:\"before_author_note\"},after_author_note:{type:\"after_author_note\"},at_depth_as_system:{type:\"at_depth\",role:\"system\"},at_depth_as_assistant:{type:\"at_depth\",role:\"assistant\"},at_depth_as_user:{type:\"at_depth\",role:\"user\"}}),oa=Object.freeze({0:\"before_character_definition\",1:\"after_character_definition\",2:\"before_author_note\",3:\"after_author_note\",4:\"at_depth_as_system\",5:\"before_example_messages\",6:\"after_example_messages\"}),xt=Object.freeze({before_char:\"before_character_definition\",after_char:\"after_character_definition\",before_an:\"before_author_note\",after_an:\"after_author_note\",before_em:\"before_example_messages\",after_em:\"after_example_messages\",at_depth:\"at_depth_as_system\",depth_system:\"at_depth_as_system\",depth_character:\"at_depth_as_assistant\",depth_user:\"at_depth_as_user\"}),jo=\"regexLoreHub\",Wo=\"regexLoreHub.themeId\",Go=A(async()=>{let e=null;try{let t=Se()?.extensionSettings;if(t&&typeof t==\"object\"){let a=t[jo]??t.regexLoreHub??t.RegexLoreHub??null;if(a&&typeof a==\"object\"){let l=a.themeId??a.theme??a.theme_id??a.themeName;typeof l==\"string\"&&l.trim()&&(e=l.trim())}}}catch(r){console.warn(\"[RegexLoreHub] \\u8BFB\\u53D6 extensionSettings \\u4E3B\\u9898\\u504F\\u597D\\u5931\\u8D25\\uFF1A\",r)}if(!e)try{let t=$e()?.localStorage?.getItem(Wo);typeof t==\"string\"&&t.trim()&&(e=t.trim())}catch(r){console.warn(\"[RegexLoreHub] \\u8BFB\\u53D6 localStorage \\u4E3B\\u9898\\u504F\\u597D\\u5931\\u8D25\\uFF1A\",r)}return e??null},\"RegexLoreHubThemeStorage\"),Ko=A(async e=>{let r=typeof e==\"string\"?e.trim():\"\";if(!r)return!1;let t=!1;try{let a=Se(),l=a?.extensionSettings;if(l&&typeof l==\"object\"){let n=jo,i=l[n]&&typeof l[n]==\"object\"?l[n]:l[n]={};i.themeId=r,t=!0,a?.builtin?.saveSettings&&await a.builtin.saveSettings()}}catch(a){console.warn(\"[RegexLoreHub] \\u5199\\u5165 extensionSettings \\u4E3B\\u9898\\u504F\\u597D\\u5931\\u8D25\\uFF1A\",a)}try{$e()?.localStorage?.setItem(Wo,r),t=!0}catch(a){console.warn(\"[RegexLoreHub] \\u5199\\u5165 localStorage \\u4E3B\\u9898\\u504F\\u597D\\u5931\\u8D25\\uFF1A\",a)}return t},\"RegexLoreHubThemeStorage\"),kr=e=>e?JSON.parse(JSON.stringify(e)):{},Zr=e=>Array.isArray(e)?e.map(r=>{if(typeof r==\"string\")return r.trim();if(r instanceof RegExp)return r.source;if(r&&typeof r==\"object\"){if(typeof r.pattern==\"string\")return r.pattern.trim();if(typeof r.source==\"string\")return r.source.trim()}if(r!=null&&typeof r.toString==\"function\"){let t=r.toString();return typeof t==\"string\"?t.trim():\"\"}return\"\"}).filter(Boolean):[],la=[\"order\",\"displayIndex\",\"display_index\",\"sort_order\",\"script_order\"],er=(e=[])=>{!Array.isArray(e)||e.length===0||e.forEach((r,t)=>{!r||typeof r!=\"object\"||r.source===\"card\"||(la.forEach(a=>{r[a]=t}),r?.position&&typeof r.position==\"object\"&&\"order\"in r.position&&(r.position.order=t))})},aa=e=>{if(!Array.isArray(e)||e.length===0)return e;let r=new Map([[\"global\",[]],[\"character\",[]]]);return e.forEach(t=>{if(!t||typeof t!=\"object\"||t.source===\"card\")return;let a=t.scope===\"character\"?\"character\":\"global\";r.get(a).push(t)}),r.forEach(t=>er(t)),e},Qr=e=>{if(e===!0||e===!1)return e;if(e==null)return!1;if(typeof e==\"string\"){let r=e.trim().toLowerCase();return[\"1\",\"true\",\"yes\",\"on\"].includes(r)}return!!e},Ue=e=>{if(e===\"\"||e===null||e===void 0)return null;let r=Number(e);return Number.isNaN(r)?null:r},Vo=e=>{if(e==null)return\"and_any\";if(typeof e==\"number\"&&!Number.isNaN(e))return gt[e]??gt[e.toString()]??\"and_any\";let r=e.toString().trim().toLowerCase();return vt[r]!==void 0?r:gt[r]!==void 0?gt[r]:\"and_any\"};var Rr=e=>{if(typeof e==\"string\"){let r=e.trim().toLowerCase();if(ta[r]!==void 0)return r}if(typeof e==\"number\"&&!Number.isNaN(e)){let r=Ho[e]??Ho[e.toString()];if(r)return r}return null},Gt=(e,r)=>{if(e==null)return\"before_character_definition\";if(typeof e==\"object\"&&e!==null){if(typeof e.type==\"string\"&&e.type){let t=(xt[e.type]??e.type).trim();if(t===\"at_depth\"||t===\"at_depth_as_system\"){let a=Rr(e.role??r)??\"system\";return a===\"assistant\"?\"at_depth_as_assistant\":a===\"user\"?\"at_depth_as_user\":\"at_depth_as_system\"}return t.startsWith(\"at_depth_as_\"),t}if(typeof e.position==\"number\"&&!Number.isNaN(e.position))return Gt(e.position,e.role??r)}if(typeof e==\"string\"){let t=(xt[e]??e).trim();if(t===\"at_depth\"){let a=Rr(r)??\"system\";return a===\"assistant\"?\"at_depth_as_assistant\":a===\"user\"?\"at_depth_as_user\":\"at_depth_as_system\"}return t}if(typeof e==\"number\"&&!Number.isNaN(e)){if(e===4){let a=Rr(r)??\"system\";return a===\"assistant\"?\"at_depth_as_assistant\":a===\"user\"?\"at_depth_as_user\":\"at_depth_as_system\"}let t=oa[e];if(t)return t}return\"before_character_definition\"};var Yo=(e,{fallbackRole:r=null,fallbackDepth:t=null,fallbackOrder:a=null}={})=>{let l=Rr(r),n={type:\"before_character_definition\",role:null,depth:null,order:Ue(a),uiKey:\"before_character_definition\"},i=b=>{let p=Ue(b);p!==null&&(n.order=p)},h=b=>{let p=Ue(b);p!==null&&(n.depth=p)};if(i(a),h(t),e&&typeof e==\"object\"){if(typeof e.type==\"string\"&&e.type){let b=(xt[e.type]??e.type).trim();n.type=b===\"at_depth_as_system\"?\"at_depth\":b;let p=Rr(e.role)??l;return n.type===\"at_depth\"?(n.role=p??\"system\",h(e.depth),n.uiKey=n.role===\"assistant\"?\"at_depth_as_assistant\":n.role===\"user\"?\"at_depth_as_user\":\"at_depth_as_system\"):(n.role=null,n.depth=null,n.uiKey=n.type),i(e.order),n}if(typeof e.position==\"number\"&&!Number.isNaN(e.position)){let b=Rr(e.role)??l,p=Gt(e.position,b);return n.uiKey=p,p.startsWith(\"at_depth\")?(n.type=\"at_depth\",n.role=b??\"system\",h(e.depth)):(n.type=p,n.role=null,n.depth=null),i(e.order),n}}let m=Gt(e,l);return n.uiKey=m,m.startsWith(\"at_depth\")?(n.type=\"at_depth\",n.role=m===\"at_depth_as_assistant\"?\"assistant\":m===\"at_depth_as_user\"?\"user\":\"system\",n.depth===null&&(n.depth=Ue(t))):(n.type=m,n.role=null,n.depth=null),n},na=(e,{depth:r,order:t,basePosition:a}={})=>{let l=Yo(a??null),n=(xt[e]??e??l.uiKey).toString().trim()||l.uiKey||\"before_character_definition\",i=Ft[n]??Ft[l.uiKey]??Ft.before_character_definition,h={type:i.type},m=Ue(t),b=m!==null?m:l.order!==null&&l.order!==void 0?l.order:0;if(h.order=b,i.type===\"at_depth\"){let p=i.role??l.role??\"system\";h.role=p;let f=Ue(r),v=f!==null?f:l.depth!==null&&l.depth!==void 0?l.depth:0;h.depth=v}return h},ar=e=>{if(!e||typeof e!=\"object\")return e;let r=kr(e);(!r.strategy||typeof r.strategy!=\"object\")&&(r.strategy={});let t=r.strategy,a=qe(Yt(r))??Re;t.type=a.strategyType,r.type=a.strategyType,r.statusId=a.id;let l=Zr(t.keys??r.keys??r.key??r.keywords);t.keys=[...l],r.keys=[...l],r.key=[...l],r.keywords=[...l];let n=Zr(t.keys_secondary?.keys??r.keysecondary??r.key_secondary??[]);(!t.keys_secondary||typeof t.keys_secondary!=\"object\")&&(t.keys_secondary={logic:\"and_any\",keys:[]}),t.keys_secondary.keys=[...n],r.keysecondary=[...n];let i=Vo(t.keys_secondary.logic??r.logic??r.selectiveLogic);t.keys_secondary.logic=i,r.logic=i,r.selectiveLogic=vt[i];let h=Yo(r.position,{fallbackRole:r.role,fallbackDepth:r.depth,fallbackOrder:r.order??r.insertion_order??r.displayIndex});r.position=h.uiKey,r.depth=h.type===\"at_depth\"?h.depth??0:null,r.order=h.order??0,r.role=h.role;let m=Ue(r.probability);return r.probability=m===null?100:m,(!r.recursion||typeof r.recursion!=\"object\")&&(r.recursion={prevent_incoming:!1,prevent_outgoing:!1,delay_until:null}),r.prevent_recursion=Qr(r.prevent_recursion??r.preventRecursion??r.recursion.prevent_outgoing),r.exclude_recursion=Qr(r.exclude_recursion??r.excludeRecursion??r.recursion.prevent_incoming),r.recursion.prevent_outgoing=r.prevent_recursion,r.recursion.prevent_incoming=r.exclude_recursion,r.case_sensitive=Qr(r.case_sensitive??r.caseSensitive??!1),r.caseSensitive=r.case_sensitive,r.match_whole_words=Qr(r.match_whole_words??r.matchWholeWords??!1),r.matchWholeWords=r.match_whole_words,r.enabled=r.disable!==void 0?!r.disable:r.enabled??!0,r},ia=(e,r={})=>{let t=kr(r),a=kr(e),l=qe(a.statusId??a.strategy?.type??a.type)??Re;(!t.strategy||typeof t.strategy!=\"object\")&&(t.strategy={}),t.strategy.type=l.strategyType,t.type=l.strategyType,t.statusId=l.id,a.statusId=l.id,(!a.strategy||typeof a.strategy!=\"object\")&&(a.strategy={}),a.strategy.type=l.strategyType,a.type=l.strategyType;let n=Ue(a.uid);n!==null&&(t.uid=n),a.name!==void 0&&(t.name=a.name),a.comment!==void 0&&(t.comment=a.comment),a.content!==void 0&&(t.content=a.content),(!t.strategy||typeof t.strategy!=\"object\")&&(t.strategy={});let i=t.strategy,h=Zr(a.keys??i.keys??t.keys??t.key??t.keywords);i.keys=[...h],t.keys=[...h],t.key=[...h],t.keywords=[...h];let m=Zr(a.keysecondary??i.keys_secondary?.keys??t.keysecondary);(!i.keys_secondary||typeof i.keys_secondary!=\"object\")&&(i.keys_secondary={logic:\"and_any\",keys:[]}),i.keys_secondary.keys=[...m],t.keysecondary=[...m];let b=Vo(a.logic??i.keys_secondary.logic??t.logic??t.selectiveLogic);i.keys_secondary.logic=b,t.logic=b,t.selectiveLogic=vt[b],a.enabled!==void 0&&(t.enabled=!!a.enabled,t.disable=!t.enabled);let p=Ue(a.probability);p!==null?(t.probability=p,t.useProbability=p!==100):t.probability!==void 0&&(t.useProbability=t.probability!==100);let f=Ue(a.order),v=Ue(a.depth),w=na(a.position??t.position,{depth:v,order:f,basePosition:t.position});t.position=w,w.type===\"at_depth\"?(t.depth=w.depth??0,t.role=w.role??\"system\"):(t.depth=null,t.role=null),w.order!==void 0&&(t.order=w.order,t.insertion_order=w.order,t.displayIndex=w.order),(!t.recursion||typeof t.recursion!=\"object\")&&(t.recursion={prevent_incoming:!1,prevent_outgoing:!1,delay_until:null});let T=t.recursion;a.prevent_recursion!==void 0&&(T.prevent_outgoing=!!a.prevent_recursion),a.exclude_recursion!==void 0&&(T.prevent_incoming=!!a.exclude_recursion),t.preventRecursion=T.prevent_outgoing,t.prevent_recursion=T.prevent_outgoing,t.excludeRecursion=T.prevent_incoming,t.exclude_recursion=T.prevent_incoming;let k=(g,x)=>g===void 0?x:Qr(g),I=k(a.case_sensitive,t.caseSensitive??t.case_sensitive);I!==void 0&&(t.caseSensitive=I,t.case_sensitive=I);let s=k(a.match_whole_words,t.matchWholeWords??t.match_whole_words);return s!==void 0&&(t.matchWholeWords=s,t.match_whole_words=s),t},Ar=e=>{if(typeof e==\"number\"&&Number.isInteger(e))return e;let r=Number(e);return Number.isInteger(r)?r:null},Yt=e=>{if(!e||typeof e!=\"object\")return it;let r=e?.strategy?.type??e?.type;return Wr(r)??it},Kt=e=>e&&typeof e==\"object\"?{uid:Ar(e.uid??e.id??e.entryUid??e.entry_id??null),tempUid:e.tempUid??e.temp_uid??null,name:e.name??\"\"}:{uid:Ar(e),tempUid:null,name:\"\"},Uo=(e,r={})=>{let t=Kt(e),a=Kt(r);return{uid:t.uid??a.uid??null,tempUid:e?.tempUid??e?.temp_uid??a.tempUid??null,name:e?.name??a.name??\"\",previousStatus:Yt(e??{})}},sa=e=>{let r=Kt(e);return{uid:r.uid,tempUid:r.tempUid,name:r.name,previousStatus:null}},Nr=(e,r={})=>({uid:e?.uid??null,tempUid:e?.tempUid??null,name:e?.name??\"\",previousStatus:e?.previousStatus??null,newStatus:r.newStatus??null,alreadyApplied:!!r.alreadyApplied,reason:r.reason??null,error:r.error??null}),Ir=Object.freeze({UNSAVED_ENTRY:\"UNSAVED_ENTRY\",DUPLICATE_SELECTION:\"DUPLICATE_SELECTION\",ENTRY_NOT_FOUND:\"ENTRY_NOT_FOUND\",API_ERROR:\"API_ERROR\",STATUS_NOT_APPLIED:\"STATUS_NOT_APPLIED\"}),ca=e=>Zr(e),Po=e=>{if(!e)return!1;let r=String(e?.message??e??\"\").toLowerCase();return r.includes(\"\\u672A\\u627E\\u5230\\u540D\\u4E3A\")||r.includes(\"character\")&&r.includes(\"not found\")},Y={createWorldbook:A(async e=>await Se().createWorldbook(e,[])),deleteWorldbook:A(async e=>await Se().deleteWorldbook(e)),getWorldbooks:A(async()=>await Se().getWorldbookNames()),getCharData:A(async()=>await Se().getCharData()),getRegexes:A(async()=>await Se().getTavernRegexes({scope:\"all\"})),replaceRegexes:A(async(e,r={})=>{let t=r?.scope??\"all\",a=Array.isArray(e)?e:[];aa(a),await Se().replaceTavernRegexes(a,{scope:t})}),getGlobalWorldbookNames:A(async()=>await Se().getGlobalWorldbookNames()),rebindGlobalWorldbooks:A(async e=>await Se().rebindGlobalWorldbooks(e)),getCharWorldbookNames:A(async e=>{try{let r=e?.name;return r?await Se().getCharWorldbookNames(r):(console.warn(\"[RegexLoreHub] getCharWorldbookNames \\u8C03\\u7528\\u7F3A\\u5C11\\u89D2\\u8272\\u540D\\u79F0\\u3002\"),null)}catch(r){if(Po(r))return console.warn(\"[RegexLoreHub] \\u672A\\u627E\\u5230\\u6307\\u5B9A\\u89D2\\u8272\\u5361\\uFF0C\\u8DF3\\u8FC7\\u89D2\\u8272\\u4E16\\u754C\\u4E66\\u52A0\\u8F7D\\u3002\",r),null;throw r}}),getCurrentCharWorldbookNames:A(async()=>{try{return await Se().getCharWorldbookNames(\"current\")}catch(e){if(Po(e))return console.warn(\"[RegexLoreHub] \\u672A\\u627E\\u5230\\u5F53\\u524D\\u89D2\\u8272\\u5361\\uFF0C\\u8DF3\\u8FC7\\u89D2\\u8272\\u4E16\\u754C\\u4E66\\u52A0\\u8F7D\\u3002\",e),null;throw e}}),getChatWorldbookName:A(async()=>await Se().getChatWorldbookName(\"current\")),getOrCreateChatWorldbook:A(async e=>await Se().getOrCreateChatWorldbook(\"current\",e)),rebindChatWorldbook:A(async e=>await Se().rebindChatWorldbook(\"current\",e)),getWorldbook:A(async e=>await Se().getWorldbook(e)),updateWorldbookWith:A(async(e,r)=>await Se().updateWorldbookWith(e,r)),replaceWorldbook:A(async(e,r)=>await Se().replaceWorldbook(e,r)),createWorldbookEntries:A(async(e,r)=>await Se().createWorldbookEntries(e,r)),deleteWorldbookEntries:A(async(e,r)=>{let t=new Set(r);return await Se().deleteWorldbookEntries(e,a=>t.has(a.uid))}),saveSettings:A(async()=>await Se().builtin.saveSettings()),rebindCharWorldbooks:A(async e=>await Se().rebindCharWorldbooks(\"current\",e)),get Character(){return Se().Character}},je=A(async(e,r)=>{if(!Array.isArray(r)||r.length===0)return;let t=new Map,a=new Set;if(r.forEach(b=>{if(!b||typeof b!=\"object\")return;let p=Ue(b.uid);if(p===null)return;a.add(p);let f=t.get(p)??{};t.set(p,{...f,...b})}),a.size===0)return;let l=ne(e),n=new Map(l.map(b=>[Ue(b?.uid),b]).filter(([b])=>b!==null)),i=b=>b.map(p=>{let f=Ue(p?.uid);if(f===null||!a.has(f))return p;let v=n.get(f);if(!v)return p;let w=kr(v),T=t.get(f);return T&&typeof T==\"object\"&&Object.entries(T).forEach(([k,I])=>{k===\"uid\"||k===\"tempUid\"||(Array.isArray(I)?w[k]=I.map(s=>typeof s==\"object\"&&s!==null?kr(s):s):I&&typeof I==\"object\"?w[k]=kr(I):w[k]=I)}),ia(w,p)}),h=await Y.updateWorldbookWith(e,i),m=Array.isArray(h)?h.map(ar):[];return Oe(e,m),wr(e),await Y.saveSettings(),h}),zo=(e,r,t,a,l)=>{let n=r.length,i=t.length,h=a.length,m=r.filter(v=>v.alreadyApplied).length,b=n-m,p=a.filter(v=>v.reason===Ir.UNSAVED_ENTRY).length,f=\"skipped\";return n>0&&i===0?f=\"success\":n>0&&i>0?f=\"partial\":i>0&&(f=\"failed\"),{status:f,successCount:n,failedCount:i,ignoredCount:h,alreadyAppliedCount:m,appliedCount:b,ignoredUnsavedCount:p,requestedCount:l,targetStatusId:e.id,targetStatusLabel:e.label}},qo=async(e,r,t,a={})=>{let l=Array.isArray(r)?r.filter(s=>s!=null):r!=null?[r]:[],n=l.length,i=qe(t);if(!i)return{ok:!1,targetStatusId:Wr(t),targetStatusLabel:\"\",targetStrategyType:null,success:[],failed:[],ignored:[],summary:{status:\"failed\",successCount:0,failedCount:0,ignoredCount:0,alreadyAppliedCount:0,appliedCount:0,ignoredUnsavedCount:0,requestedCount:n,targetStatusId:Wr(t),targetStatusLabel:\"\"},errorCode:\"INVALID_STATUS\"};if(!e||typeof e!=\"string\"){let s=Re;return{ok:!1,targetStatusId:s.id,targetStatusLabel:s.label,targetStrategyType:s.strategyType,success:[],failed:[],ignored:[],summary:zo(s,[],[],[],n),errorCode:\"INVALID_BOOK_NAME\"}}let h=ne(e),m=new Map(h.map(s=>[Ar(s?.uid),s])),b=new Set,p=[],f=[],v=[],w=[],T=new Map;l.forEach(s=>{let g=sa(s);if(g.uid===null){v.push(Nr(g,{reason:Ir.UNSAVED_ENTRY}));return}if(b.has(g.uid)){let S=m.get(g.uid),K=S?Uo(S,g):g;v.push(Nr(K,{reason:Ir.DUPLICATE_SELECTION}));return}b.add(g.uid);let x=m.get(g.uid);if(!x){f.push(Nr(g,{reason:Ir.ENTRY_NOT_FOUND}));return}let C=Uo(x,g);if(C.previousStatus===i.id){p.push(Nr(C,{newStatus:i.id,alreadyApplied:!0}));return}let D=kr(x.strategy??{});D.type=i.strategyType,w.push({uid:C.uid,statusId:i.id,strategy:D,type:i.strategyType}),T.set(C.uid,C)});let k;if(w.length>0&&(k=await je(e,w)),T.size>0){let s=ne(e),g=new Map(s.map(C=>[Ar(C?.uid),C])),x=w.length>0&&!Array.isArray(k);T.forEach(C=>{let D=g.get(C.uid),S=Yt(D);if(!D||S!==i.id){f.push(Nr(C,{reason:x?Ir.API_ERROR:Ir.STATUS_NOT_APPLIED}));return}p.push(Nr(C,{newStatus:i.id}))})}let I=zo(i,p,f,v,n);return{ok:I.status===\"success\",targetStatusId:i.id,targetStatusLabel:i.label,targetStrategyType:i.strategyType,targetToastLabel:i.toastLabel??i.label,success:p,failed:f,ignored:v,summary:I,options:a}};var da=e=>(o.pendingLorebookUpdates.has(e)||o.pendingLorebookUpdates.set(e,new Map),o.pendingLorebookUpdates.get(e)),qt=(e,r,t={})=>{if(!e||!t||typeof t!=\"object\")return;let a=Ar(r),l=String(r),n=da(e),i=n.get(l)??{uid:a,tempUid:a==null?l:null,data:{}};a!=null&&(i.uid=a),(!i.data||typeof i.data!=\"object\")&&(i.data={});let h={...t};Array.isArray(h.keys)&&(h.keys=ca(h.keys)),Object.entries(h).forEach(([m,b])=>{b!==void 0&&(i.data[m]=b)}),n.set(l,i)},Xo=e=>{e!=null&&o.pendingRegexUpdates.add(e)},ha=(e,r,t)=>{let a=Ar(t);if(!e||r==null||a==null)return;let l=o.pendingLorebookUpdates.get(e);if(!l||!(l instanceof Map))return;let n=String(r),i=l.get(n);if(!i)return;l.delete(n);let h=String(a),m=l.get(h)??{uid:a,tempUid:null,data:{}};m.uid=a,(!m.data||typeof m.data!=\"object\")&&(m.data={}),i.data&&typeof i.data==\"object\"&&(m.data={...i.data,...m.data}),l.set(h,m)},Jr=null,pa=async()=>{let e=xe(),r=we(),t=$e(),a=Se(),l=e(`#${ke}-content`,r);et();let i=(()=>{l.html(`\n      <div class=\"rlh-loading\">\n        <div class=\"rlh-loading-spinner\" aria-hidden=\"true\"></div>\n        <div class=\"rlh-loading-text\">\n          <p class=\"rlh-loading-title\">\\u6B63\\u5728\\u52A0\\u8F7D\\u6570\\u636E...</p>\n          <p class=\"rlh-loading-status\">\\u521D\\u59CB\\u5316...</p>\n          <div class=\"rlh-loading-bar\" role=\"progressbar\" aria-valuemin=\"0\" aria-valuemax=\"100\" aria-valuenow=\"0\">\n            <div class=\"rlh-loading-bar-inner\"></div>\n          </div>\n          <div class=\"rlh-loading-progress\">0%</div>\n          <p class=\"rlh-loading-detail\"></p>\n        </div>\n      </div>\n    `);let f=l.find(\".rlh-loading-status\"),v=l.find(\".rlh-loading-detail\"),w=l.find(\".rlh-loading-progress\"),T=l.find(\".rlh-loading-bar-inner\"),k=l.find(\".rlh-loading-bar\"),I=1,s=0,g=()=>{let x=Math.max(1,I),C=Math.min(s/x,1),D=Math.round(C*100);T.css(\"width\",`${D}%`),k.attr(\"aria-valuenow\",D),w.text(`${D}%`)};return g(),{setProgress(x,C,D,S){I=Math.max(1,C),s=Math.max(0,Math.min(x,I)),D&&f.text(D),S!==void 0&&v.text(S),g()},setStatus(x,C){x&&f.text(x),C!==void 0&&v.text(C)}}})(),h=4,m=0,b=(p,f)=>{m=Math.min(m+1,h),i.setProgress(m,h,p,f)};i.setProgress(m,h,\"\\u51C6\\u5907\\u52A0\\u8F7D\\u6570\\u636E...\",\"\\u6B63\\u5728\\u68C0\\u67E5\\u8FD0\\u884C\\u73AF\\u5883\");try{if(!t.SillyTavern||!t.SillyTavern.getContext){console.warn(\"[RegexLoreHub] SillyTavern API not available, initializing with empty data\"),o.regexes.global=[],o.regexes.character=[],o.allLorebooks=[],o.lorebooks.character=[],o.chatLorebook=null,Bt(),o.isDataLoaded=!0,se();return}b(\"\\u83B7\\u53D6\\u57FA\\u7840\\u6570\\u636E...\",\"\\u6B63\\u5728\\u5411 SillyTavern \\u8BF7\\u6C42\\u6570\\u636E\");let p=t.SillyTavern?.getContext?.()||{},f=Array.isArray(p.characters)?p.characters:[],v=p.characterId!==void 0&&p.characterId!==null,w=p.chatId!==void 0&&p.chatId!==null,T=null,k=null,I=null,s=[Y.getRegexes().catch(()=>[]),Y.getGlobalWorldbookNames().catch(()=>[]),Y.getWorldbooks().catch(()=>[])];v?(s.push(Y.getCharData().catch(()=>null)),s.push(Y.getCurrentCharWorldbookNames().catch(()=>null))):s.push(Promise.resolve(null),Promise.resolve(null)),w?s.push(Y.getChatWorldbookName().catch(q=>(console.warn(\"[RegexLoreHub] Failed to get chat worldbook:\",q),null))):s.push(Promise.resolve(null));let g=await Promise.allSettled(s);b(\"\\u89E3\\u6790\\u6570\\u636E\\u7ED3\\u6784...\",`\\u68C0\\u6D4B\\u5230 ${f.length} \\u4E2A\\u89D2\\u8272\\uFF0C\\u6B63\\u5728\\u6574\\u7406\\u6570\\u636E`);let x=g[0].status===\"fulfilled\"?g[0].value:[],C=g[1].status===\"fulfilled\"?g[1].value:[],D=g[2].status===\"fulfilled\"?g[2].value:[];T=g[3]?.status===\"fulfilled\"?g[3].value:null,k=g[4]?.status===\"fulfilled\"?g[4].value:null,I=g[5]?.status===\"fulfilled\"?g[5].value:null,et({charData:T}),o.regexes.global=Array.isArray(x)?x.filter(q=>q.scope===\"global\"):[],er(o.regexes.global),tl(x,T),Bt(),o.pendingLorebookUpdates instanceof Map?o.pendingLorebookUpdates.clear():o.pendingLorebookUpdates=new Map,o.pendingRegexUpdates instanceof Set?o.pendingRegexUpdates.clear():o.pendingRegexUpdates=new Set,o.lorebookUsage.clear();let S=new Set(Array.isArray(D)?D:[]);if(Array.isArray(f)&&f.length>0)try{await Promise.all(f.map(async q=>{if(!(!q||!q.name))try{let Z=null;try{let W=a.getCharWorldbookNames(q.name);W&&typeof W.then==\"function\"?Z=await W:Z=W}catch(W){console.warn(`[RegexLoreHub] Error getting worldbooks for character \"${q.name}\":`,W),Z=null}if(Z&&typeof Z==\"object\"){let W=new Set;Z.primary&&typeof Z.primary==\"string\"&&W.add(Z.primary),Array.isArray(Z.additional)&&Z.additional.forEach(oe=>typeof oe==\"string\"&&W.add(oe)),W.forEach(oe=>{typeof oe==\"string\"&&(o.lorebookUsage.has(oe)||o.lorebookUsage.set(oe,[]),o.lorebookUsage.get(oe).push(q.name),S.add(oe),console.log(`[RegexLoreHub] Character \"${q.name}\" uses worldbook \"${oe}\"`))})}}catch(Z){console.warn(`[RegexLoreHub] Error processing character ${q.name}:`,Z)}}))}catch(q){console.warn(\"[RegexLoreHub] Error processing characters:\",q)}let K=new Set(Array.isArray(C)?C:[]);o.allLorebooks=(Array.isArray(D)?D:[]).map(q=>({name:q,enabled:K.has(q),entryCount:0,enabledEntryCount:0,entriesLoaded:!1}));let ce=new Set;k&&typeof k==\"object\"&&(k.primary&&typeof k.primary==\"string\"&&ce.add(k.primary),Array.isArray(k.additional)&&k.additional.forEach(q=>typeof q==\"string\"&&ce.add(q))),o.lorebooks.character=Array.from(ce),o.chatLorebook=typeof I==\"string\"?I:null,typeof I==\"string\"&&S.add(I),b(\"\\u6784\\u5EFA\\u7D22\\u5F15...\",\"\\u4E16\\u754C\\u4E66\\u5217\\u8868\\u5DF2\\u52A0\\u8F7D\"),o.isDataLoaded=!0,b(\"\\u6E32\\u67D3\\u754C\\u9762...\",\"\\u6570\\u636E\\u52A0\\u8F7D\\u5B8C\\u6210\"),se(),fa()}catch(p){throw console.error(\"[RegexLoreHub] Error in loadAllData:\",p),l.html(`\n                <div class=\"rlh-error-wrapper\">\n                    <p class=\"rlh-error-title\">\n                        <i class=\"fa-solid fa-exclamation-triangle\"></i> \\u6570\\u636E\\u52A0\\u8F7D\\u5931\\u8D25\n                    </p>\n                    <p class=\"rlh-error-text\">\n                        \\u8BF7\\u68C0\\u67E5\\u5F00\\u53D1\\u8005\\u63A7\\u5236\\u53F0\\u83B7\\u53D6\\u8BE6\\u7EC6\\u4FE1\\u606F\\uFF0C\\u6216\\u5C1D\\u8BD5\\u5237\\u65B0\\u9875\\u9762\\u3002\n                    </p>\n                    <button class=\"rlh-modal-btn rlh-error-retry-btn\" onclick=\"$('#${Dr}').click()\">\n                        <i class=\"fa-solid fa-refresh\"></i> \\u91CD\\u8BD5\n                    </button>\n                </div>\n            `),p}},We=A(async(e=!1)=>{if(e)o.isDataLoaded=!1;else if(o.isDataLoaded)return;if(!(Jr&&(await Jr,!e))){Jr=pa();try{await Jr}finally{Jr=null}}}),jt=!1,ua=3,Fo=e=>new Promise(r=>setTimeout(r,e)),Jo=()=>{let e=xe(),r=we();if(!e||!r)return{};let t=e(`#${ot}`,r);if(!t.length)return{};let a=t.find(`#${lt}`),l=t.find(`#${at}`),n=t.find(\".rlh-prefetch-bar\");return{$indicator:t,$text:a,$bar:l,$barContainer:n}},Qo=e=>{let{$indicator:r,$bar:t,$barContainer:a}=Jo();r&&(r.attr(\"data-visible\",e?\"true\":\"false\"),r.attr(\"aria-hidden\",e?\"false\":\"true\"),e||(t?.length&&t.css(\"width\",\"0%\"),a?.length&&a.attr(\"aria-valuenow\",0)))},Zo=(e,r)=>{let{$indicator:t,$text:a,$bar:l,$barContainer:n}=Jo();if(!t)return;let i=r>0?r:1,h=Math.min(e,r),m=Math.round(h/i*100),b=`\\u540E\\u53F0\\u52A0\\u8F7D\\u4E16\\u754C\\u4E66 (${h}/${r})\\uFF0C\\u4E0D\\u5F71\\u54CD\\u5176\\u4ED6\\u64CD\\u4F5C`;a?.length&&a.text(b),l?.length&&l.css(\"width\",`${Math.min(m,100)}%`),n?.length&&n.attr(\"aria-valuenow\",Math.min(m,100))},Vt=()=>{Qo(!1)},ba=e=>{let r=xe(),t=we();if(!r||!t)return;let a=r(`#${ke}`,t);if(!a.length)return;let l=a.find(\".rlh-book-group\").filter((i,h)=>r(h).data(\"book-name\")===e);if(!l.length)return;let n=o.allLorebooks.find(i=>i.name===e);n&&l.find(\".rlh-book-stats\").text(`\\u6761\\u76EE: ${n.enabledEntryCount} / ${n.entryCount}`)},ma=e=>{if(e<=0){Vt();return}Qo(!0),Zo(0,e)},fa=A(async()=>{if(jt)return;let e=o.allLorebooks.filter(r=>!r.entriesLoaded);if(e.length===0){Vt();return}jt=!0,ma(e.length);try{let r=0,t=[...e],a=async()=>{for(;t.length>0;){let n=t.shift();if(!n)break;try{await Ie(n.name),ba(n.name)}finally{r+=1,Zo(r,e.length)}await Fo(30)}},l=Math.min(ua,t.length);await Promise.all(Array.from({length:l},()=>a()))}finally{await Fo(260),Vt(),jt=!1}}),el=()=>{let e=Array.isArray(o.allLorebooks)?o.allLorebooks:[],r=new Map,t=new Set,a=0;return e.forEach(l=>{let n=wo(l);n.name&&(a+=1,r.set(n.name,n),n.bindingCount===0&&t.add(n.name))}),{totalBooks:a,unboundNames:t,statsByName:r}},rl=A(async()=>{let r=$e().SillyTavern?.getContext?.()||{},t=r.chatId!==void 0&&r.chatId!==null,a=[Y.getCharData(),Y.getCurrentCharWorldbookNames(),Y.getRegexes()];t?a.push(Y.getChatWorldbookName().catch(b=>(console.warn(\"[RegexLoreHub] Failed to get chat worldbook in refreshCharacterData:\",b),null))):a.push(Promise.resolve(null));let[l,n,i,h]=await Promise.all(a);tl(i,l),et({charData:l}),ga(n),o.chatLorebook=h;let m=o.lorebooks.character.filter(b=>!Ot(b));m.length>0&&await Promise.all(m.map(async b=>{let p=await Y.getWorldbook(b);Oe(b,p.map(ar))}))});function tl(e,r){let t=e?.filter(i=>i.scope===\"character\")||[],a=[];if(r&&Y.Character)try{a=(new Y.Character(r).getRegexScripts()||[]).map((h,m)=>({id:h.id||`card-${Date.now()}-${m}`,script_name:h.scriptName||\"\\u672A\\u547D\\u540D\\u5361\\u5185\\u6B63\\u5219\",find_regex:h.findRegex,replace_string:h.replaceString,enabled:!h.disabled,scope:\"character\",source:\"card\"}))}catch(i){console.warn(\"\\u65E0\\u6CD5\\u89E3\\u6790\\u89D2\\u8272\\u5361\\u6B63\\u5219\\u811A\\u672C:\",i)}let l=new Set(t.map(i=>`${i.script_name}::${i.find_regex}::${i.replace_string}`)),n=a.filter(i=>{let h=`${i.script_name}::${i.find_regex}::${i.replace_string}`;return!l.has(h)});o.regexes.character=[...t,...n],er(o.regexes.character)}function ga(e){let r=[];e&&(e.primary&&r.push(e.primary),e.additional&&r.push(...e.additional)),o.lorebooks.character=[...new Set(r)]}var wr=e=>{let r=ne(e),t=o.allLorebooks.find(a=>a.name===e);t&&(t.entryCount=r.length,t.enabledEntryCount=r.filter(a=>a.enabled).length)},ol=e=>{let r={uid:`temp-${Date.now()}`,name:\"\\u65B0\\u6761\\u76EE\",comment:\"\",content:\"\",keys:[],key:[],keysecondary:[],statusId:it,enabled:!0,disable:!1,is_temp:!0,selective:!0,selectiveLogic:vt.and_any,logic:\"and_any\",constant:!1,position:\"before_character_definition\",depth:null,order:0,probability:100,useProbability:!1,case_sensitive:!1,match_whole_words:!1,prevent_recursion:!1,exclude_recursion:!1,type:Re?.strategyType??\"constant\",strategy:{type:Re?.strategyType??\"constant\",keys:[],keys_secondary:{logic:\"and_any\",keys:[]},scan_depth:\"same_as_global\"}},t=ne(e);return t.unshift(r),Oe(e,t),r},ll=(e,r,t)=>{let a=ne(e),l=a.findIndex(n=>n.uid===r);if(l!==-1){let n=ar(t),i={...a[l],...n,is_temp:!1};a[l]=i,Oe(e,a),ha(e,r,i.uid)}else console.warn(`[RegexLoreHub] \\u5728\\u66F4\\u65B0\\u65F6\\u627E\\u4E0D\\u5230\\u4E34\\u65F6\\u6761\\u76EE: ${r}`)},Ie=A(async(e,r=!1)=>{let t=o.allLorebooks.find(a=>a.name===e);if(!(!t||Ot(e)&&!r))try{let a=await Y.getWorldbook(e);a=a.map(ar),Oe(e,a),t.entriesLoaded=!0,wr(e)}catch(a){console.error(`[RegexLoreHub] Failed to load entries for worldbook \"${e}\":`,a),t.entriesLoaded=!0}}),pr=A(async(e={})=>{let{silent:r=!1}=e,t=3,a=3e3,l=0,n=p=>new Promise(f=>setTimeout(f,p)),i=()=>{r?mt():se()},h=async()=>{if(!(o.pendingLorebookUpdates instanceof Map))return o.pendingLorebookUpdates=new Map,!1;let p=!1;for(let[f,v]of[...o.pendingLorebookUpdates.entries()]){if(!(v instanceof Map)||v.size===0)continue;let w=[],T=[];for(let[I,s]of v.entries()){let g=s?.uid;if(typeof g!=\"number\"||Number.isNaN(g))continue;let x=s?.data;if(!x||Object.keys(x).length===0){T.push(I);continue}w.push({uid:g,...x}),T.push(I)}if(w.length===0){T.forEach(I=>v.delete(I)),v.size===0&&o.pendingLorebookUpdates.delete(f);continue}await je(f,w)&&(p=!0,T.forEach(I=>v.delete(I)),v.size===0&&o.pendingLorebookUpdates.delete(f))}return p},m=async()=>{if(!(o.pendingRegexUpdates instanceof Set))return o.pendingRegexUpdates=new Set,!1;if(o.pendingRegexUpdates.size===0)return!1;er(o.regexes.global),er(o.regexes.character);let p=[...o.regexes.global,...o.regexes.character];return await Y.replaceRegexes(p.filter(f=>f.source!==\"card\")),await Y.saveSettings(),o.pendingRegexUpdates.clear(),!0},b=async()=>{console.log(\"[RegexLoreHub] \\u6267\\u884C\\u7EDF\\u4E00\\u4FDD\\u5B58\\u64CD\\u4F5C...\");let p=await h(),f=await m();return console.log(!p&&!f?\"[RegexLoreHub] \\u6CA1\\u6709\\u5F85\\u4FDD\\u5B58\\u7684\\u66F4\\u6539\\u3002\":\"[RegexLoreHub] \\u4FDD\\u5B58\\u64CD\\u4F5C\\u5B8C\\u6210\\u3002\"),!0};for(;l<t;)try{o.saveRetryAttempt=l+1,o.saveStatus=l===0?\"saving\":\"retrying\",i(),await b(),o.saveStatus=\"success\",o.saveRetryAttempt=0,i(),await n(1500),o.saveStatus=\"idle\",i(),console.log(\"[RegexLoreHub] \\u6240\\u6709\\u66F4\\u6539\\u5DF2\\u6210\\u529F\\u4FDD\\u5B58\\u3002\");return}catch(p){if(l++,console.error(`[RegexLoreHub] \\u4FDD\\u5B58\\u5931\\u8D25\\uFF0C\\u5C1D\\u8BD5\\u6B21\\u6570 ${l}/${t}:`,p),l>=t)throw o.saveStatus=\"failed\",i(),console.error(\"[RegexLoreHub] \\u6240\\u6709\\u91CD\\u8BD5\\u5747\\u5931\\u8D25\\uFF0C\\u5DF2\\u505C\\u6B62\\u4FDD\\u5B58\\u3002\"),new Error(\"\\u81EA\\u52A8\\u4FDD\\u5B58\\u5931\\u8D25\\uFF0C\\u8BF7\\u68C0\\u67E5\\u8FDE\\u63A5\\u6216\\u624B\\u52A8\\u4FDD\\u5B58\\u3002\");await n(a)}}),He=e=>{if(typeof e!=\"string\")return null;let r=e.trim();return r.length>0?r:null},Wt=e=>!e||typeof e!=\"object\"?null:He(e.name)||He(e.display_name)||He(e.title)||He(e.metadata?.name)||He(e.filename)||He(e.external_id),xa=e=>!e||typeof e!=\"object\"?null:He(e.name)||He(e.char_name)||He(e.display_name)||He(e.metadata?.name)||He(e.data?.name)||He(e.data?.char_name)||He(e.data?.display_name),va=(e,r)=>{if(!e||r===void 0||r===null)return!1;let t=String(r);return[e.id,e.characterId,e.metadata?.characterId,e.metadata?.id,e.external_id,e.filename].map(l=>l==null?null:String(l)).some(l=>l&&l===t)},et=({charData:e=null}={})=>{let t=$e().SillyTavern?.getContext?.()||{},a=Array.isArray(t.characters)?t.characters:[],l=t.characterId!==void 0&&t.characterId!==null?t.characterId:null,n=He(t.name)||Wt(t.character);if(!n&&l!==null){let i=a.find(h=>va(h,l));i&&(n=Wt(i))}!n&&e&&(n=xa(e)),!n&&a.length===1&&(n=Wt(a[0])),o.characterContext.name=n??null,o.characterContext.id=l,console.log(\"[RegexLoreHub] Context synced with appState:\",o.characterContext)};function al(e={}){let r=e.$??xe(),t=e.parentDoc??we(),a=e.parentWin??$e(),l=async(s,{showLoading:g=!0}={})=>{let x=(s??\"\").toString().trim();if(!x)return;let C=o.loadingBookName;try{g&&(o.loadingBookName=x,se()),await Ie(x,!0)}finally{o.loadingBookName=C&&C!==x?C:null,se()}},n=A(async s=>{o.activeView=\"global-lore-detail\",o.activeBookName=s,o.loadingBookName=s,se(),await Ie(s),o.loadingBookName=null,se()}),i=A(async()=>{o.activeView=\"global-lore-list\",o.activeBookName=null,o.selectedItems.clear(),o.globalSearch={term:\"\",replace:\"\"};let s=r(\"#rlh-global-search-input\",t);s.length&&s.val(\"\"),se()}),h=async(s,g,x,C={})=>{let D=o.lorebookUsage.get(s)||[];if(D.length===0)return;let S=a.SillyTavern.getContext(),K=S.characterId,ce=0,q=D.length,{currentAttempt:Z=1,totalAttempts:W=1}=C;x?.update?.(`\\u6B63\\u5728\\u66F4\\u65B0 ${q} \\u4E2A\\u5173\\u8054\\u89D2\\u8272... (${ce}/${q})\\uFF08\\u5C1D\\u8BD5 ${Z}/${W}\\uFF09`);let oe=[];try{for(let ue of D){try{let re=a.Character?.findCharacterIndex?.(ue)??S.characters.findIndex(u=>u.name===ue);if(re===-1){console.warn(`[RegexLoreHub] Character \"${ue}\" not found, skipping...`);continue}console.log(`[RegexLoreHub] Switching to character \"${ue}\" (index: ${re})`),await S.selectCharacterById(re);let pe=await Y.getCharWorldbookNames({name:ue});if(!pe){console.warn(`[RegexLoreHub] Failed to get worldbooks for character \"${ue}\"`),oe.push({name:ue,error:new Error(\"\\u65E0\\u6CD5\\u83B7\\u53D6\\u4E16\\u754C\\u4E66\\u5217\\u8868\")});continue}console.log(`[RegexLoreHub] Current worldbooks for \"${ue}\":`,pe);let le=!1;if(pe.primary===s&&(console.log(`[RegexLoreHub] Updating primary lorebook from \"${s}\" to \"${g}\"`),pe.primary=g,le=!0),Array.isArray(pe.additional)){let u=pe.additional.indexOf(s);u>-1&&(console.log(`[RegexLoreHub] Updating additional lorebook at index ${u} from \"${s}\" to \"${g}\"`),pe.additional[u]=g,le=!0)}le?(console.log(`[RegexLoreHub] Saving updated lorebooks for \"${ue}\":`,pe),await Y.rebindCharWorldbooks(pe),console.log(`[RegexLoreHub] Successfully updated lorebooks for \"${ue}\"`)):console.log(`[RegexLoreHub] No updates needed for character \"${ue}\"`)}catch(re){console.error(`[RegexLoreHub] Failed to update lorebook for character \"${ue}\":`,re),oe.push({name:ue,error:re})}ce++,x?.update?.(`\\u6B63\\u5728\\u66F4\\u65B0 ${q} \\u4E2A\\u5173\\u8054\\u89D2\\u8272... (${ce}/${q})\\uFF08\\u5C1D\\u8BD5 ${Z}/${W}\\uFF09`)}}finally{S.characterId!==K&&await S.selectCharacterById(K)}if(oe.length>0){let ue=oe.map(pe=>pe.name).join(\", \"),re=new Error(`\\u4EE5\\u4E0B\\u89D2\\u8272\\u7684\\u4E16\\u754C\\u4E66\\u7ED1\\u5B9A\\u672A\\u6210\\u529F\\u66F4\\u65B0\\uFF1A${ue}`);throw re.details=oe,re}},m=A(async s=>{s.stopPropagation();let x=r(s.currentTarget).closest(\".rlh-book-group, .rlh-detail-view\"),C=x.hasClass(\"rlh-detail-view\"),D=x.data(\"book-name\")||o.activeBookName;if(!D)return;let S;try{S=await J({type:\"prompt\",title:\"\\u91CD\\u547D\\u540D\\u4E16\\u754C\\u4E66\",text:\"\\u8BF7\\u8F93\\u5165\\u65B0\\u7684\\u4E16\\u754C\\u4E66\\u540D\\u79F0\\uFF1A\",value:D})}catch{return}if(S=S.trim(),!S||S===D)return;if(o.allLorebooks.some(B=>B.name===S)){await J({type:\"alert\",title:\"\\u91CD\\u547D\\u540D\\u5931\\u8D25\",text:\"\\u8BE5\\u540D\\u79F0\\u7684\\u4E16\\u754C\\u4E66\\u5DF2\\u5B58\\u5728\\uFF0C\\u8BF7\\u9009\\u62E9\\u5176\\u4ED6\\u540D\\u79F0\\u3002\"});return}let K=o.lorebookUsage.get(D)||[],ce=o.chatLorebook===D,q=ce?1:0,Z=K.length+q;console.log(`[RegexLoreHub] Renaming lorebook \"${D}\" to \"${S}\", linked characters:`,K,\"chat linked:\",ce);let W=`\\u6B64\\u64CD\\u4F5C\\u5C06\\u66F4\\u65B0 ${Z} \\u4E2A\\u7ED1\\u5B9A\\u5173\\u7CFB`;K.length>0&&(W+=`\\uFF0C\\u9700\\u8981\\u4E34\\u65F6\\u5207\\u6362\\u5230 ${K.length} \\u4E2A\\u5173\\u8054\\u89D2\\u8272\\u5361\\u6765\\u66F4\\u65B0\\u4E16\\u754C\\u4E66\\u94FE\\u63A5`),W+=`\\uFF0C\\u671F\\u95F4\\u8BF7\\u52FF\\u64CD\\u4F5C\\u3002\n\n`,K.length>0&&(W+=`\\u5173\\u8054\\u89D2\\u8272\\u5361\\uFF1A${K.join(\", \")}\n`),ce&&(W+=`\\u5173\\u8054\\u804A\\u5929\\uFF1A\\u5F53\\u524D\\u804A\\u5929\n`),o.activeTab===\"global-lore\"&&(W+=`\n\\u26A0\\uFE0F \\u91CD\\u8981\\u63D0\\u793A\\uFF1A\\u7531\\u4E8ESillyTavern API\\u9650\\u5236\\uFF0C\\u65E0\\u6CD5\\u76F4\\u63A5\\u5217\\u51FA\\u6240\\u6709*\\u804A\\u5929\\u4E16\\u754C\\u4E66*\\u7ED1\\u5B9A\\u3002\\u5982\\u679C\\u6B64\\u4E16\\u754C\\u4E66\\u4E0E*\\u804A\\u5929*\\u7ED1\\u5B9A\\uFF0C\\u91CD\\u547D\\u540D\\u540E\\u9700\\u8981\\u624B\\u52A8\\u68C0\\u67E5\\u90A3\\u4E9B\\u804A\\u5929\\u7ED1\\u5B9A\\u72B6\\u6001\\u3002\n`),W+=`\n\\u662F\\u5426\\u7EE7\\u7EED\\uFF1F`;try{await J({type:\"confirm\",title:\"\\u786E\\u8BA4\\u91CD\\u547D\\u540D\",text:W})}catch{return}let oe={maxAttempts:3,delayMs:600},ue=B=>new Promise(j=>setTimeout(j,B)),re=[],pe=(B,j)=>{let te={id:`cleanup-${re.length+1}`,description:B,action:j,status:\"pending\",lastError:null};return re.push(te),te},le=B=>B===\"success\"?\"\\u5DF2\\u5B8C\\u6210\":B===\"failed\"?\"\\u5931\\u8D25\":B===\"running\"?\"\\u6267\\u884C\\u4E2D\":\"\\u5F85\\u6267\\u884C\",u=async(B=!1)=>{for(let j of re)if(!(B&&j.status===\"success\"))try{j.status=\"running\",await j.action(),j.status=\"success\",j.lastError=null}catch(te){j.status=\"failed\",j.lastError=te}},_=B=>{let j=re.length?`<ul class=\"rlh-cleanup-task-list\">${re.map(te=>`<li class=\"rlh-cleanup-task\" data-task-id=\"${te.id}\" data-status=\"${te.status}\">\n                  <span class=\"rlh-cleanup-task-title\">${O(te.description)}</span>\n                  <span class=\"rlh-cleanup-task-status\">${O(le(te.status))}</span>\n                  ${te.lastError?`<div class=\"rlh-cleanup-task-error\">${O(te.lastError.message??String(te.lastError))}</div>`:\"\"}\n                </li>`).join(\"\")}</ul>`:'<p class=\"rlh-cleanup-empty\">\\u6CA1\\u6709\\u9700\\u8981\\u6267\\u884C\\u7684\\u6E05\\u7406\\u4EFB\\u52A1\\u3002</p>';return`\n        <div class=\"rlh-cleanup-modal\">\n          <p class=\"rlh-cleanup-error\">${O(B)}</p>\n          ${j}\n          ${re.length?'<button type=\"button\" class=\"rlh-modal-btn rlh-cleanup-retry\">\\u91CD\\u8BD5\\u6E05\\u7406</button>':\"\"}\n          <p class=\"rlh-cleanup-hint\">\\u5982\\u6E05\\u7406\\u591A\\u6B21\\u5931\\u8D25\\uFF0C\\u8BF7\\u67E5\\u770B\\u63A7\\u5236\\u53F0\\u6216\\u5728 SillyTavern \\u4E2D\\u624B\\u52A8\\u6062\\u590D\\u3002</p>\n        </div>\n      `},M=async B=>{let j=J({type:\"alert\",title:\"\\u91CD\\u547D\\u540D\\u5931\\u8D25\",html:_(B)});setTimeout(()=>{let te=r(\".rlh-modal-overlay\",t).last();if(te.length===0)return;let ie=()=>{re.forEach(ge=>{let _e=te.find(`[data-task-id=\"${ge.id}\"]`);if(_e.length===0)return;_e.attr(\"data-status\",ge.status),_e.find(\".rlh-cleanup-task-status\").text(le(ge.status));let G=_e.find(\".rlh-cleanup-task-error\");ge.lastError?G.length?G.text(ge.lastError.message??String(ge.lastError)):_e.append(`<div class=\"rlh-cleanup-task-error\">${O(ge.lastError.message??String(ge.lastError))}</div>`):G.length&&G.remove()})};ie();let ae=te.find(\".rlh-cleanup-retry\");ae.length&&ae.on(\"click\",async ge=>{ge.preventDefault(),!ae.prop(\"disabled\")&&(ae.prop(\"disabled\",!0).text(\"\\u6B63\\u5728\\u91CD\\u8BD5...\"),await u(!0),ie(),ae.prop(\"disabled\",!1).text(\"\\u91CD\\u8BD5\\u6E05\\u7406\"))})},0),await j},L=async(B,{description:j,onAttempt:te,onError:ie}={})=>{let ae=0,ge;for(;ae<oe.maxAttempts;){ae+=1,te?.(ae,oe.maxAttempts);try{return await B(ae,oe.maxAttempts)}catch(_e){if(ge=_e,console.warn(`[RegexLoreHub] ${j} \\u7B2C ${ae} \\u6B21\\u5C1D\\u8BD5\\u5931\\u8D25:`,_e),ie?.(_e,ae,oe.maxAttempts),ae>=oe.maxAttempts)break;await ue(oe.delayMs)}}throw ge??new Error(`${j} \\u5931\\u8D25`)},N=lr(\"\\u5F00\\u59CB\\u91CD\\u547D\\u540D...\"),R=o.chatLorebook,H=null,F=!1,Q=!1;try{if(N.update(\"\\u6B63\\u5728\\u521B\\u5EFA\\u65B0\\u4E16\\u754C\\u4E66...\"),!await Y.createWorldbook(S))throw new Error(\"\\u521B\\u5EFA\\u65B0\\u4E16\\u754C\\u4E66\\u6587\\u4EF6\\u5931\\u8D25\\u3002\");pe(`\\u5220\\u9664\\u65B0\\u5EFA\\u7684\\u4E16\\u754C\\u4E66 \"${S}\"`,async()=>{if(!(await Y.getWorldbooks()??[]).includes(S))return;if(await Y.deleteWorldbook(S),(await Y.getWorldbooks()??[]).includes(S))throw new Error(\"\\u65B0\\u4E16\\u754C\\u4E66\\u4ECD\\u5B58\\u5728\\uFF0C\\u5220\\u9664\\u5931\\u8D25\\u3002\")});let j=[...ne(D)];if(j.length>0){let G=j.map(be=>{let de={...be};return delete de.uid,delete de.tempUid,delete de.temp_uid,de});await L(async()=>{await Y.replaceWorldbook(S,G);let be=await Y.getWorldbook(S),de=Array.isArray(be)?be.length:0;if(de!==G.length)throw new Error(`\\u590D\\u5236\\u6761\\u76EE\\u6821\\u9A8C\\u5931\\u8D25\\uFF08\\u671F\\u671B ${G.length} \\u6761\\uFF0C\\u5B9E\\u9645 ${de} \\u6761\\uFF09\\u3002`)},{description:\"\\u590D\\u5236\\u6761\\u76EE\",onAttempt:(be,de)=>{let Ge=be>1?`\\uFF08\\u5C1D\\u8BD5 ${be}/${de}\\uFF09`:\"\";N.update(`\\u6B63\\u5728\\u590D\\u5236\\u6761\\u76EE...${Ge}`)}})}K.length>0&&(await L(async(G,be)=>await h(D,S,N,{currentAttempt:G,totalAttempts:be}),{description:\"\\u66F4\\u65B0\\u89D2\\u8272\\u7ED1\\u5B9A\",onAttempt:(G,be)=>{let de=G>1?`\\uFF08\\u5C1D\\u8BD5 ${G}/${be}\\uFF09`:\"\";N.update(`\\u6B63\\u5728\\u66F4\\u65B0\\u89D2\\u8272\\u7ED1\\u5B9A...${de}`)}}),pe(`\\u6062\\u590D ${K.length} \\u4E2A\\u89D2\\u8272\\u7684\\u4E16\\u754C\\u4E66\\u7ED1\\u5B9A`,async()=>{await h(S,D,null,{currentAttempt:1,totalAttempts:1})})),N.update(\"\\u6B63\\u5728\\u66F4\\u65B0\\u5168\\u5C40\\u8BBE\\u7F6E...\");let te=await Y.getGlobalWorldbookNames(),ie=Array.isArray(te)&&te.includes(D),ae=null;if(ie&&(H=[...te],ae=H.map(G=>G===D?S:G),await L(async()=>{await Y.rebindGlobalWorldbooks(ae);let G=await Y.getGlobalWorldbookNames();if(!Array.isArray(G)||!G.includes(S)||G.includes(D))throw new Error(\"\\u5168\\u5C40\\u4E16\\u754C\\u4E66\\u5217\\u8868\\u66F4\\u65B0\\u6821\\u9A8C\\u5931\\u8D25\\u3002\")},{description:\"\\u66F4\\u65B0\\u5168\\u5C40\\u8BBE\\u7F6E\",onAttempt:(G,be)=>{let de=G>1?`\\uFF08\\u5C1D\\u8BD5 ${G}/${be}\\uFF09`:\"\";N.update(`\\u6B63\\u5728\\u66F4\\u65B0\\u5168\\u5C40\\u8BBE\\u7F6E...${de}`)}}),pe(\"\\u56DE\\u6EDA\\u5168\\u5C40\\u4E16\\u754C\\u4E66\\u7ED1\\u5B9A\",async()=>{if(!Array.isArray(H))return;await Y.rebindGlobalWorldbooks(H);let G=await Y.getGlobalWorldbookNames();if(!Array.isArray(G)||G.includes(S)||!G.includes(D))throw new Error(\"\\u5168\\u5C40\\u4E16\\u754C\\u4E66\\u56DE\\u6EDA\\u6821\\u9A8C\\u5931\\u8D25\\u3002\")}),F=!0),ce&&(await L(async()=>{await Y.rebindChatWorldbook(S);let G=await Y.getChatWorldbookName();if(G!==S)throw new Error(`\\u804A\\u5929\\u4E16\\u754C\\u4E66\\u4ECD\\u4E3A ${G??\"\\u672A\\u7ED1\\u5B9A\"}`)},{description:\"\\u66F4\\u65B0\\u804A\\u5929\\u7ED1\\u5B9A\",onAttempt:(G,be)=>{let de=G>1?`\\uFF08\\u5C1D\\u8BD5 ${G}/${be}\\uFF09`:\"\";N.update(`\\u6B63\\u5728\\u66F4\\u65B0\\u804A\\u5929\\u7ED1\\u5B9A...${de}`)}}),o.chatLorebook=S,pe(\"\\u6062\\u590D\\u804A\\u5929\\u4E16\\u754C\\u4E66\\u7ED1\\u5B9A\",async()=>{await Y.rebindChatWorldbook(D);let G=await Y.getChatWorldbookName();if(G!==D)throw new Error(`\\u804A\\u5929\\u4E16\\u754C\\u4E66\\u4ECD\\u4E3A ${G??\"\\u672A\\u7ED1\\u5B9A\"}`);o.chatLorebook=D}),Q=!0),N.update(\"\\u6B63\\u5728\\u66F4\\u65B0\\u5185\\u90E8\\u6620\\u5C04...\"),o.lorebookUsage.has(D)){let G=o.lorebookUsage.get(D);o.lorebookUsage.delete(D),o.lorebookUsage.set(S,G),console.log(`[RegexLoreHub] Updated lorebookUsage mapping from \"${D}\" to \"${S}\"`)}await L(async()=>{if(await Y.deleteWorldbook(D),(await Y.getWorldbooks()??[]).includes(D))throw new Error(\"\\u65E7\\u4E16\\u754C\\u4E66\\u4ECD\\u5B58\\u5728\\uFF0C\\u5220\\u9664\\u5931\\u8D25\\u3002\")},{description:\"\\u5220\\u9664\\u65E7\\u4E16\\u754C\\u4E66\",onAttempt:(G,be)=>{let de=G>1?`\\uFF08\\u5C1D\\u8BD5 ${G}/${be}\\uFF09`:\"\";N.update(`\\u6B63\\u5728\\u5220\\u9664\\u65E7\\u4E16\\u754C\\u4E66...${de}`)}}),re.length=0,N.update(\"\\u6B63\\u5728\\u5237\\u65B0\\u6570\\u636E...\");let ge=o.chatLorebook;await We(!0),ge&&o.chatLorebook!==ge&&(console.log(`[RegexLoreHub] Restoring chat lorebook state after data refresh: \"${ge}\"`),o.chatLorebook=ge);let _e=o.allLorebooks.map(G=>G.name);if(_e.includes(S)||console.warn(`[RegexLoreHub] \\u9A8C\\u8BC1\\u5931\\u8D25\\uFF1A\\u5237\\u65B0\\u540E\\u672A\\u627E\\u5230\\u65B0\\u4E16\\u754C\\u4E66 \"${S}\"\\u3002`),_e.includes(D)&&console.warn(`[RegexLoreHub] \\u9A8C\\u8BC1\\u5931\\u8D25\\uFF1A\\u5237\\u65B0\\u540E\\u65E7\\u4E16\\u754C\\u4E66 \"${D}\" \\u4ECD\\u7136\\u5B58\\u5728\\u3002`),F){let G=await Y.getGlobalWorldbookNames();(!Array.isArray(G)||!G.includes(S))&&console.warn(`[RegexLoreHub] \\u9A8C\\u8BC1\\u5931\\u8D25\\uFF1A\\u5168\\u5C40\\u4E16\\u754C\\u4E66\\u672A\\u5305\\u542B \"${S}\"\\u3002`,G),Array.isArray(G)&&G.includes(D)&&console.warn(`[RegexLoreHub] \\u9A8C\\u8BC1\\u5931\\u8D25\\uFF1A\\u5168\\u5C40\\u4E16\\u754C\\u4E66\\u4ECD\\u5305\\u542B \"${D}\"\\u3002`,G)}if(Q)try{let G=await Y.getChatWorldbookName();G!==S&&(console.warn(`[RegexLoreHub] \\u9A8C\\u8BC1\\u5931\\u8D25\\uFF1A\\u804A\\u5929\\u4E16\\u754C\\u4E66\\u672A\\u66F4\\u65B0\\u4E3A \"${S}\"\\uFF0C\\u5F53\\u524D\\u503C \"${G??\"\\u672A\\u7ED1\\u5B9A\"}\"\\u3002`),o.chatLorebook=G)}catch(G){console.warn(\"[RegexLoreHub] \\u9A8C\\u8BC1\\u804A\\u5929\\u4E16\\u754C\\u4E66\\u72B6\\u6001\\u5931\\u8D25:\",G)}N.remove(),ve(\"\\u4E16\\u754C\\u4E66\\u91CD\\u547D\\u540D\\u6210\\u529F\"),C?await n(S):se()}catch(B){N.remove(),console.error(\"[RegexLoreHub] Rename failed:\",B),re.length>0?(await u(),await M(B?.message??\"\\u91CD\\u547D\\u540D\\u8FC7\\u7A0B\\u4E2D\\u53D1\\u751F\\u9519\\u8BEF\\u3002\")):await J({type:\"alert\",title:\"\\u91CD\\u547D\\u540D\\u5931\\u8D25\",text:`\\u64CD\\u4F5C\\u5931\\u8D25: ${B?.message??\"\\u672A\\u77E5\\u9519\\u8BEF\"}`}),await We(!0),R&&o.chatLorebook!==R&&(console.log(`[RegexLoreHub] Restoring chat lorebook state after error recovery: \"${R}\"`),o.chatLorebook=R);try{let j=a.SillyTavern.getContext()||{};if(j.chatId!==void 0&&j.chatId!==null){let ie=await Y.getChatWorldbookName();ie!==o.chatLorebook&&(console.log(`[RegexLoreHub] Final chat lorebook sync after error recovery: \"${ie}\"`),o.chatLorebook=ie)}}catch(j){console.warn(\"[RegexLoreHub] Failed to sync chat lorebook state after error recovery:\",j)}}}),b=A(async(s,g=\"\")=>{let x;try{x=await J({type:\"prompt\",title:\"\\u65B0\\u5EFA\\u4E16\\u754C\\u4E66\",text:\"\\u8BF7\\u8F93\\u5165\\u65B0\\u4E16\\u754C\\u4E66\\u7684\\u540D\\u79F0:\",value:g})}catch{return}if(x=x.trim(),!x)return;if(o.allLorebooks.some(D=>D.name===x))return await J({type:\"alert\",title:\"\\u9519\\u8BEF\",text:\"\\u5DF2\\u5B58\\u5728\\u540C\\u540D\\u4E16\\u754C\\u4E66\\u3002\"}),b(s,x);let C=s?r(s.currentTarget):null;C&&C.prop(\"disabled\",!0).addClass(\"rlh-loading\");try{await Y.createWorldbook(x)?(o.allLorebooks.push({name:x,enabled:!1,entryCount:0,enabledEntryCount:0,entriesLoaded:!0}),await n(x)):await J({type:\"alert\",title:\"\\u521B\\u5EFA\\u5931\\u8D25\",text:\"\\u521B\\u5EFA\\u4E16\\u754C\\u4E66\\u65F6\\u53D1\\u751F\\u9519\\u8BEF\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"})}finally{C&&C.prop(\"disabled\",!1).removeClass(\"rlh-loading\")}}),p=A(async s=>{s.stopPropagation();let x=r(s.currentTarget).closest(\".rlh-book-group, .rlh-detail-view\"),C=x.data(\"book-name\")||o.activeBookName;if(!C)return;let D=x.hasClass(\"rlh-detail-view\");try{await J({type:\"confirm\",title:\"\\u786E\\u8BA4\\u5220\\u9664\",text:`\\u60A8\\u786E\\u5B9A\\u8981\\u6C38\\u4E45\\u5220\\u9664\\u4E16\\u754C\\u4E66 \"${C}\" \\u5417\\uFF1F\\u6B64\\u64CD\\u4F5C\\u65E0\\u6CD5\\u64A4\\u9500\\u3002`})}catch{return}await Y.deleteWorldbook(C)?(o.allLorebooks=o.allLorebooks.filter(K=>K.name!==C),Vr(C),o.lorebookUsage instanceof Map&&o.lorebookUsage.has(C)&&o.lorebookUsage.delete(C),Array.isArray(o.lorebooks?.character)&&(o.lorebooks.character=o.lorebooks.character.filter(K=>K!==C)),o.chatLorebook===C&&(o.chatLorebook=null),o.activeCharacterBook===C&&(o.activeCharacterBook=null),o.activeBookName===C&&(o.activeBookName=null),D?await i():se(),ve(\"\\u5220\\u9664\\u6210\\u529F\")):await J({type:\"alert\",title:\"\\u5220\\u9664\\u5931\\u8D25\",text:\"\\u5220\\u9664\\u4E16\\u754C\\u4E66\\u65F6\\u53D1\\u751F\\u9519\\u8BEF\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"})}),f=A(async s=>{let x=(r(s.currentTarget).data(\"book-name\")??\"\").toString().trim(),C=Ae(),S=[x,C?.activeBookName??\"\",o.activeBookName??\"\",o.activeCharacterBook??\"\",o.chatLorebook??\"\"].find(q=>typeof q==\"string\"&&q.trim().length>0)?.trim()??\"\";if(!S){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u6216\\u6253\\u5F00\\u4E00\\u4E2A\\u4E16\\u754C\\u4E66\\u3002\"});return}let K=[...ne(S)];if((!K||K.length===0)&&(await Ie(S),K=[...ne(S)]),!K||K.length===0){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BE5\\u4E16\\u754C\\u4E66\\u6CA1\\u6709\\u6761\\u76EE\\u53EF\\u64CD\\u4F5C\\u3002\"});return}try{await J({type:\"confirm\",title:\"\\u786E\\u8BA4\\u64CD\\u4F5C\",text:`\\u786E\\u5B9A\\u8981\\u4E3A \"${S}\" \\u4E2D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u5F00\\u542F\\u201C\\u9632\\u6B62\\u9012\\u5F52\\u201D\\u548C\\u201C\\u4E0D\\u53EF\\u88AB\\u9012\\u5F52\\u201D\\u5417\\uFF1F\\u6B64\\u64CD\\u4F5C\\u4F1A\\u963B\\u6B62\\u4E16\\u754C\\u4E66\\u6761\\u76EE\\u5F7C\\u6B64\\u89E6\\u53D1\\u3002`})}catch{return}let ce=K.map(q=>({uid:q.uid,prevent_recursion:!0,exclude_recursion:!0}));await je(S,ce),K.forEach(q=>{q.prevent_recursion=!0,q.exclude_recursion=!0,(!q.recursion||typeof q.recursion!=\"object\")&&(q.recursion={}),q.recursion.prevent_outgoing=!0,q.recursion.prevent_incoming=!0}),ce.forEach(q=>{let Z=r(`#rlh-panel-content .rlh-item-container[data-book-name=\"${S}\"][data-id=\"${q.uid}\"] .rlh-collapsible-content:visible`,t);Z.length&&(Z.find(\".rlh-edit-prevent-recursion\").prop(\"checked\",!0),Z.find(\".rlh-edit-exclude-recursion\").prop(\"checked\",!0))}),ve(\"\\u5DF2\\u4E3A\\u6240\\u6709\\u6761\\u76EE\\u5F00\\u542F\\u201C\\u9632\\u6B62\\u9012\\u5F52\\u201D\\u548C\\u201C\\u4E0D\\u53EF\\u88AB\\u9012\\u5F52\\u201D\"),await l(S)}),v=A(async s=>{let x=(r(s.currentTarget).data(\"book-name\")??\"\").toString().trim(),C=Ae(),S=[x,C?.activeBookName??\"\",o.activeBookName??\"\",o.activeCharacterBook??\"\",o.chatLorebook??\"\"].find(Z=>typeof Z==\"string\"&&Z.trim().length>0)?.trim()??\"\";if(!S){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u6216\\u6253\\u5F00\\u4E00\\u4E2A\\u4E16\\u754C\\u4E66\\u3002\"});return}let K=[...ne(S)];if((!K||K.length===0)&&(await Ie(S),K=[...ne(S)]),!K||K.length===0){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BE5\\u4E16\\u754C\\u4E66\\u6CA1\\u6709\\u6761\\u76EE\\u53EF\\u64CD\\u4F5C\\u3002\"});return}try{await J({type:\"confirm\",title:\"\\u786E\\u8BA4\\u64CD\\u4F5C\",text:`\\u786E\\u5B9A\\u8981\\u4E3A \"${S}\" \\u4E2D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u4FEE\\u590D\\u5173\\u952E\\u8BCD\\uFF08\\u5C06\\u4E2D\\u6587\\u9017\\u53F7\\u66FF\\u6362\\u4E3A\\u82F1\\u6587\\u9017\\u53F7\\uFF09\\u5417\\uFF1F`})}catch{return}let ce=0,q=K.map(Z=>{let W=(Z.keys||[]).join(\", \"),ue=W.replace(/，/g,\",\").replace(/,+/g,\",\").trim().split(\",\").map(pe=>pe.trim()).filter(Boolean),re=ue.join(\", \");return W!==re?(ce++,{uid:Z.uid,keys:ue}):null}).filter(Boolean);q.length>0?(await je(S,q),q.forEach(Z=>{let W=K.find(oe=>oe.uid===Z.uid);W&&(W.keys=Z.keys)}),q.forEach(Z=>{let W=r(`#rlh-panel-content .rlh-item-container[data-book-name=\"${S}\"][data-id=\"${Z.uid}\"] .rlh-collapsible-content:visible`,t);W.length&&W.find(\".rlh-edit-keys\").val(Z.keys.join(\", \"))}),ve(`\\u6210\\u529F\\u4FEE\\u590D\\u4E86 ${ce} \\u4E2A\\u6761\\u76EE\\u7684\\u5173\\u952E\\u8BCD`),await l(S)):await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u6240\\u6709\\u6761\\u76EE\\u7684\\u5173\\u952E\\u8BCD\\u683C\\u5F0F\\u90FD\\u6B63\\u786E\\uFF0C\\u65E0\\u9700\\u4FEE\\u590D\\u3002\"})}),w=A(async({bookName:s,positionValue:g})=>{let x=(g??\"\").toString().trim();if(!x)return;let C=Ae(),S=[s,C?.activeBookName??\"\",o.activeBookName??\"\",o.activeCharacterBook??\"\",o.chatLorebook??\"\"].find(le=>typeof le==\"string\"&&le.trim().length>0)?.trim()??\"\";if(!S){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u6216\\u6253\\u5F00\\u4E00\\u4E2A\\u4E16\\u754C\\u4E66\\u3002\"});return}let K=[...ne(S)];if(K.length||(await Ie(S),K=[...ne(S)]),!K.length){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BE5\\u4E16\\u754C\\u4E66\\u6CA1\\u6709\\u6761\\u76EE\\u53EF\\u64CD\\u4F5C\\u3002\"});return}let ce=o.multiSelectMode&&o.multiSelectTarget===\"entry\",q=K;if(ce){let le=gr(S),u=new Set;if(o.selectedItems.forEach(_=>{if(typeof _!=\"string\"||!_.startsWith(le))return;let M=_.slice(le.length),L=ze(M),N=Number(L);Number.isFinite(N)&&u.add(N)}),u.size===0){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u5DF2\\u5F00\\u542F\\u591A\\u9009\\uFF0C\\u8BF7\\u5148\\u52FE\\u9009\\u8981\\u7EDF\\u4E00\\u4F4D\\u7F6E\\u7684\\u6761\\u76EE\\u3002\"});return}if(q=K.filter(_=>u.has(Number(_?.uid))),!q.length){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u672A\\u80FD\\u5339\\u914D\\u5230\\u5DF2\\u9009\\u62E9\\u7684\\u6761\\u76EE\\uFF0C\\u8BF7\\u91CD\\u65B0\\u9009\\u62E9\\u540E\\u518D\\u8BD5\\u3002\"});return}}let Z=Xe.position?.[x]??x,W=q.filter(le=>(le?.position??\"\").toString()!==x).map(le=>({uid:le.uid,position:x}));if(!W.length){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:`${ce?\"\\u6240\\u9009\\u6761\\u76EE\":\"\\u6240\\u6709\\u6761\\u76EE\"}\\u7684\\u4F4D\\u7F6E\\u5DF2\\u7ECF\\u662F\\u300C${Z}\\u300D\\u3002`});return}try{let le=q.length,u=ce?\"\\u9009\\u4E2D\\u7684\\u6761\\u76EE\":`\"${S}\" \\u4E2D\\u7684\\u6761\\u76EE`;await J({type:\"confirm\",title:\"\\u786E\\u8BA4\\u64CD\\u4F5C\",text:`\\u786E\\u5B9A\\u8981\\u5C06 ${u}\\uFF08\\u5171 ${le} \\u4E2A\\uFF09\\u8BBE\\u7F6E\\u4E3A\\u300C${Z}\\u300D\\u5417\\uFF1F`})}catch{return}await je(S,W);let oe=ne(S),ue=new Set(oe.map(le=>(le?.position??\"before_character_definition\").toString())),re=ue.size===1?ue.values().next().value:null;W.forEach(le=>{let u=`#rlh-panel-content .rlh-item-container[data-book-name=\"${S}\"][data-id=\"${le.uid}\"]`,_=r(u,t);if(_.length){let M=_.find(\".rlh-edit-position\");M.length&&M.val(x).trigger(\"change\")}});let pe=r(`#${or}`,t);if(pe.length){pe.attr(\"data-book-name\",S);let le=r(`#${Qe}`,t);le.length&&(le.removeAttr(\"disabled\"),le.attr(\"data-book-name\",S)),pe.find(\".rlh-position-option\").each(function(){let _=r(this),M=(_.data(\"position-value\")??\"\").toString(),L=re&&M===re;_.toggleClass(\"active\",L),_.attr(\"aria-selected\",L?\"true\":\"false\"),_.attr(\"data-book-name\",S)})}ve(`\\u5DF2\\u66F4\\u65B0 ${W.length} \\u4E2A\\u6761\\u76EE\\u7684\\u4F4D\\u7F6E\\u4E3A\\u300C${Z}\\u300D`),await l(S)}),T=A(async()=>{let s=await Y.getOrCreateChatWorldbook();s?(ve(`\\u5DF2\\u521B\\u5EFA\\u5E76\\u7ED1\\u5B9A\\u804A\\u5929\\u4E16\\u754C\\u4E66: ${s}`),await We(!0)):await J({type:\"alert\",title:\"\\u64CD\\u4F5C\\u5931\\u8D25\",text:\"\\u65E0\\u6CD5\\u521B\\u5EFA\\u6216\\u7ED1\\u5B9A\\u804A\\u5929\\u4E16\\u754C\\u4E66\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"})}),k=A(async()=>{let s=o.chatLorebook;if(s){try{await J({type:\"confirm\",title:\"\\u786E\\u8BA4\\u89E3\\u9664\\u7ED1\\u5B9A\",text:`\\u60A8\\u786E\\u5B9A\\u8981\\u89E3\\u9664\\u4E0E\\u804A\\u5929\\u4E16\\u754C\\u4E66 \"${s}\" \\u7684\\u7ED1\\u5B9A\\u5417\\uFF1F\\u4E16\\u754C\\u4E66\\u672C\\u8EAB\\u4E0D\\u4F1A\\u88AB\\u5220\\u9664\\u3002`})}catch{return}await Y.rebindChatWorldbook(null),o.chatLorebook=null,ve(\"\\u5DF2\\u89E3\\u9664\\u7ED1\\u5B9A\"),se()}}),I=A(async()=>{let s=o.activeBookName;s&&(o.loadingBookName=s,se(),await Ie(s,!0),o.loadingBookName=null,se())});return{handleEnterLorebookDetail:n,handleExitLorebookDetail:i,handleRefreshLorebookDetail:I,handleCreateLorebook:b,handleDeleteLorebook:p,handleRenameBook:m,handleBatchSetRecursion:f,handleFixKeywords:v,applyUnifiedPosition:w,handleCreateChatLorebook:T,handleUnlinkChatLorebook:k}}function nl(e={}){let r=e.$??xe(),t=e.parentDoc??we(),a=u=>{let _=String(u),M=o.regexes.global.find(L=>String(L.id)===_);return M||(o.regexes.character.find(L=>String(L.id)===_)??null)},l=(u,_,M)=>{if(!u||!_)return;let L=M;if(typeof L!=\"boolean\"&&(L=L??\"\"),_===\"min_depth\"||_===\"max_depth\"){let H=parseInt(L,10);L=Number.isNaN(H)?null:H}let N=_.split(\".\");if(N.length===1){u[N[0]]=L;return}let R=u;for(let H=0;H<N.length-1;H++){let F=N[H];(!R[F]||typeof R[F]!=\"object\")&&(R[F]={}),R=R[F]}R[N[N.length-1]]=L},n=Dt(()=>pr({silent:!0}),1e3),i=A(async u=>{let _=r(u.currentTarget),M=_.closest(\".rlh-item-container\"),L=M.data(\"type\"),N=M.data(\"id\"),R=Number(N),H=_.data(\"field\");if(H){if(L===\"lore\"){let F=M.data(\"book-name\"),B=ne(F).find(ie=>{let ae=ie?.uid;return typeof ae==\"number\"&&!Number.isNaN(R)?ae===R:String(ae)===String(N)});if(!B)return;let j;if(_.is(\":checkbox\"))j=_.is(\":checked\");else if(_.is('[contenteditable=\"true\"]')){let ie=_.get(0);if(ie){let ae=new Set([\"div\",\"p\",\"li\",\"ul\",\"ol\",\"blockquote\",\"pre\",\"h1\",\"h2\",\"h3\",\"h4\",\"h5\",\"h6\",\"table\",\"tr\"]),ge=[],_e=de=>{de&&ge.push(de)},G=()=>{if(!ge.length){ge.push(`\n`);return}ge[ge.length-1]?.endsWith(`\n`)||ge.push(`\n`)},be=de=>{if(!de)return;let Ge=de.nodeType;if(Ge===Node.TEXT_NODE){_e(de.nodeValue||\"\");return}if(Ge!==Node.ELEMENT_NODE)return;let Le=de.nodeName.toLowerCase();if(Le===\"br\"){ge.push(`\n`);return}Le===\"style\"||Le===\"script\"||(de.childNodes.forEach(Ke=>be(Ke)),ae.has(Le)&&G())};be(ie),j=ge.join(\"\"),j=j.replace(/\\u00a0/g,\" \"),j=j.replace(/\\r?\\n/g,`\n`)}else j=\"\"}else j=_.val();if(H===\"statusId\"){let ie=qe(j)??Re;B.statusId=ie.id,(!B.strategy||typeof B.strategy!=\"object\")&&(B.strategy={}),B.strategy.type=ie.strategyType,B.type=ie.strategyType,qt(F,B.uid??N,{statusId:ie.id,strategy:{...B.strategy??{},type:ie.strategyType},type:ie.strategyType}),bt(F,B.uid??N,ie.id),n();return}if(H===\"keys\")B.keys=j.split(\",\").map(ie=>ie.trim()).filter(Boolean);else if([\"depth\",\"order\",\"probability\"].includes(H)){let ie=parseInt(j,10);B[H]=isNaN(ie)?_.attr(\"placeholder\")===\"\\u4F8B\\u5982: 0\"?null:100:ie}else B[H]=j;let te=Array.isArray(B[H])?[...B[H]]:B[H];qt(F,B.uid??N,{[H]:te})}else if(L===\"regex\"){let F=a(N);if(!F)return;let Q;_.is(\":checkbox\")?Q=_.is(\":checked\"):Q=_.val(),l(F,H,Q),Xo(F.id)}n()}}),h=u=>{let _=Object.entries(Xe.position).map(([Q,B])=>`<option value=\"${Q}\" ${u.position===Q?\"selected\":\"\"}>${B}</option>`).join(\"\"),M=Object.entries(Xe.logic).map(([Q,B])=>`<option value=\"${Q}\" ${u.logic===Q?\"selected\":\"\"}>${B}</option>`).join(\"\"),L=Array.isArray(u.keys)?u.keys.join(\", \"):\"\",N=u.content||\"\",R=u.statusId??Re.id;u.statusId=R;let H=qe(R)??Re;return(!u.strategy||typeof u.strategy!=\"object\")&&(u.strategy={}),u.strategy.type=H.strategyType,u.type=H.strategyType,`\n      <div class=\"rlh-editor-wrapper\" data-mode=\"edit\">\n        <div class=\"rlh-editor-group\"><h5>\\u72B6\\u6001</h5>\n          <div class=\"rlh-editor-grid\">\n            <div class=\"rlh-grid-item\"><label>\\u6FC0\\u6D3B\\u72B6\\u6001</label><select class=\"rlh-edit-status rlh-select-nudge\" data-field=\"statusId\">${nt.map(Q=>{let B=R===Q.id?\"selected\":\"\";return`<option value=\"${Q.id}\" ${B}>${Q.label}</option>`}).join(\"\")}</select></div>\n          </div>\n        </div>\n        <div class=\"rlh-editor-field\">\n          <label>\\u5173\\u952E\\u8BCD (\\u9017\\u53F7\\u5206\\u9694)</label>\n          <input type=\"text\" class=\"rlh-edit-keys\" data-field=\"keys\" value=\"${O(L)}\">\n        </div>\n        <div class=\"rlh-editor-field\">\n          <label>\\u5185\\u5BB9</label>\n          <div class=\"rlh-edit-content\" data-field=\"content\" contenteditable=\"true\">${O(N)}</div>\n        </div>\n        <div class=\"rlh-editor-group\"><h5>\\u63D2\\u5165\\u89C4\\u5219</h5>\n          <div class=\"rlh-editor-grid\">\n            <div class=\"rlh-grid-item\"><label>\\u4F4D\\u7F6E</label><select class=\"rlh-edit-position rlh-select-nudge\" data-field=\"position\">${_}</select></div>\n            <div class=\"rlh-grid-item rlh-depth-container\"><label>\\u6DF1\\u5EA6</label><input type=\"number\" class=\"rlh-edit-depth\" data-field=\"depth\" placeholder=\"\\u4F8B\\u5982: 0\" value=\"${u.depth??\"\"}\"></div>\n            <div class=\"rlh-grid-item\"><label>\\u987A\\u5E8F</label><input type=\"number\" class=\"rlh-edit-order\" data-field=\"order\" placeholder=\"\\u4F8B\\u5982: 100\" value=\"${u.order??\"\"}\"></div>\n          </div>\n        </div>\n        <div class=\"rlh-editor-group\"><h5>\\u6FC0\\u6D3B\\u903B\\u8F91</h5>\n          <div class=\"rlh-editor-grid\">\n            <div class=\"rlh-grid-item\"><label>\\u6982\\u7387 (%)</label><input type=\"number\" class=\"rlh-edit-probability\" data-field=\"probability\" min=\"0\" max=\"100\" placeholder=\"100\" value=\"${u.probability??\"\"}\"></div>\n            <div class=\"rlh-grid-item\"><label>\\u5173\\u952E\\u8BCD\\u903B\\u8F91</label><select class=\"rlh-edit-logic rlh-select-nudge\" data-field=\"logic\">${M}</select></div>\n          </div>\n        </div>\n        <div class=\"rlh-editor-group\"><h5>\\u5339\\u914D\\u4E0E\\u9012\\u5F52</h5>\n          <div class=\"rlh-editor-options-row\">\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-case-sensitive\" data-field=\"case_sensitive\" ${u.case_sensitive?\"checked\":\"\"}> \\u5927\\u5C0F\\u5199\\u654F\\u611F</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-match-whole\" data-field=\"match_whole_words\" ${u.match_whole_words?\"checked\":\"\"}> \\u5168\\u8BCD\\u5339\\u914D</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-prevent-recursion\" data-field=\"prevent_recursion\" ${u.prevent_recursion?\"checked\":\"\"}> \\u9632\\u6B62\\u9012\\u5F52</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-exclude-recursion\" data-field=\"exclude_recursion\" ${u.exclude_recursion?\"checked\":\"\"}> \\u4E0D\\u53EF\\u88AB\\u9012\\u5F52</label>\n          </div>\n        </div>\n      </div>\n    `},m=u=>{let _=u?.destination??{},M=u?.source??{},L=O(u?.find_regex??\"\"),N=O(u?.replace_string??\"\"),R=O(String(u?.min_depth??\"\")),H=O(String(u?.max_depth??\"\"));return`\n      <div class=\"rlh-editor-wrapper\" data-mode=\"edit\">\n        <div class=\"rlh-editor-field\">\n          <label>\\u67E5\\u627E\\u6B63\\u5219\\u8868\\u8FBE\\u5F0F</label>\n          <textarea class=\"rlh-edit-find\" data-field=\"find_regex\">${L}</textarea>\n        </div>\n        <div class=\"rlh-editor-field\">\n          <label>\\u66FF\\u6362\\u4E3A</label>\n          <textarea class=\"rlh-edit-replace\" data-field=\"replace_string\">${N}</textarea>\n        </div>\n        <div class=\"rlh-editor-group\">\n          <h5>\\u77ED\\u6682</h5>\n          <div class=\"rlh-editor-options-row\">\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-dest-display\" data-field=\"destination.display\" ${_.display?\"checked\":\"\"}> \\u4EC5\\u683C\\u5F0F\\u663E\\u793A</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-dest-prompt\" data-field=\"destination.prompt\" ${_.prompt?\"checked\":\"\"}> \\u4EC5\\u683C\\u5F0F\\u63D0\\u793A\\u8BCD</label>\n          </div>\n        </div>\n        <div class=\"rlh-editor-group\">\n          <h5>\\u4F5C\\u7528\\u8303\\u56F4</h5>\n          <div class=\"rlh-editor-options-row\">\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-user\" data-field=\"source.user_input\" ${M.user_input?\"checked\":\"\"}> \\u7528\\u6237\\u8F93\\u5165</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-ai\" data-field=\"source.ai_output\" ${M.ai_output?\"checked\":\"\"}> AI\\u8F93\\u51FA</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-slash\" data-field=\"source.slash_command\" ${M.slash_command?\"checked\":\"\"}> \\u659C\\u6760\\u547D\\u4EE4</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-world\" data-field=\"source.world_info\" ${M.world_info?\"checked\":\"\"}> \\u4E16\\u754C\\u4E66</label>\n          </div>\n        </div>\n        <div class=\"rlh-editor-group\">\n          <h5>\\u6DF1\\u5EA6</h5>\n          <div class=\"rlh-depth-inputs\">\n            <input type=\"number\" class=\"rlh-edit-depth-min\" data-field=\"min_depth\" placeholder=\"\\u6700\\u5C0F\\u6DF1\\u5EA6\" value=\"${R}\">\n            <input type=\"number\" class=\"rlh-edit-depth-max\" data-field=\"max_depth\" placeholder=\"\\u6700\\u5927\\u6DF1\\u5EA6\" value=\"${H}\">\n          </div>\n        </div>\n      </div>\n    `},b=(u,_)=>{let M=u.find(\".rlh-rename-btn\").first();if(!M.length)return;let L=M.find(\"i\").first();_===\"edit\"?(M.attr(\"title\",\"\\u9000\\u51FA\\u7F16\\u8F91\\u6A21\\u5F0F\"),M.attr(\"data-rename-mode\",\"exit\"),L.length&&L.removeClass(\"fa-pencil\").addClass(\"fa-eye\")):(M.attr(\"title\",\"\\u91CD\\u547D\\u540D\\u5E76\\u7F16\\u8F91\"),M.attr(\"data-rename-mode\",\"rename\"),L.length&&L.removeClass(\"fa-eye\").addClass(\"fa-pencil\"))},p=u=>{u.on(\"input.rlh change.rlh\",'input, textarea, select, [contenteditable=\"true\"]',i),u.find(\".rlh-edit-position\").trigger(\"change\")},f=(u,_,M,{animate:L=!0,searchTerm:N}={})=>{let R=_.find(\".rlh-collapsible-content\").first();if(!R.length)return;let H=u===\"view\",F=typeof N==\"string\"?N:_.data(\"searchTerm\")||\"\",Q=H?pt(M,F):h(M);H&&(_.data(\"searchTerm\",F),_.attr(\"data-search-term\",F)),R.stop(!0,!0),R.off(\"input.rlh change.rlh\"),R.html(Q),_.attr(\"data-entry-mode\",u),R.attr(\"data-entry-mode\",u),_.toggleClass(\"rlh-editing\",!H),b(_,u);let B=_.find(\".rlh-item-name\").first();B.length&&(H?B.show().removeAttr(\"aria-hidden\"):B.hide().attr(\"aria-hidden\",\"true\"));let j=()=>{H||p(R)},te=ie=>{let ae=R[0];if(!ae){ie();return}let ge=280,_e=Le=>Le<.5?2*Le*Le:-1+(4-2*Le)*Le;ae.style.display=\"block\",ae.style.overflow=\"hidden\";let G=0,be=ae.scrollHeight;ae.style.height=`${G}px`,ae.style.opacity=\"0\";let de=null,Ge=Le=>{de||(de=Le);let Ke=Math.min((Le-de)/ge,1),br=_e(Ke),kt=G+(be-G)*br;ae.style.height=`${kt}px`,ae.style.opacity=String(.6+.4*br),Ke<1?requestAnimationFrame(Ge):(ae.style.height=\"\",ae.style.opacity=\"\",ae.style.overflow=\"\",ie())};requestAnimationFrame(Ge)};R.is(\":visible\")?j():L?te(j):(R.show(),j())},v=(u,_,M,L={})=>{f(\"view\",u,_,{...L,searchTerm:M})},w=(u,_,M={})=>{f(\"edit\",u,_,M)},T=(u,_,M,{animate:L=!0}={})=>{let N=u.find(\".rlh-collapsible-content\").first();if(!N.length)return;let R=typeof M==\"string\"?M:\"\";u.data(\"searchTerm\",R),u.attr(\"data-search-term\",R);let H=Ht(_,R);N.stop(!0,!0),N.off(\"input.rlh change.rlh\"),N.html(H),u.attr(\"data-entry-mode\",\"view\"),N.attr(\"data-entry-mode\",\"view\"),u.removeClass(\"rlh-editing\"),b(u,\"view\");let F=u.find(\".rlh-item-name\").first();F.length&&F.show().removeAttr(\"aria-hidden\"),N.is(\":visible\")||(L?N.slideDown(200):N.show())},k=(u,_,{animate:M=!0}={})=>{let L=u.find(\".rlh-collapsible-content\").first();if(!L.length)return;let N=m(_);L.stop(!0,!0),L.off(\"input.rlh change.rlh\");let R=()=>{L.on(\"input.rlh change.rlh\",'input, textarea, select, [contenteditable=\"true\"]',i)};L.html(N),u.attr(\"data-entry-mode\",\"edit\"),L.attr(\"data-entry-mode\",\"edit\"),u.addClass(\"rlh-editing\"),b(u,\"edit\");let H=u.find(\".rlh-item-name\").first();H.length&&H.hide().attr(\"aria-hidden\",\"true\"),L.is(\":visible\")?R():M?L.slideDown(200,R):(L.show(),R())},I=(u,_={})=>{let{animate:M=!1,silent:L=!1}=_;if(!u.length)return!1;if(o.multiSelectMode)return L||ve(\"\\u8BF7\\u5148\\u9000\\u51FA\\u591A\\u9009\\u6A21\\u5F0F\\u540E\\u518D\\u7F16\\u8F91\\u3002\",\"info\"),!1;let N=u.data(\"book-name\"),R=Number(u.data(\"id\"));if(!N||Number.isNaN(R))return!1;let H=ne(N).find(F=>F.uid===R);return H?(w(u,H,{animate:M}),!0):!1},s=(u,_={})=>{let{animate:M=!1}=_;if(!u.length)return!1;let L=u.data(\"book-name\"),N=Number(u.data(\"id\"));if(!L||Number.isNaN(N))return!1;let R=ne(L).find(F=>F.uid===N);if(!R)return!1;let H=u.data(\"searchTerm\")||\"\";return v(u,R,H,{animate:M}),!0},g=(u,_={})=>{let{animate:M=!1,silent:L=!1}=_;if(!u.length)return!1;if(o.multiSelectMode)return L||ve(\"\\u8BF7\\u5148\\u9000\\u51FA\\u591A\\u9009\\u6A21\\u5F0F\\u540E\\u518D\\u7F16\\u8F91\\u3002\",\"info\"),!1;let N=u.data(\"id\"),R=a(N);return R?(k(u,R,{animate:M}),!0):!1},x=(u,_={})=>{let{animate:M=!1}=_;if(!u.length)return!1;let L=u.data(\"id\"),N=a(L);if(!N)return!1;let R=u.data(\"searchTerm\")||\"\";return T(u,N,R,{animate:M}),!0},C=A(async u=>{u.preventDefault(),u.stopPropagation();let _=r(u.currentTarget).closest(\".rlh-item-container\");I(_,{animate:!1})}),D=A(async u=>{u.preventDefault(),u.stopPropagation();let _=r(u.currentTarget).closest(\".rlh-item-container\");s(_,{animate:!1})}),S=A(async u=>{u.preventDefault(),u.stopPropagation();let _=r(u.currentTarget).closest(\".rlh-item-container\");g(_,{animate:!1})}),K=A(async u=>{u.preventDefault(),u.stopPropagation();let _=r(u.currentTarget).closest(\".rlh-item-container\");x(_,{animate:!1})}),ce=A(async u=>{u.stopPropagation();let _=r(u.currentTarget),M=_.closest(\".rlh-book-group, .rlh-item-container\");if(M.hasClass(\"renaming\"))return;let L=!M.hasClass(\"enabled\"),N=M.parent();if(_.hasClass(\"rlh-global-toggle\")){_.addClass(\"rlh-loading\");try{let H=M.data(\"book-name\"),F=new Set(await Y.getGlobalWorldbookNames()||[]);L?F.add(H):F.delete(H),await Y.rebindGlobalWorldbooks(Array.from(F)),await Y.saveSettings();let Q=o.allLorebooks.find(B=>B.name===H);Q&&(Q.enabled=L)}finally{_.removeClass(\"rlh-loading\")}}else{let H=M.data(\"type\"),F=M.data(\"id\");if(H===\"lore\"){let Q=M.data(\"book-name\");await je(Q,[{uid:Number(F),enabled:L}]);let B=ne(Q).find(j=>j.uid===Number(F));B&&(B.enabled=L)}else{let Q=await Y.getRegexes(),B=Q.find(j=>j.id===F);if(B){B.enabled=L,await Y.replaceRegexes(Q.filter(te=>te.source!==\"card\")),await Y.saveSettings();let j=o.regexes.global.find(te=>te.id===F)||o.regexes.character.find(te=>te.id===F);j&&(j.enabled=L)}}}ve(L?\"\\u5DF2\\u542F\\u7528\":\"\\u5DF2\\u7981\\u7528\"),M.toggleClass(\"enabled\",L);let R=N.children().get();R.sort((H,F)=>{let Q=r(H).hasClass(\"enabled\"),B=r(F).hasClass(\"enabled\");if(Q!==B)return B-Q;let j=r(H).find(\".rlh-item-name\").text().trim(),te=r(F).find(\".rlh-item-name\").text().trim();return j.localeCompare(te)}),N.append(R)}),q=A(async u=>{u.stopPropagation();let M=r(u.currentTarget).closest(\".rlh-item-container\");if(!M.length)return;let L=M.data(\"type\");if(M.attr(\"data-entry-mode\")===\"edit\"){Z(M),L===\"lore\"?s(M,{animate:!1}):x(M,{animate:!1});return}if(o.multiSelectMode){ve(\"\\u8BF7\\u5148\\u9000\\u51FA\\u591A\\u9009\\u6A21\\u5F0F\\u540E\\u518D\\u7F16\\u8F91\\u3002\",\"info\");return}let R=M.find(\".rlh-item-header\").first(),F=R.find(\".rlh-item-name\").first().clone().children().remove().end().text().trim(),Q=`<div class=\"rlh-rename-ui\"><div class=\"rlh-rename-input-wrapper\"><input type=\"text\" class=\"rlh-rename-input\" value=\"${O(F)}\" /><button class=\"rlh-action-btn-icon rlh-rename-save-btn\" title=\"\\u786E\\u8BA4\"><i class=\"fa-solid fa-check\"></i></button></div></div>`,B=!1;L===\"lore\"?B=I(M,{animate:!1,silent:!0}):B=g(M,{animate:!1,silent:!0}),B&&(R.find(\".rlh-rename-ui\").length||(M.addClass(\"renaming\"),R.append(Q)),R.find(\".rlh-rename-input\").focus().select())}),Z=(u,_=null)=>{let M=u.find(\".rlh-item-header\").first(),L=M.find(\".rlh-item-name\").first();_&&L.text(_),M.find(\".rlh-rename-ui\").remove(),L.length&&u.attr(\"data-entry-mode\")!==\"edit\"&&L.show().removeAttr(\"aria-hidden\"),u.removeClass(\"renaming\")},W=A(async u=>{u.stopPropagation();let _=r(u.currentTarget).closest(\".rlh-item-container\"),M=_.data(\"type\"),L=()=>{M===\"lore\"?s(_,{animate:!1}):x(_,{animate:!1})},R=_.find(\".rlh-rename-input\").val().trim(),H=_.find(\".rlh-item-name\").first().text().trim();if(!R||R===H){Z(_,H),L();return}let F=_.data(\"id\");if(M===\"lore\"){let Q=_.data(\"book-name\");await je(Q,[{uid:Number(F),name:R}]);let j=[...ne(Q)].find(te=>te.uid===Number(F));j&&(j.name=R)}else{let Q=await Y.getRegexes(),B=Q.find(j=>j.id===F);if(B){B.script_name=R,await Y.replaceRegexes(Q.filter(te=>te.source!==\"card\")),await Y.saveSettings();let j=o.regexes.global.find(te=>te.id===F)||o.regexes.character.find(te=>te.id===F);j&&(j.script_name=R)}}Z(_,R),L(),ve(\"\\u91CD\\u547D\\u540D\\u6210\\u529F\")}),oe=A(async u=>{if(u.key===\"Enter\")r(u.currentTarget).siblings(\".rlh-rename-save-btn\").click();else if(u.key===\"Escape\"){u.preventDefault();let _=r(u.currentTarget).closest(\".rlh-item-container\");Z(_)}}),ue=A(async u=>{u.stopPropagation();let _=r(u.currentTarget),L=_.closest(\".rlh-editor-wrapper\").find(\"textarea, .rlh-edit-content\");_.find(\"i\").hasClass(\"fa-expand\")?(_.attr(\"title\",\"\\u6536\\u7F29\").find(\"i\").removeClass(\"fa-expand\").addClass(\"fa-compress\"),L.each(function(){this.style.height=\"auto\",this.style.height=this.scrollHeight+\"px\"})):(_.attr(\"title\",\"\\u5C55\\u5F00\").find(\"i\").removeClass(\"fa-compress\").addClass(\"fa-expand\"),L.css(\"height\",\"\"))}),re=Dt(A(async u=>{let M=r(u.currentTarget).data(\"book-name\"),N=Ae().activeBookName??o.activeBookName??o.activeCharacterBook??o.chatLorebook??\"\",R=M||N;if(!R){await J({type:\"alert\",title:\"\\u521B\\u5EFA\\u5931\\u8D25\",text:\"\\u5F53\\u524D\\u6CA1\\u6709\\u9009\\u4E2D\\u7684\\u4E16\\u754C\\u4E66\\uFF0C\\u65E0\\u6CD5\\u521B\\u5EFA\\u6761\\u76EE\\u3002\"});return}let H=ol(R),F=No(H,R);if(F&&F.length){let Q=F.find(\".rlh-rename-btn\");Q.length&&Q.trigger(\"click\")}try{let Q=await Y.createWorldbookEntries(R,[{name:H.name,enabled:H.enabled,keys:H.keys}]);if(Q&&Q.new_entries&&Q.new_entries.length>0){Oe(R,Q.worldbook.map(ar));let B=Q.new_entries[0];if(B){ll(R,H.uid,B);let j=r(`#rlh-panel .rlh-item-container[data-id=\"${H.uid}\"]`,t);j.length&&(j.attr(\"data-id\",B.uid),j.data(\"id\",B.uid))}wr(R),ve(\"\\u65B0\\u6761\\u76EE\\u5DF2\\u521B\\u5EFA\")}else throw new Error(\"API\\u8FD4\\u56DE\\u6570\\u636E\\u683C\\u5F0F\\u4E0D\\u6B63\\u786E\")}catch(Q){console.error(\"[RegexLoreHub] Create entry failed:\",Q),J({type:\"alert\",title:\"\\u521B\\u5EFA\\u5931\\u8D25\",text:`\\u521B\\u5EFA\\u65B0\\u6761\\u76EE\\u65F6\\u53D1\\u751F\\u9519\\u8BEF\\uFF0C\\u4F46\\u60A8\\u4ECD\\u53EF\\u7F16\\u8F91\\u5F53\\u524D\\u5185\\u5BB9\\u5E76\\u624B\\u52A8\\u4FDD\\u5B58\\u3002\\u9519\\u8BEF: ${Q.message}`})}}),300),pe=A(async u=>{u.stopPropagation();let _=r(u.currentTarget).closest(\".rlh-item-container\"),M=_.data(\"book-name\"),L=Number(_.data(\"id\")),N=_.find(\".rlh-item-name\").text().trim();try{await J({type:\"confirm\",title:\"\\u786E\\u8BA4\\u5220\\u9664\",text:`\\u60A8\\u786E\\u5B9A\\u8981\\u5220\\u9664\\u6761\\u76EE \"${N}\" \\u5417\\uFF1F`})}catch{return}let R=await Y.deleteWorldbookEntries(M,[L]);R&&R.deleted_entries&&R.deleted_entries.length>0?(Oe(M,R.worldbook.map(ar)),wr(M),_.slideUp(300,()=>_.remove()),ve(\"\\u5220\\u9664\\u6210\\u529F\")):await J({type:\"alert\",title:\"\\u5220\\u9664\\u5931\\u8D25\",text:\"\\u5220\\u9664\\u6761\\u76EE\\u65F6\\u53D1\\u751F\\u9519\\u8BEF\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"})}),le=A(async u=>{let _=r(u.currentTarget),M=_.closest(\".rlh-editor-grid\").find(\".rlh-depth-container\");_.val().startsWith(\"at_depth\")?M.slideDown(200):M.slideUp(200)});return{handleToggleState:ce,handleEditorInput:i,renderLoreEntryViewer:v,renderLoreEntryEditor:w,renderRegexViewer:T,renderRegexEditor:k,handleEntryEnterEdit:C,handleEntryExitEdit:D,handleRegexEnterEdit:S,handleRegexExitEdit:K,handleRename:q,handleConfirmRename:W,handleRenameKeydown:oe,handleEditorExpandToggle:ue,handleCreateEntry:re,handleDeleteEntry:pe,handlePositionChange:le}}var ya=(e,r,t,a,l,n)=>{let i=Io(e,r,t,a,l,n);return J({type:\"confirm\",title:\"\\u786E\\u8BA4\\u66FF\\u6362\",html:i})},il=A(async e=>{let r=xe(),t=we(),a=r(`#${ke}`,t);if(!a.length)return;let l=a.find(`#${Ye.TOOLBAR_SHELL}`);if(l.length||(l=a.find(\".rlh-toolbar-shell\").first(),l.length&&l.attr(\"id\",Ye.TOOLBAR_SHELL)),!l.length)return;let n=!l.hasClass(\"rlh-toolbar-shell--collapsed\");e?.preventDefault?.(),e?.stopPropagation?.(),l.toggleClass(\"rlh-toolbar-shell--collapsed\",n),l.attr(\"aria-hidden\",String(n)),o.isToolbarCollapsed=n;let i=e?.currentTarget?r(e.currentTarget):a.find(`#${Ye.TOGGLE_TOOLBAR_BTN}`);i.length&&(i.text(n?\"\\u5C55\\u5F00\\u5DE5\\u5177\\u680F\":\"\\u6298\\u53E0\\u5DE5\\u5177\\u680F\"),i.attr(\"aria-expanded\",String(!n)),i.attr(\"title\",n?\"\\u5C55\\u5F00\\u5DE5\\u5177\\u680F\":\"\\u6298\\u53E0\\u5DE5\\u5177\\u680F\"))});function sl(e={}){let r=e.$??xe(),t=e.parentDoc??we(),a=e.lorebookHandlers,l=e.itemHandlers,n=()=>{switch(o.multiSelectTarget){case\"book\":return\"book:\";case\"entry\":return\"lore:\";case\"regex\":return\"regex:\";default:return\"\"}},i=c=>{let d=String(c??\"\"),y=d.indexOf(\":\");if(y===-1)return{type:d,raw:\"\"};let E=d.slice(0,y),V=d.slice(y+1);if(E===\"book\")return{type:E,bookName:ze(V)};if(E===\"lore\"){let z=V.lastIndexOf(\":\");if(z===-1)return{type:E,bookName:ze(V),entryId:null};let P=V.slice(0,z),U=V.slice(z+1);return{type:E,bookName:ze(P),entryId:ze(U)}}return E===\"regex\"?{type:E,regexId:ze(V)}:{type:E,raw:V}},h=()=>({$menu:r(`#${$r}`,t),$button:r(`#${sr}`,t)}),m=()=>{let c=new Map;for(let d of o.selectedItems){let{type:y,bookName:E,entryId:V}=i(d);if(y===\"lore\"&&E){let z=Number(V),P=Number.isFinite(z)?z:V;if(P==null||P===\"\")continue;c.has(E)||c.set(E,[]),c.get(E).push(P)}}return c},b=!1;function p(){let{$menu:c,$button:d}=h();c.length&&c.attr(\"data-open\",\"false\"),d.length&&d.attr(\"aria-expanded\",\"false\"),b&&(r(t).off(\"click.rlhUnifiedStatus\",f),b=!1)}function f(c){let{$menu:d,$button:y}=h();if(!d.length)return;let E=r(c.target);E.closest(`#${$r}`).length||y.length&&E.closest(`#${sr}`).length||p()}function v(){let{$menu:c,$button:d}=h();!c.length||!d.length||(c.attr(\"data-open\",\"true\"),d.attr(\"aria-expanded\",\"true\"),b||(r(t).on(\"click.rlhUnifiedStatus\",f),b=!0))}let w=()=>{let{$menu:c,$button:d}=h();if(!d.length)return;let y=Ae();if(!(y?.type===\"lore\")){d.attr(\"disabled\",\"disabled\").attr(\"title\",\"\\u7EDF\\u4E00\\u72B6\\u6001\\u4EC5\\u5728\\u6761\\u76EE\\u89C6\\u56FE\\u53EF\\u7528\"),c.length&&c.attr(\"data-open\")===\"true\"&&p();return}let z=[y?.activeBookName,o.activeBookName,o.activeCharacterBook,o.chatLorebook].find(Ce=>typeof Ce==\"string\"&&Ce.trim().length>0)?.toString().trim()??\"\",P=m();!z&&P.size===1&&(z=[...P.keys()][0]??\"\");let X=(z?ne(z):[]).length>0,ee=o.multiSelectMode&&o.multiSelectTarget===\"entry\",me=0;P.forEach(Ce=>{Array.isArray(Ce)&&(me+=Ce.length)});let fe=ee?me>0:X,he;ee?he=me>0?`\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u5C06\\u5BF9\\u5DF2\\u9009\\u4E2D\\u7684 ${me} \\u4E2A\\u6761\\u76EE\\u7EDF\\u4E00\\u72B6\\u6001`:\"\\u5DF2\\u5F00\\u542F\\u591A\\u9009\\uFF0C\\u8BF7\\u5148\\u52FE\\u9009\\u8981\\u8C03\\u6574\\u72B6\\u6001\\u7684\\u6761\\u76EE\":X?he=`\\u5C06\\u5BF9\\u300C${z||\"\\u5F53\\u524D\\u4E16\\u754C\\u4E66\"}\\u300D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u7EDF\\u4E00\\u72B6\\u6001`:he=z?`\\u300C${z}\\u300D\\u6682\\u65E0\\u6761\\u76EE\\u53EF\\u8C03\\u6574`:\"\\u8BF7\\u5148\\u6253\\u5F00\\u9700\\u8981\\u7EDF\\u4E00\\u72B6\\u6001\\u7684\\u4E16\\u754C\\u4E66\",d.attr(\"title\",he),fe?d.removeAttr(\"disabled\"):(d.attr(\"disabled\",\"disabled\"),c.length&&c.attr(\"data-open\")===\"true\"&&p())},T=()=>{let{$menu:c,$button:d}=_e();if(!d.length)return;let V=[Ae()?.activeBookName,o.activeBookName,o.activeCharacterBook,o.chatLorebook].find(he=>typeof he==\"string\"&&he.trim().length>0)?.toString().trim()??\"\",z=m();!V&&z.size===1&&(V=[...z.keys()][0]??\"\");let U=(V?ne(V):[]).length>0,X=o.multiSelectMode&&o.multiSelectTarget===\"entry\",ee=0;z.forEach(he=>{Array.isArray(he)&&(ee+=he.length)});let me=X?ee>0:U,fe;X?fe=ee>0?`\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u5C06\\u5BF9\\u5DF2\\u9009\\u4E2D\\u7684 ${ee} \\u4E2A\\u6761\\u76EE\\u7EDF\\u4E00\\u4F4D\\u7F6E`:\"\\u5DF2\\u5F00\\u542F\\u591A\\u9009\\uFF0C\\u8BF7\\u5148\\u52FE\\u9009\\u8981\\u8C03\\u6574\\u4F4D\\u7F6E\\u7684\\u6761\\u76EE\":U?fe=`\\u5C06\\u5BF9\\u300C${V||\"\\u5F53\\u524D\\u4E16\\u754C\\u4E66\"}\\u300D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u7EDF\\u4E00\\u4F4D\\u7F6E`:fe=V?`\\u300C${V}\\u300D\\u6682\\u65E0\\u6761\\u76EE\\u53EF\\u8C03\\u6574`:\"\\u8BF7\\u5148\\u6253\\u5F00\\u9700\\u8981\\u7EDF\\u4E00\\u4F4D\\u7F6E\\u7684\\u4E16\\u754C\\u4E66\",d.attr(\"title\",fe),me?d.removeAttr(\"disabled\"):(d.attr(\"disabled\",\"disabled\"),c.length&&c.attr(\"data-open\",\"false\"))},k=()=>{ut(),w(),T()},I=()=>{if(!o.multiSelectMode)return[];let c=r(`#${ke}`,t);if(!c.length)return[];let d;switch(o.multiSelectTarget){case\"book\":d=\".rlh-book-group[data-select-key]\";break;case\"entry\":d='.rlh-item-container[data-select-key][data-type=\"lore\"]';break;case\"regex\":d='.rlh-item-container[data-select-key][data-type=\"regex\"]';break;default:d=\"[data-select-key]\";break}let y=[];return c.find(d).each((E,V)=>{let z=r(V);if(!z.is(\":visible\"))return;let P=z.data(\"select-key\");P&&y.push(String(P))}),y},s=()=>{if(!o.selectedItems||o.selectedItems.size===0)return!1;let c=n();if(!c)return o.selectedItems.size>0;for(let d of o.selectedItems)if(d.startsWith(c))return!0;return!1},g=c=>{if(!c||!c.length)return null;if(c.hasClass(\"rlh-book-group\")){if(o.multiSelectTarget!==\"book\")return null;let d=c.data(\"book-name\");return d?Ze(d):null}if(c.hasClass(\"rlh-item-container\")){let d=c.data(\"type\"),y=c.data(\"id\");if(d===\"lore\"&&o.multiSelectTarget===\"entry\"){let E=c.data(\"book-name\");return E!=null&&y!=null?Gr(E,y):null}if(d===\"regex\"&&o.multiSelectTarget===\"regex\")return y!=null?Kr(y):null}return null},x=c=>{let d=g(c);return d?(o.selectedItems.has(d)?(o.selectedItems.delete(d),c.removeClass(\"selected\"),c.find(\".rlh-multi-select-checkbox\").prop(\"checked\",!1)):(o.selectedItems.add(d),c.addClass(\"selected\"),c.find(\".rlh-multi-select-checkbox\").prop(\"checked\",!0)),k(),!0):!1},C=A(async c=>{let d=r(c.currentTarget),y=d.val();d.attr(\"id\")===\"rlh-global-search-input\"?o.globalSearch.term=y:d.attr(\"id\")===\"rlh-global-replace-input\"&&(o.globalSearch.replace=y),d.attr(\"id\")===\"rlh-global-search-input\"&&se()}),D=A(async c=>{if(c.key===\"Enter\"){c.preventDefault();let d=c.currentTarget.value??\"\";o.globalSearch.term=d,se()}}),S=(c=[])=>{let d=new Set;return c.forEach(y=>{if(typeof y!=\"string\")return;let E=y.trim();E&&d.add(E)}),Array.from(d)},K=async c=>{let d=S(c);if(!d.length)return!0;let y=d.filter(V=>{if(o.allLorebooks.find(U=>U.name===V)?.entriesLoaded)return!1;let P=ne(V);return!Array.isArray(P)||P.length===0});if(!y.length)return!0;let E=lr(`\\u6B63\\u5728\\u52A0\\u8F7D ${y.length} \\u672C\\u4E16\\u754C\\u4E66\\u7684\\u6761\\u76EE...`);try{return await Promise.all(y.map(V=>Ie(V))),E.remove(),!0}catch(V){return E.remove(),console.error(\"[RegexLoreHub] Failed to load entries before replace:\",V),await J({type:\"alert\",title:\"\\u52A0\\u8F7D\\u5931\\u8D25\",text:\"\\u5728\\u6267\\u884C\\u66FF\\u6362\\u524D\\u52A0\\u8F7D\\u4E16\\u754C\\u4E66\\u6761\\u76EE\\u5931\\u8D25\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"}),!1}},ce=A(async()=>{let c=r(`#${nr}`,t);c.length&&c.val(\"\"),o.globalSearch.term=\"\",se()}),q=A(async()=>{let c=r(`#${nr}`,t).val(),d=r(`#${Sr}`,t).val(),y=Ae();if(!c){await J({type:\"alert\",title:\"\\u66FF\\u6362\\u5931\\u8D25\",text:\"\\u8BF7\\u5148\\u8F93\\u5165\\u641C\\u7D22\\u8BCD\\u3002\"});return}if(y.view===\"global-lore-list\"){let U=o.allLorebooks.filter(X=>!X.entriesLoaded);if(U.length>0){let X=lr(`\\u6B63\\u5728\\u52A0\\u8F7D ${U.length} \\u672C\\u4E16\\u754C\\u4E66\\u7684\\u6761\\u76EE...`);try{await Promise.all(U.map(ee=>Ie(ee.name))),X.remove()}catch(ee){X.remove(),console.error(\"[RegexLoreHub] Failed to load entries before replace:\",ee),await J({type:\"alert\",title:\"\\u52A0\\u8F7D\\u5931\\u8D25\",text:\"\\u5728\\u6267\\u884C\\u66FF\\u6362\\u524D\\u52A0\\u8F7D\\u4E16\\u754C\\u4E66\\u6761\\u76EE\\u5931\\u8D25\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"});return}}}let E,V,z,P;if(y.type===\"lore\")if(P={type:\"lorebook\",bookNames:[]},y.view===\"global-lore-list\")({matches:E,stats:V,booksMatchedByNameOnly:z}=Xr(c));else if(y.view===\"global-lore-detail\"){let U=S([y.activeBookName]);if(!U.length){await J({type:\"alert\",title:\"\\u64CD\\u4F5C\\u65E0\\u6548\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u8981\\u66FF\\u6362\\u7684\\u4E16\\u754C\\u4E66\\u3002\"});return}if(!await K(U))return;({matches:E,stats:V,booksMatchedByNameOnly:z}=Xr(c,!1,{bookNames:U})),P.bookNames=U}else if(y.id===\"char-lore\"){let U=S([y.activeBookName,o.activeCharacterBook]);if(!U.length){await J({type:\"alert\",title:\"\\u64CD\\u4F5C\\u65E0\\u6548\",text:\"\\u5F53\\u524D\\u6CA1\\u6709\\u53EF\\u7528\\u7684\\u89D2\\u8272\\u4E16\\u754C\\u4E66\\uFF0C\\u65E0\\u6CD5\\u6267\\u884C\\u66FF\\u6362\\u3002\"});return}if(!await K(U))return;({matches:E,stats:V,booksMatchedByNameOnly:z}=Xr(c,!1,{bookNames:U})),P.bookNames=U}else if(y.id===\"chat-lore\"){let U=S([y.activeBookName,o.chatLorebook]);if(!U.length){await J({type:\"alert\",title:\"\\u64CD\\u4F5C\\u65E0\\u6548\",text:\"\\u5F53\\u524D\\u6CA1\\u6709\\u53EF\\u7528\\u7684\\u804A\\u5929\\u4E16\\u754C\\u4E66\\uFF0C\\u65E0\\u6CD5\\u6267\\u884C\\u66FF\\u6362\\u3002\"});return}if(!await K(U))return;({matches:E,stats:V,booksMatchedByNameOnly:z}=Xr(c,!1,{bookNames:U})),P.bookNames=U}else{await J({type:\"alert\",title:\"\\u64CD\\u4F5C\\u65E0\\u6548\",text:\"\\u5F53\\u524D\\u89C6\\u56FE\\u4E0D\\u652F\\u6301\\u66FF\\u6362\\u529F\\u80FD\\u3002\"});return}else if(y.type===\"regex\")({matches:E,stats:V}=Do(c)),P=\"regex\";else{await J({type:\"alert\",title:\"\\u64CD\\u4F5C\\u65E0\\u6548\",text:\"\\u672A\\u77E5\\u7684\\u89C6\\u56FE\\u7C7B\\u578B\\uFF0C\\u65E0\\u6CD5\\u6267\\u884C\\u66FF\\u6362\\u3002\"});return}if((!E||E.length===0)&&(!z||z.length===0)){await J({type:\"alert\",title:\"\\u65E0\\u5339\\u914D\\u9879\",text:\"\\u672A\\u627E\\u5230\\u53EF\\u66FF\\u6362\\u7684\\u6761\\u76EE\\u3002\"});return}try{await ya(E,V,z,c,d,P);let U=lr(\"\\u6B63\\u5728\\u6267\\u884C\\u66FF\\u6362...\");try{await gl(E,c,d),U.remove(),ve(\"\\u66FF\\u6362\\u5B8C\\u6210\"),se()}catch(X){U.remove(),console.error(\"[RegexLoreHub] Replace error:\",X),await J({type:\"alert\",title:\"\\u66FF\\u6362\\u5931\\u8D25\",text:\"\\u66FF\\u6362\\u8FC7\\u7A0B\\u4E2D\\u53D1\\u751F\\u9519\\u8BEF\\uFF0C\\u8BF7\\u68C0\\u67E5\\u5F00\\u53D1\\u8005\\u63A7\\u5236\\u53F0\\u83B7\\u53D6\\u8BE6\\u7EC6\\u4FE1\\u606F\\u3002\"})}}catch{console.log(\"[RegexLoreHub] Replace operation cancelled by user.\")}}),Z=A(async()=>{let c=Ae();if(!c.showCollapseToggle)return;let d=Cr(c),E=(o.collapseStateByContext.get(d)??\"expanded\")===\"collapsed\"?\"expanded\":\"collapsed\";Eo(c,E),r(`#${ke}-content .rlh-item-container:visible, #${ke}-content .rlh-book-group:visible`,t).each(function(){let P=r(this),X=P.find(\".rlh-collapsible-content\").first().is(\":visible\"),ee=P.find(\".rlh-item-header, .rlh-global-book-header\").first();E===\"expanded\"&&!X?ee.trigger(\"click.rlh\",{bulk:!0}):E===\"collapsed\"&&X&&ee.trigger(\"click.rlh\",{bulk:!0})});let z=r(`#${_r}`,t);if(z.length){let P=E===\"collapsed\"?\"fa-expand-arrows-alt\":\"fa-compress-arrows-alt\",U=E===\"collapsed\"?\"\\u5168\\u90E8\\u5C55\\u5F00\":\"\\u5168\\u90E8\\u6298\\u53E0\";z.attr(\"data-collapse-state\",E),z.find(\"i\").removeClass(\"fa-expand-arrows-alt fa-compress-arrows-alt\").addClass(P),z.find(\"span\").text(U)}}),W=!1;function oe(){return{$menu:r(`#${Er}`,t),$button:r(`#${ir}`,t)}}function ue(c){if(!W)return;let d=r(c.target);d.closest(`#${Er}`).length||d.closest(`#${ir}`).length||u()}function re(c){if(c.key!==\"Escape\")return;let{$button:d}=oe();u(),d.length&&d.trigger(\"focus\")}function pe(){W||(r(t).on(\"click.rlhSortMenu\",ue),r(t).on(\"keydown.rlhSortMenu\",re),W=!0)}function le(){W&&(r(t).off(\"click.rlhSortMenu\",ue),r(t).off(\"keydown.rlhSortMenu\",re),W=!1)}function u(){let{$menu:c,$button:d}=oe();c.length&&(c.attr(\"data-open\",\"false\").removeClass(\"open\"),d.length&&d.attr(\"aria-expanded\",\"false\"),le())}function _(){let{$menu:c,$button:d}=oe();c.length&&(c.attr(\"data-open\",\"true\").addClass(\"open\"),d.length&&d.attr(\"aria-expanded\",\"true\"),pe())}let M=A(async c=>{c.preventDefault(),c.stopPropagation();let{$menu:d}=oe();if(!d.length)return;d.attr(\"data-open\")===\"true\"?u():_()}),L=A(async c=>{c.preventDefault();let d=r(c.currentTarget).data(\"sort-value\");if(!d)return;u();let y=Ae();$o(y,d),se()}),N=!1,R=()=>({$wrapper:r(`#${Pr}`,t),$menu:r(`#${cr}`,t),$button:r(`#${zr}`,t)});function H(c){if(!N)return;let{$wrapper:d}=R();if(!d.length)return;let y=c?.target??null;y&&d[0]?.contains(y)||j()}function F(c){if(c.key!==\"Escape\")return;let{$button:d}=R();j(),d.length&&d.trigger(\"focus\")}function Q(){N||(r(t).on(\"click.rlhThemeMenu\",H),r(t).on(\"keydown.rlhThemeMenu\",F),N=!0)}function B(){N&&(r(t).off(\"click.rlhThemeMenu\",H),r(t).off(\"keydown.rlhThemeMenu\",F),N=!1)}function j(){let{$wrapper:c,$menu:d,$button:y}=R();c.length&&c.removeClass(\"open\"),d.length&&d.attr(\"data-open\",\"false\"),y.length&&y.attr(\"aria-expanded\",\"false\"),B()}function te(){let{$wrapper:c,$menu:d,$button:y}=R();!c.length||!d.length||(c.addClass(\"open\"),d.attr(\"data-open\",\"true\"),y.length&&y.attr(\"aria-expanded\",\"true\"),Q())}let ie=A(c=>{c.preventDefault(),c.stopPropagation();let{$wrapper:d}=R();if(!d.length)return;d.hasClass(\"open\")?j():te()}),ae=A(async c=>{c.preventDefault();let d=r(c.currentTarget);if(!d.hasClass(Tr)){j();return}let y=d.data(\"themeId\"),E=typeof y==\"string\"||typeof y==\"number\"?String(y).trim():\"\";if(!E){j();return}let V=Fr();if(!V||V.id!==E){let z=jr(E,{reason:\"user\"});z&&await Ko(z.id)}j()}),ge=!1;function _e(){return{$menu:r(`#${or}`,t),$button:r(`#${Qe}`,t)}}function G(c){if(!ge)return;let d=r(c.target);d.closest(`#${or}`).length||d.closest(`#${Qe}`).length||Le()}function be(c){if(c.key!==\"Escape\")return;let{$button:d}=_e();Le(),d.length&&d.trigger(\"focus\")}function de(){ge||(r(t).on(\"click.rlhPositionMenu\",G),r(t).on(\"keydown.rlhPositionMenu\",be),ge=!0)}function Ge(){ge&&(r(t).off(\"click.rlhPositionMenu\",G),r(t).off(\"keydown.rlhPositionMenu\",be),ge=!1)}function Le(){let{$menu:c,$button:d}=_e();c.length&&(c.attr(\"data-open\",\"false\").removeClass(\"open\"),d.length&&d.attr(\"aria-expanded\",\"false\"),Ge())}function Ke(){let{$menu:c,$button:d}=_e();c.length&&(d.is(\"[disabled]\")||(c.attr(\"data-open\",\"true\").addClass(\"open\"),d.length&&d.attr(\"aria-expanded\",\"true\"),de()))}let br=A(async c=>{c.preventDefault(),c.stopPropagation(),k();let{$menu:d}=_e();if(!d.length)return;d.attr(\"data-open\")===\"true\"?Le():Ke()}),kt=A(async c=>{c.preventDefault();let d=r(c.currentTarget),y=(d.data(\"position-value\")??\"\").toString().trim(),E=(d.data(\"book-name\")??d.closest(`#${or}`).data(\"book-name\")??\"\").toString().trim();Le(),y&&a?.applyUnifiedPosition&&await a.applyUnifiedPosition({bookName:E,positionValue:y})}),ul=A(async c=>{c.preventDefault(),c.stopPropagation(),k();let{$menu:d,$button:y}=h();if(!d.length||!y.length||y.is(\":disabled\"))return;d.attr(\"data-open\")===\"true\"?p():v()}),bl=A(async c=>{c.preventDefault();let y=(r(c.currentTarget).data(\"status-id\")??\"\").toString().trim();if(!y)return;p();let E=o.multiSelectMode&&o.multiSelectTarget===\"entry\",V=m();if(E&&V.size===0){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u81F3\\u5C11\\u9009\\u62E9\\u4E00\\u4E2A\\u5DF2\\u4FDD\\u5B58\\u7684\\u6761\\u76EE\\u3002\"}),k();return}if(!E){let Pe=[Ae()?.activeBookName,o.activeBookName,o.activeCharacterBook,o.chatLorebook].find(Je=>typeof Je==\"string\"&&Je.trim().length>0)?.toString().trim()??\"\";if(!Pe){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u6253\\u5F00\\u4E00\\u4E2A\\u4E16\\u754C\\u4E66\\u4EE5\\u4FBF\\u6267\\u884C\\u7EDF\\u4E00\\u72B6\\u6001\\u3002\"}),k();return}let mr=[...ne(Pe)];if(mr.length||(await Ie(Pe),mr=[...ne(Pe)]),!mr.length){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:`\\u300C${Pe}\\u300D\\u6682\\u65E0\\u6761\\u76EE\\u53EF\\u64CD\\u4F5C\\u3002`}),k();return}let Fe=[];if(mr.forEach(Je=>{let Te=Number(Je?.uid);Number.isFinite(Te)&&Fe.push(Te)}),!Fe.length){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u5F53\\u524D\\u6CA1\\u6709\\u5DF2\\u4FDD\\u5B58\\u7684\\u6761\\u76EE\\u53EF\\u64CD\\u4F5C\\u3002\"}),k();return}V=new Map([[Pe,Fe]])}let z=qe(y)??Re,P=z.toastLabel??z.label,U=Array.from(V.values()).reduce((Be,Mr)=>Be+Mr.length,0),X=lr(`\\u6B63\\u5728\\u66F4\\u65B0 ${U} \\u4E2A\\u6761\\u76EE\\u7684\\u72B6\\u6001...`),ee=0,me=0,fe=0,he=0,Ce=0,Ve=[];try{let Be=Ae(),Mr=0;for(let[Pe,mr]of V.entries()){Mr+=1,X.update(`\\u6B63\\u5728\\u66F4\\u65B0\\u300C${Pe}\\u300D (${Mr}/${V.size})`);let Fe=await qo(Pe,mr,z.id,{context:Be?.id??\"unknown\"}).catch(Te=>(console.error(\"[RegexLoreHub] \\u6279\\u91CF\\u72B6\\u6001\\u66F4\\u65B0\\u5F02\\u5E38:\",Te),Ve.push({bookName:Pe,reason:Te?.message??\"\\u672A\\u77E5\\u9519\\u8BEF\"}),fe+=mr.length,null));if(!Fe)continue;let Je=Fe.summary??{appliedCount:0,alreadyAppliedCount:0,failedCount:0,ignoredCount:0,ignoredUnsavedCount:0};ee+=Je.appliedCount??0,me+=Je.alreadyAppliedCount??0,fe+=Je.failedCount??0,he+=Je.ignoredCount??0,Ce+=Je.ignoredUnsavedCount??0,Array.isArray(Fe.failed)&&Fe.failed.forEach(Te=>{Ve.push({bookName:Pe,name:Te.name??`#${Te.uid??Te.tempUid??\"\\u672A\\u77E5\"}`,reason:Te.reason??\"\\u672A\\u8BF4\\u660E\"})}),Array.isArray(Fe.ignored)&&Fe.ignored.filter(Te=>Te.reason&&Te.reason!==\"UNSAVED_ENTRY\").forEach(Te=>{Ve.push({bookName:Pe,name:Te.name??`#${Te.uid??Te.tempUid??\"\\u672A\\u77E5\"}`,reason:Te.reason})}),Array.isArray(Fe.success)&&Fe.success.forEach(Te=>{let lo=Te.uid??Te.tempUid;lo!=null&&bt(Pe,lo,z.id)})}}finally{X.remove()}let Ne=Math.max(he-Ce,0),Me=\"\";if(ee>0&&fe===0&&Ce===0&&Ne===0)Me=`${ee} \\u4E2A\\u6761\\u76EE\\u7684\\u72B6\\u6001\\u5DF2\\u66F4\\u65B0\\u4E3A\\u300C${P}\\u300D`,me>0&&(Me+=`\\uFF08\\u5176\\u4E2D ${me} \\u4E2A\\u539F\\u672C\\u5DF2\\u5904\\u4E8E\\u8BE5\\u72B6\\u6001\\uFF09`);else{let Be=[];ee>0&&Be.push(`${ee} \\u4E2A\\u6761\\u76EE\\u66F4\\u65B0\\u4E3A\\u300C${P}\\u300D`),me>0&&Be.push(`${me} \\u4E2A\\u539F\\u672C\\u5DF2\\u5904\\u4E8E\\u8BE5\\u72B6\\u6001`),fe>0&&Be.push(`${fe} \\u4E2A\\u6761\\u76EE\\u66F4\\u65B0\\u5931\\u8D25`),Ce>0&&Be.push(`\\u5FFD\\u7565 ${Ce} \\u4E2A\\u672A\\u4FDD\\u5B58\\u6761\\u76EE`),Ne>0&&Be.push(`\\u8DF3\\u8FC7 ${Ne} \\u4E2A\\u6761\\u76EE`),Me=Be.length>0?Be.join(\"\\uFF1B\"):\"\\u672A\\u6267\\u884C\\u4EFB\\u4F55\\u72B6\\u6001\\u66F4\\u65B0\\uFF0C\\u8BF7\\u786E\\u8BA4\\u5DF2\\u9009\\u62E9\\u6709\\u6548\\u6761\\u76EE\\u3002\"}let Ee=\"success\";fe>0?Ee=ee>0?\"warning\":\"error\":(Ce>0||Ne>0)&&(Ee=\"info\"),ve(Me,Ee),Ve.length&&console.warn(\"[RegexLoreHub] \\u72B6\\u6001\\u66F4\\u65B0\\u8BE6\\u60C5\\uFF08\\u4EC5\\u65E5\\u5FD7\\uFF09:\",Ve),k()}),ml=A(async c=>{let d=(r(c.currentTarget).val()??\"\").toString().trim();!d||o.activeCharacterBook===d||(o.activeCharacterBook=d,se())}),fl=A(async c=>{let d=r(c.currentTarget),y=d.data(\"select-key\");if(!y)return;if(!o.multiSelectMode){d.prop(\"checked\",!1);return}let E=d.is(\":checked\");E?o.selectedItems.add(y):o.selectedItems.delete(y),d.closest(\"[data-select-key]\").toggleClass(\"selected\",E),k()}),gl=async(c,d,y)=>{let E=So(d,!1),V=new Map,z=(P,U)=>{if(!Array.isArray(P)||!Array.isArray(U)||P.length!==U.length)return!1;for(let X=0;X<P.length;X+=1)if(P[X]!==U[X])return!1;return!0};for(let P of c){let{bookName:U,entry:X}=P??{};if(!U||!X)throw new Error(\"\\u4EC5\\u652F\\u6301\\u4E16\\u754C\\u4E66\\u6761\\u76EE\\u7684\\u6279\\u91CF\\u66FF\\u6362\\u3002\");let ee=Number(X?.uid);if(!Number.isFinite(ee))continue;let me={uid:ee},fe=!1;if(Array.isArray(X.keys)){let he=X.keys.map(Ce=>Ce.replace(E,y));z(X.keys,he)||(me.keys=he,fe=!0)}if(typeof X.content==\"string\"){let he=X.content.replace(E,y);he!==X.content&&(me.content=he,fe=!0)}if(typeof X.name==\"string\"){let he=X.name.replace(E,y);he!==X.name&&(me.name=he,fe=!0)}if(typeof X.comment==\"string\"){let he=X.comment.replace(E,y);he!==X.comment&&(me.comment=he,fe=!0)}fe&&(V.has(U)||V.set(U,[]),V.get(U).push(me))}for(let[P,U]of V.entries())U.length!==0&&await je(P,U)},xl=A(async()=>{r(`#${ke}`,t).is(\":visible\")?ro():await vl()}),ro=async()=>{ve(\"\\u6B63\\u5728\\u540E\\u53F0\\u4FDD\\u5B58\\u6570\\u636E...\",\"info\"),pr().then(()=>{ve(\"\\u6570\\u636E\\u4FDD\\u5B58\\u6210\\u529F\\uFF01\",\"success\")}).catch(y=>{console.error(\"[RegexLoreHub] Background save failed:\",y),ve(\"\\u540E\\u53F0\\u4FDD\\u5B58\\u5931\\u8D25\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u65E5\\u5FD7\\u3002\",\"error\")});let c=r(`#${ke}`,t),d=r(\"body\",t);c.hide(),r(`#${tr}`,t).removeClass(\"active\"),d.off(\"mousedown.rlh-outside-click\")},vl=async()=>{let c=r(`#${ke}`,t),d=r(\"body\",t);c.css(\"display\",\"flex\"),r(`#${tr}`,t).addClass(\"active\"),d.on(\"mousedown.rlh-outside-click\",function(y){r(y.target).closest(`#${ke}`).length===0&&r(y.target).closest(`#${tr}`).length===0&&ro()}),o.isDataLoaded?se():await We()},yl=A(async c=>{o.isLoadingTabData=!0,se();try{await rl();let d=y=>{if(!y)return null;Array.isArray(o.allLorebooks)||(o.allLorebooks=[]);let E=o.allLorebooks.find(V=>V.name===y);return E||(E={name:y,enabled:!1,entryCount:0,enabledEntryCount:0,entriesLoaded:!1},o.allLorebooks.push(E)),E};if(c===\"char-lore\"){let y=Array.isArray(o.lorebooks.character)?o.lorebooks.character:[];for(let E of y)d(E),await Ie(E,!0)}else if(c===\"chat-lore\"){let y=o.chatLorebook;y&&(d(y),await Ie(y,!0))}}catch(d){console.error(`[RegexLoreHub] Error refreshing tab ${c}:`,d),A(()=>{throw d})()}finally{o.isLoadingTabData=!1,se()}}),kl=c=>{switch(c){case\"char-lore\":o.activeView=\"char-lore\";break;case\"chat-lore\":o.activeView=\"chat-lore\";break;case\"global-regex\":o.activeView=\"global-regex\";break;case\"char-regex\":o.activeView=\"char-regex\";break;case\"global-lore\":default:o.activeView!==\"global-lore-detail\"&&(o.activeView=\"global-lore-list\");break}},wl=A(async c=>{let d=r(c.currentTarget).data(\"tab\");if(d===\"global-lore\"&&o.activeView===\"global-lore-detail\"){await a.handleExitLorebookDetail();return}o.activeTab=d,kl(d),r(`#${ke} .rlh-tab`,t).removeClass(\"active\"),r(c.currentTarget).addClass(\"active\"),r(`#${rt}`,t).toggle(o.activeTab===\"global-lore\"),o.selectedItems.clear(),d===\"char-lore\"&&!o.charLoreInitialSynced&&(await We(),o.charLoreInitialSynced=!0),d===\"char-lore\"||d===\"chat-lore\"?await yl(d):se()}),to=A(async c=>{o.multiSelectMode=!o.multiSelectMode,o.selectedItems.clear(),r(\"#rlh-multi-select-btn\",t).toggleClass(\"active\",o.multiSelectMode),r(\"#rlh-multi-select-controls\",t).toggleClass(\"active\",o.multiSelectMode),se(),k()}),Sl=A(async()=>{if(!o.multiSelectMode)return;let c=I();c.length&&(c.forEach(d=>o.selectedItems.add(d)),se(),k())}),_l=A(async()=>{if(!o.multiSelectMode)return;let c=n(),d=!1;if(c)[...o.selectedItems].forEach(E=>{E.startsWith(c)&&(o.selectedItems.delete(E),d=!0)});else{if(o.selectedItems.size===0)return;o.selectedItems.clear(),d=!0}d&&(se(),k())}),El=A(async()=>{if(!o.multiSelectMode)return;let c=I();c.length&&(c.forEach(d=>{o.selectedItems.has(d)?o.selectedItems.delete(d):o.selectedItems.add(d)}),se(),k())}),$l=A(async()=>{if(o.multiSelectMode){if(!s())return await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u8981\\u542F\\u7528\\u7684\\u9879\\u76EE\\u3002\"});await oo(!0),ve(\"\\u6279\\u91CF\\u542F\\u7528\\u6210\\u529F\")}}),Tl=A(async()=>{if(o.multiSelectMode){if(!s())return await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u8981\\u7981\\u7528\\u7684\\u9879\\u76EE\\u3002\"});await oo(!1),ve(\"\\u6279\\u91CF\\u7981\\u7528\\u6210\\u529F\")}}),Ll=A(async()=>{if(!o.multiSelectMode)return;let c=new Set,d=new Map,y=new Set,E=0;for(let U of o.selectedItems){let{type:X,bookName:ee,entryId:me,regexId:fe}=i(U);if(X===\"book\"&&ee)c.add(ee);else if(X===\"lore\"&&ee){let he=Number(me);if(!Number.isFinite(he))continue;d.has(ee)||d.set(ee,[]),d.get(ee).push(he),E++}else if(X===\"regex\"){let he=fe!=null&&fe!==\"\"?String(fe):\"\";he&&y.add(he)}}if(c.size===0&&E===0&&y.size===0)return await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u8981\\u5220\\u9664\\u7684\\u9879\\u76EE\\u3002\"});let V=\"\\u60A8\\u786E\\u5B9A\\u8981\\u6C38\\u4E45\\u5220\\u9664\",z=[];c.size>0&&z.push(`\\u9009\\u4E2D\\u7684 ${c.size} \\u672C\\u4E16\\u754C\\u4E66`),E>0&&z.push(`${E} \\u4E2A\\u6761\\u76EE`),y.size>0&&z.push(`${y.size} \\u4E2A\\u6B63\\u5219`),V+=` ${z.join(\"\\u548C\")} \\u5417\\uFF1F\\u6B64\\u64CD\\u4F5C\\u65E0\\u6CD5\\u64A4\\u9500\\u3002`;try{await J({type:\"confirm\",title:\"\\u786E\\u8BA4\\u5220\\u9664\",text:V})}catch{return}let P=lr(\"\\u5F00\\u59CB\\u5220\\u9664...\");try{let U=0,X=0,ee=0,me=0,fe=0,he=Array.from(d.entries());for(let[Ne,Me]of he){if(c.has(Ne)){me+=Me.length;continue}P.update(`\\u6B63\\u5728\\u5220\\u9664\\u6761\\u76EE... (${me}/${E})`);let Ee=await Y.deleteWorldbookEntries(Ne,Me);me+=Me.length,Ee&&Ee.deleted_entries&&Ee.deleted_entries.length>0&&(X+=Ee.deleted_entries.length,Oe(Ne,Ee.worldbook.map(ar)),Me.forEach(Be=>o.selectedItems.delete(Gr(Ne,Be))))}let Ce=Array.from(c);for(let Ne of Ce){if(P.update(`\\u6B63\\u5728\\u5220\\u9664\\u4E16\\u754C\\u4E66... (${fe+1}/${Ce.length})`),await Y.deleteWorldbook(Ne)){U++,o.allLorebooks=o.allLorebooks.filter(Ee=>Ee.name!==Ne),Vr(Ne),o.selectedItems.delete(Ze(Ne));let Me=gr(Ne);for(let Ee of[...o.selectedItems])Ee.startsWith(Me)&&o.selectedItems.delete(Ee)}fe++}if(y.size>0){P.update(`\\u6B63\\u5728\\u5220\\u9664 ${y.size} \\u4E2A\\u6B63\\u5219...`);let Ne=await Y.getRegexes(),Me=Ne.filter(Ee=>!y.has(String(Ee.id)));await Y.replaceRegexes(Me.filter(Ee=>Ee.source!==\"card\")),await Y.saveSettings(),ee=Ne.length-Me.length,o.regexes.global=o.regexes.global.filter(Ee=>!y.has(String(Ee.id))),o.regexes.character=o.regexes.character.filter(Ee=>!y.has(String(Ee.id))),er(o.regexes.global),er(o.regexes.character),y.forEach(Ee=>o.selectedItems.delete(Kr(Ee)))}P.remove();let Ve=[];U>0&&Ve.push(`\\u6210\\u529F\\u5220\\u9664 ${U} \\u672C\\u4E16\\u754C\\u4E66`),X>0&&Ve.push(`\\u6210\\u529F\\u5220\\u9664 ${X} \\u4E2A\\u6761\\u76EE`),ee>0&&Ve.push(`\\u6210\\u529F\\u5220\\u9664 ${ee} \\u4E2A\\u6B63\\u5219`),Ve.length>0?(ve(Ve.join(\"\\uFF0C\")),o.multiSelectMode?to():se()):await J({type:\"alert\",title:\"\\u5220\\u9664\\u5931\\u8D25\",text:\"\\u5220\\u9664\\u9879\\u76EE\\u65F6\\u53D1\\u751F\\u9519\\u8BEF\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"})}catch(U){P.remove(),console.error(\"[RegexLoreHub] Batch delete failed:\",U),await J({type:\"alert\",title:\"\\u5220\\u9664\\u5931\\u8D25\",text:`\\u64CD\\u4F5C\\u5931\\u8D25: ${U.message}`}),await We(!0)}}),Cl=A(async()=>{if(!Array.isArray(o.allLorebooks)||o.allLorebooks.length===0){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u6CA1\\u6709\\u627E\\u5230\\u53EF\\u4EE5\\u6E05\\u7406\\u7684\\u4E16\\u754C\\u4E66\\u3002\"});return}let c=o.allLorebooks.filter(z=>{let P=o.lorebookUsage instanceof Map?o.lorebookUsage.get(z.name):[],U=Array.isArray(P)?P:[];return!z.enabled&&U.length===0}).map(z=>z.name);if(c.length===0){await J({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u6CA1\\u6709\\u627E\\u5230\\u672A\\u542F\\u7528\\u4E14\\u672A\\u7ED1\\u5B9A\\u89D2\\u8272\\u5361\\u7684\\u4E16\\u754C\\u4E66\\u3002\"});return}o.multiSelectMode=!0,o.multiSelectTarget=\"book\",o.selectedItems.clear(),c.forEach(z=>o.selectedItems.add(Ze(z))),se();let d=\"\\u5C06\\u5220\\u9664 \"+c.length+\" \\u672C\\u672A\\u542F\\u7528\\u4E14\\u672A\\u7ED1\\u5B9A\\u89D2\\u8272\\u5361\\u7684\\u4E16\\u754C\\u4E66\\u3002\\u56E0API\\u9650\\u5236\\uFF0C\\u65E0\\u6CD5\\u76F4\\u63A5\\u83B7\\u53D6\\u804A\\u5929\\u7ED1\\u5B9A\\u4E16\\u754C\\u4E66\\uFF0C\\u5B58\\u5728\\u8BEF\\u5220\\u8BE5\\u4E16\\u754C\\u4E66\\u7684\\u53EF\\u80FD\\u3002\\u786E\\u5B9A\\u7EE7\\u7EED\\u5417\\uFF1F\";try{await J({type:\"confirm\",title:\"\\u786E\\u8BA4\\u6E05\\u7406\\u5B64\\u7ACB\\u4E16\\u754C\\u4E66\",text:d})}catch{return}let y=lr(\"\\u5F00\\u59CB\\u6E05\\u7406\\u5B64\\u7ACB\\u4E16\\u754C\\u4E66...\"),E=[],V=0;try{for(let z=0;z<c.length;z+=1){let P=c[z];if(y.update(\"\\u6B63\\u5728\\u5220\\u9664\\u7B2C \"+(z+1)+\" / \"+c.length+\" \\u672C\\u4E16\\u754C\\u4E66...\"),await Y.deleteWorldbook(P)){V+=1,o.allLorebooks=o.allLorebooks.filter(ee=>ee.name!==P),Vr(P),o.lorebookUsage instanceof Map&&o.lorebookUsage.has(P)&&o.lorebookUsage.delete(P),Array.isArray(o.lorebooks?.character)&&(o.lorebooks.character=o.lorebooks.character.filter(ee=>ee!==P)),o.chatLorebook===P&&(o.chatLorebook=null),o.activeCharacterBook===P&&(o.activeCharacterBook=null),o.activeBookName===P&&(o.activeBookName=null),o.selectedItems.delete(Ze(P));let X=gr(P);for(let ee of[...o.selectedItems])ee.startsWith(X)&&o.selectedItems.delete(ee)}else E.push(P)}}catch(z){y.remove(),console.error(\"[RegexLoreHub] Clean orphan lorebooks failed:\",z),await J({type:\"alert\",title:\"\\u64CD\\u4F5C\\u5931\\u8D25\",text:\"\\u6E05\\u7406\\u5B64\\u7ACB\\u4E16\\u754C\\u4E66\\u65F6\\u53D1\\u751F\\u9519\\u8BEF\\uFF1A\"+(z?.message||z)}),await We(!0);return}y.remove(),V>0&&ve(\"\\u5DF2\\u5220\\u9664 \"+V+\" \\u672C\\u5B64\\u7ACB\\u4E16\\u754C\\u4E66\"),E.length>0?(o.selectedItems.clear(),E.forEach(z=>o.selectedItems.add(Ze(z))),await J({type:\"alert\",title:\"\\u90E8\\u5206\\u5220\\u9664\\u5931\\u8D25\",text:\"\\u4EE5\\u4E0B\\u4E16\\u754C\\u4E66\\u672A\\u80FD\\u5220\\u9664\\uFF1A\"+E.join(\"\\u3001\")})):(o.selectedItems.clear(),o.multiSelectMode=!1),se()}),oo=A(async c=>{let d=new Set,y=new Map,E=new Set,V=!1,z=!1;for(let P of o.selectedItems){let{type:U,bookName:X,entryId:ee,regexId:me}=i(P);if(U===\"book\"&&X)d.add(X);else if(U===\"lore\"&&X){let fe=Number(ee);if(!Number.isFinite(fe))continue;y.has(X)||y.set(X,[]),y.get(X).push(fe)}else if(U===\"regex\"){let fe=me!=null&&me!==\"\"?String(me):\"\";fe&&E.add(fe)}}if(d.size>0){let P=new Set(await Y.getGlobalWorldbookNames()||[]);d.forEach(U=>c?P.add(U):P.delete(U)),await Y.rebindGlobalWorldbooks(Array.from(P)),z=!0,d.forEach(U=>{let X=o.allLorebooks.find(ee=>ee.name===U);X&&(X.enabled=c)})}if(y.size>0)for(let[P,U]of y){let X=[...ne(P)];if(X){let ee=U.map(me=>{let fe=X.find(he=>he.uid===me);return fe?(fe.enabled=c,{uid:me,enabled:c}):null}).filter(Boolean);ee.length>0&&await je(P,ee)}}if(await Y.saveSettings(),E.size>0){let P=await Y.getRegexes();P.forEach(U=>{E.has(String(U.id))&&(U.enabled=c)}),await Y.replaceRegexes(P.filter(U=>U.source!==\"card\")),V=!0,[o.regexes.global,o.regexes.character].forEach(U=>U.forEach(X=>{E.has(String(X.id))&&(X.enabled=c)}))}(z||V)&&await Y.saveSettings(),o.selectedItems.clear(),se()}),Nl=A(async(c,d)=>{let y=r(c.target),E=r(c.currentTarget).closest(\".rlh-item-container, .rlh-book-group\");if(y.closest(\".rlh-item-controls, .rlh-rename-ui\").length>0||o.multiSelectMode&&x(E))return;if(!o.multiSelectMode&&o.activeTab===\"global-lore\"&&o.activeView===\"global-lore-list\"&&E.is(\".rlh-book-group\")&&y.closest(\".rlh-book-title-wrapper\").length>0){let z=E.data(\"book-name\");z&&a?.handleEnterLorebookDetail&&await a.handleEnterLorebookDetail(z);return}if(E.hasClass(\"from-card\")||E.hasClass(\"renaming\"))return;let V=E.find(\".rlh-collapsible-content\").first();if(E.is(\".rlh-book-group\")&&o.activeTab!==\"global-lore\"){V.slideToggle(200);return}if(E.is(\".rlh-item-container\")){if(V.is(\":visible\")){V.stop(!0,!0).slideUp(200,()=>{V.off(\"input.rlh\"),V.empty(),V.attr(\"data-entry-mode\",\"collapsed\")}),E.attr(\"data-entry-mode\",\"collapsed\");return}d?.bulk||E.siblings(\".rlh-item-container\").find(\".rlh-collapsible-content:visible\").slideUp(200).empty();let z=E.data(\"type\"),P=E.data(\"id\"),U=E.data(\"searchTerm\"),X=E.attr(\"data-search-term\"),ee=typeof U==\"string\"&&U.length>0?U:typeof X==\"string\"&&X.length>0?X:\"\";if(z===\"lore\"){let me=E.data(\"book-name\"),he=[...ne(me)].find(Ce=>Ce.uid===Number(P));if(!he)return;l.renderLoreEntryViewer(E,he,ee,{animate:!0});return}if(z===\"regex\"){let me=[...o.regexes.global,...o.regexes.character].find(he=>he.id===P);if(!me)return;E.attr(\"data-entry-mode\")===\"edit\"?l.renderRegexEditor(E,me,{animate:!0}):l.renderRegexViewer(E,me,ee,{animate:!0});return}}}),Il=A(async c=>{if(!o.multiSelectMode||r(c.target).closest(\".rlh-item-controls, .rlh-rename-ui, .rlh-action-btn, .rlh-action-btn-icon, .rlh-toggle-btn, .rlh-selection-control, .rlh-multi-select-checkbox, .rlh-item-header, .rlh-global-book-header\").length>0)return;let y=r(c.currentTarget).closest(\".rlh-item-container, .rlh-book-group\");y.length&&x(y)&&(c.stopPropagation(),c.preventDefault())}),Rl=A(async c=>{c.stopPropagation();let d=r(c.currentTarget),y=d.closest(\".rlh-book-group\"),E=!y.hasClass(\"editing-entries\");y.toggleClass(\"editing-entries\"),E?(o.multiSelectMode||(o.multiSelectMode=!0,r(\"#rlh-multi-select-btn\",t).addClass(\"active\"),r(\"#rlh-multi-select-controls\",t).addClass(\"active\"),r(`#${ke}`,t).addClass(\"rlh-multi-select-mode\")),y.find(\".rlh-collapsible-content\").first().slideDown(200),d.attr(\"title\",\"\\u5B8C\\u6210\\u7F16\\u8F91\").find(\"i\").removeClass(\"fa-pen-to-square\").addClass(\"fa-check-square\"),d.addClass(\"active\")):(d.attr(\"title\",\"\\u7F16\\u8F91/\\u9009\\u62E9\\u6761\\u76EE\").find(\"i\").removeClass(\"fa-check-square\").addClass(\"fa-pen-to-square\"),d.removeClass(\"active\"))}),Al=A(async c=>{let y=r(c.currentTarget).find(\"i\");y.addClass(\"fa-spin\");let E=null;o.activeView===\"global-lore-detail\"&&o.activeBookName&&(E=ne(o.activeBookName),console.log(`[RegexLoreHub] \\u5168\\u5C40\\u5237\\u65B0\\u65F6\\u7F13\\u5B58\\u8BE6\\u60C5\\u89C6\\u56FE\\u6761\\u76EE: ${o.activeBookName}`)),et(),await We(!0),E&&o.activeView===\"global-lore-detail\"&&o.activeBookName&&(Oe(o.activeBookName,E),wr(o.activeBookName),console.log(`[RegexLoreHub] \\u6062\\u590D\\u8BE6\\u60C5\\u89C6\\u56FE\\u6761\\u76EE: ${o.activeBookName}`),Ie(o.activeBookName,!0).catch(V=>{console.warn(`[RegexLoreHub] \\u6062\\u590D\\u540E\\u5237\\u65B0\\u6761\\u76EE\\u5931\\u8D25: ${o.activeBookName}`,V)}),se()),setTimeout(()=>y.removeClass(\"fa-spin\"),500)}),Ml=A(async c=>{if(o.activeView===\"global-lore-list\")a?.handleCreateLorebook&&await a.handleCreateLorebook(c);else if(o.activeView===\"global-lore-detail\"){if(!o.activeBookName)return;if(l?.handleCreateEntry){let d={currentTarget:r(`<button data-book-name=\"${o.activeBookName}\"></button>`)};await l.handleCreateEntry(d)}}});return{handleGlobalSearch:C,handleSearchClear:ce,handleSearchInputKeydown:D,handleReplace:q,handleToolbarToggleCollapse:Z,handleSortMenuToggle:M,handleSortOptionSelect:L,handleThemeMenuToggle:ie,handleThemeOptionSelect:ae,handlePositionMenuToggle:br,handlePositionOptionSelect:kt,handleUnifiedStatusMenuToggle:ul,handleUnifiedStatusOptionSelect:bl,handleCharacterBookSwitch:ml,handleSelectionCheckboxChange:fl,togglePanel:xl,switchTab:wl,toggleMultiSelectMode:to,handleSelectAll:Sl,handleSelectNone:_l,handleSelectInvert:El,handleBatchEnable:$l,handleBatchDisable:Tl,handleBatchDelete:Ll,handleCleanOrphanLorebooks:Cl,handleHeaderClick:Nl,handleMultiSelectContainerClick:Il,handleEditEntriesToggle:Rl,handleRefresh:Al,handlePrimaryCreateButtonClick:Ml}}var Xt=e=>!e&&e!==0?\"\":typeof e==\"string\"?e.trim():e&&typeof e==\"object\"&&typeof e.name==\"string\"?e.name.trim():String(e??\"\").trim(),cl=()=>typeof performance<\"u\"&&typeof performance.now==\"function\"?performance.now():Date.now(),dl=()=>({handleSelectUnboundBooks:A(async r=>{if(r?.preventDefault?.(),r?.stopPropagation?.(),o.activeView!==\"global-lore-list\"){ve(\"\\u8BE5\\u64CD\\u4F5C\\u4EC5\\u5728\\u5168\\u5C40\\u4E16\\u754C\\u4E66\\u5217\\u8868\\u89C6\\u56FE\\u53EF\\u7528\",\"info\");return}if(o.activeTab!==\"global-lore\"){ve(\"\\u8BE5\\u64CD\\u4F5C\\u4EC5\\u5728\\u5168\\u5C40\\u4E16\\u754C\\u4E66\\u5217\\u8868\\u53EF\\u7528\",\"info\");return}let t=cl(),{totalBooks:a,unboundNames:l,statsByName:n}=el(),i=Array.isArray(o.allLorebooks)?o.allLorebooks:[],h=typeof o.globalSearch?.term==\"string\"?o.globalSearch.term.trim():\"\",m=h.toLowerCase(),b=Xt(o.activeBookName),v=(!!(m&&m.length)?i.filter(s=>{let g=Xt(s);if(!g)return!1;if(o.searchFilters.bookName&&g.toLowerCase().includes(m))return!0;let C=ne(g);return!Array.isArray(C)||C.length===0?!1:C.some(D=>yr(D,m))}):i).map(s=>{let g=Xt(s);return{book:s,name:g}}).filter(({name:s})=>typeof s==\"string\"&&s.length>0),w=v.map(({name:s})=>s),T=v.filter(({book:s,name:g})=>{if(!g||b&&g===b||s&&s.enabled)return!1;if(l.has(g))return!0;let x=n.get(g);return x?x.bindingCount===0:!1}).map(({name:s})=>s);if(T.length===0){ve(\"\\u6CA1\\u6709\\u672A\\u7ED1\\u5B9A\\u7684\\u4E16\\u754C\\u4E66\",\"info\"),Mt({category:\"lorebook\",action:\"select_unbound\",value:0,label:\"global_unbound_select\",feature:\"select_unbound_lorebooks\",view:o.activeView,meta:{searchTerm:h,visibleBookCount:w.length,totalBookCount:a,unboundTotal:l.size}});return}o.multiSelectMode=!0,o.multiSelectTarget=\"book\",o.selectedItems.clear(),T.forEach(s=>{let g=Ze(s);g&&o.selectedItems.add(g)});let k=cl(),I=Math.max(0,Math.round(k-t));se(),ve(`\\u5DF2\\u9009\\u4E2D ${T.length} \\u672C\\u672A\\u7ED1\\u5B9A\\u7684\\u4E16\\u754C\\u4E66\\uFF0C\\u8BF7\\u786E\\u8BA4\\u8FD9\\u4E9B\\u4E16\\u754C\\u4E66\\u672A\\u5728\\u804A\\u5929\\u4E2D\\u4F7F\\u7528\\uFF0C\\u907F\\u514D\\u8BEF\\u5220\\u804A\\u5929\\u4E16\\u754C\\u4E66\\u3002`,\"success\"),console.log(`[RegexLoreHub] \\u9009\\u62E9\\u5B64\\u7ACB\\u4E16\\u754C\\u4E66\\uFF1A\\u5339\\u914D ${T.length} / \\u53EF\\u89C1 ${w.length} / \\u5168\\u91CF ${a}\\uFF0C\\u8017\\u65F6 ${I}ms\\u3002`),Mt({category:\"lorebook\",action:\"select_unbound\",value:T.length,label:\"global_unbound_select\",feature:\"select_unbound_lorebooks\",view:o.activeView,meta:{searchTerm:h,visibleBookCount:w.length,totalBookCount:a,unboundTotal:l.size,selectionCount:T.length,durationMs:I}})})});function hl(){let e=xe(),r=we(),t=$e(),a={$:e,parentDoc:r,parentWin:t},l=al(a),n=nl(a),i=sl({...a,lorebookHandlers:l,itemHandlers:n}),h=dl();return{...l,...n,...i,...h}}var Jt=`\n/*! tailwindcss v4.1.13 | MIT License | https://tailwindcss.com */\n@layer theme{:root,:host{--rlh-default-transition-duration:.15s;--rlh-default-transition-timing-function:cubic-bezier(.4,0,.2,1)}}@layer utilities;@layer base{#regex-lore-hub-panel *{text-shadow:none!important}#regex-lore-hub-panel{--rlh-panel-radius:20px;--rlh-focus-ring:0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-focus-ring:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}#regex-lore-hub-panel{--rlh-bg-color:#f5f7fb;--rlh-surface-color:#fffd;--rlh-text-color:#0f172a;--rlh-em-color:#475569;--rlh-border-color:#bfc8f5;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)12%,transparent)}}#regex-lore-hub-panel{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)20%,transparent)}}#regex-lore-hub-panel{--rlh-shadow-color:#0f172a2e;--rlh-header-bg:#eef2ffd9;--rlh-input-bg:#ffffffeb;--rlh-accent-color:#4f46e5;--rlh-green:#10b981;--rlh-red:#ef4444;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)18%,transparent)}}#regex-lore-hub-panel{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)18%,transparent)}}#regex-lore-hub-panel{--rlh-status-constant:#22c55e;--rlh-status-selective:#3b82f6;--rlh-status-vectorized:#a855f7}#regex-lore-hub-panel.dark{--rlh-bg-color:#101827;--rlh-surface-color:#111827cc;--rlh-text-color:#f9fafb;--rlh-em-color:#cbd5e1;--rlh-border-color:#2d3748;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)14%,transparent)}}#regex-lore-hub-panel.dark{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)22%,transparent)}}#regex-lore-hub-panel.dark{--rlh-shadow-color:#02061780;--rlh-header-bg:#0f172ae6;--rlh-input-bg:#1f2937d9;--rlh-accent-color:#6366f1;--rlh-green:#10b981;--rlh-red:#fb7185;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)20%,transparent)}}#regex-lore-hub-panel.dark{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)20%,transparent)}}#regex-lore-hub-panel.dark{--rlh-status-constant:#34d399;--rlh-status-selective:#60a5fa;--rlh-status-vectorized:#c084fc}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-bg-color:#f9f5d7;--rlh-surface-color:#fbf1c7eb;--rlh-text-color:#3c3836;--rlh-em-color:#7c6f64;--rlh-border-color:#d5ab7e;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)16%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)26%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-shadow-color:#3c383633;--rlh-header-bg:#ebdbb2d9;--rlh-input-bg:#fbf1c7e6;--rlh-accent-color:#d65d0e;--rlh-green:#98971a;--rlh-red:#cc241d;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)18%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)18%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-status-constant:#98971a;--rlh-status-selective:#458588;--rlh-status-vectorized:#b16286}@keyframes rlhFadeInUp{0%{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}@keyframes rlhSoftPulse{}@keyframes rlhToastIn{0%{opacity:0;transform:translate(-50%)translateY(28px)scale(.96)}60%{opacity:1;transform:translate(-50%)translateY(-4px)scale(1.02)}to{opacity:1;transform:translate(-50%)translateY(0)scale(1)}}@keyframes rlhHighlightPulse{0%{background-color:#fde68a}50%{background-color:#facc15}to{background-color:#fde68a}}}@layer components{#regex-lore-hub-panel{z-index:10000;width:100%;height:100dvh;min-height:100svh;color:var(--rlh-text-color);background:var(--rlh-bg-color);justify-content:center;align-items:center;padding:clamp(.8rem,1.5vw,1.3rem);display:none;position:fixed;inset:0}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{background:color-mix(in srgb,var(--rlh-bg-color)92%,transparent)}}#regex-lore-hub-panel{-webkit-backdrop-filter:blur(24px);backdrop-filter:blur(24px);font-family:Inter,Segoe UI,Microsoft YaHei,sans-serif;transition:opacity .25s}@media (max-width:1024px){#regex-lore-hub-panel{justify-content:flex-start;align-items:stretch}}#regex-lore-hub-panel .rlh-shell{border-radius:var(--rlh-panel-radius);background:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);width:min(1250px,100%);height:100%;box-shadow:0 32px 120px -60px var(--rlh-shadow-color);flex-direction:column;gap:clamp(.45rem,1vw,.75rem);margin:0 auto;padding:clamp(.75rem,1.4vw,1.15rem);animation:.3s ease-out both rlhFadeInUp;display:flex;position:relative;overflow:hidden}#regex-lore-hub-panel .rlh-shell:before{content:\"\";background:radial-gradient(circle at top right,var(--rlh-accent-color)0%,transparent 60%),radial-gradient(circle at bottom left,var(--rlh-green)0%,transparent 65%);position:absolute;inset:-140px}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-shell:before{background:radial-gradient(circle at top right,color-mix(in srgb,var(--rlh-accent-color)24%,transparent)0%,transparent 60%),radial-gradient(circle at bottom left,color-mix(in srgb,var(--rlh-green)18%,transparent)0%,transparent 65%)}}#regex-lore-hub-panel .rlh-shell:before{opacity:.32;pointer-events:none}@media (max-width:768px){#regex-lore-hub-panel .rlh-shell{border-radius:14px;padding:.55rem}}@media (min-width:1360px){#regex-lore-hub-panel .rlh-shell{border-radius:20px;padding:1.05rem 1.3rem}}.rlh-shell-header{justify-content:space-between;align-items:center;gap:.55rem;padding-block:.08rem;display:flex}.rlh-shell-title{flex-direction:column;gap:.18rem;display:flex}.rlh-shell-title h4{color:var(--rlh-text-color);margin:0;font-size:clamp(1rem,2vw,1.3rem);font-weight:600;line-height:1.2}.rlh-shell-meta{color:var(--rlh-em-color);align-items:center;gap:.35rem;font-size:max(.8125rem,13px);line-height:1.2;display:inline-flex;margin:0!important}.rlh-shell-version{background:var(--rlh-accent-color);border-radius:9999px;align-items:center;padding:.1rem .55rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-shell-version{background:color-mix(in srgb,var(--rlh-accent-color)16%,transparent)}}.rlh-shell-version{color:var(--rlh-text-color);font-size:.78rem;font-weight:600}.rlh-shell-dot{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-shell-dot{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-shell-dot{font-size:max(.8125rem,13px);line-height:1}.rlh-shell-updated{color:var(--rlh-em-color);font-size:.78rem}.rlh-shell-actions{align-items:center;gap:.4rem;display:flex}.rlh-shell-right{align-items:center;gap:.6rem;margin-left:auto;display:flex}.rlh-prefetch-indicator{text-align:right;flex-direction:column;align-items:flex-end;gap:.35rem;width:clamp(200px,34vw,320px);display:none}.rlh-prefetch-indicator[data-visible=true]{display:flex}.rlh-prefetch-text{color:var(--rlh-em-color);white-space:normal;font-size:.78rem}#rlh-prefetch-progress-text{width:100%}.rlh-prefetch-bar{background:var(--rlh-accent-color);border-radius:9999px;width:100%;height:4px;position:relative}@supports (color:color-mix(in lab, red, red)){.rlh-prefetch-bar{background:color-mix(in srgb,var(--rlh-accent-color)20%,transparent)}}.rlh-prefetch-bar{overflow:hidden}.rlh-prefetch-bar-inner{border-radius:inherit;background:var(--rlh-accent-color);width:0%;height:100%;transition:width .25s;display:block}.rlh-icon-button,.rlh-close-button{width:2.25rem;height:2.25rem;color:var(--rlh-text-color);cursor:pointer;background-color:#0000;border:1px solid #0000;border-radius:9999px;justify-content:center;align-items:center;transition:color .2s,background-color .2s,border-color .2s;display:inline-flex}.rlh-icon-button:hover,.rlh-close-button:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-icon-button:hover,.rlh-close-button:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-theme-toggle{border:1px solid var(--rlh-accent-color);border-radius:9999px;align-items:center;gap:.35rem;padding:.4rem .9rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle{border:1px solid color-mix(in srgb,var(--rlh-accent-color)28%,transparent)}}.rlh-theme-toggle{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle{background-color:color-mix(in srgb,var(--rlh-accent-color)12%,transparent)}}.rlh-theme-toggle{color:var(--rlh-text-color);cursor:pointer;font-size:.85rem;font-weight:500;transition:background-color .2s,color .2s,border-color .2s}.rlh-theme-toggle:hover{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)18%,transparent)}}.rlh-theme-toggle .rlh-theme-toggle-label{white-space:nowrap}.rlh-theme-toggle-caret{margin-left:.45rem;font-size:.78rem;transition:transform .2s}.rlh-theme-menu{align-items:center;display:inline-flex;position:relative}.rlh-theme-menu-list{min-width:12rem;padding:.55rem}.rlh-theme-option{justify-content:space-between;align-items:center;gap:.6rem;width:100%;padding:.45rem .65rem;display:flex}.rlh-theme-option-text{flex-direction:column;align-items:flex-start;gap:.18rem;display:flex}.rlh-theme-option-meta{color:var(--rlh-em-color);font-size:.78rem}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option-meta{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-theme-option-check{color:var(--rlh-accent-color);opacity:0;transition:opacity .18s,transform .18s;transform:scale(.92)}.rlh-theme-option[data-active=true] .rlh-theme-option-check{opacity:1;transform:scale(1)}.rlh-theme-option[data-active=true]{background-color:var(--rlh-selected-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option[data-active=true]{background-color:color-mix(in srgb,var(--rlh-selected-bg)72%,transparent)}}.rlh-theme-option[data-active=true]{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option[data-active=true]{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-theme-option[data-active=true]{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option[data-active=true]{color:color-mix(in srgb,var(--rlh-text-color)88%,var(--rlh-accent-color)12%)}}.rlh-theme-option[data-active=true] .rlh-theme-option-meta{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option[data-active=true] .rlh-theme-option-meta{color:color-mix(in srgb,var(--rlh-em-color)65%,var(--rlh-accent-color)20%)}}.rlh-theme-menu.open .rlh-theme-toggle-caret{transform:rotate(180deg)}.rlh-tab-nav{background-color:var(--rlh-header-bg);flex-wrap:wrap;gap:.4rem;padding:.35rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-tab-nav{background-color:color-mix(in srgb,var(--rlh-header-bg)85%,transparent)}}.rlh-tab-nav{border:1px solid var(--rlh-border-color);border-radius:9999px}@supports (color:color-mix(in lab, red, red)){.rlh-tab-nav{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-tab{color:var(--rlh-em-color);cursor:pointer;border-radius:9999px;justify-content:center;align-items:center;gap:.55rem;padding:.4rem 1.1rem;font-size:.9rem;font-weight:500;transition:color .2s,background-color .2s,transform .2s;display:inline-flex}.rlh-tab:hover{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color)}.rlh-tab.active{background-color:var(--rlh-selected-bg);color:var(--rlh-text-color);box-shadow:inset 0 0 0 1px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-tab.active{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)60%,transparent)}}.rlh-tab-text-short{display:none}@media (max-width:640px){.rlh-tab-text-full{display:none}.rlh-tab-text-short{display:inline}}.rlh-main-area{flex-direction:column;flex:auto;gap:clamp(.6rem,1.4vw,1rem);width:100%;min-height:0;padding:0;display:flex}.rlh-toolbar-shell{flex-direction:column;gap:clamp(.6rem,1.3vw,.95rem);width:100%;display:flex}.rlh-toolbar-container,.rlh-replace-container{flex-direction:column;gap:clamp(.65rem,1.1vw,.9rem);display:flex}.rlh-toolbar-inner{background-color:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:clamp(.125rem,.3vw,.25rem);padding:clamp(.25rem,.5vw,.4rem);display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{background-color:color-mix(in srgb,var(--rlh-surface-color)95%,var(--rlh-accent-color)5%)}}.rlh-toolbar-inner{border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{border:1px solid color-mix(in srgb,var(--rlh-accent-color)24%,var(--rlh-border-color))}}.rlh-toolbar-inner{box-shadow:0 16px 42px -34px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{box-shadow:0 16px 42px -34px color-mix(in srgb,var(--rlh-shadow-color)78%,transparent)}}@media (max-width:768px){.rlh-toolbar-inner{border-radius:14px;padding:.55rem}.rlh-toolbar-section{gap:.4rem;padding:.45rem}}@media (min-width:1360px){.rlh-toolbar-inner{gap:1.1rem;padding:1.05rem 1.3rem}.rlh-toolbar-section{gap:.8rem;padding:.6rem .8rem}}.rlh-toolbar-section{background-color:#0000;border:none;border-radius:12px;flex-direction:column;gap:clamp(.1rem,.3vw,.2rem);padding:clamp(.1rem,.25vw,.2rem);display:flex}.rlh-toolbar-section--search,.rlh-toolbar-section--actions,.rlh-toolbar-section--multiselect{background-color:#0000}.rlh-toolbar-section--actions{flex-direction:row;align-items:center}.rlh-search-section-grid{flex-wrap:nowrap;align-items:stretch;gap:clamp(.25rem,.7vw,.5rem);display:flex}.rlh-search-section-main{flex:18rem;min-width:0}.rlh-search-section-multiselect{flex:0 14rem;justify-content:flex-start;align-items:flex-start;min-width:10rem;max-width:20rem;padding:5px 0 0;display:flex}.rlh-search-section-multiselect .rlh-multi-select-module{flex-direction:column;align-items:flex-start;gap:.25rem;width:100%;display:flex}.rlh-toolbar-section--actions .rlh-toolbar-actions{flex-wrap:wrap;justify-content:flex-start;align-items:center;gap:clamp(.25rem,.6vw,.45rem);width:100%;display:flex;overflow:visible}.rlh-toolbar-section--actions .rlh-toolbar-actions>*{flex-shrink:0}@media (max-width:960px){.rlh-search-section-grid{flex-direction:column}.rlh-search-section-main,.rlh-search-section-multiselect{flex:100%;max-width:none}.rlh-search-box{grid-template-columns:minmax(0,1fr);grid-template-areas:\"row\"\"replace\"\"meta\"}.rlh-replace-body{grid-template-columns:minmax(0,1fr) auto}}.rlh-content-pane{flex-direction:column;flex:auto;gap:clamp(.8rem,1.6vw,1.2rem);min-height:0;padding:0;display:flex}.rlh-content-pane>*{min-width:0}@media (max-width:768px){.rlh-content-pane{gap:.6rem}}.rlh-toolbar-btn{border:1px solid var(--rlh-accent-color);border-radius:12px;justify-content:flex-start;align-items:center;gap:.35rem;padding:.125rem .75rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{border:1px solid color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}.rlh-toolbar-btn{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-toolbar-btn{color:var(--rlh-text-color);cursor:pointer;box-shadow:inset 0 0 0 1px var(--rlh-accent-color);font-size:.9rem;font-weight:500}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)25%,transparent)}}.rlh-toolbar-btn{transition:color .2s,background-color .2s,border-color .2s,box-shadow .2s,transform .2s}.rlh-toolbar-icon-btn{border:1px solid var(--rlh-accent-color);border-radius:12px;justify-content:center;align-items:center;width:2.1rem;height:2.1rem;padding:0;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{border:1px solid color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}.rlh-toolbar-icon-btn{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-toolbar-icon-btn{color:var(--rlh-text-color);cursor:pointer;line-height:1;transition:color .2s,background-color .2s,border-color .2s,box-shadow .2s,transform .2s}.rlh-toolbar-icon-btn i{font-size:.95rem}.rlh-toolbar-icon-btn:hover{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)92%,var(--rlh-accent-color)20%)}}.rlh-toolbar-icon-btn:hover{color:var(--rlh-text-color)}.rlh-toolbar-icon-btn:focus{box-shadow:0 0 0 2px var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:focus{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-search-row .rlh-toolbar-icon-btn,.rlh-replace-body .rlh-toolbar-icon-btn{width:2rem;height:2rem}.rlh-toolbar-btn i{font-size:.95rem}.rlh-toggle-btn i,.rlh-action-btn-icon i,.rlh-toolbar-btn i{transition:transform .25s}.rlh-toolbar-btn span{white-space:nowrap}.rlh-toggle-btn:hover i,.rlh-action-btn-icon:hover i,.rlh-toolbar-btn:hover i{transform:translateY(-1px)scale(1.08)}.rlh-toolbar-group--leading .rlh-toolbar-btn,.rlh-toolbar-group--actions .rlh-toolbar-btn{width:100%}.rlh-toolbar-btn:hover{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)26%,var(--rlh-surface-color))}}.rlh-toolbar-btn:hover{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-border-color)30%)}}.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px var(--rlh-accent-color),0 10px 22px -16px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent),0 10px 22px -16px var(--rlh-shadow-color)}}.rlh-toolbar-btn:hover{color:var(--rlh-text-color);transform:translateY(-1px)scale(1.01)}.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{cursor:not-allowed;opacity:.55;box-shadow:none;border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{border-color:color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{color:color-mix(in srgb,var(--rlh-text-color)55%,var(--rlh-surface-color)45%)}}.rlh-toolbar-btn:focus-visible{box-shadow:0 0 0 2px var(--rlh-accent-color),inset 0 0 0 1.5px var(--rlh-accent-color);outline:none;animation:1.1s ease-out rlhSoftPulse}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:focus-visible{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)40%,transparent),inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-toolbar-btn.active{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{background-color:color-mix(in srgb,var(--rlh-accent-color)32%,var(--rlh-surface-color))}}.rlh-toolbar-btn.active{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{border-color:color-mix(in srgb,var(--rlh-accent-color)75%,var(--rlh-border-color)25%)}}.rlh-toolbar-btn.active{box-shadow:inset 0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)50%,transparent)}}.rlh-toolbar-btn.active{color:var(--rlh-text-color)}#regex-lore-hub-panel .rlh-toolbar-btn,#regex-lore-hub-panel .rlh-toolbar-btn:hover,#regex-lore-hub-panel .rlh-toolbar-btn.active{color:var(--rlh-text-color)!important}#regex-lore-hub-panel .rlh-toolbar-btn:disabled,#regex-lore-hub-panel .rlh-toolbar-btn.disabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-toolbar-btn:disabled,#regex-lore-hub-panel .rlh-toolbar-btn.disabled{color:color-mix(in srgb,var(--rlh-text-color)55%,var(--rlh-surface-color)45%)}}#regex-lore-hub-panel .rlh-toolbar-icon-btn,#regex-lore-hub-panel .rlh-action-btn-icon,#regex-lore-hub-panel .rlh-toggle-btn,#regex-lore-hub-panel .rlh-icon-button,#regex-lore-hub-panel .rlh-close-button{color:var(--rlh-text-color)!important}.rlh-search-field{border:1px solid var(--rlh-border-color);border-radius:12px;align-items:center;gap:0;width:100%;min-width:0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-field{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-field{background-color:var(--rlh-input-bg);transition:border-color .2s,box-shadow .2s,color .2s;overflow:hidden}.rlh-search-row{grid-area:row;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:.125rem;width:100%;display:grid}.rlh-search-box{border:1px solid var(--rlh-border-color);border-radius:12px;grid-template-columns:minmax(0,1fr) auto;grid-template-areas:\"row replace\"\"meta meta\";gap:.125rem;padding:.2rem .3rem;display:grid}@supports (color:color-mix(in lab, red, red)){.rlh-search-box{border:1px solid color-mix(in srgb,var(--rlh-border-color)45%,transparent)}}.rlh-search-box{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-box{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,transparent)}}.rlh-search-box{box-shadow:0 8px 28px -24px var(--rlh-shadow-color)}.rlh-search-field .rlh-search-input{min-width:0;color:inherit;background:0 0;border:none;flex:auto;padding:.4rem .6rem;font-size:1rem}.rlh-search-field .rlh-search-input:focus{box-shadow:none;border:none;outline:none}.rlh-search-field:focus-within{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-field:focus-within{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-search-field:focus-within{box-shadow:var(--rlh-focus-ring);color:var(--rlh-text-color)}.rlh-search-meta{color:var(--rlh-em-color);flex-direction:row;grid-area:meta;align-items:center;gap:.4rem;font-size:.85rem;display:flex}.rlh-search-scope{color:var(--rlh-accent-color);font-weight:500}@supports (color:color-mix(in lab, red, red)){.rlh-search-scope{color:color-mix(in srgb,var(--rlh-accent-color)65%,var(--rlh-text-color))}}@media (max-width:1200px){.rlh-search-section-grid{flex-direction:column}.rlh-search-section-main,.rlh-search-section-multiselect{flex:100%;max-width:none}.rlh-search-box{grid-template-columns:minmax(0,1fr);grid-template-areas:\"row\"\"replace\"\"meta\"}.rlh-replace-body{grid-template-columns:minmax(0,1fr) auto}.rlh-search-meta{flex-wrap:wrap;justify-content:flex-start;gap:.35rem}}.rlh-sort-menu,.rlh-position-menu{align-items:center;width:auto;min-width:0;margin-left:auto;display:inline-flex;position:relative}.rlh-unified-status{align-items:stretch;min-width:0;display:inline-flex;position:relative}.rlh-unified-status-menu{border:1px solid var(--rlh-border-color);border-radius:12px;flex-direction:column;gap:.15rem;min-width:12rem;padding:.5rem;display:flex;position:absolute;top:calc(100% + .5rem);right:0}@supports (color:color-mix(in lab, red, red)){.rlh-unified-status-menu{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-unified-status-menu{background:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-unified-status-menu{background:color-mix(in srgb,var(--rlh-surface-color)95%,transparent)}}.rlh-unified-status-menu{box-shadow:0 24px 60px -28px var(--rlh-shadow-color);opacity:0;pointer-events:none;z-index:30;transition:opacity .18s,transform .18s;transform:translateY(8px)}.rlh-unified-status[data-open=true] .rlh-unified-status-menu{opacity:1;pointer-events:auto;transform:translate(0)}.rlh-unified-status-option{width:100%;color:inherit;cursor:pointer;background:0 0;border:none;border-radius:10px;justify-content:space-between;align-items:center;gap:.6rem;padding:.45rem .5rem;font-size:.85rem;font-weight:500;transition:background-color .18s,color .18s;display:flex}.rlh-unified-status-option:hover,.rlh-unified-status-option:focus-visible{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-unified-status-option:hover,.rlh-unified-status-option:focus-visible{background:color-mix(in srgb,var(--rlh-hover-bg)75%,transparent)}}.rlh-unified-status-option:hover,.rlh-unified-status-option:focus-visible{outline:none}.rlh-unified-status-option__label{text-align:right;flex:auto;min-width:0}.rlh-sort-menu-list,.rlh-position-menu-list{background-color:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);border-radius:14px;min-width:10rem;padding:.5rem;list-style:none;position:absolute;top:calc(100% + .5rem);right:0}@supports (color:color-mix(in lab, red, red)){.rlh-sort-menu-list,.rlh-position-menu-list{border:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-sort-menu-list,.rlh-position-menu-list{box-shadow:0 24px 60px -36px var(--rlh-shadow-color);z-index:99;opacity:0;visibility:hidden;pointer-events:none;transition:opacity var(--rlh-default-transition-duration)var(--rlh-default-transition-timing-function),transform var(--rlh-default-transition-duration)var(--rlh-default-transition-timing-function),visibility 0s linear var(--rlh-default-transition-duration);will-change:opacity,transform;flex-direction:column;gap:.35rem;display:flex;transform:translateY(6px)scale(.98)}.rlh-toolbar-group--actions .rlh-sort-menu-list,.rlh-toolbar-group--actions .rlh-position-menu-list{left:0;right:auto}.rlh-sort-menu.open .rlh-sort-menu-list,.rlh-position-menu.open .rlh-position-menu-list{opacity:1;visibility:visible;pointer-events:auto;transition-delay:0s,0s,0s;transform:translateY(0)scale(1)}.rlh-sort-option,.rlh-position-option{width:100%;color:var(--rlh-text-color);cursor:pointer;background-color:#0000;border:1px solid #0000;border-radius:10px;justify-content:space-between;align-items:center;gap:.4rem;padding:.4rem .6rem;font-size:.9rem;transition:background-color .2s,border-color .2s,color .2s;display:flex}.rlh-sort-option:hover,.rlh-position-option:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option:hover,.rlh-position-option:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-sort-option.active,.rlh-position-option.active{background-color:var(--rlh-selected-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option.active,.rlh-position-option.active{border-color:color-mix(in srgb,var(--rlh-accent-color)60%,transparent)}}.rlh-sort-option.active,.rlh-position-option.active{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option.active,.rlh-position-option.active{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-replace-body{grid-area:replace;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:.25rem;width:100%;display:grid}.rlh-info-text{color:var(--rlh-em-color);font-size:.9rem}@supports (color:color-mix(in lab, red, red)){.rlh-info-text{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-info-text{margin:.5rem 0}.rlh-info-text-small{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}@supports (color:color-mix(in lab, red, red)){.rlh-info-text-small{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-chat-lore-empty{text-align:center;background-color:var(--rlh-hover-bg);border-radius:16px;flex-direction:column;justify-content:center;align-items:center;gap:1rem;padding:2rem 1.5rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-chat-lore-empty{background-color:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}.rlh-chat-lore-empty{border:1px dashed var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-chat-lore-empty{border:1px dashed color-mix(in srgb,var(--rlh-border-color)75%,transparent)}}.rlh-detail-view{background-color:var(--rlh-surface-color);border-radius:18px;flex-direction:column;gap:.6rem;padding:.6rem .8rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-detail-view{background-color:color-mix(in srgb,var(--rlh-surface-color)94%,transparent)}}.rlh-detail-view{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-detail-view{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-detail-view{box-shadow:0 24px 70px -50px var(--rlh-shadow-color)}@media (max-width:768px){.rlh-detail-view{gap:.6rem;padding:.6rem .8rem}.rlh-detail-header{gap:.4rem;padding:.4rem .6rem}.rlh-detail-content{gap:.4rem}.rlh-entry-list-wrapper{gap:.4rem;padding:.4rem 0}.rlh-detail-header h2{font-size:1rem;line-height:1.1}}.rlh-detail-header{grid-template-columns:auto 1fr auto;align-items:center;gap:.4rem;padding:.4rem .6rem;display:grid}.rlh-detail-header h2{color:var(--rlh-text-color);text-align:center;white-space:nowrap;text-overflow:ellipsis;min-width:0;margin:0;padding-inline:.5rem;font-size:1.1rem;font-weight:600;overflow:hidden}.rlh-detail-header .rlh-back-to-list-btn{justify-self:start}.rlh-detail-header .rlh-item-controls{justify-self:end;align-items:center;gap:.4rem;display:inline-flex}.rlh-detail-content,.rlh-entry-list-wrapper{flex-direction:column;gap:.4rem;display:flex}.rlh-entry-list-wrapper .rlh-item-container{animation:.3s ease-out both rlhFadeListItem}@keyframes rlhFadeListItem{0%{opacity:0;transform:translateY(6px)scale(.95)}to{opacity:1;transform:translateY(0)scale(1)}}.rlh-regex-list{flex-direction:column;gap:.45rem;display:flex;position:relative}.rlh-regex-list.sorting-active{border:1.5px dashed var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{border:1.5px dashed color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}.rlh-regex-list.sorting-active{box-shadow:0 0 0 3px var(--rlh-accent-color),0 20px 50px -30px var(--rlh-shadow-color);border-radius:14px;padding:.35rem .45rem}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-accent-color)12%,transparent),0 20px 50px -30px var(--rlh-shadow-color)}}.rlh-regex-list.sorting-active{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{background:color-mix(in srgb,var(--rlh-hover-bg)45%,transparent)}}.rlh-regex-list.sorting-active .rlh-item-container{border-radius:12px}.rlh-regex-list .sortable-ghost{opacity:.2;transform:scale(.98)}.rlh-regex-list .sortable-chosen{box-shadow:0 18px 40px -28px var(--rlh-shadow-color);transform:rotate(.4deg)}.rlh-sorting-fallback{opacity:.7!important;transform:scale(1.02)!important}.rlh-entry-list-wrapper>*{margin:0}.rlh-order-indicator{background-color:var(--rlh-hover-bg);min-width:1.75rem;color:var(--rlh-accent-color);border-radius:9999px;justify-content:center;align-items:center;padding:.1rem .5rem;font-size:max(.8125rem,13px);font-weight:600;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-order-indicator{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-selection-control{justify-content:center;align-items:center;margin-right:.35rem;display:inline-flex}.rlh-selection-control input{cursor:pointer;width:1rem;height:1rem;accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-selection-control input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}.rlh-drag-handle{color:var(--rlh-em-color);justify-content:center;align-items:center;margin-right:.35rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-drag-handle{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-drag-handle{cursor:grab}.rlh-drag-handle:active{cursor:grabbing}.rlh-editor-group{border-top:1px solid var(--rlh-border-color);flex-direction:column;gap:.6rem;padding:.75rem 0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-editor-group{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-editor-group:first-of-type{border-top:none;padding-top:0}.rlh-editor-group h5{color:var(--rlh-em-color);font-size:.85rem;font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-editor-group h5{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-editor-grid{grid-template-columns:repeat(auto-fit,minmax(14rem,1fr));gap:.6rem;display:grid}.rlh-grid-item,.rlh-depth-container{flex-direction:column;gap:.4rem;display:flex}.rlh-depth-inputs{flex-wrap:wrap;gap:.6rem;display:flex}.rlh-editor-options-row{flex-wrap:wrap;gap:.4rem;display:flex}.rlh-editor-option-item{background-color:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.35rem;padding:.35rem .65rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-editor-option-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}.rlh-editor-option-item{color:var(--rlh-em-color);font-size:.85rem}.rlh-editor-option-item input{accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-editor-option-item input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}.rlh-select-nudge{min-width:8rem}.rlh-rename-ui{width:100%}.rlh-rename-input-wrapper{border:1px solid var(--rlh-border-color);border-radius:12px;align-items:center;gap:.4rem;width:100%;padding:.4rem .6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-rename-input-wrapper{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-rename-input-wrapper{background-color:var(--rlh-input-bg)}.rlh-rename-input{color:var(--rlh-text-color);background:0 0;border:none;outline:none;flex:1;font-size:.9rem}.rlh-rename-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)75%,transparent)}}.rlh-rename-save-btn{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-save-btn{border-color:color-mix(in srgb,var(--rlh-green)55%,transparent)}}.rlh-rename-cancel-btn{color:var(--rlh-red);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-cancel-btn{border-color:color-mix(in srgb,var(--rlh-red)55%,transparent)}}.rlh-global-toggle,.rlh-item-toggle{transition:background-color .2s,border-color .2s,color .2s}.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{border-color:color-mix(in srgb,var(--rlh-green)65%,transparent)}}.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{background-color:var(--rlh-green-bg)}.rlh-clickable-header{cursor:pointer}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{box-shadow:0 36px 120px -60px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{box-shadow:0 36px 120px -60px color-mix(in srgb,var(--rlh-accent-color)30%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{color:color-mix(in srgb,var(--rlh-accent-color)65%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{font-size:max(.8125rem,13px)}.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{box-shadow:0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-item-container.rlh-collapsed .rlh-item-header,.rlh-book-group.rlh-collapsed .rlh-global-book-header{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.rlh-collapsed .rlh-item-header,.rlh-book-group.rlh-collapsed .rlh-global-book-header{background-color:color-mix(in srgb,var(--rlh-hover-bg)45%,transparent)}}.sortable-ghost{opacity:.75;background-color:var(--rlh-selected-bg)}@supports (color:color-mix(in lab, red, red)){.sortable-ghost{background-color:color-mix(in srgb,var(--rlh-selected-bg)85%,transparent)}}.sortable-ghost{border:1px dashed var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.sortable-ghost{border:1px dashed color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}.rlh-search-controls{flex-wrap:wrap;align-items:center;gap:.7rem;display:flex}#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{border:1px solid var(--rlh-border-color);border-radius:12px;width:100%;min-width:0;padding:.4rem .6rem}@supports (color:color-mix(in lab, red, red)){#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);font-size:1rem;transition:border-color .2s,box-shadow .2s}#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{box-shadow:var(--rlh-focus-ring)}#rlh-search-input::placeholder,.rlh-search-input::placeholder,#rlh-replace-input::placeholder,.rlh-replace-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){#rlh-search-input::placeholder,.rlh-search-input::placeholder,#rlh-replace-input::placeholder,.rlh-replace-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-multi-select-module{flex-direction:column;align-items:flex-start;gap:.25rem;display:flex}.rlh-search-action-btn,.rlh-multi-select-action-btn{border:1px solid var(--rlh-border-color);border-radius:10px;justify-content:center;align-items:center;gap:.2rem;padding:.3rem .5rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-action-btn,.rlh-multi-select-action-btn{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-action-btn,.rlh-multi-select-action-btn{color:var(--rlh-text-color);cursor:pointer;background:0 0;font-size:.78rem;line-height:1;transition:color .2s,background-color .2s,border-color .2s,transform .2s}.rlh-multi-select-action-btn:active{transform:scale(.95)}.rlh-search-action-btn:hover,.rlh-multi-select-action-btn:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-action-btn:hover,.rlh-multi-select-action-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-multi-select-actions{flex-wrap:nowrap;align-items:center;gap:.3rem;display:inline-flex}.rlh-multi-select-action-btn.enable{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.enable{border-color:color-mix(in srgb,var(--rlh-green)60%,transparent)}}.rlh-multi-select-action-btn.enable{background-color:var(--rlh-green-bg)}.rlh-multi-select-action-btn.disable{color:var(--rlh-red);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.disable{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-multi-select-action-btn.disable{background-color:var(--rlh-red-bg)}#rlh-search-filters-container,.rlh-filter-list{flex-wrap:wrap;gap:.6rem;display:flex}.rlh-filter-item{background-color:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.4rem;padding:.4rem .65rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)65%,transparent)}}.rlh-filter-item{color:var(--rlh-em-color);font-size:.85rem}.rlh-filter-item input{accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}#rlh-multi-select-controls{align-items:center;gap:.35rem;display:none}#rlh-multi-select-controls.active{flex-wrap:wrap;display:flex}@media (max-width:960px){.rlh-multi-select-module{align-items:stretch;gap:.35rem}#rlh-multi-select-controls{flex-wrap:wrap;justify-content:flex-start;align-items:flex-start}.rlh-multi-select-actions{flex-wrap:wrap;justify-content:flex-start}}.rlh-content-pane{-webkit-overflow-scrolling:touch;scrollbar-gutter:stable both-edges;flex-direction:column;flex:auto;gap:1rem;min-height:0;padding-right:.25rem;display:flex;overflow:hidden auto}#regex-lore-hub-panel-content{-webkit-overflow-scrolling:touch;scrollbar-gutter:stable both-edges;scroll-behavior:smooth;flex:auto;min-height:clamp(18rem,48vh,32rem);padding-right:clamp(.25rem,.8vw,.5rem);display:block;overflow:hidden auto}#regex-lore-hub-panel-content>*+*{margin-top:clamp(.8rem,1.4vw,1.1rem)}#regex-lore-hub-panel-content::-webkit-scrollbar{width:6px}#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{background-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{border-radius:9999px}.rlh-book-group,.rlh-item-container{border:1px solid var(--rlh-border-color);border-radius:16px;flex-direction:column;min-height:0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-book-group,.rlh-item-container{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{background-color:color-mix(in srgb,var(--rlh-surface-color)94%,transparent)}}.rlh-book-group,.rlh-item-container{box-shadow:0 18px 50px -40px var(--rlh-shadow-color);overflow:hidden}.rlh-book-group-header{justify-content:center;align-items:center;padding:.85rem 1rem;display:flex;position:relative}.rlh-book-group-title{color:var(--rlh-text-color);text-align:center;white-space:nowrap;text-overflow:ellipsis;max-width:calc(100% - 8rem);margin:0;font-size:1.1rem;font-weight:600;overflow:hidden}.rlh-book-group-header .rlh-item-controls{align-items:center;gap:.4rem;display:inline-flex;position:absolute;top:50%;right:1rem;transform:translateY(-50%)}.rlh-global-book-header,.rlh-item-header{cursor:pointer;justify-content:flex-start;align-items:center;gap:.6rem;padding:.85rem 1rem;transition:background-color .2s,border-color .2s;display:flex}.rlh-global-book-header{flex-wrap:wrap;align-items:flex-start}.rlh-global-book-header .rlh-book-title-wrapper{flex:auto;min-width:0}.rlh-global-book-header .rlh-item-name{white-space:normal;word-break:break-word;flex:0 auto;min-width:0}.rlh-global-book-header .rlh-book-stats{white-space:nowrap}.rlh-global-book-header .rlh-item-controls{flex:none;margin-top:.1rem;margin-left:auto}.rlh-global-book-header.enabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{color:color-mix(in srgb,var(--rlh-text-color)70%,var(--rlh-accent-color)30%)}}.rlh-global-book-header.enabled{background:linear-gradient(135deg,var(--rlh-accent-color)0%,var(--rlh-accent-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{background:linear-gradient(135deg,color-mix(in srgb,var(--rlh-accent-color)32%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-accent-color)18%,var(--rlh-surface-color))100%)}}.rlh-global-book-header.enabled{box-shadow:0 18px 45px -30px var(--rlh-accent-color),inset 0 0 0 1px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{box-shadow:0 18px 45px -30px color-mix(in srgb,var(--rlh-accent-color)50%,transparent),inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-global-book-header.enabled .rlh-item-name{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled .rlh-item-name{color:color-mix(in srgb,var(--rlh-accent-color)85%,var(--rlh-text-color))}}.rlh-global-book-header.enabled .rlh-book-stats{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled .rlh-book-stats{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-em-color))}}.rlh-global-book-header.enabled:hover{background:linear-gradient(135deg,var(--rlh-accent-color)0%,var(--rlh-accent-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled:hover{background:linear-gradient(135deg,color-mix(in srgb,var(--rlh-accent-color)38%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-accent-color)22%,var(--rlh-surface-color))100%)}}.rlh-global-book-header:hover,.rlh-item-header:hover{background-color:var(--rlh-hover-bg)}.rlh-item-header-main{flex:auto;align-items:center;gap:.5rem;min-width:0;display:flex}.rlh-item-title-row{flex-wrap:wrap;align-items:center;gap:.45rem;display:inline-flex}.rlh-status-badge{--badge-color:var(--rlh-accent-color);letter-spacing:.01em;background:var(--badge-color);border-radius:999px;align-items:center;gap:.35rem;padding:.15rem .55rem;font-size:.75rem;font-weight:600;line-height:1;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-status-badge{background:color-mix(in srgb,var(--badge-color)18%,transparent)}}.rlh-status-badge{color:var(--badge-color)}@supports (color:color-mix(in lab, red, red)){.rlh-status-badge{color:color-mix(in srgb,var(--badge-color)80%,white 5%)}}.rlh-status-badge{white-space:nowrap}.rlh-status-badge i{font-size:.55rem}.rlh-status-badge__text{display:inline-block;transform:translateY(.5px)}.rlh-status-badge--constant{--badge-color:var(--rlh-status-constant)}.rlh-status-badge--selective{--badge-color:var(--rlh-status-selective)}.rlh-status-badge--vectorized{--badge-color:var(--rlh-status-vectorized)}.rlh-item-name{color:var(--rlh-text-color);flex-shrink:0;font-size:.95rem;font-weight:500}@media (max-width:720px){.rlh-item-header{flex-wrap:wrap;align-items:flex-start;gap:.45rem;padding:.7rem .75rem}.rlh-item-header-main{flex-direction:column;align-items:flex-start;gap:.3rem;width:100%}.rlh-item-name{text-overflow:ellipsis;white-space:nowrap;flex:auto;min-width:0;max-width:100%;overflow:hidden}.rlh-book-group-header{justify-content:flex-start;align-items:flex-start}.rlh-book-group-title{text-align:left;width:100%;max-width:100%}.rlh-item-controls{flex-direction:row;justify-content:flex-end;align-self:flex-start;align-items:center;gap:.18rem;width:auto}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{border-width:1px;border-radius:.6rem;width:1.55rem;height:1.55rem;padding:0}.rlh-item-controls .rlh-toggle-btn i,.rlh-item-controls .rlh-action-btn-icon i{font-size:max(.8125rem,13px)}.rlh-detail-header .rlh-item-controls{justify-self:flex-end}.rlh-book-group-header .rlh-item-controls{justify-content:flex-end;align-items:center;margin-top:.25rem;margin-left:auto;position:static;transform:none}.rlh-item-meta{gap:.25rem;font-size:.74rem}.rlh-item-meta-chip{gap:.2rem;padding:.12rem .45rem}}.rlh-item-meta{color:var(--rlh-em-color);flex-wrap:wrap;align-items:center;gap:.35rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta{color:color-mix(in srgb,var(--rlh-em-color)92%,transparent)}}.rlh-item-meta{font-size:.78rem}.rlh-item-meta-chip{background:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.25rem;padding:.15rem .55rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)70%,transparent)}}.rlh-item-meta-chip{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip{border:1px solid color-mix(in srgb,var(--rlh-border-color)50%,transparent)}}.rlh-item-meta-chip{line-height:1.2}.rlh-item-meta-chip i{color:var(--rlh-accent-color);font-size:.7rem}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip i{color:color-mix(in srgb,var(--rlh-accent-color)75%,var(--rlh-em-color))}}#regex-lore-hub-panel.dark .rlh-item-meta-chip{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}#regex-lore-hub-panel.dark .rlh-item-meta-chip{border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-item-meta-chip{border-color:color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-meta-chip{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-meta-chip{border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-meta-chip{border-color:color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-item-controls{flex-wrap:wrap;align-items:center;gap:.35rem;margin-left:auto;display:inline-flex}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{flex-shrink:0}@media (max-width:960px){.rlh-item-controls{gap:.28rem}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:2rem;height:2rem}}@media (max-width:900px) and (min-width:721px){.rlh-item-controls{flex-direction:column;align-items:flex-end;gap:.22rem;width:auto}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:1.75rem;height:1.75rem}.rlh-item-name{flex:auto;min-width:0;max-width:100%}}.rlh-toggle-btn,.rlh-action-btn-icon{border:1px solid var(--rlh-border-color);border-radius:9999px;justify-content:center;align-items:center;width:2.25rem;height:2.25rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toggle-btn,.rlh-action-btn-icon{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-toggle-btn,.rlh-action-btn-icon{color:var(--rlh-text-color);cursor:pointer;background:0 0;transition:color .2s,background-color .2s,border-color .2s,transform .2s}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{transform:translateY(-1px)scale(1.03)}.rlh-item-container.enabled .rlh-item-name,.rlh-book-group.enabled .rlh-item-name{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.enabled .rlh-item-name,.rlh-book-group.enabled .rlh-item-name{color:color-mix(in srgb,var(--rlh-accent-color)80%,var(--rlh-text-color))}}.rlh-collapsible-content{border-top:1px solid var(--rlh-border-color);margin-top:.75rem;padding:0 1rem 1rem;display:none}@supports (color:color-mix(in lab, red, red)){.rlh-collapsible-content{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-collapsible-content{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-collapsible-content{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,transparent)}}.rlh-entry-actions{border-bottom:1px dashed var(--rlh-border-color);flex-wrap:wrap;gap:.6rem;padding:.9rem 1rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-entry-actions{border-bottom:1px dashed color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-action-btn{background-color:var(--rlh-accent-color);color:#fff;cursor:pointer;border:none;border-radius:12px;justify-content:center;align-items:center;gap:.4rem;padding:.55rem 1rem;font-size:.9rem;font-weight:500;transition:transform .2s,opacity .2s;display:inline-flex}.rlh-action-btn:hover{opacity:.9}.rlh-action-btn.rlh-maximize-btn{border:1px solid var(--rlh-em-color);background:0 0}@supports (color:color-mix(in lab, red, red)){.rlh-action-btn.rlh-maximize-btn{border:1px solid color-mix(in srgb,var(--rlh-em-color)45%,transparent)}}.rlh-action-btn.rlh-maximize-btn{color:var(--rlh-em-color)}.rlh-editor-wrapper{flex-direction:column;gap:1rem;display:flex}.rlh-editor-field{flex-direction:column;gap:.35rem;display:flex}.rlh-editor-field label{background-color:var(--rlh-header-bg);padding:.55rem .85rem;display:block}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field label{background-color:color-mix(in srgb,var(--rlh-header-bg)82%,transparent)}}.rlh-editor-field label{border-bottom:1px solid var(--rlh-border-color);border-radius:12px 12px 0 0}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field label{border-bottom:1px solid color-mix(in srgb,var(--rlh-border-color)68%,transparent)}}.rlh-editor-field label{color:var(--rlh-text-color);margin:0;font-size:.875rem;font-weight:600;line-height:1.3}.rlh-editor-field label+*{border-top-left-radius:0;border-top-right-radius:0;margin-top:0}.rlh-viewer-field{gap:0}.rlh-regex-viewer{grid-template-columns:repeat(auto-fit,minmax(14rem,1fr));gap:.75rem;display:grid}.rlh-regex-viewer>.rlh-editor-field:nth-child(-n+2){grid-column:1/-1}.rlh-entry-viewer{flex-direction:column;gap:.75rem;display:flex}.rlh-viewer-field label{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-field label{background-color:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}.rlh-viewer-field label{border-bottom-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-field label{border-bottom-color:color-mix(in srgb,var(--rlh-accent-color)28%,transparent)}}.rlh-viewer-text{border:1px solid var(--rlh-border-color);padding:.6rem .85rem}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-text{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-viewer-text{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);white-space:pre-wrap;border-top:none;border-radius:0 0 12px 12px;line-height:1.5}.rlh-viewer-text>article{margin:0}.rlh-editor-field .rlh-edit-content,.rlh-editor-field article{border-top:none;border-radius:0 0 12px 12px;margin-top:0}#regex-lore-hub-panel.dark .rlh-editor-field label{background-color:var(--rlh-header-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-editor-field label{background-color:color-mix(in srgb,var(--rlh-header-bg)70%,transparent)}}#regex-lore-hub-panel.dark .rlh-editor-field label{border-bottom-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-editor-field label{border-bottom-color:color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-field label{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-field label{background-color:color-mix(in srgb,var(--rlh-hover-bg)70%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-field label{border-bottom-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-field label{border-bottom-color:color-mix(in srgb,var(--rlh-accent-color)32%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-text{border-color:color-mix(in srgb,var(--rlh-border-color)50%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{background-color:var(--rlh-input-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-text{background-color:color-mix(in srgb,var(--rlh-input-bg)90%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{border-top:none}.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{border:1px solid var(--rlh-border-color);border-radius:12px;width:100%;padding:.55rem .75rem}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);transition:border-color .2s,box-shadow .2s}.rlh-editor-field label+:is(input,textarea,select){border-top:none;border-radius:0 0 12px 12px}.rlh-editor-field textarea{resize:vertical;min-height:8rem}.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{box-shadow:var(--rlh-focus-ring)}.rlh-toast-notification,.rlh-progress-toast{background-color:var(--rlh-accent-color);color:#fff;box-shadow:0 24px 120px -40px var(--rlh-shadow-color);opacity:0;pointer-events:none;z-index:10002;border-radius:9999px;padding:.9rem 1.3rem;font-size:.9rem;font-weight:500;transition:opacity .25s,transform .25s;position:fixed;bottom:clamp(1rem,4vw,2rem);left:50%;transform:translate(-50%)translateY(20px)}.rlh-progress-toast{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-progress-toast{background-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-toast-notification.visible,.rlh-progress-toast.visible{opacity:1;animation:.38s cubic-bezier(.3,.7,.4,1.1) both rlhToastIn;transform:translate(-50%)translateY(0)}.rlh-modal-overlay{z-index:10003;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);background:#0206178c;justify-content:center;align-items:center;display:flex;position:fixed;inset:0}.rlh-modal-content{background:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);width:min(420px,90%);box-shadow:0 30px 120px -60px var(--rlh-shadow-color);border-radius:16px;margin:auto;overflow:hidden}.rlh-modal-header{border-bottom:1px solid var(--rlh-border-color);padding:1rem 1.25rem;font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-modal-header{border-bottom:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-body{color:var(--rlh-em-color);flex-direction:column;gap:.6rem;padding:1.1rem 1.25rem;display:flex}.rlh-modal-footer{border-top:1px solid var(--rlh-border-color);justify-content:flex-end;gap:.6rem;padding:.9rem 1.25rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-modal-footer{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-btn{border:1px solid var(--rlh-border-color);border-radius:12px;padding:.55rem 1.1rem}@supports (color:color-mix(in lab, red, red)){.rlh-modal-btn{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-btn{color:var(--rlh-text-color);cursor:pointer;background:0 0;font-weight:500;transition:background-color .2s,border-color .2s}.rlh-modal-btn:hover{background-color:var(--rlh-hover-bg)}.rlh-modal-btn.rlh-modal-ok{background-color:var(--rlh-accent-color);color:#fff;border-color:#0000}.rlh-modal-btn.rlh-modal-cancel{background-color:var(--rlh-red-bg);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-modal-btn.rlh-modal-cancel{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-modal-btn.rlh-modal-cancel{color:var(--rlh-red)}.rlh-loading{background:var(--rlh-surface-color);border-radius:20px;align-items:center;gap:1.25rem;padding:1.4rem 1.6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-loading{background:color-mix(in srgb,var(--rlh-surface-color)96%,transparent)}}.rlh-loading{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-loading{border:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-loading{box-shadow:0 24px 80px -50px var(--rlh-shadow-color)}.rlh-loading-spinner{border:3px solid var(--rlh-em-color);border-radius:9999px;width:2.6rem;height:2.6rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-spinner{border:3px solid color-mix(in srgb,var(--rlh-em-color)35%,transparent)}}.rlh-loading-spinner{border-top-color:var(--rlh-accent-color);animation:.9s linear infinite rlh-spin}.rlh-loading-text{flex-direction:column;flex:1;gap:.55rem;display:flex}.rlh-loading-title{color:var(--rlh-text-color);font-size:.95rem;font-weight:600}.rlh-loading-status{color:var(--rlh-text-color);font-size:.9rem}.rlh-loading-detail{color:var(--rlh-em-color);font-size:.82rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-detail{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-loading-bar{background:var(--rlh-hover-bg);border-radius:9999px;width:100%;height:.4rem;position:relative}@supports (color:color-mix(in lab, red, red)){.rlh-loading-bar{background:color-mix(in srgb,var(--rlh-hover-bg)75%,transparent)}}.rlh-loading-bar{overflow:hidden}.rlh-loading-bar-inner{background:linear-gradient(90deg,var(--rlh-accent-color),var(--rlh-accent-color));width:0%;height:100%}@supports (color:color-mix(in lab, red, red)){.rlh-loading-bar-inner{background:linear-gradient(90deg,var(--rlh-accent-color),color-mix(in srgb,var(--rlh-accent-color)70%,transparent))}}.rlh-loading-bar-inner{transition:width .3s}.rlh-loading-progress{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}@supports (color:color-mix(in lab, red, red)){.rlh-loading-progress{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-menu-icon{width:1.1rem;height:1.1rem;color:var(--rlh-accent-color);justify-content:center;align-items:center;display:inline-flex}@keyframes rlh-spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.rlh-edit-content{border:1px solid var(--rlh-border-color);border-radius:0 0 12px 12px;min-height:6rem;padding:.75rem}@supports (color:color-mix(in lab, red, red)){.rlh-edit-content{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-edit-content{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);white-space:pre-wrap}.rlh-error-wrapper{text-align:center;border:1px dashed var(--rlh-red);border-radius:16px;padding:1.5rem}@supports (color:color-mix(in lab, red, red)){.rlh-error-wrapper{border:1px dashed color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-error-wrapper{background-color:var(--rlh-red-bg)}.rlh-error-title{color:var(--rlh-red);margin-bottom:.75rem;font-weight:600}.rlh-error-text{color:var(--rlh-em-color);font-size:.9rem}.rlh-error-retry-btn{border:1px solid var(--rlh-red);color:var(--rlh-red);cursor:pointer;background-color:#0000;border-radius:9999px;margin-top:1rem;padding:.55rem 1.1rem;transition:background-color .2s}.rlh-error-retry-btn:hover{background-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-error-retry-btn:hover{background-color:color-mix(in srgb,var(--rlh-red)18%,transparent)}}.rlh-error-retry-btn:hover{color:#fff}.rlh-search-card,.rlh-filters-card{background:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:.9rem;padding:1rem 1.1rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-card,.rlh-filters-card{background:color-mix(in srgb,var(--rlh-surface-color)92%,transparent)}}.rlh-search-card,.rlh-filters-card{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-card,.rlh-filters-card{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-card,.rlh-filters-card{box-shadow:0 20px 60px -40px var(--rlh-shadow-color)}.rlh-section-title{letter-spacing:.08em;text-transform:uppercase;color:var(--rlh-em-color);font-size:max(.8125rem,13px);font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-section-title{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-toast-notification.success{background-color:var(--rlh-green)}.rlh-toast-notification.error{background-color:var(--rlh-red)}.rlh-toast-notification.info{background-color:var(--rlh-accent-color)}@media (prefers-reduced-motion:reduce){#regex-lore-hub-panel .rlh-shell,.rlh-toolbar-btn:focus-visible{animation:none}.rlh-toast-notification.visible,.rlh-progress-toast.visible{transition:opacity .2s,transform .2s;animation:none}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover,.rlh-toolbar-btn:hover,.rlh-toggle-btn:hover i,.rlh-action-btn-icon:hover i,.rlh-toolbar-btn:hover i{transform:none}}.rlh-breadcrumbs{align-items:center;gap:.4rem;margin-bottom:.5rem;font-size:.9rem;display:flex}.rlh-breadcrumb-item{color:var(--rlh-em-color);text-decoration:none;transition:color .2s}.rlh-breadcrumb-item:hover{color:var(--rlh-accent-color)}.rlh-breadcrumb-item.active{color:var(--rlh-text-color);pointer-events:none;font-weight:500}.rlh-breadcrumb-separator{color:var(--rlh-em-color)}.rlh-empty-state{text-align:center;background-color:var(--rlh-hover-bg);border-radius:16px;flex-direction:column;justify-content:center;align-items:center;margin-top:1rem;padding:2rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-empty-state{background-color:color-mix(in srgb,var(--rlh-hover-bg)50%,transparent)}}.rlh-empty-state{border:1px dashed var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-empty-state{border:1px dashed color-mix(in srgb,var(--rlh-border-color)80%,transparent)}}.rlh-empty-icon{color:var(--rlh-accent-color);background-color:var(--rlh-selected-bg);border-radius:9999px;justify-content:center;align-items:center;width:4rem;height:4rem;margin-bottom:1rem;font-size:2rem;display:flex}.rlh-empty-state h4{color:var(--rlh-text-color);margin-bottom:.5rem;font-size:1.1rem;font-weight:600}.rlh-empty-state p{color:var(--rlh-em-color);max-width:300px}.rlh-book-group{transition:box-shadow .2s,border-color .2s;position:relative}.rlh-book-group.enabled{border-left:3px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{border-left:3px solid color-mix(in srgb,var(--rlh-accent-color)80%,transparent)}}.rlh-book-group.enabled{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color))}}.rlh-book-group.enabled{background:linear-gradient(160deg,var(--rlh-accent-color)0%,var(--rlh-surface-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{background:linear-gradient(160deg,color-mix(in srgb,var(--rlh-accent-color)20%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-surface-color)96%,transparent)100%)}}.rlh-book-group.enabled{box-shadow:0 26px 70px -46px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{box-shadow:0 26px 70px -46px color-mix(in srgb,var(--rlh-accent-color)58%,transparent)}}.rlh-book-title-wrapper{flex-direction:column;flex:1;gap:.2rem;display:flex}.rlh-book-stats{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}.rlh-book-summary{background-color:var(--rlh-hover-bg);padding:.5rem 1rem;font-size:.85rem}@supports (color:color-mix(in lab, red, red)){.rlh-book-summary{background-color:color-mix(in srgb,var(--rlh-hover-bg)40%,transparent)}}.rlh-book-summary{border-top:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-summary{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-used-by-chars span{background-color:var(--rlh-selected-bg);border-radius:9999px;margin:.1rem;padding:.1rem .5rem;font-size:max(.8125rem,13px);display:inline-block}.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{border:1px solid var(--rlh-border-color);border-radius:12px;padding:.45rem .65rem}@supports (color:color-mix(in lab, red, red)){.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{background-color:var(--rlh-input-bg);color:var(--rlh-text-color)}.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{box-shadow:var(--rlh-focus-ring)}.rlh-loading{pointer-events:none;opacity:.5;position:relative}.rlh-loading>i{visibility:hidden}.rlh-loading:after{content:\"\";border:2px solid oklch(70.7% .022 261.325);border-top-color:oklch(62.3% .214 259.815);border-radius:50%;width:16px;height:16px;margin-top:-8px;margin-left:-8px;animation:.8s linear infinite rlh-spin;position:absolute;top:50%;left:50%}.rlh-highlight{color:#1f2937;background-color:#facc15;animation:.5s ease-out rlhHighlightPulse}.rlh-replace-confirm-modal{color:var(--rlh-text-color);flex-direction:column;gap:.6rem;display:flex}.rlh-replace-stats{background:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-replace-stats{background:color-mix(in srgb,var(--rlh-accent-color)6%,transparent)}}.rlh-replace-stats{border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-replace-stats{border:1px solid color-mix(in srgb,var(--rlh-accent-color)22%,transparent)}}.rlh-replace-stats{border-radius:10px;padding:.6rem .8rem}.rlh-replace-stats h4{color:var(--rlh-text-color);margin:0 0 .4rem;font-weight:600}.rlh-replace-stats ul{margin:0;padding-left:1.1rem}.rlh-confirm-scroll-list{border:1px solid var(--rlh-border-color);background:var(--rlh-surface-color);border-radius:10px;max-height:12rem;padding:.4rem .25rem;overflow-y:auto}.rlh-confirm-entry-list{margin:0;padding:.25rem .25rem .25rem .5rem;list-style:none}.rlh-confirm-entry-item{border-radius:8px;padding:.35rem .5rem;transition:background-color .15s}.rlh-confirm-entry-item:hover{background:var(--rlh-hover-bg)}.rlh-toolbar-btn:focus-visible,.rlh-icon-button:focus-visible,.rlh-close-button:focus-visible,.rlh-toggle-btn:focus-visible,.rlh-action-btn-icon:focus-visible,.rlh-toolbar-icon-btn:focus-visible{outline-offset:2px;outline:3px solid var(--rlh-accent-color)!important;box-shadow:0 0 0 5px var(--rlh-accent-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:focus-visible,.rlh-icon-button:focus-visible,.rlh-close-button:focus-visible,.rlh-toggle-btn:focus-visible,.rlh-action-btn-icon:focus-visible,.rlh-toolbar-icon-btn:focus-visible{box-shadow:0 0 0 5px color-mix(in srgb,var(--rlh-accent-color)20%,transparent)!important}}input:focus-visible,select:focus-visible,textarea:focus-visible,[contenteditable]:focus-visible{outline:3px solid var(--rlh-accent-color);outline-offset:2px}}.rlh-toolbar-toggle-btn{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color);border:1px solid var(--rlh-border-color);cursor:pointer;border-radius:8px;justify-content:center;align-items:center;padding:.5rem 1rem;transition:background-color .2s,color .2s;display:inline-flex}.rlh-toolbar-toggle-btn:hover{background-color:var(--rlh-selected-bg);color:var(--rlh-accent-color)}#regex-lore-hub-toolbar-shell{transition:max-height .3s ease-in-out}.rlh-toolbar-shell--collapsed{max-height:0;margin-top:0;margin-bottom:0;padding-top:0;padding-bottom:0;overflow:hidden}@media (max-width:640px){.rlh-toggle-btn,.rlh-action-btn-icon,.rlh-toolbar-icon-btn,.rlh-icon-button,.rlh-close-button{width:44px;height:44px;padding:.5rem;min-width:44px!important;min-height:44px!important}.rlh-multi-select-action-btn{padding:.6rem .8rem;min-width:44px!important;min-height:44px!important}.rlh-item-controls{gap:.5rem!important}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:44px!important;height:44px!important}}\n`;var ka=(()=>{try{return new URL(\"../vendor/Sortable.min.js\",import.meta.url).href}catch(e){return console.error(\"[RegexLoreHub] \\u8BA1\\u7B97 SortableJS \\u672C\\u5730\\u8DEF\\u5F84\\u5931\\u8D25\\uFF1A\",e),\"\"}})(),Qt=e=>!e||typeof e!=\"string\"?\"\":e.trim().replace(/\\\\/g,\"/\").replace(/\\/+$/,\"\"),yt=(e,r)=>{let t=Qt(e);if(!t)return\"\";let a=r.replace(/^\\/+/,\"\");return`${t}/${a}`},wa=(e,r)=>{let t=[],a=l=>{if(!l||typeof l!=\"string\")return;let n=l.trim();n&&(t.includes(n)||t.push(n))};a(yt(o.paths?.vendor,\"Sortable.min.js\")),a(yt(o.paths?.rlhRoot,\"vendor/Sortable.min.js\"));try{a(new URL(\"../vendor/Sortable.min.js\",import.meta.url).href)}catch(l){console.warn(\"[RegexLoreHub] \\u57FA\\u4E8E\\u6A21\\u5757\\u8DEF\\u5F84\\u63A8\\u5BFC Sortable \\u8D44\\u6E90\\u5931\\u8D25\\uFF1A\",l)}try{e&&e.querySelectorAll(\"script[src]\").forEach(n=>{let i=n.getAttribute(\"src\");if(!(!i||!/regex[-_]lore[-_]hub/i.test(i)))try{let h=new URL(i,r?.location?.href||window.location.href),m=Qt(h.href.replace(/\\/[^/]*$/,\"\"));a(yt(m,\"vendor/Sortable.min.js\")),a(yt(m,\"src/vendor/Sortable.min.js\"))}catch(h){console.warn(\"[RegexLoreHub] \\u5BBF\\u4E3B\\u811A\\u672C\\u8DEF\\u5F84\\u63A8\\u5BFC\\u5931\\u8D25\\uFF1A\",h)}})}catch(l){console.warn(\"[RegexLoreHub] \\u904D\\u5386\\u5BBF\\u4E3B\\u811A\\u672C\\u8282\\u70B9\\u5931\\u8D25\\uFF1A\",l)}return a(ka),a(\"https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js\"),t.filter(Boolean)};async function pl(e){let r=xe(),t=we(),a=$e();try{let f=await Go();f?jr(f,{applyToDom:!1,silent:!0,reason:\"restore\"})||console.warn(\"[RegexLoreHub] \\u65E0\\u6CD5\\u6062\\u590D\\u5B58\\u50A8\\u7684\\u4E3B\\u9898\\uFF0CID:\",f):jr(\"dark\",{applyToDom:!1,silent:!0,reason:\"initial-default\"})}catch(f){console.warn(\"[RegexLoreHub] \\u8BFB\\u53D6\\u4E3B\\u9898\\u504F\\u597D\\u5931\\u8D25\\uFF1A\",f)}let l=e(),n=f=>f===\"dark\"?\"\\u6697\\u8272\":f===\"light\"?\"\\u4EAE\\u8272\":\"\\u81EA\\u5B9A\\u4E49\",i=()=>{let f=r(`#${cr}`,t);if(!f.length)return;let w=Fr()?.id??\"\",k=fo().map(I=>{let s=typeof I?.id==\"string\"?I.id.trim():\"\",g=s&&s===w,x=O(It(s)),C=O(n(I?.colorScheme));return`\n          <button type=\"button\" class=\"rlh-sort-option ${Tr}\" data-theme-id=\"${O(s)}\" role=\"menuitemradio\" aria-checked=\"${g?\"true\":\"false\"}\" data-active=\"${g}\">\n            <span class=\"rlh-theme-option-text\">\n              <span class=\"rlh-theme-option-name\">${x}</span>\n              <span class=\"rlh-theme-option-meta\">${C}</span>\n            </span>\n            <span class=\"rlh-theme-option-check\"><i class=\"fa-solid fa-check\" aria-hidden=\"true\"></i></span>\n          </button>`}).join(\"\");f.html(k)},h=f=>{let v=f??Fr(),w=v?.id??\"\",T=It(w),k=r(`#${Lt}`,t);k.length&&k.text(v?`\\u4E3B\\u9898\\uFF1A${T}`:\"\\u4E3B\\u9898\\uFF1A\\u672A\\u8BBE\\u7F6E\");let I=r(`#${Pr}`,t);I.length&&I.attr(\"data-active-theme\",w),r(`#${cr}`,t).find(`.${Tr}`).each((g,x)=>{let C=r(x),S=String(C.data(\"themeId\")??\"\").trim()===w&&!!w;C.attr(\"data-active\",String(S)),C.attr(\"aria-checked\",String(S))})};xo(({theme:f})=>{i(),h(f)});function m(){let f=t.getElementById(`${ke}-styles`);if(f){f.textContent=Jt;return}let v=t.createElement(\"style\");v.id=`${ke}-styles`,v.textContent=Jt,t.head.appendChild(v)}function b(f){if(o.isDragSortDisabled=!1,a.Sortable){if(typeof f==\"function\")try{f()}catch(s){console.error(\"[RegexLoreHub] \\u521D\\u59CB\\u5316\\u56DE\\u8C03\\u6267\\u884C\\u5931\\u8D25\\uFF1A\",s)}return}let v=!1,w=()=>{if(!v&&(v=!0,typeof f==\"function\"))try{f()}catch(s){console.error(\"[RegexLoreHub] \\u521D\\u59CB\\u5316\\u56DE\\u8C03\\u6267\\u884C\\u5931\\u8D25\\uFF1A\",s)}},T=wa(t,a),k=s=>{if(!t){o.isDragSortDisabled=!0,console.error(\"[RegexLoreHub] \\u65E0\\u6CD5\\u52A0\\u8F7D SortableJS\\uFF1A\\u5BBF\\u4E3B\\u6587\\u6863\\u4E0D\\u53EF\\u8BBF\\u95EE\\u3002\",s),w();return}let g=T.length?`\\u5C1D\\u8BD5\\u8DEF\\u5F84\\uFF1A${T.join(\", \")}`:\"\\u672A\\u627E\\u5230\\u53EF\\u7528\\u5019\\u9009\\u8DEF\\u5F84\\u3002\";(async()=>{if(typeof(a.fetch||window.fetch)!=\"function\")throw s||new Error(\"fetch not available\");let C=a.fetch?a.fetch.bind(a):window.fetch.bind(window),D=(()=>{try{return new URL(\"../vendor/Sortable.min.js\",import.meta.url).href}catch(q){return console.warn(\"[RegexLoreHub] \\u5185\\u8054\\u56DE\\u9000\\u8DEF\\u5F84\\u89E3\\u6790\\u5931\\u8D25\\uFF1A\",q),\"\"}})()||T[0]||\"\";if(!D)throw s||new Error(\"missing inline url\");let S=await C(D,{cache:\"no-cache\"});if(!S.ok)throw new Error(`HTTP ${S.status} ${S.statusText}`);let K=await S.text(),ce=t.createElement(\"script\");ce.textContent=K,t.head.appendChild(ce),console.warn(\"[RegexLoreHub] SortableJS \\u5DF2\\u901A\\u8FC7\\u5185\\u8054\\u6A21\\u5F0F\\u52A0\\u8F7D\\u3002\"),o.isDragSortDisabled=!1,w()})().catch(C=>{o.isDragSortDisabled=!0,console.error(\"[RegexLoreHub] Failed to load SortableJS.\",C??s),J({type:\"alert\",title:\"\\u9519\\u8BEF\",text:`\\u65E0\\u6CD5\\u52A0\\u8F7D\\u62D6\\u62FD\\u6392\\u5E8F\\u5E93\\uFF0C\\u8BF7\\u68C0\\u67E5\\u8D44\\u6E90\\u8DEF\\u5F84\\u914D\\u7F6E\\u3002${g}`}).catch(()=>{}),w()}).finally(()=>{})};if(!T.length){k(new Error(\"Sortable candidate URLs not found.\"));return}let I=s=>{if(s>=T.length){k(new Error(\"All Sortable candidates failed.\"));return}let g=T[s],x=a.document.createElement(\"script\");x.src=g,x.dataset.rlhSortableCandidate=String(s),x.onload=()=>{o.isDragSortDisabled=!1,console.log(\"[RegexLoreHub] SortableJS loaded successfully.\",g),o.paths=o.paths||{},o.paths.vendor=Qt(g.replace(/\\/Sortable\\.min\\.js(?:\\?.*)?$/,\"\")),o.paths.rlhRoot=o.paths.vendor?.replace(/\\/vendor$/,\"\")||o.paths.rlhRoot||\"\",w()},x.onerror=C=>{x.remove(),console.warn(\"[RegexLoreHub] SortableJS \\u52A0\\u8F7D\\u5931\\u8D25\\uFF0C\\u5C1D\\u8BD5\\u4E0B\\u4E00\\u4E2A\\u5019\\u9009\\u3002\",g,C?.error),I(s+1)},a.document.head.appendChild(x)};I(0)}function p(){if(console.log(\"[RegexLoreHub] Initializing UI and button...\"),r(`#${ke}`,t).length>0){console.log(\"[RegexLoreHub] Panel already exists. Skipping UI creation.\");return}m();let f=`\n      <div id=\"${ke}\">\n\n        <div class=\"rlh-shell\">\n\n          <header class=\"rlh-shell-header\">\n\n            <div class=\"rlh-shell-title\">\n\n              <h4>${$t}</h4>\n\n              <p class=\"rlh-shell-meta\"><span class=\"rlh-shell-version\">v3.2</span><span class=\"rlh-shell-dot\">\\xB7</span><span class=\"rlh-shell-updated\">\\u66F4\\u65B0\\u4E8E 2025 \\u5E74 10 \\u6708 21 \\u65E5</span></p>\n\n            </div>\n\n            <div class=\"rlh-shell-right\">\n\n              <div id=\"${ot}\" class=\"rlh-prefetch-indicator\" data-visible=\"false\" aria-hidden=\"true\">\n\n                <div id=\"${lt}\" class=\"rlh-prefetch-text\" aria-live=\"polite\">\\u540E\\u53F0\\u52A0\\u8F7D\\u4E16\\u754C\\u4E66 (0/0)\\uFF0C\\u4E0D\\u5F71\\u54CD\\u5176\\u4ED6\\u64CD\\u4F5C</div>\n\n                <div class=\"rlh-prefetch-bar\" role=\"progressbar\" aria-valuemin=\"0\" aria-valuemax=\"100\" aria-valuenow=\"0\">\n\n                  <span id=\"${at}\" class=\"rlh-prefetch-bar-inner\"></span>\n\n                </div>\n\n              </div>\n\n              <button type=\"button\" id=\"${Ye.TOGGLE_TOOLBAR_BTN}\" class=\"rlh-toolbar-toggle-btn\" title=\"\\u6298\\u53E0\\u5DE5\\u5177\\u680F\" aria-controls=\"${Ye.TOOLBAR_SHELL}\" aria-expanded=\"true\">\\u6298\\u53E0\\u5DE5\\u5177\\u680F</button>\n\n              <div class=\"rlh-shell-actions\">\n\n                <div id=\"${Pr}\" class=\"rlh-theme-menu rlh-sort-menu\" data-open=\"false\">\n\n                  <button type=\"button\" id=\"${zr}\" class=\"rlh-theme-toggle\" title=\"\\u5207\\u6362\\u4E3B\\u9898\" aria-haspopup=\"true\" aria-expanded=\"false\" aria-controls=\"${cr}\">\n\n                    <i class=\"fa-solid fa-palette\" aria-hidden=\"true\"></i>\n\n                    <span id=\"${Lt}\" class=\"rlh-theme-toggle-label\">\\u4E3B\\u9898\\uFF1A\\u52A0\\u8F7D\\u4E2D</span>\n\n                    <i class=\"fa-solid fa-caret-down rlh-theme-toggle-caret\" aria-hidden=\"true\"></i>\n\n                  </button>\n\n                  <div id=\"${cr}\" class=\"rlh-sort-menu-list rlh-theme-menu-list\" role=\"menu\"></div>\n\n                </div>\n\n                <button type=\"button\" id=\"${Dr}\" class=\"rlh-icon-button rlh-refresh-button\" title=\"\\u5237\\u65B0\\u6570\\u636E\">\n\n                  <i class=\"fa-solid fa-arrows-rotate\"></i>\n\n                </button>\n\n                <button type=\"button\" id=\"${Tt}\" class=\"rlh-icon-button rlh-close-button\" title=\"\\u5173\\u95ED\\u9762\\u677F\">\n\n                  <i class=\"fa-solid fa-xmark\"></i>\n\n                </button>\n\n              </div>\n\n            </div>\n\n          </header>\n\n\n\n\n\n          <nav class=\"rlh-tab-nav\">\n\n            <div class=\"rlh-tab active\" data-tab=\"global-lore\"><span class=\"rlh-tab-text-full\">\\u5168\\u5C40\\u4E16\\u754C\\u4E66</span><span class=\"rlh-tab-text-short\">\\u5168\\u5C40\\u4E66</span></div>\n\n            <div class=\"rlh-tab\" data-tab=\"char-lore\"><span class=\"rlh-tab-text-full\">\\u89D2\\u8272\\u4E16\\u754C\\u4E66</span><span class=\"rlh-tab-text-short\">\\u89D2\\u8272\\u4E66</span></div>\n\n            <div class=\"rlh-tab\" data-tab=\"chat-lore\"><span class=\"rlh-tab-text-full\">\\u804A\\u5929\\u4E16\\u754C\\u4E66</span><span class=\"rlh-tab-text-short\">\\u804A\\u5929\\u4E66</span></div>\n\n            <div class=\"rlh-tab\" data-tab=\"global-regex\"><span class=\"rlh-tab-text-full\">\\u5168\\u5C40\\u6B63\\u5219</span><span class=\"rlh-tab-text-short\">\\u5168\\u5C40\\u6B63\\u5219</span></div>\n\n            <div class=\"rlh-tab\" data-tab=\"char-regex\"><span class=\"rlh-tab-text-full\">\\u89D2\\u8272\\u6B63\\u5219</span><span class=\"rlh-tab-text-short\">\\u89D2\\u8272\\u6B63\\u5219</span></div>\n\n          </nav>\n\n          <div id=\"${Ye.TOOLBAR_SHELL}\" class=\"rlh-toolbar-shell\">\n\n            <div id=\"${Hr}\" class=\"rlh-toolbar-container\"></div>\n\n            <div id=\"${Ur}\" class=\"rlh-replace-container\"></div>\n\n          </div>\n\n          <div class=\"rlh-content-pane\">\n\n            <div id=\"${ke}-content\"></div>\n\n          </div>\n\n          <footer class=\"rlh-shell-footer\">\n\n            <div id=\"regex-lore-hub-save-status\" class=\"rlh-save-status\"></div>\n\n          </footer>\n\n        </div>\n\n      </div>`;r(\"body\",t).append(f),go(),i(),h();let v=`<div id=\"${tr}\" class=\"list-group-item flex-container flexGap5 interactable\" title=\"${$t}\"><span class=\"rlh-menu-icon\"><i class=\"fa-solid fa-layer-group\"></i></span><span>${so}</span></div>`,w=r(\"#extensionsMenu\",t);w.find(`#${tr}`).length===0&&(w.append(v),console.log(`[RegexLoreHub] Button #${tr} appended to #extensionsMenu.`));let T=r(`#${ke}`,t);if(r(\"body\",t).off(\".rlh\").on(\"click.rlh\",`#${tr}`,l.togglePanel),T.off(\".rlh\").on(\"click.rlh\",`#${Tt}`,l.togglePanel).on(\"click.rlh\",\".rlh-tab\",l.switchTab).on(\"click.rlh\",\".rlh-item-header, .rlh-global-book-header\",l.handleHeaderClick).on(\"click.rlh\",\".rlh-item-container\",l.handleMultiSelectContainerClick).on(\"click.rlh\",\".rlh-book-group\",l.handleMultiSelectContainerClick).on(\"click.rlh\",\".rlh-back-to-list-btn\",l.handleExitLorebookDetail).on(\"click.rlh\",\".rlh-toggle-btn\",l.handleToggleState).on(\"click.rlh\",\".rlh-refresh-detail-btn\",l.handleRefreshLorebookDetail).on(\"click.rlh\",\".rlh-entry-edit-btn\",l.handleEntryEnterEdit).on(\"click.rlh\",\".rlh-entry-view-btn\",l.handleEntryExitEdit).on(\"click.rlh\",\".rlh-regex-edit-btn\",l.handleRegexEnterEdit).on(\"click.rlh\",\".rlh-regex-view-btn\",l.handleRegexExitEdit).on(\"keydown.rlh\",`#${nr}`,l.handleSearchInputKeydown).on(\"click.rlh\",\"#rlh-search-clear-btn\",l.handleSearchClear).on(\"input.rlh\",`#${nr}, #${Sr}`,l.handleGlobalSearch).on(\"change.rlh\",\"#rlh-search-filters-container input\",se).on(\"change.rlh\",`#${tt}`,l.handleCharacterBookSwitch).on(\"click.rlh\",`#${_r}`,l.handleToolbarToggleCollapse).on(\"click.rlh\",`#${ir}`,l.handleSortMenuToggle).on(\"click.rlh\",\".rlh-sort-option\",l.handleSortOptionSelect).on(\"click.rlh\",`#${zr}`,l.handleThemeMenuToggle).on(\"click.rlh\",`#${cr} .${Tr}`,l.handleThemeOptionSelect).on(\"click.rlh\",`#${Qe}`,l.handlePositionMenuToggle).on(\"click.rlh\",\".rlh-position-option\",l.handlePositionOptionSelect).on(\"click.rlh\",`#${sr}`,l.handleUnifiedStatusMenuToggle).on(\"click.rlh\",\".rlh-unified-status-option\",l.handleUnifiedStatusOptionSelect).on(\"change.rlh\",\".rlh-multi-select-checkbox\",l.handleSelectionCheckboxChange).on(\"click.rlh\",`#${Dr}`,l.handleRefresh).on(\"click.rlh\",\"#rlh-multi-select-btn\",l.toggleMultiSelectMode).on(\"click.rlh\",\"#rlh-select-all-btn\",l.handleSelectAll).on(\"click.rlh\",\"#rlh-select-none-btn\",l.handleSelectNone).on(\"click.rlh\",\"#rlh-select-invert-btn\",l.handleSelectInvert).on(\"click.rlh\",\".rlh-select-unbound\",l.handleSelectUnboundBooks).on(\"click.rlh\",\"#rlh-batch-enable-btn\",l.handleBatchEnable).on(\"click.rlh\",\"#rlh-batch-disable-btn\",l.handleBatchDisable).on(\"click.rlh\",\"#rlh-batch-delete-btn\",l.handleBatchDelete).on(\"click.rlh\",\".rlh-clean-orphan-books-btn\",l.handleCleanOrphanLorebooks).on(\"click.rlh\",`#${rt}`,l.handlePrimaryCreateButtonClick).on(\"click.rlh\",\".rlh-rename-book-btn\",l.handleRenameBook).on(\"click.rlh\",\".rlh-edit-entries-btn\",l.handleEditEntriesToggle).on(\"click.rlh\",\".rlh-delete-book-btn\",l.handleDeleteLorebook).on(\"click.rlh\",\".rlh-create-entry-btn\",l.handleCreateEntry).on(\"click.rlh\",\"#regex-lore-hub-create-lorebook-btn\",l.handleCreateLorebook).on(\"click.rlh\",\".rlh-delete-entry-btn\",l.handleDeleteEntry).on(\"click.rlh\",\".rlh-batch-recursion-btn\",l.handleBatchSetRecursion).on(\"click.rlh\",\".rlh-fix-keywords-btn\",l.handleFixKeywords).on(\"click.rlh\",\".rlh-rename-btn\",l.handleRename).on(\"click.rlh\",\".rlh-rename-save-btn\",l.handleConfirmRename).on(\"keydown.rlh\",\".rlh-rename-input\",l.handleRenameKeydown).on(\"change.rlh\",\".rlh-edit-position\",l.handlePositionChange).on(\"click.rlh\",\"#rlh-create-chat-lore-btn\",l.handleCreateChatLorebook).on(\"click.rlh\",\".rlh-unlink-chat-lore-btn\",l.handleUnlinkChatLorebook).on(\"click.rlh\",`#${Ye.TOGGLE_TOOLBAR_BTN}`,il).on(\"click.rlh\",\"#rlh-replace-btn\",l.handleReplace),o.isToolbarCollapsed){r(`#${Ye.TOOLBAR_SHELL}`,t).addClass(\"rlh-toolbar-shell--collapsed\");let s=r(`#${Ye.TOGGLE_TOOLBAR_BTN}`,t);s.length&&s.text(\"\\u5C55\\u5F00\\u5DE5\\u5177\\u680F\").attr(\"aria-expanded\",\"false\").attr(\"title\",\"\\u5C55\\u5F00\\u5DE5\\u5177\\u680F\")}console.log(\"[RegexLoreHub] All UI and events initialized.\"),We()}b(p)}var Zt=null,eo=null;function Sa(e,r){Zt=e,eo=r}function xe(){if(Zt)return Zt;let e=window.parent||window;return e?.jQuery?e.jQuery:null}function Se(){if(eo)return eo;let e=window.parent||window;return e?.TavernHelper?e.TavernHelper:null}function _a(e){let r=\"#extensionsMenu\",a=0;console.log(`[RegexLoreHub] Starting readiness check. Polling for DOM element \"${r}\" AND core APIs (TavernHelper, jQuery).`);let l=setInterval(()=>{let n=window.parent?.document,i=window.parent,h=!!n&&n.querySelector(r)!==null,m=!!(i&&i.TavernHelper)&&typeof i.TavernHelper.getCharData==\"function\"&&!!i.jQuery;if(h&&m){clearInterval(l),console.log(`[RegexLoreHub] SUCCESS: Both DOM (\"${r}\") and Core APIs are ready. Initializing script.`);try{let b=e(i.jQuery,i.TavernHelper);b?.catch&&b.catch(p=>{console.error(\"[RegexLoreHub] FATAL: Error during main callback execution.\",p)})}catch(b){console.error(\"[RegexLoreHub] FATAL: Error during main callback execution.\",b)}}else a++,a>100&&(clearInterval(l),console.error(\"[RegexLoreHub] FATAL: Readiness check timed out.\"),h||console.error(`[RegexLoreHub] -> Failure: DOM element \"${r}\" not found.`),m||console.error(`[RegexLoreHub] -> Failure: Core APIs not available. TavernHelper: ${!!i?.TavernHelper}, jQuery: ${!!i?.jQuery}`))},150)}async function Ea(e,r){Sa(e,r);try{await pl(hl)}catch(t){console.error(\"[RegexLoreHub] FATAL: Failed to bootstrap application.\",t)}}_a(Ea);\n//# sourceMappingURL=bundle.js.map\n",
  "info": "",
  "buttons": [],
  "data": {}
}
{
  "id": "0266db8e-add9-49c0-bfca-3b237bbb1eaf",
  "name": "世界书&正则管理器",
  "content": "var me=\"regex-lore-hub-panel\",Xe=\"regex-lore-hub-button\";var st=\"\\u4E16\\u754C\\u4E66&\\u6B63\\u5219\\u7BA1\\u7406\\u5668\",Pt=\"\\u4E16\\u754C\\u4E66&\\u6B63\\u5219\\u7BA1\\u7406\\u5668\",ct=\"rlh-close-btn\",er=\"rlh-search-input\",Er=\"rlh-refresh-btn\",Lr=\"rlh-core-toolbar\",Tr=\"rlh-replace-tool-container\";var mr=\"rlh-replace-input\",fr=\"rlh-toggle-collapse-btn\",zt=\"rlh-toggle-recursion-btn\",Ft=\"rlh-fix-keywords-btn\",gr=\"rlh-sort-menu\",rr=\"rlh-sort-menu-btn\",Je=\"rlh-position-menu\",Ye=\"rlh-position-menu-btn\",xr=\"rlh-unified-status-menu\",tr=\"rlh-unified-status-btn\",Hr=\"rlh-create-primary-btn\",Pr=\"rlh-character-book-switch\",zr=\"rlh-prefetch-indicator\",Fr=\"rlh-prefetch-progress-text\",jr=\"rlh-prefetch-progress-bar\",We={TOOLBAR_SHELL:\"regex-lore-hub-toolbar-shell\",TOGGLE_TOOLBAR_BTN:\"regex-lore-hub-toggle-toolbar-btn\"},dt=e=>!e||typeof e!=\"string\"?\"\":e.replace(/\\\\/g,\"/\").replace(/\\/+$/,\"\"),Yo=()=>{try{let e=new URL(\"./\",import.meta.url).href;return dt(e)}catch(e){return console.warn(\"[RegexLoreHub] \\u65E0\\u6CD5\\u89E3\\u6790\\u811A\\u672C\\u6839\\u8DEF\\u5F84\\uFF1A\",e),\"\"}},qo=()=>{try{let e=window.parent||window,r=e?.document;if(!r)return\"\";let o=r.querySelectorAll(\"script[src]\");for(let l of o){let a=l.getAttribute(\"src\");if(!(!a||!/regex[-_]lore[-_]hub/i.test(a)))try{let n=new URL(a,e.location?.href||window.location.href),i=dt(n.href);if(!i)continue;let b=i.replace(/\\/[^/]*$/,\"\");if(b)return b}catch(n){console.warn(\"[RegexLoreHub] \\u5BBF\\u4E3B\\u811A\\u672C\\u6839\\u8DEF\\u5F84\\u89E3\\u6790\\u5931\\u8D25\\uFF1A\",n)}}}catch(e){console.warn(\"[RegexLoreHub] \\u65E0\\u6CD5\\u4ECE\\u5BBF\\u4E3B DOM \\u63A8\\u65AD\\u6839\\u8DEF\\u5F84\\uFF1A\",e)}return\"\"},nt=dt(qo())||Yo(),Xo=[{id:\"constant\",label:\"\\u6C38\\u4E45\\u6FC0\\u6D3B\",shortLabel:\"\\u6C38\\u4E45\",description:\"\\u5FFD\\u7565\\u5173\\u952E\\u8BCD\\u9650\\u5236\\uFF0C\\u53EA\\u8981\\u6761\\u76EE\\u542F\\u7528\\u4E14\\u6EE1\\u8DB3\\u6982\\u7387\\u5C31\\u59CB\\u7EC8\\u5C1D\\u8BD5\\u6FC0\\u6D3B\\u3002\",strategyType:\"constant\",toastLabel:\"\\u6C38\\u4E45\\u6FC0\\u6D3B\",accentVar:\"--rlh-status-constant\",badgeClass:\"rlh-status-badge--constant\",order:0},{id:\"selective\",label:\"\\u5173\\u952E\\u8BCD\\u89E6\\u53D1\",shortLabel:\"\\u5173\\u952E\\u8BCD\",description:\"\\u5339\\u914D\\u4E3B\\u8981/\\u6B21\\u8981\\u5173\\u952E\\u8BCD\\u540E\\u6FC0\\u6D3B\\uFF0C\\u53EF\\u7ED3\\u5408\\u6982\\u7387\\u4E0E\\u626B\\u63CF\\u6DF1\\u5EA6\\u63A7\\u5236\\u89E6\\u53D1\\u3002\",strategyType:\"selective\",toastLabel:\"\\u5173\\u952E\\u8BCD\\u89E6\\u53D1\",accentVar:\"--rlh-status-selective\",badgeClass:\"rlh-status-badge--selective\",order:1},{id:\"vectorized\",label:\"\\u5411\\u91CF\\u5316\",shortLabel:\"\\u5411\\u91CF\",description:\"\\u4F9D\\u8D56\\u5411\\u91CF\\u76F8\\u4F3C\\u5EA6\\u6FC0\\u6D3B\\uFF0C\\u9002\\u7528\\u4E8E\\u8BED\\u4E49\\u53EC\\u56DE\\u573A\\u666F\\u3002\",strategyType:\"vectorized\",toastLabel:\"\\u5411\\u91CF\\u5316\",accentVar:\"--rlh-status-vectorized\",badgeClass:\"rlh-status-badge--vectorized\",order:2}],jt=Xo.map(e=>Object.freeze({...e,id:String(e.id).toLowerCase(),strategyType:String(e.strategyType??e.id).toLowerCase(),toastLabel:e.toastLabel??e.label,shortLabel:e.shortLabel??e.label})),it={};jt.forEach(e=>{it[e.id]=e,it[e.strategyType]=e});var ht=Object.freeze(it),Wr=Object.freeze([...jt].sort((e,r)=>e.order-r.order)),Ce=ht.constant,Gr=Ce?.id??\"constant\",Cr=e=>{if(!e&&e!==0)return null;let r=String(e).trim().toLowerCase();return ht[r]?.id??null},Ge=e=>{let r=Cr(e);return r?ht[r]??null:null};var Ke={position:{before_character_definition:\"\\u89D2\\u8272\\u5B9A\\u4E49\\u524D\",after_character_definition:\"\\u89D2\\u8272\\u5B9A\\u4E49\\u540E\",before_example_messages:\"\\u804A\\u5929\\u793A\\u4F8B\\u524D\",after_example_messages:\"\\u804A\\u5929\\u793A\\u4F8B\\u540E\",before_author_note:\"\\u4F5C\\u8005\\u7B14\\u8BB0\\u524D\",after_author_note:\"\\u4F5C\\u8005\\u7B14\\u8BB0\\u540E\",at_depth_as_system:\"@D \\u2699 \\u7CFB\\u7EDF\",at_depth_as_assistant:\"@D \\u{1F5E8}\\uFE0F \\u89D2\\u8272\",at_depth_as_user:\"@D \\u{1F464} \\u7528\\u6237\"},logic:{and_any:\"\\u4EFB\\u4E00 AND\",and_all:\"\\u6240\\u6709 AND\",not_any:\"\\u4EFB\\u4E00 NOT\",not_all:\"\\u6240\\u6709 NOT\"}},vr={bookName:\"\\u4E66\\u540D\",entryName:\"\\u6761\\u76EE\\u540D\",keywords:\"\\u5173\\u952E\\u8BCD\",content:\"\\u5185\\u5BB9\"},pt={entryName:\"\\u540D\\u79F0\",content:\"\\u5185\\u5BB9\"},Wt={bookName:{id:\"rlh-filter-book-name\"},entryName:{id:\"rlh-filter-entry-name\"},keywords:{id:\"rlh-filter-keywords\"},content:{id:\"rlh-filter-content\"}},Gt={status:{value:\"status\",label:\"\\u6309\\u542F\\u7528\\u72B6\\u6001\"},name:{value:\"name\",label:\"\\u540D\\u79F0\\u6392\\u5E8F\"}},t={regexes:{global:[],character:[]},lorebooks:{character:[]},chatLorebook:null,allLorebooks:[],lorebookEntries:new Map,pendingLorebookUpdates:new Map,pendingRegexUpdates:new Set,lorebookUsage:new Map,activeTab:\"global-lore\",activeView:\"global-lore-list\",activeBookName:null,activeCharacterBook:null,charLoreInitialSynced:!1,pendingHighlightEntry:null,isDataLoaded:!1,isLoadingTabData:!1,loadingBookName:null,searchFilters:{bookName:!0,entryName:!0,keywords:!0,content:!0},multiSelectMode:!1,multiSelectTarget:\"book\",selectedItems:new Set,globalSearch:{term:\"\",replace:\"\"},searchFilterContextsInitialized:new Set,collapseStateByContext:new Map,sortModeByContext:new Map,characterContext:{name:null,id:null},saveStatus:\"idle\",saveRetryAttempt:0,isToolbarCollapsed:!0,isDragSortDisabled:!1,paths:{rlhRoot:nt,vendor:nt?`${nt}/vendor`:\"\"}},Kt=e=>!e&&e!==0?\"\":typeof e==\"string\"?e.trim():e&&typeof e==\"object\"&&typeof e.name==\"string\"?e.name.trim():String(e??\"\").trim(),Dt=(e,r)=>{if(!e||!r&&r!==0)return;let o=typeof r==\"string\"?r.trim():String(r).trim();o&&e.add(o)},Kr=e=>{let r=Kt(e);return r?`book:${r}`:\"\"},Vt=e=>{let r=new Set,o=new Set,l=typeof e==\"string\"?{name:e}:e??{},a=Kt(l),n=m=>Dt(r,m),i=m=>Dt(o,m);if(l&&typeof l==\"object\"&&(Array.isArray(l.characters)?l.characters.forEach(n):l.characters&&typeof l.characters==\"object\"&&Object.values(l.characters).forEach(n),Array.isArray(l.charIds)?l.charIds.forEach(i):Array.isArray(l.characterIds)?l.characterIds.forEach(i):l.charIds&&typeof l.charIds==\"object\"&&Object.values(l.charIds).forEach(i)),a&&t.lorebookUsage instanceof Map&&t.lorebookUsage.has(a)){let m=t.lorebookUsage.get(a);Array.isArray(m)&&m.forEach(n)}let b=r.size+o.size;return{name:a,characters:[...r],charIds:[...o],bindingCount:b}};var Ut=\"RegexLoreHubAnalytics\",Jo=\"select_unbound_lorebooks\",Qo=\"v3.2\",Zo=500,Ht=new Map,ut=(e={})=>{try{let r=Date.now(),o=typeof e.category==\"string\"?e.category.trim():\"\",l=typeof e.action==\"string\"?e.action.trim():\"\",a=o||\"unknown\",n=l||\"unknown\",i=`${a}::${n}`,b=Ht.get(i)??0;if(r-b<Zo)return;Ht.set(i,r);let m=typeof t.activeView==\"string\"?t.activeView.trim():\"\",u=typeof e.feature==\"string\"&&e.feature.trim()?e.feature.trim():Jo,p=typeof e.view==\"string\"&&e.view.trim()?e.view.trim():m||\"unknown\",g={source:\"regex-lore-hub\",timestamp:r,version:Qo,...e,category:a,action:n,feature:u,view:p},v=ke(),E=v?.CustomEvent||(typeof CustomEvent==\"function\"?CustomEvent:null);if(v&&typeof v.dispatchEvent==\"function\"&&E){v.dispatchEvent(new E(Ut,{detail:g}));return}if(typeof window<\"u\"&&typeof window.dispatchEvent==\"function\"&&E){window.dispatchEvent(new E(Ut,{detail:g}));return}console.info(\"[RegexLoreHub] Analytics event captured:\",g)}catch(r){console.warn(\"[RegexLoreHub] emitAnalyticsEvent \\u8C03\\u7528\\u5931\\u8D25\\uFF1A\",r)}},ee=e=>{try{(!t.lorebookEntries||!(t.lorebookEntries instanceof Map))&&(console.warn(\"[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...\"),t.lorebookEntries=new Map),typeof t.lorebookEntries.get!=\"function\"&&(console.warn(\"[RegexLoreHub] appState.lorebookEntries.get is not a function, reinitializing...\"),t.lorebookEntries=new Map);let r=t.lorebookEntries.get(e);return Array.isArray(r)?r:[]}catch(r){return console.error(\"[RegexLoreHub] Error in safeGetLorebookEntries:\",r),t.lorebookEntries=new Map,[]}},Re=(e,r)=>{try{(!t.lorebookEntries||!(t.lorebookEntries instanceof Map))&&(console.warn(\"[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...\"),t.lorebookEntries=new Map),typeof t.lorebookEntries.set!=\"function\"&&(console.warn(\"[RegexLoreHub] appState.lorebookEntries.set is not a function, reinitializing...\"),t.lorebookEntries=new Map),t.lorebookEntries.set(e,Array.isArray(r)?r:[])}catch(o){console.error(\"[RegexLoreHub] Error in safeSetLorebookEntries:\",o),t.lorebookEntries=new Map,t.lorebookEntries.set(e,Array.isArray(r)?r:[])}},Nr=e=>{try{if(!t.lorebookEntries||!(t.lorebookEntries instanceof Map)){console.warn(\"[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...\"),t.lorebookEntries=new Map;return}if(typeof t.lorebookEntries.delete!=\"function\"){console.warn(\"[RegexLoreHub] appState.lorebookEntries.delete is not a function, reinitializing...\"),t.lorebookEntries=new Map;return}t.lorebookEntries.delete(e)}catch(r){console.error(\"[RegexLoreHub] Error in safeDeleteLorebookEntries:\",r),t.lorebookEntries=new Map}},bt=()=>{try{if(!t.lorebookEntries||!(t.lorebookEntries instanceof Map)){console.warn(\"[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...\"),t.lorebookEntries=new Map;return}if(typeof t.lorebookEntries.clear!=\"function\"){console.warn(\"[RegexLoreHub] appState.lorebookEntries.clear is not a function, reinitializing...\"),t.lorebookEntries=new Map;return}t.lorebookEntries.clear()}catch(e){console.error(\"[RegexLoreHub] Error in safeClearLorebookEntries:\",e),t.lorebookEntries=new Map}},mt=e=>{try{return!t.lorebookEntries||!(t.lorebookEntries instanceof Map)?(console.warn(\"[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...\"),t.lorebookEntries=new Map,!1):typeof t.lorebookEntries.has!=\"function\"?(console.warn(\"[RegexLoreHub] appState.lorebookEntries.has is not a function, reinitializing...\"),t.lorebookEntries=new Map,!1):t.lorebookEntries.has(e)}catch(r){return console.error(\"[RegexLoreHub] Error in safeHasLorebookEntries:\",r),t.lorebookEntries=new Map,!1}};function ke(){return window.parent||window}function fe(){return ke().document}var O=e=>{if(typeof e!=\"string\")return String(e);let r=fe().createElement(\"div\");return r.textContent=e,r.innerHTML},cr=(e,r)=>{if(!r||!e)return O(e);let o=O(e),l=O(r),a=new Set([\".\",\"*\",\"+\",\"?\",\"^\",\"$\",\"{\",\"}\",\"(\",\")\",\"|\",\"[\",\"]\",\"\\\\\\\\\"]),n=\"\";for(let b of l)n+=a.has(b)?\"\\\\\"+b:b;let i=new RegExp(`(${n})`,\"gi\");return o.replace(i,'<mark class=\"rlh-highlight\">$1</mark>')},he=(e,r=\"success\",o=2e3)=>{let l=ce(),a=fe();if(!l||!a)return;let n=l(`#${me}`,a);if(n.length===0)return;n.find(\".rlh-toast-notification\").remove();let i={success:\"fa-check-circle\",error:\"fa-times-circle\",info:\"fa-info-circle\"}[r],b=`\n    <div class=\"rlh-toast-notification ${r}\">\n      <i class=\"fa-solid ${i}\"></i> ${O(e)}\n    </div>\n  `,m=l(b);n.append(m),setTimeout(()=>m.addClass(\"visible\"),10),setTimeout(()=>{m.removeClass(\"visible\"),setTimeout(()=>m.remove(),300)},o)},Qe=(e=\"\\u6B63\\u5728\\u5904\\u7406...\")=>{let r=ce(),o=fe();if(!r||!o)return{update:()=>{},remove:()=>{}};let l=r(`#${me}`,o);if(l.length===0)return{update:()=>{},remove:()=>{}};l.find(\".rlh-progress-toast\").remove();let a=`<div class=\"rlh-progress-toast\"><i class=\"fa-solid fa-spinner fa-spin\"></i> <span class=\"rlh-progress-text\">${O(e)}</span></div>`,n=r(a);return l.append(n),setTimeout(()=>n.addClass(\"visible\"),10),{update:m=>{n.find(\".rlh-progress-text\").html(O(m))},remove:()=>{n.removeClass(\"visible\"),setTimeout(()=>n.remove(),300)}}},q=e=>{let r=ce(),o=fe();return!r||!o?Promise.reject():new Promise((l,a)=>{let{type:n=\"alert\",title:i=\"\\u901A\\u77E5\",text:b=\"\",html:m=\"\",placeholder:u=\"\",value:p=\"\"}=e||{},g=\"\";n===\"alert\"?g='<button class=\"rlh-modal-btn rlh-modal-ok\">\\u786E\\u5B9A</button>':n===\"confirm\"?g='<button class=\"rlh-modal-btn rlh-modal-cancel\">\\u53D6\\u6D88</button><button class=\"rlh-modal-btn rlh-modal-ok\">\\u786E\\u8BA4</button>':n===\"prompt\"&&(g='<button class=\"rlh-modal-btn rlh-modal-cancel\">\\u53D6\\u6D88</button><button class=\"rlh-modal-btn rlh-modal-ok\">\\u786E\\u5B9A</button>');let v=n===\"prompt\"?`<input type=\"text\" class=\"rlh-modal-input\" placeholder=\"${O(u)}\" value=\"${O(p)}\">`:\"\",E=m||`<p>${O(b)}</p>`,w=`<div class=\"rlh-modal-overlay\"><div class=\"rlh-modal-content\"><div class=\"rlh-modal-header\">${O(i)}</div><div class=\"rlh-modal-body\">${E}${v}</div><div class=\"rlh-modal-footer\">${g}</div></div></div>`,k=r(w).hide(),C=r(`#${me}`,o);C.length>0?C.append(k):r(\"body\",o).append(k),k.fadeIn(200);let s=k.find(\".rlh-modal-input\");n===\"prompt\"&&s.focus().select();let f=(x,A)=>{k.fadeOut(200,()=>{k.remove(),x?l(A):a()})};k.on(\"click\",\".rlh-modal-ok\",()=>{let x=n===\"prompt\"?s.val():!0;if(n===\"prompt\"&&!String(x).trim()){s.addClass(\"rlh-input-error\"),setTimeout(()=>s.removeClass(\"rlh-input-error\"),500);return}f(!0,x)}),k.on(\"click\",\".rlh-modal-cancel\",()=>f(!1)),n===\"prompt\"&&s.on(\"keydown\",x=>{x.key===\"Enter\"?k.find(\".rlh-modal-ok\").click():x.key===\"Escape\"&&k.find(\".rlh-modal-cancel\").click()})})},I=(e,r=\"RegexLoreHub\",o={})=>{let{notify:l=\"toast\",toastType:a=\"error\",toastDuration:n=4e3,toastMessage:i=\"\\u64CD\\u4F5C\\u53D1\\u751F\\u5F02\\u5E38\\uFF0C\\u8BF7\\u67E5\\u770B\\u63A7\\u5236\\u53F0\\u83B7\\u53D6\\u8BE6\\u7EC6\\u4FE1\\u606F\\u3002\",modalTitle:b=\"\\u811A\\u672C\\u5F02\\u5E38\",modalText:m=\"\\u64CD\\u4F5C\\u4E2D\\u53D1\\u751F\\u672A\\u77E5\\u9519\\u8BEF\\uFF0C\\u8BF7\\u68C0\\u67E5\\u5F00\\u53D1\\u8005\\u63A7\\u5236\\u53F0\\u83B7\\u53D6\\u8BE6\\u7EC6\\u4FE1\\u606F\\u3002\"}=o??{};return async(...u)=>{try{return await e(...u)}catch(p){if(!p)return;if(console.error(`[${r}] Error:`,p),l===\"modal\"){await q({type:\"alert\",title:b,text:m});return}l===\"toast\"&&he(i,a,n)}}};function ft(e,r){let o;return function(...l){let a=this;clearTimeout(o),o=setTimeout(()=>e.apply(a,l),r)}}var Yt=(e,r)=>{let o=e.replace(/[.*+?^${}()|[\\]\\/\\\\]/g,\"\\\\$&\"),l=r?\"g\":\"gi\";return new RegExp(o,l)},qt={INSERT_RULES_TITLE:\"\\u63D2\\u5165\\u89C4\\u5219\"};var yr=e=>e.instanceKey||e.id||\"default\",dr=e=>{let r=yr(e);return t.collapseStateByContext.get(r)??\"expanded\"},Xt=(e,r)=>{let o=yr(e);t.collapseStateByContext.set(o,r)},or=e=>{let r=Array.isArray(e.sortOptions)?e.sortOptions:[];if(!r.length)return null;let o=yr(e),l=t.sortModeByContext.get(o);if(l&&r.includes(l))return l;let a=r[0];return t.sortModeByContext.set(o,a),a},Jt=(e,r)=>{if(!(e.sortOptions??[]).includes(r))return;let l=yr(e);t.sortModeByContext.set(l,r)},Rr=e=>O(String(e??\"\")),Yr=e=>Ge(e)??Ce,qr=(e,{shortLabel:r=!1,withIcon:o=!0}={})=>{let l=Yr(e),a=r?l.shortLabel:l.label,n=o?'<i class=\"fa-solid fa-circle\"></i>':\"\";return`<span class=\"rlh-status-badge ${l.badgeClass??\"\"}\" data-status-id=\"${Rr(l.id)}\">${n}<span class=\"rlh-status-badge__text\">${O(a)}</span></span>`},el=()=>Wr.map(e=>{let r=qr(e.id,{shortLabel:!0});return`<li role=\"presentation\"><button type=\"button\" class=\"rlh-unified-status-option\" data-status-id=\"${Rr(e.id)}\" role=\"option\" aria-selected=\"false\">${r}<span class=\"rlh-unified-status-option__label\">${O(e.label)}</span></button></li>`}).join(\"\"),rl=(e,r)=>{let o=e.visibleFilters??[];if(!o.length)return\"\";let l=o.map(a=>{let n=Wt[a];if(!n)return\"\";let i=e.filterLabels?.[a]??vr[a]??a,b=r[a];return`<label class=\"rlh-filter-item\"><input type=\"checkbox\" id=\"${n.id}\" data-filter-key=\"${a}\" ${b?\"checked\":\"\"}>${i}</label>`}).filter(Boolean).join(\"\");return l?`<div class=\"rlh-filter-list\" id=\"rlh-search-filters-container\">${l}</div>`:\"\"},tl=(e,r)=>{let o=Array.isArray(e.sortOptions)?e.sortOptions:[];if(!o.length)return\"\";let l=o.map(n=>{let i=Gt[n];if(!i)return\"\";let b=i.value===r;return`<li role=\"presentation\"><button type=\"button\" class=\"rlh-sort-option${b?\" active\":\"\"}\" data-sort-value=\"${i.value}\" role=\"option\" aria-selected=\"${b?\"true\":\"false\"}\">${i.label}</button></li>`}).filter(Boolean).join(\"\");if(!l)return\"\";let a=`${gr}-list`;return`<div class=\"rlh-sort-menu\" id=\"${gr}\" data-open=\"false\"><button type=\"button\" id=\"${rr}\" class=\"rlh-toolbar-btn\" data-current-sort=\"${r??\"\"}\" aria-haspopup=\"listbox\" aria-expanded=\"false\" aria-controls=\"${a}\"><i class=\"fa-solid fa-sort\"></i><span>\\u6392\\u5E8F</span></button><ul class=\"rlh-sort-menu-list\" id=\"${a}\" role=\"listbox\" aria-labelledby=\"${rr}\">${l}</ul></div>`},ol=e=>{if(!e.showPositionMenu)return\"\";let r=new Map;t.selectedItems.forEach(k=>{if(typeof k!=\"string\"||!k.startsWith(\"lore:\"))return;let C=k.lastIndexOf(\":\");if(C===-1)return;let s=k.slice(5,C),f=k.slice(C+1);f&&(r.has(s)||r.set(s,[]),r.get(s).push(f))});let o=e.activeBookName?.toString().trim()??\"\";!o&&r.size===1&&(o=[...r.keys()][0]??\"\");let l=o?ee(o):[],a=l.length>0,n=t.multiSelectMode&&t.multiSelectTarget===\"entry\",i=o?r.get(o)??[]:[],b=!!o&&(n?i.length>0:a),m;o?!a&&!n?m=`\\u300C${o}\\u300D\\u6682\\u65E0\\u6761\\u76EE\\u53EF\\u8C03\\u6574`:n?m=i.length>0?`\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u5C06\\u5BF9\\u5DF2\\u9009\\u4E2D\\u7684 ${i.length} \\u4E2A\\u6761\\u76EE\\u7EDF\\u4E00\\u4F4D\\u7F6E`:\"\\u5DF2\\u5F00\\u542F\\u591A\\u9009\\uFF0C\\u8BF7\\u5148\\u52FE\\u9009\\u8981\\u8C03\\u6574\\u4F4D\\u7F6E\\u7684\\u6761\\u76EE\":m=`\\u5C06\\u5BF9\\u300C${o}\\u300D\\u4E2D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u7EDF\\u4E00\\u4F4D\\u7F6E`:m=r.size>0?\"\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u672A\\u80FD\\u8BC6\\u522B\\u9009\\u4E2D\\u7684\\u6761\\u76EE\\u5F52\\u5C5E\\uFF0C\\u8BF7\\u91CD\\u65B0\\u9009\\u62E9\":\"\\u8BF7\\u5148\\u6253\\u5F00\\u9700\\u8981\\u7EDF\\u4E00\\u4F4D\\u7F6E\\u7684\\u4E16\\u754C\\u4E66\";let u=new Set(l.map(k=>(k?.position??\"before_character_definition\").toString())),p=u.size===1?u.values().next().value:null,g=`${Je}-list`,v=['type=\"button\"',`id=\"${Ye}\"`,'class=\"rlh-toolbar-btn\"','aria-haspopup=\"listbox\"','aria-expanded=\"false\"',`aria-controls=\"${g}\"`,`title=\"${O(m)}\"`];b||v.push(\"disabled\"),o&&v.push(`data-book-name=\"${O(o)}\"`);let E=Object.entries(Ke.position).map(([k,C])=>{let s=a&&p===k,f=['type=\"button\"',`class=\"rlh-position-option${s?\" active\":\"\"}\"`,`data-position-value=\"${O(k)}\"`,'role=\"option\"',`aria-selected=\"${s?\"true\":\"false\"}\"`];return o&&f.push(`data-book-name=\"${O(o)}\"`),`<li role=\"presentation\"><button ${f.join(\" \")}>${O(C)}</button></li>`}).join(\"\"),w=['class=\"rlh-position-menu\"',`id=\"${Je}\"`,'data-open=\"false\"'];return o&&w.push(`data-book-name=\"${O(o)}\"`),`<div ${w.join(\" \")}><button ${v.join(\" \")}><i class=\"fa-solid fa-map-pin\"></i><span>\\u7EDF\\u4E00\\u4F4D\\u7F6E</span></button><ul class=\"rlh-position-menu-list\" id=\"${g}\" role=\"listbox\" aria-labelledby=\"${Ye}\">${E}</ul></div>`},Qt=(e,{$toolbar:r,$replaceContainer:o})=>{let l=dr(e),a=e.sortOptions?.length??0?or(e):null,n=[\"rlh-toolbar-btn\"];t.multiSelectMode&&n.push(\"active\"),e.supportsMultiSelect||n.push(\"disabled\");let i=['type=\"button\"','id=\"rlh-multi-select-btn\"',`class=\"${n.join(\" \")}\"`,`data-target=\"${e.supportsMultiSelect?e.multiSelectTarget:\"\"}\"`];e.supportsMultiSelect||i.push(\"disabled\");let b=`<button ${i.join(\" \")}><i class=\"fa-solid fa-check-double\"></i><span>\\u591A\\u9009\\u6A21\\u5F0F</span></button>`,m=[\"rlh-multi-select-controls\"];t.multiSelectMode&&m.push(\"active\");let u=e.supportsMultiSelect?`\n        <div id=\"rlh-multi-select-controls\" class=\"${m.join(\" \")}\">\n          <div class=\"rlh-multi-select-actions\">\n            <button class=\"rlh-multi-select-action-btn\" id=\"rlh-select-all-btn\" title=\"\\u5168\\u9009\">\\u5168</button>\n            <button class=\"rlh-multi-select-action-btn\" id=\"rlh-select-none-btn\" title=\"\\u6E05\\u9664\">\\u6E05</button>\n            <button class=\"rlh-multi-select-action-btn\" id=\"rlh-select-invert-btn\" title=\"\\u53CD\\u9009\">\\u53CD</button>\n            <button class=\"rlh-multi-select-action-btn enable\" id=\"rlh-batch-enable-btn\" title=\"\\u542F\\u7528\">\\u5F00</button>\n            <button class=\"rlh-multi-select-action-btn disable\" id=\"rlh-batch-disable-btn\" title=\"\\u7981\\u7528\">\\u5173</button>\n            <button class=\"rlh-multi-select-action-btn disable\" id=\"rlh-batch-delete-btn\" title=\"\\u5220\\u9664\">\\u5220</button>\n          </div>\n          <span class=\"rlh-selection-count\" id=\"rlh-selection-count\">\\u5DF2\\u9009\\u62E9: ${t.selectedItems.size}</span>\n        </div>\n      `:\"\",p=`\n        <div class=\"rlh-multi-select-module\">\n          ${b}\n          ${u}\n        </div>\n      `,g=e.supportsMultiSelect&&e.multiSelectTarget===\"entry\"?(()=>{let N=`${xr}`,B=`${xr}-list`,R=el(),H=[\"rlh-unified-status\"];t.multiSelectMode&&H.push(\"is-multiselect\");let j=new Map;t.selectedItems.forEach(Le=>{if(typeof Le!=\"string\"||!Le.startsWith(\"lore:\"))return;let ve=Le.lastIndexOf(\":\");if(ve===-1)return;let Fe=Le.slice(5,ve),we=Le.slice(ve+1);we&&(j.has(Fe)||j.set(Fe,[]),j.get(Fe).push(we))});let W=[e.activeBookName,t.activeBookName,t.activeCharacterBook,t.chatLorebook].find(Le=>typeof Le==\"string\"&&Le.trim().length>0)?.toString().trim()??\"\";!W&&j.size===1&&(W=[...j.keys()][0]??\"\");let be=(W?ee(W):[]).length>0,ue=t.multiSelectMode&&t.multiSelectTarget===\"entry\",xe=W?j.get(W)??[]:[],Oe=Array.from(j.values()).reduce((Le,ve)=>Le+(Array.isArray(ve)?ve.length:0),0),ir=!!W&&(ue?xe.length>0:be),De;return W?!be&&!ue?De=`\\u300C${W}\\u300D\\u6682\\u65E0\\u6761\\u76EE\\u53EF\\u8C03\\u6574`:ue?De=xe.length>0?`\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u5C06\\u5BF9\\u5DF2\\u9009\\u4E2D\\u7684 ${xe.length} \\u4E2A\\u6761\\u76EE\\u7EDF\\u4E00\\u72B6\\u6001`:\"\\u5DF2\\u5F00\\u542F\\u591A\\u9009\\uFF0C\\u8BF7\\u5148\\u52FE\\u9009\\u8981\\u8C03\\u6574\\u72B6\\u6001\\u7684\\u6761\\u76EE\":De=`\\u5C06\\u5BF9\\u300C${W||\"\\u5F53\\u524D\\u4E16\\u754C\\u4E66\"}\\u300D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u7EDF\\u4E00\\u72B6\\u6001`:De=j.size>0?\"\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u672A\\u80FD\\u8BC6\\u522B\\u9009\\u4E2D\\u7684\\u6761\\u76EE\\u5F52\\u5C5E\\uFF0C\\u8BF7\\u91CD\\u65B0\\u9009\\u62E9\":\"\\u8BF7\\u5148\\u6253\\u5F00\\u9700\\u8981\\u7EDF\\u4E00\\u72B6\\u6001\\u7684\\u4E16\\u754C\\u4E66\",`\n            <div class=\"${H.join(\" \")}\" id=\"${N}\" data-open=\"false\">\n              <button type=\"button\" id=\"${tr}\" class=\"rlh-toolbar-btn\" aria-haspopup=\"listbox\" aria-expanded=\"false\" aria-controls=\"${B}\" ${ir?\"\":\"disabled\"} title=\"${O(De)}\">\n                <i class=\"fa-solid fa-layer-group\"></i><span>\\u7EDF\\u4E00\\u72B6\\u6001</span>\n              </button>\n              <ul class=\"rlh-unified-status-menu\" id=\"${B}\" role=\"listbox\">\n                ${R}\n              </ul>\n            </div>\n          `})():\"\",v=\"\";e.showCollapseToggle&&(v=`<button type=\"button\" id=\"${fr}\" class=\"rlh-toolbar-btn\" data-collapse-state=\"${l}\"><i class=\"fa-solid ${l===\"collapsed\"?\"fa-expand-arrows-alt\":\"fa-compress-arrows-alt\"}\"></i><span>${l===\"collapsed\"?\"\\u5168\\u90E8\\u5C55\\u5F00\":\"\\u5168\\u90E8\\u6298\\u53E0\"}</span></button>`);let E=e.showRecursion?(()=>{let N=e.activeBookName??\"\",B=['type=\"button\"',`id=\"${zt}\"`,'class=\"rlh-toolbar-btn rlh-batch-recursion-btn\"'];return N?B.push(`data-book-name=\"${O(N)}\"`):B.push(\"disabled\"),`<button ${B.join(\" \")}><i class=\"fa-solid fa-shield-halved\"></i><span>\\u5168\\u5F00\\u9632\\u9012\\u5F52</span></button>`})():\"\",w=e.showFixKeywords?(()=>{let N=e.activeBookName??\"\",B=['type=\"button\"',`id=\"${Ft}\"`,'class=\"rlh-toolbar-btn rlh-fix-keywords-btn\"'];return N?B.push(`data-book-name=\"${O(N)}\"`):B.push(\"disabled\"),`<button ${B.join(\" \")}><i class=\"fa-solid fa-check-double\"></i><span>\\u4FEE\\u590D\\u5173\\u952E\\u8BCD</span></button>`})():\"\",k=ol(e),C=tl(e,a),s=rl(e,t.searchFilters),f=O(e.scopeLabel),x=O(e.searchPlaceholder),A=Rr(t.globalSearch.term??\"\"),K=`<div class=\"rlh-search-row\">${`<label class=\"rlh-search-field\">\n          <input type=\"search\" id=\"${er}\" class=\"rlh-search-input\" placeholder=\"${x}\" value=\"${A}\" autocomplete=\"off\" />\n        </label>`}<button type=\"button\" id=\"rlh-search-clear-btn\" class=\"rlh-toolbar-icon-btn\" title=\"\\u6E05\\u7A7A\"><i class=\"fa-solid fa-eraser\"></i></button></div>`,ne=Rr(t.globalSearch.replace??\"\"),F=e.showReplace?`<div class=\"rlh-replace-body\"><input type=\"text\" id=\"${mr}\" class=\"rlh-replace-input\" placeholder=\"\\u66FF\\u6362\\u4E3A...\" value=\"${ne}\" /><button type=\"button\" id=\"rlh-replace-btn\" class=\"rlh-toolbar-icon-btn rlh-replace-action\" title=\"\\u66FF\\u6362\"><i class=\"fa-solid fa-repeat\"></i></button></div>`:\"\",X=`<div class=\"rlh-search-meta\">\n          ${s}\n          <span class=\"rlh-search-scope\">${f}</span>\n        </div>`,D=`<div class=\"rlh-search-box\">${K}${F}${X}</div>`,Z=\"\";if(e.primaryAction?.visible&&e.primaryAction.scope===\"entry\"){let N=e.activeBookName??\"\",B=!N,R=[\"rlh-toolbar-btn\",\"rlh-create-entry-btn\"];B&&R.push(\"disabled\");let H=['type=\"button\"',`class=\"${R.join(\" \")}\"`],j=e.primaryAction.title??e.primaryAction.label??\"\";j&&H.push(`title=\"${O(j)}\"`),B?H.push(\"disabled\"):H.push(`data-book-name=\"${O(N)}\"`);let J=e.primaryAction.icon?e.primaryAction.icon:\"fa-file-circle-plus\",W=O(e.primaryAction.label??\"\\u65B0\\u5EFA\\u6761\\u76EE\");Z=`<button ${H.join(\" \")}><i class=\"fa-solid ${J}\"></i><span>${W}</span></button>`}let pe=\"\";if(e.primaryAction?.visible&&e.primaryAction.scope===\"book\"){let B=['type=\"button\"','id=\"regex-lore-hub-create-lorebook-btn\"',`class=\"${[\"rlh-toolbar-btn\",\"rlh-create-book-btn\"].join(\" \")}\"`],R=e.primaryAction.title??e.primaryAction.label??\"\";R&&B.push(`title=\"${O(R)}\"`);let H=e.primaryAction.icon?e.primaryAction.icon:\"fa-plus\",j=O(e.primaryAction.label??\"\\u65B0\\u5EFA\\u4E16\\u754C\\u4E66\");pe=`<button ${B.join(\" \")}><i class=\"fa-solid ${H}\"></i><span>${j}</span></button>`}let ae=e.id===\"global-lore-list\"?'<button type=\"button\" class=\"rlh-toolbar-btn rlh-select-unbound\" title=\"\\u4E00\\u952E\\u9009\\u4E2D\\u672A\\u7ED1\\u5B9A\\u4EFB\\u4F55\\u89D2\\u8272\\u5361\\u7684\\u4E16\\u754C\\u4E66\"><i class=\"fa-solid fa-link-slash\"></i><span>\\u9009\\u62E9\\u5B64\\u7ACB\\u4E16\\u754C\\u4E66</span></button>':\"\",de=`\n    <div class=\"rlh-toolbar-section rlh-toolbar-section--search\">\n      <div class=\"rlh-search-section-grid\">\n        <div class=\"rlh-search-section-main\">\n          ${D}\n        </div>\n        <div class=\"rlh-search-section-multiselect\">\n          ${p}\n        </div>\n      </div>\n    </div>\n  `,re=[pe,ae,Z,e.showCollapseToggle?v:\"\",E,w,g,k,C].filter(Boolean),d=re.length?`\n        <div class=\"rlh-toolbar-section rlh-toolbar-section--actions\">\n          <div class=\"rlh-toolbar-actions\">\n            ${re.join(\"\")}\n          </div>\n        </div>\n      `:\"\",T=`\n    <div class=\"rlh-toolbar-inner\">\n      ${[de,d].filter(Boolean).join(\"\")}\n    </div>\n\n  `;if(r.html(T),e.supportsMultiSelect&&e.multiSelectTarget===\"entry\"){let B=[e.activeBookName,t.activeBookName,t.activeCharacterBook,t.chatLorebook].find(ue=>typeof ue==\"string\"&&ue.trim().length>0)?.toString().trim()??\"\",R=B?ee(B):[],H=R.length>0,j=t.multiSelectMode&&t.multiSelectTarget===\"entry\",J=j&&R.length>0&&[...t.selectedItems].some(ue=>ue.startsWith(`lore:${B}:`)),W=H&&(!j||J),te=H?j?J?\"\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u4EC5\\u5BF9\\u9009\\u4E2D\\u7684\\u6761\\u76EE\\u7EDF\\u4E00\\u72B6\\u6001\":\"\\u5DF2\\u5F00\\u542F\\u591A\\u9009\\uFF0C\\u8BF7\\u5148\\u52FE\\u9009\\u8981\\u8C03\\u6574\\u72B6\\u6001\\u7684\\u6761\\u76EE\":`\\u5C06\\u5BF9\\u300C${B||\"\\u5F53\\u524D\\u4E16\\u754C\\u4E66\"}\\u300D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u7EDF\\u4E00\\u72B6\\u6001`:B?`\\u300C${B}\\u300D\\u6682\\u65E0\\u6761\\u76EE\\u53EF\\u8C03\\u6574`:\"\\u8BF7\\u5148\\u6253\\u5F00\\u9700\\u8981\\u7EDF\\u4E00\\u72B6\\u6001\\u7684\\u4E16\\u754C\\u4E66\",be=$(`#${tr}`,r);be.length&&(be.attr(\"title\",te),W?be.removeAttr(\"disabled\"):be.attr(\"disabled\",\"disabled\"))}o.empty()},hr=(e,r)=>{let o=r.toLowerCase();return!!(!o||t.searchFilters.entryName&&(e.name||\"\").toLowerCase().includes(o)||t.searchFilters.keywords&&e.keys.join(\" \").toLowerCase().includes(o)||t.searchFilters.content&&e.content&&e.content.toLowerCase().includes(o))},Zt=(e,r)=>{let o=r.toLowerCase();return!!(t.searchFilters.entryName&&(e.script_name||\"\").toLowerCase().includes(o)||t.searchFilters.content&&(e.find_regex||\"\").toLowerCase().includes(o)||t.searchFilters.content&&(e.replace_string||\"\").toLowerCase().includes(o))},eo=(e,r,o,l)=>{let a=ce(),n=t.lorebookUsage.get(e.name)||[],i=n.length>0?`<div class=\"rlh-used-by-chars\">\\u4F7F\\u7528\\u8005: ${n.map(f=>`<span>${O(f)}</span>`).join(\", \")}</div>`:\"\",b=cr(e.name,r),m=t.multiSelectMode&&t.multiSelectTarget===\"book\",u=Kr(e.name),p=typeof u==\"string\"&&u.length>0,g=m&&p&&t.selectedItems.has(u),v=m?`<label class=\"rlh-selection-control\"><input type=\"checkbox\" class=\"rlh-multi-select-checkbox\" data-select-key=\"${O(u)}\" ${g?\"checked\":\"\"}></label>`:\"\",E=a(`\n      <div class=\"rlh-book-group\" data-book-name=\"${O(e.name)}\" data-select-key=\"${O(u)}\">\n          <div class=\"rlh-global-book-header rlh-clickable-header\">\n              ${v}\n              <div class=\"rlh-book-title-wrapper\">\n                  <span class=\"rlh-item-name\">${b}</span>\n                  <div class=\"rlh-book-stats\">\\u6761\\u76EE: ${e.enabledEntryCount} / ${e.entryCount}</div>\n              </div>\n              <div class=\"rlh-item-controls\">\n                  <button class=\"rlh-action-btn-icon rlh-rename-book-btn\" title=\"\\u91CD\\u547D\\u540D\\u4E16\\u754C\\u4E66\"><i class=\"fa-solid fa-pen-to-square\"></i></button>\n                  <button class=\"rlh-toggle-btn rlh-global-toggle\" title=\"\\u542F\\u7528/\\u7981\\u7528\\u6574\\u4E2A\\u4E16\\u754C\\u4E66\"><i class=\"fa-solid fa-power-off\"></i></button>\n                  <button class=\"rlh-action-btn-icon rlh-delete-book-btn\" title=\"\\u5220\\u9664\\u4E16\\u754C\\u4E66\"><i class=\"fa-solid fa-folder-minus\"></i></button>\n              </div>\n          </div>\n          ${n.length>0?`<div class=\"rlh-book-summary\">${i}</div>`:\"\"}\n          <div class=\"rlh-collapsible-content\"></div>\n      </div>\n    `);E.toggleClass(\"enabled\",e.enabled),E.find(\".rlh-global-book-header\").toggleClass(\"enabled\",e.enabled),E.toggleClass(\"selected\",g);let w=E.find(\".rlh-collapsible-content\"),k=a(`<div class=\"rlh-entry-actions\"><button class=\"rlh-action-btn rlh-create-entry-btn\" data-book-name=\"${O(e.name)}\"><i class=\"fa-solid fa-plus\"></i> \\u65B0\\u5EFA\\u6761\\u76EE</button><button class=\"rlh-action-btn rlh-batch-recursion-btn\" data-book-name=\"${O(e.name)}\"><i class=\"fa-solid fa-shield-halved\"></i> \\u5168\\u5F00\\u9632\\u9012\\u5F52</button><button class=\"rlh-action-btn rlh-fix-keywords-btn\" data-book-name=\"${O(e.name)}\"><i class=\"fa-solid fa-check-double\"></i> \\u4FEE\\u590D\\u5173\\u952E\\u8BCD</button></div>`);w.append(k);let C=[...ee(e.name)].sort((f,x)=>(f.display_index??Number.MAX_SAFE_INTEGER)-(x.display_index??Number.MAX_SAFE_INTEGER)),s=o?C:l||[];if(s&&s.length>0){let f=a('<div class=\"rlh-entry-list-wrapper\"></div>');s.forEach(x=>f.append(lr(x,\"lore\",e.name,r,{enableDrag:!1}))),w.append(f)}else r&&w.append('<div class=\"rlh-info-text-small\">\\u65E0\\u5339\\u914D\\u9879</div>');return E},Vr=e=>typeof e==\"string\"?e.replace(/\\r?\\n/g,\"<br>\"):e,Ir=e=>`<span class=\"rlh-viewer-empty\">${O(e)}</span>`,Xr=(e,r)=>{let o=Yr(e?.statusId),l=qr(o.id),n=(Array.isArray(e?.keys)?e.keys:[]).join(\", \"),i=n?Vr(r?cr(n,r):O(n)):Ir(\"\\u6682\\u65E0\\u5173\\u952E\\u8BCD\"),b=e?.content??\"\",m=b?Vr(r?cr(b,r):O(b)):Ir(\"\\u6682\\u65E0\\u5185\\u5BB9\"),u=D=>D!=null&&D!==\"\",p=(D,Z=\"\\u672A\\u8BBE\\u7F6E\")=>u(D)?O(String(D)):Ir(Z),g=D=>{if(!D)return\"\";let{label:Z,value:pe,placeholder:ae,html:de}=D,re=de!==void 0?de:p(pe,ae);return`\n      <div class=\"rlh-editor-field rlh-viewer-field\">\n        <label>${Z}</label>\n        <div class=\"rlh-viewer-text\">${re}</div>\n      </div>\n    `},v=(D,Z,pe={})=>{if(!Z.length)return\"\";let ae=pe.layout??\"grid\",de=D?`<h5>${D}</h5>`:\"\",re=\"\";return ae===\"grid\"?re=`\n        <div class=\"rlh-editor-grid\">${Z.map(y=>`\n          <div class=\"rlh-grid-item\">${g(y)}</div>`).join(\"\")}\n        </div>\n      `:re=Z.map(g).join(\"\"),`\n      <div class=\"rlh-editor-group rlh-viewer-group\">\n        ${de}\n        ${re}\n      </div>\n    `},E=(()=>{let D=e?.position;return u(D)?typeof D==\"object\"&&D!==null&&typeof D.type==\"string\"&&D.type?Ke.position?.[D.type]??D.type:typeof D==\"string\"?Ke.position?.[D]??D:null:null})(),w=u(e?.depth)?e.depth:null,k=u(e?.order)?e.order:null,C=u(e?.logic),s=C?e.logic:\"and_any\",f=Ke.logic?.[s]??s,x=C?f:`${f} (\\u9ED8\\u8BA4)`,A=u(e?.probability)?`${e.probability}%`:\"100% (\\u9ED8\\u8BA4)\",M=g({label:\"\\u5173\\u952E\\u8BCD\",html:i}),L=g({label:\"\\u5185\\u5BB9\",html:`<article class=\"rlh:prose rlh:dark:rlh:prose-invert max-w-none\">${m}</article>`}),K=v(qt.INSERT_RULES_TITLE,[{label:\"\\u4F4D\\u7F6E\",value:E,placeholder:\"\\u672A\\u8BBE\\u7F6E\"},{label:\"\\u6DF1\\u5EA6\",value:w,placeholder:\"\\u672A\\u8BBE\\u7F6E\"},{label:\"\\u987A\\u5E8F\",value:k,placeholder:\"\\u672A\\u8BBE\\u7F6E\"}],{layout:\"grid\"}),ne=v(\"\\u6FC0\\u6D3B\\u903B\\u8F91\",[{label:\"\\u6982\\u7387\",value:A,placeholder:\"100% (\\u9ED8\\u8BA4)\"},{label:\"\\u5173\\u952E\\u8BCD\\u903B\\u8F91\",value:x,placeholder:\"\\u4EFB\\u4E00 AND (\\u9ED8\\u8BA4)\"}],{layout:\"grid\"}),F=v(\"\\u5339\\u914D\\u4E0E\\u9012\\u5F52\",[{label:\"\\u5927\\u5C0F\\u5199\\u654F\\u611F\",value:e?.case_sensitive?\"\\u5F00\\u542F\":\"\\u5173\\u95ED\",placeholder:\"\\u5173\\u95ED\"},{label:\"\\u5168\\u8BCD\\u5339\\u914D\",value:e?.match_whole_words?\"\\u5F00\\u542F\":\"\\u5173\\u95ED\",placeholder:\"\\u5173\\u95ED\"},{label:\"\\u9632\\u6B62\\u9012\\u5F52\",value:e?.prevent_recursion?\"\\u5F00\\u542F\":\"\\u5173\\u95ED\",placeholder:\"\\u5173\\u95ED\"},{label:\"\\u4E0D\\u53EF\\u88AB\\u9012\\u5F52\",value:e?.exclude_recursion?\"\\u5F00\\u542F\":\"\\u5173\\u95ED\",placeholder:\"\\u5173\\u95ED\"}],{layout:\"grid\"});return`\n    <div class=\"rlh-entry-viewer\" data-mode=\"view\">\n      ${v(\"\\u72B6\\u6001\",[{label:\"\\u5F53\\u524D\\u72B6\\u6001\",html:l}],{layout:\"grid\"})}\n      ${M}\n      ${L}\n      ${K}\n      ${ne}\n      ${F}\n    </div>\n  `},gt=(e,r)=>{let o=e?.find_regex??\"\",l=e?.replace_string??\"\",a=typeof r==\"string\"?r:\"\",n=o?Vr(a?cr(o,a):O(o)):Ir(\"\\u6682\\u65E0\\u67E5\\u627E\\u6B63\\u5219\"),i=l?Vr(a?cr(l,a):O(l)):Ir(\"\\u6682\\u65E0\\u66FF\\u6362\\u5185\\u5BB9\"),b=e?.destination??{},m=e?.source??{},u=e?.min_depth,p=e?.max_depth,g=[];b.display&&g.push(\"\\u4EC5\\u683C\\u5F0F\\u663E\\u793A\"),b.prompt&&g.push(\"\\u4EC5\\u683C\\u5F0F\\u63D0\\u793A\\u8BCD\");let v=g.length?g.join(\" / \"):\"\\u683C\\u5F0F\\u4E0E\\u63D0\\u793A\\u8BCD\",w=Object.entries({user_input:\"\\u7528\\u6237\\u8F93\\u5165\",ai_output:\"AI\\u8F93\\u51FA\",slash_command:\"\\u659C\\u6760\\u547D\\u4EE4\",world_info:\"\\u4E16\\u754C\\u4E66\"}).filter(([M])=>!!m?.[M]).map(([,M])=>M),k=w.length===0?\"\\u672A\\u9009\\u62E9\\u4F5C\\u7528\\u8303\\u56F4\":w.length===4?\"\\u5168\\u90E8\\u6765\\u6E90\":w.join(\" / \"),C=u!=null&&u!==\"\",s=p!=null&&p!==\"\",f=\"\\u65E0\\u6DF1\\u5EA6\\u9650\\u5236\";C&&s?f=`${u} - ${p}`:C?f=`>= ${u}`:s&&(f=`<= ${p}`);let A=[{label:\"\\u8F93\\u51FA\\u8BBE\\u7F6E\",value:v},{label:\"\\u4F5C\\u7528\\u8303\\u56F4\",value:k},{label:\"\\u6DF1\\u5EA6\\u8303\\u56F4\",value:f}].map(M=>`\n      <div class=\"rlh-editor-field rlh-viewer-field\">\n        <label>${M.label}</label>\n        <div class=\"rlh-viewer-text\">${O(String(M.value??\"\"))}</div>\n      </div>\n    `).join(\"\");return`\n    <div class=\"rlh-regex-viewer\" data-mode=\"view\">\n      <div class=\"rlh-editor-field rlh-viewer-field\">\n        <label>\\u67E5\\u627E\\u6B63\\u5219\\u8868\\u8FBE\\u5F0F</label>\n        <article class=\"rlh:prose rlh:dark:rlh:prose-invert max-w-none\">${n}</article>\n      </div>\n      <div class=\"rlh-editor-field rlh-viewer-field\">\n        <label>\\u66FF\\u6362\\u4E3A</label>\n        <article class=\"rlh:prose rlh:dark:rlh:prose-invert max-w-none\">${i}</article>\n      </div>\n      ${A}\n    </div>\n  `},lr=(e,r,o=\"\",l=\"\",a={})=>{let n=ce(),i=r===\"lore\",b=i?e.uid:e.id,m=i?e.name||\"\\u65E0\\u6807\\u9898\\u6761\\u76EE\":e.script_name||\"\\u672A\\u547D\\u540D\\u6B63\\u5219\",u=e.source===\"card\",p=a.collapseState??\"expanded\",g=a.isExpanded??!1,E=(a.enableDrag??!0)&&!u,w=E&&t.isDragSortDisabled,k=w?\"\\u62D6\\u62FD\\u529F\\u80FD\\u4E0D\\u53EF\\u7528\\uFF1A\\u6392\\u5E8F\\u811A\\u672C\\u672A\\u52A0\\u8F7D\":\"\\u62D6\\u62FD\\u6392\\u5E8F\",C=w?' data-disabled=\"true\" aria-disabled=\"true\" style=\"cursor: not-allowed; opacity: 0.6;\"':\"\",s=E?`<span class=\"rlh-drag-handle${w?\" rlh-drag-handle--disabled\":\"\"}\" title=\"${O(k)}\"${C}><i class=\"fa-solid fa-grip-vertical\"></i></span>`:\"\",f=a.selectionKey??(i?`lore:${o}:${b}`:`regex:${b}`),x=t.multiSelectTarget,A=t.multiSelectMode&&(x===\"entry\"&&i||x===\"regex\"&&!i),M=A&&t.selectedItems.has(f),L=\"\";i?L=`\n      <button class=\"rlh-action-btn-icon rlh-rename-btn\" title=\"\\u91CD\\u547D\\u540D\\u5E76\\u7F16\\u8F91\"><i class=\"fa-solid fa-pencil\"></i></button>\n      <button class=\"rlh-toggle-btn rlh-item-toggle\" title=\"\\u542F\\u7528/\\u7981\\u7528\\u6B64\\u6761\\u76EE\"><i class=\"fa-solid fa-power-off\"></i></button>\n      <button class=\"rlh-action-btn-icon rlh-delete-entry-btn\" title=\"\\u5220\\u9664\\u6761\\u76EE\"><i class=\"fa-solid fa-trash-can\"></i></button>\n    `:u?L='<button class=\"rlh-toggle-btn rlh-item-toggle\" title=\"\\u542F\\u7528/\\u7981\\u7528\\u6B64\\u6761\\u76EE\"><i class=\"fa-solid fa-power-off\"></i></button>':L=`\n      <button class=\"rlh-action-btn-icon rlh-rename-btn\" title=\"\\u91CD\\u547D\\u540D\\u5E76\\u7F16\\u8F91\"><i class=\"fa-solid fa-pencil\"></i></button>\n      <button class=\"rlh-toggle-btn rlh-item-toggle\" title=\"\\u542F\\u7528/\\u7981\\u7528\\u6B64\\u6761\\u76EE\"><i class=\"fa-solid fa-power-off\"></i></button>\n    `;let K=A?`<label class=\"rlh-selection-control\"><input type=\"checkbox\" class=\"rlh-multi-select-checkbox\" data-select-key=\"${O(f)}\" ${M?\"checked\":\"\"}></label>`:\"\",ne=u?\"\\u6B64\\u6761\\u76EE\\u6765\\u81EA\\u89D2\\u8272\\u5361\\uFF0C\\u90E8\\u5206\\u64CD\\u4F5C\\u53D7\\u9650\":A?\"\\u70B9\\u51FB\\u9009\\u62E9/\\u53D6\\u6D88\\u9009\\u62E9\":\"\\u70B9\\u51FB\\u5C55\\u5F00/\\u7F16\\u8F91\",F=cr(m,l),X=i?Yr(e.statusId):null,D=i?qr(X.id,{shortLabel:!0}):\"\",Z=\"\";if(i){let d=(e.position??\"before_character_definition\").toString(),y=Ke.position?.[d]??\"\\u9ED8\\u8BA4\\u4F4D\\u7F6E\",T=O(y),N=Number(e.order),B=Number(e.display_index),R=Number.isFinite(N)?`#${N}`:Number.isFinite(B)?`#${B}`:\"\\u672A\\u8BBE\\u7F6E\",H=O(R);Z=`\n          <div class=\"rlh-item-meta\" title=\"\\u63D2\\u5165\\u4E0E\\u987A\\u5E8F\\u4FE1\\u606F\">\n            <span class=\"rlh-item-meta-chip\"><i class=\"fa-solid fa-map-pin\"></i>\\u63D2\\u5165 ${T}</span>\n            <span class=\"rlh-item-meta-chip\"><i class=\"fa-solid fa-list-ol\"></i>\\u987A\\u5E8F ${H}</span>\n          </div>\n        `}let pe=E?` data-drag-enabled=\"${w?\"false\":\"true\"}\"${w?' data-drag-disabled=\"true\"':\"\"}`:\"\",ae=n(`<div class=\"rlh-item-container ${u?\"from-card\":\"\"}\" data-type=\"${r}\" data-id=\"${b}\" ${i?`data-book-name=\"${O(o)}\"`:\"\"} data-select-key=\"${O(f)}\"${i?` data-status-id=\"${Rr(X.id)}\"`:\"\"}${pe}>\n      <div class=\"rlh-item-header\" title=\"${ne}\">\n        ${K}\n        ${s}\n        <div class=\"rlh-item-header-main\">\n          <div class=\"rlh-item-title-row\">\n            <span class=\"rlh-item-name\">${F}</span>\n            ${D}\n          </div>\n          ${Z}\n        </div>\n        <div class=\"rlh-item-controls\">${L}</div>\n      </div>\n      <div class=\"rlh-collapsible-content\"></div>\n    </div>`);ae.data(\"searchTerm\",l),ae.attr(\"data-search-term\",typeof l==\"string\"?l:\"\"),ae.toggleClass(\"enabled\",e.enabled),ae.toggleClass(\"selected\",M);let de=ae.find(\".rlh-collapsible-content\"),re=a.initialMode;if(!re&&l&&(re=\"viewer\"),g)ae.removeClass(\"rlh-collapsed\"),de.show(),ae.attr(\"data-entry-mode\",\"edit\");else if(re===\"viewer\"){let d=i?Xr(e,l):gt(e,l);de.html(d),de.show(),ae.removeClass(\"rlh-collapsed\"),ae.attr(\"data-entry-mode\",\"view\")}else p===\"collapsed\"?(ae.addClass(\"rlh-collapsed\"),de.hide(),ae.attr(\"data-entry-mode\",re??\"collapsed\")):(ae.removeClass(\"rlh-collapsed\"),ae.attr(\"data-entry-mode\",re??\"collapsed\"));return ae},ro=(e,r)=>{let o=ce(),l=fe(),a=o(\".rlh-entry-list-wrapper\",l);if(a.length>0){a.find(\".rlh-info-text\").remove();let n=lr(e,\"lore\",r,\"\",{isExpanded:!0,enableDrag:!1});return a.prepend(n),n}return null},Jr=()=>{let e=ce(),r=fe();e(\"#rlh-selection-count\",r).text(`\\u5DF2\\u9009\\u62E9: ${t.selectedItems.size}`)},Qr=(e,r,o)=>{let l=ce(),a=fe(),i=r!=null?Number(r):NaN,b=Number.isInteger(i),m=w=>{if(w==null)return!1;if(b){let k=Number(w);if(Number.isInteger(k))return k===i}return String(w)===String(r)},u=l('.rlh-item-container[data-type=\"lore\"]',a).filter((w,k)=>{let C=l(k),s=C.data(\"book-name\")??C.attr(\"data-book-name\");if(String(s)!==String(e))return!1;let f=C.data(\"id\");return m(f)?!0:m(C.attr(\"data-id\"))}).first();if(!u.length)return;let p=Yr(o),g=qr(p.id,{shortLabel:!0});u.attr(\"data-status-id\",p.id);let v=u.find(\".rlh-item-title-row\").first();if(v.length){let w=v.find(\".rlh-status-badge\").first();w.length?w.replaceWith(g):v.append(g)}let E=u.find(\".rlh-collapsible-content\");if(E.length&&u.attr(\"data-entry-mode\")===\"view\"){let k=ee(e).find(C=>Number(C?.uid)===numericId);if(k){let C=Xr(k,u.data(\"searchTerm\")??\"\");E.html(C)}}},to=(e,r,o,l,a,n)=>{let i=\"\",b=\"\",m=\"\",u=p=>Object.entries(p).filter(([,g])=>g>0).map(([g,v])=>`<li>- ${O(g)}\\uFF1A<strong>${v}</strong> \\u4E2A</li>`).join(\"\");if(n?.type===\"lorebook\"){let p=n?.bookNames?.length===1?`\\u5F53\\u524D\\u4E16\\u754C\\u4E66\\u300C${O(n.bookNames[0])}\\u300D`:\"\\u5339\\u914D\\u5230\\u7684\\u4E16\\u754C\\u4E66\",g=new Set(e.map(w=>w.bookName)).size+(o?.length??0),v=e.length;i=`\n      <div class=\"rlh-replace-stats\">\n        <p>- \\u5171\\u5339\\u914D\\u5230 ${g} \\u672C\\u4E16\\u754C\\u4E66\\uFF0C\\u5176\\u4E2D ${v} \\u4E2A\\u6761\\u76EE\\u5C06\\u88AB\\u4FEE\\u6539\\u3002</p>\n        <p>- \\u66FF\\u6362\\u8303\\u56F4\\uFF1A${p}</p>\n        <p>- \\u547D\\u4E2D\\u8BE6\\u60C5\\uFF1A</p>\n        <ul>\n          <li>- \\u4E66\\u540D\\uFF1A<strong>${r.bookName}</strong> \\u4E2A</li>\n          <li>- \\u6761\\u76EE\\u540D\\uFF1A<strong>${r.entryName}</strong> \\u4E2A</li>\n          <li>- \\u5173\\u952E\\u8BCD\\uFF1A<strong>${r.keywords}</strong> \\u4E2A</li>\n          <li>- \\u5185\\u5BB9\\uFF1A<strong>${r.content}</strong> \\u4E2A</li>\n        </ul>\n      </div>\n    `,b=`<ul class=\"rlh-confirm-entry-list\">${e.map(({bookName:w,entry:k,matchedFields:C})=>{let s=[];C&&(C.entryName&&s.push(\"\\u6761\\u76EE\\u540D\"),C.keywords>0&&s.push(\"\\u5173\\u952E\\u8BCD\"),C.content&&s.push(\"\\u5185\\u5BB9\"));let f=s.join(\"\\u3001\"),x=O(k.name||\"\\u65E0\\u6807\\u9898\\u6761\\u76EE\"),A=f?`\\uFF08${f}\\uFF09`:\"\";return`<li class=\"rlh-confirm-entry-item\">${O(w)}: ${x}${A}</li>`}).join(\"\")}</ul>`,o&&o.length>0&&(m=`\n        <hr>\n        <h4>\\u4EC5\\u4E66\\u540D\\u5339\\u914D (\\u4E0D\\u4F1A\\u88AB\\u66FF\\u6362):</h4>\n        <div class=\"rlh-confirm-scroll-list rlh-confirm-scroll-list--secondary\">\n          <ul class=\"rlh-confirm-entry-list\">${o.map(k=>`<li class=\"rlh-confirm-entry-item\">${O(k)}</li>`).join(\"\")}</ul>\n        </div>\n      `)}else if(n===\"regex\"){let p={\\u540D\\u79F0\\u5339\\u914D:r.name,\\u5185\\u5BB9\\u5339\\u914D:r.content},g=u(p);g&&(i=`<div class=\"rlh-replace-stats\"><h4>\\u66FF\\u6362\\u7EDF\\u8BA1\\u6458\\u8981\\uFF1A</h4><ul>${g}</ul></div>`),b=`<ul class=\"rlh-confirm-entry-list\">${e.map(v=>`<li class=\"rlh-confirm-entry-item\">${O(v.script_name||\"\\u672A\\u547D\\u540D\\u6B63\\u5219\")}</li>`).join(\"\")}</ul>`}return`\n    <div class=\"rlh-replace-confirm-modal\">\n      <p>\\u786E\\u5B9A\\u8981\\u5C06 <strong>\"${O(l)}\"</strong> \\u66FF\\u6362\\u4E3A <strong>\"${O(a)}\"</strong> \\u5417\\uFF1F</p>\n      <p>\\u6B64\\u64CD\\u4F5C\\u4E0D\\u53EF\\u64A4\\u9500\\u3002</p>\n      <hr>\n      ${i}\n      <hr>\n      <h4>\\u5C06\\u8981\\u4FEE\\u6539\\u7684\\u6761\\u76EE\\u5217\\u8868\\uFF1A</h4>\n      <div class=\"rlh-confirm-scroll-list\">\n        ${b}\n      </div>\n      ${m}\n    </div>\n  `},Zr=()=>{let e=ce(),r=fe(),o=e(\"#regex-lore-hub-save-status\",r);if(!o.length)return;let l=t.saveStatus,a=\"\",n=\"\";switch(l){case\"saving\":a='<i class=\"fa-solid fa-spinner fa-spin\"></i> \\u6B63\\u5728\\u4FDD\\u5B58...',n=\"saving\";break;case\"retrying\":a=`<i class=\"fa-solid fa-triangle-exclamation fa-fade\"></i> \\u81EA\\u52A8\\u4FDD\\u5B58\\u5931\\u8D25\\uFF0C\\u6B63\\u5728\\u91CD\\u8BD5... (${t.saveRetryAttempt}/3)`,n=\"retrying\";break;case\"success\":a='<i class=\"fa-solid fa-check-circle\"></i> \\u6570\\u636E\\u5DF2\\u4FDD\\u5B58',n=\"success\";break;case\"failed\":a='<i class=\"fa-solid fa-circle-xmark\"></i> \\u81EA\\u52A8\\u4FDD\\u5B58\\u5931\\u8D25\\uFF0C\\u8BF7\\u68C0\\u67E5\\u8FDE\\u63A5\\u6216\\u624B\\u52A8\\u4FDD\\u5B58\\u3002',n=\"failed\";break;case\"idle\":default:a=\"\",n=\"idle\";break}o.html(a),o.attr(\"class\",`rlh-save-status ${n}`)},ll=(e,r)=>{let o=ee(e);if(!Array.isArray(o)||!o.length||!Array.isArray(r)||r.length!==o.length)return null;let l=new Map(o.map(n=>[String(n.uid??\"\"),n])),a=[];return r.forEach(n=>{let i=String(n??\"\");l.has(i)&&(a.push(l.get(i)),l.delete(i))}),a.length?(l.forEach(n=>a.push(n)),a.forEach((n,i)=>{n.display_index=i,(n.order===void 0||n.order===null||Number.isNaN(Number(n.order)))&&(n.order=i)}),Re(e,a),a):null},xt=(e,r,o={})=>{let l=ke(),a=o.enabled??!1,n=!!e?.length,i=()=>{n&&(e.attr(\"data-drag-disabled\",\"true\"),e.find(\".rlh-drag-disabled-tip\").length||e.prepend('<p class=\"rlh-info-text-small rlh-drag-disabled-tip\">\\u62D6\\u62FD\\u6392\\u5E8F\\u529F\\u80FD\\u6682\\u65F6\\u4E0D\\u53EF\\u7528\\u3002</p>'))};if(!a||!n){n&&(e.removeAttr(\"data-drag-disabled\"),e.find(\".rlh-drag-disabled-tip\").remove());return}if(t.isDragSortDisabled){i();return}if(!l?.Sortable)return;let b=e[0];!b||e.find(\".rlh-item-container\").length<2||(e.removeAttr(\"data-drag-disabled\"),e.find(\".rlh-drag-disabled-tip\").remove(),l.Sortable.create(b,{animation:150,handle:\".rlh-drag-handle\",ghostClass:\"sortable-ghost\",chosenClass:\"sortable-chosen\",onEnd:I(async u=>{let{oldIndex:p,newIndex:g}=u;if(p===g)return;let v=Array.from(b.querySelectorAll(\".rlh-item-container\")).map(E=>E.getAttribute(\"data-id\")).filter(Boolean);ll(r,v)&&await ar()},\"RegexLoreHub.Sortable\")}))};var oo=6,nr=null,Ae=null,vt=()=>{if(!nr&&!Ae)return;let e=ke();if(nr){let{type:r,id:o}=nr;if(r===\"idle\"&&e?.cancelIdleCallback)e.cancelIdleCallback(o);else if(r===\"raf\"&&e?.cancelAnimationFrame)e.cancelAnimationFrame(o);else if(r===\"timeout\"){let l=e?.clearTimeout??(typeof clearTimeout==\"function\"?clearTimeout:null);l&&l(o)}nr=null}Ae&&(Ae.remove(),Ae=null)},yt=(e,r)=>{let o=Array.isArray(e)?[...e]:[];return r===\"status\"?o.sort((l,a)=>{let n=Number(a.enabled)-Number(l.enabled);return n!==0?n:(l.name||\"\").localeCompare(a.name||\"\",\"zh\")}):o.sort((l,a)=>(l.name||\"\\u65E0\\u6807\\u9898\\u6761\\u76EE\").localeCompare(a.name||\"\\u65E0\\u6807\\u9898\\u6761\\u76EE\",\"zh\"))},Ar=(e,r=!1,o={})=>{let l=[],a=[],n={bookName:0,entryName:0,keywords:0,content:0},i=typeof e==\"string\"?e:\"\";if(!i)return{matches:l,stats:n,booksMatchedByNameOnly:a};let{bookNames:b}=o,m=Array.isArray(b)?[...new Set(b.map(f=>typeof f==\"string\"?f.trim():\"\").filter(f=>!!f))]:[],u=Array.isArray(t.allLorebooks)?t.allLorebooks:[],p=m.length?u.filter(f=>m.includes(f.name)):u.slice();if(m.length){let f=new Set(p.map(x=>x.name));m.forEach(x=>{f.has(x)||p.push({name:x})})}let g=r?\"\":\"i\",v=new RegExp(i.replace(/[.*+?^${}()|[\\/\\\\]/g,\"\\\\$&\"),g),E=new Set,w=new Set,k=new Set,C=new Set,s=new Set;for(let f of p){let x=f?.name??\"\";if(!x)continue;let A=ee(x),M=v.test(x),L=!1;M&&E.add(x);for(let K of A){let ne={bookName:!1,entryName:!1,keywords:0,content:!1},F=!1;if(v.test(K.name||\"\")&&(w.add(K.uid),ne.entryName=!0,F=!0),Array.isArray(K.keys)){let X=K.keys.filter(D=>v.test(D)).length;X>0&&(ne.keywords=X,k.add(K.uid),F=!0)}v.test(K.content||\"\")&&(C.add(K.uid),ne.content=!0,F=!0),F&&(L=!0,s.has(K.uid)||(l.push({bookName:x,entry:K,matchedFields:ne}),s.add(K.uid)))}M&&!L&&a.push(x)}return n.bookName=E.size,n.entryName=w.size,n.keywords=k.size,n.content=C.size,{matches:l,stats:n,booksMatchedByNameOnly:a}},lo=(e,r,o)=>{e.view===\"global-lore-detail\"?nl(e,r,o):al(e,r,o)},al=(e,r,o)=>{vt();let l=ce(),a=fe(),n=ke(),i=typeof r==\"string\"?r:\"\",b=or(e),m=[...t.allLorebooks];if(b===\"status\"?m.sort((s,f)=>{let x=Number(f.enabled)-Number(s.enabled);return x!==0?x:s.name.localeCompare(f.name,\"zh\")}):m.sort((s,f)=>s.name.localeCompare(f.name,\"zh\")),!m.length){o.html(`\n      <div class=\"rlh-empty-state\">\n        <div class=\"rlh-empty-icon\"><i class=\"fa-solid fa-book-bookmark\"></i></div>\n        <h4>\\u6CA1\\u6709\\u4E16\\u754C\\u4E66</h4>\n        <p>\\u70B9\\u51FB\\u53F3\\u4E0A\\u89D2\\u7684\\u201C<i class=\"fa-solid fa-plus\"></i>\\u201D\\u6309\\u94AE\\u6765\\u521B\\u5EFA\\u4F60\\u7684\\u7B2C\\u4E00\\u4E2A\\u4E16\\u754C\\u4E66\\u5427\\uFF01</p>\n      </div>\n    `);return}let u=i?m.filter(s=>t.searchFilters.bookName&&s.name.toLowerCase().includes(i)?!0:ee(s.name).some(A=>hr(A,i))):m;if(!u.length){o.html('<p class=\"rlh-info-text\">\\u672A\\u627E\\u5230\\u5339\\u914D\\u7684\\u4E16\\u754C\\u4E66\\u3002</p>');return}o.empty();let p=u.length,g=p<=oo?p:Math.min(oo,Math.max(3,Math.ceil(p/5))),v=0;Ae=p>g?l('<p class=\"rlh-info-text-small\" aria-live=\"polite\"></p>'):null;let E=()=>{if(!Ae)return;let s=Math.min(v,p);Ae.text(`\\u6B63\\u5728\\u52A0\\u8F7D\\u4E16\\u754C\\u4E66\\u5217\\u8868 (${s}/${p})\\uFF0C\\u8BF7\\u7A0D\\u5019...`).appendTo(o)},w=s=>{if(!s.length)return;let f=a&&typeof a.createDocumentFragment==\"function\"?a.createDocumentFragment():null;f?(s.forEach(x=>f.appendChild(x)),o.append(f)):s.forEach(x=>o.append(x))},k=()=>{let s=Math.min(v+g,p),f=[];for(let x=v;x<s;x++){let M=eo(u[x],r,!0,null).get(0);M&&f.push(M)}if(w(f),v=s,E(),v>=p&&Ae){let x=Ae;(n?.setTimeout??setTimeout)(()=>{Ae===x&&(x.remove(),Ae=null)},320)}},C=()=>{let s=()=>{nr=null,k(),v<p&&C()};n?.requestIdleCallback?nr={type:\"idle\",id:n.requestIdleCallback(s,{timeout:120})}:n?.requestAnimationFrame?nr={type:\"raf\",id:n.requestAnimationFrame(s)}:nr={type:\"timeout\",id:(n?.setTimeout??setTimeout)(s,16)}};k(),v<p?C():Ae&&(Ae.remove(),Ae=null)},nl=(e,r,o)=>{vt();let l=ce(),a=e?.activeBookName??t.activeBookName;if(!t.allLorebooks.find(E=>E.name===a)){o.html(`<p class=\"rlh-info-text\">\\u9519\\u8BEF\\uFF1A\\u672A\\u627E\\u5230\\u540D\\u4E3A \"${O(a)}\" \\u7684\\u4E16\\u754C\\u4E66\\u3002</p>`);return}if(t.loadingBookName===a){let E=`\n        <div class=\"rlh-detail-view\" data-book-name=\"${O(a)}\">\n          <header class=\"rlh-detail-header\">\n            <button class=\"rlh-action-btn-icon rlh-back-to-list-btn\" title=\"\\u8FD4\\u56DE\\u4E16\\u754C\\u4E66\\u5217\\u8868\"><i class=\"fa-solid fa-arrow-left\"></i></button>\n            <h2>${O(a)}</h2>\n            <div class=\"rlh-item-controls\">\n              <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\\u91CD\\u547D\\u540D\\u4E16\\u754C\\u4E66\">\\u91CD\\u547D\\u540D</button>\n              <button class=\"rlh-toolbar-btn rlh-delete-book-btn\" title=\"\\u5220\\u9664\\u4E16\\u754C\\u4E66\">\\u5220\\u9664</button>\n            </div>\n          </header>\n          <div class=\"rlh-detail-content\">\n            <p class=\"rlh-info-text\">\\u52A0\\u8F7D\\u4E2D...</p>\n          </div>\n        </div>\n      `;o.html(E);return}o.append(`<div class=\"rlh-info-text-small\">\\u5F53\\u524D\\u4E16\\u754C\\u4E66\\uFF1A${O(a)}</div>`);let i=or(e),b=dr(e),m=yt(ee(a),i),u=`\n        <div class=\"rlh-detail-view\" data-book-name=\"${O(a)}\">\n          <header class=\"rlh-detail-header\">\n            <button class=\"rlh-action-btn-icon rlh-back-to-list-btn\" title=\"\\u8FD4\\u56DE\\u4E16\\u754C\\u4E66\\u5217\\u8868\"><i class=\"fa-solid fa-arrow-left\"></i></button>\n            <h2>${O(a)}</h2>\n            <div class=\"rlh-item-controls\">\n              <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\\u91CD\\u547D\\u540D\\u4E16\\u754C\\u4E66\">\\u91CD\\u547D\\u540D</button>\n              <button class=\"rlh-toolbar-btn rlh-delete-book-btn\" title=\"\\u5220\\u9664\\u4E16\\u754C\\u4E66\">\\u5220\\u9664</button>\n            </div>\n          </header>\n          <div class=\"rlh-detail-content\">\n          </div>\n        </div>\n      `;o.html(u);let p=r?m.filter(E=>hr(E,r)):m,g=o.find(\".rlh-detail-content\");if(!p.length){let E=m.length?\"\\u65E0\\u5339\\u914D\\u6761\\u76EE\":\"\\u8FD9\\u672C\\u4E66\\u8FD8\\u6CA1\\u6709\\u6761\\u76EE\\uFF0C\\u70B9\\u51FB\\u5DE5\\u5177\\u680F\\u7684\\u201C\\u65B0\\u5EFA\\u6761\\u76EE\\u201D\\u6309\\u94AE\\uFF0C\\u4E3A\\u5B83\\u6DFB\\u52A0\\u5185\\u5BB9\\u3002\";g.html(`<p class=\"rlh-info-text\">${E}</p>`);return}let v=`\n    <p class=\"rlh-info-text-small\">\\u5171 ${m.length} \\u4E2A\\u6761\\u76EE</p>\n    <div class=\"rlh-entry-list-wrapper\">\n      ${p.map(E=>lr(E,\"lore\",a,r,{collapseState:b,enableDrag:!1}).prop(\"outerHTML\")).join(\"\")}\n    </div>\n  `;g.html(v)},ao=(e,r,o)=>{let l=ce(),a=t.lorebooks.character,n=t.characterContext.name??\"\";if(!(t.characterContext.id!==null)){o.html('<p class=\"rlh-info-text\">\\u8BF7\\u5148\\u52A0\\u8F7D\\u4E00\\u4E2A\\u89D2\\u8272\\u4EE5\\u7BA1\\u7406\\u89D2\\u8272\\u4E16\\u754C\\u4E66\\u3002</p>');return}if(a.length===0){o.html('<p class=\"rlh-info-text\">\\u5F53\\u524D\\u89D2\\u8272\\u6CA1\\u6709\\u7ED1\\u5B9A\\u7684\\u4E16\\u754C\\u4E66\\u3002\\u70B9\\u51FB\\u540C\\u6B65\\u6309\\u94AE\\u5237\\u65B0\\u3002</p>');return}let b=t.activeCharacterBook;(!b||!a.includes(b))&&(b=a[0],t.activeCharacterBook=b);let m=or(e),u=dr(e);if(a.length>1){let v=a.map(E=>`<option value=\"${O(E)}\"${E===b?\" selected\":\"\"}>${O(E)}</option>`).join(\"\");o.append(`<div class=\"rlh-book-switcher\"><label>\\u5F53\\u524D\\u89D2\\u8272\\u540D\\uFF1A${O(n)}<select id=\"${Pr}\" class=\"rlh-input\">${v}</select></label></div>`)}else o.append(`<div class=\"rlh-info-text-small\">\\u5F53\\u524D\\u89D2\\u8272\\u540D\\uFF1A${O(n)}</div>`);let g=(v=>{let E=l(`<div class=\"rlh-book-group\" data-book-name=\"${O(v)}\">\n        <div class=\"rlh-book-group-header\">\n          <h2 class=\"rlh-book-group-title\">${O(v)}</h2>\n          <div class=\"rlh-item-controls\">\n            <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\\u91CD\\u547D\\u540D\\u4E16\\u754C\\u4E66\">\\u91CD\\u547D\\u540D</button>\n            <button class=\"rlh-toolbar-btn rlh-delete-book-btn\" title=\"\\u5220\\u9664\\u4E16\\u754C\\u4E66\">\\u5220\\u9664</button>\n          </div>\n        </div>\n        <div class=\"rlh-entry-list-wrapper\"></div>\n      </div>`),w=E.find(\".rlh-entry-list-wrapper\"),k=t.allLorebooks.find(L=>L.name===v);if(k&&!k.entriesLoaded)return k.loadingEntries||(k.loadingEntries=!0,Ee(v).finally(()=>{k.loadingEntries=!1,oe()})),w.append('<p class=\"rlh-info-text\">\\u52A0\\u8F7D\\u4E2D...</p>'),E;let C=[...ee(v)].sort((L,K)=>(L.display_index??Number.MAX_SAFE_INTEGER)-(K.display_index??Number.MAX_SAFE_INTEGER)),s=yt(C,m),f=!r||t.searchFilters.bookName&&v.toLowerCase().includes(r),x=r?s.filter(L=>hr(L,r)):s,A=f&&!r?s:x,M=!1;return A.length?A.forEach(L=>{w.append(lr(L,\"lore\",v,r,{collapseState:u,enableDrag:M}))}):r?w.append('<p class=\"rlh-info-text-small\">\\u65E0\\u5339\\u914D\\u6761\\u76EE</p>'):w.append('<p class=\"rlh-info-text-small\">\\u8FD9\\u672C\\u4E16\\u754C\\u4E66\\u6682\\u65F6\\u6CA1\\u6709\\u6761\\u76EE\\u3002</p>'),xt(w,v,{enabled:M}),E})(b);g?(g.attr(\"data-active\",\"true\"),o.append(g)):r?o.append('<p class=\"rlh-info-text\">\\u672A\\u627E\\u5230\\u5339\\u914D\\u7684\\u6761\\u76EE\\u3002</p>'):o.append('<p class=\"rlh-info-text\">\\u672A\\u80FD\\u52A0\\u8F7D\\u5F53\\u524D\\u4E16\\u754C\\u4E66\\uFF0C\\u8BF7\\u5C1D\\u8BD5\\u5237\\u65B0\\u6570\\u636E\\u3002</p>')};var no=(e,r,o)=>{let l=ce(),a=t.chatLorebook,n=ke(),i=t.characterContext.name??\"\";if(!(n.SillyTavern?.getContext?.()?.chatId!==null)){o.html('<p class=\"rlh-info-text\">\\u8BF7\\u5148\\u6253\\u5F00\\u4E00\\u4E2A\\u804A\\u5929\\u4EE5\\u7BA1\\u7406\\u804A\\u5929\\u4E16\\u754C\\u4E66\\u3002</p>');return}if(!a){o.html(`\n      <div class=\"rlh-chat-lore-empty\">\n        <p class=\"rlh-info-text\">\\u5F53\\u524D\\u804A\\u5929\\u6CA1\\u6709\\u7ED1\\u5B9A\\u7684\\u4E16\\u754C\\u4E66\\u3002</p>\n        <button class=\"rlh-action-btn\" id=\"rlh-create-chat-lore-btn\"><i class=\"fa-solid fa-plus\"></i> \\u521B\\u5EFA\\u5E76\\u7ED1\\u5B9A\\u804A\\u5929\\u4E16\\u754C\\u4E66</button>\n      </div>\n    `);return}o.append(`<div class=\"rlh-info-text-small\">\\u5F53\\u524D\\u804A\\u5929\\u89D2\\u8272\\u540D\\uFF1A${O(i)}</div>`);let m=or(e),u=dr(e),p=l(`<div class=\"rlh-book-group\" data-book-name=\"${O(a)}\">\n      <div class=\"rlh-book-group-header\">\n        <h2 class=\"rlh-book-group-title\">${O(a)} (\\u804A\\u5929\\u4E13\\u7528)</h2>\n        <div class=\"rlh-item-controls\">\n          <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\\u91CD\\u547D\\u540D\\u4E16\\u754C\\u4E66\">\\u91CD\\u547D\\u540D</button>\n          <button class=\"rlh-toolbar-btn rlh-unlink-chat-lore-btn\" title=\"\\u89E3\\u9664\\u7ED1\\u5B9A\">\\u89E3\\u9664\\u7ED1\\u5B9A</button>\n        </div>\n      </div>\n      <div class=\"rlh-entry-list-wrapper\"></div>\n    </div>`),g=p.find(\".rlh-entry-list-wrapper\"),v=t.allLorebooks.find(s=>s.name===a);if(v&&!v.entriesLoaded){v.loadingEntries||(v.loadingEntries=!0,Ee(a).finally(()=>{v.loadingEntries=!1,oe()})),g.append('<p class=\"rlh-info-text\">\\u52A0\\u8F7D\\u4E2D...</p>'),o.append(p);return}let E=[...ee(a)].sort((s,f)=>(s.display_index??Number.MAX_SAFE_INTEGER)-(f.display_index??Number.MAX_SAFE_INTEGER)),w=yt(E,m),k=r?w.filter(s=>hr(s,r)):w,C=!1;if(k.length)k.forEach(s=>{g.append(lr(s,\"lore\",a,r,{collapseState:u,enableDrag:C}))});else{let s=w.length?\"\\u65E0\\u5339\\u914D\\u6761\\u76EE\":\"\\u8FD9\\u672C\\u4E66\\u8FD8\\u6CA1\\u6709\\u6761\\u76EE\\u3002\";g.append(`<p class=\"rlh-info-text-small\">${s}</p>`)}xt(g,a,{enabled:C}),o.append(p)},io=()=>vt();var il=(e,r)=>{let o=Array.isArray(e)?[...e]:[];return r===\"status\"?o.sort((l,a)=>{let n=Number(a.enabled)-Number(l.enabled);return n!==0?n:(l.script_name||\"\").localeCompare(a.script_name||\"\",\"zh\")}):r===\"name\"?o.sort((l,a)=>(l.script_name||\"\").localeCompare(a.script_name||\"\",\"zh\")):o},so=(e,r=!1)=>{let o=[],l={name:0,content:0};if(!e)return{matches:o,stats:l};let a=[...t.regexes.global,...t.regexes.character],n=r?\"\":\"i\",i=new RegExp(e.replace(/[.*+?^${}()|[\\/\\\\]/g,\"\\\\$&\"),n),b=new Set,m=new Set,u=new Set;for(let p of a){let g=!1;i.test(p.script_name||\"\")&&(b.add(p.script_name),g=!0);let v=`${p.find_regex||\"\"} ${p.replace_string||\"\"}`;i.test(v)&&(m.add(p.script_name),g=!0),g&&!u.has(p.id)&&(o.push(p),u.add(p.id))}return l.name=b.size,l.content=m.size,{matches:o,stats:l}},et=(e,r,o,l,a)=>{let n=ce(),i=ke(),b=or(e),m=dr(e),u=il(r??[],b),p=a??(e.id===\"char-regex\"?\"\\u89D2\\u8272\\u6B63\\u5219\":\"\\u5168\\u5C40\\u6B63\\u5219\");if(e.id===\"char-regex\"){let s=i.SillyTavern?.getContext?.()||{};if(!(s.characterId!==void 0&&s.characterId!==null)){l.html('<p class=\"rlh-info-text\">\\u8BF7\\u5148\\u52A0\\u8F7D\\u4E00\\u4E2A\\u89D2\\u8272\\u4EE5\\u7BA1\\u7406\\u89D2\\u8272\\u6B63\\u5219\\u3002</p>');return}}if(!u.length){l.html(`<p class=\"rlh-info-text\">\\u6CA1\\u6709${p}\\u3002\\u70B9\\u51FB\\u540C\\u6B65\\u6309\\u94AE\\u5237\\u65B0\\u3002</p>`);return}let g=o?u.filter(s=>Zt(s,o)):u;if(!g.length){l.html(`<p class=\"rlh-info-text\">\\u6CA1\\u6709\\u5339\\u914D\\u7684${p}\\u3002</p>`);return}let v=`rlh-regex-list-${e.id}`,E=n(`<div id=\"${v}\" class=\"rlh-regex-list\"></div>`);l.append(E);let w=!o;g.forEach((s,f)=>{let x=lr(s,\"regex\",\"\",o,{collapseState:m,selectionKey:`regex:${s.id}`,enableDrag:w});x.find(\".rlh-item-name\").prepend(`<span class=\"rlh-order-indicator\">#${f+1}</span> `),E.append(x)});let k=E[0],C=\"rlh-drag-disabled-banner\";if(l.find(`.${C}`).remove(),w&&t.isDragSortDisabled?(E.attr(\"data-drag-disabled\",\"true\"),l.prepend(`<p class=\"rlh-info-text-small ${C}\">\\u63D0\\u793A\\uFF1A\\u62D6\\u62FD\\u6392\\u5E8F\\u529F\\u80FD\\u6682\\u65F6\\u4E0D\\u53EF\\u7528\\uFF0C\\u8BF7\\u4F7F\\u7528\\u6309\\u94AE\\u8C03\\u6574\\u987A\\u5E8F\\u3002</p>`)):E.removeAttr(\"data-drag-disabled\"),w&&!t.isDragSortDisabled&&k&&i.Sortable){let s=i.Sortable.create(k,{animation:150,handle:\".rlh-drag-handle\",forceFallback:!0,fallbackOnBody:!0,fallbackTolerance:6,delayOnTouchOnly:!0,touchStartThreshold:8,fallbackClass:\"rlh-sorting-fallback\",onStart:()=>{E.addClass(\"sorting-active\")},onEnd:I(async f=>{E.removeClass(\"sorting-active\");let{oldIndex:x,newIndex:A}=f;if(x===A)return;let M=e.id===\"global-regex\"?\"global\":\"character\",L=t.regexes[M];if(!Array.isArray(L))return;let[K]=L.splice(x,1);K&&(L.splice(A,0,K),qe(L),t.pendingRegexUpdates instanceof Set||(t.pendingRegexUpdates=new Set),t.pendingRegexUpdates.add(M),await ar({silent:!0}),l.empty(),et(e,L,o,l,a))},\"RegexLoreHub.RegexSortable\")})}};var sl=e=>e?.toString().trim().toLowerCase()??\"\",Ne=()=>{let e=t.activeTab,r=t.activeView,o={tab:e,view:r,id:`${e}`,instanceKey:`${e}`,activeBookName:t.activeBookName,type:\"lore\",scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u5F53\\u524D\\u89C6\\u56FE\",replaceScopeLabel:\"\\u5728\\u5F53\\u524D\\u89C6\\u56FE\\u4E2D\\u66FF\\u6362\",searchPlaceholder:\"\\u641C\\u7D22...\",visibleFilters:[\"entryName\",\"keywords\",\"content\"],filterLabels:vr,defaultFilters:{entryName:!0,keywords:!0,content:!0},showReplace:!0,showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!1,showPositionMenu:!1,sortOptions:[],multiSelectTarget:\"entry\",supportsMultiSelect:!0,primaryAction:{visible:!1}};if(e===\"global-lore\"){if(r===\"global-lore-detail\"){let l=t.activeBookName??\"\";return{...o,id:\"global-lore-detail\",instanceKey:l?`global-lore-detail:${l}`:\"global-lore-detail\",activeBookName:l,scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u5F53\\u524D\\u4E16\\u754C\\u4E66\",replaceScopeLabel:\"\\u5728\\u5F53\\u524D\\u4E16\\u754C\\u4E66\\u4E2D\\u66FF\\u6362\",searchPlaceholder:\"\\u641C\\u7D22...\",visibleFilters:[\"bookName\",\"entryName\",\"keywords\",\"content\"],defaultFilters:{bookName:!1,entryName:!0,keywords:!0,content:!0},showRecursion:!0,showFixKeywords:!0,showCollapseToggle:!0,showPositionMenu:!0,sortOptions:[\"status\",\"name\"],multiSelectTarget:\"entry\",primaryAction:{visible:!0,icon:\"fa-file-circle-plus\",label:\"\\u65B0\\u5EFA\\u6761\\u76EE\",title:\"\\u65B0\\u5EFA\\u6761\\u76EE\",scope:\"entry\"}}}return{...o,id:\"global-lore-list\",instanceKey:\"global-lore-list\",activeBookName:null,scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u5168\\u90E8\\u4E16\\u754C\\u4E66\",replaceScopeLabel:\"\\u5728\\u5339\\u914D\\u5230\\u7684\\u4E16\\u754C\\u4E66\\u6216\\u6761\\u76EE\\u4E2D\\u66FF\\u6362\",visibleFilters:[\"bookName\",\"entryName\",\"keywords\",\"content\"],defaultFilters:{bookName:!0,entryName:!0,keywords:!0,content:!0},showReplace:!0,showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!1,showPositionMenu:!1,showCleanOrphanBooks:!0,sortOptions:[\"status\",\"name\"],multiSelectTarget:\"book\",primaryAction:{visible:!0,icon:\"fa-plus\",label:\"\\u65B0\\u5EFA\\u4E16\\u754C\\u4E66\",title:\"\\u65B0\\u5EFA\\u4E16\\u754C\\u4E66\",scope:\"book\"}}}if(e===\"char-lore\"){let l=t.activeCharacterBook;if(!l){let n=(Array.isArray(t.lorebooks?.character)?t.lorebooks.character:[]).find(i=>typeof i==\"string\"&&i.trim().length);n&&(l=n,t.activeCharacterBook=n)}return{...o,id:\"char-lore\",instanceKey:\"char-lore\",activeBookName:l,scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u5F53\\u524D\\u4E16\\u754C\\u4E66\",replaceScopeLabel:\"\\u5728\\u5F53\\u524D\\u4E16\\u754C\\u4E66\\u4E2D\\u66FF\\u6362\",visibleFilters:[\"entryName\",\"keywords\",\"content\"],defaultFilters:{bookName:!1,entryName:!0,keywords:!0,content:!0},showRecursion:!0,showFixKeywords:!0,showCollapseToggle:!0,showPositionMenu:!0,sortOptions:[\"status\",\"name\"],multiSelectTarget:\"entry\",primaryAction:{visible:!0,icon:\"fa-file-circle-plus\",label:\"\\u65B0\\u5EFA\\u6761\\u76EE\",title:\"\\u65B0\\u5EFA\\u6761\\u76EE\",scope:\"entry\"}}}return e===\"chat-lore\"?{...o,id:\"chat-lore\",instanceKey:\"chat-lore\",activeBookName:t.chatLorebook,scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u5F53\\u524D\\u4E16\\u754C\\u4E66\",replaceScopeLabel:\"\\u5728\\u5F53\\u524D\\u4E16\\u754C\\u4E66\\u4E2D\\u66FF\\u6362\",visibleFilters:[\"entryName\",\"keywords\",\"content\"],defaultFilters:{bookName:!1,entryName:!0,keywords:!0,content:!0},showRecursion:!0,showFixKeywords:!0,showCollapseToggle:!0,showPositionMenu:!0,sortOptions:[\"status\",\"name\"],multiSelectTarget:\"entry\",primaryAction:{visible:!0,icon:\"fa-file-circle-plus\",label:\"\\u65B0\\u5EFA\\u6761\\u76EE\",title:\"\\u65B0\\u5EFA\\u6761\\u76EE\",scope:\"entry\"}}:e===\"global-regex\"?{...o,id:\"global-regex\",instanceKey:\"global-regex\",type:\"regex\",scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u5168\\u5C40\\u6B63\\u5219\\u8868\\u8FBE\\u5F0F\",replaceScopeLabel:\"\\u5728\\u5168\\u5C40\\u6B63\\u5219\\u4E2D\\u66FF\\u6362\",visibleFilters:[\"entryName\",\"content\"],filterLabels:{...vr,...pt},defaultFilters:{bookName:!1,entryName:!0,keywords:!1,content:!0},showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!0,showPositionMenu:!1,sortOptions:[],multiSelectTarget:\"regex\",supportsMultiSelect:!0,primaryAction:{visible:!1}}:e===\"char-regex\"?{...o,id:\"char-regex\",instanceKey:\"char-regex\",type:\"regex\",scopeLabel:\"\\u641C\\u7D22\\u8303\\u56F4\\uFF1A\\u89D2\\u8272\\u6B63\\u5219\\u8868\\u8FBE\\u5F0F\",replaceScopeLabel:\"\\u5728\\u89D2\\u8272\\u6B63\\u5219\\u4E2D\\u66FF\\u6362\",visibleFilters:[\"entryName\",\"content\"],filterLabels:{...vr,...pt},defaultFilters:{bookName:!1,entryName:!0,keywords:!1,content:!0},showRecursion:!1,showFixKeywords:!1,showCollapseToggle:!0,showPositionMenu:!1,sortOptions:[],multiSelectTarget:\"regex\",supportsMultiSelect:!1,primaryAction:{visible:!1}}:{...o,id:\"unknown\",instanceKey:\"unknown\",supportsMultiSelect:!1}},cl=e=>{let r=e.id;r&&(t.searchFilterContextsInitialized.has(r)||((e.visibleFilters??[]).forEach(o=>{t.searchFilters[o]=!0}),t.searchFilterContextsInitialized.add(r)),(e.id===\"char-lore\"||e.id===\"chat-lore\")&&t.searchFilters.keywords===void 0&&(t.searchFilters.keywords=!0))},oe=()=>{let e=ce(),r=fe(),o=e(`#${me}`,r),l=()=>{if(!o.length){let k=e([]);return{$toolbarRow:k,$toolbar:k,$replaceContainer:k,$content:k}}let p=o.find(\".rlh-toolbar-shell\").first();if(!p.length){let k=o.find(\".rlh-tab-nav\").first();p=e('<div class=\"rlh-toolbar-shell\"></div>'),k.length?p.insertAfter(k):o.prepend(p)}let g=p.find(`#${Lr}`);g.length||(g=e(`<div id=\"${Lr}\" class=\"rlh-toolbar-container\"></div>`),p.append(g));let v=p.find(`#${Tr}`);v.length||(v=e(`<div id=\"${Tr}\" class=\"rlh-replace-container\"></div>`),p.append(v));let E=o.find(\".rlh-content-pane\").first();E.length||(E=e('<div class=\"rlh-content-pane\"></div>'),E.insertAfter(p));let w=E.find(`#${me}-content`);return w.length||(w=e(`<div id=\"${me}-content\"></div>`),E.append(w)),{$toolbarRow:p,$toolbar:g,$replaceContainer:v,$content:w}},a=sl(t.globalSearch.term??\"\");[[\"bookName\",\"#rlh-filter-book-name\"],[\"entryName\",\"#rlh-filter-entry-name\"],[\"keywords\",\"#rlh-filter-keywords\"],[\"content\",\"#rlh-filter-content\"]].forEach(([p,g])=>{let v=o.find(g);v.length&&(t.searchFilters[p]=v.is(\":checked\"))});let{$toolbar:i,$replaceContainer:b,$content:m}=l();i.empty(),b.empty(),m.empty();let u=Ne();if(cl(u),u.tab!==\"global-lore\"&&io(),!u.supportsMultiSelect&&t.multiSelectMode&&(t.multiSelectMode=!1,t.selectedItems.clear()),t.multiSelectMode?t.multiSelectTarget!==u.multiSelectTarget&&(t.multiSelectTarget=u.multiSelectTarget,t.selectedItems.clear()):t.multiSelectTarget=u.multiSelectTarget,o.toggleClass(\"rlh-multi-select-mode\",t.multiSelectMode),Qt(u,{$toolbar:i,$replaceContainer:b}),Zr(),Jr(),t.isLoadingTabData){m.html('<p class=\"rlh-info-text\">\\u52A0\\u8F7D\\u4E2D...</p>');return}switch(u.tab){case\"global-lore\":lo(u,a,m);break;case\"char-lore\":ao(u,a,m);break;case\"chat-lore\":no(u,a,m);break;case\"global-regex\":et(u,t.regexes.global,a,m,\"\\u5168\\u5C40\\u6B63\\u5219\");break;case\"char-regex\":et(u,t.regexes.character,a,m,\"\\u89D2\\u8272\\u6B63\\u5219\");break;default:m.html('<p class=\"rlh-info-text\">\\u5F53\\u524D\\u89C6\\u56FE\\u672A\\u5B9E\\u73B0\\u3002</p>');break}};var ot=Object.freeze({and_any:0,not_all:1,not_any:2,and_all:3}),rt=Object.freeze({0:\"and_any\",1:\"not_all\",2:\"not_any\",3:\"and_all\"}),dl=Object.freeze({system:0,user:1,assistant:2}),co=Object.freeze({0:\"system\",1:\"user\",2:\"assistant\"}),kt=Object.freeze({before_character_definition:{type:\"before_character_definition\"},after_character_definition:{type:\"after_character_definition\"},before_example_messages:{type:\"before_example_messages\"},after_example_messages:{type:\"after_example_messages\"},before_author_note:{type:\"before_author_note\"},after_author_note:{type:\"after_author_note\"},at_depth_as_system:{type:\"at_depth\",role:\"system\"},at_depth_as_assistant:{type:\"at_depth\",role:\"assistant\"},at_depth_as_user:{type:\"at_depth\",role:\"user\"}}),hl=Object.freeze({0:\"before_character_definition\",1:\"after_character_definition\",2:\"before_author_note\",3:\"after_author_note\",4:\"at_depth_as_system\",5:\"before_example_messages\",6:\"after_example_messages\"}),tt=Object.freeze({before_char:\"before_character_definition\",after_char:\"after_character_definition\",before_an:\"before_author_note\",after_an:\"after_author_note\",before_em:\"before_example_messages\",after_em:\"after_example_messages\",at_depth:\"at_depth_as_system\",depth_system:\"at_depth_as_system\",depth_character:\"at_depth_as_assistant\",depth_user:\"at_depth_as_user\"}),pr=e=>e?JSON.parse(JSON.stringify(e)):{},Or=e=>Array.isArray(e)?e.map(r=>{if(typeof r==\"string\")return r.trim();if(r instanceof RegExp)return r.source;if(r&&typeof r==\"object\"){if(typeof r.pattern==\"string\")return r.pattern.trim();if(typeof r.source==\"string\")return r.source.trim()}if(r!=null&&typeof r.toString==\"function\"){let o=r.toString();return typeof o==\"string\"?o.trim():\"\"}return\"\"}).filter(Boolean):[],pl=[\"order\",\"displayIndex\",\"display_index\",\"sort_order\",\"script_order\"],qe=(e=[])=>{!Array.isArray(e)||e.length===0||e.forEach((r,o)=>{!r||typeof r!=\"object\"||r.source===\"card\"||(pl.forEach(l=>{r[l]=o}),r?.position&&typeof r.position==\"object\"&&\"order\"in r.position&&(r.position.order=o))})},ul=e=>{if(!Array.isArray(e)||e.length===0)return e;let r=new Map([[\"global\",[]],[\"character\",[]]]);return e.forEach(o=>{if(!o||typeof o!=\"object\"||o.source===\"card\")return;let l=o.scope===\"character\"?\"character\":\"global\";r.get(l).push(o)}),r.forEach(o=>qe(o)),e},Mr=e=>{if(e===!0||e===!1)return e;if(e==null)return!1;if(typeof e==\"string\"){let r=e.trim().toLowerCase();return[\"1\",\"true\",\"yes\",\"on\"].includes(r)}return!!e},Me=e=>{if(e===\"\"||e===null||e===void 0)return null;let r=Number(e);return Number.isNaN(r)?null:r},mo=e=>{if(e==null)return\"and_any\";if(typeof e==\"number\"&&!Number.isNaN(e))return rt[e]??rt[e.toString()]??\"and_any\";let r=e.toString().trim().toLowerCase();return ot[r]!==void 0?r:rt[r]!==void 0?rt[r]:\"and_any\"};var Sr=e=>{if(typeof e==\"string\"){let r=e.trim().toLowerCase();if(dl[r]!==void 0)return r}if(typeof e==\"number\"&&!Number.isNaN(e)){let r=co[e]??co[e.toString()];if(r)return r}return null},_t=(e,r)=>{if(e==null)return\"before_character_definition\";if(typeof e==\"object\"&&e!==null){if(typeof e.type==\"string\"&&e.type){let o=(tt[e.type]??e.type).trim();if(o===\"at_depth\"||o===\"at_depth_as_system\"){let l=Sr(e.role??r)??\"system\";return l===\"assistant\"?\"at_depth_as_assistant\":l===\"user\"?\"at_depth_as_user\":\"at_depth_as_system\"}return o.startsWith(\"at_depth_as_\"),o}if(typeof e.position==\"number\"&&!Number.isNaN(e.position))return _t(e.position,e.role??r)}if(typeof e==\"string\"){let o=(tt[e]??e).trim();if(o===\"at_depth\"){let l=Sr(r)??\"system\";return l===\"assistant\"?\"at_depth_as_assistant\":l===\"user\"?\"at_depth_as_user\":\"at_depth_as_system\"}return o}if(typeof e==\"number\"&&!Number.isNaN(e)){if(e===4){let l=Sr(r)??\"system\";return l===\"assistant\"?\"at_depth_as_assistant\":l===\"user\"?\"at_depth_as_user\":\"at_depth_as_system\"}let o=hl[e];if(o)return o}return\"before_character_definition\"};var fo=(e,{fallbackRole:r=null,fallbackDepth:o=null,fallbackOrder:l=null}={})=>{let a=Sr(r),n={type:\"before_character_definition\",role:null,depth:null,order:Me(l),uiKey:\"before_character_definition\"},i=u=>{let p=Me(u);p!==null&&(n.order=p)},b=u=>{let p=Me(u);p!==null&&(n.depth=p)};if(i(l),b(o),e&&typeof e==\"object\"){if(typeof e.type==\"string\"&&e.type){let u=(tt[e.type]??e.type).trim();n.type=u===\"at_depth_as_system\"?\"at_depth\":u;let p=Sr(e.role)??a;return n.type===\"at_depth\"?(n.role=p??\"system\",b(e.depth),n.uiKey=n.role===\"assistant\"?\"at_depth_as_assistant\":n.role===\"user\"?\"at_depth_as_user\":\"at_depth_as_system\"):(n.role=null,n.depth=null,n.uiKey=n.type),i(e.order),n}if(typeof e.position==\"number\"&&!Number.isNaN(e.position)){let u=Sr(e.role)??a,p=_t(e.position,u);return n.uiKey=p,p.startsWith(\"at_depth\")?(n.type=\"at_depth\",n.role=u??\"system\",b(e.depth)):(n.type=p,n.role=null,n.depth=null),i(e.order),n}}let m=_t(e,a);return n.uiKey=m,m.startsWith(\"at_depth\")?(n.type=\"at_depth\",n.role=m===\"at_depth_as_assistant\"?\"assistant\":m===\"at_depth_as_user\"?\"user\":\"system\",n.depth===null&&(n.depth=Me(o))):(n.type=m,n.role=null,n.depth=null),n},bl=(e,{depth:r,order:o,basePosition:l}={})=>{let a=fo(l??null),n=(tt[e]??e??a.uiKey).toString().trim()||a.uiKey||\"before_character_definition\",i=kt[n]??kt[a.uiKey]??kt.before_character_definition,b={type:i.type},m=Me(o),u=m!==null?m:a.order!==null&&a.order!==void 0?a.order:0;if(b.order=u,i.type===\"at_depth\"){let p=i.role??a.role??\"system\";b.role=p;let g=Me(r),v=g!==null?g:a.depth!==null&&a.depth!==void 0?a.depth:0;b.depth=v}return b},Ze=e=>{if(!e||typeof e!=\"object\")return e;let r=pr(e);(!r.strategy||typeof r.strategy!=\"object\")&&(r.strategy={});let o=r.strategy,l=Ge(Lt(r))??Ce;o.type=l.strategyType,r.type=l.strategyType,r.statusId=l.id;let a=Or(o.keys??r.keys??r.key??r.keywords);o.keys=[...a],r.keys=[...a],r.key=[...a],r.keywords=[...a];let n=Or(o.keys_secondary?.keys??r.keysecondary??r.key_secondary??[]);(!o.keys_secondary||typeof o.keys_secondary!=\"object\")&&(o.keys_secondary={logic:\"and_any\",keys:[]}),o.keys_secondary.keys=[...n],r.keysecondary=[...n];let i=mo(o.keys_secondary.logic??r.logic??r.selectiveLogic);o.keys_secondary.logic=i,r.logic=i,r.selectiveLogic=ot[i];let b=fo(r.position,{fallbackRole:r.role,fallbackDepth:r.depth,fallbackOrder:r.order??r.insertion_order??r.displayIndex});r.position=b.uiKey,r.depth=b.type===\"at_depth\"?b.depth??0:null,r.order=b.order??0,r.role=b.role;let m=Me(r.probability);return r.probability=m===null?100:m,(!r.recursion||typeof r.recursion!=\"object\")&&(r.recursion={prevent_incoming:!1,prevent_outgoing:!1,delay_until:null}),r.prevent_recursion=Mr(r.prevent_recursion??r.preventRecursion??r.recursion.prevent_outgoing),r.exclude_recursion=Mr(r.exclude_recursion??r.excludeRecursion??r.recursion.prevent_incoming),r.recursion.prevent_outgoing=r.prevent_recursion,r.recursion.prevent_incoming=r.exclude_recursion,r.case_sensitive=Mr(r.case_sensitive??r.caseSensitive??!1),r.caseSensitive=r.case_sensitive,r.match_whole_words=Mr(r.match_whole_words??r.matchWholeWords??!1),r.matchWholeWords=r.match_whole_words,r.enabled=r.disable!==void 0?!r.disable:r.enabled??!0,r},ml=(e,r={})=>{let o=pr(r),l=pr(e),a=Ge(l.statusId??l.strategy?.type??l.type)??Ce;(!o.strategy||typeof o.strategy!=\"object\")&&(o.strategy={}),o.strategy.type=a.strategyType,o.type=a.strategyType,o.statusId=a.id,l.statusId=a.id,(!l.strategy||typeof l.strategy!=\"object\")&&(l.strategy={}),l.strategy.type=a.strategyType,l.type=a.strategyType;let n=Me(l.uid);n!==null&&(o.uid=n),l.name!==void 0&&(o.name=l.name),l.comment!==void 0&&(o.comment=l.comment),l.content!==void 0&&(o.content=l.content),(!o.strategy||typeof o.strategy!=\"object\")&&(o.strategy={});let i=o.strategy,b=Or(l.keys??i.keys??o.keys??o.key??o.keywords);i.keys=[...b],o.keys=[...b],o.key=[...b],o.keywords=[...b];let m=Or(l.keysecondary??i.keys_secondary?.keys??o.keysecondary);(!i.keys_secondary||typeof i.keys_secondary!=\"object\")&&(i.keys_secondary={logic:\"and_any\",keys:[]}),i.keys_secondary.keys=[...m],o.keysecondary=[...m];let u=mo(l.logic??i.keys_secondary.logic??o.logic??o.selectiveLogic);i.keys_secondary.logic=u,o.logic=u,o.selectiveLogic=ot[u],l.enabled!==void 0&&(o.enabled=!!l.enabled,o.disable=!o.enabled);let p=Me(l.probability);p!==null?(o.probability=p,o.useProbability=p!==100):o.probability!==void 0&&(o.useProbability=o.probability!==100);let g=Me(l.order),v=Me(l.depth),E=bl(l.position??o.position,{depth:v,order:g,basePosition:o.position});o.position=E,E.type===\"at_depth\"?(o.depth=E.depth??0,o.role=E.role??\"system\"):(o.depth=null,o.role=null),E.order!==void 0&&(o.order=E.order,o.insertion_order=E.order,o.displayIndex=E.order),(!o.recursion||typeof o.recursion!=\"object\")&&(o.recursion={prevent_incoming:!1,prevent_outgoing:!1,delay_until:null});let w=o.recursion;l.prevent_recursion!==void 0&&(w.prevent_outgoing=!!l.prevent_recursion),l.exclude_recursion!==void 0&&(w.prevent_incoming=!!l.exclude_recursion),o.preventRecursion=w.prevent_outgoing,o.prevent_recursion=w.prevent_outgoing,o.excludeRecursion=w.prevent_incoming,o.exclude_recursion=w.prevent_incoming;let k=(f,x)=>f===void 0?x:Mr(f),C=k(l.case_sensitive,o.caseSensitive??o.case_sensitive);C!==void 0&&(o.caseSensitive=C,o.case_sensitive=C);let s=k(l.match_whole_words,o.matchWholeWords??o.match_whole_words);return s!==void 0&&(o.matchWholeWords=s,o.match_whole_words=s),o},_r=e=>{if(typeof e==\"number\"&&Number.isInteger(e))return e;let r=Number(e);return Number.isInteger(r)?r:null},Lt=e=>{if(!e||typeof e!=\"object\")return Gr;let r=e?.strategy?.type??e?.type;return Cr(r)??Gr},$t=e=>e&&typeof e==\"object\"?{uid:_r(e.uid??e.id??e.entryUid??e.entry_id??null),tempUid:e.tempUid??e.temp_uid??null,name:e.name??\"\"}:{uid:_r(e),tempUid:null,name:\"\"},ho=(e,r={})=>{let o=$t(e),l=$t(r);return{uid:o.uid??l.uid??null,tempUid:e?.tempUid??e?.temp_uid??l.tempUid??null,name:e?.name??l.name??\"\",previousStatus:Lt(e??{})}},fl=e=>{let r=$t(e);return{uid:r.uid,tempUid:r.tempUid,name:r.name,previousStatus:null}},kr=(e,r={})=>({uid:e?.uid??null,tempUid:e?.tempUid??null,name:e?.name??\"\",previousStatus:e?.previousStatus??null,newStatus:r.newStatus??null,alreadyApplied:!!r.alreadyApplied,reason:r.reason??null,error:r.error??null}),wr=Object.freeze({UNSAVED_ENTRY:\"UNSAVED_ENTRY\",DUPLICATE_SELECTION:\"DUPLICATE_SELECTION\",ENTRY_NOT_FOUND:\"ENTRY_NOT_FOUND\",API_ERROR:\"API_ERROR\",STATUS_NOT_APPLIED:\"STATUS_NOT_APPLIED\"}),gl=e=>Or(e),po=e=>{if(!e)return!1;let r=String(e?.message??e??\"\").toLowerCase();return r.includes(\"\\u672A\\u627E\\u5230\\u540D\\u4E3A\")||r.includes(\"character\")&&r.includes(\"not found\")},Y={createWorldbook:I(async e=>await ge().createWorldbook(e,[])),deleteWorldbook:I(async e=>await ge().deleteWorldbook(e)),getWorldbooks:I(async()=>await ge().getWorldbookNames()),getCharData:I(async()=>await ge().getCharData()),getRegexes:I(async()=>await ge().getTavernRegexes({scope:\"all\"})),replaceRegexes:I(async(e,r={})=>{let o=r?.scope??\"all\",l=Array.isArray(e)?e:[];ul(l),await ge().replaceTavernRegexes(l,{scope:o})}),getGlobalWorldbookNames:I(async()=>await ge().getGlobalWorldbookNames()),rebindGlobalWorldbooks:I(async e=>await ge().rebindGlobalWorldbooks(e)),getCharWorldbookNames:I(async e=>{try{let r=e?.name;return r?await ge().getCharWorldbookNames(r):(console.warn(\"[RegexLoreHub] getCharWorldbookNames \\u8C03\\u7528\\u7F3A\\u5C11\\u89D2\\u8272\\u540D\\u79F0\\u3002\"),null)}catch(r){if(po(r))return console.warn(\"[RegexLoreHub] \\u672A\\u627E\\u5230\\u6307\\u5B9A\\u89D2\\u8272\\u5361\\uFF0C\\u8DF3\\u8FC7\\u89D2\\u8272\\u4E16\\u754C\\u4E66\\u52A0\\u8F7D\\u3002\",r),null;throw r}}),getCurrentCharWorldbookNames:I(async()=>{try{return await ge().getCharWorldbookNames(\"current\")}catch(e){if(po(e))return console.warn(\"[RegexLoreHub] \\u672A\\u627E\\u5230\\u5F53\\u524D\\u89D2\\u8272\\u5361\\uFF0C\\u8DF3\\u8FC7\\u89D2\\u8272\\u4E16\\u754C\\u4E66\\u52A0\\u8F7D\\u3002\",e),null;throw e}}),getChatWorldbookName:I(async()=>await ge().getChatWorldbookName(\"current\")),getOrCreateChatWorldbook:I(async e=>await ge().getOrCreateChatWorldbook(\"current\",e)),rebindChatWorldbook:I(async e=>await ge().rebindChatWorldbook(\"current\",e)),getWorldbook:I(async e=>await ge().getWorldbook(e)),updateWorldbookWith:I(async(e,r)=>await ge().updateWorldbookWith(e,r)),replaceWorldbook:I(async(e,r)=>await ge().replaceWorldbook(e,r)),createWorldbookEntries:I(async(e,r)=>await ge().createWorldbookEntries(e,r)),deleteWorldbookEntries:I(async(e,r)=>{let o=new Set(r);return await ge().deleteWorldbookEntries(e,l=>o.has(l.uid))}),saveSettings:I(async()=>await ge().builtin.saveSettings()),rebindCharWorldbooks:I(async e=>await ge().rebindCharWorldbooks(\"current\",e)),get Character(){return ge().Character}},Pe=I(async(e,r)=>{if(!Array.isArray(r)||r.length===0)return;let o=new Map,l=new Set;if(r.forEach(u=>{if(!u||typeof u!=\"object\")return;let p=Me(u.uid);if(p===null)return;l.add(p);let g=o.get(p)??{};o.set(p,{...g,...u})}),l.size===0)return;let a=ee(e),n=new Map(a.map(u=>[Me(u?.uid),u]).filter(([u])=>u!==null)),i=u=>u.map(p=>{let g=Me(p?.uid);if(g===null||!l.has(g))return p;let v=n.get(g);if(!v)return p;let E=pr(v),w=o.get(g);return w&&typeof w==\"object\"&&Object.entries(w).forEach(([k,C])=>{k===\"uid\"||k===\"tempUid\"||(Array.isArray(C)?E[k]=C.map(s=>typeof s==\"object\"&&s!==null?pr(s):s):C&&typeof C==\"object\"?E[k]=pr(C):E[k]=C)}),ml(E,p)}),b=await Y.updateWorldbookWith(e,i),m=Array.isArray(b)?b.map(Ze):[];return Re(e,m),ur(e),await Y.saveSettings(),b}),uo=(e,r,o,l,a)=>{let n=r.length,i=o.length,b=l.length,m=r.filter(v=>v.alreadyApplied).length,u=n-m,p=l.filter(v=>v.reason===wr.UNSAVED_ENTRY).length,g=\"skipped\";return n>0&&i===0?g=\"success\":n>0&&i>0?g=\"partial\":i>0&&(g=\"failed\"),{status:g,successCount:n,failedCount:i,ignoredCount:b,alreadyAppliedCount:m,appliedCount:u,ignoredUnsavedCount:p,requestedCount:a,targetStatusId:e.id,targetStatusLabel:e.label}},go=async(e,r,o,l={})=>{let a=Array.isArray(r)?r.filter(s=>s!=null):r!=null?[r]:[],n=a.length,i=Ge(o);if(!i)return{ok:!1,targetStatusId:Cr(o),targetStatusLabel:\"\",targetStrategyType:null,success:[],failed:[],ignored:[],summary:{status:\"failed\",successCount:0,failedCount:0,ignoredCount:0,alreadyAppliedCount:0,appliedCount:0,ignoredUnsavedCount:0,requestedCount:n,targetStatusId:Cr(o),targetStatusLabel:\"\"},errorCode:\"INVALID_STATUS\"};if(!e||typeof e!=\"string\"){let s=Ce;return{ok:!1,targetStatusId:s.id,targetStatusLabel:s.label,targetStrategyType:s.strategyType,success:[],failed:[],ignored:[],summary:uo(s,[],[],[],n),errorCode:\"INVALID_BOOK_NAME\"}}let b=ee(e),m=new Map(b.map(s=>[_r(s?.uid),s])),u=new Set,p=[],g=[],v=[],E=[],w=new Map;a.forEach(s=>{let f=fl(s);if(f.uid===null){v.push(kr(f,{reason:wr.UNSAVED_ENTRY}));return}if(u.has(f.uid)){let L=m.get(f.uid),K=L?ho(L,f):f;v.push(kr(K,{reason:wr.DUPLICATE_SELECTION}));return}u.add(f.uid);let x=m.get(f.uid);if(!x){g.push(kr(f,{reason:wr.ENTRY_NOT_FOUND}));return}let A=ho(x,f);if(A.previousStatus===i.id){p.push(kr(A,{newStatus:i.id,alreadyApplied:!0}));return}let M=pr(x.strategy??{});M.type=i.strategyType,E.push({uid:A.uid,statusId:i.id,strategy:M,type:i.strategyType}),w.set(A.uid,A)});let k;if(E.length>0&&(k=await Pe(e,E)),w.size>0){let s=ee(e),f=new Map(s.map(A=>[_r(A?.uid),A])),x=E.length>0&&!Array.isArray(k);w.forEach(A=>{let M=f.get(A.uid),L=Lt(M);if(!M||L!==i.id){g.push(kr(A,{reason:x?wr.API_ERROR:wr.STATUS_NOT_APPLIED}));return}p.push(kr(A,{newStatus:i.id}))})}let C=uo(i,p,g,v,n);return{ok:C.status===\"success\",targetStatusId:i.id,targetStatusLabel:i.label,targetStrategyType:i.strategyType,targetToastLabel:i.toastLabel??i.label,success:p,failed:g,ignored:v,summary:C,options:l}};var xl=e=>(t.pendingLorebookUpdates.has(e)||t.pendingLorebookUpdates.set(e,new Map),t.pendingLorebookUpdates.get(e)),Tt=(e,r,o={})=>{if(!e||!o||typeof o!=\"object\")return;let l=_r(r),a=String(r),n=xl(e),i=n.get(a)??{uid:l,tempUid:l==null?a:null,data:{}};l!=null&&(i.uid=l),(!i.data||typeof i.data!=\"object\")&&(i.data={});let b={...o};Array.isArray(b.keys)&&(b.keys=gl(b.keys)),Object.entries(b).forEach(([m,u])=>{u!==void 0&&(i.data[m]=u)}),n.set(a,i)},xo=e=>{e!=null&&t.pendingRegexUpdates.add(e)},vl=(e,r,o)=>{let l=_r(o);if(!e||r==null||l==null)return;let a=t.pendingLorebookUpdates.get(e);if(!a||!(a instanceof Map))return;let n=String(r),i=a.get(n);if(!i)return;a.delete(n);let b=String(l),m=a.get(b)??{uid:l,tempUid:null,data:{}};m.uid=l,(!m.data||typeof m.data!=\"object\")&&(m.data={}),i.data&&typeof i.data==\"object\"&&(m.data={...i.data,...m.data}),a.set(b,m)},Br=null,yl=async()=>{let e=ce(),r=fe(),o=ke(),l=ge(),a=e(`#${me}-content`,r);Dr();let i=(()=>{a.html(`\n      <div class=\"rlh-loading\">\n        <div class=\"rlh-loading-spinner\" aria-hidden=\"true\"></div>\n        <div class=\"rlh-loading-text\">\n          <p class=\"rlh-loading-title\">\\u6B63\\u5728\\u52A0\\u8F7D\\u6570\\u636E...</p>\n          <p class=\"rlh-loading-status\">\\u521D\\u59CB\\u5316...</p>\n          <div class=\"rlh-loading-bar\" role=\"progressbar\" aria-valuemin=\"0\" aria-valuemax=\"100\" aria-valuenow=\"0\">\n            <div class=\"rlh-loading-bar-inner\"></div>\n          </div>\n          <div class=\"rlh-loading-progress\">0%</div>\n          <p class=\"rlh-loading-detail\"></p>\n        </div>\n      </div>\n    `);let g=a.find(\".rlh-loading-status\"),v=a.find(\".rlh-loading-detail\"),E=a.find(\".rlh-loading-progress\"),w=a.find(\".rlh-loading-bar-inner\"),k=a.find(\".rlh-loading-bar\"),C=1,s=0,f=()=>{let x=Math.max(1,C),A=Math.min(s/x,1),M=Math.round(A*100);w.css(\"width\",`${M}%`),k.attr(\"aria-valuenow\",M),E.text(`${M}%`)};return f(),{setProgress(x,A,M,L){C=Math.max(1,A),s=Math.max(0,Math.min(x,C)),M&&g.text(M),L!==void 0&&v.text(L),f()},setStatus(x,A){x&&g.text(x),A!==void 0&&v.text(A)}}})(),b=4,m=0,u=(p,g)=>{m=Math.min(m+1,b),i.setProgress(m,b,p,g)};i.setProgress(m,b,\"\\u51C6\\u5907\\u52A0\\u8F7D\\u6570\\u636E...\",\"\\u6B63\\u5728\\u68C0\\u67E5\\u8FD0\\u884C\\u73AF\\u5883\");try{if(!o.SillyTavern||!o.SillyTavern.getContext){console.warn(\"[RegexLoreHub] SillyTavern API not available, initializing with empty data\"),t.regexes.global=[],t.regexes.character=[],t.allLorebooks=[],t.lorebooks.character=[],t.chatLorebook=null,bt(),t.isDataLoaded=!0,oe();return}u(\"\\u83B7\\u53D6\\u57FA\\u7840\\u6570\\u636E...\",\"\\u6B63\\u5728\\u5411 SillyTavern \\u8BF7\\u6C42\\u6570\\u636E\");let p=o.SillyTavern?.getContext?.()||{},g=Array.isArray(p.characters)?p.characters:[],v=p.characterId!==void 0&&p.characterId!==null,E=p.chatId!==void 0&&p.chatId!==null,w=null,k=null,C=null,s=[Y.getRegexes().catch(()=>[]),Y.getGlobalWorldbookNames().catch(()=>[]),Y.getWorldbooks().catch(()=>[])];v?(s.push(Y.getCharData().catch(()=>null)),s.push(Y.getCurrentCharWorldbookNames().catch(()=>null))):s.push(Promise.resolve(null),Promise.resolve(null)),E?s.push(Y.getChatWorldbookName().catch(F=>(console.warn(\"[RegexLoreHub] Failed to get chat worldbook:\",F),null))):s.push(Promise.resolve(null));let f=await Promise.allSettled(s);u(\"\\u89E3\\u6790\\u6570\\u636E\\u7ED3\\u6784...\",`\\u68C0\\u6D4B\\u5230 ${g.length} \\u4E2A\\u89D2\\u8272\\uFF0C\\u6B63\\u5728\\u6574\\u7406\\u6570\\u636E`);let x=f[0].status===\"fulfilled\"?f[0].value:[],A=f[1].status===\"fulfilled\"?f[1].value:[],M=f[2].status===\"fulfilled\"?f[2].value:[];w=f[3]?.status===\"fulfilled\"?f[3].value:null,k=f[4]?.status===\"fulfilled\"?f[4].value:null,C=f[5]?.status===\"fulfilled\"?f[5].value:null,Dr({charData:w}),t.regexes.global=Array.isArray(x)?x.filter(F=>F.scope===\"global\"):[],qe(t.regexes.global),_o(x,w),bt(),t.pendingLorebookUpdates instanceof Map?t.pendingLorebookUpdates.clear():t.pendingLorebookUpdates=new Map,t.pendingRegexUpdates instanceof Set?t.pendingRegexUpdates.clear():t.pendingRegexUpdates=new Set,t.lorebookUsage.clear();let L=new Set(Array.isArray(M)?M:[]);if(Array.isArray(g)&&g.length>0)try{await Promise.all(g.map(async F=>{if(!(!F||!F.name))try{let X=null;try{let D=l.getCharWorldbookNames(F.name);D&&typeof D.then==\"function\"?X=await D:X=D}catch(D){console.warn(`[RegexLoreHub] Error getting worldbooks for character \"${F.name}\":`,D),X=null}if(X&&typeof X==\"object\"){let D=new Set;X.primary&&typeof X.primary==\"string\"&&D.add(X.primary),Array.isArray(X.additional)&&X.additional.forEach(Z=>typeof Z==\"string\"&&D.add(Z)),D.forEach(Z=>{typeof Z==\"string\"&&(t.lorebookUsage.has(Z)||t.lorebookUsage.set(Z,[]),t.lorebookUsage.get(Z).push(F.name),L.add(Z),console.log(`[RegexLoreHub] Character \"${F.name}\" uses worldbook \"${Z}\"`))})}}catch(X){console.warn(`[RegexLoreHub] Error processing character ${F.name}:`,X)}}))}catch(F){console.warn(\"[RegexLoreHub] Error processing characters:\",F)}let K=new Set(Array.isArray(A)?A:[]);t.allLorebooks=(Array.isArray(M)?M:[]).map(F=>({name:F,enabled:K.has(F),entryCount:0,enabledEntryCount:0,entriesLoaded:!1}));let ne=new Set;k&&typeof k==\"object\"&&(k.primary&&typeof k.primary==\"string\"&&ne.add(k.primary),Array.isArray(k.additional)&&k.additional.forEach(F=>typeof F==\"string\"&&ne.add(F))),t.lorebooks.character=Array.from(ne),t.chatLorebook=typeof C==\"string\"?C:null,typeof C==\"string\"&&L.add(C),u(\"\\u6784\\u5EFA\\u7D22\\u5F15...\",\"\\u4E16\\u754C\\u4E66\\u5217\\u8868\\u5DF2\\u52A0\\u8F7D\"),t.isDataLoaded=!0,u(\"\\u6E32\\u67D3\\u754C\\u9762...\",\"\\u6570\\u636E\\u52A0\\u8F7D\\u5B8C\\u6210\"),oe(),_l()}catch(p){throw console.error(\"[RegexLoreHub] Error in loadAllData:\",p),a.html(`\n                <div class=\"rlh-error-wrapper\">\n                    <p class=\"rlh-error-title\">\n                        <i class=\"fa-solid fa-exclamation-triangle\"></i> \\u6570\\u636E\\u52A0\\u8F7D\\u5931\\u8D25\n                    </p>\n                    <p class=\"rlh-error-text\">\n                        \\u8BF7\\u68C0\\u67E5\\u5F00\\u53D1\\u8005\\u63A7\\u5236\\u53F0\\u83B7\\u53D6\\u8BE6\\u7EC6\\u4FE1\\u606F\\uFF0C\\u6216\\u5C1D\\u8BD5\\u5237\\u65B0\\u9875\\u9762\\u3002\n                    </p>\n                    <button class=\"rlh-modal-btn rlh-error-retry-btn\" onclick=\"$('#${Er}').click()\">\n                        <i class=\"fa-solid fa-refresh\"></i> \\u91CD\\u8BD5\n                    </button>\n                </div>\n            `),p}},ze=I(async(e=!1)=>{if(e)t.isDataLoaded=!1;else if(t.isDataLoaded)return;if(!(Br&&(await Br,!e))){Br=yl();try{await Br}finally{Br=null}}}),wt=!1,kl=3,bo=e=>new Promise(r=>setTimeout(r,e)),vo=()=>{let e=ce(),r=fe();if(!e||!r)return{};let o=e(`#${zr}`,r);if(!o.length)return{};let l=o.find(`#${Fr}`),a=o.find(`#${jr}`),n=o.find(\".rlh-prefetch-bar\");return{$indicator:o,$text:l,$bar:a,$barContainer:n}},yo=e=>{let{$indicator:r,$bar:o,$barContainer:l}=vo();r&&(r.attr(\"data-visible\",e?\"true\":\"false\"),r.attr(\"aria-hidden\",e?\"false\":\"true\"),e||(o?.length&&o.css(\"width\",\"0%\"),l?.length&&l.attr(\"aria-valuenow\",0)))},ko=(e,r)=>{let{$indicator:o,$text:l,$bar:a,$barContainer:n}=vo();if(!o)return;let i=r>0?r:1,b=Math.min(e,r),m=Math.round(b/i*100),u=`\\u540E\\u53F0\\u52A0\\u8F7D\\u4E16\\u754C\\u4E66 (${b}/${r})\\uFF0C\\u4E0D\\u5F71\\u54CD\\u5176\\u4ED6\\u64CD\\u4F5C`;l?.length&&l.text(u),a?.length&&a.css(\"width\",`${Math.min(m,100)}%`),n?.length&&n.attr(\"aria-valuenow\",Math.min(m,100))},Et=()=>{yo(!1)},wl=e=>{let r=ce(),o=fe();if(!r||!o)return;let l=r(`#${me}`,o);if(!l.length)return;let a=l.find(\".rlh-book-group\").filter((i,b)=>r(b).data(\"book-name\")===e);if(!a.length)return;let n=t.allLorebooks.find(i=>i.name===e);n&&a.find(\".rlh-book-stats\").text(`\\u6761\\u76EE: ${n.enabledEntryCount} / ${n.entryCount}`)},Sl=e=>{if(e<=0){Et();return}yo(!0),ko(0,e)},_l=I(async()=>{if(wt)return;let e=t.allLorebooks.filter(r=>!r.entriesLoaded);if(e.length===0){Et();return}wt=!0,Sl(e.length);try{let r=0,o=[...e],l=async()=>{for(;o.length>0;){let n=o.shift();if(!n)break;try{await Ee(n.name),wl(n.name)}finally{r+=1,ko(r,e.length)}await bo(30)}},a=Math.min(kl,o.length);await Promise.all(Array.from({length:a},()=>l()))}finally{await bo(260),Et(),wt=!1}}),wo=()=>{let e=Array.isArray(t.allLorebooks)?t.allLorebooks:[],r=new Map,o=new Set,l=0;return e.forEach(a=>{let n=Vt(a);n.name&&(l+=1,r.set(n.name,n),n.bindingCount===0&&o.add(n.name))}),{totalBooks:l,unboundNames:o,statsByName:r}},So=I(async()=>{let r=ke().SillyTavern?.getContext?.()||{},o=r.chatId!==void 0&&r.chatId!==null,l=[Y.getCharData(),Y.getCurrentCharWorldbookNames(),Y.getRegexes()];o?l.push(Y.getChatWorldbookName().catch(u=>(console.warn(\"[RegexLoreHub] Failed to get chat worldbook in refreshCharacterData:\",u),null))):l.push(Promise.resolve(null));let[a,n,i,b]=await Promise.all(l);_o(i,a),Dr({charData:a}),$l(n),t.chatLorebook=b;let m=t.lorebooks.character.filter(u=>!mt(u));m.length>0&&await Promise.all(m.map(async u=>{let p=await Y.getWorldbook(u);Re(u,p.map(Ze))}))});function _o(e,r){let o=e?.filter(i=>i.scope===\"character\")||[],l=[];if(r&&Y.Character)try{l=(new Y.Character(r).getRegexScripts()||[]).map((b,m)=>({id:b.id||`card-${Date.now()}-${m}`,script_name:b.scriptName||\"\\u672A\\u547D\\u540D\\u5361\\u5185\\u6B63\\u5219\",find_regex:b.findRegex,replace_string:b.replaceString,enabled:!b.disabled,scope:\"character\",source:\"card\"}))}catch(i){console.warn(\"\\u65E0\\u6CD5\\u89E3\\u6790\\u89D2\\u8272\\u5361\\u6B63\\u5219\\u811A\\u672C:\",i)}let a=new Set(o.map(i=>`${i.script_name}::${i.find_regex}::${i.replace_string}`)),n=l.filter(i=>{let b=`${i.script_name}::${i.find_regex}::${i.replace_string}`;return!a.has(b)});t.regexes.character=[...o,...n],qe(t.regexes.character)}function $l(e){let r=[];e&&(e.primary&&r.push(e.primary),e.additional&&r.push(...e.additional)),t.lorebooks.character=[...new Set(r)]}var ur=e=>{let r=ee(e),o=t.allLorebooks.find(l=>l.name===e);o&&(o.entryCount=r.length,o.enabledEntryCount=r.filter(l=>l.enabled).length)},$o=e=>{let r={uid:`temp-${Date.now()}`,name:\"\\u65B0\\u6761\\u76EE\",comment:\"\",content:\"\",keys:[],key:[],keysecondary:[],statusId:Gr,enabled:!0,disable:!1,is_temp:!0,selective:!0,selectiveLogic:ot.and_any,logic:\"and_any\",constant:!1,position:\"before_character_definition\",depth:null,order:0,probability:100,useProbability:!1,case_sensitive:!1,match_whole_words:!1,prevent_recursion:!1,exclude_recursion:!1,type:Ce?.strategyType??\"constant\",strategy:{type:Ce?.strategyType??\"constant\",keys:[],keys_secondary:{logic:\"and_any\",keys:[]},scan_depth:\"same_as_global\"}},o=ee(e);return o.unshift(r),Re(e,o),r},Eo=(e,r,o)=>{let l=ee(e),a=l.findIndex(n=>n.uid===r);if(a!==-1){let n=Ze(o),i={...l[a],...n,is_temp:!1};l[a]=i,Re(e,l),vl(e,r,i.uid)}else console.warn(`[RegexLoreHub] \\u5728\\u66F4\\u65B0\\u65F6\\u627E\\u4E0D\\u5230\\u4E34\\u65F6\\u6761\\u76EE: ${r}`)},Ee=I(async(e,r=!1)=>{let o=t.allLorebooks.find(l=>l.name===e);if(!(!o||mt(e)&&!r))try{let l=await Y.getWorldbook(e);l=l.map(Ze),Re(e,l),o.entriesLoaded=!0,ur(e)}catch(l){console.error(`[RegexLoreHub] Failed to load entries for worldbook \"${e}\":`,l),o.entriesLoaded=!0}}),ar=I(async(e={})=>{let{silent:r=!1}=e,o=3,l=3e3,a=0,n=p=>new Promise(g=>setTimeout(g,p)),i=()=>{r?Zr():oe()},b=async()=>{if(!(t.pendingLorebookUpdates instanceof Map))return t.pendingLorebookUpdates=new Map,!1;let p=!1;for(let[g,v]of[...t.pendingLorebookUpdates.entries()]){if(!(v instanceof Map)||v.size===0)continue;let E=[],w=[];for(let[C,s]of v.entries()){let f=s?.uid;if(typeof f!=\"number\"||Number.isNaN(f))continue;let x=s?.data;if(!x||Object.keys(x).length===0){w.push(C);continue}E.push({uid:f,...x}),w.push(C)}if(E.length===0){w.forEach(C=>v.delete(C)),v.size===0&&t.pendingLorebookUpdates.delete(g);continue}await Pe(g,E)&&(p=!0,w.forEach(C=>v.delete(C)),v.size===0&&t.pendingLorebookUpdates.delete(g))}return p},m=async()=>{if(!(t.pendingRegexUpdates instanceof Set))return t.pendingRegexUpdates=new Set,!1;if(t.pendingRegexUpdates.size===0)return!1;qe(t.regexes.global),qe(t.regexes.character);let p=[...t.regexes.global,...t.regexes.character];return await Y.replaceRegexes(p.filter(g=>g.source!==\"card\")),await Y.saveSettings(),t.pendingRegexUpdates.clear(),!0},u=async()=>{console.log(\"[RegexLoreHub] \\u6267\\u884C\\u7EDF\\u4E00\\u4FDD\\u5B58\\u64CD\\u4F5C...\");let p=await b(),g=await m();return console.log(!p&&!g?\"[RegexLoreHub] \\u6CA1\\u6709\\u5F85\\u4FDD\\u5B58\\u7684\\u66F4\\u6539\\u3002\":\"[RegexLoreHub] \\u4FDD\\u5B58\\u64CD\\u4F5C\\u5B8C\\u6210\\u3002\"),!0};for(;a<o;)try{t.saveRetryAttempt=a+1,t.saveStatus=a===0?\"saving\":\"retrying\",i(),await u(),t.saveStatus=\"success\",t.saveRetryAttempt=0,i(),await n(1500),t.saveStatus=\"idle\",i(),console.log(\"[RegexLoreHub] \\u6240\\u6709\\u66F4\\u6539\\u5DF2\\u6210\\u529F\\u4FDD\\u5B58\\u3002\");return}catch(p){if(a++,console.error(`[RegexLoreHub] \\u4FDD\\u5B58\\u5931\\u8D25\\uFF0C\\u5C1D\\u8BD5\\u6B21\\u6570 ${a}/${o}:`,p),a>=o)throw t.saveStatus=\"failed\",i(),console.error(\"[RegexLoreHub] \\u6240\\u6709\\u91CD\\u8BD5\\u5747\\u5931\\u8D25\\uFF0C\\u5DF2\\u505C\\u6B62\\u4FDD\\u5B58\\u3002\"),new Error(\"\\u81EA\\u52A8\\u4FDD\\u5B58\\u5931\\u8D25\\uFF0C\\u8BF7\\u68C0\\u67E5\\u8FDE\\u63A5\\u6216\\u624B\\u52A8\\u4FDD\\u5B58\\u3002\");await n(l)}}),Be=e=>{if(typeof e!=\"string\")return null;let r=e.trim();return r.length>0?r:null},St=e=>!e||typeof e!=\"object\"?null:Be(e.name)||Be(e.display_name)||Be(e.title)||Be(e.metadata?.name)||Be(e.filename)||Be(e.external_id),El=e=>!e||typeof e!=\"object\"?null:Be(e.name)||Be(e.char_name)||Be(e.display_name)||Be(e.metadata?.name)||Be(e.data?.name)||Be(e.data?.char_name)||Be(e.data?.display_name),Ll=(e,r)=>{if(!e||r===void 0||r===null)return!1;let o=String(r);return[e.id,e.characterId,e.metadata?.characterId,e.metadata?.id,e.external_id,e.filename].map(a=>a==null?null:String(a)).some(a=>a&&a===o)},Dr=({charData:e=null}={})=>{let o=ke().SillyTavern?.getContext?.()||{},l=Array.isArray(o.characters)?o.characters:[],a=o.characterId!==void 0&&o.characterId!==null?o.characterId:null,n=Be(o.name)||St(o.character);if(!n&&a!==null){let i=l.find(b=>Ll(b,a));i&&(n=St(i))}!n&&e&&(n=El(e)),!n&&l.length===1&&(n=St(l[0])),t.characterContext.name=n??null,t.characterContext.id=a,console.log(\"[RegexLoreHub] Context synced with appState:\",t.characterContext)};function Lo(e={}){let r=e.$??ce(),o=e.parentDoc??fe(),l=e.parentWin??ke(),a=async(s,{showLoading:f=!0}={})=>{let x=(s??\"\").toString().trim();if(!x)return;let A=t.loadingBookName;try{f&&(t.loadingBookName=x,oe()),await Ee(x,!0)}finally{t.loadingBookName=A&&A!==x?A:null,oe()}},n=I(async s=>{t.activeView=\"global-lore-detail\",t.activeBookName=s,t.loadingBookName=s,oe(),await Ee(s),t.loadingBookName=null,oe()}),i=I(async()=>{t.activeView=\"global-lore-list\",t.activeBookName=null,t.selectedItems.clear(),t.globalSearch={term:\"\",replace:\"\"};let s=r(\"#rlh-global-search-input\",o);s.length&&s.val(\"\"),oe()}),b=I(async(s,f,x)=>{let A=t.lorebookUsage.get(s)||[];if(A.length===0)return;let M=l.SillyTavern.getContext(),L=M.characterId,K=0,ne=A.length;x.update(`\\u6B63\\u5728\\u66F4\\u65B0 ${ne} \\u4E2A\\u5173\\u8054\\u89D2\\u8272... (0/${ne})`);for(let F of A){try{let X=l.Character?.findCharacterIndex?.(F)??M.characters.findIndex(pe=>pe.name===F);if(X===-1){console.warn(`[RegexLoreHub] Character \"${F}\" not found, skipping...`);continue}console.log(`[RegexLoreHub] Switching to character \"${F}\" (index: ${X})`),await M.selectCharacterById(X);let D=await Y.getCharWorldbookNames({name:F});if(!D){console.warn(`[RegexLoreHub] Failed to get worldbooks for character \"${F}\"`);continue}console.log(`[RegexLoreHub] Current worldbooks for \"${F}\":`,D);let Z=!1;if(D.primary===s&&(console.log(`[RegexLoreHub] Updating primary lorebook from \"${s}\" to \"${f}\"`),D.primary=f,Z=!0),D.additional){let pe=D.additional.indexOf(s);pe>-1&&(console.log(`[RegexLoreHub] Updating additional lorebook at index ${pe} from \"${s}\" to \"${f}\"`),D.additional[pe]=f,Z=!0)}Z?(console.log(`[RegexLoreHub] Saving updated lorebooks for \"${F}\":`,D),await Y.rebindCharWorldbooks(D),console.log(`[RegexLoreHub] Successfully updated lorebooks for \"${F}\"`)):console.log(`[RegexLoreHub] No updates needed for character \"${F}\"`)}catch(X){console.error(`[RegexLoreHub] Failed to update lorebook for character \"${F}\":`,X)}K++,x.update(`\\u6B63\\u5728\\u66F4\\u65B0 ${ne} \\u4E2A\\u5173\\u8054\\u89D2\\u8272... (${K}/${ne})`)}M.characterId!==L&&await M.selectCharacterById(L)}),m=I(async s=>{s.stopPropagation();let x=r(s.currentTarget).closest(\".rlh-book-group, .rlh-detail-view\"),A=x.hasClass(\"rlh-detail-view\"),M=x.data(\"book-name\")||t.activeBookName;if(!M)return;let L;try{L=await q({type:\"prompt\",title:\"\\u91CD\\u547D\\u540D\\u4E16\\u754C\\u4E66\",text:\"\\u8BF7\\u8F93\\u5165\\u65B0\\u7684\\u4E16\\u754C\\u4E66\\u540D\\u79F0\\uFF1A\",value:M})}catch{return}if(L=L.trim(),!L||L===M)return;if(t.allLorebooks.some(pe=>pe.name===L)){await q({type:\"alert\",title:\"\\u91CD\\u547D\\u540D\\u5931\\u8D25\",text:\"\\u8BE5\\u540D\\u79F0\\u7684\\u4E16\\u754C\\u4E66\\u5DF2\\u5B58\\u5728\\uFF0C\\u8BF7\\u9009\\u62E9\\u5176\\u4ED6\\u540D\\u79F0\\u3002\"});return}let K=t.lorebookUsage.get(M)||[],ne=t.chatLorebook===M,F=ne?1:0,X=K.length+F;console.log(`[RegexLoreHub] Renaming lorebook \"${M}\" to \"${L}\", linked characters:`,K,\"chat linked:\",ne);let D=`\\u6B64\\u64CD\\u4F5C\\u5C06\\u66F4\\u65B0 ${X} \\u4E2A\\u7ED1\\u5B9A\\u5173\\u7CFB`;K.length>0&&(D+=`\\uFF0C\\u9700\\u8981\\u4E34\\u65F6\\u5207\\u6362\\u5230 ${K.length} \\u4E2A\\u5173\\u8054\\u89D2\\u8272\\u5361\\u6765\\u66F4\\u65B0\\u4E16\\u754C\\u4E66\\u94FE\\u63A5`),D+=`\\uFF0C\\u671F\\u95F4\\u8BF7\\u52FF\\u64CD\\u4F5C\\u3002\n\n`,K.length>0&&(D+=`\\u5173\\u8054\\u89D2\\u8272\\u5361\\uFF1A${K.join(\", \")}\n`),ne&&(D+=`\\u5173\\u8054\\u804A\\u5929\\uFF1A\\u5F53\\u524D\\u804A\\u5929\n`),t.activeTab===\"global-lore\"&&(D+=`\n\\u26A0\\uFE0F \\u91CD\\u8981\\u63D0\\u793A\\uFF1A\\u7531\\u4E8ESillyTavern API\\u9650\\u5236\\uFF0C\\u65E0\\u6CD5\\u76F4\\u63A5\\u5217\\u51FA\\u6240\\u6709*\\u804A\\u5929\\u4E16\\u754C\\u4E66*\\u7ED1\\u5B9A\\u3002\\u5982\\u679C\\u6B64\\u4E16\\u754C\\u4E66\\u4E0E*\\u804A\\u5929*\\u7ED1\\u5B9A\\uFF0C\\u91CD\\u547D\\u540D\\u540E\\u9700\\u8981\\u624B\\u52A8\\u68C0\\u67E5\\u90A3\\u4E9B\\u804A\\u5929\\u7ED1\\u5B9A\\u72B6\\u6001\\u3002\n`),D+=`\n\\u662F\\u5426\\u7EE7\\u7EED\\uFF1F`;try{await q({type:\"confirm\",title:\"\\u786E\\u8BA4\\u91CD\\u547D\\u540D\",text:D})}catch{return}let Z=Qe(\"\\u5F00\\u59CB\\u91CD\\u547D\\u540D...\");try{if(Z.update(\"\\u6B63\\u5728\\u521B\\u5EFA\\u65B0\\u4E16\\u754C\\u4E66...\"),!await Y.createWorldbook(L))throw new Error(\"\\u521B\\u5EFA\\u65B0\\u4E16\\u754C\\u4E66\\u6587\\u4EF6\\u5931\\u8D25\\u3002\");let ae=[...ee(M)];if(ae.length>0){Z.update(\"\\u6B63\\u5728\\u590D\\u5236\\u6761\\u76EE...\");let d=ae.map(y=>{let T={...y};return delete T.uid,T});await Y.createWorldbookEntries(L,d)}await b(M,L,Z),Z.update(\"\\u6B63\\u5728\\u66F4\\u65B0\\u5168\\u5C40\\u8BBE\\u7F6E...\");let de=await Y.getGlobalWorldbookNames();if(de&&de.includes(M)){let d=de.map(T=>T===M?L:T);await Y.rebindGlobalWorldbooks(d),console.log(`[RegexLoreHub] Updated global lorebook settings from \"${M}\" to \"${L}\"`);let y=await Y.getGlobalWorldbookNames();(!y||!y.includes(L))&&console.warn(`[RegexLoreHub] Global lorebook settings update verification failed for \"${L}\"`)}if(t.chatLorebook===M){Z.update(\"\\u6B63\\u5728\\u66F4\\u65B0\\u804A\\u5929\\u7ED1\\u5B9A...\"),await Y.rebindChatWorldbook(L),t.chatLorebook=L,console.log(`[RegexLoreHub] Updated chat lorebook from \"${M}\" to \"${L}\"`);try{let d=await Y.getChatWorldbookName();d!==L&&(console.warn(`[RegexLoreHub] Chat lorebook update verification failed. Expected: \"${L}\", Got: \"${d}\"`),t.chatLorebook=d)}catch(d){console.warn(\"[RegexLoreHub] Failed to verify chat lorebook update:\",d)}}if(Z.update(\"\\u6B63\\u5728\\u66F4\\u65B0\\u5185\\u90E8\\u6620\\u5C04...\"),t.lorebookUsage.has(M)){let d=t.lorebookUsage.get(M);t.lorebookUsage.delete(M),t.lorebookUsage.set(L,d),console.log(`[RegexLoreHub] Updated lorebookUsage mapping from \"${M}\" to \"${L}\"`)}Z.update(\"\\u6B63\\u5728\\u5220\\u9664\\u65E7\\u4E16\\u754C\\u4E66...\"),await Y.deleteWorldbook(M),Z.update(\"\\u6B63\\u5728\\u5237\\u65B0\\u6570\\u636E...\");let re=t.chatLorebook;await ze(!0),re&&t.chatLorebook!==re&&(console.log(`[RegexLoreHub] Restoring chat lorebook state after data refresh: \"${re}\"`),t.chatLorebook=re);try{let d=l.SillyTavern.getContext()||{};if(d.chatId!==void 0&&d.chatId!==null){let T=await Y.getChatWorldbookName();T!==t.chatLorebook&&(console.log(`[RegexLoreHub] Final chat lorebook sync: \"${T}\"`),t.chatLorebook=T)}}catch(d){console.warn(\"[RegexLoreHub] Failed to sync final chat lorebook state:\",d)}Z.remove(),he(\"\\u4E16\\u754C\\u4E66\\u91CD\\u547D\\u540D\\u6210\\u529F\"),A?await n(L):oe()}catch(pe){Z.remove(),console.error(\"[RegexLoreHub] Rename failed:\",pe),await q({type:\"alert\",title:\"\\u91CD\\u547D\\u540D\\u5931\\u8D25\",text:`\\u64CD\\u4F5C\\u5931\\u8D25: ${pe.message}`}),t.allLorebooks.some(de=>de.name===L)&&await Y.deleteWorldbook(L);let ae=t.chatLorebook;await ze(!0),ae&&t.chatLorebook!==ae&&(console.log(`[RegexLoreHub] Restoring chat lorebook state after error recovery: \"${ae}\"`),t.chatLorebook=ae);try{let de=l.SillyTavern.getContext()||{};if(de.chatId!==void 0&&de.chatId!==null){let d=await Y.getChatWorldbookName();d!==t.chatLorebook&&(console.log(`[RegexLoreHub] Final chat lorebook sync after error recovery: \"${d}\"`),t.chatLorebook=d)}}catch(de){console.warn(\"[RegexLoreHub] Failed to sync chat lorebook state after error recovery:\",de)}}}),u=I(async(s,f=\"\")=>{let x;try{x=await q({type:\"prompt\",title:\"\\u65B0\\u5EFA\\u4E16\\u754C\\u4E66\",text:\"\\u8BF7\\u8F93\\u5165\\u65B0\\u4E16\\u754C\\u4E66\\u7684\\u540D\\u79F0:\",value:f})}catch{return}if(x=x.trim(),!x)return;if(t.allLorebooks.some(M=>M.name===x))return await q({type:\"alert\",title:\"\\u9519\\u8BEF\",text:\"\\u5DF2\\u5B58\\u5728\\u540C\\u540D\\u4E16\\u754C\\u4E66\\u3002\"}),u(s,x);let A=s?r(s.currentTarget):null;A&&A.prop(\"disabled\",!0).addClass(\"rlh-loading\");try{await Y.createWorldbook(x)?(t.allLorebooks.push({name:x,enabled:!1,entryCount:0,enabledEntryCount:0,entriesLoaded:!0}),await n(x)):await q({type:\"alert\",title:\"\\u521B\\u5EFA\\u5931\\u8D25\",text:\"\\u521B\\u5EFA\\u4E16\\u754C\\u4E66\\u65F6\\u53D1\\u751F\\u9519\\u8BEF\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"})}finally{A&&A.prop(\"disabled\",!1).removeClass(\"rlh-loading\")}}),p=I(async s=>{s.stopPropagation();let x=r(s.currentTarget).closest(\".rlh-book-group, .rlh-detail-view\"),A=x.data(\"book-name\")||t.activeBookName;if(!A)return;let M=x.hasClass(\"rlh-detail-view\");try{await q({type:\"confirm\",title:\"\\u786E\\u8BA4\\u5220\\u9664\",text:`\\u60A8\\u786E\\u5B9A\\u8981\\u6C38\\u4E45\\u5220\\u9664\\u4E16\\u754C\\u4E66 \"${A}\" \\u5417\\uFF1F\\u6B64\\u64CD\\u4F5C\\u65E0\\u6CD5\\u64A4\\u9500\\u3002`})}catch{return}await Y.deleteWorldbook(A)?(t.allLorebooks=t.allLorebooks.filter(K=>K.name!==A),Nr(A),t.lorebookUsage instanceof Map&&t.lorebookUsage.has(A)&&t.lorebookUsage.delete(A),Array.isArray(t.lorebooks?.character)&&(t.lorebooks.character=t.lorebooks.character.filter(K=>K!==A)),t.chatLorebook===A&&(t.chatLorebook=null),t.activeCharacterBook===A&&(t.activeCharacterBook=null),t.activeBookName===A&&(t.activeBookName=null),M?await i():oe(),he(\"\\u5220\\u9664\\u6210\\u529F\")):await q({type:\"alert\",title:\"\\u5220\\u9664\\u5931\\u8D25\",text:\"\\u5220\\u9664\\u4E16\\u754C\\u4E66\\u65F6\\u53D1\\u751F\\u9519\\u8BEF\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"})}),g=I(async s=>{let x=(r(s.currentTarget).data(\"book-name\")??\"\").toString().trim(),A=Ne(),L=[x,A?.activeBookName??\"\",t.activeBookName??\"\",t.activeCharacterBook??\"\",t.chatLorebook??\"\"].find(F=>typeof F==\"string\"&&F.trim().length>0)?.trim()??\"\";if(!L){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u6216\\u6253\\u5F00\\u4E00\\u4E2A\\u4E16\\u754C\\u4E66\\u3002\"});return}let K=[...ee(L)];if((!K||K.length===0)&&(await Ee(L),K=[...ee(L)]),!K||K.length===0){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BE5\\u4E16\\u754C\\u4E66\\u6CA1\\u6709\\u6761\\u76EE\\u53EF\\u64CD\\u4F5C\\u3002\"});return}try{await q({type:\"confirm\",title:\"\\u786E\\u8BA4\\u64CD\\u4F5C\",text:`\\u786E\\u5B9A\\u8981\\u4E3A \"${L}\" \\u4E2D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u5F00\\u542F\\u201C\\u9632\\u6B62\\u9012\\u5F52\\u201D\\u548C\\u201C\\u4E0D\\u53EF\\u88AB\\u9012\\u5F52\\u201D\\u5417\\uFF1F\\u6B64\\u64CD\\u4F5C\\u4F1A\\u963B\\u6B62\\u4E16\\u754C\\u4E66\\u6761\\u76EE\\u5F7C\\u6B64\\u89E6\\u53D1\\u3002`})}catch{return}let ne=K.map(F=>({uid:F.uid,prevent_recursion:!0,exclude_recursion:!0}));await Pe(L,ne),K.forEach(F=>{F.prevent_recursion=!0,F.exclude_recursion=!0,(!F.recursion||typeof F.recursion!=\"object\")&&(F.recursion={}),F.recursion.prevent_outgoing=!0,F.recursion.prevent_incoming=!0}),ne.forEach(F=>{let X=r(`#rlh-panel-content .rlh-item-container[data-book-name=\"${L}\"][data-id=\"${F.uid}\"] .rlh-collapsible-content:visible`,o);X.length&&(X.find(\".rlh-edit-prevent-recursion\").prop(\"checked\",!0),X.find(\".rlh-edit-exclude-recursion\").prop(\"checked\",!0))}),he(\"\\u5DF2\\u4E3A\\u6240\\u6709\\u6761\\u76EE\\u5F00\\u542F\\u201C\\u9632\\u6B62\\u9012\\u5F52\\u201D\\u548C\\u201C\\u4E0D\\u53EF\\u88AB\\u9012\\u5F52\\u201D\"),await a(L)}),v=I(async s=>{let x=(r(s.currentTarget).data(\"book-name\")??\"\").toString().trim(),A=Ne(),L=[x,A?.activeBookName??\"\",t.activeBookName??\"\",t.activeCharacterBook??\"\",t.chatLorebook??\"\"].find(X=>typeof X==\"string\"&&X.trim().length>0)?.trim()??\"\";if(!L){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u6216\\u6253\\u5F00\\u4E00\\u4E2A\\u4E16\\u754C\\u4E66\\u3002\"});return}let K=[...ee(L)];if((!K||K.length===0)&&(await Ee(L),K=[...ee(L)]),!K||K.length===0){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BE5\\u4E16\\u754C\\u4E66\\u6CA1\\u6709\\u6761\\u76EE\\u53EF\\u64CD\\u4F5C\\u3002\"});return}try{await q({type:\"confirm\",title:\"\\u786E\\u8BA4\\u64CD\\u4F5C\",text:`\\u786E\\u5B9A\\u8981\\u4E3A \"${L}\" \\u4E2D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u4FEE\\u590D\\u5173\\u952E\\u8BCD\\uFF08\\u5C06\\u4E2D\\u6587\\u9017\\u53F7\\u66FF\\u6362\\u4E3A\\u82F1\\u6587\\u9017\\u53F7\\uFF09\\u5417\\uFF1F`})}catch{return}let ne=0,F=K.map(X=>{let D=(X.keys||[]).join(\", \"),pe=D.replace(/，/g,\",\").replace(/,+/g,\",\").trim().split(\",\").map(de=>de.trim()).filter(Boolean),ae=pe.join(\", \");return D!==ae?(ne++,{uid:X.uid,keys:pe}):null}).filter(Boolean);F.length>0?(await Pe(L,F),F.forEach(X=>{let D=K.find(Z=>Z.uid===X.uid);D&&(D.keys=X.keys)}),F.forEach(X=>{let D=r(`#rlh-panel-content .rlh-item-container[data-book-name=\"${L}\"][data-id=\"${X.uid}\"] .rlh-collapsible-content:visible`,o);D.length&&D.find(\".rlh-edit-keys\").val(X.keys.join(\", \"))}),he(`\\u6210\\u529F\\u4FEE\\u590D\\u4E86 ${ne} \\u4E2A\\u6761\\u76EE\\u7684\\u5173\\u952E\\u8BCD`),await a(L)):await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u6240\\u6709\\u6761\\u76EE\\u7684\\u5173\\u952E\\u8BCD\\u683C\\u5F0F\\u90FD\\u6B63\\u786E\\uFF0C\\u65E0\\u9700\\u4FEE\\u590D\\u3002\"})}),E=I(async({bookName:s,positionValue:f})=>{let x=(f??\"\").toString().trim();if(!x)return;let A=Ne(),L=[s,A?.activeBookName??\"\",t.activeBookName??\"\",t.activeCharacterBook??\"\",t.chatLorebook??\"\"].find(re=>typeof re==\"string\"&&re.trim().length>0)?.trim()??\"\";if(!L){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u6216\\u6253\\u5F00\\u4E00\\u4E2A\\u4E16\\u754C\\u4E66\\u3002\"});return}let K=[...ee(L)];if(K.length||(await Ee(L),K=[...ee(L)]),!K.length){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BE5\\u4E16\\u754C\\u4E66\\u6CA1\\u6709\\u6761\\u76EE\\u53EF\\u64CD\\u4F5C\\u3002\"});return}let ne=t.multiSelectMode&&t.multiSelectTarget===\"entry\",F=K;if(ne){let re=`lore:${L}:`,d=new Set;if(t.selectedItems.forEach(y=>{if(typeof y!=\"string\"||!y.startsWith(re))return;let T=y.slice(re.length),N=Number(T);Number.isFinite(N)&&d.add(N)}),d.size===0){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u5DF2\\u5F00\\u542F\\u591A\\u9009\\uFF0C\\u8BF7\\u5148\\u52FE\\u9009\\u8981\\u7EDF\\u4E00\\u4F4D\\u7F6E\\u7684\\u6761\\u76EE\\u3002\"});return}if(F=K.filter(y=>d.has(Number(y?.uid))),!F.length){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u672A\\u80FD\\u5339\\u914D\\u5230\\u5DF2\\u9009\\u62E9\\u7684\\u6761\\u76EE\\uFF0C\\u8BF7\\u91CD\\u65B0\\u9009\\u62E9\\u540E\\u518D\\u8BD5\\u3002\"});return}}let X=Ke.position?.[x]??x,D=F.filter(re=>(re?.position??\"\").toString()!==x).map(re=>({uid:re.uid,position:x}));if(!D.length){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:`${ne?\"\\u6240\\u9009\\u6761\\u76EE\":\"\\u6240\\u6709\\u6761\\u76EE\"}\\u7684\\u4F4D\\u7F6E\\u5DF2\\u7ECF\\u662F\\u300C${X}\\u300D\\u3002`});return}try{let re=F.length,d=ne?\"\\u9009\\u4E2D\\u7684\\u6761\\u76EE\":`\"${L}\" \\u4E2D\\u7684\\u6761\\u76EE`;await q({type:\"confirm\",title:\"\\u786E\\u8BA4\\u64CD\\u4F5C\",text:`\\u786E\\u5B9A\\u8981\\u5C06 ${d}\\uFF08\\u5171 ${re} \\u4E2A\\uFF09\\u8BBE\\u7F6E\\u4E3A\\u300C${X}\\u300D\\u5417\\uFF1F`})}catch{return}await Pe(L,D);let Z=ee(L),pe=new Set(Z.map(re=>(re?.position??\"before_character_definition\").toString())),ae=pe.size===1?pe.values().next().value:null;D.forEach(re=>{let d=`#rlh-panel-content .rlh-item-container[data-book-name=\"${L}\"][data-id=\"${re.uid}\"]`,y=r(d,o);if(y.length){let T=y.find(\".rlh-edit-position\");T.length&&T.val(x).trigger(\"change\")}});let de=r(`#${Je}`,o);if(de.length){de.attr(\"data-book-name\",L);let re=r(`#${Ye}`,o);re.length&&(re.removeAttr(\"disabled\"),re.attr(\"data-book-name\",L)),de.find(\".rlh-position-option\").each(function(){let y=r(this),T=(y.data(\"position-value\")??\"\").toString(),N=ae&&T===ae;y.toggleClass(\"active\",N),y.attr(\"aria-selected\",N?\"true\":\"false\"),y.attr(\"data-book-name\",L)})}he(`\\u5DF2\\u66F4\\u65B0 ${D.length} \\u4E2A\\u6761\\u76EE\\u7684\\u4F4D\\u7F6E\\u4E3A\\u300C${X}\\u300D`),await a(L)}),w=I(async()=>{let s=await Y.getOrCreateChatWorldbook();s?(he(`\\u5DF2\\u521B\\u5EFA\\u5E76\\u7ED1\\u5B9A\\u804A\\u5929\\u4E16\\u754C\\u4E66: ${s}`),await ze(!0)):await q({type:\"alert\",title:\"\\u64CD\\u4F5C\\u5931\\u8D25\",text:\"\\u65E0\\u6CD5\\u521B\\u5EFA\\u6216\\u7ED1\\u5B9A\\u804A\\u5929\\u4E16\\u754C\\u4E66\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"})}),k=I(async()=>{let s=t.chatLorebook;if(s){try{await q({type:\"confirm\",title:\"\\u786E\\u8BA4\\u89E3\\u9664\\u7ED1\\u5B9A\",text:`\\u60A8\\u786E\\u5B9A\\u8981\\u89E3\\u9664\\u4E0E\\u804A\\u5929\\u4E16\\u754C\\u4E66 \"${s}\" \\u7684\\u7ED1\\u5B9A\\u5417\\uFF1F\\u4E16\\u754C\\u4E66\\u672C\\u8EAB\\u4E0D\\u4F1A\\u88AB\\u5220\\u9664\\u3002`})}catch{return}await Y.rebindChatWorldbook(null),t.chatLorebook=null,he(\"\\u5DF2\\u89E3\\u9664\\u7ED1\\u5B9A\"),oe()}}),C=I(async()=>{let s=t.activeBookName;s&&(t.loadingBookName=s,oe(),await Ee(s,!0),t.loadingBookName=null,oe())});return{handleEnterLorebookDetail:n,handleExitLorebookDetail:i,handleRefreshLorebookDetail:C,handleCreateLorebook:u,handleDeleteLorebook:p,handleRenameBook:m,handleBatchSetRecursion:g,handleFixKeywords:v,applyUnifiedPosition:E,handleCreateChatLorebook:w,handleUnlinkChatLorebook:k}}function To(e={}){let r=e.$??ce(),o=e.parentDoc??fe(),l=d=>{let y=String(d),T=t.regexes.global.find(N=>String(N.id)===y);return T||(t.regexes.character.find(N=>String(N.id)===y)??null)},a=(d,y,T)=>{if(!d||!y)return;let N=T;if(typeof N!=\"boolean\"&&(N=N??\"\"),y===\"min_depth\"||y===\"max_depth\"){let H=parseInt(N,10);N=Number.isNaN(H)?null:H}let B=y.split(\".\");if(B.length===1){d[B[0]]=N;return}let R=d;for(let H=0;H<B.length-1;H++){let j=B[H];(!R[j]||typeof R[j]!=\"object\")&&(R[j]={}),R=R[j]}R[B[B.length-1]]=N},n=ft(()=>ar({silent:!0}),1e3),i=I(async d=>{let y=r(d.currentTarget),T=y.closest(\".rlh-item-container\"),N=T.data(\"type\"),B=T.data(\"id\"),R=Number(B),H=y.data(\"field\");if(H){if(N===\"lore\"){let j=T.data(\"book-name\"),W=ee(j).find(ue=>{let xe=ue?.uid;return typeof xe==\"number\"&&!Number.isNaN(R)?xe===R:String(xe)===String(B)});if(!W)return;let te;if(y.is(\":checkbox\"))te=y.is(\":checked\");else if(y.is('[contenteditable=\"true\"]')){let ue=y.get(0);if(ue){let xe=new Set([\"div\",\"p\",\"li\",\"ul\",\"ol\",\"blockquote\",\"pre\",\"h1\",\"h2\",\"h3\",\"h4\",\"h5\",\"h6\",\"table\",\"tr\"]),Oe=[],ir=ve=>{ve&&Oe.push(ve)},De=()=>{if(!Oe.length){Oe.push(`\n`);return}Oe[Oe.length-1]?.endsWith(`\n`)||Oe.push(`\n`)},Le=ve=>{if(!ve)return;let Fe=ve.nodeType;if(Fe===Node.TEXT_NODE){ir(ve.nodeValue||\"\");return}if(Fe!==Node.ELEMENT_NODE)return;let we=ve.nodeName.toLowerCase();if(we===\"br\"){Oe.push(`\n`);return}we===\"style\"||we===\"script\"||(ve.childNodes.forEach(br=>Le(br)),xe.has(we)&&De())};Le(ue),te=Oe.join(\"\"),te=te.replace(/\\u00a0/g,\" \"),te=te.replace(/\\r?\\n/g,`\n`)}else te=\"\"}else te=y.val();if(H===\"statusId\"){let ue=Ge(te)??Ce;W.statusId=ue.id,(!W.strategy||typeof W.strategy!=\"object\")&&(W.strategy={}),W.strategy.type=ue.strategyType,W.type=ue.strategyType,Tt(j,W.uid??B,{statusId:ue.id,strategy:{...W.strategy??{},type:ue.strategyType},type:ue.strategyType}),Qr(j,W.uid??B,ue.id),n();return}if(H===\"keys\")W.keys=te.split(\",\").map(ue=>ue.trim()).filter(Boolean);else if([\"depth\",\"order\",\"probability\"].includes(H)){let ue=parseInt(te,10);W[H]=isNaN(ue)?y.attr(\"placeholder\")===\"\\u4F8B\\u5982: 0\"?null:100:ue}else W[H]=te;let be=Array.isArray(W[H])?[...W[H]]:W[H];Tt(j,W.uid??B,{[H]:be})}else if(N===\"regex\"){let j=l(B);if(!j)return;let J;y.is(\":checkbox\")?J=y.is(\":checked\"):J=y.val(),a(j,H,J),xo(j.id)}n()}}),b=d=>{let y=Object.entries(Ke.position).map(([J,W])=>`<option value=\"${J}\" ${d.position===J?\"selected\":\"\"}>${W}</option>`).join(\"\"),T=Object.entries(Ke.logic).map(([J,W])=>`<option value=\"${J}\" ${d.logic===J?\"selected\":\"\"}>${W}</option>`).join(\"\"),N=Array.isArray(d.keys)?d.keys.join(\", \"):\"\",B=d.content||\"\",R=d.statusId??Ce.id;d.statusId=R;let H=Ge(R)??Ce;return(!d.strategy||typeof d.strategy!=\"object\")&&(d.strategy={}),d.strategy.type=H.strategyType,d.type=H.strategyType,`\n      <div class=\"rlh-editor-wrapper\" data-mode=\"edit\">\n        <div class=\"rlh-editor-group\"><h5>\\u72B6\\u6001</h5>\n          <div class=\"rlh-editor-grid\">\n            <div class=\"rlh-grid-item\"><label>\\u6FC0\\u6D3B\\u72B6\\u6001</label><select class=\"rlh-edit-status rlh-select-nudge\" data-field=\"statusId\">${Wr.map(J=>{let W=R===J.id?\"selected\":\"\";return`<option value=\"${J.id}\" ${W}>${J.label}</option>`}).join(\"\")}</select></div>\n          </div>\n        </div>\n        <div class=\"rlh-editor-field\">\n          <label>\\u5173\\u952E\\u8BCD (\\u9017\\u53F7\\u5206\\u9694)</label>\n          <input type=\"text\" class=\"rlh-edit-keys\" data-field=\"keys\" value=\"${O(N)}\">\n        </div>\n        <div class=\"rlh-editor-field\">\n          <label>\\u5185\\u5BB9</label>\n          <div class=\"rlh-edit-content\" data-field=\"content\" contenteditable=\"true\">${O(B)}</div>\n        </div>\n        <div class=\"rlh-editor-group\"><h5>\\u63D2\\u5165\\u89C4\\u5219</h5>\n          <div class=\"rlh-editor-grid\">\n            <div class=\"rlh-grid-item\"><label>\\u4F4D\\u7F6E</label><select class=\"rlh-edit-position rlh-select-nudge\" data-field=\"position\">${y}</select></div>\n            <div class=\"rlh-grid-item rlh-depth-container\"><label>\\u6DF1\\u5EA6</label><input type=\"number\" class=\"rlh-edit-depth\" data-field=\"depth\" placeholder=\"\\u4F8B\\u5982: 0\" value=\"${d.depth??\"\"}\"></div>\n            <div class=\"rlh-grid-item\"><label>\\u987A\\u5E8F</label><input type=\"number\" class=\"rlh-edit-order\" data-field=\"order\" placeholder=\"\\u4F8B\\u5982: 100\" value=\"${d.order??\"\"}\"></div>\n          </div>\n        </div>\n        <div class=\"rlh-editor-group\"><h5>\\u6FC0\\u6D3B\\u903B\\u8F91</h5>\n          <div class=\"rlh-editor-grid\">\n            <div class=\"rlh-grid-item\"><label>\\u6982\\u7387 (%)</label><input type=\"number\" class=\"rlh-edit-probability\" data-field=\"probability\" min=\"0\" max=\"100\" placeholder=\"100\" value=\"${d.probability??\"\"}\"></div>\n            <div class=\"rlh-grid-item\"><label>\\u5173\\u952E\\u8BCD\\u903B\\u8F91</label><select class=\"rlh-edit-logic rlh-select-nudge\" data-field=\"logic\">${T}</select></div>\n          </div>\n        </div>\n        <div class=\"rlh-editor-group\"><h5>\\u5339\\u914D\\u4E0E\\u9012\\u5F52</h5>\n          <div class=\"rlh-editor-options-row\">\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-case-sensitive\" data-field=\"case_sensitive\" ${d.case_sensitive?\"checked\":\"\"}> \\u5927\\u5C0F\\u5199\\u654F\\u611F</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-match-whole\" data-field=\"match_whole_words\" ${d.match_whole_words?\"checked\":\"\"}> \\u5168\\u8BCD\\u5339\\u914D</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-prevent-recursion\" data-field=\"prevent_recursion\" ${d.prevent_recursion?\"checked\":\"\"}> \\u9632\\u6B62\\u9012\\u5F52</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-exclude-recursion\" data-field=\"exclude_recursion\" ${d.exclude_recursion?\"checked\":\"\"}> \\u4E0D\\u53EF\\u88AB\\u9012\\u5F52</label>\n          </div>\n        </div>\n      </div>\n    `},m=d=>{let y=d?.destination??{},T=d?.source??{},N=O(d?.find_regex??\"\"),B=O(d?.replace_string??\"\"),R=O(String(d?.min_depth??\"\")),H=O(String(d?.max_depth??\"\"));return`\n      <div class=\"rlh-editor-wrapper\" data-mode=\"edit\">\n        <div class=\"rlh-editor-field\">\n          <label>\\u67E5\\u627E\\u6B63\\u5219\\u8868\\u8FBE\\u5F0F</label>\n          <textarea class=\"rlh-edit-find\" data-field=\"find_regex\">${N}</textarea>\n        </div>\n        <div class=\"rlh-editor-field\">\n          <label>\\u66FF\\u6362\\u4E3A</label>\n          <textarea class=\"rlh-edit-replace\" data-field=\"replace_string\">${B}</textarea>\n        </div>\n        <div class=\"rlh-editor-group\">\n          <h5>\\u77ED\\u6682</h5>\n          <div class=\"rlh-editor-options-row\">\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-dest-display\" data-field=\"destination.display\" ${y.display?\"checked\":\"\"}> \\u4EC5\\u683C\\u5F0F\\u663E\\u793A</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-dest-prompt\" data-field=\"destination.prompt\" ${y.prompt?\"checked\":\"\"}> \\u4EC5\\u683C\\u5F0F\\u63D0\\u793A\\u8BCD</label>\n          </div>\n        </div>\n        <div class=\"rlh-editor-group\">\n          <h5>\\u4F5C\\u7528\\u8303\\u56F4</h5>\n          <div class=\"rlh-editor-options-row\">\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-user\" data-field=\"source.user_input\" ${T.user_input?\"checked\":\"\"}> \\u7528\\u6237\\u8F93\\u5165</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-ai\" data-field=\"source.ai_output\" ${T.ai_output?\"checked\":\"\"}> AI\\u8F93\\u51FA</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-slash\" data-field=\"source.slash_command\" ${T.slash_command?\"checked\":\"\"}> \\u659C\\u6760\\u547D\\u4EE4</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-world\" data-field=\"source.world_info\" ${T.world_info?\"checked\":\"\"}> \\u4E16\\u754C\\u4E66</label>\n          </div>\n        </div>\n        <div class=\"rlh-editor-group\">\n          <h5>\\u6DF1\\u5EA6</h5>\n          <div class=\"rlh-depth-inputs\">\n            <input type=\"number\" class=\"rlh-edit-depth-min\" data-field=\"min_depth\" placeholder=\"\\u6700\\u5C0F\\u6DF1\\u5EA6\" value=\"${R}\">\n            <input type=\"number\" class=\"rlh-edit-depth-max\" data-field=\"max_depth\" placeholder=\"\\u6700\\u5927\\u6DF1\\u5EA6\" value=\"${H}\">\n          </div>\n        </div>\n      </div>\n    `},u=(d,y)=>{let T=d.find(\".rlh-rename-btn\").first();if(!T.length)return;let N=T.find(\"i\").first();y===\"edit\"?(T.attr(\"title\",\"\\u9000\\u51FA\\u7F16\\u8F91\\u6A21\\u5F0F\"),T.attr(\"data-rename-mode\",\"exit\"),N.length&&N.removeClass(\"fa-pencil\").addClass(\"fa-eye\")):(T.attr(\"title\",\"\\u91CD\\u547D\\u540D\\u5E76\\u7F16\\u8F91\"),T.attr(\"data-rename-mode\",\"rename\"),N.length&&N.removeClass(\"fa-eye\").addClass(\"fa-pencil\"))},p=d=>{d.on(\"input.rlh change.rlh\",'input, textarea, select, [contenteditable=\"true\"]',i),d.find(\".rlh-edit-position\").trigger(\"change\")},g=(d,y,T,{animate:N=!0,searchTerm:B}={})=>{let R=y.find(\".rlh-collapsible-content\").first();if(!R.length)return;let H=d===\"view\",j=typeof B==\"string\"?B:y.data(\"searchTerm\")||\"\",J=H?Xr(T,j):b(T);H&&(y.data(\"searchTerm\",j),y.attr(\"data-search-term\",j)),R.stop(!0,!0),R.off(\"input.rlh change.rlh\"),R.html(J),y.attr(\"data-entry-mode\",d),R.attr(\"data-entry-mode\",d),y.toggleClass(\"rlh-editing\",!H),u(y,d);let W=y.find(\".rlh-item-name\").first();W.length&&(H?W.show().removeAttr(\"aria-hidden\"):W.hide().attr(\"aria-hidden\",\"true\"));let te=()=>{H||p(R)},be=ue=>{let xe=R[0];if(!xe){ue();return}let Oe=280,ir=we=>we<.5?2*we*we:-1+(4-2*we)*we;xe.style.display=\"block\",xe.style.overflow=\"hidden\";let De=0,Le=xe.scrollHeight;xe.style.height=`${De}px`,xe.style.opacity=\"0\";let ve=null,Fe=we=>{ve||(ve=we);let br=Math.min((we-ve)/Oe,1),Ur=ir(br),at=De+(Le-De)*Ur;xe.style.height=`${at}px`,xe.style.opacity=String(.6+.4*Ur),br<1?requestAnimationFrame(Fe):(xe.style.height=\"\",xe.style.opacity=\"\",xe.style.overflow=\"\",ue())};requestAnimationFrame(Fe)};R.is(\":visible\")?te():N?be(te):(R.show(),te())},v=(d,y,T,N={})=>{g(\"view\",d,y,{...N,searchTerm:T})},E=(d,y,T={})=>{g(\"edit\",d,y,T)},w=(d,y,T,{animate:N=!0}={})=>{let B=d.find(\".rlh-collapsible-content\").first();if(!B.length)return;let R=typeof T==\"string\"?T:\"\";d.data(\"searchTerm\",R),d.attr(\"data-search-term\",R);let H=gt(y,R);B.stop(!0,!0),B.off(\"input.rlh change.rlh\"),B.html(H),d.attr(\"data-entry-mode\",\"view\"),B.attr(\"data-entry-mode\",\"view\"),d.removeClass(\"rlh-editing\"),u(d,\"view\");let j=d.find(\".rlh-item-name\").first();j.length&&j.show().removeAttr(\"aria-hidden\"),B.is(\":visible\")||(N?B.slideDown(200):B.show())},k=(d,y,{animate:T=!0}={})=>{let N=d.find(\".rlh-collapsible-content\").first();if(!N.length)return;let B=m(y);N.stop(!0,!0),N.off(\"input.rlh change.rlh\");let R=()=>{N.on(\"input.rlh change.rlh\",'input, textarea, select, [contenteditable=\"true\"]',i)};N.html(B),d.attr(\"data-entry-mode\",\"edit\"),N.attr(\"data-entry-mode\",\"edit\"),d.addClass(\"rlh-editing\"),u(d,\"edit\");let H=d.find(\".rlh-item-name\").first();H.length&&H.hide().attr(\"aria-hidden\",\"true\"),N.is(\":visible\")?R():T?N.slideDown(200,R):(N.show(),R())},C=(d,y={})=>{let{animate:T=!1,silent:N=!1}=y;if(!d.length)return!1;if(t.multiSelectMode)return N||he(\"\\u8BF7\\u5148\\u9000\\u51FA\\u591A\\u9009\\u6A21\\u5F0F\\u540E\\u518D\\u7F16\\u8F91\\u3002\",\"info\"),!1;let B=d.data(\"book-name\"),R=Number(d.data(\"id\"));if(!B||Number.isNaN(R))return!1;let H=ee(B).find(j=>j.uid===R);return H?(E(d,H,{animate:T}),!0):!1},s=(d,y={})=>{let{animate:T=!1}=y;if(!d.length)return!1;let N=d.data(\"book-name\"),B=Number(d.data(\"id\"));if(!N||Number.isNaN(B))return!1;let R=ee(N).find(j=>j.uid===B);if(!R)return!1;let H=d.data(\"searchTerm\")||\"\";return v(d,R,H,{animate:T}),!0},f=(d,y={})=>{let{animate:T=!1,silent:N=!1}=y;if(!d.length)return!1;if(t.multiSelectMode)return N||he(\"\\u8BF7\\u5148\\u9000\\u51FA\\u591A\\u9009\\u6A21\\u5F0F\\u540E\\u518D\\u7F16\\u8F91\\u3002\",\"info\"),!1;let B=d.data(\"id\"),R=l(B);return R?(k(d,R,{animate:T}),!0):!1},x=(d,y={})=>{let{animate:T=!1}=y;if(!d.length)return!1;let N=d.data(\"id\"),B=l(N);if(!B)return!1;let R=d.data(\"searchTerm\")||\"\";return w(d,B,R,{animate:T}),!0},A=I(async d=>{d.preventDefault(),d.stopPropagation();let y=r(d.currentTarget).closest(\".rlh-item-container\");C(y,{animate:!1})}),M=I(async d=>{d.preventDefault(),d.stopPropagation();let y=r(d.currentTarget).closest(\".rlh-item-container\");s(y,{animate:!1})}),L=I(async d=>{d.preventDefault(),d.stopPropagation();let y=r(d.currentTarget).closest(\".rlh-item-container\");f(y,{animate:!1})}),K=I(async d=>{d.preventDefault(),d.stopPropagation();let y=r(d.currentTarget).closest(\".rlh-item-container\");x(y,{animate:!1})}),ne=I(async d=>{d.stopPropagation();let y=r(d.currentTarget),T=y.closest(\".rlh-book-group, .rlh-item-container\");if(T.hasClass(\"renaming\"))return;let N=!T.hasClass(\"enabled\"),B=T.parent();if(y.hasClass(\"rlh-global-toggle\")){y.addClass(\"rlh-loading\");try{let H=T.data(\"book-name\"),j=new Set(await Y.getGlobalWorldbookNames()||[]);N?j.add(H):j.delete(H),await Y.rebindGlobalWorldbooks(Array.from(j)),await Y.saveSettings();let J=t.allLorebooks.find(W=>W.name===H);J&&(J.enabled=N)}finally{y.removeClass(\"rlh-loading\")}}else{let H=T.data(\"type\"),j=T.data(\"id\");if(H===\"lore\"){let J=T.data(\"book-name\");await Pe(J,[{uid:Number(j),enabled:N}]);let W=ee(J).find(te=>te.uid===Number(j));W&&(W.enabled=N)}else{let J=await Y.getRegexes(),W=J.find(te=>te.id===j);if(W){W.enabled=N,await Y.replaceRegexes(J.filter(be=>be.source!==\"card\")),await Y.saveSettings();let te=t.regexes.global.find(be=>be.id===j)||t.regexes.character.find(be=>be.id===j);te&&(te.enabled=N)}}}he(N?\"\\u5DF2\\u542F\\u7528\":\"\\u5DF2\\u7981\\u7528\"),T.toggleClass(\"enabled\",N);let R=B.children().get();R.sort((H,j)=>{let J=r(H).hasClass(\"enabled\"),W=r(j).hasClass(\"enabled\");if(J!==W)return W-J;let te=r(H).find(\".rlh-item-name\").text().trim(),be=r(j).find(\".rlh-item-name\").text().trim();return te.localeCompare(be)}),B.append(R)}),F=I(async d=>{d.stopPropagation();let T=r(d.currentTarget).closest(\".rlh-item-container\");if(!T.length)return;let N=T.data(\"type\");if(T.attr(\"data-entry-mode\")===\"edit\"){X(T),N===\"lore\"?s(T,{animate:!1}):x(T,{animate:!1});return}if(t.multiSelectMode){he(\"\\u8BF7\\u5148\\u9000\\u51FA\\u591A\\u9009\\u6A21\\u5F0F\\u540E\\u518D\\u7F16\\u8F91\\u3002\",\"info\");return}let R=T.find(\".rlh-item-header\").first(),j=R.find(\".rlh-item-name\").first().clone().children().remove().end().text().trim(),J=`<div class=\"rlh-rename-ui\"><div class=\"rlh-rename-input-wrapper\"><input type=\"text\" class=\"rlh-rename-input\" value=\"${O(j)}\" /><button class=\"rlh-action-btn-icon rlh-rename-save-btn\" title=\"\\u786E\\u8BA4\"><i class=\"fa-solid fa-check\"></i></button></div></div>`,W=!1;N===\"lore\"?W=C(T,{animate:!1,silent:!0}):W=f(T,{animate:!1,silent:!0}),W&&(R.find(\".rlh-rename-ui\").length||(T.addClass(\"renaming\"),R.append(J)),R.find(\".rlh-rename-input\").focus().select())}),X=(d,y=null)=>{let T=d.find(\".rlh-item-header\").first(),N=T.find(\".rlh-item-name\").first();y&&N.text(y),T.find(\".rlh-rename-ui\").remove(),N.length&&d.attr(\"data-entry-mode\")!==\"edit\"&&N.show().removeAttr(\"aria-hidden\"),d.removeClass(\"renaming\")},D=I(async d=>{d.stopPropagation();let y=r(d.currentTarget).closest(\".rlh-item-container\"),T=y.data(\"type\"),N=()=>{T===\"lore\"?s(y,{animate:!1}):x(y,{animate:!1})},R=y.find(\".rlh-rename-input\").val().trim(),H=y.find(\".rlh-item-name\").first().text().trim();if(!R||R===H){X(y,H),N();return}let j=y.data(\"id\");if(T===\"lore\"){let J=y.data(\"book-name\");await Pe(J,[{uid:Number(j),name:R}]);let te=[...ee(J)].find(be=>be.uid===Number(j));te&&(te.name=R)}else{let J=await Y.getRegexes(),W=J.find(te=>te.id===j);if(W){W.script_name=R,await Y.replaceRegexes(J.filter(be=>be.source!==\"card\")),await Y.saveSettings();let te=t.regexes.global.find(be=>be.id===j)||t.regexes.character.find(be=>be.id===j);te&&(te.script_name=R)}}X(y,R),N(),he(\"\\u91CD\\u547D\\u540D\\u6210\\u529F\")}),Z=I(async d=>{if(d.key===\"Enter\")r(d.currentTarget).siblings(\".rlh-rename-save-btn\").click();else if(d.key===\"Escape\"){d.preventDefault();let y=r(d.currentTarget).closest(\".rlh-item-container\");X(y)}}),pe=I(async d=>{d.stopPropagation();let y=r(d.currentTarget),N=y.closest(\".rlh-editor-wrapper\").find(\"textarea, .rlh-edit-content\");y.find(\"i\").hasClass(\"fa-expand\")?(y.attr(\"title\",\"\\u6536\\u7F29\").find(\"i\").removeClass(\"fa-expand\").addClass(\"fa-compress\"),N.each(function(){this.style.height=\"auto\",this.style.height=this.scrollHeight+\"px\"})):(y.attr(\"title\",\"\\u5C55\\u5F00\").find(\"i\").removeClass(\"fa-compress\").addClass(\"fa-expand\"),N.css(\"height\",\"\"))}),ae=ft(I(async d=>{let T=r(d.currentTarget).data(\"book-name\"),B=Ne().activeBookName??t.activeBookName??t.activeCharacterBook??t.chatLorebook??\"\",R=T||B;if(!R){await q({type:\"alert\",title:\"\\u521B\\u5EFA\\u5931\\u8D25\",text:\"\\u5F53\\u524D\\u6CA1\\u6709\\u9009\\u4E2D\\u7684\\u4E16\\u754C\\u4E66\\uFF0C\\u65E0\\u6CD5\\u521B\\u5EFA\\u6761\\u76EE\\u3002\"});return}let H=$o(R),j=ro(H,R);if(j&&j.length){let J=j.find(\".rlh-rename-btn\");J.length&&J.trigger(\"click\")}try{let J=await Y.createWorldbookEntries(R,[{name:H.name,enabled:H.enabled,keys:H.keys}]);if(J&&J.new_entries&&J.new_entries.length>0){Re(R,J.worldbook.map(Ze));let W=J.new_entries[0];if(W){Eo(R,H.uid,W);let te=r(`#rlh-panel .rlh-item-container[data-id=\"${H.uid}\"]`,o);te.length&&(te.attr(\"data-id\",W.uid),te.data(\"id\",W.uid))}ur(R),he(\"\\u65B0\\u6761\\u76EE\\u5DF2\\u521B\\u5EFA\")}else throw new Error(\"API\\u8FD4\\u56DE\\u6570\\u636E\\u683C\\u5F0F\\u4E0D\\u6B63\\u786E\")}catch(J){console.error(\"[RegexLoreHub] Create entry failed:\",J),q({type:\"alert\",title:\"\\u521B\\u5EFA\\u5931\\u8D25\",text:`\\u521B\\u5EFA\\u65B0\\u6761\\u76EE\\u65F6\\u53D1\\u751F\\u9519\\u8BEF\\uFF0C\\u4F46\\u60A8\\u4ECD\\u53EF\\u7F16\\u8F91\\u5F53\\u524D\\u5185\\u5BB9\\u5E76\\u624B\\u52A8\\u4FDD\\u5B58\\u3002\\u9519\\u8BEF: ${J.message}`})}}),300),de=I(async d=>{d.stopPropagation();let y=r(d.currentTarget).closest(\".rlh-item-container\"),T=y.data(\"book-name\"),N=Number(y.data(\"id\")),B=y.find(\".rlh-item-name\").text().trim();try{await q({type:\"confirm\",title:\"\\u786E\\u8BA4\\u5220\\u9664\",text:`\\u60A8\\u786E\\u5B9A\\u8981\\u5220\\u9664\\u6761\\u76EE \"${B}\" \\u5417\\uFF1F`})}catch{return}let R=await Y.deleteWorldbookEntries(T,[N]);R&&R.deleted_entries&&R.deleted_entries.length>0?(Re(T,R.worldbook.map(Ze)),ur(T),y.slideUp(300,()=>y.remove()),he(\"\\u5220\\u9664\\u6210\\u529F\")):await q({type:\"alert\",title:\"\\u5220\\u9664\\u5931\\u8D25\",text:\"\\u5220\\u9664\\u6761\\u76EE\\u65F6\\u53D1\\u751F\\u9519\\u8BEF\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"})}),re=I(async d=>{let y=r(d.currentTarget),T=y.closest(\".rlh-editor-grid\").find(\".rlh-depth-container\");y.val().startsWith(\"at_depth\")?T.slideDown(200):T.slideUp(200)});return{handleToggleState:ne,handleEditorInput:i,renderLoreEntryViewer:v,renderLoreEntryEditor:E,renderRegexViewer:w,renderRegexEditor:k,handleEntryEnterEdit:A,handleEntryExitEdit:M,handleRegexEnterEdit:L,handleRegexExitEdit:K,handleRename:F,handleConfirmRename:D,handleRenameKeydown:Z,handleEditorExpandToggle:pe,handleCreateEntry:ae,handleDeleteEntry:de,handlePositionChange:re}}var Tl=(e,r,o,l,a,n)=>{let i=to(e,r,o,l,a,n);return q({type:\"confirm\",title:\"\\u786E\\u8BA4\\u66FF\\u6362\",html:i})},Co=I(async e=>{let r=ce(),o=fe(),l=r(`#${me}`,o);if(!l.length)return;let a=l.find(`#${We.TOOLBAR_SHELL}`);if(a.length||(a=l.find(\".rlh-toolbar-shell\").first(),a.length&&a.attr(\"id\",We.TOOLBAR_SHELL)),!a.length)return;let n=!a.hasClass(\"rlh-toolbar-shell--collapsed\");e?.preventDefault?.(),e?.stopPropagation?.(),a.toggleClass(\"rlh-toolbar-shell--collapsed\",n),a.attr(\"aria-hidden\",String(n)),t.isToolbarCollapsed=n;let i=e?.currentTarget?r(e.currentTarget):l.find(`#${We.TOGGLE_TOOLBAR_BTN}`);i.length&&(i.text(n?\"\\u5C55\\u5F00\\u5DE5\\u5177\\u680F\":\"\\u6298\\u53E0\\u5DE5\\u5177\\u680F\"),i.attr(\"aria-expanded\",String(!n)),i.attr(\"title\",n?\"\\u5C55\\u5F00\\u5DE5\\u5177\\u680F\":\"\\u6298\\u53E0\\u5DE5\\u5177\\u680F\"))});function No(e={}){let r=e.$??ce(),o=e.parentDoc??fe(),l=e.lorebookHandlers,a=e.itemHandlers,n=()=>{switch(t.multiSelectTarget){case\"book\":return\"book:\";case\"entry\":return\"lore:\";case\"regex\":return\"regex:\";default:return\"\"}},i=c=>{let h=String(c??\"\"),S=h.indexOf(\":\");if(S===-1)return{type:h,raw:\"\"};let _=h.slice(0,S),G=h.slice(S+1);if(_===\"book\")return{type:_,bookName:G};if(_===\"lore\"){let z=G.lastIndexOf(\":\");return z===-1?{type:_,bookName:G,entryId:null}:{type:_,bookName:G.slice(0,z),entryId:G.slice(z+1)}}return _===\"regex\"?{type:_,regexId:G}:{type:_,raw:G}},b=()=>({$menu:r(`#${xr}`,o),$button:r(`#${tr}`,o)}),m=()=>{let c=new Map;for(let h of t.selectedItems){let{type:S,bookName:_,entryId:G}=i(h);if(S===\"lore\"&&_){let z=Number(G),P=Number.isFinite(z)?z:G;if(P==null||P===\"\")continue;c.has(_)||c.set(_,[]),c.get(_).push(P)}}return c},u=!1;function p(){let{$menu:c,$button:h}=b();c.length&&c.attr(\"data-open\",\"false\"),h.length&&h.attr(\"aria-expanded\",\"false\"),u&&(r(o).off(\"click.rlhUnifiedStatus\",g),u=!1)}function g(c){let{$menu:h,$button:S}=b();if(!h.length)return;let _=r(c.target);_.closest(`#${xr}`).length||S.length&&_.closest(`#${tr}`).length||p()}function v(){let{$menu:c,$button:h}=b();!c.length||!h.length||(c.attr(\"data-open\",\"true\"),h.attr(\"aria-expanded\",\"true\"),u||(r(o).on(\"click.rlhUnifiedStatus\",g),u=!0))}let E=()=>{let{$menu:c,$button:h}=b();if(!h.length)return;let S=Ne();if(!(S?.type===\"lore\")){h.attr(\"disabled\",\"disabled\").attr(\"title\",\"\\u7EDF\\u4E00\\u72B6\\u6001\\u4EC5\\u5728\\u6761\\u76EE\\u89C6\\u56FE\\u53EF\\u7528\"),c.length&&c.attr(\"data-open\")===\"true\"&&p();return}let z=[S?.activeBookName,t.activeBookName,t.activeCharacterBook,t.chatLorebook].find(Se=>typeof Se==\"string\"&&Se.trim().length>0)?.toString().trim()??\"\",P=m();!z&&P.size===1&&(z=[...P.keys()][0]??\"\");let V=(z?ee(z):[]).length>0,Q=t.multiSelectMode&&t.multiSelectTarget===\"entry\",ie=0;P.forEach(Se=>{Array.isArray(Se)&&(ie+=Se.length)});let se=Q?ie>0:V,le;Q?le=ie>0?`\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u5C06\\u5BF9\\u5DF2\\u9009\\u4E2D\\u7684 ${ie} \\u4E2A\\u6761\\u76EE\\u7EDF\\u4E00\\u72B6\\u6001`:\"\\u5DF2\\u5F00\\u542F\\u591A\\u9009\\uFF0C\\u8BF7\\u5148\\u52FE\\u9009\\u8981\\u8C03\\u6574\\u72B6\\u6001\\u7684\\u6761\\u76EE\":V?le=`\\u5C06\\u5BF9\\u300C${z||\"\\u5F53\\u524D\\u4E16\\u754C\\u4E66\"}\\u300D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u7EDF\\u4E00\\u72B6\\u6001`:le=z?`\\u300C${z}\\u300D\\u6682\\u65E0\\u6761\\u76EE\\u53EF\\u8C03\\u6574`:\"\\u8BF7\\u5148\\u6253\\u5F00\\u9700\\u8981\\u7EDF\\u4E00\\u72B6\\u6001\\u7684\\u4E16\\u754C\\u4E66\",h.attr(\"title\",le),se?h.removeAttr(\"disabled\"):(h.attr(\"disabled\",\"disabled\"),c.length&&c.attr(\"data-open\")===\"true\"&&p())},w=()=>{let{$menu:c,$button:h}=R();if(!h.length)return;let G=[Ne()?.activeBookName,t.activeBookName,t.activeCharacterBook,t.chatLorebook].find(le=>typeof le==\"string\"&&le.trim().length>0)?.toString().trim()??\"\",z=m();!G&&z.size===1&&(G=[...z.keys()][0]??\"\");let U=(G?ee(G):[]).length>0,V=t.multiSelectMode&&t.multiSelectTarget===\"entry\",Q=0;z.forEach(le=>{Array.isArray(le)&&(Q+=le.length)});let ie=V?Q>0:U,se;V?se=Q>0?`\\u591A\\u9009\\u6A21\\u5F0F\\uFF1A\\u5C06\\u5BF9\\u5DF2\\u9009\\u4E2D\\u7684 ${Q} \\u4E2A\\u6761\\u76EE\\u7EDF\\u4E00\\u4F4D\\u7F6E`:\"\\u5DF2\\u5F00\\u542F\\u591A\\u9009\\uFF0C\\u8BF7\\u5148\\u52FE\\u9009\\u8981\\u8C03\\u6574\\u4F4D\\u7F6E\\u7684\\u6761\\u76EE\":U?se=`\\u5C06\\u5BF9\\u300C${G||\"\\u5F53\\u524D\\u4E16\\u754C\\u4E66\"}\\u300D\\u7684\\u6240\\u6709\\u6761\\u76EE\\u7EDF\\u4E00\\u4F4D\\u7F6E`:se=G?`\\u300C${G}\\u300D\\u6682\\u65E0\\u6761\\u76EE\\u53EF\\u8C03\\u6574`:\"\\u8BF7\\u5148\\u6253\\u5F00\\u9700\\u8981\\u7EDF\\u4E00\\u4F4D\\u7F6E\\u7684\\u4E16\\u754C\\u4E66\",h.attr(\"title\",se),ie?h.removeAttr(\"disabled\"):(h.attr(\"disabled\",\"disabled\"),c.length&&c.attr(\"data-open\",\"false\"))},k=()=>{Jr(),E(),w()},C=()=>{if(!t.multiSelectMode)return[];let c=r(`#${me}`,o);if(!c.length)return[];let h;switch(t.multiSelectTarget){case\"book\":h=\".rlh-book-group[data-select-key]\";break;case\"entry\":h='.rlh-item-container[data-select-key][data-type=\"lore\"]';break;case\"regex\":h='.rlh-item-container[data-select-key][data-type=\"regex\"]';break;default:h=\"[data-select-key]\";break}let S=[];return c.find(h).each((_,G)=>{let z=r(G);if(!z.is(\":visible\"))return;let P=z.data(\"select-key\");P&&S.push(String(P))}),S},s=()=>{if(!t.selectedItems||t.selectedItems.size===0)return!1;let c=n();if(!c)return t.selectedItems.size>0;for(let h of t.selectedItems)if(h.startsWith(c))return!0;return!1},f=c=>{if(!c||!c.length)return null;if(c.hasClass(\"rlh-book-group\")){if(t.multiSelectTarget!==\"book\")return null;let h=c.data(\"book-name\");return h?`book:${h}`:null}if(c.hasClass(\"rlh-item-container\")){let h=c.data(\"type\"),S=c.data(\"id\");if(h===\"lore\"&&t.multiSelectTarget===\"entry\"){let _=c.data(\"book-name\");return _!=null&&S!=null?`lore:${_}:${S}`:null}if(h===\"regex\"&&t.multiSelectTarget===\"regex\")return S!=null?`regex:${S}`:null}return null},x=c=>{let h=f(c);return h?(t.selectedItems.has(h)?(t.selectedItems.delete(h),c.removeClass(\"selected\"),c.find(\".rlh-multi-select-checkbox\").prop(\"checked\",!1)):(t.selectedItems.add(h),c.addClass(\"selected\"),c.find(\".rlh-multi-select-checkbox\").prop(\"checked\",!0)),k(),!0):!1},A=I(async c=>{let h=r(c.currentTarget),S=h.val();h.attr(\"id\")===\"rlh-global-search-input\"?t.globalSearch.term=S:h.attr(\"id\")===\"rlh-global-replace-input\"&&(t.globalSearch.replace=S),h.attr(\"id\")===\"rlh-global-search-input\"&&oe()}),M=I(async c=>{if(c.key===\"Enter\"){c.preventDefault();let h=c.currentTarget.value??\"\";t.globalSearch.term=h,oe()}}),L=(c=[])=>{let h=new Set;return c.forEach(S=>{if(typeof S!=\"string\")return;let _=S.trim();_&&h.add(_)}),Array.from(h)},K=async c=>{let h=L(c);if(!h.length)return!0;let S=h.filter(G=>{if(t.allLorebooks.find(U=>U.name===G)?.entriesLoaded)return!1;let P=ee(G);return!Array.isArray(P)||P.length===0});if(!S.length)return!0;let _=Qe(`\\u6B63\\u5728\\u52A0\\u8F7D ${S.length} \\u672C\\u4E16\\u754C\\u4E66\\u7684\\u6761\\u76EE...`);try{return await Promise.all(S.map(G=>Ee(G))),_.remove(),!0}catch(G){return _.remove(),console.error(\"[RegexLoreHub] Failed to load entries before replace:\",G),await q({type:\"alert\",title:\"\\u52A0\\u8F7D\\u5931\\u8D25\",text:\"\\u5728\\u6267\\u884C\\u66FF\\u6362\\u524D\\u52A0\\u8F7D\\u4E16\\u754C\\u4E66\\u6761\\u76EE\\u5931\\u8D25\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"}),!1}},ne=I(async()=>{let c=r(`#${er}`,o);c.length&&c.val(\"\"),t.globalSearch.term=\"\",oe()}),F=I(async()=>{let c=r(`#${er}`,o).val(),h=r(`#${mr}`,o).val(),S=Ne();if(!c){await q({type:\"alert\",title:\"\\u66FF\\u6362\\u5931\\u8D25\",text:\"\\u8BF7\\u5148\\u8F93\\u5165\\u641C\\u7D22\\u8BCD\\u3002\"});return}if(S.view===\"global-lore-list\"){let U=t.allLorebooks.filter(V=>!V.entriesLoaded);if(U.length>0){let V=Qe(`\\u6B63\\u5728\\u52A0\\u8F7D ${U.length} \\u672C\\u4E16\\u754C\\u4E66\\u7684\\u6761\\u76EE...`);try{await Promise.all(U.map(Q=>Ee(Q.name))),V.remove()}catch(Q){V.remove(),console.error(\"[RegexLoreHub] Failed to load entries before replace:\",Q),await q({type:\"alert\",title:\"\\u52A0\\u8F7D\\u5931\\u8D25\",text:\"\\u5728\\u6267\\u884C\\u66FF\\u6362\\u524D\\u52A0\\u8F7D\\u4E16\\u754C\\u4E66\\u6761\\u76EE\\u5931\\u8D25\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"});return}}}let _,G,z,P;if(S.type===\"lore\")if(P={type:\"lorebook\",bookNames:[]},S.view===\"global-lore-list\")({matches:_,stats:G,booksMatchedByNameOnly:z}=Ar(c));else if(S.view===\"global-lore-detail\"){let U=L([S.activeBookName]);if(!U.length){await q({type:\"alert\",title:\"\\u64CD\\u4F5C\\u65E0\\u6548\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u8981\\u66FF\\u6362\\u7684\\u4E16\\u754C\\u4E66\\u3002\"});return}if(!await K(U))return;({matches:_,stats:G,booksMatchedByNameOnly:z}=Ar(c,!1,{bookNames:U})),P.bookNames=U}else if(S.id===\"char-lore\"){let U=L([S.activeBookName,t.activeCharacterBook]);if(!U.length){await q({type:\"alert\",title:\"\\u64CD\\u4F5C\\u65E0\\u6548\",text:\"\\u5F53\\u524D\\u6CA1\\u6709\\u53EF\\u7528\\u7684\\u89D2\\u8272\\u4E16\\u754C\\u4E66\\uFF0C\\u65E0\\u6CD5\\u6267\\u884C\\u66FF\\u6362\\u3002\"});return}if(!await K(U))return;({matches:_,stats:G,booksMatchedByNameOnly:z}=Ar(c,!1,{bookNames:U})),P.bookNames=U}else if(S.id===\"chat-lore\"){let U=L([S.activeBookName,t.chatLorebook]);if(!U.length){await q({type:\"alert\",title:\"\\u64CD\\u4F5C\\u65E0\\u6548\",text:\"\\u5F53\\u524D\\u6CA1\\u6709\\u53EF\\u7528\\u7684\\u804A\\u5929\\u4E16\\u754C\\u4E66\\uFF0C\\u65E0\\u6CD5\\u6267\\u884C\\u66FF\\u6362\\u3002\"});return}if(!await K(U))return;({matches:_,stats:G,booksMatchedByNameOnly:z}=Ar(c,!1,{bookNames:U})),P.bookNames=U}else{await q({type:\"alert\",title:\"\\u64CD\\u4F5C\\u65E0\\u6548\",text:\"\\u5F53\\u524D\\u89C6\\u56FE\\u4E0D\\u652F\\u6301\\u66FF\\u6362\\u529F\\u80FD\\u3002\"});return}else if(S.type===\"regex\")({matches:_,stats:G}=so(c)),P=\"regex\";else{await q({type:\"alert\",title:\"\\u64CD\\u4F5C\\u65E0\\u6548\",text:\"\\u672A\\u77E5\\u7684\\u89C6\\u56FE\\u7C7B\\u578B\\uFF0C\\u65E0\\u6CD5\\u6267\\u884C\\u66FF\\u6362\\u3002\"});return}if((!_||_.length===0)&&(!z||z.length===0)){await q({type:\"alert\",title:\"\\u65E0\\u5339\\u914D\\u9879\",text:\"\\u672A\\u627E\\u5230\\u53EF\\u66FF\\u6362\\u7684\\u6761\\u76EE\\u3002\"});return}try{await Tl(_,G,z,c,h,P);let U=Qe(\"\\u6B63\\u5728\\u6267\\u884C\\u66FF\\u6362...\");try{await ve(_,c,h),U.remove(),he(\"\\u66FF\\u6362\\u5B8C\\u6210\"),oe()}catch(V){U.remove(),console.error(\"[RegexLoreHub] Replace error:\",V),await q({type:\"alert\",title:\"\\u66FF\\u6362\\u5931\\u8D25\",text:\"\\u66FF\\u6362\\u8FC7\\u7A0B\\u4E2D\\u53D1\\u751F\\u9519\\u8BEF\\uFF0C\\u8BF7\\u68C0\\u67E5\\u5F00\\u53D1\\u8005\\u63A7\\u5236\\u53F0\\u83B7\\u53D6\\u8BE6\\u7EC6\\u4FE1\\u606F\\u3002\"})}}catch{console.log(\"[RegexLoreHub] Replace operation cancelled by user.\")}}),X=I(async()=>{let c=Ne();if(!c.showCollapseToggle)return;let h=yr(c),_=(t.collapseStateByContext.get(h)??\"expanded\")===\"collapsed\"?\"expanded\":\"collapsed\";Xt(c,_),r(`#${me}-content .rlh-item-container:visible, #${me}-content .rlh-book-group:visible`,o).each(function(){let P=r(this),V=P.find(\".rlh-collapsible-content\").first().is(\":visible\"),Q=P.find(\".rlh-item-header, .rlh-global-book-header\").first();_===\"expanded\"&&!V?Q.trigger(\"click.rlh\",{bulk:!0}):_===\"collapsed\"&&V&&Q.trigger(\"click.rlh\",{bulk:!0})});let z=r(`#${fr}`,o);if(z.length){let P=_===\"collapsed\"?\"fa-expand-arrows-alt\":\"fa-compress-arrows-alt\",U=_===\"collapsed\"?\"\\u5168\\u90E8\\u5C55\\u5F00\":\"\\u5168\\u90E8\\u6298\\u53E0\";z.attr(\"data-collapse-state\",_),z.find(\"i\").removeClass(\"fa-expand-arrows-alt fa-compress-arrows-alt\").addClass(P),z.find(\"span\").text(U)}}),D=!1;function Z(){return{$menu:r(`#${gr}`,o),$button:r(`#${rr}`,o)}}function pe(c){if(!D)return;let h=r(c.target);h.closest(`#${gr}`).length||h.closest(`#${rr}`).length||d()}function ae(c){if(c.key!==\"Escape\")return;let{$button:h}=Z();d(),h.length&&h.trigger(\"focus\")}function de(){D||(r(o).on(\"click.rlhSortMenu\",pe),r(o).on(\"keydown.rlhSortMenu\",ae),D=!0)}function re(){D&&(r(o).off(\"click.rlhSortMenu\",pe),r(o).off(\"keydown.rlhSortMenu\",ae),D=!1)}function d(){let{$menu:c,$button:h}=Z();c.length&&(c.attr(\"data-open\",\"false\").removeClass(\"open\"),h.length&&h.attr(\"aria-expanded\",\"false\"),re())}function y(){let{$menu:c,$button:h}=Z();c.length&&(c.attr(\"data-open\",\"true\").addClass(\"open\"),h.length&&h.attr(\"aria-expanded\",\"true\"),de())}let T=I(async c=>{c.preventDefault(),c.stopPropagation();let{$menu:h}=Z();if(!h.length)return;h.attr(\"data-open\")===\"true\"?d():y()}),N=I(async c=>{c.preventDefault();let h=r(c.currentTarget).data(\"sort-value\");if(!h)return;d();let S=Ne();Jt(S,h),oe()}),B=!1;function R(){return{$menu:r(`#${Je}`,o),$button:r(`#${Ye}`,o)}}function H(c){if(!B)return;let h=r(c.target);h.closest(`#${Je}`).length||h.closest(`#${Ye}`).length||te()}function j(c){if(c.key!==\"Escape\")return;let{$button:h}=R();te(),h.length&&h.trigger(\"focus\")}function J(){B||(r(o).on(\"click.rlhPositionMenu\",H),r(o).on(\"keydown.rlhPositionMenu\",j),B=!0)}function W(){B&&(r(o).off(\"click.rlhPositionMenu\",H),r(o).off(\"keydown.rlhPositionMenu\",j),B=!1)}function te(){let{$menu:c,$button:h}=R();c.length&&(c.attr(\"data-open\",\"false\").removeClass(\"open\"),h.length&&h.attr(\"aria-expanded\",\"false\"),W())}function be(){let{$menu:c,$button:h}=R();c.length&&(h.is(\"[disabled]\")||(c.attr(\"data-open\",\"true\").addClass(\"open\"),h.length&&h.attr(\"aria-expanded\",\"true\"),J()))}let ue=I(async c=>{c.preventDefault(),c.stopPropagation(),k();let{$menu:h}=R();if(!h.length)return;h.attr(\"data-open\")===\"true\"?te():be()}),xe=I(async c=>{c.preventDefault();let h=r(c.currentTarget),S=(h.data(\"position-value\")??\"\").toString().trim(),_=(h.data(\"book-name\")??h.closest(`#${Je}`).data(\"book-name\")??\"\").toString().trim();te(),S&&l?.applyUnifiedPosition&&await l.applyUnifiedPosition({bookName:_,positionValue:S})}),Oe=I(async c=>{c.preventDefault(),c.stopPropagation(),k();let{$menu:h,$button:S}=b();if(!h.length||!S.length||S.is(\":disabled\"))return;h.attr(\"data-open\")===\"true\"?p():v()}),ir=I(async c=>{c.preventDefault();let S=(r(c.currentTarget).data(\"status-id\")??\"\").toString().trim();if(!S)return;p();let _=t.multiSelectMode&&t.multiSelectTarget===\"entry\",G=m();if(_&&G.size===0){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u81F3\\u5C11\\u9009\\u62E9\\u4E00\\u4E2A\\u5DF2\\u4FDD\\u5B58\\u7684\\u6761\\u76EE\\u3002\"}),k();return}if(!_){let Ue=[Ne()?.activeBookName,t.activeBookName,t.activeCharacterBook,t.chatLorebook].find(Ve=>typeof Ve==\"string\"&&Ve.trim().length>0)?.toString().trim()??\"\";if(!Ue){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u6253\\u5F00\\u4E00\\u4E2A\\u4E16\\u754C\\u4E66\\u4EE5\\u4FBF\\u6267\\u884C\\u7EDF\\u4E00\\u72B6\\u6001\\u3002\"}),k();return}let sr=[...ee(Ue)];if(sr.length||(await Ee(Ue),sr=[...ee(Ue)]),!sr.length){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:`\\u300C${Ue}\\u300D\\u6682\\u65E0\\u6761\\u76EE\\u53EF\\u64CD\\u4F5C\\u3002`}),k();return}let He=[];if(sr.forEach(Ve=>{let ye=Number(Ve?.uid);Number.isFinite(ye)&&He.push(ye)}),!He.length){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u5F53\\u524D\\u6CA1\\u6709\\u5DF2\\u4FDD\\u5B58\\u7684\\u6761\\u76EE\\u53EF\\u64CD\\u4F5C\\u3002\"}),k();return}G=new Map([[Ue,He]])}let z=Ge(S)??Ce,P=z.toastLabel??z.label,U=Array.from(G.values()).reduce((Ie,$r)=>Ie+$r.length,0),V=Qe(`\\u6B63\\u5728\\u66F4\\u65B0 ${U} \\u4E2A\\u6761\\u76EE\\u7684\\u72B6\\u6001...`),Q=0,ie=0,se=0,le=0,Se=0,je=[];try{let Ie=Ne(),$r=0;for(let[Ue,sr]of G.entries()){$r+=1,V.update(`\\u6B63\\u5728\\u66F4\\u65B0\\u300C${Ue}\\u300D (${$r}/${G.size})`);let He=await go(Ue,sr,z.id,{context:Ie?.id??\"unknown\"}).catch(ye=>(console.error(\"[RegexLoreHub] \\u6279\\u91CF\\u72B6\\u6001\\u66F4\\u65B0\\u5F02\\u5E38:\",ye),je.push({bookName:Ue,reason:ye?.message??\"\\u672A\\u77E5\\u9519\\u8BEF\"}),se+=sr.length,null));if(!He)continue;let Ve=He.summary??{appliedCount:0,alreadyAppliedCount:0,failedCount:0,ignoredCount:0,ignoredUnsavedCount:0};Q+=Ve.appliedCount??0,ie+=Ve.alreadyAppliedCount??0,se+=Ve.failedCount??0,le+=Ve.ignoredCount??0,Se+=Ve.ignoredUnsavedCount??0,Array.isArray(He.failed)&&He.failed.forEach(ye=>{je.push({bookName:Ue,name:ye.name??`#${ye.uid??ye.tempUid??\"\\u672A\\u77E5\"}`,reason:ye.reason??\"\\u672A\\u8BF4\\u660E\"})}),Array.isArray(He.ignored)&&He.ignored.filter(ye=>ye.reason&&ye.reason!==\"UNSAVED_ENTRY\").forEach(ye=>{je.push({bookName:Ue,name:ye.name??`#${ye.uid??ye.tempUid??\"\\u672A\\u77E5\"}`,reason:ye.reason})}),Array.isArray(He.success)&&He.success.forEach(ye=>{let Ot=ye.uid??ye.tempUid;Ot!=null&&Qr(Ue,Ot,z.id)})}}finally{V.remove()}let $e=Math.max(le-Se,0),Te=\"\";if(Q>0&&se===0&&Se===0&&$e===0)Te=`${Q} \\u4E2A\\u6761\\u76EE\\u7684\\u72B6\\u6001\\u5DF2\\u66F4\\u65B0\\u4E3A\\u300C${P}\\u300D`,ie>0&&(Te+=`\\uFF08\\u5176\\u4E2D ${ie} \\u4E2A\\u539F\\u672C\\u5DF2\\u5904\\u4E8E\\u8BE5\\u72B6\\u6001\\uFF09`);else{let Ie=[];Q>0&&Ie.push(`${Q} \\u4E2A\\u6761\\u76EE\\u66F4\\u65B0\\u4E3A\\u300C${P}\\u300D`),ie>0&&Ie.push(`${ie} \\u4E2A\\u539F\\u672C\\u5DF2\\u5904\\u4E8E\\u8BE5\\u72B6\\u6001`),se>0&&Ie.push(`${se} \\u4E2A\\u6761\\u76EE\\u66F4\\u65B0\\u5931\\u8D25`),Se>0&&Ie.push(`\\u5FFD\\u7565 ${Se} \\u4E2A\\u672A\\u4FDD\\u5B58\\u6761\\u76EE`),$e>0&&Ie.push(`\\u8DF3\\u8FC7 ${$e} \\u4E2A\\u6761\\u76EE`),Te=Ie.length>0?Ie.join(\"\\uFF1B\"):\"\\u672A\\u6267\\u884C\\u4EFB\\u4F55\\u72B6\\u6001\\u66F4\\u65B0\\uFF0C\\u8BF7\\u786E\\u8BA4\\u5DF2\\u9009\\u62E9\\u6709\\u6548\\u6761\\u76EE\\u3002\"}let _e=\"success\";se>0?_e=Q>0?\"warning\":\"error\":(Se>0||$e>0)&&(_e=\"info\"),he(Te,_e),je.length&&console.warn(\"[RegexLoreHub] \\u72B6\\u6001\\u66F4\\u65B0\\u8BE6\\u60C5\\uFF08\\u4EC5\\u65E5\\u5FD7\\uFF09:\",je),k()}),De=I(async c=>{let h=(r(c.currentTarget).val()??\"\").toString().trim();!h||t.activeCharacterBook===h||(t.activeCharacterBook=h,oe())}),Le=I(async c=>{let h=r(c.currentTarget),S=h.data(\"select-key\");if(!S)return;if(!t.multiSelectMode){h.prop(\"checked\",!1);return}let _=h.is(\":checked\");_?t.selectedItems.add(S):t.selectedItems.delete(S),h.closest(\"[data-select-key]\").toggleClass(\"selected\",_),k()}),ve=async(c,h,S)=>{let _=Yt(h,!1),G=new Map,z=(P,U)=>{if(!Array.isArray(P)||!Array.isArray(U)||P.length!==U.length)return!1;for(let V=0;V<P.length;V+=1)if(P[V]!==U[V])return!1;return!0};for(let P of c){let{bookName:U,entry:V}=P??{};if(!U||!V)throw new Error(\"\\u4EC5\\u652F\\u6301\\u4E16\\u754C\\u4E66\\u6761\\u76EE\\u7684\\u6279\\u91CF\\u66FF\\u6362\\u3002\");let Q=Number(V?.uid);if(!Number.isFinite(Q))continue;let ie={uid:Q},se=!1;if(Array.isArray(V.keys)){let le=V.keys.map(Se=>Se.replace(_,S));z(V.keys,le)||(ie.keys=le,se=!0)}if(typeof V.content==\"string\"){let le=V.content.replace(_,S);le!==V.content&&(ie.content=le,se=!0)}if(typeof V.name==\"string\"){let le=V.name.replace(_,S);le!==V.name&&(ie.name=le,se=!0)}if(typeof V.comment==\"string\"){let le=V.comment.replace(_,S);le!==V.comment&&(ie.comment=le,se=!0)}se&&(G.has(U)||G.set(U,[]),G.get(U).push(ie))}for(let[P,U]of G.entries())U.length!==0&&await Pe(P,U)},Fe=I(async()=>{r(`#${me}`,o).is(\":visible\")?we():await br()}),we=async()=>{he(\"\\u6B63\\u5728\\u540E\\u53F0\\u4FDD\\u5B58\\u6570\\u636E...\",\"info\"),ar().then(()=>{he(\"\\u6570\\u636E\\u4FDD\\u5B58\\u6210\\u529F\\uFF01\",\"success\")}).catch(S=>{console.error(\"[RegexLoreHub] Background save failed:\",S),he(\"\\u540E\\u53F0\\u4FDD\\u5B58\\u5931\\u8D25\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u65E5\\u5FD7\\u3002\",\"error\")});let c=r(`#${me}`,o),h=r(\"body\",o);c.hide(),r(`#${Xe}`,o).removeClass(\"active\"),h.off(\"mousedown.rlh-outside-click\")},br=async()=>{let c=r(`#${me}`,o),h=r(\"body\",o);c.css(\"display\",\"flex\"),r(`#${Xe}`,o).addClass(\"active\"),h.on(\"mousedown.rlh-outside-click\",function(S){r(S.target).closest(`#${me}`).length===0&&r(S.target).closest(`#${Xe}`).length===0&&we()}),t.isDataLoaded?oe():await ze()},Ur=I(async c=>{t.isLoadingTabData=!0,oe();try{await So();let h=S=>{if(!S)return null;Array.isArray(t.allLorebooks)||(t.allLorebooks=[]);let _=t.allLorebooks.find(G=>G.name===S);return _||(_={name:S,enabled:!1,entryCount:0,enabledEntryCount:0,entriesLoaded:!1},t.allLorebooks.push(_)),_};if(c===\"char-lore\"){let S=Array.isArray(t.lorebooks.character)?t.lorebooks.character:[];for(let _ of S)h(_),await Ee(_,!0)}else if(c===\"chat-lore\"){let S=t.chatLorebook;S&&(h(S),await Ee(S,!0))}}catch(h){console.error(`[RegexLoreHub] Error refreshing tab ${c}:`,h),I(()=>{throw h})()}finally{t.isLoadingTabData=!1,oe()}}),at=c=>{switch(c){case\"char-lore\":t.activeView=\"char-lore\";break;case\"chat-lore\":t.activeView=\"chat-lore\";break;case\"global-regex\":t.activeView=\"global-regex\";break;case\"char-regex\":t.activeView=\"char-regex\";break;case\"global-lore\":default:t.activeView!==\"global-lore-detail\"&&(t.activeView=\"global-lore-list\");break}},Mo=I(async c=>{let h=r(c.currentTarget).data(\"tab\");if(h===\"global-lore\"&&t.activeView===\"global-lore-detail\"){await l.handleExitLorebookDetail();return}t.activeTab=h,at(h),r(`#${me} .rlh-tab`,o).removeClass(\"active\"),r(c.currentTarget).addClass(\"active\"),r(`#${Hr}`,o).toggle(t.activeTab===\"global-lore\"),t.selectedItems.clear(),h===\"char-lore\"&&!t.charLoreInitialSynced&&(await ze(),t.charLoreInitialSynced=!0),h===\"char-lore\"||h===\"chat-lore\"?await Ur(h):oe()}),Bt=I(async c=>{t.multiSelectMode=!t.multiSelectMode,t.selectedItems.clear(),r(\"#rlh-multi-select-btn\",o).toggleClass(\"active\",t.multiSelectMode),r(\"#rlh-multi-select-controls\",o).toggleClass(\"active\",t.multiSelectMode),oe(),k()}),Oo=I(async()=>{if(!t.multiSelectMode)return;let c=C();c.length&&(c.forEach(h=>t.selectedItems.add(h)),oe(),k())}),Do=I(async()=>{if(!t.multiSelectMode)return;let c=n(),h=!1;if(c)[...t.selectedItems].forEach(_=>{_.startsWith(c)&&(t.selectedItems.delete(_),h=!0)});else{if(t.selectedItems.size===0)return;t.selectedItems.clear(),h=!0}h&&(oe(),k())}),Uo=I(async()=>{if(!t.multiSelectMode)return;let c=C();c.length&&(c.forEach(h=>{t.selectedItems.has(h)?t.selectedItems.delete(h):t.selectedItems.add(h)}),oe(),k())}),Ho=I(async()=>{if(t.multiSelectMode){if(!s())return await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u8981\\u542F\\u7528\\u7684\\u9879\\u76EE\\u3002\"});await Mt(!0),he(\"\\u6279\\u91CF\\u542F\\u7528\\u6210\\u529F\")}}),Po=I(async()=>{if(t.multiSelectMode){if(!s())return await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u8981\\u7981\\u7528\\u7684\\u9879\\u76EE\\u3002\"});await Mt(!1),he(\"\\u6279\\u91CF\\u7981\\u7528\\u6210\\u529F\")}}),zo=I(async()=>{if(!t.multiSelectMode)return;let c=new Set,h=new Map,S=new Set,_=0;for(let U of t.selectedItems){let{type:V,bookName:Q,entryId:ie,regexId:se}=i(U);if(V===\"book\"&&Q)c.add(Q);else if(V===\"lore\"&&Q){let le=Number(ie);if(!Number.isFinite(le))continue;h.has(Q)||h.set(Q,[]),h.get(Q).push(le),_++}else if(V===\"regex\"){let le=se!=null&&se!==\"\"?String(se):\"\";le&&S.add(le)}}if(c.size===0&&_===0&&S.size===0)return await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u8BF7\\u5148\\u9009\\u62E9\\u8981\\u5220\\u9664\\u7684\\u9879\\u76EE\\u3002\"});let G=\"\\u60A8\\u786E\\u5B9A\\u8981\\u6C38\\u4E45\\u5220\\u9664\",z=[];c.size>0&&z.push(`\\u9009\\u4E2D\\u7684 ${c.size} \\u672C\\u4E16\\u754C\\u4E66`),_>0&&z.push(`${_} \\u4E2A\\u6761\\u76EE`),S.size>0&&z.push(`${S.size} \\u4E2A\\u6B63\\u5219`),G+=` ${z.join(\"\\u548C\")} \\u5417\\uFF1F\\u6B64\\u64CD\\u4F5C\\u65E0\\u6CD5\\u64A4\\u9500\\u3002`;try{await q({type:\"confirm\",title:\"\\u786E\\u8BA4\\u5220\\u9664\",text:G})}catch{return}let P=Qe(\"\\u5F00\\u59CB\\u5220\\u9664...\");try{let U=0,V=0,Q=0,ie=0,se=0,le=Array.from(h.entries());for(let[$e,Te]of le){if(c.has($e)){ie+=Te.length;continue}P.update(`\\u6B63\\u5728\\u5220\\u9664\\u6761\\u76EE... (${ie}/${_})`);let _e=await Y.deleteWorldbookEntries($e,Te);ie+=Te.length,_e&&_e.deleted_entries&&_e.deleted_entries.length>0&&(V+=_e.deleted_entries.length,Re($e,_e.worldbook.map(Ze)),Te.forEach(Ie=>t.selectedItems.delete(`lore:${$e}:${Ie}`)))}let Se=Array.from(c);for(let $e of Se){if(P.update(`\\u6B63\\u5728\\u5220\\u9664\\u4E16\\u754C\\u4E66... (${se+1}/${Se.length})`),await Y.deleteWorldbook($e)){U++,t.allLorebooks=t.allLorebooks.filter(Te=>Te.name!==$e),Nr($e),t.selectedItems.delete(`book:${$e}`);for(let Te of t.selectedItems)Te.startsWith(`lore:${$e}:`)&&t.selectedItems.delete(Te)}se++}if(S.size>0){P.update(`\\u6B63\\u5728\\u5220\\u9664 ${S.size} \\u4E2A\\u6B63\\u5219...`);let $e=await Y.getRegexes(),Te=$e.filter(_e=>!S.has(String(_e.id)));await Y.replaceRegexes(Te.filter(_e=>_e.source!==\"card\")),await Y.saveSettings(),Q=$e.length-Te.length,t.regexes.global=t.regexes.global.filter(_e=>!S.has(String(_e.id))),t.regexes.character=t.regexes.character.filter(_e=>!S.has(String(_e.id))),qe(t.regexes.global),qe(t.regexes.character),S.forEach(_e=>t.selectedItems.delete(`regex:${_e}`))}P.remove();let je=[];U>0&&je.push(`\\u6210\\u529F\\u5220\\u9664 ${U} \\u672C\\u4E16\\u754C\\u4E66`),V>0&&je.push(`\\u6210\\u529F\\u5220\\u9664 ${V} \\u4E2A\\u6761\\u76EE`),Q>0&&je.push(`\\u6210\\u529F\\u5220\\u9664 ${Q} \\u4E2A\\u6B63\\u5219`),je.length>0?(he(je.join(\"\\uFF0C\")),t.multiSelectMode?Bt():oe()):await q({type:\"alert\",title:\"\\u5220\\u9664\\u5931\\u8D25\",text:\"\\u5220\\u9664\\u9879\\u76EE\\u65F6\\u53D1\\u751F\\u9519\\u8BEF\\uFF0C\\u8BF7\\u68C0\\u67E5\\u63A7\\u5236\\u53F0\\u3002\"})}catch(U){P.remove(),console.error(\"[RegexLoreHub] Batch delete failed:\",U),await q({type:\"alert\",title:\"\\u5220\\u9664\\u5931\\u8D25\",text:`\\u64CD\\u4F5C\\u5931\\u8D25: ${U.message}`}),await ze(!0)}}),Fo=I(async()=>{if(!Array.isArray(t.allLorebooks)||t.allLorebooks.length===0){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u6CA1\\u6709\\u627E\\u5230\\u53EF\\u4EE5\\u6E05\\u7406\\u7684\\u4E16\\u754C\\u4E66\\u3002\"});return}let c=t.allLorebooks.filter(z=>{let P=t.lorebookUsage instanceof Map?t.lorebookUsage.get(z.name):[],U=Array.isArray(P)?P:[];return!z.enabled&&U.length===0}).map(z=>z.name);if(c.length===0){await q({type:\"alert\",title:\"\\u63D0\\u793A\",text:\"\\u6CA1\\u6709\\u627E\\u5230\\u672A\\u542F\\u7528\\u4E14\\u672A\\u7ED1\\u5B9A\\u89D2\\u8272\\u5361\\u7684\\u4E16\\u754C\\u4E66\\u3002\"});return}t.multiSelectMode=!0,t.multiSelectTarget=\"book\",t.selectedItems.clear(),c.forEach(z=>t.selectedItems.add(\"book:\"+z)),oe();let h=\"\\u5C06\\u5220\\u9664 \"+c.length+\" \\u672C\\u672A\\u542F\\u7528\\u4E14\\u672A\\u7ED1\\u5B9A\\u89D2\\u8272\\u5361\\u7684\\u4E16\\u754C\\u4E66\\u3002\\u56E0API\\u9650\\u5236\\uFF0C\\u65E0\\u6CD5\\u76F4\\u63A5\\u83B7\\u53D6\\u804A\\u5929\\u7ED1\\u5B9A\\u4E16\\u754C\\u4E66\\uFF0C\\u5B58\\u5728\\u8BEF\\u5220\\u8BE5\\u4E16\\u754C\\u4E66\\u7684\\u53EF\\u80FD\\u3002\\u786E\\u5B9A\\u7EE7\\u7EED\\u5417\\uFF1F\";try{await q({type:\"confirm\",title:\"\\u786E\\u8BA4\\u6E05\\u7406\\u5B64\\u7ACB\\u4E16\\u754C\\u4E66\",text:h})}catch{return}let S=Qe(\"\\u5F00\\u59CB\\u6E05\\u7406\\u5B64\\u7ACB\\u4E16\\u754C\\u4E66...\"),_=[],G=0;try{for(let z=0;z<c.length;z+=1){let P=c[z];S.update(\"\\u6B63\\u5728\\u5220\\u9664\\u7B2C \"+(z+1)+\" / \"+c.length+\" \\u672C\\u4E16\\u754C\\u4E66...\"),await Y.deleteWorldbook(P)?(G+=1,t.allLorebooks=t.allLorebooks.filter(Q=>Q.name!==P),Nr(P),t.lorebookUsage instanceof Map&&t.lorebookUsage.has(P)&&t.lorebookUsage.delete(P),Array.isArray(t.lorebooks?.character)&&(t.lorebooks.character=t.lorebooks.character.filter(Q=>Q!==P)),t.chatLorebook===P&&(t.chatLorebook=null),t.activeCharacterBook===P&&(t.activeCharacterBook=null),t.activeBookName===P&&(t.activeBookName=null),t.selectedItems.delete(\"book:\"+P),[...t.selectedItems].forEach(Q=>{Q.startsWith(\"lore:\"+P+\":\")&&t.selectedItems.delete(Q)})):_.push(P)}}catch(z){S.remove(),console.error(\"[RegexLoreHub] Clean orphan lorebooks failed:\",z),await q({type:\"alert\",title:\"\\u64CD\\u4F5C\\u5931\\u8D25\",text:\"\\u6E05\\u7406\\u5B64\\u7ACB\\u4E16\\u754C\\u4E66\\u65F6\\u53D1\\u751F\\u9519\\u8BEF\\uFF1A\"+(z?.message||z)}),await ze(!0);return}S.remove(),G>0&&he(\"\\u5DF2\\u5220\\u9664 \"+G+\" \\u672C\\u5B64\\u7ACB\\u4E16\\u754C\\u4E66\"),_.length>0?(t.selectedItems.clear(),_.forEach(z=>t.selectedItems.add(\"book:\"+z)),await q({type:\"alert\",title:\"\\u90E8\\u5206\\u5220\\u9664\\u5931\\u8D25\",text:\"\\u4EE5\\u4E0B\\u4E16\\u754C\\u4E66\\u672A\\u80FD\\u5220\\u9664\\uFF1A\"+_.join(\"\\u3001\")})):(t.selectedItems.clear(),t.multiSelectMode=!1),oe()}),Mt=I(async c=>{let h=new Set,S=new Map,_=new Set,G=!1,z=!1;for(let P of t.selectedItems){let{type:U,bookName:V,entryId:Q,regexId:ie}=i(P);if(U===\"book\"&&V)h.add(V);else if(U===\"lore\"&&V){let se=Number(Q);if(!Number.isFinite(se))continue;S.has(V)||S.set(V,[]),S.get(V).push(se)}else if(U===\"regex\"){let se=ie!=null&&ie!==\"\"?String(ie):\"\";se&&_.add(se)}}if(h.size>0){let P=new Set(await Y.getGlobalWorldbookNames()||[]);h.forEach(U=>c?P.add(U):P.delete(U)),await Y.rebindGlobalWorldbooks(Array.from(P)),z=!0,h.forEach(U=>{let V=t.allLorebooks.find(Q=>Q.name===U);V&&(V.enabled=c)})}if(S.size>0)for(let[P,U]of S){let V=[...ee(P)];if(V){let Q=U.map(ie=>{let se=V.find(le=>le.uid===ie);return se?(se.enabled=c,{uid:ie,enabled:c}):null}).filter(Boolean);Q.length>0&&await Pe(P,Q)}}if(await Y.saveSettings(),_.size>0){let P=await Y.getRegexes();P.forEach(U=>{_.has(String(U.id))&&(U.enabled=c)}),await Y.replaceRegexes(P.filter(U=>U.source!==\"card\")),G=!0,[t.regexes.global,t.regexes.character].forEach(U=>U.forEach(V=>{_.has(String(V.id))&&(V.enabled=c)}))}(z||G)&&await Y.saveSettings(),t.selectedItems.clear(),oe()}),jo=I(async(c,h)=>{let S=r(c.target),_=r(c.currentTarget).closest(\".rlh-item-container, .rlh-book-group\");if(S.closest(\".rlh-item-controls, .rlh-rename-ui\").length>0||t.multiSelectMode&&x(_))return;if(!t.multiSelectMode&&t.activeTab===\"global-lore\"&&t.activeView===\"global-lore-list\"&&_.is(\".rlh-book-group\")&&S.closest(\".rlh-book-title-wrapper\").length>0){let z=_.data(\"book-name\");z&&l?.handleEnterLorebookDetail&&await l.handleEnterLorebookDetail(z);return}if(_.hasClass(\"from-card\")||_.hasClass(\"renaming\"))return;let G=_.find(\".rlh-collapsible-content\").first();if(_.is(\".rlh-book-group\")&&t.activeTab!==\"global-lore\"){G.slideToggle(200);return}if(_.is(\".rlh-item-container\")){if(G.is(\":visible\")){G.stop(!0,!0).slideUp(200,()=>{G.off(\"input.rlh\"),G.empty(),G.attr(\"data-entry-mode\",\"collapsed\")}),_.attr(\"data-entry-mode\",\"collapsed\");return}h?.bulk||_.siblings(\".rlh-item-container\").find(\".rlh-collapsible-content:visible\").slideUp(200).empty();let z=_.data(\"type\"),P=_.data(\"id\"),U=_.data(\"searchTerm\"),V=_.attr(\"data-search-term\"),Q=typeof U==\"string\"&&U.length>0?U:typeof V==\"string\"&&V.length>0?V:\"\";if(z===\"lore\"){let ie=_.data(\"book-name\"),le=[...ee(ie)].find(Se=>Se.uid===Number(P));if(!le)return;a.renderLoreEntryViewer(_,le,Q,{animate:!0});return}if(z===\"regex\"){let ie=[...t.regexes.global,...t.regexes.character].find(le=>le.id===P);if(!ie)return;_.attr(\"data-entry-mode\")===\"edit\"?a.renderRegexEditor(_,ie,{animate:!0}):a.renderRegexViewer(_,ie,Q,{animate:!0});return}}}),Wo=I(async c=>{if(!t.multiSelectMode||r(c.target).closest(\".rlh-item-controls, .rlh-rename-ui, .rlh-action-btn, .rlh-action-btn-icon, .rlh-toggle-btn, .rlh-selection-control, .rlh-multi-select-checkbox, .rlh-item-header, .rlh-global-book-header\").length>0)return;let S=r(c.currentTarget).closest(\".rlh-item-container, .rlh-book-group\");S.length&&x(S)&&(c.stopPropagation(),c.preventDefault())}),Go=I(async c=>{c.stopPropagation();let h=r(c.currentTarget),S=h.closest(\".rlh-book-group\"),_=!S.hasClass(\"editing-entries\");S.toggleClass(\"editing-entries\"),_?(t.multiSelectMode||(t.multiSelectMode=!0,r(\"#rlh-multi-select-btn\",o).addClass(\"active\"),r(\"#rlh-multi-select-controls\",o).addClass(\"active\"),r(`#${me}`,o).addClass(\"rlh-multi-select-mode\")),S.find(\".rlh-collapsible-content\").first().slideDown(200),h.attr(\"title\",\"\\u5B8C\\u6210\\u7F16\\u8F91\").find(\"i\").removeClass(\"fa-pen-to-square\").addClass(\"fa-check-square\"),h.addClass(\"active\")):(h.attr(\"title\",\"\\u7F16\\u8F91/\\u9009\\u62E9\\u6761\\u76EE\").find(\"i\").removeClass(\"fa-check-square\").addClass(\"fa-pen-to-square\"),h.removeClass(\"active\"))}),Ko=I(async c=>{let S=r(c.currentTarget).find(\"i\");S.addClass(\"fa-spin\");let _=null;t.activeView===\"global-lore-detail\"&&t.activeBookName&&(_=ee(t.activeBookName),console.log(`[RegexLoreHub] \\u5168\\u5C40\\u5237\\u65B0\\u65F6\\u7F13\\u5B58\\u8BE6\\u60C5\\u89C6\\u56FE\\u6761\\u76EE: ${t.activeBookName}`)),Dr(),await ze(!0),_&&t.activeView===\"global-lore-detail\"&&t.activeBookName&&(Re(t.activeBookName,_),ur(t.activeBookName),console.log(`[RegexLoreHub] \\u6062\\u590D\\u8BE6\\u60C5\\u89C6\\u56FE\\u6761\\u76EE: ${t.activeBookName}`),Ee(t.activeBookName,!0).catch(G=>{console.warn(`[RegexLoreHub] \\u6062\\u590D\\u540E\\u5237\\u65B0\\u6761\\u76EE\\u5931\\u8D25: ${t.activeBookName}`,G)}),oe()),setTimeout(()=>S.removeClass(\"fa-spin\"),500)}),Vo=I(async c=>{if(t.activeView===\"global-lore-list\")l?.handleCreateLorebook&&await l.handleCreateLorebook(c);else if(t.activeView===\"global-lore-detail\"){if(!t.activeBookName)return;if(a?.handleCreateEntry){let h={currentTarget:r(`<button data-book-name=\"${t.activeBookName}\"></button>`)};await a.handleCreateEntry(h)}}});return{handleGlobalSearch:A,handleSearchClear:ne,handleSearchInputKeydown:M,handleReplace:F,handleToolbarToggleCollapse:X,handleSortMenuToggle:T,handleSortOptionSelect:N,handlePositionMenuToggle:ue,handlePositionOptionSelect:xe,handleUnifiedStatusMenuToggle:Oe,handleUnifiedStatusOptionSelect:ir,handleCharacterBookSwitch:De,handleSelectionCheckboxChange:Le,togglePanel:Fe,switchTab:Mo,toggleMultiSelectMode:Bt,handleSelectAll:Oo,handleSelectNone:Do,handleSelectInvert:Uo,handleBatchEnable:Ho,handleBatchDisable:Po,handleBatchDelete:zo,handleCleanOrphanLorebooks:Fo,handleHeaderClick:jo,handleMultiSelectContainerClick:Wo,handleEditEntriesToggle:Go,handleRefresh:Ko,handlePrimaryCreateButtonClick:Vo}}var Ct=e=>!e&&e!==0?\"\":typeof e==\"string\"?e.trim():e&&typeof e==\"object\"&&typeof e.name==\"string\"?e.name.trim():String(e??\"\").trim(),Io=()=>typeof performance<\"u\"&&typeof performance.now==\"function\"?performance.now():Date.now(),Ro=()=>({handleSelectUnboundBooks:I(async r=>{if(r?.preventDefault?.(),r?.stopPropagation?.(),t.activeView!==\"global-lore-list\"){he(\"\\u8BE5\\u64CD\\u4F5C\\u4EC5\\u5728\\u5168\\u5C40\\u4E16\\u754C\\u4E66\\u5217\\u8868\\u89C6\\u56FE\\u53EF\\u7528\",\"info\");return}if(t.activeTab!==\"global-lore\"){he(\"\\u8BE5\\u64CD\\u4F5C\\u4EC5\\u5728\\u5168\\u5C40\\u4E16\\u754C\\u4E66\\u5217\\u8868\\u53EF\\u7528\",\"info\");return}let o=Io(),{totalBooks:l,unboundNames:a,statsByName:n}=wo(),i=Array.isArray(t.allLorebooks)?t.allLorebooks:[],b=typeof t.globalSearch?.term==\"string\"?t.globalSearch.term.trim():\"\",m=b.toLowerCase(),u=Ct(t.activeBookName),v=(!!(m&&m.length)?i.filter(s=>{let f=Ct(s);if(!f)return!1;if(t.searchFilters.bookName&&f.toLowerCase().includes(m))return!0;let A=ee(f);return!Array.isArray(A)||A.length===0?!1:A.some(M=>hr(M,m))}):i).map(s=>{let f=Ct(s);return{book:s,name:f}}).filter(({name:s})=>typeof s==\"string\"&&s.length>0),E=v.map(({name:s})=>s),w=v.filter(({book:s,name:f})=>{if(!f||u&&f===u||s&&s.enabled)return!1;if(a.has(f))return!0;let x=n.get(f);return x?x.bindingCount===0:!1}).map(({name:s})=>s);if(w.length===0){he(\"\\u6CA1\\u6709\\u672A\\u7ED1\\u5B9A\\u7684\\u4E16\\u754C\\u4E66\",\"info\"),ut({category:\"lorebook\",action:\"select_unbound\",value:0,label:\"global_unbound_select\",feature:\"select_unbound_lorebooks\",view:t.activeView,meta:{searchTerm:b,visibleBookCount:E.length,totalBookCount:l,unboundTotal:a.size}});return}t.multiSelectMode=!0,t.multiSelectTarget=\"book\",t.selectedItems.clear(),w.forEach(s=>{let f=Kr(s);f&&t.selectedItems.add(f)});let k=Io(),C=Math.max(0,Math.round(k-o));oe(),he(`\\u5DF2\\u9009\\u4E2D ${w.length} \\u672C\\u672A\\u7ED1\\u5B9A\\u7684\\u4E16\\u754C\\u4E66\\uFF0C\\u8BF7\\u786E\\u8BA4\\u8FD9\\u4E9B\\u4E16\\u754C\\u4E66\\u672A\\u5728\\u804A\\u5929\\u4E2D\\u4F7F\\u7528\\uFF0C\\u907F\\u514D\\u8BEF\\u5220\\u804A\\u5929\\u4E16\\u754C\\u4E66\\u3002`,\"success\"),console.log(`[RegexLoreHub] \\u9009\\u62E9\\u5B64\\u7ACB\\u4E16\\u754C\\u4E66\\uFF1A\\u5339\\u914D ${w.length} / \\u53EF\\u89C1 ${E.length} / \\u5168\\u91CF ${l}\\uFF0C\\u8017\\u65F6 ${C}ms\\u3002`),ut({category:\"lorebook\",action:\"select_unbound\",value:w.length,label:\"global_unbound_select\",feature:\"select_unbound_lorebooks\",view:t.activeView,meta:{searchTerm:b,visibleBookCount:E.length,totalBookCount:l,unboundTotal:a.size,selectionCount:w.length,durationMs:C}})})});function Ao(){let e=ce(),r=fe(),o=ke(),l={$:e,parentDoc:r,parentWin:o},a=Lo(l),n=To(l),i=No({...l,lorebookHandlers:a,itemHandlers:n}),b=Ro();return{...a,...n,...i,...b}}var Nt=`\n/*! tailwindcss v4.1.13 | MIT License | https://tailwindcss.com */\n@layer theme{:root,:host{--rlh-font-sans:ui-sans-serif,system-ui,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\",\"Segoe UI Symbol\",\"Noto Color Emoji\";--rlh-spacing:.25rem;--rlh-text-sm:.875rem;--rlh-text-sm--line-height:calc(1.25/.875);--rlh-text-base:1rem;--rlh-text-base--line-height:calc(1.5/1);--rlh-font-weight-medium:500;--rlh-radius-lg:.5rem;--rlh-radius-xl:.75rem;--rlh-ease-out:cubic-bezier(0,0,.2,1);--rlh-blur-xl:24px;--rlh-default-transition-duration:.15s;--rlh-default-transition-timing-function:cubic-bezier(.4,0,.2,1)}}@layer utilities;@layer base{#regex-lore-hub-panel *{text-shadow:none!important}#regex-lore-hub-panel{--rlh-panel-radius:20px;--rlh-focus-ring:0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-focus-ring:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}#regex-lore-hub-panel{--rlh-bg-color:#f5f7fb;--rlh-surface-color:#fffd;--rlh-text-color:#0f172a;--rlh-em-color:#475569;--rlh-border-color:#bfc8f5;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)12%,transparent)}}#regex-lore-hub-panel{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)20%,transparent)}}#regex-lore-hub-panel{--rlh-shadow-color:#0f172a2e;--rlh-header-bg:#eef2ffd9;--rlh-input-bg:#ffffffeb;--rlh-accent-color:#4f46e5;--rlh-green:#10b981;--rlh-red:#ef4444;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)18%,transparent)}}#regex-lore-hub-panel{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)18%,transparent)}}#regex-lore-hub-panel{--rlh-status-constant:#22c55e;--rlh-status-selective:#3b82f6;--rlh-status-vectorized:#a855f7}#regex-lore-hub-panel.dark{--rlh-bg-color:#101827;--rlh-surface-color:#111827cc;--rlh-text-color:#f9fafb;--rlh-em-color:#cbd5e1;--rlh-border-color:#2d3748;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)14%,transparent)}}#regex-lore-hub-panel.dark{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)22%,transparent)}}#regex-lore-hub-panel.dark{--rlh-shadow-color:#02061780;--rlh-header-bg:#0f172ae6;--rlh-input-bg:#1f2937d9;--rlh-accent-color:#6366f1;--rlh-green:#10b981;--rlh-red:#fb7185;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)20%,transparent)}}#regex-lore-hub-panel.dark{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)20%,transparent)}}#regex-lore-hub-panel.dark{--rlh-status-constant:#34d399;--rlh-status-selective:#60a5fa;--rlh-status-vectorized:#c084fc}@keyframes rlhFadeInUp{0%{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}@keyframes rlhSoftPulse{}@keyframes rlhToastIn{0%{opacity:0;transform:translate(-50%)translateY(28px)scale(.96)}60%{opacity:1;transform:translate(-50%)translateY(-4px)scale(1.02)}to{opacity:1;transform:translate(-50%)translateY(0)scale(1)}}@keyframes rlhHighlightPulse{0%{background-color:#fde68a}50%{background-color:#facc15}to{background-color:#fde68a}}}@layer components{#regex-lore-hub-panel{z-index:10000;width:100%;height:100dvh;min-height:100svh;color:var(--rlh-text-color);background:var(--rlh-bg-color);justify-content:center;align-items:center;padding:clamp(.8rem,1.5vw,1.3rem);display:none;position:fixed;inset:0}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{background:color-mix(in srgb,var(--rlh-bg-color)92%,transparent)}}#regex-lore-hub-panel{-webkit-backdrop-filter:blur(24px);backdrop-filter:blur(24px);font-family:Inter,Segoe UI,Microsoft YaHei,sans-serif;transition:opacity .25s}@media (max-width:1024px){#regex-lore-hub-panel{justify-content:flex-start;align-items:stretch}}#regex-lore-hub-panel .rlh-shell{border-radius:var(--rlh-panel-radius);background:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);width:min(1250px,100%);height:100%;box-shadow:0 32px 120px -60px var(--rlh-shadow-color);flex-direction:column;gap:clamp(.45rem,1vw,.75rem);margin:0 auto;padding:clamp(.75rem,1.4vw,1.15rem);animation:.3s ease-out both rlhFadeInUp;display:flex;position:relative;overflow:hidden}#regex-lore-hub-panel .rlh-shell:before{content:\"\";background:radial-gradient(circle at top right,var(--rlh-accent-color)0%,transparent 60%),radial-gradient(circle at bottom left,var(--rlh-green)0%,transparent 65%);position:absolute;inset:-140px}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-shell:before{background:radial-gradient(circle at top right,color-mix(in srgb,var(--rlh-accent-color)24%,transparent)0%,transparent 60%),radial-gradient(circle at bottom left,color-mix(in srgb,var(--rlh-green)18%,transparent)0%,transparent 65%)}}#regex-lore-hub-panel .rlh-shell:before{opacity:.32;pointer-events:none}@media (max-width:768px){#regex-lore-hub-panel .rlh-shell{border-radius:14px;padding:.55rem}}@media (min-width:1360px){#regex-lore-hub-panel .rlh-shell{border-radius:20px;padding:1.05rem 1.3rem}}.rlh-shell-header{justify-content:space-between;align-items:center;gap:.55rem;padding-block:.08rem;display:flex}.rlh-shell-title{flex-direction:column;gap:.18rem;display:flex}.rlh-shell-title h4{color:var(--rlh-text-color);margin:0;font-size:clamp(1rem,2vw,1.3rem);font-weight:600;line-height:1.2}.rlh-shell-meta{color:var(--rlh-em-color);align-items:center;gap:.35rem;font-size:max(.8125rem,13px);line-height:1.2;display:inline-flex;margin:0!important}.rlh-shell-version{background:var(--rlh-accent-color);border-radius:9999px;align-items:center;padding:.1rem .55rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-shell-version{background:color-mix(in srgb,var(--rlh-accent-color)16%,transparent)}}.rlh-shell-version{color:var(--rlh-text-color);font-size:.78rem;font-weight:600}.rlh-shell-dot{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-shell-dot{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-shell-dot{font-size:max(.8125rem,13px);line-height:1}.rlh-shell-updated{color:var(--rlh-em-color);font-size:.78rem}.rlh-shell-actions{align-items:center;gap:.4rem;display:flex}.rlh-shell-right{align-items:center;gap:.6rem;margin-left:auto;display:flex}.rlh-prefetch-indicator{text-align:right;flex-direction:column;align-items:flex-end;gap:.35rem;width:clamp(200px,34vw,320px);display:none}.rlh-prefetch-indicator[data-visible=true]{display:flex}.rlh-prefetch-text{color:var(--rlh-em-color);white-space:normal;font-size:.78rem}#rlh-prefetch-progress-text{width:100%}.rlh-prefetch-bar{background:var(--rlh-accent-color);border-radius:9999px;width:100%;height:4px;position:relative}@supports (color:color-mix(in lab, red, red)){.rlh-prefetch-bar{background:color-mix(in srgb,var(--rlh-accent-color)20%,transparent)}}.rlh-prefetch-bar{overflow:hidden}.rlh-prefetch-bar-inner{border-radius:inherit;background:var(--rlh-accent-color);width:0%;height:100%;transition:width .25s;display:block}.rlh-icon-button,.rlh-close-button{width:2.25rem;height:2.25rem;color:var(--rlh-text-color);cursor:pointer;background-color:#0000;border:1px solid #0000;border-radius:9999px;justify-content:center;align-items:center;transition:color .2s,background-color .2s,border-color .2s;display:inline-flex}.rlh-icon-button:hover,.rlh-close-button:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-icon-button:hover,.rlh-close-button:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-theme-toggle{border:1px solid var(--rlh-accent-color);border-radius:9999px;align-items:center;gap:.35rem;padding:.4rem .9rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle{border:1px solid color-mix(in srgb,var(--rlh-accent-color)28%,transparent)}}.rlh-theme-toggle{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle{background-color:color-mix(in srgb,var(--rlh-accent-color)12%,transparent)}}.rlh-theme-toggle{color:var(--rlh-text-color);cursor:pointer;font-size:.85rem;font-weight:500;transition:background-color .2s,color .2s,border-color .2s}.rlh-theme-toggle:hover{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)18%,transparent)}}.rlh-tab-nav{background-color:var(--rlh-header-bg);flex-wrap:wrap;gap:.4rem;padding:.35rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-tab-nav{background-color:color-mix(in srgb,var(--rlh-header-bg)85%,transparent)}}.rlh-tab-nav{border:1px solid var(--rlh-border-color);border-radius:9999px}@supports (color:color-mix(in lab, red, red)){.rlh-tab-nav{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-tab{color:var(--rlh-em-color);cursor:pointer;border-radius:9999px;justify-content:center;align-items:center;gap:.55rem;padding:.4rem 1.1rem;font-size:.9rem;font-weight:500;transition:color .2s,background-color .2s,transform .2s;display:inline-flex}.rlh-tab:hover{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color)}.rlh-tab.active{background-color:var(--rlh-selected-bg);color:var(--rlh-text-color);box-shadow:inset 0 0 0 1px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-tab.active{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)60%,transparent)}}.rlh-tab-text-short{display:none}@media (max-width:640px){.rlh-tab-text-full{display:none}.rlh-tab-text-short{display:inline}}.rlh-main-area{flex-direction:column;flex:auto;gap:clamp(.6rem,1.4vw,1rem);width:100%;min-height:0;padding:0;display:flex}.rlh-toolbar-shell{flex-direction:column;gap:clamp(.6rem,1.3vw,.95rem);width:100%;display:flex}.rlh-toolbar-container,.rlh-replace-container{flex-direction:column;gap:clamp(.65rem,1.1vw,.9rem);display:flex}.rlh-toolbar-inner{background-color:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:clamp(.125rem,.3vw,.25rem);padding:clamp(.25rem,.5vw,.4rem);display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{background-color:color-mix(in srgb,var(--rlh-surface-color)95%,var(--rlh-accent-color)5%)}}.rlh-toolbar-inner{border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{border:1px solid color-mix(in srgb,var(--rlh-accent-color)24%,var(--rlh-border-color))}}.rlh-toolbar-inner{box-shadow:0 16px 42px -34px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{box-shadow:0 16px 42px -34px color-mix(in srgb,var(--rlh-shadow-color)78%,transparent)}}@media (max-width:768px){.rlh-toolbar-inner{border-radius:14px;padding:.55rem}.rlh-toolbar-section{gap:.4rem;padding:.45rem}}@media (min-width:1360px){.rlh-toolbar-inner{gap:1.1rem;padding:1.05rem 1.3rem}.rlh-toolbar-section{gap:.8rem;padding:.6rem .8rem}}.rlh-toolbar-section{background-color:#0000;border:none;border-radius:12px;flex-direction:column;gap:clamp(.1rem,.3vw,.2rem);padding:clamp(.1rem,.25vw,.2rem);display:flex}.rlh-toolbar-section--search,.rlh-toolbar-section--actions,.rlh-toolbar-section--multiselect{background-color:#0000}.rlh-toolbar-section--actions{flex-direction:row;align-items:center}.rlh-search-section-grid{flex-wrap:nowrap;align-items:stretch;gap:clamp(.25rem,.7vw,.5rem);display:flex}.rlh-search-section-main{flex:18rem;min-width:0}.rlh-search-section-multiselect{flex:0 14rem;justify-content:flex-start;align-items:flex-start;min-width:10rem;max-width:20rem;padding:5px 0 0;display:flex}.rlh-search-section-multiselect .rlh-multi-select-module{flex-direction:column;align-items:flex-start;gap:.25rem;width:100%;display:flex}.rlh-toolbar-section--actions .rlh-toolbar-actions{flex-wrap:wrap;justify-content:flex-start;align-items:center;gap:clamp(.25rem,.6vw,.45rem);width:100%;display:flex;overflow:visible}.rlh-toolbar-section--actions .rlh-toolbar-actions>*{flex-shrink:0}@media (max-width:960px){.rlh-search-section-grid{flex-direction:column}.rlh-search-section-main,.rlh-search-section-multiselect{flex:100%;max-width:none}.rlh-search-box{grid-template-columns:minmax(0,1fr);grid-template-areas:\"row\"\"replace\"\"meta\"}.rlh-replace-body{grid-template-columns:minmax(0,1fr) auto}}.rlh-content-pane{flex-direction:column;flex:auto;gap:clamp(.8rem,1.6vw,1.2rem);min-height:0;padding:0;display:flex}.rlh-content-pane>*{min-width:0}@media (max-width:768px){.rlh-content-pane{gap:.6rem}}.rlh-toolbar-btn{border:1px solid var(--rlh-accent-color);border-radius:12px;justify-content:flex-start;align-items:center;gap:.35rem;padding:.125rem .75rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{border:1px solid color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}.rlh-toolbar-btn{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-toolbar-btn{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{color:color-mix(in srgb,var(--rlh-text-color)90%,var(--rlh-accent-color)10%)}}.rlh-toolbar-btn{cursor:pointer;box-shadow:inset 0 0 0 1px var(--rlh-accent-color);font-size:.9rem;font-weight:500}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)25%,transparent)}}.rlh-toolbar-btn{transition:color .2s,background-color .2s,border-color .2s,box-shadow .2s,transform .2s}.rlh-toolbar-icon-btn{border:1px solid var(--rlh-accent-color);border-radius:12px;justify-content:center;align-items:center;width:2.1rem;height:2.1rem;padding:0;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{border:1px solid color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}.rlh-toolbar-icon-btn{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-toolbar-icon-btn{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{color:color-mix(in srgb,var(--rlh-text-color)90%,var(--rlh-accent-color)10%)}}.rlh-toolbar-icon-btn{cursor:pointer;line-height:1;transition:color .2s,background-color .2s,border-color .2s,box-shadow .2s,transform .2s}.rlh-toolbar-icon-btn i{font-size:.95rem}.rlh-toolbar-icon-btn:hover{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)92%,var(--rlh-accent-color)20%)}}.rlh-toolbar-icon-btn:hover{color:var(--rlh-text-color)}.rlh-toolbar-icon-btn:focus{box-shadow:0 0 0 2px var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:focus{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-search-row .rlh-toolbar-icon-btn,.rlh-replace-body .rlh-toolbar-icon-btn{width:2rem;height:2rem}.rlh-toolbar-btn i{font-size:.95rem}.rlh-toggle-btn i,.rlh-action-btn-icon i,.rlh-toolbar-btn i{transition:transform .25s}.rlh-toolbar-btn span{white-space:nowrap}.rlh-toggle-btn:hover i,.rlh-action-btn-icon:hover i,.rlh-toolbar-btn:hover i{transform:translateY(-1px)scale(1.08)}.rlh-toolbar-group--leading .rlh-toolbar-btn,.rlh-toolbar-group--actions .rlh-toolbar-btn{width:100%}.rlh-toolbar-btn:hover{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)26%,var(--rlh-surface-color))}}.rlh-toolbar-btn:hover{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-border-color)30%)}}.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px var(--rlh-accent-color),0 10px 22px -16px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent),0 10px 22px -16px var(--rlh-shadow-color)}}.rlh-toolbar-btn:hover{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{color:color-mix(in srgb,var(--rlh-text-color)85%,var(--rlh-accent-color)15%)}}.rlh-toolbar-btn:hover{transform:translateY(-1px)scale(1.01)}.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{cursor:not-allowed;opacity:.55;box-shadow:none;border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{border-color:color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{color:color-mix(in srgb,var(--rlh-text-color)75%,var(--rlh-accent-color)5%)}}.rlh-toolbar-btn:focus-visible{box-shadow:0 0 0 2px var(--rlh-accent-color),inset 0 0 0 1.5px var(--rlh-accent-color);outline:none;animation:1.1s ease-out rlhSoftPulse}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:focus-visible{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)40%,transparent),inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-toolbar-btn.active{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{background-color:color-mix(in srgb,var(--rlh-accent-color)32%,var(--rlh-surface-color))}}.rlh-toolbar-btn.active{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{border-color:color-mix(in srgb,var(--rlh-accent-color)75%,var(--rlh-border-color)25%)}}.rlh-toolbar-btn.active{box-shadow:inset 0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)50%,transparent)}}.rlh-toolbar-btn.active{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-search-field{border:1px solid var(--rlh-border-color);border-radius:12px;align-items:center;gap:0;width:100%;min-width:0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-field{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-field{background-color:var(--rlh-input-bg);transition:border-color .2s,box-shadow .2s,color .2s;overflow:hidden}.rlh-search-row{grid-area:row;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:.125rem;width:100%;display:grid}.rlh-search-box{border:1px solid var(--rlh-border-color);border-radius:12px;grid-template-columns:minmax(0,1fr) auto;grid-template-areas:\"row replace\"\"meta meta\";gap:.125rem;padding:.2rem .3rem;display:grid}@supports (color:color-mix(in lab, red, red)){.rlh-search-box{border:1px solid color-mix(in srgb,var(--rlh-border-color)45%,transparent)}}.rlh-search-box{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-box{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,transparent)}}.rlh-search-box{box-shadow:0 8px 28px -24px var(--rlh-shadow-color)}.rlh-search-field .rlh-search-input{min-width:0;color:inherit;background:0 0;border:none;flex:auto;padding:.4rem .6rem;font-size:1rem}.rlh-search-field .rlh-search-input:focus{box-shadow:none;border:none;outline:none}.rlh-search-field:focus-within{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-field:focus-within{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-search-field:focus-within{box-shadow:var(--rlh-focus-ring);color:var(--rlh-text-color)}.rlh-search-meta{color:var(--rlh-em-color);flex-direction:row;grid-area:meta;align-items:center;gap:.4rem;font-size:.85rem;display:flex}.rlh-search-scope{color:var(--rlh-accent-color);font-weight:500}@supports (color:color-mix(in lab, red, red)){.rlh-search-scope{color:color-mix(in srgb,var(--rlh-accent-color)65%,var(--rlh-text-color))}}@media (max-width:1200px){.rlh-search-section-grid{flex-direction:column}.rlh-search-section-main,.rlh-search-section-multiselect{flex:100%;max-width:none}.rlh-search-box{grid-template-columns:minmax(0,1fr);grid-template-areas:\"row\"\"replace\"\"meta\"}.rlh-replace-body{grid-template-columns:minmax(0,1fr) auto}.rlh-search-meta{flex-wrap:wrap;justify-content:flex-start;gap:.35rem}}.rlh-sort-menu,.rlh-position-menu{align-items:center;width:auto;min-width:0;margin-left:auto;display:inline-flex;position:relative}.rlh-unified-status{align-items:stretch;min-width:0;display:inline-flex;position:relative}.rlh-unified-status-menu{border:1px solid var(--rlh-border-color);border-radius:12px;flex-direction:column;gap:.15rem;min-width:12rem;padding:.5rem;display:flex;position:absolute;top:calc(100% + .5rem);right:0}@supports (color:color-mix(in lab, red, red)){.rlh-unified-status-menu{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-unified-status-menu{background:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-unified-status-menu{background:color-mix(in srgb,var(--rlh-surface-color)95%,transparent)}}.rlh-unified-status-menu{box-shadow:0 24px 60px -28px var(--rlh-shadow-color);opacity:0;pointer-events:none;z-index:30;transition:opacity .18s,transform .18s;transform:translateY(8px)}.rlh-unified-status[data-open=true] .rlh-unified-status-menu{opacity:1;pointer-events:auto;transform:translate(0)}.rlh-unified-status-option{width:100%;color:inherit;cursor:pointer;background:0 0;border:none;border-radius:10px;justify-content:space-between;align-items:center;gap:.6rem;padding:.45rem .5rem;font-size:.85rem;font-weight:500;transition:background-color .18s,color .18s;display:flex}.rlh-unified-status-option:hover,.rlh-unified-status-option:focus-visible{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-unified-status-option:hover,.rlh-unified-status-option:focus-visible{background:color-mix(in srgb,var(--rlh-hover-bg)75%,transparent)}}.rlh-unified-status-option:hover,.rlh-unified-status-option:focus-visible{outline:none}.rlh-unified-status-option__label{text-align:right;flex:auto;min-width:0}.rlh-sort-menu-list,.rlh-position-menu-list{background-color:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);border-radius:14px;min-width:10rem;padding:.5rem;list-style:none;position:absolute;top:calc(100% + .5rem);right:0}@supports (color:color-mix(in lab, red, red)){.rlh-sort-menu-list,.rlh-position-menu-list{border:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-sort-menu-list,.rlh-position-menu-list{box-shadow:0 24px 60px -36px var(--rlh-shadow-color);z-index:99;opacity:0;visibility:hidden;pointer-events:none;transition:opacity var(--rlh-default-transition-duration)var(--rlh-default-transition-timing-function),transform var(--rlh-default-transition-duration)var(--rlh-default-transition-timing-function),visibility 0s linear var(--rlh-default-transition-duration);will-change:opacity,transform;flex-direction:column;gap:.35rem;display:flex;transform:translateY(6px)scale(.98)}.rlh-toolbar-group--actions .rlh-sort-menu-list,.rlh-toolbar-group--actions .rlh-position-menu-list{left:0;right:auto}.rlh-sort-menu.open .rlh-sort-menu-list,.rlh-position-menu.open .rlh-position-menu-list{opacity:1;visibility:visible;pointer-events:auto;transition-delay:0s,0s,0s;transform:translateY(0)scale(1)}.rlh-sort-option,.rlh-position-option{width:100%;color:var(--rlh-text-color);cursor:pointer;background-color:#0000;border:1px solid #0000;border-radius:10px;justify-content:space-between;align-items:center;gap:.4rem;padding:.4rem .6rem;font-size:.9rem;transition:background-color .2s,border-color .2s,color .2s;display:flex}.rlh-sort-option:hover,.rlh-position-option:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option:hover,.rlh-position-option:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-sort-option.active,.rlh-position-option.active{background-color:var(--rlh-selected-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option.active,.rlh-position-option.active{border-color:color-mix(in srgb,var(--rlh-accent-color)60%,transparent)}}.rlh-sort-option.active,.rlh-position-option.active{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option.active,.rlh-position-option.active{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-replace-body{grid-area:replace;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:.25rem;width:100%;display:grid}.rlh-info-text{color:var(--rlh-em-color);font-size:.9rem}@supports (color:color-mix(in lab, red, red)){.rlh-info-text{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-info-text{margin:.5rem 0}.rlh-info-text-small{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}@supports (color:color-mix(in lab, red, red)){.rlh-info-text-small{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-chat-lore-empty{text-align:center;background-color:var(--rlh-hover-bg);border-radius:16px;flex-direction:column;justify-content:center;align-items:center;gap:1rem;padding:2rem 1.5rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-chat-lore-empty{background-color:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}.rlh-chat-lore-empty{border:1px dashed var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-chat-lore-empty{border:1px dashed color-mix(in srgb,var(--rlh-border-color)75%,transparent)}}.rlh-detail-view{background-color:var(--rlh-surface-color);border-radius:18px;flex-direction:column;gap:.6rem;padding:.6rem .8rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-detail-view{background-color:color-mix(in srgb,var(--rlh-surface-color)94%,transparent)}}.rlh-detail-view{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-detail-view{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-detail-view{box-shadow:0 24px 70px -50px var(--rlh-shadow-color)}@media (max-width:768px){.rlh-detail-view{gap:.6rem;padding:.6rem .8rem}.rlh-detail-header{gap:.4rem;padding:.4rem .6rem}.rlh-detail-content{gap:.4rem}.rlh-entry-list-wrapper{gap:.4rem;padding:.4rem 0}.rlh-detail-header h2{font-size:1rem;line-height:1.1}}.rlh-detail-header{grid-template-columns:auto 1fr auto;align-items:center;gap:.4rem;padding:.4rem .6rem;display:grid}.rlh-detail-header h2{color:var(--rlh-text-color);text-align:center;white-space:nowrap;text-overflow:ellipsis;min-width:0;margin:0;padding-inline:.5rem;font-size:1.1rem;font-weight:600;overflow:hidden}.rlh-detail-header .rlh-back-to-list-btn{justify-self:start}.rlh-detail-header .rlh-item-controls{justify-self:end;align-items:center;gap:.4rem;display:inline-flex}.rlh-detail-content,.rlh-entry-list-wrapper{flex-direction:column;gap:.4rem;display:flex}.rlh-entry-list-wrapper .rlh-item-container{animation:.3s ease-out both rlhFadeListItem}@keyframes rlhFadeListItem{0%{opacity:0;transform:translateY(6px)scale(.95)}to{opacity:1;transform:translateY(0)scale(1)}}.rlh-regex-list{flex-direction:column;gap:.45rem;display:flex;position:relative}.rlh-regex-list.sorting-active{border:1.5px dashed var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{border:1.5px dashed color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}.rlh-regex-list.sorting-active{box-shadow:0 0 0 3px var(--rlh-accent-color),0 20px 50px -30px var(--rlh-shadow-color);border-radius:14px;padding:.35rem .45rem}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-accent-color)12%,transparent),0 20px 50px -30px var(--rlh-shadow-color)}}.rlh-regex-list.sorting-active{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{background:color-mix(in srgb,var(--rlh-hover-bg)45%,transparent)}}.rlh-regex-list.sorting-active .rlh-item-container{border-radius:12px}.rlh-regex-list .sortable-ghost{opacity:.2;transform:scale(.98)}.rlh-regex-list .sortable-chosen{box-shadow:0 18px 40px -28px var(--rlh-shadow-color);transform:rotate(.4deg)}.rlh-sorting-fallback{opacity:.7!important;transform:scale(1.02)!important}.rlh-entry-list-wrapper>*{margin:0}.rlh-order-indicator{background-color:var(--rlh-hover-bg);min-width:1.75rem;color:var(--rlh-accent-color);border-radius:9999px;justify-content:center;align-items:center;padding:.1rem .5rem;font-size:max(.8125rem,13px);font-weight:600;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-order-indicator{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-selection-control{justify-content:center;align-items:center;margin-right:.35rem;display:inline-flex}.rlh-selection-control input{cursor:pointer;width:1rem;height:1rem;accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-selection-control input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}.rlh-drag-handle{color:var(--rlh-em-color);justify-content:center;align-items:center;margin-right:.35rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-drag-handle{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-drag-handle{cursor:grab}.rlh-drag-handle:active{cursor:grabbing}.rlh-editor-group{border-top:1px solid var(--rlh-border-color);flex-direction:column;gap:.6rem;padding:.75rem 0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-editor-group{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-editor-group:first-of-type{border-top:none;padding-top:0}.rlh-editor-group h5{color:var(--rlh-em-color);font-size:.85rem;font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-editor-group h5{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-editor-grid{grid-template-columns:repeat(auto-fit,minmax(14rem,1fr));gap:.6rem;display:grid}.rlh-grid-item,.rlh-depth-container{flex-direction:column;gap:.4rem;display:flex}.rlh-depth-inputs{flex-wrap:wrap;gap:.6rem;display:flex}.rlh-editor-options-row{flex-wrap:wrap;gap:.4rem;display:flex}.rlh-editor-option-item{background-color:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.35rem;padding:.35rem .65rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-editor-option-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}.rlh-editor-option-item{color:var(--rlh-em-color);font-size:.85rem}.rlh-editor-option-item input{accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-editor-option-item input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}.rlh-select-nudge{min-width:8rem}.rlh-rename-ui{width:100%}.rlh-rename-input-wrapper{border:1px solid var(--rlh-border-color);border-radius:12px;align-items:center;gap:.4rem;width:100%;padding:.4rem .6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-rename-input-wrapper{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-rename-input-wrapper{background-color:var(--rlh-input-bg)}.rlh-rename-input{color:var(--rlh-text-color);background:0 0;border:none;outline:none;flex:1;font-size:.9rem}.rlh-rename-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)75%,transparent)}}.rlh-rename-save-btn{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-save-btn{border-color:color-mix(in srgb,var(--rlh-green)55%,transparent)}}.rlh-rename-cancel-btn{color:var(--rlh-red);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-cancel-btn{border-color:color-mix(in srgb,var(--rlh-red)55%,transparent)}}.rlh-global-toggle,.rlh-item-toggle{transition:background-color .2s,border-color .2s,color .2s}.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{border-color:color-mix(in srgb,var(--rlh-green)65%,transparent)}}.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{background-color:var(--rlh-green-bg)}.rlh-clickable-header{cursor:pointer}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{box-shadow:0 36px 120px -60px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{box-shadow:0 36px 120px -60px color-mix(in srgb,var(--rlh-accent-color)30%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{color:color-mix(in srgb,var(--rlh-accent-color)65%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{font-size:max(.8125rem,13px)}.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{box-shadow:0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-item-container.rlh-collapsed .rlh-item-header,.rlh-book-group.rlh-collapsed .rlh-global-book-header{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.rlh-collapsed .rlh-item-header,.rlh-book-group.rlh-collapsed .rlh-global-book-header{background-color:color-mix(in srgb,var(--rlh-hover-bg)45%,transparent)}}.sortable-ghost{opacity:.75;background-color:var(--rlh-selected-bg)}@supports (color:color-mix(in lab, red, red)){.sortable-ghost{background-color:color-mix(in srgb,var(--rlh-selected-bg)85%,transparent)}}.sortable-ghost{border:1px dashed var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.sortable-ghost{border:1px dashed color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}.rlh-search-controls{flex-wrap:wrap;align-items:center;gap:.7rem;display:flex}#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{border:1px solid var(--rlh-border-color);border-radius:12px;width:100%;min-width:0;padding:.4rem .6rem}@supports (color:color-mix(in lab, red, red)){#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);font-size:1rem;transition:border-color .2s,box-shadow .2s}#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{box-shadow:var(--rlh-focus-ring)}#rlh-search-input::placeholder,.rlh-search-input::placeholder,#rlh-replace-input::placeholder,.rlh-replace-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){#rlh-search-input::placeholder,.rlh-search-input::placeholder,#rlh-replace-input::placeholder,.rlh-replace-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-multi-select-module{flex-direction:column;align-items:flex-start;gap:.25rem;display:flex}.rlh-search-action-btn,.rlh-multi-select-action-btn{border:1px solid var(--rlh-border-color);border-radius:10px;justify-content:center;align-items:center;gap:.2rem;padding:.3rem .5rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-action-btn,.rlh-multi-select-action-btn{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-action-btn,.rlh-multi-select-action-btn{color:var(--rlh-text-color);cursor:pointer;background:0 0;font-size:.78rem;line-height:1;transition:color .2s,background-color .2s,border-color .2s,transform .2s}.rlh-multi-select-action-btn:active{transform:scale(.95)}.rlh-search-action-btn:hover,.rlh-multi-select-action-btn:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-action-btn:hover,.rlh-multi-select-action-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-multi-select-actions{flex-wrap:nowrap;align-items:center;gap:.3rem;display:inline-flex}.rlh-multi-select-action-btn.enable{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.enable{border-color:color-mix(in srgb,var(--rlh-green)60%,transparent)}}.rlh-multi-select-action-btn.enable{background-color:var(--rlh-green-bg)}.rlh-multi-select-action-btn.disable{color:var(--rlh-red);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.disable{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-multi-select-action-btn.disable{background-color:var(--rlh-red-bg)}#rlh-search-filters-container,.rlh-filter-list{flex-wrap:wrap;gap:.6rem;display:flex}.rlh-filter-item{background-color:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.4rem;padding:.4rem .65rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)65%,transparent)}}.rlh-filter-item{color:var(--rlh-em-color);font-size:.85rem}.rlh-filter-item input{accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}#rlh-multi-select-controls{align-items:center;gap:.35rem;display:none}#rlh-multi-select-controls.active{flex-wrap:wrap;display:flex}@media (max-width:960px){.rlh-multi-select-module{align-items:stretch;gap:.35rem}#rlh-multi-select-controls{flex-wrap:wrap;justify-content:flex-start;align-items:flex-start}.rlh-multi-select-actions{flex-wrap:wrap;justify-content:flex-start}}.rlh-content-pane{-webkit-overflow-scrolling:touch;scrollbar-gutter:stable both-edges;flex-direction:column;flex:auto;gap:1rem;min-height:0;padding-right:.25rem;display:flex;overflow:hidden auto}#regex-lore-hub-panel-content{-webkit-overflow-scrolling:touch;scrollbar-gutter:stable both-edges;scroll-behavior:smooth;flex:auto;min-height:clamp(18rem,48vh,32rem);padding-right:clamp(.25rem,.8vw,.5rem);display:block;overflow:hidden auto}#regex-lore-hub-panel-content>*+*{margin-top:clamp(.8rem,1.4vw,1.1rem)}#regex-lore-hub-panel-content::-webkit-scrollbar{width:6px}#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{background-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{border-radius:9999px}.rlh-book-group,.rlh-item-container{border:1px solid var(--rlh-border-color);border-radius:16px;flex-direction:column;min-height:0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-book-group,.rlh-item-container{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{background-color:color-mix(in srgb,var(--rlh-surface-color)94%,transparent)}}.rlh-book-group,.rlh-item-container{box-shadow:0 18px 50px -40px var(--rlh-shadow-color);overflow:hidden}.rlh-book-group-header{justify-content:center;align-items:center;padding:.85rem 1rem;display:flex;position:relative}.rlh-book-group-title{color:var(--rlh-text-color);text-align:center;white-space:nowrap;text-overflow:ellipsis;max-width:calc(100% - 8rem);margin:0;font-size:1.1rem;font-weight:600;overflow:hidden}.rlh-book-group-header .rlh-item-controls{align-items:center;gap:.4rem;display:inline-flex;position:absolute;top:50%;right:1rem;transform:translateY(-50%)}.rlh-global-book-header,.rlh-item-header{cursor:pointer;justify-content:flex-start;align-items:center;gap:.6rem;padding:.85rem 1rem;transition:background-color .2s,border-color .2s;display:flex}.rlh-global-book-header{flex-wrap:wrap;align-items:flex-start}.rlh-global-book-header .rlh-book-title-wrapper{flex:auto;min-width:0}.rlh-global-book-header .rlh-item-name{white-space:normal;word-break:break-word;flex:0 auto;min-width:0}.rlh-global-book-header .rlh-book-stats{white-space:nowrap}.rlh-global-book-header .rlh-item-controls{flex:none;margin-top:.1rem;margin-left:auto}.rlh-global-book-header.enabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{color:color-mix(in srgb,var(--rlh-text-color)70%,var(--rlh-accent-color)30%)}}.rlh-global-book-header.enabled{background:linear-gradient(135deg,var(--rlh-accent-color)0%,var(--rlh-accent-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{background:linear-gradient(135deg,color-mix(in srgb,var(--rlh-accent-color)32%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-accent-color)18%,var(--rlh-surface-color))100%)}}.rlh-global-book-header.enabled{box-shadow:0 18px 45px -30px var(--rlh-accent-color),inset 0 0 0 1px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{box-shadow:0 18px 45px -30px color-mix(in srgb,var(--rlh-accent-color)50%,transparent),inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-global-book-header.enabled .rlh-item-name{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled .rlh-item-name{color:color-mix(in srgb,var(--rlh-accent-color)85%,var(--rlh-text-color))}}.rlh-global-book-header.enabled .rlh-book-stats{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled .rlh-book-stats{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-em-color))}}.rlh-global-book-header.enabled:hover{background:linear-gradient(135deg,var(--rlh-accent-color)0%,var(--rlh-accent-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled:hover{background:linear-gradient(135deg,color-mix(in srgb,var(--rlh-accent-color)38%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-accent-color)22%,var(--rlh-surface-color))100%)}}.rlh-global-book-header:hover,.rlh-item-header:hover{background-color:var(--rlh-hover-bg)}.rlh-item-header-main{flex:auto;align-items:center;gap:.5rem;min-width:0;display:flex}.rlh-item-title-row{flex-wrap:wrap;align-items:center;gap:.45rem;display:inline-flex}.rlh-status-badge{--badge-color:var(--rlh-accent-color);letter-spacing:.01em;background:var(--badge-color);border-radius:999px;align-items:center;gap:.35rem;padding:.15rem .55rem;font-size:.75rem;font-weight:600;line-height:1;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-status-badge{background:color-mix(in srgb,var(--badge-color)18%,transparent)}}.rlh-status-badge{color:var(--badge-color)}@supports (color:color-mix(in lab, red, red)){.rlh-status-badge{color:color-mix(in srgb,var(--badge-color)80%,white 5%)}}.rlh-status-badge{white-space:nowrap}.rlh-status-badge i{font-size:.55rem}.rlh-status-badge__text{display:inline-block;transform:translateY(.5px)}.rlh-status-badge--constant{--badge-color:var(--rlh-status-constant)}.rlh-status-badge--selective{--badge-color:var(--rlh-status-selective)}.rlh-status-badge--vectorized{--badge-color:var(--rlh-status-vectorized)}.rlh-item-name{color:var(--rlh-text-color);flex-shrink:0;font-size:.95rem;font-weight:500}@media (max-width:720px){.rlh-item-header{flex-wrap:wrap;align-items:flex-start;gap:.45rem;padding:.7rem .75rem}.rlh-item-header-main{flex-direction:column;align-items:flex-start;gap:.3rem;width:100%}.rlh-item-name{text-overflow:ellipsis;white-space:nowrap;flex:auto;min-width:0;max-width:100%;overflow:hidden}.rlh-book-group-header{justify-content:flex-start;align-items:flex-start}.rlh-book-group-title{text-align:left;width:100%;max-width:100%}.rlh-item-controls{flex-direction:row;justify-content:flex-end;align-self:flex-start;align-items:center;gap:.18rem;width:auto}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{border-width:1px;border-radius:.6rem;width:1.55rem;height:1.55rem;padding:0}.rlh-item-controls .rlh-toggle-btn i,.rlh-item-controls .rlh-action-btn-icon i{font-size:max(.8125rem,13px)}.rlh-detail-header .rlh-item-controls{justify-self:flex-end}.rlh-book-group-header .rlh-item-controls{justify-content:flex-end;align-items:center;margin-top:.25rem;margin-left:auto;position:static;transform:none}.rlh-item-meta{gap:.25rem;font-size:.74rem}.rlh-item-meta-chip{gap:.2rem;padding:.12rem .45rem}}.rlh-item-meta{color:var(--rlh-em-color);flex-wrap:wrap;align-items:center;gap:.35rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta{color:color-mix(in srgb,var(--rlh-em-color)92%,transparent)}}.rlh-item-meta{font-size:.78rem}.rlh-item-meta-chip{background:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.25rem;padding:.15rem .55rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)70%,transparent)}}.rlh-item-meta-chip{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip{border:1px solid color-mix(in srgb,var(--rlh-border-color)50%,transparent)}}.rlh-item-meta-chip{line-height:1.2}.rlh-item-meta-chip i{color:var(--rlh-accent-color);font-size:.7rem}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip i{color:color-mix(in srgb,var(--rlh-accent-color)75%,var(--rlh-em-color))}}#regex-lore-hub-panel.dark .rlh-item-meta-chip{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}#regex-lore-hub-panel.dark .rlh-item-meta-chip{border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-item-meta-chip{border-color:color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-item-controls{flex-wrap:wrap;align-items:center;gap:.35rem;margin-left:auto;display:inline-flex}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{flex-shrink:0}@media (max-width:960px){.rlh-item-controls{gap:.28rem}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:2rem;height:2rem}}@media (max-width:900px) and (min-width:721px){.rlh-item-controls{flex-direction:column;align-items:flex-end;gap:.22rem;width:auto}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:1.75rem;height:1.75rem}.rlh-item-name{flex:auto;min-width:0;max-width:100%}}.rlh-toggle-btn,.rlh-action-btn-icon{border:1px solid var(--rlh-border-color);border-radius:9999px;justify-content:center;align-items:center;width:2.25rem;height:2.25rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toggle-btn,.rlh-action-btn-icon{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-toggle-btn,.rlh-action-btn-icon{color:var(--rlh-em-color);cursor:pointer;background:0 0;transition:color .2s,background-color .2s,border-color .2s,transform .2s}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{transform:translateY(-1px)scale(1.03)}.rlh-item-container.enabled .rlh-item-name,.rlh-book-group.enabled .rlh-item-name{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.enabled .rlh-item-name,.rlh-book-group.enabled .rlh-item-name{color:color-mix(in srgb,var(--rlh-accent-color)80%,var(--rlh-text-color))}}.rlh-collapsible-content{border-top:1px solid var(--rlh-border-color);margin-top:.75rem;padding:0 1rem 1rem;display:none}@supports (color:color-mix(in lab, red, red)){.rlh-collapsible-content{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-collapsible-content{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-collapsible-content{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,transparent)}}.rlh-entry-actions{border-bottom:1px dashed var(--rlh-border-color);flex-wrap:wrap;gap:.6rem;padding:.9rem 1rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-entry-actions{border-bottom:1px dashed color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-action-btn{background-color:var(--rlh-accent-color);color:#fff;cursor:pointer;border:none;border-radius:12px;justify-content:center;align-items:center;gap:.4rem;padding:.55rem 1rem;font-size:.9rem;font-weight:500;transition:transform .2s,opacity .2s;display:inline-flex}.rlh-action-btn:hover{opacity:.9}.rlh-action-btn.rlh-maximize-btn{border:1px solid var(--rlh-em-color);background:0 0}@supports (color:color-mix(in lab, red, red)){.rlh-action-btn.rlh-maximize-btn{border:1px solid color-mix(in srgb,var(--rlh-em-color)45%,transparent)}}.rlh-action-btn.rlh-maximize-btn{color:var(--rlh-em-color)}.rlh-editor-wrapper{flex-direction:column;gap:1rem;display:flex}.rlh-editor-field{flex-direction:column;gap:.35rem;display:flex}.rlh-editor-field label{background-color:var(--rlh-header-bg);padding:.55rem .85rem;display:block}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field label{background-color:color-mix(in srgb,var(--rlh-header-bg)82%,transparent)}}.rlh-editor-field label{border-bottom:1px solid var(--rlh-border-color);border-radius:12px 12px 0 0}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field label{border-bottom:1px solid color-mix(in srgb,var(--rlh-border-color)68%,transparent)}}.rlh-editor-field label{color:var(--rlh-text-color);margin:0;font-size:.875rem;font-weight:600;line-height:1.3}.rlh-editor-field label+*{border-top-left-radius:0;border-top-right-radius:0;margin-top:0}.rlh-viewer-field{gap:0}.rlh-regex-viewer{grid-template-columns:repeat(auto-fit,minmax(14rem,1fr));gap:.75rem;display:grid}.rlh-regex-viewer>.rlh-editor-field:nth-child(-n+2){grid-column:1/-1}.rlh-entry-viewer{flex-direction:column;gap:.75rem;display:flex}.rlh-viewer-field label{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-field label{background-color:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}.rlh-viewer-field label{border-bottom-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-field label{border-bottom-color:color-mix(in srgb,var(--rlh-accent-color)28%,transparent)}}.rlh-viewer-text{border:1px solid var(--rlh-border-color);padding:.6rem .85rem}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-text{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-viewer-text{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);white-space:pre-wrap;border-top:none;border-radius:0 0 12px 12px;line-height:1.5}.rlh-viewer-text>article{margin:0}.rlh-editor-field .rlh-edit-content,.rlh-editor-field article{border-top:none;border-radius:0 0 12px 12px;margin-top:0}#regex-lore-hub-panel.dark .rlh-editor-field label{background-color:var(--rlh-header-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-editor-field label{background-color:color-mix(in srgb,var(--rlh-header-bg)70%,transparent)}}#regex-lore-hub-panel.dark .rlh-editor-field label{border-bottom-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-editor-field label{border-bottom-color:color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-field label{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-field label{background-color:color-mix(in srgb,var(--rlh-hover-bg)70%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-field label{border-bottom-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-field label{border-bottom-color:color-mix(in srgb,var(--rlh-accent-color)32%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-text{border-color:color-mix(in srgb,var(--rlh-border-color)50%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{background-color:var(--rlh-input-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-text{background-color:color-mix(in srgb,var(--rlh-input-bg)90%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{border-top:none}.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{border:1px solid var(--rlh-border-color);border-radius:12px;width:100%;padding:.55rem .75rem}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);transition:border-color .2s,box-shadow .2s}.rlh-editor-field label+:is(input,textarea,select){border-top:none;border-radius:0 0 12px 12px}.rlh-editor-field textarea{resize:vertical;min-height:8rem}.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{box-shadow:var(--rlh-focus-ring)}.rlh-toast-notification,.rlh-progress-toast{background-color:var(--rlh-accent-color);color:#fff;box-shadow:0 24px 120px -40px var(--rlh-shadow-color);opacity:0;pointer-events:none;z-index:10002;border-radius:9999px;padding:.9rem 1.3rem;font-size:.9rem;font-weight:500;transition:opacity .25s,transform .25s;position:fixed;bottom:clamp(1rem,4vw,2rem);left:50%;transform:translate(-50%)translateY(20px)}.rlh-progress-toast{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-progress-toast{background-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-toast-notification.visible,.rlh-progress-toast.visible{opacity:1;animation:.38s cubic-bezier(.3,.7,.4,1.1) both rlhToastIn;transform:translate(-50%)translateY(0)}.rlh-modal-overlay{z-index:10003;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);background:#0206178c;justify-content:center;align-items:center;display:flex;position:fixed;inset:0}.rlh-modal-content{background:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);width:min(420px,90%);box-shadow:0 30px 120px -60px var(--rlh-shadow-color);border-radius:16px;margin:auto;overflow:hidden}.rlh-modal-header{border-bottom:1px solid var(--rlh-border-color);padding:1rem 1.25rem;font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-modal-header{border-bottom:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-body{color:var(--rlh-em-color);flex-direction:column;gap:.6rem;padding:1.1rem 1.25rem;display:flex}.rlh-modal-footer{border-top:1px solid var(--rlh-border-color);justify-content:flex-end;gap:.6rem;padding:.9rem 1.25rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-modal-footer{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-btn{border:1px solid var(--rlh-border-color);border-radius:12px;padding:.55rem 1.1rem}@supports (color:color-mix(in lab, red, red)){.rlh-modal-btn{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-btn{color:var(--rlh-text-color);cursor:pointer;background:0 0;font-weight:500;transition:background-color .2s,border-color .2s}.rlh-modal-btn:hover{background-color:var(--rlh-hover-bg)}.rlh-modal-btn.rlh-modal-ok{background-color:var(--rlh-accent-color);color:#fff;border-color:#0000}.rlh-modal-btn.rlh-modal-cancel{background-color:var(--rlh-red-bg);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-modal-btn.rlh-modal-cancel{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-modal-btn.rlh-modal-cancel{color:var(--rlh-red)}.rlh-loading{background:var(--rlh-surface-color);border-radius:20px;align-items:center;gap:1.25rem;padding:1.4rem 1.6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-loading{background:color-mix(in srgb,var(--rlh-surface-color)96%,transparent)}}.rlh-loading{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-loading{border:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-loading{box-shadow:0 24px 80px -50px var(--rlh-shadow-color)}.rlh-loading-spinner{border:3px solid var(--rlh-em-color);border-radius:9999px;width:2.6rem;height:2.6rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-spinner{border:3px solid color-mix(in srgb,var(--rlh-em-color)35%,transparent)}}.rlh-loading-spinner{border-top-color:var(--rlh-accent-color);animation:.9s linear infinite rlh-spin}.rlh-loading-text{flex-direction:column;flex:1;gap:.55rem;display:flex}.rlh-loading-title{color:var(--rlh-text-color);font-size:.95rem;font-weight:600}.rlh-loading-status{color:var(--rlh-text-color);font-size:.9rem}.rlh-loading-detail{color:var(--rlh-em-color);font-size:.82rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-detail{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-loading-bar{background:var(--rlh-hover-bg);border-radius:9999px;width:100%;height:.4rem;position:relative}@supports (color:color-mix(in lab, red, red)){.rlh-loading-bar{background:color-mix(in srgb,var(--rlh-hover-bg)75%,transparent)}}.rlh-loading-bar{overflow:hidden}.rlh-loading-bar-inner{background:linear-gradient(90deg,var(--rlh-accent-color),var(--rlh-accent-color));width:0%;height:100%}@supports (color:color-mix(in lab, red, red)){.rlh-loading-bar-inner{background:linear-gradient(90deg,var(--rlh-accent-color),color-mix(in srgb,var(--rlh-accent-color)70%,transparent))}}.rlh-loading-bar-inner{transition:width .3s}.rlh-loading-progress{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}@supports (color:color-mix(in lab, red, red)){.rlh-loading-progress{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-menu-icon{width:1.1rem;height:1.1rem;color:var(--rlh-accent-color);justify-content:center;align-items:center;display:inline-flex}@keyframes rlh-spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.rlh-edit-content{border:1px solid var(--rlh-border-color);border-radius:0 0 12px 12px;min-height:6rem;padding:.75rem}@supports (color:color-mix(in lab, red, red)){.rlh-edit-content{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-edit-content{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);white-space:pre-wrap}.rlh-error-wrapper{text-align:center;border:1px dashed var(--rlh-red);border-radius:16px;padding:1.5rem}@supports (color:color-mix(in lab, red, red)){.rlh-error-wrapper{border:1px dashed color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-error-wrapper{background-color:var(--rlh-red-bg)}.rlh-error-title{color:var(--rlh-red);margin-bottom:.75rem;font-weight:600}.rlh-error-text{color:var(--rlh-em-color);font-size:.9rem}.rlh-error-retry-btn{border:1px solid var(--rlh-red);color:var(--rlh-red);cursor:pointer;background-color:#0000;border-radius:9999px;margin-top:1rem;padding:.55rem 1.1rem;transition:background-color .2s}.rlh-error-retry-btn:hover{background-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-error-retry-btn:hover{background-color:color-mix(in srgb,var(--rlh-red)18%,transparent)}}.rlh-error-retry-btn:hover{color:#fff}.rlh-search-card,.rlh-filters-card{background:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:.9rem;padding:1rem 1.1rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-card,.rlh-filters-card{background:color-mix(in srgb,var(--rlh-surface-color)92%,transparent)}}.rlh-search-card,.rlh-filters-card{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-card,.rlh-filters-card{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-card,.rlh-filters-card{box-shadow:0 20px 60px -40px var(--rlh-shadow-color)}.rlh-section-title{letter-spacing:.08em;text-transform:uppercase;color:var(--rlh-em-color);font-size:max(.8125rem,13px);font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-section-title{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-toast-notification.success{background-color:var(--rlh-green)}.rlh-toast-notification.error{background-color:var(--rlh-red)}.rlh-toast-notification.info{background-color:var(--rlh-accent-color)}@media (prefers-reduced-motion:reduce){#regex-lore-hub-panel .rlh-shell,.rlh-toolbar-btn:focus-visible{animation:none}.rlh-toast-notification.visible,.rlh-progress-toast.visible{transition:opacity .2s,transform .2s;animation:none}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover,.rlh-toolbar-btn:hover,.rlh-toggle-btn:hover i,.rlh-action-btn-icon:hover i,.rlh-toolbar-btn:hover i{transform:none}}.rlh-breadcrumbs{align-items:center;gap:.4rem;margin-bottom:.5rem;font-size:.9rem;display:flex}.rlh-breadcrumb-item{color:var(--rlh-em-color);text-decoration:none;transition:color .2s}.rlh-breadcrumb-item:hover{color:var(--rlh-accent-color)}.rlh-breadcrumb-item.active{color:var(--rlh-text-color);pointer-events:none;font-weight:500}.rlh-breadcrumb-separator{color:var(--rlh-em-color)}.rlh-empty-state{text-align:center;background-color:var(--rlh-hover-bg);border-radius:16px;flex-direction:column;justify-content:center;align-items:center;margin-top:1rem;padding:2rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-empty-state{background-color:color-mix(in srgb,var(--rlh-hover-bg)50%,transparent)}}.rlh-empty-state{border:1px dashed var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-empty-state{border:1px dashed color-mix(in srgb,var(--rlh-border-color)80%,transparent)}}.rlh-empty-icon{color:var(--rlh-accent-color);background-color:var(--rlh-selected-bg);border-radius:9999px;justify-content:center;align-items:center;width:4rem;height:4rem;margin-bottom:1rem;font-size:2rem;display:flex}.rlh-empty-state h4{color:var(--rlh-text-color);margin-bottom:.5rem;font-size:1.1rem;font-weight:600}.rlh-empty-state p{color:var(--rlh-em-color);max-width:300px}.rlh-book-group{transition:box-shadow .2s,border-color .2s;position:relative}.rlh-book-group.enabled{border-left:3px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{border-left:3px solid color-mix(in srgb,var(--rlh-accent-color)80%,transparent)}}.rlh-book-group.enabled{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color))}}.rlh-book-group.enabled{background:linear-gradient(160deg,var(--rlh-accent-color)0%,var(--rlh-surface-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{background:linear-gradient(160deg,color-mix(in srgb,var(--rlh-accent-color)20%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-surface-color)96%,transparent)100%)}}.rlh-book-group.enabled{box-shadow:0 26px 70px -46px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{box-shadow:0 26px 70px -46px color-mix(in srgb,var(--rlh-accent-color)58%,transparent)}}.rlh-book-title-wrapper{flex-direction:column;flex:1;gap:.2rem;display:flex}.rlh-book-stats{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}.rlh-book-summary{background-color:var(--rlh-hover-bg);padding:.5rem 1rem;font-size:.85rem}@supports (color:color-mix(in lab, red, red)){.rlh-book-summary{background-color:color-mix(in srgb,var(--rlh-hover-bg)40%,transparent)}}.rlh-book-summary{border-top:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-summary{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-used-by-chars span{background-color:var(--rlh-selected-bg);border-radius:9999px;margin:.1rem;padding:.1rem .5rem;font-size:max(.8125rem,13px);display:inline-block}.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{border:1px solid var(--rlh-border-color);border-radius:12px;padding:.45rem .65rem}@supports (color:color-mix(in lab, red, red)){.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{background-color:var(--rlh-input-bg);color:var(--rlh-text-color)}.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{box-shadow:var(--rlh-focus-ring)}.rlh-loading{pointer-events:none;opacity:.5;position:relative}.rlh-loading>i{visibility:hidden}.rlh-loading:after{content:\"\";border:2px solid oklch(70.7% .022 261.325);border-top-color:oklch(62.3% .214 259.815);border-radius:50%;width:16px;height:16px;margin-top:-8px;margin-left:-8px;animation:.8s linear infinite rlh-spin;position:absolute;top:50%;left:50%}.rlh-highlight{color:#1f2937;background-color:#facc15;animation:.5s ease-out rlhHighlightPulse}.rlh-replace-confirm-modal{color:var(--rlh-text-color);flex-direction:column;gap:.6rem;display:flex}.rlh-replace-stats{background:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-replace-stats{background:color-mix(in srgb,var(--rlh-accent-color)6%,transparent)}}.rlh-replace-stats{border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-replace-stats{border:1px solid color-mix(in srgb,var(--rlh-accent-color)22%,transparent)}}.rlh-replace-stats{border-radius:10px;padding:.6rem .8rem}.rlh-replace-stats h4{color:var(--rlh-text-color);margin:0 0 .4rem;font-weight:600}.rlh-replace-stats ul{margin:0;padding-left:1.1rem}.rlh-confirm-scroll-list{border:1px solid var(--rlh-border-color);background:var(--rlh-surface-color);border-radius:10px;max-height:12rem;padding:.4rem .25rem;overflow-y:auto}.rlh-confirm-entry-list{margin:0;padding:.25rem .25rem .25rem .5rem;list-style:none}.rlh-confirm-entry-item{border-radius:8px;padding:.35rem .5rem;transition:background-color .15s}.rlh-confirm-entry-item:hover{background:var(--rlh-hover-bg)}.rlh-toolbar-btn:focus-visible,.rlh-icon-button:focus-visible,.rlh-close-button:focus-visible,.rlh-toggle-btn:focus-visible,.rlh-action-btn-icon:focus-visible,.rlh-toolbar-icon-btn:focus-visible{outline-offset:2px;outline:3px solid var(--rlh-accent-color)!important;box-shadow:0 0 0 5px var(--rlh-accent-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:focus-visible,.rlh-icon-button:focus-visible,.rlh-close-button:focus-visible,.rlh-toggle-btn:focus-visible,.rlh-action-btn-icon:focus-visible,.rlh-toolbar-icon-btn:focus-visible{box-shadow:0 0 0 5px color-mix(in srgb,var(--rlh-accent-color)20%,transparent)!important}}input:focus-visible,select:focus-visible,textarea:focus-visible,[contenteditable]:focus-visible{outline:3px solid var(--rlh-accent-color);outline-offset:2px}}.rlh-toolbar-toggle-btn{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color);border:1px solid var(--rlh-border-color);cursor:pointer;border-radius:8px;justify-content:center;align-items:center;padding:.5rem 1rem;transition:background-color .2s,color .2s;display:inline-flex}.rlh-toolbar-toggle-btn:hover{background-color:var(--rlh-selected-bg);color:var(--rlh-accent-color)}#regex-lore-hub-toolbar-shell{transition:max-height .3s ease-in-out}.rlh-toolbar-shell--collapsed{max-height:0;margin-top:0;margin-bottom:0;padding-top:0;padding-bottom:0;overflow:hidden}@media (max-width:640px){.rlh-toggle-btn,.rlh-action-btn-icon,.rlh-toolbar-icon-btn,.rlh-icon-button,.rlh-close-button{width:44px;height:44px;padding:.5rem;min-width:44px!important;min-height:44px!important}.rlh-multi-select-action-btn{padding:.6rem .8rem;min-width:44px!important;min-height:44px!important}.rlh-item-controls{gap:.5rem!important}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:44px!important;height:44px!important}}\n`;var Cl=(()=>{try{return new URL(\"../vendor/Sortable.min.js\",import.meta.url).href}catch(e){return console.error(\"[RegexLoreHub] \\u8BA1\\u7B97 SortableJS \\u672C\\u5730\\u8DEF\\u5F84\\u5931\\u8D25\\uFF1A\",e),\"\"}})(),It=e=>!e||typeof e!=\"string\"?\"\":e.trim().replace(/\\\\/g,\"/\").replace(/\\/+$/,\"\"),lt=(e,r)=>{let o=It(e);if(!o)return\"\";let l=r.replace(/^\\/+/,\"\");return`${o}/${l}`},Nl=(e,r)=>{let o=[],l=a=>{if(!a||typeof a!=\"string\")return;let n=a.trim();n&&(o.includes(n)||o.push(n))};l(lt(t.paths?.vendor,\"Sortable.min.js\")),l(lt(t.paths?.rlhRoot,\"vendor/Sortable.min.js\"));try{l(new URL(\"../vendor/Sortable.min.js\",import.meta.url).href)}catch(a){console.warn(\"[RegexLoreHub] \\u57FA\\u4E8E\\u6A21\\u5757\\u8DEF\\u5F84\\u63A8\\u5BFC Sortable \\u8D44\\u6E90\\u5931\\u8D25\\uFF1A\",a)}try{e&&e.querySelectorAll(\"script[src]\").forEach(n=>{let i=n.getAttribute(\"src\");if(!(!i||!/regex[-_]lore[-_]hub/i.test(i)))try{let b=new URL(i,r?.location?.href||window.location.href),m=It(b.href.replace(/\\/[^/]*$/,\"\"));l(lt(m,\"vendor/Sortable.min.js\")),l(lt(m,\"src/vendor/Sortable.min.js\"))}catch(b){console.warn(\"[RegexLoreHub] \\u5BBF\\u4E3B\\u811A\\u672C\\u8DEF\\u5F84\\u63A8\\u5BFC\\u5931\\u8D25\\uFF1A\",b)}})}catch(a){console.warn(\"[RegexLoreHub] \\u904D\\u5386\\u5BBF\\u4E3B\\u811A\\u672C\\u8282\\u70B9\\u5931\\u8D25\\uFF1A\",a)}return l(Cl),l(\"https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js\"),o.filter(Boolean)};function Bo(e){let r=ce(),o=fe(),l=ke(),a=e();function n(){let m=o.getElementById(`${me}-styles`);if(m){m.textContent=Nt;return}let u=o.createElement(\"style\");u.id=`${me}-styles`,u.textContent=Nt,o.head.appendChild(u)}function i(m){if(t.isDragSortDisabled=!1,l.Sortable){if(typeof m==\"function\")try{m()}catch(w){console.error(\"[RegexLoreHub] \\u521D\\u59CB\\u5316\\u56DE\\u8C03\\u6267\\u884C\\u5931\\u8D25\\uFF1A\",w)}return}let u=!1,p=()=>{if(!u&&(u=!0,typeof m==\"function\"))try{m()}catch(w){console.error(\"[RegexLoreHub] \\u521D\\u59CB\\u5316\\u56DE\\u8C03\\u6267\\u884C\\u5931\\u8D25\\uFF1A\",w)}},g=Nl(o,l),v=w=>{if(!o){t.isDragSortDisabled=!0,console.error(\"[RegexLoreHub] \\u65E0\\u6CD5\\u52A0\\u8F7D SortableJS\\uFF1A\\u5BBF\\u4E3B\\u6587\\u6863\\u4E0D\\u53EF\\u8BBF\\u95EE\\u3002\",w),p();return}let k=g.length?`\\u5C1D\\u8BD5\\u8DEF\\u5F84\\uFF1A${g.join(\", \")}`:\"\\u672A\\u627E\\u5230\\u53EF\\u7528\\u5019\\u9009\\u8DEF\\u5F84\\u3002\";(async()=>{if(typeof(l.fetch||window.fetch)!=\"function\")throw w||new Error(\"fetch not available\");let s=l.fetch?l.fetch.bind(l):window.fetch.bind(window),f=(()=>{try{return new URL(\"../vendor/Sortable.min.js\",import.meta.url).href}catch(L){return console.warn(\"[RegexLoreHub] \\u5185\\u8054\\u56DE\\u9000\\u8DEF\\u5F84\\u89E3\\u6790\\u5931\\u8D25\\uFF1A\",L),\"\"}})()||g[0]||\"\";if(!f)throw w||new Error(\"missing inline url\");let x=await s(f,{cache:\"no-cache\"});if(!x.ok)throw new Error(`HTTP ${x.status} ${x.statusText}`);let A=await x.text(),M=o.createElement(\"script\");M.textContent=A,o.head.appendChild(M),console.warn(\"[RegexLoreHub] SortableJS \\u5DF2\\u901A\\u8FC7\\u5185\\u8054\\u6A21\\u5F0F\\u52A0\\u8F7D\\u3002\"),t.isDragSortDisabled=!1,p()})().catch(s=>{t.isDragSortDisabled=!0,console.error(\"[RegexLoreHub] Failed to load SortableJS.\",s??w),q({type:\"alert\",title:\"\\u9519\\u8BEF\",text:`\\u65E0\\u6CD5\\u52A0\\u8F7D\\u62D6\\u62FD\\u6392\\u5E8F\\u5E93\\uFF0C\\u8BF7\\u68C0\\u67E5\\u8D44\\u6E90\\u8DEF\\u5F84\\u914D\\u7F6E\\u3002${k}`}).catch(()=>{}),p()}).finally(()=>{})};if(!g.length){v(new Error(\"Sortable candidate URLs not found.\"));return}let E=w=>{if(w>=g.length){v(new Error(\"All Sortable candidates failed.\"));return}let k=g[w],C=l.document.createElement(\"script\");C.src=k,C.dataset.rlhSortableCandidate=String(w),C.onload=()=>{t.isDragSortDisabled=!1,console.log(\"[RegexLoreHub] SortableJS loaded successfully.\",k),t.paths=t.paths||{},t.paths.vendor=It(k.replace(/\\/Sortable\\.min\\.js(?:\\?.*)?$/,\"\")),t.paths.rlhRoot=t.paths.vendor?.replace(/\\/vendor$/,\"\")||t.paths.rlhRoot||\"\",p()},C.onerror=s=>{C.remove(),console.warn(\"[RegexLoreHub] SortableJS \\u52A0\\u8F7D\\u5931\\u8D25\\uFF0C\\u5C1D\\u8BD5\\u4E0B\\u4E00\\u4E2A\\u5019\\u9009\\u3002\",k,s?.error),E(w+1)},l.document.head.appendChild(C)};E(0)}function b(){if(console.log(\"[RegexLoreHub] Initializing UI and button...\"),r(`#${me}`,o).length>0){console.log(\"[RegexLoreHub] Panel already exists. Skipping UI creation.\");return}n();let m=`\n      <div id=\"${me}\">\n\n        <div class=\"rlh-shell\">\n\n          <header class=\"rlh-shell-header\">\n\n            <div class=\"rlh-shell-title\">\n\n              <h4>${st}</h4>\n\n              <p class=\"rlh-shell-meta\"><span class=\"rlh-shell-version\">v3.2</span><span class=\"rlh-shell-dot\">\\xB7</span><span class=\"rlh-shell-updated\">\\u66F4\\u65B0\\u4E8E 2025 \\u5E74 10 \\u6708 21 \\u65E5</span></p>\n\n            </div>\n\n            <div class=\"rlh-shell-right\">\n\n              <div id=\"${zr}\" class=\"rlh-prefetch-indicator\" data-visible=\"false\" aria-hidden=\"true\">\n\n                <div id=\"${Fr}\" class=\"rlh-prefetch-text\" aria-live=\"polite\">\\u540E\\u53F0\\u52A0\\u8F7D\\u4E16\\u754C\\u4E66 (0/0)\\uFF0C\\u4E0D\\u5F71\\u54CD\\u5176\\u4ED6\\u64CD\\u4F5C</div>\n\n                <div class=\"rlh-prefetch-bar\" role=\"progressbar\" aria-valuemin=\"0\" aria-valuemax=\"100\" aria-valuenow=\"0\">\n\n                  <span id=\"${jr}\" class=\"rlh-prefetch-bar-inner\"></span>\n\n                </div>\n\n              </div>\n\n              <button type=\"button\" id=\"${We.TOGGLE_TOOLBAR_BTN}\" class=\"rlh-toolbar-toggle-btn\" title=\"\\u6298\\u53E0\\u5DE5\\u5177\\u680F\" aria-controls=\"${We.TOOLBAR_SHELL}\" aria-expanded=\"true\">\\u6298\\u53E0\\u5DE5\\u5177\\u680F</button>\n\n              <div class=\"rlh-shell-actions\">\n\n                <button type=\"button\" id=\"${Er}\" class=\"rlh-icon-button rlh-refresh-button\" title=\"\\u5237\\u65B0\\u6570\\u636E\">\n\n                  <i class=\"fa-solid fa-arrows-rotate\"></i>\n\n                </button>\n\n                <button type=\"button\" id=\"${ct}\" class=\"rlh-icon-button rlh-close-button\" title=\"\\u5173\\u95ED\\u9762\\u677F\">\n\n                  <i class=\"fa-solid fa-xmark\"></i>\n\n                </button>\n\n              </div>\n\n            </div>\n\n          </header>\n\n\n\n\n\n          <nav class=\"rlh-tab-nav\">\n\n            <div class=\"rlh-tab active\" data-tab=\"global-lore\"><span class=\"rlh-tab-text-full\">\\u5168\\u5C40\\u4E16\\u754C\\u4E66</span><span class=\"rlh-tab-text-short\">\\u5168\\u5C40\\u4E66</span></div>\n\n            <div class=\"rlh-tab\" data-tab=\"char-lore\"><span class=\"rlh-tab-text-full\">\\u89D2\\u8272\\u4E16\\u754C\\u4E66</span><span class=\"rlh-tab-text-short\">\\u89D2\\u8272\\u4E66</span></div>\n\n            <div class=\"rlh-tab\" data-tab=\"chat-lore\"><span class=\"rlh-tab-text-full\">\\u804A\\u5929\\u4E16\\u754C\\u4E66</span><span class=\"rlh-tab-text-short\">\\u804A\\u5929\\u4E66</span></div>\n\n            <div class=\"rlh-tab\" data-tab=\"global-regex\"><span class=\"rlh-tab-text-full\">\\u5168\\u5C40\\u6B63\\u5219</span><span class=\"rlh-tab-text-short\">\\u5168\\u5C40\\u6B63\\u5219</span></div>\n\n            <div class=\"rlh-tab\" data-tab=\"char-regex\"><span class=\"rlh-tab-text-full\">\\u89D2\\u8272\\u6B63\\u5219</span><span class=\"rlh-tab-text-short\">\\u89D2\\u8272\\u6B63\\u5219</span></div>\n\n          </nav>\n\n          <div id=\"${We.TOOLBAR_SHELL}\" class=\"rlh-toolbar-shell\">\n\n            <div id=\"${Lr}\" class=\"rlh-toolbar-container\"></div>\n\n            <div id=\"${Tr}\" class=\"rlh-replace-container\"></div>\n\n          </div>\n\n          <div class=\"rlh-content-pane\">\n\n            <div id=\"${me}-content\"></div>\n\n          </div>\n\n          <footer class=\"rlh-shell-footer\">\n\n            <div id=\"regex-lore-hub-save-status\" class=\"rlh-save-status\"></div>\n\n          </footer>\n\n        </div>\n\n      </div>`;r(\"body\",o).append(m);let u=`<div id=\"${Xe}\" class=\"list-group-item flex-container flexGap5 interactable\" title=\"${st}\"><span class=\"rlh-menu-icon\"><i class=\"fa-solid fa-layer-group\"></i></span><span>${Pt}</span></div>`,p=r(\"#extensionsMenu\",o);p.find(`#${Xe}`).length===0&&(p.append(u),console.log(`[RegexLoreHub] Button #${Xe} appended to #extensionsMenu.`));let g=r(`#${me}`,o);if(g.addClass(\"dark\"),r(\"body\",o).off(\".rlh\").on(\"click.rlh\",`#${Xe}`,a.togglePanel),g.off(\".rlh\").on(\"click.rlh\",`#${ct}`,a.togglePanel).on(\"click.rlh\",\".rlh-tab\",a.switchTab).on(\"click.rlh\",\".rlh-item-header, .rlh-global-book-header\",a.handleHeaderClick).on(\"click.rlh\",\".rlh-item-container\",a.handleMultiSelectContainerClick).on(\"click.rlh\",\".rlh-book-group\",a.handleMultiSelectContainerClick).on(\"click.rlh\",\".rlh-back-to-list-btn\",a.handleExitLorebookDetail).on(\"click.rlh\",\".rlh-toggle-btn\",a.handleToggleState).on(\"click.rlh\",\".rlh-refresh-detail-btn\",a.handleRefreshLorebookDetail).on(\"click.rlh\",\".rlh-entry-edit-btn\",a.handleEntryEnterEdit).on(\"click.rlh\",\".rlh-entry-view-btn\",a.handleEntryExitEdit).on(\"click.rlh\",\".rlh-regex-edit-btn\",a.handleRegexEnterEdit).on(\"click.rlh\",\".rlh-regex-view-btn\",a.handleRegexExitEdit).on(\"keydown.rlh\",`#${er}`,a.handleSearchInputKeydown).on(\"click.rlh\",\"#rlh-search-clear-btn\",a.handleSearchClear).on(\"input.rlh\",`#${er}, #${mr}`,a.handleGlobalSearch).on(\"change.rlh\",\"#rlh-search-filters-container input\",oe).on(\"change.rlh\",`#${Pr}`,a.handleCharacterBookSwitch).on(\"click.rlh\",`#${fr}`,a.handleToolbarToggleCollapse).on(\"click.rlh\",`#${rr}`,a.handleSortMenuToggle).on(\"click.rlh\",\".rlh-sort-option\",a.handleSortOptionSelect).on(\"click.rlh\",`#${Ye}`,a.handlePositionMenuToggle).on(\"click.rlh\",\".rlh-position-option\",a.handlePositionOptionSelect).on(\"click.rlh\",`#${tr}`,a.handleUnifiedStatusMenuToggle).on(\"click.rlh\",\".rlh-unified-status-option\",a.handleUnifiedStatusOptionSelect).on(\"change.rlh\",\".rlh-multi-select-checkbox\",a.handleSelectionCheckboxChange).on(\"click.rlh\",`#${Er}`,a.handleRefresh).on(\"click.rlh\",\"#rlh-multi-select-btn\",a.toggleMultiSelectMode).on(\"click.rlh\",\"#rlh-select-all-btn\",a.handleSelectAll).on(\"click.rlh\",\"#rlh-select-none-btn\",a.handleSelectNone).on(\"click.rlh\",\"#rlh-select-invert-btn\",a.handleSelectInvert).on(\"click.rlh\",\".rlh-select-unbound\",a.handleSelectUnboundBooks).on(\"click.rlh\",\"#rlh-batch-enable-btn\",a.handleBatchEnable).on(\"click.rlh\",\"#rlh-batch-disable-btn\",a.handleBatchDisable).on(\"click.rlh\",\"#rlh-batch-delete-btn\",a.handleBatchDelete).on(\"click.rlh\",\".rlh-clean-orphan-books-btn\",a.handleCleanOrphanLorebooks).on(\"click.rlh\",`#${Hr}`,a.handlePrimaryCreateButtonClick).on(\"click.rlh\",\".rlh-rename-book-btn\",a.handleRenameBook).on(\"click.rlh\",\".rlh-edit-entries-btn\",a.handleEditEntriesToggle).on(\"click.rlh\",\".rlh-delete-book-btn\",a.handleDeleteLorebook).on(\"click.rlh\",\".rlh-create-entry-btn\",a.handleCreateEntry).on(\"click.rlh\",\"#regex-lore-hub-create-lorebook-btn\",a.handleCreateLorebook).on(\"click.rlh\",\".rlh-delete-entry-btn\",a.handleDeleteEntry).on(\"click.rlh\",\".rlh-batch-recursion-btn\",a.handleBatchSetRecursion).on(\"click.rlh\",\".rlh-fix-keywords-btn\",a.handleFixKeywords).on(\"click.rlh\",\".rlh-rename-btn\",a.handleRename).on(\"click.rlh\",\".rlh-rename-save-btn\",a.handleConfirmRename).on(\"keydown.rlh\",\".rlh-rename-input\",a.handleRenameKeydown).on(\"change.rlh\",\".rlh-edit-position\",a.handlePositionChange).on(\"click.rlh\",\"#rlh-create-chat-lore-btn\",a.handleCreateChatLorebook).on(\"click.rlh\",\".rlh-unlink-chat-lore-btn\",a.handleUnlinkChatLorebook).on(\"click.rlh\",`#${We.TOGGLE_TOOLBAR_BTN}`,Co).on(\"click.rlh\",\"#rlh-replace-btn\",a.handleReplace),t.isToolbarCollapsed){r(`#${We.TOOLBAR_SHELL}`,o).addClass(\"rlh-toolbar-shell--collapsed\");let w=r(`#${We.TOGGLE_TOOLBAR_BTN}`,o);w.length&&w.text(\"\\u5C55\\u5F00\\u5DE5\\u5177\\u680F\").attr(\"aria-expanded\",\"false\").attr(\"title\",\"\\u5C55\\u5F00\\u5DE5\\u5177\\u680F\")}console.log(\"[RegexLoreHub] All UI and events initialized.\"),ze()}i(b)}var Rt=null,At=null;function Il(e,r){Rt=e,At=r}function ce(){if(Rt)return Rt;let e=window.parent||window;return e?.jQuery?e.jQuery:null}function ge(){if(At)return At;let e=window.parent||window;return e?.TavernHelper?e.TavernHelper:null}function Rl(e){let r=\"#extensionsMenu\",l=0;console.log(`[RegexLoreHub] Starting readiness check. Polling for DOM element \"${r}\" AND core APIs (TavernHelper, jQuery).`);let a=setInterval(()=>{let n=window.parent?.document,i=window.parent,b=!!n&&n.querySelector(r)!==null,m=!!(i&&i.TavernHelper)&&typeof i.TavernHelper.getCharData==\"function\"&&!!i.jQuery;if(b&&m){clearInterval(a),console.log(`[RegexLoreHub] SUCCESS: Both DOM (\"${r}\") and Core APIs are ready. Initializing script.`);try{let u=e(i.jQuery,i.TavernHelper);u?.catch&&u.catch(p=>{console.error(\"[RegexLoreHub] FATAL: Error during main callback execution.\",p)})}catch(u){console.error(\"[RegexLoreHub] FATAL: Error during main callback execution.\",u)}}else l++,l>100&&(clearInterval(a),console.error(\"[RegexLoreHub] FATAL: Readiness check timed out.\"),b||console.error(`[RegexLoreHub] -> Failure: DOM element \"${r}\" not found.`),m||console.error(`[RegexLoreHub] -> Failure: Core APIs not available. TavernHelper: ${!!i?.TavernHelper}, jQuery: ${!!i?.jQuery}`))},150)}async function Al(e,r){Il(e,r);try{await Bo(Ao)}catch(o){console.error(\"[RegexLoreHub] FATAL: Failed to bootstrap application.\",o)}}Rl(Al);\n//# sourceMappingURL=bundle.js.map\n",
  "info": "",
  "buttons": [],
  "data": {}
}
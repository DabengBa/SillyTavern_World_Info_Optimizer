{
  "version": 3,
  "sources": ["../src/core.js", "../src/ui/render/shared.js", "../src/ui/render/lorebook.js", "../src/ui/render/regex.js", "../src/ui/render/index.js", "../src/dataLayer.js", "../src/ui/handlers/lorebook.js", "../src/ui/handlers/item.js", "../src/ui/handlers/ui.js", "../src/ui/handlers/worldbook/selectUnboundBooks.js", "../src/ui/handlers/index.js", "../src/styles/generated.js", "../src/ui/shell.js", "../src/appBootstrap.js"],
  "sourcesContent": ["import { get$ } from './appBootstrap.js';\n\nexport { get$, getTavernHelper } from './appBootstrap.js';\n\nexport const PANEL_ID = 'regex-lore-hub-panel';\nexport const BUTTON_ID = 'regex-lore-hub-button';\nexport const BUTTON_ICON_URL = 'https://i.postimg.cc/bY23wb9Y/IMG-20250626-000247.png';\nexport const BUTTON_TOOLTIP = '\u4E16\u754C\u4E66&\u6B63\u5219\u7BA1\u7406\u5668';\nexport const BUTTON_TEXT_IN_MENU = '\u4E16\u754C\u4E66&\u6B63\u5219\u7BA1\u7406\u5668';\nexport const CLOSE_BTN_ID = 'rlh-close-btn';\nexport const SEARCH_INPUT_ID = 'rlh-search-input';\nexport const REFRESH_BTN_ID = 'rlh-refresh-btn';\nexport const CORE_TOOLBAR_ID = 'rlh-core-toolbar';\nexport const REPLACE_TOOL_CONTAINER_ID = 'rlh-replace-tool-container';\nexport const REPLACE_TOGGLE_BTN_ID = 'rlh-replace-toggle-btn';\nexport const REPLACE_INPUT_ID = 'rlh-replace-input';\nexport const TOGGLE_COLLAPSE_BTN_ID = 'rlh-toggle-collapse-btn';\nexport const TOGGLE_RECURSION_BTN_ID = 'rlh-toggle-recursion-btn';\nexport const FIX_KEYWORDS_BTN_ID = 'rlh-fix-keywords-btn';\nexport const SORT_MENU_ID = 'rlh-sort-menu';\nexport const SORT_MENU_BUTTON_ID = 'rlh-sort-menu-btn';\nexport const POSITION_MENU_ID = 'rlh-position-menu';\nexport const POSITION_MENU_BUTTON_ID = 'rlh-position-menu-btn';\nexport const UNIFIED_STATUS_MENU_ID = 'rlh-unified-status-menu';\nexport const UNIFIED_STATUS_BUTTON_ID = 'rlh-unified-status-btn';\nexport const CREATE_LOREBOOK_BTN_ID = 'rlh-create-primary-btn';\nexport const CHARACTER_BOOK_SWITCH_ID = 'rlh-character-book-switch';\nexport const PREFETCH_INDICATOR_ID = 'rlh-prefetch-indicator';\nexport const PREFETCH_PROGRESS_TEXT_ID = 'rlh-prefetch-progress-text';\nexport const PREFETCH_PROGRESS_BAR_ID = 'rlh-prefetch-progress-bar';\nexport const THEME_MENU_WRAPPER_ID = 'rlh-theme-menu-wrapper';\nexport const THEME_MENU_ID = 'rlh-theme-menu';\nexport const THEME_TOGGLE_BTN_ID = 'rlh-theme-toggle-btn';\nexport const THEME_TOGGLE_LABEL_ID = 'rlh-theme-toggle-label';\nexport const THEME_OPTION_CLASS = 'rlh-theme-option';\nexport const DOM_ID = {\n  TOOLBAR_SHELL: 'regex-lore-hub-toolbar-shell',\n  TOGGLE_TOOLBAR_BTN: 'regex-lore-hub-toggle-toolbar-btn',\n};\n\nconst normalizeUrlBase = value => {\n  if (!value || typeof value !== 'string') return '';\n  return value.replace(/\\\\/g, '/').replace(/\\/+$/, '');\n};\n\nconst computeDefaultModuleRoot = () => {\n  try {\n    const baseUrl = new URL('./', import.meta.url).href;\n    return normalizeUrlBase(baseUrl);\n  } catch (error) {\n    console.warn('[RegexLoreHub] \u65E0\u6CD5\u89E3\u6790\u811A\u672C\u6839\u8DEF\u5F84\uFF1A', error);\n    return '';\n  }\n};\n\nconst detectRootFromParent = () => {\n  try {\n    const parentWin = window.parent || window;\n    const parentDoc = parentWin?.document;\n    if (!parentDoc) return '';\n\n    const scripts = parentDoc.querySelectorAll('script[src]');\n    for (const scriptEl of scripts) {\n      const src = scriptEl.getAttribute('src');\n      if (!src || !/regex[-_]lore[-_]hub/i.test(src)) continue;\n\n      try {\n        const absoluteUrl = new URL(src, parentWin.location?.href || window.location.href);\n        const normalized = normalizeUrlBase(absoluteUrl.href);\n        if (!normalized) continue;\n        const trimmed = normalized.replace(/\\/[^/]*$/, '');\n        if (trimmed) return trimmed;\n      } catch (innerError) {\n        console.warn('[RegexLoreHub] \u5BBF\u4E3B\u811A\u672C\u6839\u8DEF\u5F84\u89E3\u6790\u5931\u8D25\uFF1A', innerError);\n      }\n    }\n  } catch (error) {\n    console.warn('[RegexLoreHub] \u65E0\u6CD5\u4ECE\u5BBF\u4E3B DOM \u63A8\u65AD\u6839\u8DEF\u5F84\uFF1A', error);\n  }\n  return '';\n};\n\nconst RLH_ROOT_URL = normalizeUrlBase(detectRootFromParent()) || computeDefaultModuleRoot();\n\n// \u7EDF\u4E00\u7EF4\u62A4\u6240\u6709\u53EF\u7528\u7684\u4E3B\u9898\u53D8\u91CF\u6620\u5C04\uFF0C\u907F\u514D\u5404\u5904\u6563\u843D\u5199\u6B7B CSS \u53D8\u91CF\u540D\u3002\nconst THEME_TOKEN_ENTRIES = [\n  ['focusRing', '--rlh-focus-ring'],\n  ['background', '--rlh-bg-color'],\n  ['surface', '--rlh-surface-color'],\n  ['text', '--rlh-text-color'],\n  ['textMuted', '--rlh-em-color'],\n  ['border', '--rlh-border-color'],\n  ['hover', '--rlh-hover-bg'],\n  ['selected', '--rlh-selected-bg'],\n  ['shadow', '--rlh-shadow-color'],\n  ['header', '--rlh-header-bg'],\n  ['input', '--rlh-input-bg'],\n  ['accent', '--rlh-accent-color'],\n  ['positive', '--rlh-green'],\n  ['negative', '--rlh-red'],\n  ['positiveBg', '--rlh-green-bg'],\n  ['negativeBg', '--rlh-red-bg'],\n  ['statusConstant', '--rlh-status-constant'],\n  ['statusSelective', '--rlh-status-selective'],\n  ['statusVectorized', '--rlh-status-vectorized'],\n];\n\nconst THEME_VARIABLES_MAP = {};\nTHEME_TOKEN_ENTRIES.forEach(([token, varName]) => {\n  THEME_VARIABLES_MAP[token] = varName;\n});\n\nexport const THEME_VARIABLES = Object.freeze({ ...THEME_VARIABLES_MAP });\nexport const THEME_TOKEN_LIST = Object.freeze(THEME_TOKEN_ENTRIES.map(([token]) => token));\nexport const resolveThemeVarName = token =>\n  typeof token === 'string' && token ? THEME_VARIABLES_MAP[token] ?? null : null;\n\nconst sanitizeThemeId = value => {\n  if (value === null || value === undefined) return '';\n  return String(value).trim().toLowerCase();\n};\n\nconst normalizeThemeClasses = classes => {\n  if (!classes) return [];\n  const list = Array.isArray(classes) ? classes : [classes];\n  const unique = [];\n  list.forEach(item => {\n    if (!item && item !== 0) return;\n    const str = String(item).trim();\n    if (!str) return;\n    if (!unique.includes(str)) unique.push(str);\n  });\n  return unique;\n};\n\nconst themeRegistry = new Map();\nconst themeOrder = [];\nconst themeListeners = new Set();\n\nconst themeState = {\n  activeId: 'dark',\n  fallbackId: 'dark',\n  pendingApplyId: null,\n  appliedClasses: [],\n  colorScheme: 'dark',\n  activeSnapshot: null,\n};\n\nconst storeThemeConfig = config => {\n  themeRegistry.set(config.id, config);\n  if (!themeOrder.includes(config.id)) {\n    themeOrder.push(config.id);\n  }\n  themeOrder.sort((a, b) => {\n    const themeA = themeRegistry.get(a);\n    const themeB = themeRegistry.get(b);\n    if (!themeA || !themeB) return 0;\n    if (themeA.order !== themeB.order) return themeA.order - themeB.order;\n    return themeA.id.localeCompare(themeB.id);\n  });\n  return config;\n};\n\nconst normalizeThemeConfig = rawConfig => {\n  if (!rawConfig || typeof rawConfig !== 'object') {\n    throw new Error('\u4E3B\u9898\u914D\u7F6E\u5FC5\u987B\u662F\u5BF9\u8C61');\n  }\n  const normalizedId = sanitizeThemeId(rawConfig.id ?? rawConfig.themeId ?? rawConfig.name);\n  if (!normalizedId) {\n    throw new Error('\u4E3B\u9898\u914D\u7F6E\u7F3A\u5C11 id');\n  }\n  const normalizedLabel =\n    typeof rawConfig.label === 'string' && rawConfig.label.trim() ? rawConfig.label.trim() : normalizedId;\n  const normalizedDescription =\n    typeof rawConfig.description === 'string' ? rawConfig.description.trim() : '';\n  const normalizedOrder =\n    typeof rawConfig.order === 'number' && !Number.isNaN(rawConfig.order)\n      ? rawConfig.order\n      : themeOrder.length;\n  const normalizedClasses = normalizeThemeClasses(rawConfig.panelClassList ?? rawConfig.classList);\n  const normalizedScheme = rawConfig.colorScheme === 'dark' ? 'dark' : 'light';\n  const metadata =\n    rawConfig.metadata && typeof rawConfig.metadata === 'object' ? { ...rawConfig.metadata } : {};\n\n  return Object.freeze({\n    id: normalizedId,\n    label: normalizedLabel,\n    description: normalizedDescription,\n    order: normalizedOrder,\n    panelClassList: Object.freeze(normalizedClasses),\n    colorScheme: normalizedScheme,\n    metadata: Object.freeze(metadata),\n  });\n};\n\nconst applyThemeToPanel = themeConfig => {\n  try {\n    const parentDoc = getParentDoc();\n    if (!parentDoc) return false;\n    const panelEl = parentDoc.getElementById(PANEL_ID);\n    if (!panelEl) return false;\n\n    if (Array.isArray(themeState.appliedClasses) && themeState.appliedClasses.length) {\n      themeState.appliedClasses.forEach(className => {\n        if (className) panelEl.classList.remove(className);\n      });\n    }\n\n    const classesToApply = Array.isArray(themeConfig.panelClassList) ? [...themeConfig.panelClassList] : [];\n    classesToApply.forEach(className => {\n      if (className) panelEl.classList.add(className);\n    });\n    themeState.appliedClasses = classesToApply;\n\n    panelEl.dataset.rlhTheme = themeConfig.id;\n    if (themeConfig.colorScheme) {\n      panelEl.dataset.rlhThemeScheme = themeConfig.colorScheme;\n    } else {\n      delete panelEl.dataset.rlhThemeScheme;\n    }\n\n    return true;\n  } catch (error) {\n    console.warn('[RegexLoreHub] \u5E94\u7528\u4E3B\u9898\u5230\u9762\u677F\u5931\u8D25\uFF1A', error);\n    return false;\n  }\n};\n\nconst emitThemeChange = (themeConfig, previousTheme, reason) => {\n  const payload = {\n    theme: themeConfig,\n    previous: previousTheme,\n    reason: reason || 'manual',\n  };\n\n  themeListeners.forEach(listener => {\n    if (typeof listener !== 'function') return;\n    try {\n      listener(payload);\n    } catch (error) {\n      console.warn('[RegexLoreHub] \u4E3B\u9898\u76D1\u542C\u5668\u6267\u884C\u5931\u8D25\uFF1A', error);\n    }\n  });\n\n  try {\n    const parentWin = getParentWin();\n    const CustomEvt = parentWin?.CustomEvent || (typeof CustomEvent === 'function' ? CustomEvent : null);\n    if (parentWin && typeof parentWin.dispatchEvent === 'function' && CustomEvt) {\n      parentWin.dispatchEvent(new CustomEvt('RegexLoreHubThemeChange', { detail: payload }));\n    } else if (typeof window !== 'undefined' && typeof window.dispatchEvent === 'function' && CustomEvt) {\n      window.dispatchEvent(new CustomEvt('RegexLoreHubThemeChange', { detail: payload }));\n    }\n  } catch (error) {\n    console.warn('[RegexLoreHub] \u6D3E\u53D1\u4E3B\u9898\u4E8B\u4EF6\u5931\u8D25\uFF1A', error);\n  }\n};\n\nconst ensureActiveThemeInternal = () => {\n  const byActive = themeRegistry.get(themeState.activeId);\n  if (byActive) {\n    themeState.activeSnapshot = byActive;\n    themeState.colorScheme = byActive.colorScheme;\n    return byActive;\n  }\n  const fallback = themeRegistry.get(themeState.fallbackId);\n  if (fallback) {\n    themeState.activeId = fallback.id;\n    themeState.activeSnapshot = fallback;\n    themeState.colorScheme = fallback.colorScheme;\n    return fallback;\n  }\n  const first = themeOrder.length ? themeRegistry.get(themeOrder[0]) : null;\n  if (first) {\n    themeState.fallbackId = first.id;\n    themeState.activeId = first.id;\n    themeState.activeSnapshot = first;\n    themeState.colorScheme = first.colorScheme;\n  }\n  return first ?? null;\n};\n\nexport const registerTheme = rawConfig => {\n  try {\n    const normalized = normalizeThemeConfig(rawConfig);\n    storeThemeConfig(normalized);\n    if (!themeState.fallbackId) {\n      themeState.fallbackId = normalized.id;\n    }\n    if (!themeState.activeId) {\n      themeState.activeId = normalized.id;\n    }\n    if (themeState.activeId === normalized.id) {\n      themeState.activeSnapshot = normalized;\n      themeState.colorScheme = normalized.colorScheme;\n    }\n    return normalized;\n  } catch (error) {\n    console.error('[RegexLoreHub] \u6CE8\u518C\u4E3B\u9898\u5931\u8D25\uFF1A', error);\n    return null;\n  }\n};\n\nexport const getThemeDefinition = themeId => {\n  const normalizedId = sanitizeThemeId(themeId);\n  if (!normalizedId) return null;\n  return themeRegistry.get(normalizedId) ?? null;\n};\n\nexport const listThemes = () => themeOrder.map(id => themeRegistry.get(id)).filter(Boolean);\n\nexport const getActiveTheme = () => ensureActiveThemeInternal();\n\nexport const getThemeLabel = themeId => {\n  const theme = getThemeDefinition(themeId);\n  if (theme && typeof theme.label === 'string' && theme.label.trim()) return theme.label.trim();\n  if (typeof themeId === 'string' && themeId.trim()) return themeId.trim();\n  return '';\n};\n\nexport const setActiveTheme = (themeId, options = {}) => {\n  const { reason = 'manual', applyToDom = true, silent = false } = options ?? {};\n  const normalizedId = sanitizeThemeId(themeId);\n  const resolvedId = normalizedId === 'default' ? 'gruvbox-light-hard' : normalizedId;\n  const targetTheme =\n    (resolvedId && themeRegistry.get(resolvedId)) || ensureActiveThemeInternal();\n  if (!targetTheme) return null;\n\n  const previousTheme = ensureActiveThemeInternal();\n  const changed = !previousTheme || previousTheme.id !== targetTheme.id;\n\n  themeState.activeId = targetTheme.id;\n  themeState.activeSnapshot = targetTheme;\n  themeState.colorScheme = targetTheme.colorScheme;\n\n  if (applyToDom) {\n    const applied = applyThemeToPanel(targetTheme);\n    themeState.pendingApplyId = applied ? null : targetTheme.id;\n  } else {\n    themeState.pendingApplyId = targetTheme.id;\n  }\n\n  if (changed && !silent) {\n    emitThemeChange(targetTheme, previousTheme, reason);\n  }\n\n  return targetTheme;\n};\n\nexport const syncThemeToDom = () => {\n  const activeTheme = ensureActiveThemeInternal();\n  if (!activeTheme) return false;\n  const applied = applyThemeToPanel(activeTheme);\n  themeState.pendingApplyId = applied ? null : activeTheme.id;\n  return applied;\n};\n\nexport const onThemeChange = listener => {\n  if (typeof listener !== 'function') return () => {};\n  themeListeners.add(listener);\n  return () => themeListeners.delete(listener);\n};\n\nregisterTheme({\n  id: 'dark',\n  label: '\u6697\u8272\u4E3B\u9898',\n  description: '\u6DF1\u8272\u754C\u9762\uFF0C\u7EE7\u627F\u73B0\u6709 dark \u6837\u5F0F\u3002',\n  order: 0,\n  panelClassList: ['dark', 'rlh-theme-dark'],\n  colorScheme: 'dark',\n});\n\nregisterTheme({\n  id: 'gruvbox-light-hard',\n  label: 'Gruvbox',\n  description: '\u91C7\u7528 Gruvbox Light Hard \u8C03\u8272\u677F\u7684\u6D45\u8272\u4E3B\u9898\u3002',\n  order: 1,\n  panelClassList: ['rlh-theme-gruvbox'],\n  colorScheme: 'light',\n  metadata: { family: 'gruvbox', variant: 'light-hard' },\n});\n\nensureActiveThemeInternal();\n\nconst WORLD_BOOK_STATUS_DEFINITIONS = [\n  {\n    id: 'constant',\n    label: '\u6C38\u4E45\u6FC0\u6D3B',\n    shortLabel: '\u6C38\u4E45',\n    description: '\u5FFD\u7565\u5173\u952E\u8BCD\u9650\u5236\uFF0C\u53EA\u8981\u6761\u76EE\u542F\u7528\u4E14\u6EE1\u8DB3\u6982\u7387\u5C31\u59CB\u7EC8\u5C1D\u8BD5\u6FC0\u6D3B\u3002',\n    strategyType: 'constant',\n    toastLabel: '\u6C38\u4E45\u6FC0\u6D3B',\n    accentVar: THEME_VARIABLES.statusConstant,\n    badgeClass: 'rlh-status-badge--constant',\n    order: 0,\n  },\n  {\n    id: 'selective',\n    label: '\u5173\u952E\u8BCD\u89E6\u53D1',\n    shortLabel: '\u5173\u952E\u8BCD',\n    description: '\u5339\u914D\u4E3B\u8981/\u6B21\u8981\u5173\u952E\u8BCD\u540E\u6FC0\u6D3B\uFF0C\u53EF\u7ED3\u5408\u6982\u7387\u4E0E\u626B\u63CF\u6DF1\u5EA6\u63A7\u5236\u89E6\u53D1\u3002',\n    strategyType: 'selective',\n    toastLabel: '\u5173\u952E\u8BCD\u89E6\u53D1',\n    accentVar: THEME_VARIABLES.statusSelective,\n    badgeClass: 'rlh-status-badge--selective',\n    order: 1,\n  },\n  {\n    id: 'vectorized',\n    label: '\u5411\u91CF\u5316',\n    shortLabel: '\u5411\u91CF',\n    description: '\u4F9D\u8D56\u5411\u91CF\u76F8\u4F3C\u5EA6\u6FC0\u6D3B\uFF0C\u9002\u7528\u4E8E\u8BED\u4E49\u53EC\u56DE\u573A\u666F\u3002',\n    strategyType: 'vectorized',\n    toastLabel: '\u5411\u91CF\u5316',\n    accentVar: THEME_VARIABLES.statusVectorized,\n    badgeClass: 'rlh-status-badge--vectorized',\n    order: 2,\n  },\n];\n\nconst normalizedStatusDefinitions = WORLD_BOOK_STATUS_DEFINITIONS.map(def =>\n  Object.freeze({\n    ...def,\n    id: String(def.id).toLowerCase(),\n    strategyType: String(def.strategyType ?? def.id).toLowerCase(),\n    toastLabel: def.toastLabel ?? def.label,\n    shortLabel: def.shortLabel ?? def.label,\n  }),\n);\n\nconst statusMap = {};\nnormalizedStatusDefinitions.forEach(def => {\n  statusMap[def.id] = def;\n  statusMap[def.strategyType] = def;\n});\n\nexport const WORLD_BOOK_STATUS_MAP = Object.freeze(statusMap);\nexport const WORLD_BOOK_STATUS_LIST = Object.freeze([...normalizedStatusDefinitions].sort((a, b) => a.order - b.order));\nexport const DEFAULT_WORLD_BOOK_STATUS = WORLD_BOOK_STATUS_MAP.constant;\nexport const DEFAULT_STATUS_ID = DEFAULT_WORLD_BOOK_STATUS?.id ?? 'constant';\n\nexport const normalizeWorldbookStatusId = value => {\n  if (!value && value !== 0) return null;\n  const key = String(value).trim().toLowerCase();\n  return WORLD_BOOK_STATUS_MAP[key]?.id ?? null;\n};\n\nexport const resolveWorldbookStatus = statusId => {\n  const normalized = normalizeWorldbookStatusId(statusId);\n  return normalized ? WORLD_BOOK_STATUS_MAP[normalized] ?? null : null;\n};\n\nexport const resolveWorldbookStatusByStrategy = strategyType =>\n  resolveWorldbookStatus(strategyType);\n\nexport const LOREBOOK_OPTIONS = {\n  position: {\n    before_character_definition: '\u89D2\u8272\u5B9A\u4E49\u524D',\n    after_character_definition: '\u89D2\u8272\u5B9A\u4E49\u540E',\n    before_example_messages: '\u804A\u5929\u793A\u4F8B\u524D',\n    after_example_messages: '\u804A\u5929\u793A\u4F8B\u540E',\n    before_author_note: '\u4F5C\u8005\u7B14\u8BB0\u524D',\n    after_author_note: '\u4F5C\u8005\u7B14\u8BB0\u540E',\n    at_depth_as_system: '@D \u2699 \u7CFB\u7EDF',\n    at_depth_as_assistant: '@D \uD83D\uDDE8\uFE0F \u89D2\u8272',\n    at_depth_as_user: '@D \uD83D\uDC64 \u7528\u6237',\n  },\n  logic: {\n    and_any: '\u4EFB\u4E00 AND',\n    and_all: '\u6240\u6709 AND',\n    not_any: '\u4EFB\u4E00 NOT',\n    not_all: '\u6240\u6709 NOT',\n  },\n};\n\nexport const DEFAULT_FILTER_LABELS = {\n  bookName: '\u4E66\u540D',\n  entryName: '\u6761\u76EE\u540D',\n  keywords: '\u5173\u952E\u8BCD',\n  content: '\u5185\u5BB9',\n};\n\nexport const REGEX_FILTER_LABELS = {\n  entryName: '\u540D\u79F0',\n  content: '\u5185\u5BB9',\n};\n\nexport const FILTER_DEFINITIONS = {\n  bookName: { id: 'rlh-filter-book-name' },\n  entryName: { id: 'rlh-filter-entry-name' },\n  keywords: { id: 'rlh-filter-keywords' },\n  content: { id: 'rlh-filter-content' },\n};\n\nexport const SORT_OPTION_DEFINITIONS = {\n  status: { value: 'status', label: '\u6309\u542F\u7528\u72B6\u6001' },\n  name: { value: 'name', label: '\u540D\u79F0\u6392\u5E8F' },\n};\n\nexport const appState = {\n  regexes: { global: [], character: [] },\n  lorebooks: { character: [] },\n  chatLorebook: null,\n  allLorebooks: [],\n  theme: themeState,\n  lorebookEntries: new Map(),\n  pendingLorebookUpdates: new Map(), // \u5F85\u4FDD\u5B58\u7684\u4E16\u754C\u4E66\u5B57\u6BB5\u66F4\u65B0\n  pendingRegexUpdates: new Set(), // \u5F85\u4FDD\u5B58\u7684\u6B63\u5219\u66F4\u65B0\n  lorebookUsage: new Map(),\n  activeTab: 'global-lore',\n  activeView: 'global-lore-list',\n  activeBookName: null,\n  activeCharacterBook: null,\n  charLoreInitialSynced: false,\n  pendingHighlightEntry: null,\n  isDataLoaded: false,\n  isLoadingTabData: false,\n  loadingBookName: null,\n  searchFilters: { bookName: true, entryName: true, keywords: true, content: true },\n  multiSelectMode: false,\n  multiSelectTarget: 'book',\n  selectedItems: new Set(),\n  globalSearch: { term: '', replace: '' },\n  searchFilterContextsInitialized: new Set(),\n  collapseStateByContext: new Map(),\n  sortModeByContext: new Map(),\n  characterContext: { name: null, id: null }, // \u65B0\u589E\uFF1A\u7528\u4E8E\u7F13\u5B58\u89D2\u8272\u4E0A\u4E0B\u6587\n  saveStatus: 'idle',\n  saveRetryAttempt: 0,\n  isToolbarCollapsed: true,\n  isDragSortDisabled: false,\n  paths: {\n    rlhRoot: RLH_ROOT_URL,\n    vendor: RLH_ROOT_URL ? `${RLH_ROOT_URL}/vendor` : '',\n  },\n};\n\nconst normalizeLorebookName = value => {\n  if (!value && value !== 0) return '';\n  if (typeof value === 'string') return value.trim();\n  if (value && typeof value === 'object' && typeof value.name === 'string') return value.name.trim();\n  return String(value ?? '').trim();\n};\n\nconst pushUniqueString = (targetSet, rawValue) => {\n  if (!targetSet || !rawValue && rawValue !== 0) return;\n  const str = typeof rawValue === 'string' ? rawValue.trim() : String(rawValue).trim();\n  if (!str) return;\n  targetSet.add(str);\n};\n\nexport const encodeSelectionPart = value => {\n  if (value === undefined || value === null) return '';\n  return encodeURIComponent(String(value));\n};\n\nexport const decodeSelectionPart = value => {\n  if (value === undefined || value === null) return '';\n  try {\n    return decodeURIComponent(String(value));\n  } catch {\n    return String(value);\n  }\n};\n\n/**\n * \u57FA\u4E8E\u4E16\u754C\u4E66\u540D\u79F0\u751F\u6210\u591A\u9009\u952E\uFF1B\u5F53\u540D\u79F0\u65E0\u6548\u65F6\u8FD4\u56DE\u7A7A\u5B57\u7B26\u4E32\uFF0C\u8C03\u7528\u65B9\u9700\u636E\u6B64\u8DF3\u8FC7\u5199\u5165\u3002\n * @param {unknown} name \u5F85\u89C4\u8303\u5316\u7684\u4E16\u754C\u4E66\u540D\u79F0\u6216\u5BF9\u8C61\u3002\n * @returns {string} \u5F62\u5982 `book:xxx` \u7684\u952E\uFF0C\u82E5\u540D\u79F0\u4E3A\u7A7A\u5219\u8FD4\u56DE\u7A7A\u5B57\u7B26\u4E32\u3002\n */\nexport const buildBookSelectionKey = name => {\n  const normalized = normalizeLorebookName(name);\n  return normalized ? `book:${encodeSelectionPart(normalized)}` : '';\n};\n\nexport const buildLoreSelectionKey = (bookName, entryId) => {\n  const normalizedBook = normalizeLorebookName(bookName);\n  if (!normalizedBook) return '';\n  const entryPart = entryId ?? '';\n  return `lore:${encodeSelectionPart(normalizedBook)}:${encodeSelectionPart(entryPart)}`;\n};\n\nexport const buildLoreSelectionPrefix = bookName => {\n  const normalizedBook = normalizeLorebookName(bookName);\n  if (!normalizedBook) return 'lore:';\n  return `lore:${encodeSelectionPart(normalizedBook)}:`;\n};\n\nexport const buildRegexSelectionKey = identifier => `regex:${encodeSelectionPart(identifier ?? '')}`;\n\nexport const resolveLorebookBindingStats = bookOrName => {\n  const charNames = new Set();\n  const charIds = new Set();\n  const book = typeof bookOrName === 'string' ? { name: bookOrName } : bookOrName ?? {};\n  const name = normalizeLorebookName(book);\n\n  const appendCharName = value => pushUniqueString(charNames, value);\n  const appendCharId = value => pushUniqueString(charIds, value);\n\n  if (book && typeof book === 'object') {\n    if (Array.isArray(book.characters)) {\n      book.characters.forEach(appendCharName);\n    } else if (book.characters && typeof book.characters === 'object') {\n      Object.values(book.characters).forEach(appendCharName);\n    }\n\n    if (Array.isArray(book.charIds)) {\n      book.charIds.forEach(appendCharId);\n    } else if (Array.isArray(book.characterIds)) {\n      book.characterIds.forEach(appendCharId);\n    } else if (book.charIds && typeof book.charIds === 'object') {\n      Object.values(book.charIds).forEach(appendCharId);\n    }\n  }\n\n  if (name && appState.lorebookUsage instanceof Map && appState.lorebookUsage.has(name)) {\n    const usageList = appState.lorebookUsage.get(name);\n    if (Array.isArray(usageList)) {\n      usageList.forEach(appendCharName);\n    }\n  }\n\n  const bindingCount = charNames.size + charIds.size;\n  return {\n    name,\n    characters: [...charNames],\n    charIds: [...charIds],\n    bindingCount,\n  };\n};\n\nexport const isLorebookUnbound = bookOrName => resolveLorebookBindingStats(bookOrName).bindingCount === 0;\n\nconst ANALYTICS_EVENT_NAME = 'RegexLoreHubAnalytics';\nconst ANALYTICS_DEFAULT_FEATURE = 'select_unbound_lorebooks';\nconst ANALYTICS_DEFAULT_VERSION = 'v3.2';\nconst ANALYTICS_THROTTLE_INTERVAL_MS = 500;\nconst analyticsThrottleState = new Map();\n\nexport const emitAnalyticsEvent = (payload = {}) => {\n  try {\n    const now = Date.now();\n    const rawCategory = typeof payload.category === 'string' ? payload.category.trim() : '';\n    const rawAction = typeof payload.action === 'string' ? payload.action.trim() : '';\n    const category = rawCategory || 'unknown';\n    const action = rawAction || 'unknown';\n\n    const throttleKey = `${category}::${action}`;\n    const lastTrigger = analyticsThrottleState.get(throttleKey) ?? 0;\n    if (now - lastTrigger < ANALYTICS_THROTTLE_INTERVAL_MS) {\n      return;\n    }\n    analyticsThrottleState.set(throttleKey, now);\n\n    const defaultViewRaw = typeof appState.activeView === 'string' ? appState.activeView.trim() : '';\n    const normalizedFeature =\n      typeof payload.feature === 'string' && payload.feature.trim()\n        ? payload.feature.trim()\n        : ANALYTICS_DEFAULT_FEATURE;\n    const normalizedView =\n      typeof payload.view === 'string' && payload.view.trim()\n        ? payload.view.trim()\n        : defaultViewRaw || 'unknown';\n\n    const detail = {\n      source: 'regex-lore-hub',\n      timestamp: now,\n      version: ANALYTICS_DEFAULT_VERSION,\n      ...payload,\n      category,\n      action,\n      feature: normalizedFeature,\n      view: normalizedView,\n    };\n\n    const parentWin = getParentWin();\n    const CustomEvt = parentWin?.CustomEvent || (typeof CustomEvent === 'function' ? CustomEvent : null);\n\n    if (parentWin && typeof parentWin.dispatchEvent === 'function' && CustomEvt) {\n      parentWin.dispatchEvent(new CustomEvt(ANALYTICS_EVENT_NAME, { detail }));\n      return;\n    }\n\n    if (typeof window !== 'undefined' && typeof window.dispatchEvent === 'function' && CustomEvt) {\n      window.dispatchEvent(new CustomEvt(ANALYTICS_EVENT_NAME, { detail }));\n      return;\n    }\n\n    console.info('[RegexLoreHub] Analytics event captured:', detail);\n  } catch (error) {\n    console.warn('[RegexLoreHub] emitAnalyticsEvent \u8C03\u7528\u5931\u8D25\uFF1A', error);\n  }\n};\n\nexport const safeGetLorebookEntries = bookName => {\n  try {\n    if (!appState.lorebookEntries || !(appState.lorebookEntries instanceof Map)) {\n      console.warn('[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...');\n      appState.lorebookEntries = new Map();\n    }\n    if (typeof appState.lorebookEntries.get !== 'function') {\n      console.warn('[RegexLoreHub] appState.lorebookEntries.get is not a function, reinitializing...');\n      appState.lorebookEntries = new Map();\n    }\n    const entries = appState.lorebookEntries.get(bookName);\n    return Array.isArray(entries) ? entries : [];\n  } catch (error) {\n    console.error('[RegexLoreHub] Error in safeGetLorebookEntries:', error);\n    appState.lorebookEntries = new Map();\n    return [];\n  }\n};\n\nexport const safeSetLorebookEntries = (bookName, entries) => {\n  try {\n    if (!appState.lorebookEntries || !(appState.lorebookEntries instanceof Map)) {\n      console.warn('[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...');\n      appState.lorebookEntries = new Map();\n    }\n    if (typeof appState.lorebookEntries.set !== 'function') {\n      console.warn('[RegexLoreHub] appState.lorebookEntries.set is not a function, reinitializing...');\n      appState.lorebookEntries = new Map();\n    }\n    appState.lorebookEntries.set(bookName, Array.isArray(entries) ? entries : []);\n  } catch (error) {\n    console.error('[RegexLoreHub] Error in safeSetLorebookEntries:', error);\n    appState.lorebookEntries = new Map();\n    appState.lorebookEntries.set(bookName, Array.isArray(entries) ? entries : []);\n  }\n};\n\nexport const safeDeleteLorebookEntries = bookName => {\n  try {\n    if (!appState.lorebookEntries || !(appState.lorebookEntries instanceof Map)) {\n      console.warn('[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...');\n      appState.lorebookEntries = new Map();\n      return;\n    }\n    if (typeof appState.lorebookEntries.delete !== 'function') {\n      console.warn('[RegexLoreHub] appState.lorebookEntries.delete is not a function, reinitializing...');\n      appState.lorebookEntries = new Map();\n      return;\n    }\n    appState.lorebookEntries.delete(bookName);\n  } catch (error) {\n    console.error('[RegexLoreHub] Error in safeDeleteLorebookEntries:', error);\n    appState.lorebookEntries = new Map();\n  }\n};\n\nexport const safeClearLorebookEntries = () => {\n  try {\n    if (!appState.lorebookEntries || !(appState.lorebookEntries instanceof Map)) {\n      console.warn('[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...');\n      appState.lorebookEntries = new Map();\n      return;\n    }\n    if (typeof appState.lorebookEntries.clear !== 'function') {\n      console.warn('[RegexLoreHub] appState.lorebookEntries.clear is not a function, reinitializing...');\n      appState.lorebookEntries = new Map();\n      return;\n    }\n    appState.lorebookEntries.clear();\n  } catch (error) {\n    console.error('[RegexLoreHub] Error in safeClearLorebookEntries:', error);\n    appState.lorebookEntries = new Map();\n  }\n};\n\nexport const safeHasLorebookEntries = bookName => {\n  try {\n    if (!appState.lorebookEntries || !(appState.lorebookEntries instanceof Map)) {\n      console.warn('[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...');\n      appState.lorebookEntries = new Map();\n      return false;\n    }\n    if (typeof appState.lorebookEntries.has !== 'function') {\n      console.warn('[RegexLoreHub] appState.lorebookEntries.has is not a function, reinitializing...');\n      appState.lorebookEntries = new Map();\n      return false;\n    }\n    return appState.lorebookEntries.has(bookName);\n  } catch (error) {\n    console.error('[RegexLoreHub] Error in safeHasLorebookEntries:', error);\n    appState.lorebookEntries = new Map();\n    return false;\n  }\n};\n\nexport function getParentWin() {\n  return window.parent || window;\n}\n\nexport function getParentDoc() {\n  return getParentWin().document;\n}\n\nexport const escapeHtml = text => {\n  if (typeof text !== 'string') return String(text);\n  const div = getParentDoc().createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n};\n\nexport const highlightText = (text, searchTerm) => {\n  if (!searchTerm || !text) return escapeHtml(text);\n  const escapedText = escapeHtml(text);\n  const htmlSafeSearchTerm = escapeHtml(searchTerm);\n  const regexSpecialChars = new Set(['.', '*', '+', '?', '^', '$', '{', '}', '(', ')', '|', '[', ']', '\\\\\\\\']);\n  let escapedSearchTerm = '';\n  for (const char of htmlSafeSearchTerm) {\n    escapedSearchTerm += regexSpecialChars.has(char) ? '\\\\' + char : char;\n  }\n  const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');\n  return escapedText.replace(regex, '<mark class=\"rlh-highlight\">$1</mark>');\n};\n\nexport const showToast = (message, type = 'success', duration = 2000) => {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  if (!$ || !parentDoc) return;\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\n  if ($panel.length === 0) return;\n\n  $panel.find('.rlh-toast-notification').remove();\n\n  const iconClass = {\n    success: 'fa-check-circle',\n    error: 'fa-times-circle',\n    info: 'fa-info-circle',\n  }[type];\n\n  const toastHtml = `\n    <div class=\"rlh-toast-notification ${type}\">\n      <i class=\"fa-solid ${iconClass}\"></i> ${escapeHtml(message)}\n    </div>\n  `;\n\n  const $toast = $(toastHtml);\n  $panel.append($toast);\n\n  setTimeout(() => $toast.addClass('visible'), 10);\n\n  setTimeout(() => {\n    $toast.removeClass('visible');\n    setTimeout(() => $toast.remove(), 300);\n  }, duration);\n};\n\nexport const showProgressToast = (initialMessage = '\u6B63\u5728\u5904\u7406...') => {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  if (!$ || !parentDoc) return { update: () => {}, remove: () => {} };\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\n  if ($panel.length === 0) return { update: () => {}, remove: () => {} };\n  $panel.find('.rlh-progress-toast').remove();\n  const toastHtml = `<div class=\"rlh-progress-toast\"><i class=\"fa-solid fa-spinner fa-spin\"></i> <span class=\"rlh-progress-text\">${escapeHtml(initialMessage)}</span></div>`;\n  const $toast = $(toastHtml);\n  $panel.append($toast);\n  setTimeout(() => $toast.addClass('visible'), 10);\n  const update = newMessage => {\n    $toast.find('.rlh-progress-text').html(escapeHtml(newMessage));\n  };\n  const remove = () => {\n    $toast.removeClass('visible');\n    setTimeout(() => $toast.remove(), 300);\n  };\n  return { update, remove };\n};\n\nexport const showModal = options => {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  if (!$ || !parentDoc) return Promise.reject();\n  return new Promise((resolve, reject) => {\n    const { type = 'alert', title = '\u901A\u77E5', text = '', html = '', placeholder = '', value = '' } = options || {};\n    let buttonsHtml = '';\n    if (type === 'alert') buttonsHtml = '<button class=\"rlh-modal-btn rlh-modal-ok\">\u786E\u5B9A</button>';\n    else if (type === 'confirm')\n      buttonsHtml =\n        '<button class=\"rlh-modal-btn rlh-modal-cancel\">\u53D6\u6D88</button><button class=\"rlh-modal-btn rlh-modal-ok\">\u786E\u8BA4</button>';\n    else if (type === 'prompt')\n      buttonsHtml =\n        '<button class=\"rlh-modal-btn rlh-modal-cancel\">\u53D6\u6D88</button><button class=\"rlh-modal-btn rlh-modal-ok\">\u786E\u5B9A</button>';\n\n    const inputHtml =\n      type === 'prompt'\n        ? `<input type=\"text\" class=\"rlh-modal-input\" placeholder=\"${escapeHtml(placeholder)}\" value=\"${escapeHtml(value)}\">`\n        : '';\n\n    // \u4F18\u5148\u4F7F\u7528 html \u5185\u5BB9\uFF0C\u5426\u5219\u56DE\u9000\u5230 text\n    const bodyContent = html ? html : `<p>${escapeHtml(text)}</p>`;\n\n    const modalHtml = `<div class=\"rlh-modal-overlay\"><div class=\"rlh-modal-content\"><div class=\"rlh-modal-header\">${escapeHtml(title)}</div><div class=\"rlh-modal-body\">${bodyContent}${inputHtml}</div><div class=\"rlh-modal-footer\">${buttonsHtml}</div></div></div>`;\n\n    const $modal = $(modalHtml).hide();\n    const $panel = $(`#${PANEL_ID}`, parentDoc);\n    if ($panel.length > 0) $panel.append($modal);\n    else $('body', parentDoc).append($modal);\n\n    $modal.fadeIn(200);\n    const $input = $modal.find('.rlh-modal-input');\n    if (type === 'prompt') $input.focus().select();\n\n    const closeModal = (isSuccess, val) => {\n      $modal.fadeOut(200, () => {\n        $modal.remove();\n        if (isSuccess) resolve(val);\n        else reject();\n      });\n    };\n\n    $modal.on('click', '.rlh-modal-ok', () => {\n      const val = type === 'prompt' ? $input.val() : true;\n      if (type === 'prompt' && !String(val).trim()) {\n        $input.addClass('rlh-input-error');\n        setTimeout(() => $input.removeClass('rlh-input-error'), 500);\n        return;\n      }\n      closeModal(true, val);\n    });\n    $modal.on('click', '.rlh-modal-cancel', () => closeModal(false));\n    if (type === 'prompt') {\n      $input.on('keydown', e => {\n        if (e.key === 'Enter') $modal.find('.rlh-modal-ok').click();\n        else if (e.key === 'Escape') $modal.find('.rlh-modal-cancel').click();\n      });\n    }\n  });\n};\n\nexport const errorCatched = (fn, context = 'RegexLoreHub', options = {}) => {\n  const {\n    notify = 'toast',\n    toastType = 'error',\n    toastDuration = 4000,\n    toastMessage = '\u64CD\u4F5C\u53D1\u751F\u5F02\u5E38\uFF0C\u8BF7\u67E5\u770B\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u3002',\n    modalTitle = '\u811A\u672C\u5F02\u5E38',\n    modalText = '\u64CD\u4F5C\u4E2D\u53D1\u751F\u672A\u77E5\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u3002',\n  } = options ?? {};\n\n  return async (...args) => {\n    try {\n      return await fn(...args);\n    } catch (error) {\n      if (!error) return;\n      console.error(`[${context}] Error:`, error);\n\n      if (notify === 'modal') {\n        await showModal({ type: 'alert', title: modalTitle, text: modalText });\n        return;\n      }\n\n      if (notify === 'toast') {\n        showToast(toastMessage, toastType, toastDuration);\n      }\n    }\n  };\n};\n\n/**\n * \u521B\u5EFA\u4E00\u4E2A\u9632\u6296\u51FD\u6570\uFF0C\u8BE5\u51FD\u6570\u4F1A\u4ECE\u4E0A\u4E00\u6B21\u88AB\u8C03\u7528\u540E\uFF0C\u5EF6\u8FDF `delay` \u6BEB\u79D2\u540E\u8C03\u7528 `func` \u65B9\u6CD5\u3002\n * @param {Function} func \u8981\u9632\u6296\u7684\u51FD\u6570\u3002\n * @param {number} delay \u5EF6\u8FDF\u7684\u6BEB\u79D2\u6570\u3002\n * @returns {Function} \u8FD4\u56DE\u4E00\u4E2A\u65B0\u7684\u9632\u6296\u51FD\u6570\u3002\n */\nexport function debounce(func, delay) {\n  let timeout;\n  return function (...args) {\n    const context = this;\n    clearTimeout(timeout);\n    timeout = setTimeout(() => func.apply(context, args), delay);\n  };\n}\n\n/**\n * \u6839\u636E\u7ED9\u5B9A\u7684\u641C\u7D22\u8BCD\u548C\u9009\u9879\u6784\u5EFA\u4E00\u4E2A\u6B63\u5219\u8868\u8FBE\u5F0F\u5BF9\u8C61\u3002\n * @param {string} searchTerm - \u7528\u4E8E\u641C\u7D22\u7684\u5B57\u7B26\u4E32\u3002\n * @param {boolean} caseSensitive - \u662F\u5426\u533A\u5206\u5927\u5C0F\u5199\u3002\n * @returns {RegExp} - \u6784\u5EFA\u597D\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\u5BF9\u8C61\u3002\n */\nexport const buildSearchRegex = (searchTerm, caseSensitive) => {\n  const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\\]\\/\\\\]/g, '\\\\$&');\n  const flags = caseSensitive ? 'g' : 'gi';\n  return new RegExp(escapedTerm, flags);\n};\n\nexport const UI_TEXTS = {\n  INSERT_RULES_TITLE: '\u63D2\u5165\u89C4\u5219',\n  // ... \u672A\u6765\u53EF\u4EE5\u6DFB\u52A0\u66F4\u591AUI\u6587\u672C\n};\n", "import {\n  SEARCH_INPUT_ID,\n  CORE_TOOLBAR_ID,\n  REPLACE_INPUT_ID,\n  TOGGLE_COLLAPSE_BTN_ID,\n  TOGGLE_RECURSION_BTN_ID,\n  FIX_KEYWORDS_BTN_ID,\n  SORT_MENU_ID,\n  SORT_MENU_BUTTON_ID,\n  POSITION_MENU_ID,\n  POSITION_MENU_BUTTON_ID,\n  UNIFIED_STATUS_MENU_ID,\n  UNIFIED_STATUS_BUTTON_ID,\n  FILTER_DEFINITIONS,\n  SORT_OPTION_DEFINITIONS,\n  DEFAULT_FILTER_LABELS,\n  LOREBOOK_OPTIONS,\n  appState,\n  highlightText,\n  escapeHtml,\n  get$,\n  getParentDoc,\n  getParentWin,\n  errorCatched,\n  safeGetLorebookEntries,\n  safeSetLorebookEntries,\n  WORLD_BOOK_STATUS_LIST,\n  DEFAULT_WORLD_BOOK_STATUS,\n  resolveWorldbookStatus,\n  UI_TEXTS,\n  buildBookSelectionKey,\n  buildLoreSelectionKey,\n  buildLoreSelectionPrefix,\n  buildRegexSelectionKey,\n  decodeSelectionPart,\n} from '../../core.js';\nimport { saveAllChanges } from '../../dataLayer.js';\n\nexport const getContextInstanceKey = context => context.instanceKey || context.id || 'default';\n\nexport const getActiveCollapseState = context => {\n  const key = getContextInstanceKey(context);\n  return appState.collapseStateByContext.get(key) ?? 'expanded';\n};\n\nexport const setActiveCollapseState = (context, state) => {\n  const key = getContextInstanceKey(context);\n  appState.collapseStateByContext.set(key, state);\n};\n\nexport const getActiveSortMode = context => {\n  const options = Array.isArray(context.sortOptions) ? context.sortOptions : [];\n  if (!options.length) return null;\n  const key = getContextInstanceKey(context);\n  const stored = appState.sortModeByContext.get(key);\n  if (stored && options.includes(stored)) {\n    return stored;\n  }\n  const defaultValue = options[0];\n  appState.sortModeByContext.set(key, defaultValue);\n  return defaultValue;\n};\n\nexport const setActiveSortMode = (context, mode) => {\n  const options = context.sortOptions ?? [];\n  if (!options.includes(mode)) return;\n  const key = getContextInstanceKey(context);\n  appState.sortModeByContext.set(key, mode);\n};\n\nconst escapeAttr = value => escapeHtml(String(value ?? ''));\n\nconst resolveStatusMeta = statusId => resolveWorldbookStatus(statusId) ?? DEFAULT_WORLD_BOOK_STATUS;\n\nexport const buildStatusBadge = (statusId, { shortLabel = false, withIcon = true } = {}) => {\n  const statusMeta = resolveStatusMeta(statusId);\n  const label = shortLabel ? statusMeta.shortLabel : statusMeta.label;\n  const iconHtml = withIcon ? '<i class=\"fa-solid fa-circle\"></i>' : '';\n  return `<span class=\"rlh-status-badge ${statusMeta.badgeClass ?? ''}\" data-status-id=\"${escapeAttr(statusMeta.id)}\">${iconHtml}<span class=\"rlh-status-badge__text\">${escapeHtml(label)}</span></span>`;\n};\n\nconst buildUnifiedStatusOptionsHtml = () =>\n  WORLD_BOOK_STATUS_LIST.map(status => {\n    const badgeHtml = buildStatusBadge(status.id, { shortLabel: true });\n    return `<li role=\"presentation\"><button type=\"button\" class=\"rlh-unified-status-option\" data-status-id=\"${escapeAttr(status.id)}\" role=\"option\" aria-selected=\"false\">${badgeHtml}<span class=\"rlh-unified-status-option__label\">${escapeHtml(status.label)}</span></button></li>`;\n  }).join('');\n\nconst buildFilterCheckboxes = (context, filtersState) => {\n  const filters = context.visibleFilters ?? [];\n  if (!filters.length) return '';\n\n  const items = filters\n    .map(key => {\n      const definition = FILTER_DEFINITIONS[key];\n      if (!definition) return '';\n      const label = context.filterLabels?.[key] ?? DEFAULT_FILTER_LABELS[key] ?? key;\n      const isChecked = filtersState[key];\n      return `<label class=\"rlh-filter-item\"><input type=\"checkbox\" id=\"${definition.id}\" data-filter-key=\"${key}\" ${isChecked ? 'checked' : ''}>${label}</label>`;\n    })\n    .filter(Boolean)\n    .join('');\n\n  if (!items) return '';\n  return `<div class=\"rlh-filter-list\" id=\"rlh-search-filters-container\">${items}</div>`;\n};\n\nconst buildSortMenu = (context, currentSort) => {\n  const options = Array.isArray(context.sortOptions) ? context.sortOptions : [];\n  if (!options.length) return '';\n\n  const items = options\n    .map(key => {\n      const option = SORT_OPTION_DEFINITIONS[key];\n      if (!option) return '';\n      const isActive = option.value === currentSort;\n      return `<li role=\"presentation\"><button type=\"button\" class=\"rlh-sort-option${isActive ? ' active' : ''}\" data-sort-value=\"${option.value}\" role=\"option\" aria-selected=\"${isActive ? 'true' : 'false'}\">${option.label}</button></li>`;\n    })\n    .filter(Boolean)\n    .join('');\n\n  if (!items) return '';\n  const menuListId = `${SORT_MENU_ID}-list`;\n\n  return `<div class=\"rlh-sort-menu\" id=\"${SORT_MENU_ID}\" data-open=\"false\"><button type=\"button\" id=\"${SORT_MENU_BUTTON_ID}\" class=\"rlh-toolbar-btn\" data-current-sort=\"${currentSort ?? ''}\" aria-haspopup=\"listbox\" aria-expanded=\"false\" aria-controls=\"${menuListId}\"><i class=\"fa-solid fa-sort\"></i><span>\u6392\u5E8F</span></button><ul class=\"rlh-sort-menu-list\" id=\"${menuListId}\" role=\"listbox\" aria-labelledby=\"${SORT_MENU_BUTTON_ID}\">${items}</ul></div>`;\n};\n\nconst buildPositionMenu = context => {\n  if (!context.showPositionMenu) return '';\n\n  const selectionMap = new Map();\n  appState.selectedItems.forEach(key => {\n    if (typeof key !== 'string' || !key.startsWith('lore:')) return;\n    const lastSep = key.lastIndexOf(':');\n    if (lastSep === -1) return;\n    const encodedName = key.slice(5, lastSep);\n    const encodedEntryId = key.slice(lastSep + 1);\n    const name = decodeSelectionPart(encodedName);\n    const entryId = decodeSelectionPart(encodedEntryId);\n    if (!name || entryId === '') return;\n    if (!selectionMap.has(name)) selectionMap.set(name, []);\n    selectionMap.get(name).push(entryId);\n  });\n\n  let bookName = context.activeBookName?.toString().trim() ?? '';\n  if (!bookName && selectionMap.size === 1) {\n    bookName = [...selectionMap.keys()][0] ?? '';\n  }\n\n  const entries = bookName ? safeGetLorebookEntries(bookName) : [];\n  const hasEntries = entries.length > 0;\n  const isEntryMultiSelect = appState.multiSelectMode && appState.multiSelectTarget === 'entry';\n  const selectedForBook = bookName ? selectionMap.get(bookName) ?? [] : [];\n  const shouldEnable = Boolean(bookName) && (isEntryMultiSelect ? selectedForBook.length > 0 : hasEntries);\n  let tooltip;\n  if (!bookName) {\n    tooltip = selectionMap.size > 0 ? '\u591A\u9009\u6A21\u5F0F\uFF1A\u672A\u80FD\u8BC6\u522B\u9009\u4E2D\u7684\u6761\u76EE\u5F52\u5C5E\uFF0C\u8BF7\u91CD\u65B0\u9009\u62E9' : '\u8BF7\u5148\u6253\u5F00\u9700\u8981\u7EDF\u4E00\u4F4D\u7F6E\u7684\u4E16\u754C\u4E66';\n  } else if (!hasEntries && !isEntryMultiSelect) {\n    tooltip = `\u300C${bookName}\u300D\u6682\u65E0\u6761\u76EE\u53EF\u8C03\u6574`;\n  } else if (isEntryMultiSelect) {\n    tooltip = selectedForBook.length > 0\n      ? `\u591A\u9009\u6A21\u5F0F\uFF1A\u5C06\u5BF9\u5DF2\u9009\u4E2D\u7684 ${selectedForBook.length} \u4E2A\u6761\u76EE\u7EDF\u4E00\u4F4D\u7F6E`\n      : '\u5DF2\u5F00\u542F\u591A\u9009\uFF0C\u8BF7\u5148\u52FE\u9009\u8981\u8C03\u6574\u4F4D\u7F6E\u7684\u6761\u76EE';\n  } else {\n    tooltip = `\u5C06\u5BF9\u300C${bookName}\u300D\u4E2D\u7684\u6240\u6709\u6761\u76EE\u7EDF\u4E00\u4F4D\u7F6E`;\n  }\n\n  const uniquePositions = new Set(\n    entries.map(entry => (entry?.position ?? 'before_character_definition').toString()),\n  );\n  const activePosition = uniquePositions.size === 1 ? uniquePositions.values().next().value : null;\n\n  const menuListId = `${POSITION_MENU_ID}-list`;\n  const buttonAttributes = [\n    'type=\"button\"',\n    `id=\"${POSITION_MENU_BUTTON_ID}\"`,\n    'class=\"rlh-toolbar-btn\"',\n    'aria-haspopup=\"listbox\"',\n    'aria-expanded=\"false\"',\n    `aria-controls=\"${menuListId}\"`,\n    `title=\"${escapeHtml(tooltip)}\"`,\n  ];\n\n  if (!shouldEnable) {\n    buttonAttributes.push('disabled');\n  }\n\n  if (bookName) {\n    buttonAttributes.push(`data-book-name=\"${escapeHtml(bookName)}\"`);\n  }\n\n  const items = Object.entries(LOREBOOK_OPTIONS.position)\n    .map(([value, label]) => {\n      const isActive = hasEntries && activePosition === value;\n      const attributes = [\n        'type=\"button\"',\n        `class=\"rlh-position-option${isActive ? ' active' : ''}\"`,\n        `data-position-value=\"${escapeHtml(value)}\"`,\n        `role=\"option\"`,\n        `aria-selected=\"${isActive ? 'true' : 'false'}\"`,\n      ];\n      if (bookName) {\n        attributes.push(`data-book-name=\"${escapeHtml(bookName)}\"`);\n      }\n      return `<li role=\"presentation\"><button ${attributes.join(' ')}>${escapeHtml(label)}</button></li>`;\n    })\n    .join('');\n\n  const containerAttributes = [\n    'class=\"rlh-position-menu\"',\n    `id=\"${POSITION_MENU_ID}\"`,\n    'data-open=\"false\"',\n  ];\n\n  if (bookName) {\n    containerAttributes.push(`data-book-name=\"${escapeHtml(bookName)}\"`);\n  }\n\n  return `<div ${containerAttributes.join(' ')}><button ${buttonAttributes.join(' ')}><i class=\"fa-solid fa-map-pin\"></i><span>\u7EDF\u4E00\u4F4D\u7F6E</span></button><ul class=\"rlh-position-menu-list\" id=\"${menuListId}\" role=\"listbox\" aria-labelledby=\"${POSITION_MENU_BUTTON_ID}\">${items}</ul></div>`;\n};\n\nexport const renderToolbar = (context, { $toolbar, $replaceContainer }) => {\n  const collapseState = getActiveCollapseState(context);\n  const sortMode = (context.sortOptions?.length ?? 0) ? getActiveSortMode(context) : null;\n\n  const multiSelectClasses = ['rlh-toolbar-btn'];\n  if (appState.multiSelectMode) multiSelectClasses.push('active');\n  if (!context.supportsMultiSelect) multiSelectClasses.push('disabled');\n\n  const multiSelectAttributes = [\n    'type=\"button\"',\n    'id=\"rlh-multi-select-btn\"',\n    `class=\"${multiSelectClasses.join(' ')}\"`,\n    `data-target=\"${context.supportsMultiSelect ? context.multiSelectTarget : ''}\"`,\n  ];\n  if (!context.supportsMultiSelect) multiSelectAttributes.push('disabled');\n\n  const multiSelectButtonHtml = `<button ${multiSelectAttributes.join(' ')}><i class=\"fa-solid fa-check-double\"></i><span>\u591A\u9009\u6A21\u5F0F</span></button>`;\n\n  const multiSelectControlsClass = ['rlh-multi-select-controls'];\n  if (appState.multiSelectMode) multiSelectControlsClass.push('active');\n  const multiSelectControlsHtml = context.supportsMultiSelect\n    ? `\n        <div id=\"rlh-multi-select-controls\" class=\"${multiSelectControlsClass.join(' ')}\">\n          <div class=\"rlh-multi-select-actions\">\n            <button class=\"rlh-multi-select-action-btn\" id=\"rlh-select-all-btn\" title=\"\u5168\u9009\">\u5168</button>\n            <button class=\"rlh-multi-select-action-btn\" id=\"rlh-select-none-btn\" title=\"\u6E05\u9664\">\u6E05</button>\n            <button class=\"rlh-multi-select-action-btn\" id=\"rlh-select-invert-btn\" title=\"\u53CD\u9009\">\u53CD</button>\n            <button class=\"rlh-multi-select-action-btn enable\" id=\"rlh-batch-enable-btn\" title=\"\u542F\u7528\">\u5F00</button>\n            <button class=\"rlh-multi-select-action-btn disable\" id=\"rlh-batch-disable-btn\" title=\"\u7981\u7528\">\u5173</button>\n            <button class=\"rlh-multi-select-action-btn disable\" id=\"rlh-batch-delete-btn\" title=\"\u5220\u9664\">\u5220</button>\n          </div>\n          <span class=\"rlh-selection-count\" id=\"rlh-selection-count\">\u5DF2\u9009\u62E9: ${appState.selectedItems.size}</span>\n        </div>\n      `\n    : '';\n  const multiSelectModuleHtml = `\n        <div class=\"rlh-multi-select-module\">\n          ${multiSelectButtonHtml}\n          ${multiSelectControlsHtml}\n        </div>\n      `;\n\n  const unifiedStatusModuleHtml =\n    context.supportsMultiSelect && context.multiSelectTarget === 'entry'\n      ? (() => {\n          const menuId = `${UNIFIED_STATUS_MENU_ID}`;\n          const listId = `${UNIFIED_STATUS_MENU_ID}-list`;\n          const optionsHtml = buildUnifiedStatusOptionsHtml();\n          const containerClasses = ['rlh-unified-status'];\n          if (appState.multiSelectMode) containerClasses.push('is-multiselect');\n          const selectionMap = new Map();\n          appState.selectedItems.forEach(key => {\n            if (typeof key !== 'string' || !key.startsWith('lore:')) return;\n            const lastSep = key.lastIndexOf(':');\n            if (lastSep === -1) return;\n            const encodedName = key.slice(5, lastSep);\n            const encodedEntryId = key.slice(lastSep + 1);\n            const name = decodeSelectionPart(encodedName);\n            const entryId = decodeSelectionPart(encodedEntryId);\n            if (!name || entryId === '') return;\n            if (!selectionMap.has(name)) selectionMap.set(name, []);\n            selectionMap.get(name).push(entryId);\n          });\n          const fallbackNames = [\n            context.activeBookName,\n            appState.activeBookName,\n            appState.activeCharacterBook,\n            appState.chatLorebook,\n          ];\n          let resolvedBookName =\n            fallbackNames.find(name => typeof name === 'string' && name.trim().length > 0)?.toString().trim() ?? '';\n          if (!resolvedBookName && selectionMap.size === 1) {\n            resolvedBookName = [...selectionMap.keys()][0] ?? '';\n          }\n          const entries = resolvedBookName ? safeGetLorebookEntries(resolvedBookName) : [];\n          const hasEntries = entries.length > 0;\n          const isEntryMultiSelect = appState.multiSelectMode && appState.multiSelectTarget === 'entry';\n          const selectedForBook = resolvedBookName ? selectionMap.get(resolvedBookName) ?? [] : [];\n          const selectedTotal = Array.from(selectionMap.values()).reduce(\n            (sum, list) => sum + (Array.isArray(list) ? list.length : 0),\n            0,\n          );\n          const shouldEnable = Boolean(resolvedBookName) && (isEntryMultiSelect ? selectedForBook.length > 0 : hasEntries);\n          let tooltip;\n          if (!resolvedBookName) {\n            tooltip = selectionMap.size > 0 ? '\u591A\u9009\u6A21\u5F0F\uFF1A\u672A\u80FD\u8BC6\u522B\u9009\u4E2D\u7684\u6761\u76EE\u5F52\u5C5E\uFF0C\u8BF7\u91CD\u65B0\u9009\u62E9' : '\u8BF7\u5148\u6253\u5F00\u9700\u8981\u7EDF\u4E00\u72B6\u6001\u7684\u4E16\u754C\u4E66';\n          } else if (!hasEntries && !isEntryMultiSelect) {\n            tooltip = `\u300C${resolvedBookName}\u300D\u6682\u65E0\u6761\u76EE\u53EF\u8C03\u6574`;\n          } else if (isEntryMultiSelect) {\n            tooltip =\n              selectedForBook.length > 0\n                ? `\u591A\u9009\u6A21\u5F0F\uFF1A\u5C06\u5BF9\u5DF2\u9009\u4E2D\u7684 ${selectedForBook.length} \u4E2A\u6761\u76EE\u7EDF\u4E00\u72B6\u6001`\n                : '\u5DF2\u5F00\u542F\u591A\u9009\uFF0C\u8BF7\u5148\u52FE\u9009\u8981\u8C03\u6574\u72B6\u6001\u7684\u6761\u76EE';\n          } else {\n            tooltip = `\u5C06\u5BF9\u300C${resolvedBookName || '\u5F53\u524D\u4E16\u754C\u4E66'}\u300D\u7684\u6240\u6709\u6761\u76EE\u7EDF\u4E00\u72B6\u6001`;\n          }\n          return `\n            <div class=\"${containerClasses.join(' ')}\" id=\"${menuId}\" data-open=\"false\">\n              <button type=\"button\" id=\"${UNIFIED_STATUS_BUTTON_ID}\" class=\"rlh-toolbar-btn\" aria-haspopup=\"listbox\" aria-expanded=\"false\" aria-controls=\"${listId}\" ${shouldEnable ? '' : 'disabled'} title=\"${escapeHtml(tooltip)}\">\n                <i class=\"fa-solid fa-layer-group\"></i><span>\u7EDF\u4E00\u72B6\u6001</span>\n              </button>\n              <ul class=\"rlh-unified-status-menu\" id=\"${listId}\" role=\"listbox\">\n                ${optionsHtml}\n              </ul>\n            </div>\n          `;\n        })()\n      : '';\n\n  let collapseButtonHtml = '';\n  if (context.showCollapseToggle) {\n    const icon = collapseState === 'collapsed' ? 'fa-expand-arrows-alt' : 'fa-compress-arrows-alt';\n    const label = collapseState === 'collapsed' ? '\u5168\u90E8\u5C55\u5F00' : '\u5168\u90E8\u6298\u53E0';\n    collapseButtonHtml = `<button type=\"button\" id=\"${TOGGLE_COLLAPSE_BTN_ID}\" class=\"rlh-toolbar-btn\" data-collapse-state=\"${collapseState}\"><i class=\"fa-solid ${icon}\"></i><span>${label}</span></button>`;\n  }\n\n  const recursionButtonHtml = context.showRecursion\n    ? (() => {\n        const targetBookName = context.activeBookName ?? '';\n        const attributes = [\n          'type=\"button\"',\n          `id=\"${TOGGLE_RECURSION_BTN_ID}\"`,\n          'class=\"rlh-toolbar-btn rlh-batch-recursion-btn\"',\n        ];\n        if (targetBookName) {\n          attributes.push(`data-book-name=\"${escapeHtml(targetBookName)}\"`);\n        } else {\n          attributes.push('disabled');\n        }\n        return `<button ${attributes.join(' ')}><i class=\"fa-solid fa-shield-halved\"></i><span>\u5168\u5F00\u9632\u9012\u5F52</span></button>`;\n      })()\n    : '';\n\n  const fixKeywordsButtonHtml = context.showFixKeywords\n    ? (() => {\n        const targetBookName = context.activeBookName ?? '';\n        const attributes = [\n          'type=\"button\"',\n          `id=\"${FIX_KEYWORDS_BTN_ID}\"`,\n          'class=\"rlh-toolbar-btn rlh-fix-keywords-btn\"',\n        ];\n        if (targetBookName) {\n          attributes.push(`data-book-name=\"${escapeHtml(targetBookName)}\"`);\n        } else {\n          attributes.push('disabled');\n        }\n        return `<button ${attributes.join(' ')}><i class=\"fa-solid fa-check-double\"></i><span>\u4FEE\u590D\u5173\u952E\u8BCD</span></button>`;\n      })()\n    : '';\n\n  const positionMenuHtml = buildPositionMenu(context);\n  const sortMenuHtml = buildSortMenu(context, sortMode);\n  const filtersHtml = buildFilterCheckboxes(context, appState.searchFilters);\n  const scopeLabel = escapeHtml(context.scopeLabel);\n  const searchPlaceholder = escapeHtml(context.searchPlaceholder);\n  const searchValue = escapeAttr(appState.globalSearch.term ?? '');\n\n  const searchFieldHtml = `<label class=\"rlh-search-field\">\n          <input type=\"search\" id=\"${SEARCH_INPUT_ID}\" class=\"rlh-search-input\" placeholder=\"${searchPlaceholder}\" value=\"${searchValue}\" autocomplete=\"off\" />\n        </label>`;\n  const clearButtonHtml = `<button type=\"button\" id=\"rlh-search-clear-btn\" class=\"rlh-toolbar-icon-btn\" title=\"\u6E05\u7A7A\"><i class=\"fa-solid fa-eraser\"></i></button>`;\n  const searchRowHtml = `<div class=\"rlh-search-row\">${searchFieldHtml}${clearButtonHtml}</div>`;\n  const replaceValue = escapeAttr(appState.globalSearch.replace ?? '');\n  const replacePanelHtml = context.showReplace\n    ? `<div class=\"rlh-replace-body\"><input type=\"text\" id=\"${REPLACE_INPUT_ID}\" class=\"rlh-replace-input\" placeholder=\"\u66FF\u6362\u4E3A...\" value=\"${replaceValue}\" /><button type=\"button\" id=\"rlh-replace-btn\" class=\"rlh-toolbar-icon-btn rlh-replace-action\" title=\"\u66FF\u6362\"><i class=\"fa-solid fa-repeat\"></i></button></div>`\n    : '';\n  const searchMetaHtml = `<div class=\"rlh-search-meta\">\n          ${filtersHtml}\n          <span class=\"rlh-search-scope\">${scopeLabel}</span>\n        </div>`;\n  const searchBoxHtml = `<div class=\"rlh-search-box\">${searchRowHtml}${replacePanelHtml}${searchMetaHtml}</div>`;\n\n  let createEntryButtonHtml = '';\n  if (context.primaryAction?.visible && context.primaryAction.scope === 'entry') {\n    const bookNameForCreate = context.activeBookName ?? '';\n    const disabled = !bookNameForCreate;\n    const buttonClasses = ['rlh-toolbar-btn', 'rlh-create-entry-btn'];\n    if (disabled) buttonClasses.push('disabled');\n    const attributes = [\n      'type=\"button\"',\n      `class=\"${buttonClasses.join(' ')}\"`,\n    ];\n    const actionTitle = context.primaryAction.title ?? context.primaryAction.label ?? '';\n    if (actionTitle) attributes.push(`title=\"${escapeHtml(actionTitle)}\"`);\n    if (disabled) attributes.push('disabled');\n    else attributes.push(`data-book-name=\"${escapeHtml(bookNameForCreate)}\"`);\n    const iconClass = context.primaryAction.icon ? context.primaryAction.icon : 'fa-file-circle-plus';\n    const label = escapeHtml(context.primaryAction.label ?? '\u65B0\u5EFA\u6761\u76EE');\n    createEntryButtonHtml = `<button ${attributes.join(' ')}><i class=\"fa-solid ${iconClass}\"></i><span>${label}</span></button>`;\n  }\n\n  let createBookButtonHtml = '';\n  if (context.primaryAction?.visible && context.primaryAction.scope === 'book') {\n    const buttonClasses = ['rlh-toolbar-btn', 'rlh-create-book-btn'];\n    const attributes = [\n      'type=\"button\"',\n      'id=\"regex-lore-hub-create-lorebook-btn\"',\n      `class=\"${buttonClasses.join(' ')}\"`,\n    ];\n    const actionTitle = context.primaryAction.title ?? context.primaryAction.label ?? '';\n    if (actionTitle) attributes.push(`title=\"${escapeHtml(actionTitle)}\"`);\n    const iconClass = context.primaryAction.icon ? context.primaryAction.icon : 'fa-plus';\n    const label = escapeHtml(context.primaryAction.label ?? '\u65B0\u5EFA\u4E16\u754C\u4E66');\n    createBookButtonHtml = `<button ${attributes.join(' ')}><i class=\"fa-solid ${iconClass}\"></i><span>${label}</span></button>`;\n  }\n\n  const selectUnboundButtonHtml =\n    context.id === 'global-lore-list'\n      ? `<button type=\"button\" class=\"rlh-toolbar-btn rlh-select-unbound\" title=\"\u4E00\u952E\u9009\u4E2D\u672A\u7ED1\u5B9A\u4EFB\u4F55\u89D2\u8272\u5361\u7684\u4E16\u754C\u4E66\"><i class=\"fa-solid fa-link-slash\"></i><span>\u9009\u62E9\u5B64\u7ACB\u4E16\u754C\u4E66</span></button>`\n      : '';\n\n  const searchSectionHtml = `\n    <div class=\"rlh-toolbar-section rlh-toolbar-section--search\">\n      <div class=\"rlh-search-section-grid\">\n        <div class=\"rlh-search-section-main\">\n          ${searchBoxHtml}\n        </div>\n        <div class=\"rlh-search-section-multiselect\">\n          ${multiSelectModuleHtml}\n        </div>\n      </div>\n    </div>\n  `;\n\n  const actionsItems = [\n    createBookButtonHtml,\n    selectUnboundButtonHtml,\n    createEntryButtonHtml,\n    context.showCollapseToggle ? collapseButtonHtml : '',\n    recursionButtonHtml,\n    fixKeywordsButtonHtml,\n    unifiedStatusModuleHtml,\n    positionMenuHtml,\n    sortMenuHtml,\n  ].filter(Boolean);\n\n  const actionsSectionHtml = actionsItems.length\n    ? `\n        <div class=\"rlh-toolbar-section rlh-toolbar-section--actions\">\n          <div class=\"rlh-toolbar-actions\">\n            ${actionsItems.join('')}\n          </div>\n        </div>\n      `\n    : '';\n\n  const toolbarSectionsHtml = [searchSectionHtml, actionsSectionHtml].filter(Boolean).join('');\n\n  const toolbarHtml = `\n    <div class=\"rlh-toolbar-inner\">\n      ${toolbarSectionsHtml}\n    </div>\n\n  `;\n\n  $toolbar.html(toolbarHtml);\n\n  if (context.supportsMultiSelect && context.multiSelectTarget === 'entry') {\n    const fallbackNames = [\n      context.activeBookName,\n      appState.activeBookName,\n      appState.activeCharacterBook,\n      appState.chatLorebook,\n    ];\n    const resolvedBookName =\n      fallbackNames.find(name => typeof name === 'string' && name.trim().length > 0)?.toString().trim() ?? '';\n    const entries = resolvedBookName ? safeGetLorebookEntries(resolvedBookName) : [];\n    const hasEntries = entries.length > 0;\n    const isEntryMultiSelect = appState.multiSelectMode && appState.multiSelectTarget === 'entry';\n    const lorePrefix = buildLoreSelectionPrefix(resolvedBookName);\n    const hasSelection =\n      isEntryMultiSelect &&\n      entries.length > 0 &&\n      [...appState.selectedItems].some(key => typeof key === 'string' && key.startsWith(lorePrefix));\n    const shouldEnable = hasEntries && (!isEntryMultiSelect || hasSelection);\n    const tooltip = !hasEntries\n      ? (resolvedBookName ? `\u300C${resolvedBookName}\u300D\u6682\u65E0\u6761\u76EE\u53EF\u8C03\u6574` : '\u8BF7\u5148\u6253\u5F00\u9700\u8981\u7EDF\u4E00\u72B6\u6001\u7684\u4E16\u754C\u4E66')\n      : isEntryMultiSelect\n        ? (hasSelection ? '\u591A\u9009\u6A21\u5F0F\uFF1A\u4EC5\u5BF9\u9009\u4E2D\u7684\u6761\u76EE\u7EDF\u4E00\u72B6\u6001' : '\u5DF2\u5F00\u542F\u591A\u9009\uFF0C\u8BF7\u5148\u52FE\u9009\u8981\u8C03\u6574\u72B6\u6001\u7684\u6761\u76EE')\n        : `\u5C06\u5BF9\u300C${resolvedBookName || '\u5F53\u524D\u4E16\u754C\u4E66'}\u300D\u7684\u6240\u6709\u6761\u76EE\u7EDF\u4E00\u72B6\u6001`;\n    const $unifiedButton = $(`#${UNIFIED_STATUS_BUTTON_ID}`, $toolbar);\n    if ($unifiedButton.length) {\n      $unifiedButton.attr('title', tooltip);\n      if (shouldEnable) $unifiedButton.removeAttr('disabled');\n      else $unifiedButton.attr('disabled', 'disabled');\n    }\n  }\n\n  $replaceContainer.empty();\n};\n\nexport const matchEntry = (entry, searchTerm) => {\n  const term = searchTerm.toLowerCase();\n  if (!term) return true;\n  if (appState.searchFilters.entryName && (entry.name || '').toLowerCase().includes(term)) {\n    return true;\n  }\n  if (appState.searchFilters.keywords && entry.keys.join(' ').toLowerCase().includes(term)) {\n    return true;\n  }\n  if (appState.searchFilters.content && entry.content && entry.content.toLowerCase().includes(term)) {\n    return true;\n  }\n  return false;\n};\n\nexport const matchRegex = (item, searchTerm) => {\n  const term = searchTerm.toLowerCase();\n  if (appState.searchFilters.entryName && (item.script_name || '').toLowerCase().includes(term)) {\n    return true;\n  }\n  if (appState.searchFilters.content && (item.find_regex || '').toLowerCase().includes(term)) {\n    return true;\n  }\n  if (appState.searchFilters.content && (item.replace_string || '').toLowerCase().includes(term)) {\n    return true;\n  }\n  return false;\n};\n\nexport const createGlobalLorebookElement = (book, searchTerm, forceShowAllEntries, filteredEntries) => {\n  const $ = get$();\n  const usedByChars = appState.lorebookUsage.get(book.name) || [];\n  const usedByHtml =\n    usedByChars.length > 0\n      ? `<div class=\"rlh-used-by-chars\">\u4F7F\u7528\u8005: ${usedByChars.map(char => `<span>${escapeHtml(char)}</span>`).join(', ')}</div>`\n      : '';\n\n  const highlightedBookName = highlightText(book.name, searchTerm);\n  const selectionAllowed = appState.multiSelectMode && appState.multiSelectTarget === 'book';\n  const selectionKey = buildBookSelectionKey(book.name);\n  const hasSelectionKey = typeof selectionKey === 'string' && selectionKey.length > 0;\n  const isSelected = selectionAllowed && hasSelectionKey && appState.selectedItems.has(selectionKey);\n  const selectionControl = selectionAllowed\n    ? `<label class=\"rlh-selection-control\"><input type=\"checkbox\" class=\"rlh-multi-select-checkbox\" data-select-key=\"${escapeHtml(selectionKey)}\" ${isSelected ? 'checked' : ''}></label>`\n    : '';\n\n  const $element = $(`\n      <div class=\"rlh-book-group\" data-book-name=\"${escapeHtml(book.name)}\" data-select-key=\"${escapeHtml(selectionKey)}\">\n          <div class=\"rlh-global-book-header rlh-clickable-header\">\n              ${selectionControl}\n              <div class=\"rlh-book-title-wrapper\">\n                  <span class=\"rlh-item-name\">${highlightedBookName}</span>\n                  <div class=\"rlh-book-stats\">\u6761\u76EE: ${book.enabledEntryCount} / ${book.entryCount}</div>\n              </div>\n              <div class=\"rlh-item-controls\">\n                  <button class=\"rlh-action-btn-icon rlh-rename-book-btn\" title=\"\u91CD\u547D\u540D\u4E16\u754C\u4E66\"><i class=\"fa-solid fa-pen-to-square\"></i></button>\n                  <button class=\"rlh-toggle-btn rlh-global-toggle\" title=\"\u542F\u7528/\u7981\u7528\u6574\u4E2A\u4E16\u754C\u4E66\"><i class=\"fa-solid fa-power-off\"></i></button>\n                  <button class=\"rlh-action-btn-icon rlh-delete-book-btn\" title=\"\u5220\u9664\u4E16\u754C\u4E66\"><i class=\"fa-solid fa-folder-minus\"></i></button>\n              </div>\n          </div>\n          ${usedByChars.length > 0 ? `<div class=\"rlh-book-summary\">${usedByHtml}</div>` : ''}\n          <div class=\"rlh-collapsible-content\"></div>\n      </div>\n    `);\n\n  $element.toggleClass('enabled', book.enabled);\n  $element.find('.rlh-global-book-header').toggleClass('enabled', book.enabled);\n  $element.toggleClass('selected', isSelected);\n\n  const $content = $element.find('.rlh-collapsible-content');\n  const $entryActions = $(\n    `<div class=\"rlh-entry-actions\"><button class=\"rlh-action-btn rlh-create-entry-btn\" data-book-name=\"${escapeHtml(book.name)}\"><i class=\"fa-solid fa-plus\"></i> \u65B0\u5EFA\u6761\u76EE</button><button class=\"rlh-action-btn rlh-batch-recursion-btn\" data-book-name=\"${escapeHtml(book.name)}\"><i class=\"fa-solid fa-shield-halved\"></i> \u5168\u5F00\u9632\u9012\u5F52</button><button class=\"rlh-action-btn rlh-fix-keywords-btn\" data-book-name=\"${escapeHtml(book.name)}\"><i class=\"fa-solid fa-check-double\"></i> \u4FEE\u590D\u5173\u952E\u8BCD</button></div>`,\n  );\n  $content.append($entryActions);\n\n  let allEntries = [...safeGetLorebookEntries(book.name)].sort(\n    (a, b) => ((a.display_index ?? Number.MAX_SAFE_INTEGER) - (b.display_index ?? Number.MAX_SAFE_INTEGER)),\n  );\n  let entriesToShow = forceShowAllEntries ? allEntries : filteredEntries || [];\n\n  if (entriesToShow && entriesToShow.length > 0) {\n    const $listWrapper = $('<div class=\"rlh-entry-list-wrapper\"></div>');\n    entriesToShow.forEach(entry => $listWrapper.append(createItemElement(entry, 'lore', book.name, searchTerm, { enableDrag: false })));\n    $content.append($listWrapper);\n  } else if (searchTerm) {\n    $content.append(`<div class=\"rlh-info-text-small\">\u65E0\u5339\u914D\u9879</div>`);\n  }\n\n  return $element;\n};\n\nconst convertMultilineToHtml = html => (typeof html === 'string' ? html.replace(/\\r?\\n/g, '<br>') : html);\nconst buildViewerPlaceholder = text => `<span class=\"rlh-viewer-empty\">${escapeHtml(text)}</span>`;\n\nexport const buildLoreEntryViewerHTML = (entry, searchTerm) => {\n  const statusMeta = resolveStatusMeta(entry?.statusId);\n  const statusBadgeHtml = buildStatusBadge(statusMeta.id);\n  const keywords = Array.isArray(entry?.keys) ? entry.keys : [];\n  const keywordsText = keywords.join(', ');\n  const keywordsHtml = keywordsText\n    ? convertMultilineToHtml(searchTerm ? highlightText(keywordsText, searchTerm) : escapeHtml(keywordsText))\n    : buildViewerPlaceholder('\u6682\u65E0\u5173\u952E\u8BCD');\n  const rawContent = entry?.content ?? '';\n  const contentHtml = rawContent\n    ? convertMultilineToHtml(searchTerm ? highlightText(rawContent, searchTerm) : escapeHtml(rawContent))\n    : buildViewerPlaceholder('\u6682\u65E0\u5185\u5BB9');\n\n  const hasValue = value => value !== undefined && value !== null && value !== '';\n  const formatViewerText = (value, placeholder = '\u672A\u8BBE\u7F6E') => {\n    if (!hasValue(value)) {\n      return buildViewerPlaceholder(placeholder);\n    }\n    return escapeHtml(String(value));\n  };\n\n  const buildViewerField = field => {\n    if (!field) return '';\n    const { label, value, placeholder, html } = field;\n    const body = html !== undefined ? html : formatViewerText(value, placeholder);\n    return `\n      <div class=\"rlh-editor-field rlh-viewer-field\">\n        <label>${label}</label>\n        <div class=\"rlh-viewer-text\">${body}</div>\n      </div>\n    `;\n  };\n\n  const buildViewerGroup = (title, fields, options = {}) => {\n    if (!fields.length) return '';\n    const layout = options.layout ?? 'grid';\n    const headingHtml = title ? `<h5>${title}</h5>` : '';\n    let contentHtml = '';\n    if (layout === 'grid') {\n      const itemsHtml = fields\n        .map(field => `\n          <div class=\"rlh-grid-item\">${buildViewerField(field)}</div>`)\n        .join('');\n      contentHtml = `\n        <div class=\"rlh-editor-grid\">${itemsHtml}\n        </div>\n      `;\n    } else {\n      contentHtml = fields.map(buildViewerField).join('');\n    }\n    return `\n      <div class=\"rlh-editor-group rlh-viewer-group\">\n        ${headingHtml}\n        ${contentHtml}\n      </div>\n    `;\n  };\n\n    const positionLabel = (() => {\n      const pos = entry?.position;\n      if (!hasValue(pos)) return null;\n\n      // \u65B0\u7248\uFF1Aposition \u662F\u4E00\u4E2A\u5E26 type \u5C5E\u6027\u7684\u5BF9\u8C61\n      if (typeof pos === 'object' && pos !== null && typeof pos.type === 'string' && pos.type) {\n        return LOREBOOK_OPTIONS.position?.[pos.type] ?? pos.type;\n      }\n\n      // \u65E7\u7248\uFF1Aposition \u662F\u4E00\u4E2A\u5B57\u7B26\u4E32\n      if (typeof pos === 'string') {\n        return LOREBOOK_OPTIONS.position?.[pos] ?? pos;\n      }\n\n      // \u5BF9\u4E8E\u6240\u6709\u5176\u4ED6\u610F\u5916\u60C5\u51B5\uFF08\u5982\u65E0 type \u7684\u5BF9\u8C61\uFF09\uFF0C\u5B89\u5168\u5730\u8FD4\u56DE null\n      return null;\n    })();\n  const depthValue = hasValue(entry?.depth) ? entry.depth : null;\n  const orderValue = hasValue(entry?.order) ? entry.order : null;\n\n  const hasLogic = hasValue(entry?.logic);\n  const logicKey = hasLogic ? entry.logic : 'and_any';\n  const logicBaseLabel = LOREBOOK_OPTIONS.logic?.[logicKey] ?? logicKey;\n  const logicValue = hasLogic ? logicBaseLabel : `${logicBaseLabel} (\u9ED8\u8BA4)`;\n\n  const probabilityValue = hasValue(entry?.probability)\n    ? `${entry.probability}%`\n    : '100% (\u9ED8\u8BA4)';\n\n  const keywordsField = buildViewerField({ label: '\u5173\u952E\u8BCD', html: keywordsHtml });\n  const contentField = buildViewerField({\n    label: '\u5185\u5BB9',\n    html: `<article class=\"rlh:prose rlh:dark:rlh:prose-invert max-w-none\">${contentHtml}</article>`,\n  });\n\n  const insertRuleGroup = buildViewerGroup(UI_TEXTS.INSERT_RULES_TITLE, [\n    { label: '\u4F4D\u7F6E', value: positionLabel, placeholder: '\u672A\u8BBE\u7F6E' },\n    { label: '\u6DF1\u5EA6', value: depthValue, placeholder: '\u672A\u8BBE\u7F6E' },\n    { label: '\u987A\u5E8F', value: orderValue, placeholder: '\u672A\u8BBE\u7F6E' },\n  ], { layout: 'grid' });\n  const activationGroup = buildViewerGroup('\u6FC0\u6D3B\u903B\u8F91', [\n    { label: '\u6982\u7387', value: probabilityValue, placeholder: '100% (\u9ED8\u8BA4)' },\n    { label: '\u5173\u952E\u8BCD\u903B\u8F91', value: logicValue, placeholder: '\u4EFB\u4E00 AND (\u9ED8\u8BA4)' },\n  ], { layout: 'grid' });\n  const matchingGroup = buildViewerGroup('\u5339\u914D\u4E0E\u9012\u5F52', [\n    { label: '\u5927\u5C0F\u5199\u654F\u611F', value: entry?.case_sensitive ? '\u5F00\u542F' : '\u5173\u95ED', placeholder: '\u5173\u95ED' },\n    { label: '\u5168\u8BCD\u5339\u914D', value: entry?.match_whole_words ? '\u5F00\u542F' : '\u5173\u95ED', placeholder: '\u5173\u95ED' },\n    { label: '\u9632\u6B62\u9012\u5F52', value: entry?.prevent_recursion ? '\u5F00\u542F' : '\u5173\u95ED', placeholder: '\u5173\u95ED' },\n    { label: '\u4E0D\u53EF\u88AB\u9012\u5F52', value: entry?.exclude_recursion ? '\u5F00\u542F' : '\u5173\u95ED', placeholder: '\u5173\u95ED' },\n  ], { layout: 'grid' });\n  const statusGroup = buildViewerGroup('\u72B6\u6001', [\n    { label: '\u5F53\u524D\u72B6\u6001', html: statusBadgeHtml },\n  ], { layout: 'grid' });\n\n  return `\n    <div class=\"rlh-entry-viewer\" data-mode=\"view\">\n      ${statusGroup}\n      ${keywordsField}\n      ${contentField}\n      ${insertRuleGroup}\n      ${activationGroup}\n      ${matchingGroup}\n    </div>\n  `;\n};\n\nexport const buildRegexViewerHTML = (item, searchTerm) => {\n  const findRaw = item?.find_regex ?? '';\n  const replaceRaw = item?.replace_string ?? '';\n  const normalizedTerm = typeof searchTerm === 'string' ? searchTerm : '';\n  const findHtml = findRaw\n    ? convertMultilineToHtml(normalizedTerm ? highlightText(findRaw, normalizedTerm) : escapeHtml(findRaw))\n    : buildViewerPlaceholder('\u6682\u65E0\u67E5\u627E\u6B63\u5219');\n  const replaceHtml = replaceRaw\n    ? convertMultilineToHtml(normalizedTerm ? highlightText(replaceRaw, normalizedTerm) : escapeHtml(replaceRaw))\n    : buildViewerPlaceholder('\u6682\u65E0\u66FF\u6362\u5185\u5BB9');\n\n  const destination = item?.destination ?? {};\n  const source = item?.source ?? {};\n  const minDepth = item?.min_depth;\n  const maxDepth = item?.max_depth;\n\n  const destinationLabels = [];\n  if (destination.display) destinationLabels.push('\u4EC5\u683C\u5F0F\u663E\u793A');\n  if (destination.prompt) destinationLabels.push('\u4EC5\u683C\u5F0F\u63D0\u793A\u8BCD');\n  const destinationText = destinationLabels.length\n    ? destinationLabels.join(' / ')\n    : '\u683C\u5F0F\u4E0E\u63D0\u793A\u8BCD';\n\n  const sourceMapping = {\n    user_input: '\u7528\u6237\u8F93\u5165',\n    ai_output: 'AI\u8F93\u51FA',\n    slash_command: '\u659C\u6760\u547D\u4EE4',\n    world_info: '\u4E16\u754C\u4E66',\n  };\n  const activeSources = Object.entries(sourceMapping)\n    .filter(([key]) => Boolean(source?.[key]))\n    .map(([, label]) => label);\n  const sourceText = activeSources.length === 0\n    ? '\u672A\u9009\u62E9\u4F5C\u7528\u8303\u56F4'\n    : activeSources.length === 4\n    ? '\u5168\u90E8\u6765\u6E90'\n    : activeSources.join(' / ');\n\n  const hasMin = minDepth !== undefined && minDepth !== null && minDepth !== '';\n  const hasMax = maxDepth !== undefined && maxDepth !== null && maxDepth !== '';\n  let depthText = '\u65E0\u6DF1\u5EA6\u9650\u5236';\n  if (hasMin && hasMax) depthText = `${minDepth} - ${maxDepth}`;\n  else if (hasMin) depthText = `>= ${minDepth}`;\n  else if (hasMax) depthText = `<= ${maxDepth}`;\n\n  const metaRows = [\n    { label: '\u8F93\u51FA\u8BBE\u7F6E', value: destinationText },\n    { label: '\u4F5C\u7528\u8303\u56F4', value: sourceText },\n    { label: '\u6DF1\u5EA6\u8303\u56F4', value: depthText },\n  ];\n\n  const metaHtml = metaRows\n    .map(row => `\n      <div class=\"rlh-editor-field rlh-viewer-field\">\n        <label>${row.label}</label>\n        <div class=\"rlh-viewer-text\">${escapeHtml(String(row.value ?? ''))}</div>\n      </div>\n    `)\n    .join('');\n\n  return `\n    <div class=\"rlh-regex-viewer\" data-mode=\"view\">\n      <div class=\"rlh-editor-field rlh-viewer-field\">\n        <label>\u67E5\u627E\u6B63\u5219\u8868\u8FBE\u5F0F</label>\n        <article class=\"rlh:prose rlh:dark:rlh:prose-invert max-w-none\">${findHtml}</article>\n      </div>\n      <div class=\"rlh-editor-field rlh-viewer-field\">\n        <label>\u66FF\u6362\u4E3A</label>\n        <article class=\"rlh:prose rlh:dark:rlh:prose-invert max-w-none\">${replaceHtml}</article>\n      </div>\n      ${metaHtml}\n    </div>\n  `;\n};\n\nexport const createItemElement = (item, type, bookName = '', searchTerm = '', options = {}) => {\n  const $ = get$();\n  const isLore = type === 'lore';\n  const id = isLore ? item.uid : item.id;\n  const name = isLore ? item.name || '\u65E0\u6807\u9898\u6761\u76EE' : item.script_name || '\u672A\u547D\u540D\u6B63\u5219';\n  const fromCard = item.source === 'card';\n  const collapseState = options.collapseState ?? 'expanded';\n  const isExpanded = options.isExpanded ?? false;\n  const enableDrag = options.enableDrag ?? true;\n  const dragRequested = enableDrag && !fromCard;\n  const dragDisabled = dragRequested && appState.isDragSortDisabled;\n  const dragHandleTitle = dragDisabled ? '\u62D6\u62FD\u529F\u80FD\u4E0D\u53EF\u7528\uFF1A\u6392\u5E8F\u811A\u672C\u672A\u52A0\u8F7D' : '\u62D6\u62FD\u6392\u5E8F';\n  const dragHandleDisabledAttrs = dragDisabled ? ' data-disabled=\"true\" aria-disabled=\"true\" style=\"cursor: not-allowed; opacity: 0.6;\"' : '';\n  const dragHandleHtml =\n    dragRequested\n      ? `<span class=\"rlh-drag-handle${dragDisabled ? ' rlh-drag-handle--disabled' : ''}\" title=\"${escapeHtml(dragHandleTitle)}\"${\n          dragHandleDisabledAttrs\n        }><i class=\"fa-solid fa-grip-vertical\"></i></span>`\n      : '';\n  const selectionKey =\n    options.selectionKey ?? (isLore ? buildLoreSelectionKey(bookName, id) : buildRegexSelectionKey(id));\n  const target = appState.multiSelectTarget;\n  const selectionAllowed =\n    appState.multiSelectMode &&\n    ((target === 'entry' && isLore) || (target === 'regex' && !isLore));\n  const isSelected = selectionAllowed && appState.selectedItems.has(selectionKey);\n\n  let controlsHtml = '';\n\n  if (isLore) {\n    controlsHtml = `\n      <button class=\"rlh-action-btn-icon rlh-rename-btn\" title=\"\u91CD\u547D\u540D\u5E76\u7F16\u8F91\"><i class=\"fa-solid fa-pencil\"></i></button>\n      <button class=\"rlh-toggle-btn rlh-item-toggle\" title=\"\u542F\u7528/\u7981\u7528\u6B64\u6761\u76EE\"><i class=\"fa-solid fa-power-off\"></i></button>\n      <button class=\"rlh-action-btn-icon rlh-delete-entry-btn\" title=\"\u5220\u9664\u6761\u76EE\"><i class=\"fa-solid fa-trash-can\"></i></button>\n    `;\n  } else if (fromCard) {\n    controlsHtml = '<button class=\"rlh-toggle-btn rlh-item-toggle\" title=\"\u542F\u7528/\u7981\u7528\u6B64\u6761\u76EE\"><i class=\"fa-solid fa-power-off\"></i></button>';\n  } else {\n    controlsHtml = `\n      <button class=\"rlh-action-btn-icon rlh-rename-btn\" title=\"\u91CD\u547D\u540D\u5E76\u7F16\u8F91\"><i class=\"fa-solid fa-pencil\"></i></button>\n      <button class=\"rlh-toggle-btn rlh-item-toggle\" title=\"\u542F\u7528/\u7981\u7528\u6B64\u6761\u76EE\"><i class=\"fa-solid fa-power-off\"></i></button>\n    `;\n  }\n\n  const selectionControl = selectionAllowed\n    ? `<label class=\"rlh-selection-control\"><input type=\"checkbox\" class=\"rlh-multi-select-checkbox\" data-select-key=\"${escapeHtml(selectionKey)}\" ${isSelected ? 'checked' : ''}></label>`\n    : '';\n\n  const headerTitle = fromCard\n    ? '\u6B64\u6761\u76EE\u6765\u81EA\u89D2\u8272\u5361\uFF0C\u90E8\u5206\u64CD\u4F5C\u53D7\u9650'\n    : selectionAllowed\n    ? '\u70B9\u51FB\u9009\u62E9/\u53D6\u6D88\u9009\u62E9'\n    : '\u70B9\u51FB\u5C55\u5F00/\u7F16\u8F91';\n\n  const highlightedName = highlightText(name, searchTerm);\n  const statusMeta = isLore ? resolveStatusMeta(item.statusId) : null;\n  const statusBadgeHtml = isLore ? buildStatusBadge(statusMeta.id, { shortLabel: true }) : '';\n\n  let metaHtml = '';\n  if (isLore) {\n    const positionKey = (item.position ?? 'before_character_definition').toString();\n    const positionLabelRaw = LOREBOOK_OPTIONS.position?.[positionKey] ?? '\u9ED8\u8BA4\u4F4D\u7F6E';\n    const positionLabel = escapeHtml(positionLabelRaw);\n    const orderNumber = Number(item.order);\n    const fallbackOrder = Number(item.display_index);\n    const effectiveOrder = Number.isFinite(orderNumber)\n      ? `#${orderNumber}`\n      : Number.isFinite(fallbackOrder)\n      ? `#${fallbackOrder}`\n      : '\u672A\u8BBE\u7F6E';\n    const orderLabel = escapeHtml(effectiveOrder);\n    metaHtml = `\n          <div class=\"rlh-item-meta\" title=\"\u63D2\u5165\u4E0E\u987A\u5E8F\u4FE1\u606F\">\n            <span class=\"rlh-item-meta-chip\"><i class=\"fa-solid fa-map-pin\"></i>\u63D2\u5165 ${positionLabel}</span>\n            <span class=\"rlh-item-meta-chip\"><i class=\"fa-solid fa-list-ol\"></i>\u987A\u5E8F ${orderLabel}</span>\n          </div>\n        `;\n  }\n\n  const dragStateAttr = dragRequested\n    ? ` data-drag-enabled=\"${dragDisabled ? 'false' : 'true'}\"${dragDisabled ? ' data-drag-disabled=\"true\"' : ''}`\n    : '';\n  const $element = $(\n    `<div class=\"rlh-item-container ${fromCard ? 'from-card' : ''}\" data-type=\"${type}\" data-id=\"${id}\" ${isLore ? `data-book-name=\"${escapeHtml(bookName)}\"` : ''} data-select-key=\"${escapeHtml(selectionKey)}\"${isLore ? ` data-status-id=\"${escapeAttr(statusMeta.id)}\"` : ''}${dragStateAttr}>\n      <div class=\"rlh-item-header\" title=\"${headerTitle}\">\n        ${selectionControl}\n        ${dragHandleHtml}\n        <div class=\"rlh-item-header-main\">\n          <div class=\"rlh-item-title-row\">\n            <span class=\"rlh-item-name\">${highlightedName}</span>\n            ${statusBadgeHtml}\n          </div>\n          ${metaHtml}\n        </div>\n        <div class=\"rlh-item-controls\">${controlsHtml}</div>\n      </div>\n      <div class=\"rlh-collapsible-content\"></div>\n    </div>`\n  );\n\n  $element.data('searchTerm', searchTerm);\n  $element.attr('data-search-term', typeof searchTerm === 'string' ? searchTerm : '');\n  $element.toggleClass('enabled', item.enabled);\n  $element.toggleClass('selected', isSelected);\n\n  const $content = $element.find('.rlh-collapsible-content');\n  let initialMode = options.initialMode;\n  if (!initialMode && searchTerm) {\n    initialMode = 'viewer';\n  }\n\n  if (isExpanded) {\n    $element.removeClass('rlh-collapsed');\n    $content.show();\n    $element.attr('data-entry-mode', 'edit');\n  } else if (initialMode === 'viewer') {\n    const viewerHtml = isLore\n      ? buildLoreEntryViewerHTML(item, searchTerm)\n      : buildRegexViewerHTML(item, searchTerm);\n    $content.html(viewerHtml);\n    $content.show();\n    $element.removeClass('rlh-collapsed');\n    $element.attr('data-entry-mode', 'view');\n  } else if (collapseState === 'collapsed') {\n    $element.addClass('rlh-collapsed');\n    $content.hide();\n    $element.attr('data-entry-mode', initialMode ?? 'collapsed');\n  } else {\n    $element.removeClass('rlh-collapsed');\n    $element.attr('data-entry-mode', initialMode ?? 'collapsed');\n  }\n\n  return $element;\n};\n\nexport const prependEntry = (entry, bookName) => {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  const $listWrapper = $('.rlh-entry-list-wrapper', parentDoc);\n\n  if ($listWrapper.length > 0) {\n    $listWrapper.find('.rlh-info-text').remove();\n\n    const $newEntryDom = createItemElement(entry, 'lore', bookName, '', { isExpanded: true, enableDrag: false });\n    $listWrapper.prepend($newEntryDom);\n    return $newEntryDom;\n  }\n  return null;\n};\n\nexport const updateSelectionCount = () => {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  $(`#rlh-selection-count`, parentDoc).text(`\u5DF2\u9009\u62E9: ${appState.selectedItems.size}`);\n};\n\nexport const updateEntryStatusDom = (bookName, entryId, statusId) => {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  const hasEntryId = entryId !== undefined && entryId !== null;\n  const numericIdCandidate = hasEntryId ? Number(entryId) : NaN;\n  const isNumericTarget = Number.isInteger(numericIdCandidate);\n\n  const matchEntryId = candidate => {\n    if (candidate === undefined || candidate === null) return false;\n    if (isNumericTarget) {\n      const numericCandidate = Number(candidate);\n      if (Number.isInteger(numericCandidate)) return numericCandidate === numericIdCandidate;\n    }\n    return String(candidate) === String(entryId);\n  };\n\n  const $container = $('.rlh-item-container[data-type=\"lore\"]', parentDoc)\n    .filter((_, el) => {\n      const $el = $(el);\n      const candidateBook = $el.data('book-name') ?? $el.attr('data-book-name');\n      if (String(candidateBook) !== String(bookName)) return false;\n      const candidateId = $el.data('id');\n      if (matchEntryId(candidateId)) return true;\n      return matchEntryId($el.attr('data-id'));\n    })\n    .first();\n\n  if (!$container.length) return;\n\n  const statusMeta = resolveStatusMeta(statusId);\n  const badgeHtml = buildStatusBadge(statusMeta.id, { shortLabel: true });\n  $container.attr('data-status-id', statusMeta.id);\n\n  const $titleRow = $container.find('.rlh-item-title-row').first();\n  if ($titleRow.length) {\n    const $existingBadge = $titleRow.find('.rlh-status-badge').first();\n    if ($existingBadge.length) {\n      $existingBadge.replaceWith(badgeHtml);\n    } else {\n      $titleRow.append(badgeHtml);\n    }\n  }\n\n  const $content = $container.find('.rlh-collapsible-content');\n  if ($content.length && $container.attr('data-entry-mode') === 'view') {\n    const entries = safeGetLorebookEntries(bookName);\n    const targetEntry = entries.find(entry => Number(entry?.uid) === numericId);\n    if (targetEntry) {\n      const viewerHtml = buildLoreEntryViewerHTML(targetEntry, $container.data('searchTerm') ?? '');\n      $content.html(viewerHtml);\n    }\n  }\n};\n\nexport const buildReplaceConfirmationHTML = (matches, stats, booksMatchedByNameOnly, searchTerm, replaceTerm, context) => {\n  let summaryHtml = '';\n  let listHtml = '';\n  let booksOnlyHtml = '';\n\n  const buildStatsList = statsData => {\n    return Object.entries(statsData)\n      .filter(([, count]) => count > 0)\n      .map(([label, count]) => `<li>- ${escapeHtml(label)}\uFF1A<strong>${count}</strong> \u4E2A</li>`)\n      .join('');\n  };\n\n  if (context?.type === 'lorebook') {\n    const scopeText = context?.bookNames?.length === 1\n      ? `\u5F53\u524D\u4E16\u754C\u4E66\u300C${escapeHtml(context.bookNames[0])}\u300D`\n      : '\u5339\u914D\u5230\u7684\u4E16\u754C\u4E66';\n    const totalBooks = new Set(matches.map(m => m.bookName)).size + (booksMatchedByNameOnly?.length ?? 0);\n    const totalEntries = matches.length;\n\n    summaryHtml = `\n      <div class=\"rlh-replace-stats\">\n        <p>- \u5171\u5339\u914D\u5230 ${totalBooks} \u672C\u4E16\u754C\u4E66\uFF0C\u5176\u4E2D ${totalEntries} \u4E2A\u6761\u76EE\u5C06\u88AB\u4FEE\u6539\u3002</p>\n        <p>- \u66FF\u6362\u8303\u56F4\uFF1A${scopeText}</p>\n        <p>- \u547D\u4E2D\u8BE6\u60C5\uFF1A</p>\n        <ul>\n          <li>- \u4E66\u540D\uFF1A<strong>${stats.bookName}</strong> \u4E2A</li>\n          <li>- \u6761\u76EE\u540D\uFF1A<strong>${stats.entryName}</strong> \u4E2A</li>\n          <li>- \u5173\u952E\u8BCD\uFF1A<strong>${stats.keywords}</strong> \u4E2A</li>\n          <li>- \u5185\u5BB9\uFF1A<strong>${stats.content}</strong> \u4E2A</li>\n        </ul>\n      </div>\n    `;\n\n    const listItemsHtml = matches.map(({ bookName, entry, matchedFields }) => {\n      const hitFields = [];\n      if (matchedFields) {\n        if (matchedFields.entryName) hitFields.push('\u6761\u76EE\u540D');\n        if (matchedFields.keywords > 0) hitFields.push('\u5173\u952E\u8BCD');\n        if (matchedFields.content) hitFields.push('\u5185\u5BB9');\n      }\n      const fieldsText = hitFields.join('\u3001');\n      const entryName = escapeHtml(entry.name || '\u65E0\u6807\u9898\u6761\u76EE');\n      const hitDetails = fieldsText ? `\uFF08${fieldsText}\uFF09` : '';\n      return `<li class=\"rlh-confirm-entry-item\">${escapeHtml(bookName)}: ${entryName}${hitDetails}</li>`;\n    }).join('');\n\n    listHtml = `<ul class=\"rlh-confirm-entry-list\">${listItemsHtml}</ul>`;\n\n    if (booksMatchedByNameOnly && booksMatchedByNameOnly.length > 0) {\n      const bookItems = booksMatchedByNameOnly\n        .map(name => `<li class=\"rlh-confirm-entry-item\">${escapeHtml(name)}</li>`)\n        .join('');\n      booksOnlyHtml = `\n        <hr>\n        <h4>\u4EC5\u4E66\u540D\u5339\u914D (\u4E0D\u4F1A\u88AB\u66FF\u6362):</h4>\n        <div class=\"rlh-confirm-scroll-list rlh-confirm-scroll-list--secondary\">\n          <ul class=\"rlh-confirm-entry-list\">${bookItems}</ul>\n        </div>\n      `;\n    }\n\n  } else if (context === 'regex') {\n    const statsData = { '\u540D\u79F0\u5339\u914D': stats.name, '\u5185\u5BB9\u5339\u914D': stats.content };\n    const statsItems = buildStatsList(statsData);\n    if (statsItems) {\n      summaryHtml = `<div class=\"rlh-replace-stats\"><h4>\u66FF\u6362\u7EDF\u8BA1\u6458\u8981\uFF1A</h4><ul>${statsItems}</ul></div>`;\n    }\n    listHtml = `<ul class=\"rlh-confirm-entry-list\">${matches\n      .map(item => `<li class=\"rlh-confirm-entry-item\">${escapeHtml(item.script_name || '\u672A\u547D\u540D\u6B63\u5219')}</li>`)\n      .join('')}</ul>`;\n  }\n\n  return `\n    <div class=\"rlh-replace-confirm-modal\">\n      <p>\u786E\u5B9A\u8981\u5C06 <strong>\"${escapeHtml(searchTerm)}\"</strong> \u66FF\u6362\u4E3A <strong>\"${escapeHtml(replaceTerm)}\"</strong> \u5417\uFF1F</p>\n      <p>\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\u3002</p>\n      <hr>\n      ${summaryHtml}\n      <hr>\n      <h4>\u5C06\u8981\u4FEE\u6539\u7684\u6761\u76EE\u5217\u8868\uFF1A</h4>\n      <div class=\"rlh-confirm-scroll-list\">\n        ${listHtml}\n      </div>\n      ${booksOnlyHtml}\n    </div>\n  `;\n};\n\nexport const renderSaveStatus = () => {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  const $statusContainer = $('#regex-lore-hub-save-status', parentDoc);\n  if (!$statusContainer.length) return;\n\n  const status = appState.saveStatus;\n  let html = '';\n  let statusClass = '';\n\n  switch (status) {\n    case 'saving':\n      html = '<i class=\"fa-solid fa-spinner fa-spin\"></i> \u6B63\u5728\u4FDD\u5B58...';\n      statusClass = 'saving';\n      break;\n    case 'retrying':\n      html = `<i class=\"fa-solid fa-triangle-exclamation fa-fade\"></i> \u81EA\u52A8\u4FDD\u5B58\u5931\u8D25\uFF0C\u6B63\u5728\u91CD\u8BD5... (${appState.saveRetryAttempt}/3)`;\n      statusClass = 'retrying';\n      break;\n    case 'success':\n      html = '<i class=\"fa-solid fa-check-circle\"></i> \u6570\u636E\u5DF2\u4FDD\u5B58';\n      statusClass = 'success';\n      break;\n    case 'failed':\n      html = '<i class=\"fa-solid fa-circle-xmark\"></i> \u81EA\u52A8\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u8FDE\u63A5\u6216\u624B\u52A8\u4FDD\u5B58\u3002';\n      statusClass = 'failed';\n      break;\n    case 'idle':\n    default:\n      html = '';\n      statusClass = 'idle';\n      break;\n  }\n\n  $statusContainer.html(html);\n  $statusContainer.attr('class', `rlh-save-status ${statusClass}`);\n};\n\nconst reorderLoreEntriesInState = (bookName, orderedIds) => {\n  const entries = safeGetLorebookEntries(bookName);\n  if (!Array.isArray(entries) || !entries.length) return null;\n  if (!Array.isArray(orderedIds) || orderedIds.length !== entries.length) return null;\n\n  const entryMap = new Map(entries.map(entry => [String(entry.uid ?? ''), entry]));\n  const reordered = [];\n\n  orderedIds.forEach(id => {\n    const key = String(id ?? '');\n    if (!entryMap.has(key)) return;\n    reordered.push(entryMap.get(key));\n    entryMap.delete(key);\n  });\n\n  if (!reordered.length) return null;\n\n  entryMap.forEach(entry => reordered.push(entry));\n\n  reordered.forEach((entry, index) => {\n    entry.display_index = index;\n    if (entry.order === undefined || entry.order === null || Number.isNaN(Number(entry.order))) {\n      entry.order = index;\n    }\n  });\n\n  safeSetLorebookEntries(bookName, reordered);\n  return reordered;\n};\n\nexport const initializeLoreEntrySortable = ($listWrapper, bookName, options = {}) => {\n  const parentWin = getParentWin();\n  const dragRequested = options.enabled ?? false;\n  const hasWrapper = !!$listWrapper?.length;\n\n  const markDragDisabled = () => {\n    if (!hasWrapper) return;\n    $listWrapper.attr('data-drag-disabled', 'true');\n    if (!$listWrapper.find('.rlh-drag-disabled-tip').length) {\n      $listWrapper.prepend('<p class=\"rlh-info-text-small rlh-drag-disabled-tip\">\u62D6\u62FD\u6392\u5E8F\u529F\u80FD\u6682\u65F6\u4E0D\u53EF\u7528\u3002</p>');\n    }\n  };\n\n  if (!dragRequested || !hasWrapper) {\n    if (hasWrapper) {\n      $listWrapper.removeAttr('data-drag-disabled');\n      $listWrapper.find('.rlh-drag-disabled-tip').remove();\n    }\n    return;\n  }\n\n  if (appState.isDragSortDisabled) {\n    markDragDisabled();\n    return;\n  }\n\n  if (!parentWin?.Sortable) return;\n\n  const listEl = $listWrapper[0];\n  if (!listEl) return;\n  const itemCount = $listWrapper.find('.rlh-item-container').length;\n  if (itemCount < 2) return;\n\n  $listWrapper.removeAttr('data-drag-disabled');\n  $listWrapper.find('.rlh-drag-disabled-tip').remove();\n\n  parentWin.Sortable.create(listEl, {\n    animation: 150,\n    handle: '.rlh-drag-handle',\n    ghostClass: 'sortable-ghost',\n    chosenClass: 'sortable-chosen',\n    onEnd: errorCatched(async evt => {\n      const { oldIndex, newIndex } = evt;\n      if (oldIndex === newIndex) return;\n      const orderedIds = Array.from(listEl.querySelectorAll('.rlh-item-container'))\n        .map(node => node.getAttribute('data-id'))\n        .filter(Boolean);\n      if (!reorderLoreEntriesInState(bookName, orderedIds)) return;\n      await saveAllChanges();\n    }, 'RegexLoreHub.Sortable'),\n  });\n};\n", "import {\n  appState,\n  safeGetLorebookEntries,\n  escapeHtml,\n  get$,\n  getParentDoc,\n  getParentWin,\n  CHARACTER_BOOK_SWITCH_ID,\n} from '../../core.js';\nimport { loadLorebookEntriesIfNeeded } from '../../dataLayer.js';\nimport { renderContent } from './index.js';\nimport {\n  createItemElement,\n  createGlobalLorebookElement,\n  getActiveSortMode,\n  getActiveCollapseState,\n  matchEntry,\n  initializeLoreEntrySortable,\n} from './shared.js';\n\nconst GLOBAL_LIST_CHUNK_SIZE = 6;\nlet globalListRenderHandle = null;\nlet globalListProgressEl = null;\n\nconst cancelPendingGlobalListRender = () => {\n  if (!globalListRenderHandle && !globalListProgressEl) return;\n  const parentWin = getParentWin();\n  if (globalListRenderHandle) {\n    const { type, id } = globalListRenderHandle;\n    if (type === 'idle' && parentWin?.cancelIdleCallback) {\n      parentWin.cancelIdleCallback(id);\n    } else if (type === 'raf' && parentWin?.cancelAnimationFrame) {\n      parentWin.cancelAnimationFrame(id);\n    } else if (type === 'timeout') {\n      const clearFn = parentWin?.clearTimeout ?? (typeof clearTimeout === 'function' ? clearTimeout : null);\n      if (clearFn) clearFn(id);\n    }\n    globalListRenderHandle = null;\n  }\n  if (globalListProgressEl) {\n    globalListProgressEl.remove();\n    globalListProgressEl = null;\n  }\n};\n\nconst sortLoreEntries = (entries, sortMode) => {\n  const list = Array.isArray(entries) ? [...entries] : [];\n  if (sortMode === 'status') {\n    return list.sort((a, b) => {\n      const diff = Number(b.enabled) - Number(a.enabled);\n      if (diff !== 0) return diff;\n      return (a.name || '').localeCompare(b.name || '', 'zh');\n    });\n  }\n  return list.sort((a, b) => (a.name || '\u65E0\u6807\u9898\u6761\u76EE').localeCompare(b.name || '\u65E0\u6807\u9898\u6761\u76EE', 'zh'));\n};\n\nexport const getGlobalLorebookMatches = (searchTerm, caseSensitive = false, options = {}) => {\n  const matches = [];\n  const booksMatchedByNameOnly = [];\n  const stats = { bookName: 0, entryName: 0, keywords: 0, content: 0 };\n\n  const normalizedSearchTerm = typeof searchTerm === 'string' ? searchTerm : '';\n  if (!normalizedSearchTerm) {\n    return { matches, stats, booksMatchedByNameOnly };\n  }\n\n  const { bookNames } = options;\n  const targetNames = Array.isArray(bookNames)\n    ? [...new Set(\n        bookNames\n          .map(name => (typeof name === 'string' ? name.trim() : ''))\n          .filter(name => Boolean(name)),\n      )]\n    : [];\n\n  const allBooks = Array.isArray(appState.allLorebooks) ? appState.allLorebooks : [];\n  const books = targetNames.length\n    ? allBooks.filter(book => targetNames.includes(book.name))\n    : allBooks.slice();\n\n  if (targetNames.length) {\n    const knownNames = new Set(books.map(book => book.name));\n    targetNames.forEach(name => {\n      if (!knownNames.has(name)) {\n        books.push({ name });\n      }\n    });\n  }\n\n  const flags = caseSensitive ? '' : 'i';\n  const searchRegex = new RegExp(normalizedSearchTerm.replace(/[.*+?^${}()|[\\/\\\\]/g, '\\\\$&'), flags);\n\n  const matchedBooksForName = new Set();\n  const matchedEntriesForName = new Set();\n  const matchedEntriesForKeywords = new Set();\n  const matchedEntriesForContent = new Set();\n  const addedEntries = new Set();\n\n  for (const book of books) {\n    const name = book?.name ?? '';\n    if (!name) continue;\n\n    const entries = safeGetLorebookEntries(name);\n    const isBookNameMatch = searchRegex.test(name);\n    let bookHasEntryMatches = false;\n\n    if (isBookNameMatch) {\n      matchedBooksForName.add(name);\n    }\n\n    for (const entry of entries) {\n      const currentMatch = {\n        bookName: false,\n        entryName: false,\n        keywords: 0,\n        content: false,\n      };\n      let entryHasMatch = false;\n\n      if (searchRegex.test(entry.name || '')) {\n        matchedEntriesForName.add(entry.uid);\n        currentMatch.entryName = true;\n        entryHasMatch = true;\n      }\n\n      if (Array.isArray(entry.keys)) {\n        const matchedKeywordsCount = entry.keys.filter(k => searchRegex.test(k)).length;\n        if (matchedKeywordsCount > 0) {\n          currentMatch.keywords = matchedKeywordsCount;\n          matchedEntriesForKeywords.add(entry.uid);\n          entryHasMatch = true;\n        }\n      }\n\n      if (searchRegex.test(entry.content || '')) {\n        matchedEntriesForContent.add(entry.uid);\n        currentMatch.content = true;\n        entryHasMatch = true;\n      }\n\n      if (entryHasMatch) {\n        bookHasEntryMatches = true;\n        if (!addedEntries.has(entry.uid)) {\n          matches.push({ bookName: name, entry, matchedFields: currentMatch });\n          addedEntries.add(entry.uid);\n        }\n      }\n    }\n\n    if (isBookNameMatch && !bookHasEntryMatches) {\n      booksMatchedByNameOnly.push(name);\n    }\n  }\n\n  stats.bookName = matchedBooksForName.size;\n  stats.entryName = matchedEntriesForName.size;\n  stats.keywords = matchedEntriesForKeywords.size;\n  stats.content = matchedEntriesForContent.size;\n\n  return { matches, stats, booksMatchedByNameOnly };\n};\n\nexport const renderGlobalLoreTabView = (context, searchTerm, $container) => {\n  if (context.view === 'global-lore-detail') {\n    renderGlobalLoreDetailView(context, searchTerm, $container);\n  } else {\n    renderGlobalLoreListView(context, searchTerm, $container);\n  }\n};\n\nconst renderGlobalLoreListView = (context, searchTerm, $container) => {\n  cancelPendingGlobalListRender();\n\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  const parentWin = getParentWin();\n\n  const normalizedTerm = typeof searchTerm === 'string' ? searchTerm : '';\n  const sortMode = getActiveSortMode(context);\n  const books = [...appState.allLorebooks];\n\n  if (sortMode === 'status') {\n    books.sort((a, b) => {\n      const diff = Number(b.enabled) - Number(a.enabled);\n      if (diff !== 0) return diff;\n      return a.name.localeCompare(b.name, 'zh');\n    });\n  } else {\n    books.sort((a, b) => a.name.localeCompare(b.name, 'zh'));\n  }\n\n  if (!books.length) {\n    const emptyHtml = `\n      <div class=\"rlh-empty-state\">\n        <div class=\"rlh-empty-icon\"><i class=\"fa-solid fa-book-bookmark\"></i></div>\n        <h4>\u6CA1\u6709\u4E16\u754C\u4E66</h4>\n        <p>\u70B9\u51FB\u53F3\u4E0A\u89D2\u7684\u201C<i class=\"fa-solid fa-plus\"></i>\u201D\u6309\u94AE\u6765\u521B\u5EFA\u4F60\u7684\u7B2C\u4E00\u4E2A\u4E16\u754C\u4E66\u5427\uFF01</p>\n      </div>\n    `;\n    $container.html(emptyHtml);\n    return;\n  }\n\n  const filteredBooks = normalizedTerm\n    ? books.filter(book => {\n        const bookNameMatches = appState.searchFilters.bookName && book.name.toLowerCase().includes(normalizedTerm);\n        if (bookNameMatches) return true;\n\n        const entries = safeGetLorebookEntries(book.name);\n        return entries.some(entry => matchEntry(entry, normalizedTerm));\n      })\n    : books;\n\n  if (!filteredBooks.length) {\n    $container.html('<p class=\"rlh-info-text\">\u672A\u627E\u5230\u5339\u914D\u7684\u4E16\u754C\u4E66\u3002</p>');\n    return;\n  }\n\n  $container.empty();\n\n  const total = filteredBooks.length;\n  const chunkSize =\n    total <= GLOBAL_LIST_CHUNK_SIZE\n      ? total\n      : Math.min(GLOBAL_LIST_CHUNK_SIZE, Math.max(3, Math.ceil(total / 5)));\n  let currentIndex = 0;\n\n  globalListProgressEl =\n    total > chunkSize\n      ? $('<p class=\"rlh-info-text-small\" aria-live=\"polite\"></p>')\n      : null;\n\n  const updateProgress = () => {\n    if (!globalListProgressEl) return;\n    const completed = Math.min(currentIndex, total);\n    globalListProgressEl\n      .text(`\u6B63\u5728\u52A0\u8F7D\u4E16\u754C\u4E66\u5217\u8868 (${completed}/${total})\uFF0C\u8BF7\u7A0D\u5019...`)\n      .appendTo($container);\n  };\n\n  const appendNodes = nodes => {\n    if (!nodes.length) return;\n    const fragment =\n      parentDoc && typeof parentDoc.createDocumentFragment === 'function'\n        ? parentDoc.createDocumentFragment()\n        : null;\n    if (fragment) {\n      nodes.forEach(node => fragment.appendChild(node));\n      $container.append(fragment);\n    } else {\n      nodes.forEach(node => $container.append(node));\n    }\n  };\n\n  const renderChunk = () => {\n    const end = Math.min(currentIndex + chunkSize, total);\n    const nodes = [];\n    for (let i = currentIndex; i < end; i++) {\n      const element = createGlobalLorebookElement(filteredBooks[i], searchTerm, true, null);\n      const domNode = element.get(0);\n      if (domNode) nodes.push(domNode);\n    }\n    appendNodes(nodes);\n    currentIndex = end;\n    updateProgress();\n\n    if (currentIndex >= total && globalListProgressEl) {\n      const progressRef = globalListProgressEl;\n      const clearFn = parentWin?.setTimeout ?? setTimeout;\n      clearFn(() => {\n        if (globalListProgressEl === progressRef) {\n          progressRef.remove();\n          globalListProgressEl = null;\n        }\n      }, 320);\n    }\n  };\n\n  const scheduleNextChunk = () => {\n    const callback = () => {\n      globalListRenderHandle = null;\n      renderChunk();\n      if (currentIndex < total) {\n        scheduleNextChunk();\n      }\n    };\n\n    if (parentWin?.requestIdleCallback) {\n      const id = parentWin.requestIdleCallback(callback, { timeout: 120 });\n      globalListRenderHandle = { type: 'idle', id };\n    } else if (parentWin?.requestAnimationFrame) {\n      const id = parentWin.requestAnimationFrame(callback);\n      globalListRenderHandle = { type: 'raf', id };\n    } else {\n      const scheduleFn = parentWin?.setTimeout ?? setTimeout;\n      const id = scheduleFn(callback, 16);\n      globalListRenderHandle = { type: 'timeout', id };\n    }\n  };\n\n  renderChunk();\n\n  if (currentIndex < total) {\n    scheduleNextChunk();\n  } else if (globalListProgressEl) {\n    globalListProgressEl.remove();\n    globalListProgressEl = null;\n  }\n};\n\nconst renderGlobalLoreDetailView = (context, searchTerm, $container) => {\n  cancelPendingGlobalListRender();\n\n  const $ = get$();\n  const bookName = context?.activeBookName ?? appState.activeBookName;\n  const book = appState.allLorebooks.find(b => b.name === bookName);\n  if (!book) {\n    $container.html(`<p class=\"rlh-info-text\">\u9519\u8BEF\uFF1A\u672A\u627E\u5230\u540D\u4E3A \"${escapeHtml(bookName)}\" \u7684\u4E16\u754C\u4E66\u3002</p>`);\n    return;\n  }\n\n  if (appState.loadingBookName === bookName) {\n    const loadingHtml = `\n        <div class=\"rlh-detail-view\" data-book-name=\"${escapeHtml(bookName)}\">\n          <header class=\"rlh-detail-header\">\n            <button class=\"rlh-action-btn-icon rlh-back-to-list-btn\" title=\"\u8FD4\u56DE\u4E16\u754C\u4E66\u5217\u8868\"><i class=\"fa-solid fa-arrow-left\"></i></button>\n            <h2>${escapeHtml(bookName)}</h2>\n            <div class=\"rlh-item-controls\">\n              <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\u91CD\u547D\u540D\u4E16\u754C\u4E66\">\u91CD\u547D\u540D</button>\n              <button class=\"rlh-toolbar-btn rlh-delete-book-btn\" title=\"\u5220\u9664\u4E16\u754C\u4E66\">\u5220\u9664</button>\n            </div>\n          </header>\n          <div class=\"rlh-detail-content\">\n            <p class=\"rlh-info-text\">\u52A0\u8F7D\u4E2D...</p>\n          </div>\n        </div>\n      `;\n    $container.html(loadingHtml);\n    return;\n  }\n\n  $container.append(`<div class=\"rlh-info-text-small\">\u5F53\u524D\u4E16\u754C\u4E66\uFF1A${escapeHtml(bookName)}</div>`);\n\n  const sortMode = getActiveSortMode(context);\n  const collapseState = getActiveCollapseState(context);\n  const entries = sortLoreEntries(safeGetLorebookEntries(bookName), sortMode);\n  const detailHtml = `\n        <div class=\"rlh-detail-view\" data-book-name=\"${escapeHtml(bookName)}\">\n          <header class=\"rlh-detail-header\">\n            <button class=\"rlh-action-btn-icon rlh-back-to-list-btn\" title=\"\u8FD4\u56DE\u4E16\u754C\u4E66\u5217\u8868\"><i class=\"fa-solid fa-arrow-left\"></i></button>\n            <h2>${escapeHtml(bookName)}</h2>\n            <div class=\"rlh-item-controls\">\n              <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\u91CD\u547D\u540D\u4E16\u754C\u4E66\">\u91CD\u547D\u540D</button>\n              <button class=\"rlh-toolbar-btn rlh-delete-book-btn\" title=\"\u5220\u9664\u4E16\u754C\u4E66\">\u5220\u9664</button>\n            </div>\n          </header>\n          <div class=\"rlh-detail-content\">\n          </div>\n        </div>\n      `;\n  $container.html(detailHtml);\n\n  const visibleEntries = searchTerm\n    ? entries.filter(entry => matchEntry(entry, searchTerm))\n    : entries;\n\n  const $content = $container.find('.rlh-detail-content');\n\n  if (!visibleEntries.length) {\n    const message = entries.length\n      ? '\u65E0\u5339\u914D\u6761\u76EE'\n      : '\u8FD9\u672C\u4E66\u8FD8\u6CA1\u6709\u6761\u76EE\uFF0C\u70B9\u51FB\u5DE5\u5177\u680F\u7684\u201C\u65B0\u5EFA\u6761\u76EE\u201D\u6309\u94AE\uFF0C\u4E3A\u5B83\u6DFB\u52A0\u5185\u5BB9\u3002';\n    $content.html(`<p class=\"rlh-info-text\">${message}</p>`);\n    return;\n  }\n\n  const entriesHtml = `\n    <p class=\"rlh-info-text-small\">\u5171 ${entries.length} \u4E2A\u6761\u76EE</p>\n    <div class=\"rlh-entry-list-wrapper\">\n      ${visibleEntries\n        .map(entry => createItemElement(entry, 'lore', bookName, searchTerm, { collapseState, enableDrag: false }).prop('outerHTML'))\n        .join('')}\n    </div>\n  `;\n  $content.html(entriesHtml);\n};\n\nexport const renderCharacterLorebookView = (context, searchTerm, $container) => {\n  const $ = get$();\n  const linkedBooks = appState.lorebooks.character;\n  const characterName = appState.characterContext.name ?? '';\n  const hasActiveCharacter = appState.characterContext.id !== null;\n\n  if (!hasActiveCharacter) {\n    $container.html('<p class=\"rlh-info-text\">\u8BF7\u5148\u52A0\u8F7D\u4E00\u4E2A\u89D2\u8272\u4EE5\u7BA1\u7406\u89D2\u8272\u4E16\u754C\u4E66\u3002</p>');\n    return;\n  }\n\n  if (linkedBooks.length === 0) {\n    $container.html('<p class=\"rlh-info-text\">\u5F53\u524D\u89D2\u8272\u6CA1\u6709\u7ED1\u5B9A\u7684\u4E16\u754C\u4E66\u3002\u70B9\u51FB\u540C\u6B65\u6309\u94AE\u5237\u65B0\u3002</p>');\n    return;\n  }\n\n  let activeBookName = appState.activeCharacterBook;\n  if (!activeBookName || !linkedBooks.includes(activeBookName)) {\n    activeBookName = linkedBooks[0];\n    appState.activeCharacterBook = activeBookName;\n  }\n\n  const sortMode = getActiveSortMode(context);\n  const collapseState = getActiveCollapseState(context);\n\n  if (linkedBooks.length > 1) {\n    const optionsHtml = linkedBooks\n      .map(name => `<option value=\"${escapeHtml(name)}\"${name === activeBookName ? ' selected' : ''}>${escapeHtml(name)}</option>`)\n      .join('');\n    $container.append(`<div class=\"rlh-book-switcher\"><label>\u5F53\u524D\u89D2\u8272\u540D\uFF1A${escapeHtml(characterName)}<select id=\"${CHARACTER_BOOK_SWITCH_ID}\" class=\"rlh-input\">${optionsHtml}</select></label></div>`);\n  } else {\n    $container.append(`<div class=\"rlh-info-text-small\">\u5F53\u524D\u89D2\u8272\u540D\uFF1A${escapeHtml(characterName)}</div>`);\n  }\n\n  const renderBook = bookName => {\n    const $bookContainer = $(\n      `<div class=\"rlh-book-group\" data-book-name=\"${escapeHtml(bookName)}\">\n        <div class=\"rlh-book-group-header\">\n          <h2 class=\"rlh-book-group-title\">${escapeHtml(bookName)}</h2>\n          <div class=\"rlh-item-controls\">\n            <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\u91CD\u547D\u540D\u4E16\u754C\u4E66\">\u91CD\u547D\u540D</button>\n            <button class=\"rlh-toolbar-btn rlh-delete-book-btn\" title=\"\u5220\u9664\u4E16\u754C\u4E66\">\u5220\u9664</button>\n          </div>\n        </div>\n        <div class=\"rlh-entry-list-wrapper\"></div>\n      </div>`\n    );\n\n    const $listWrapper = $bookContainer.find('.rlh-entry-list-wrapper');\n    const bookMeta = appState.allLorebooks.find(b => b.name === bookName);\n    if (bookMeta && !bookMeta.entriesLoaded) {\n      if (!bookMeta.loadingEntries) {\n        bookMeta.loadingEntries = true;\n        loadLorebookEntriesIfNeeded(bookName)\n          .finally(() => {\n            bookMeta.loadingEntries = false;\n            renderContent();\n          });\n      }\n      $listWrapper.append('<p class=\"rlh-info-text\">\u52A0\u8F7D\u4E2D...</p>');\n      return $bookContainer;\n    }\n\n    const baseEntries = [...safeGetLorebookEntries(bookName)].sort(\n      (a, b) => ((a.display_index ?? Number.MAX_SAFE_INTEGER) - (b.display_index ?? Number.MAX_SAFE_INTEGER)),\n    );\n    const entries = sortLoreEntries(baseEntries, sortMode);\n\n    const bookNameMatches =\n      !searchTerm ||\n      (appState.searchFilters.bookName && bookName.toLowerCase().includes(searchTerm));\n\n    const matchingEntries = searchTerm\n      ? entries.filter(entry => matchEntry(entry, searchTerm))\n      : entries;\n\n    const entriesToShow = bookNameMatches && !searchTerm ? entries : matchingEntries;\n    const canReorder = false;\n\n    if (!entriesToShow.length) {\n      if (searchTerm) {\n        $listWrapper.append('<p class=\"rlh-info-text-small\">\u65E0\u5339\u914D\u6761\u76EE</p>');\n      } else {\n        $listWrapper.append('<p class=\"rlh-info-text-small\">\u8FD9\u672C\u4E16\u754C\u4E66\u6682\u65F6\u6CA1\u6709\u6761\u76EE\u3002</p>');\n      }\n    } else {\n      entriesToShow.forEach(entry => {\n        $listWrapper.append(\n          createItemElement(entry, 'lore', bookName, searchTerm, { collapseState, enableDrag: canReorder }),\n        );\n      });\n    }\n\n    initializeLoreEntrySortable($listWrapper, bookName, { enabled: canReorder });\n\n    return $bookContainer;\n  };\n\n  const $bookElement = renderBook(activeBookName);\n  if ($bookElement) {\n    $bookElement.attr('data-active', 'true');\n    $container.append($bookElement);\n  } else if (searchTerm) {\n    $container.append('<p class=\"rlh-info-text\">\u672A\u627E\u5230\u5339\u914D\u7684\u6761\u76EE\u3002</p>');\n  } else {\n    $container.append('<p class=\"rlh-info-text\">\u672A\u80FD\u52A0\u8F7D\u5F53\u524D\u4E16\u754C\u4E66\uFF0C\u8BF7\u5C1D\u8BD5\u5237\u65B0\u6570\u636E\u3002</p>');\n  }\n};\n\nexport const getChatLorebookMatches = searchTerm => {\n  let matches = [];\n  const bookName = appState.chatLorebook;\n  const parentWin = getParentWin();\n  const context = parentWin.SillyTavern?.getContext?.() || {};\n  const hasActiveChat = context.chatId !== undefined && context.chatId !== null;\n\n  if (!hasActiveChat || !bookName) {\n    return matches;\n  }\n\n  const entries = [...safeGetLorebookEntries(bookName)].sort(\n    (a, b) => ((a.display_index ?? Number.MAX_SAFE_INTEGER) - (b.display_index ?? Number.MAX_SAFE_INTEGER)),\n  );\n\n  if (!searchTerm) {\n    entries.forEach(entry => {\n      matches.push({ bookName, entry });\n    });\n  } else {\n    entries.forEach(entry => {\n      let entryNameMatches =\n        appState.searchFilters.entryName && (entry.name || '').toLowerCase().includes(searchTerm.toLowerCase());\n      let keywordsMatch =\n        appState.searchFilters.keywords && entry.keys.join(' ').toLowerCase().includes(searchTerm.toLowerCase());\n      let contentMatch =\n        appState.searchFilters.content &&\n        entry.content &&\n        entry.content.toLowerCase().includes(searchTerm.toLowerCase());\n\n      if (entryNameMatches || keywordsMatch || contentMatch) {\n        matches.push({ bookName, entry });\n      }\n    });\n  }\n\n  return matches;\n};\n\nexport const renderChatLorebookView = (context, searchTerm, $container) => {\n  const $ = get$();\n  const bookName = appState.chatLorebook;\n  const parentWin = getParentWin();\n  const characterName = appState.characterContext.name ?? '';\n  const hasActiveChat = parentWin.SillyTavern?.getContext?.()?.chatId !== null;\n\n  if (!hasActiveChat) {\n    $container.html('<p class=\"rlh-info-text\">\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A\u804A\u5929\u4EE5\u7BA1\u7406\u804A\u5929\u4E16\u754C\u4E66\u3002</p>');\n    return;\n  }\n\n  if (!bookName) {\n    $container.html(`\n      <div class=\"rlh-chat-lore-empty\">\n        <p class=\"rlh-info-text\">\u5F53\u524D\u804A\u5929\u6CA1\u6709\u7ED1\u5B9A\u7684\u4E16\u754C\u4E66\u3002</p>\n        <button class=\"rlh-action-btn\" id=\"rlh-create-chat-lore-btn\"><i class=\"fa-solid fa-plus\"></i> \u521B\u5EFA\u5E76\u7ED1\u5B9A\u804A\u5929\u4E16\u754C\u4E66</button>\n      </div>\n    `);\n    return;\n  }\n\n  $container.append(`<div class=\"rlh-info-text-small\">\u5F53\u524D\u804A\u5929\u89D2\u8272\u540D\uFF1A${escapeHtml(characterName)}</div>`);\n\n  const sortMode = getActiveSortMode(context);\n  const collapseState = getActiveCollapseState(context);\n\n  const $bookContainer = $(\n    `<div class=\"rlh-book-group\" data-book-name=\"${escapeHtml(bookName)}\">\n      <div class=\"rlh-book-group-header\">\n        <h2 class=\"rlh-book-group-title\">${escapeHtml(bookName)} (\u804A\u5929\u4E13\u7528)</h2>\n        <div class=\"rlh-item-controls\">\n          <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\u91CD\u547D\u540D\u4E16\u754C\u4E66\">\u91CD\u547D\u540D</button>\n          <button class=\"rlh-toolbar-btn rlh-unlink-chat-lore-btn\" title=\"\u89E3\u9664\u7ED1\u5B9A\">\u89E3\u9664\u7ED1\u5B9A</button>\n        </div>\n      </div>\n      <div class=\"rlh-entry-list-wrapper\"></div>\n    </div>`\n  );\n  const $listWrapper = $bookContainer.find('.rlh-entry-list-wrapper');\n  const bookMeta = appState.allLorebooks.find(b => b.name === bookName);\n  if (bookMeta && !bookMeta.entriesLoaded) {\n    if (!bookMeta.loadingEntries) {\n      bookMeta.loadingEntries = true;\n      loadLorebookEntriesIfNeeded(bookName)\n        .finally(() => {\n          bookMeta.loadingEntries = false;\n          renderContent();\n        });\n    }\n    $listWrapper.append('<p class=\"rlh-info-text\">\u52A0\u8F7D\u4E2D...</p>');\n    $container.append($bookContainer);\n    return;\n  }\n\n  const baseEntries = [...safeGetLorebookEntries(bookName)].sort(\n    (a, b) => ((a.display_index ?? Number.MAX_SAFE_INTEGER) - (b.display_index ?? Number.MAX_SAFE_INTEGER)),\n  );\n  const entries = sortLoreEntries(baseEntries, sortMode);\n\n  const matchingEntries = searchTerm\n    ? entries.filter(entry => matchEntry(entry, searchTerm))\n    : entries;\n  const canReorder = false;\n\n  if (!matchingEntries.length) {\n    const message = entries.length ? '\u65E0\u5339\u914D\u6761\u76EE' : '\u8FD9\u672C\u4E66\u8FD8\u6CA1\u6709\u6761\u76EE\u3002';\n    $listWrapper.append(`<p class=\"rlh-info-text-small\">${message}</p>`);\n  } else {\n    matchingEntries.forEach(entry => {\n      $listWrapper.append(\n        createItemElement(entry, 'lore', bookName, searchTerm, { collapseState, enableDrag: canReorder }),\n      );\n    });\n  }\n\n  initializeLoreEntrySortable($listWrapper, bookName, { enabled: canReorder });\n\n  $container.append($bookContainer);\n};\nexport const cancelGlobalLoreListRender = () => cancelPendingGlobalListRender();\n", "import {\n  appState,\n  errorCatched,\n  get$,\n  getParentWin,\n} from '../../core.js';\nimport { saveAllChanges, updateRegexOrderMetadata } from '../../dataLayer.js';\nimport { createItemElement, getActiveSortMode, getActiveCollapseState, matchRegex } from './shared.js';\n\nconst sortRegexEntries = (entries, sortMode) => {\n  const list = Array.isArray(entries) ? [...entries] : [];\n  if (sortMode === 'status') {\n    return list.sort((a, b) => {\n      const diff = Number(b.enabled) - Number(a.enabled);\n      if (diff !== 0) return diff;\n      return (a.script_name || '').localeCompare(b.script_name || '', 'zh');\n    });\n  }\n  if (sortMode === 'name') {\n    return list.sort((a, b) => (a.script_name || '').localeCompare(b.script_name || '', 'zh'));\n  }\n  return list;\n};\n\nexport const getRegexMatches = (searchTerm, caseSensitive = false) => {\n  const matches = [];\n  const stats = { name: 0, content: 0 };\n  if (!searchTerm) return { matches, stats };\n\n  const scripts = [...appState.regexes.global, ...appState.regexes.character];\n  const flags = caseSensitive ? '' : 'i';\n  const searchRegex = new RegExp(searchTerm.replace(/[.*+?^${}()|[\\/\\\\]/g, '\\\\$&'), flags);\n\n  const matchedScriptsForName = new Set();\n  const matchedScriptsForContent = new Set();\n  const addedScripts = new Set();\n\n  for (const script of scripts) {\n    let hasMatch = false;\n    if (searchRegex.test(script.script_name || '')) {\n      matchedScriptsForName.add(script.script_name);\n      hasMatch = true;\n    }\n\n    const contentToSearch = `${script.find_regex || ''} ${script.replace_string || ''}`;\n    if (searchRegex.test(contentToSearch)) {\n      matchedScriptsForContent.add(script.script_name);\n      hasMatch = true;\n    }\n\n    if (hasMatch && !addedScripts.has(script.id)) {\n      matches.push(script);\n      addedScripts.add(script.id);\n    }\n  }\n\n  stats.name = matchedScriptsForName.size;\n  stats.content = matchedScriptsForContent.size;\n\n  return { matches, stats };\n};\n\nexport const renderRegexView = (context, itemList, searchTerm, $container, title) => {\n  const $ = get$();\n  const parentWin = getParentWin();\n  const sortMode = getActiveSortMode(context);\n  const collapseState = getActiveCollapseState(context);\n  const items = sortRegexEntries(itemList ?? [], sortMode);\n  const label = title ?? (context.id === 'char-regex' ? '\u89D2\u8272\u6B63\u5219' : '\u5168\u5C40\u6B63\u5219');\n\n  if (context.id === 'char-regex') {\n    const hostContext = parentWin.SillyTavern?.getContext?.() || {};\n    const hasActiveCharacter = hostContext.characterId !== undefined && hostContext.characterId !== null;\n    if (!hasActiveCharacter) {\n      $container.html('<p class=\"rlh-info-text\">\u8BF7\u5148\u52A0\u8F7D\u4E00\u4E2A\u89D2\u8272\u4EE5\u7BA1\u7406\u89D2\u8272\u6B63\u5219\u3002</p>');\n      return;\n    }\n  }\n\n  if (!items.length) {\n    $container.html(`<p class=\"rlh-info-text\">\u6CA1\u6709${label}\u3002\u70B9\u51FB\u540C\u6B65\u6309\u94AE\u5237\u65B0\u3002</p>`);\n    return;\n  }\n\n  const filteredItems = searchTerm ? items.filter(item => matchRegex(item, searchTerm)) : items;\n\n  if (!filteredItems.length) {\n    $container.html(`<p class=\"rlh-info-text\">\u6CA1\u6709\u5339\u914D\u7684${label}\u3002</p>`);\n    return;\n  }\n\n  const listId = `rlh-regex-list-${context.id}`;\n  const $listContainer = $(`<div id=\"${listId}\" class=\"rlh-regex-list\"></div>`);\n  $container.append($listContainer);\n\n  const canReorder = !searchTerm;\n\n  filteredItems.forEach((item, index) => {\n    const $element = createItemElement(item, 'regex', '', searchTerm, {\n      collapseState,\n      enableDrag: canReorder,\n    });\n    $element.find('.rlh-item-name').prepend(`<span class=\"rlh-order-indicator\">#${index + 1}</span> `);\n    $listContainer.append($element);\n  });\n\n  const listEl = $listContainer[0];\n  const dragNoticeClass = 'rlh-drag-disabled-banner';\n  $container.find(`.${dragNoticeClass}`).remove();\n\n  if (canReorder && appState.isDragSortDisabled) {\n    $listContainer.attr('data-drag-disabled', 'true');\n    $container.prepend(\n      `<p class=\"rlh-info-text-small ${dragNoticeClass}\">\u63D0\u793A\uFF1A\u62D6\u62FD\u6392\u5E8F\u529F\u80FD\u6682\u65F6\u4E0D\u53EF\u7528\uFF0C\u8BF7\u4F7F\u7528\u6309\u94AE\u8C03\u6574\u987A\u5E8F\u3002</p>`,\n    );\n  } else {\n    $listContainer.removeAttr('data-drag-disabled');\n  }\n\n  if (canReorder && !appState.isDragSortDisabled && listEl && parentWin.Sortable) {\n    const sortable = parentWin.Sortable.create(listEl, {\n      animation: 150,\n      handle: '.rlh-drag-handle',\n      forceFallback: true,\n      fallbackOnBody: true,\n      fallbackTolerance: 6,\n      delayOnTouchOnly: true,\n      touchStartThreshold: 8,\n      fallbackClass: 'rlh-sorting-fallback',\n      onStart: () => {\n        $listContainer.addClass('sorting-active');\n      },\n      onEnd: errorCatched(async evt => {\n        $listContainer.removeClass('sorting-active');\n        const { oldIndex, newIndex } = evt;\n        if (oldIndex === newIndex) return;\n\n        const scope = context.id === 'global-regex' ? 'global' : 'character';\n        const targetList = appState.regexes[scope];\n        if (!Array.isArray(targetList)) return;\n\n        const [moved] = targetList.splice(oldIndex, 1);\n        if (!moved) return;\n        targetList.splice(newIndex, 0, moved);\n        updateRegexOrderMetadata(targetList);\n\n        if (!(appState.pendingRegexUpdates instanceof Set)) {\n          appState.pendingRegexUpdates = new Set();\n        }\n        appState.pendingRegexUpdates.add(scope);\n\n        await saveAllChanges({ silent: true });\n        $container.empty();\n        renderRegexView(context, targetList, searchTerm, $container, title);\n      }, 'RegexLoreHub.RegexSortable'),\n    });\n  }\n};\n", "import {\n  PANEL_ID,\n  CORE_TOOLBAR_ID,\n  REPLACE_TOOL_CONTAINER_ID,\n  DEFAULT_FILTER_LABELS,\n  REGEX_FILTER_LABELS,\n  appState,\n  get$,\n  getParentDoc,\n} from '../../core.js';\nimport { renderGlobalLoreTabView, renderCharacterLorebookView, renderChatLorebookView, cancelGlobalLoreListRender } from './lorebook.js';\nimport { renderRegexView } from './regex.js';\nimport { renderToolbar, renderSaveStatus, updateSelectionCount } from './shared.js';\nexport * from './shared.js';\n\nconst normalizeSearchTerm = value => value?.toString().trim().toLowerCase() ?? '';\n\nexport const getViewContext = () => {\n  const tab = appState.activeTab;\n  const view = appState.activeView;\n\n  const base = {\n    tab,\n    view,\n    id: `${tab}`,\n    instanceKey: `${tab}`,\n    activeBookName: appState.activeBookName,\n    type: 'lore',\n    scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u89C6\u56FE',\n    replaceScopeLabel: '\u5728\u5F53\u524D\u89C6\u56FE\u4E2D\u66FF\u6362',\n    searchPlaceholder: '\u641C\u7D22...',\n    visibleFilters: ['entryName', 'keywords', 'content'],\n    filterLabels: DEFAULT_FILTER_LABELS,\n    defaultFilters: { entryName: true, keywords: true, content: true },\n    showReplace: true,\n    showRecursion: false,\n    showFixKeywords: false,\n    showCollapseToggle: false,\n    showPositionMenu: false,\n    sortOptions: [],\n    multiSelectTarget: 'entry',\n    supportsMultiSelect: true,\n    primaryAction: { visible: false },\n  };\n\n  if (tab === 'global-lore') {\n    if (view === 'global-lore-detail') {\n      const bookName = appState.activeBookName ?? '';\n      return {\n        ...base,\n        id: 'global-lore-detail',\n        instanceKey: bookName ? `global-lore-detail:${bookName}` : 'global-lore-detail',\n        activeBookName: bookName,\n        scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u4E16\u754C\u4E66',\n        replaceScopeLabel: '\u5728\u5F53\u524D\u4E16\u754C\u4E66\u4E2D\u66FF\u6362',\n        searchPlaceholder: '\u641C\u7D22...',\n        visibleFilters: ['bookName', 'entryName', 'keywords', 'content'],\n        defaultFilters: { bookName: false, entryName: true, keywords: true, content: true },\n        showRecursion: true,\n        showFixKeywords: true,\n        showCollapseToggle: true,\n        showPositionMenu: true,\n        sortOptions: ['status', 'name'],\n        multiSelectTarget: 'entry',\n        primaryAction: {\n          visible: true,\n          icon: 'fa-file-circle-plus',\n          label: '\u65B0\u5EFA\u6761\u76EE',\n          title: '\u65B0\u5EFA\u6761\u76EE',\n          scope: 'entry',\n        },\n      };\n    }\n\n    return {\n      ...base,\n      id: 'global-lore-list',\n      instanceKey: 'global-lore-list',\n      activeBookName: null,\n      scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u5168\u90E8\u4E16\u754C\u4E66',\n      replaceScopeLabel: '\u5728\u5339\u914D\u5230\u7684\u4E16\u754C\u4E66\u6216\u6761\u76EE\u4E2D\u66FF\u6362',\n      visibleFilters: ['bookName', 'entryName', 'keywords', 'content'],\n      defaultFilters: { bookName: true, entryName: true, keywords: true, content: true },\n      showReplace: true,\n      showRecursion: false,\n      showFixKeywords: false,\n      showCollapseToggle: false,\n      showPositionMenu: false,\n      showCleanOrphanBooks: true,\n      sortOptions: ['status', 'name'],\n      multiSelectTarget: 'book',\n      primaryAction: {\n        visible: true,\n        icon: 'fa-plus',\n        label: '\u65B0\u5EFA\u4E16\u754C\u4E66',\n        title: '\u65B0\u5EFA\u4E16\u754C\u4E66',\n        scope: 'book',\n      },\n    };\n  }\n\n  if (tab === 'char-lore') {\n    let activeCharacterBook = appState.activeCharacterBook;\n    if (!activeCharacterBook) {\n      const characterBooks = Array.isArray(appState.lorebooks?.character) ? appState.lorebooks.character : [];\n      const fallbackBook = characterBooks.find(name => typeof name === 'string' && name.trim().length);\n      if (fallbackBook) {\n        activeCharacterBook = fallbackBook;\n        appState.activeCharacterBook = fallbackBook;\n      }\n    }\n\n    return {\n      ...base,\n      id: 'char-lore',\n      instanceKey: 'char-lore',\n      activeBookName: activeCharacterBook,\n      scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u4E16\u754C\u4E66',\n      replaceScopeLabel: '\u5728\u5F53\u524D\u4E16\u754C\u4E66\u4E2D\u66FF\u6362',\n      visibleFilters: ['entryName', 'keywords', 'content'],\n      defaultFilters: { bookName: false, entryName: true, keywords: true, content: true },\n      showRecursion: true,\n      showFixKeywords: true,\n      showCollapseToggle: true,\n      showPositionMenu: true,\n      sortOptions: ['status', 'name'],\n      multiSelectTarget: 'entry',\n      primaryAction: {\n        visible: true,\n        icon: 'fa-file-circle-plus',\n        label: '\u65B0\u5EFA\u6761\u76EE',\n        title: '\u65B0\u5EFA\u6761\u76EE',\n        scope: 'entry',\n      },\n    };\n  }\n\n  if (tab === 'chat-lore') {\n    return {\n      ...base,\n      id: 'chat-lore',\n      instanceKey: 'chat-lore',\n      activeBookName: appState.chatLorebook,\n      scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u4E16\u754C\u4E66',\n      replaceScopeLabel: '\u5728\u5F53\u524D\u4E16\u754C\u4E66\u4E2D\u66FF\u6362',\n      visibleFilters: ['entryName', 'keywords', 'content'],\n      defaultFilters: { bookName: false, entryName: true, keywords: true, content: true },\n      showRecursion: true,\n      showFixKeywords: true,\n      showCollapseToggle: true,\n      showPositionMenu: true,\n      sortOptions: ['status', 'name'],\n      multiSelectTarget: 'entry',\n      primaryAction: {\n        visible: true,\n        icon: 'fa-file-circle-plus',\n        label: '\u65B0\u5EFA\u6761\u76EE',\n        title: '\u65B0\u5EFA\u6761\u76EE',\n        scope: 'entry',\n      },\n    };\n  }\n\n  if (tab === 'global-regex') {\n    return {\n      ...base,\n      id: 'global-regex',\n      instanceKey: 'global-regex',\n      type: 'regex',\n      scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u5168\u5C40\u6B63\u5219\u8868\u8FBE\u5F0F',\n      replaceScopeLabel: '\u5728\u5168\u5C40\u6B63\u5219\u4E2D\u66FF\u6362',\n      visibleFilters: ['entryName', 'content'],\n      filterLabels: { ...DEFAULT_FILTER_LABELS, ...REGEX_FILTER_LABELS },\n      defaultFilters: { bookName: false, entryName: true, keywords: false, content: true },\n      showRecursion: false,\n      showFixKeywords: false,\n      showCollapseToggle: true,\n      showPositionMenu: false,\n      sortOptions: [],\n      multiSelectTarget: 'regex',\n      supportsMultiSelect: true,\n      primaryAction: { visible: false },\n    };\n  }\n\n  if (tab === 'char-regex') {\n    return {\n      ...base,\n      id: 'char-regex',\n      instanceKey: 'char-regex',\n      type: 'regex',\n      scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u89D2\u8272\u6B63\u5219\u8868\u8FBE\u5F0F',\n      replaceScopeLabel: '\u5728\u89D2\u8272\u6B63\u5219\u4E2D\u66FF\u6362',\n      visibleFilters: ['entryName', 'content'],\n      filterLabels: { ...DEFAULT_FILTER_LABELS, ...REGEX_FILTER_LABELS },\n      defaultFilters: { bookName: false, entryName: true, keywords: false, content: true },\n      showRecursion: false,\n      showFixKeywords: false,\n      showCollapseToggle: true,\n      showPositionMenu: false,\n      sortOptions: [],\n      multiSelectTarget: 'regex',\n      supportsMultiSelect: false,\n      primaryAction: { visible: false },\n    };\n  }\n\n  return {\n    ...base,\n    id: 'unknown',\n    instanceKey: 'unknown',\n    supportsMultiSelect: false,\n  };\n};\n\nconst ensureSearchFiltersDefaults = context => {\n  const contextKey = context.id;\n  if (!contextKey) return;\n  if (!appState.searchFilterContextsInitialized.has(contextKey)) {\n    (context.visibleFilters ?? []).forEach(key => {\n      appState.searchFilters[key] = true;\n    });\n    appState.searchFilterContextsInitialized.add(contextKey);\n  }\n\n  if ((context.id === 'char-lore' || context.id === 'chat-lore') && appState.searchFilters.keywords === undefined) {\n    appState.searchFilters.keywords = true;\n  }\n};\n\nexport const renderContent = () => {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\n\n  const ensureLayoutNodes = () => {\n    if (!$panel.length) {\n      const emptySet = $([]);\n      return {\n        $toolbarRow: emptySet,\n        $toolbar: emptySet,\n        $replaceContainer: emptySet,\n        $content: emptySet,\n      };\n    }\n\n    let $toolbarRow = $panel.find('.rlh-toolbar-shell').first();\n    if (!$toolbarRow.length) {\n      const $tabNav = $panel.find('.rlh-tab-nav').first();\n      $toolbarRow = $('<div class=\"rlh-toolbar-shell\"></div>');\n      if ($tabNav.length) {\n        $toolbarRow.insertAfter($tabNav);\n      } else {\n        $panel.prepend($toolbarRow);\n      }\n    }\n\n    let $toolbar = $toolbarRow.find(`#${CORE_TOOLBAR_ID}`);\n    if (!$toolbar.length) {\n      $toolbar = $(`<div id=\"${CORE_TOOLBAR_ID}\" class=\"rlh-toolbar-container\"></div>`);\n      $toolbarRow.append($toolbar);\n    }\n\n    let $replaceContainer = $toolbarRow.find(`#${REPLACE_TOOL_CONTAINER_ID}`);\n    if (!$replaceContainer.length) {\n      $replaceContainer = $(`<div id=\"${REPLACE_TOOL_CONTAINER_ID}\" class=\"rlh-replace-container\"></div>`);\n      $toolbarRow.append($replaceContainer);\n    }\n\n    let $contentPane = $panel.find('.rlh-content-pane').first();\n    if (!$contentPane.length) {\n      $contentPane = $('<div class=\"rlh-content-pane\"></div>');\n      $contentPane.insertAfter($toolbarRow);\n    }\n\n    let $content = $contentPane.find(`#${PANEL_ID}-content`);\n    if (!$content.length) {\n      $content = $(`<div id=\"${PANEL_ID}-content\"></div>`);\n      $contentPane.append($content);\n    }\n\n    return { $toolbarRow, $toolbar, $replaceContainer, $content };\n  };\n\n  const searchTerm = normalizeSearchTerm(appState.globalSearch.term ?? '');\n\n  const filterSelectors = [\n    ['bookName', '#rlh-filter-book-name'],\n    ['entryName', '#rlh-filter-entry-name'],\n    ['keywords', '#rlh-filter-keywords'],\n    ['content', '#rlh-filter-content'],\n  ];\n  filterSelectors.forEach(([key, selector]) => {\n    const $checkbox = $panel.find(selector);\n    if ($checkbox.length) {\n      appState.searchFilters[key] = $checkbox.is(':checked');\n    }\n  });\n\n  const { $toolbar, $replaceContainer, $content } = ensureLayoutNodes();\n  $toolbar.empty();\n  $replaceContainer.empty();\n  $content.empty();\n\n  const viewContext = getViewContext();\n  ensureSearchFiltersDefaults(viewContext);\n\n  if (viewContext.tab !== 'global-lore') {\n    cancelGlobalLoreListRender();\n  }\n\n  if (!viewContext.supportsMultiSelect && appState.multiSelectMode) {\n    appState.multiSelectMode = false;\n    appState.selectedItems.clear();\n  }\n\n  if (appState.multiSelectMode) {\n    if (appState.multiSelectTarget !== viewContext.multiSelectTarget) {\n      appState.multiSelectTarget = viewContext.multiSelectTarget;\n      appState.selectedItems.clear();\n    }\n  } else {\n    appState.multiSelectTarget = viewContext.multiSelectTarget;\n  }\n\n  $panel.toggleClass('rlh-multi-select-mode', appState.multiSelectMode);\n\n  renderToolbar(viewContext, { $toolbar, $replaceContainer });\n  renderSaveStatus();\n  updateSelectionCount();\n\n  if (appState.isLoadingTabData) {\n    $content.html('<p class=\"rlh-info-text\">\u52A0\u8F7D\u4E2D...</p>');\n    return;\n  }\n\n  switch (viewContext.tab) {\n    case 'global-lore':\n      renderGlobalLoreTabView(viewContext, searchTerm, $content);\n      break;\n    case 'char-lore':\n      renderCharacterLorebookView(viewContext, searchTerm, $content);\n      break;\n    case 'chat-lore':\n      renderChatLorebookView(viewContext, searchTerm, $content);\n      break;\n    case 'global-regex':\n      renderRegexView(viewContext, appState.regexes.global, searchTerm, $content, '\u5168\u5C40\u6B63\u5219');\n      break;\n    case 'char-regex':\n      renderRegexView(viewContext, appState.regexes.character, searchTerm, $content, '\u89D2\u8272\u6B63\u5219');\n      break;\n    default:\n      $content.html('<p class=\"rlh-info-text\">\u5F53\u524D\u89C6\u56FE\u672A\u5B9E\u73B0\u3002</p>');\n      break;\n  }\n};\n", "import {\n  PANEL_ID,\n  REFRESH_BTN_ID,\n  PREFETCH_INDICATOR_ID,\n  PREFETCH_PROGRESS_BAR_ID,\n  PREFETCH_PROGRESS_TEXT_ID,\n  appState,\n  safeClearLorebookEntries,\n  safeSetLorebookEntries,\n  safeHasLorebookEntries,\n  safeGetLorebookEntries,\n  errorCatched,\n  get$,\n  getParentDoc,\n  getParentWin,\n  getTavernHelper,\n  DEFAULT_WORLD_BOOK_STATUS,\n  DEFAULT_STATUS_ID,\n  resolveWorldbookStatus,\n  normalizeWorldbookStatusId,\n  resolveLorebookBindingStats,\n} from './core.js';\nimport { renderContent } from './ui/render/index.js';\nimport { renderSaveStatus } from './ui/render/shared.js';\n\nconst LOGIC_STRING_TO_ENUM = Object.freeze({\n  and_any: 0,\n  not_all: 1,\n  not_any: 2,\n  and_all: 3,\n});\n\nconst LOGIC_ENUM_TO_STRING = Object.freeze({\n  0: 'and_any',\n  1: 'not_all',\n  2: 'not_any',\n  3: 'and_all',\n});\n\nconst ROLE_NAME_TO_ENUM = Object.freeze({\n  system: 0,\n  user: 1,\n  assistant: 2,\n});\n\nconst ROLE_ENUM_TO_NAME = Object.freeze({\n  0: 'system',\n  1: 'user',\n  2: 'assistant',\n});\n\nconst POSITION_UI_TO_STRUCT = Object.freeze({\n  before_character_definition: { type: 'before_character_definition' },\n  after_character_definition: { type: 'after_character_definition' },\n  before_example_messages: { type: 'before_example_messages' },\n  after_example_messages: { type: 'after_example_messages' },\n  before_author_note: { type: 'before_author_note' },\n  after_author_note: { type: 'after_author_note' },\n  at_depth_as_system: { type: 'at_depth', role: 'system' },\n  at_depth_as_assistant: { type: 'at_depth', role: 'assistant' },\n  at_depth_as_user: { type: 'at_depth', role: 'user' },\n});\n\nconst POSITION_NUMERIC_TO_UI = Object.freeze({\n  0: 'before_character_definition',\n  1: 'after_character_definition',\n  2: 'before_author_note',\n  3: 'after_author_note',\n  4: 'at_depth_as_system',\n  5: 'before_example_messages',\n  6: 'after_example_messages',\n});\n\nconst LEGACY_POSITION_ALIASES = Object.freeze({\n  before_char: 'before_character_definition',\n  after_char: 'after_character_definition',\n  before_an: 'before_author_note',\n  after_an: 'after_author_note',\n  before_em: 'before_example_messages',\n  after_em: 'after_example_messages',\n  at_depth: 'at_depth_as_system',\n  depth_system: 'at_depth_as_system',\n  depth_character: 'at_depth_as_assistant',\n  depth_user: 'at_depth_as_user',\n});\n\nconst THEME_SETTINGS_NAMESPACE = 'regexLoreHub';\nconst THEME_SETTINGS_KEY = 'regexLoreHub.themeId';\n\nexport const loadThemePreference = errorCatched(async () => {\n  let storedTheme = null;\n\n  try {\n    const helper = getTavernHelper();\n    const extensionSettings = helper?.extensionSettings;\n    if (extensionSettings && typeof extensionSettings === 'object') {\n      const container =\n        extensionSettings[THEME_SETTINGS_NAMESPACE] ??\n        extensionSettings.regexLoreHub ??\n        extensionSettings.RegexLoreHub ??\n        null;\n      if (container && typeof container === 'object') {\n        const candidate =\n          container.themeId ?? container.theme ?? container.theme_id ?? container.themeName;\n        if (typeof candidate === 'string' && candidate.trim()) {\n          storedTheme = candidate.trim();\n        }\n      }\n    }\n  } catch (error) {\n    console.warn('[RegexLoreHub] \u8BFB\u53D6 extensionSettings \u4E3B\u9898\u504F\u597D\u5931\u8D25\uFF1A', error);\n  }\n\n  if (!storedTheme) {\n    try {\n      const parentWin = getParentWin();\n      const rawValue = parentWin?.localStorage?.getItem(THEME_SETTINGS_KEY);\n      if (typeof rawValue === 'string' && rawValue.trim()) {\n        storedTheme = rawValue.trim();\n      }\n    } catch (error) {\n      console.warn('[RegexLoreHub] \u8BFB\u53D6 localStorage \u4E3B\u9898\u504F\u597D\u5931\u8D25\uFF1A', error);\n    }\n  }\n\n  return storedTheme ?? null;\n}, 'RegexLoreHubThemeStorage');\n\nexport const saveThemePreference = errorCatched(async themeId => {\n  const normalized = typeof themeId === 'string' ? themeId.trim() : '';\n  if (!normalized) return false;\n\n  let persisted = false;\n\n  try {\n    const helper = getTavernHelper();\n    const extensionSettings = helper?.extensionSettings;\n    if (extensionSettings && typeof extensionSettings === 'object') {\n      const namespaceKey = THEME_SETTINGS_NAMESPACE;\n      const container =\n        extensionSettings[namespaceKey] && typeof extensionSettings[namespaceKey] === 'object'\n          ? extensionSettings[namespaceKey]\n          : (extensionSettings[namespaceKey] = {});\n      container.themeId = normalized;\n      persisted = true;\n      if (helper?.builtin?.saveSettings) {\n        await helper.builtin.saveSettings();\n      }\n    }\n  } catch (error) {\n    console.warn('[RegexLoreHub] \u5199\u5165 extensionSettings \u4E3B\u9898\u504F\u597D\u5931\u8D25\uFF1A', error);\n  }\n\n  try {\n    const parentWin = getParentWin();\n    parentWin?.localStorage?.setItem(THEME_SETTINGS_KEY, normalized);\n    persisted = true;\n  } catch (error) {\n    console.warn('[RegexLoreHub] \u5199\u5165 localStorage \u4E3B\u9898\u504F\u597D\u5931\u8D25\uFF1A', error);\n  }\n\n  return persisted;\n}, 'RegexLoreHubThemeStorage');\n\nconst cloneEntry = source => (source ? JSON.parse(JSON.stringify(source)) : {});\n\nconst sanitizeKeyArray = keys =>\n  Array.isArray(keys)\n    ? keys\n        .map(key => {\n          if (typeof key === 'string') return key.trim();\n          if (key instanceof RegExp) return key.source;\n          if (key && typeof key === 'object') {\n            if (typeof key.pattern === 'string') return key.pattern.trim();\n            if (typeof key.source === 'string') return key.source.trim();\n          }\n          if (key !== null && key !== undefined && typeof key.toString === 'function') {\n            const str = key.toString();\n            return typeof str === 'string' ? str.trim() : '';\n          }\n          return '';\n        })\n        .filter(Boolean)\n    : [];\n\n// \u6309\u987A\u5E8F\u4E3A\u6B63\u5219\u5199\u5165\u987A\u5E8F\u5B57\u6BB5\uFF0C\u786E\u4FDD\u5BBF\u4E3B\u754C\u9762\u80FD\u591F\u8BFB\u53D6\u5230\u6700\u65B0\u7684\u6267\u884C\u987A\u5E8F\nconst ORDER_FIELD_KEYS = ['order', 'displayIndex', 'display_index', 'sort_order', 'script_order'];\n\nexport const updateRegexOrderMetadata = (regexList = []) => {\n  if (!Array.isArray(regexList) || regexList.length === 0) return;\n  regexList.forEach((regex, index) => {\n    if (!regex || typeof regex !== 'object' || regex.source === 'card') return;\n    ORDER_FIELD_KEYS.forEach(key => {\n      regex[key] = index;\n    });\n    if (regex?.position && typeof regex.position === 'object' && 'order' in regex.position) {\n      regex.position.order = index;\n    }\n  });\n};\n\nconst normalizeRegexPayloadOrder = regexes => {\n  if (!Array.isArray(regexes) || regexes.length === 0) return regexes;\n  const buckets = new Map([\n    ['global', []],\n    ['character', []],\n  ]);\n\n  regexes.forEach(regex => {\n    if (!regex || typeof regex !== 'object' || regex.source === 'card') return;\n    const scope = regex.scope === 'character' ? 'character' : 'global';\n    buckets.get(scope).push(regex);\n  });\n\n  buckets.forEach(list => updateRegexOrderMetadata(list));\n  return regexes;\n};\n\nconst toBooleanStrict = value => {\n  if (value === true || value === false) return value;\n  if (value === null || value === undefined) return false;\n  if (typeof value === 'string') {\n    const normalized = value.trim().toLowerCase();\n    return ['1', 'true', 'yes', 'on'].includes(normalized);\n  }\n  return Boolean(value);\n};\n\nconst parseOptionalNumber = value => {\n  if (value === '' || value === null || value === undefined) return null;\n  const numeric = Number(value);\n  return Number.isNaN(numeric) ? null : numeric;\n};\n\nconst normalizeLogicString = value => {\n  if (value === null || value === undefined) return 'and_any';\n  if (typeof value === 'number' && !Number.isNaN(value)) {\n    const mapped = LOGIC_ENUM_TO_STRING[value] ?? LOGIC_ENUM_TO_STRING[value.toString()];\n    return mapped ?? 'and_any';\n  }\n  const str = value.toString().trim().toLowerCase();\n  if (LOGIC_STRING_TO_ENUM[str] !== undefined) return str;\n  if (LOGIC_ENUM_TO_STRING[str] !== undefined) return LOGIC_ENUM_TO_STRING[str];\n  return 'and_any';\n};\n\nconst mapEnumLogicToUi = value => normalizeLogicString(value);\n\nconst mapUiLogicToEnum = value => LOGIC_STRING_TO_ENUM[normalizeLogicString(value)] ?? LOGIC_STRING_TO_ENUM.and_any;\n\nconst normalizeRoleName = value => {\n  if (typeof value === 'string') {\n    const normalized = value.trim().toLowerCase();\n    if (ROLE_NAME_TO_ENUM[normalized] !== undefined) return normalized;\n  }\n  if (typeof value === 'number' && !Number.isNaN(value)) {\n    const mapped = ROLE_ENUM_TO_NAME[value] ?? ROLE_ENUM_TO_NAME[value.toString()];\n    if (mapped) return mapped;\n  }\n  return null;\n};\n\nconst resolveUiPositionKey = (positionValue, roleValue) => {\n  if (positionValue === undefined || positionValue === null) {\n    return 'before_character_definition';\n  }\n  if (typeof positionValue === 'object' && positionValue !== null) {\n    if (typeof positionValue.type === 'string' && positionValue.type) {\n      const normalizedType = (LEGACY_POSITION_ALIASES[positionValue.type] ?? positionValue.type).trim();\n      if (normalizedType === 'at_depth' || normalizedType === 'at_depth_as_system') {\n        const roleName = normalizeRoleName(positionValue.role ?? roleValue) ?? 'system';\n        if (roleName === 'assistant') return 'at_depth_as_assistant';\n        if (roleName === 'user') return 'at_depth_as_user';\n        return 'at_depth_as_system';\n      }\n      if (normalizedType.startsWith('at_depth_as_')) {\n        return normalizedType;\n      }\n      return normalizedType;\n    }\n    if (typeof positionValue.position === 'number' && !Number.isNaN(positionValue.position)) {\n      return resolveUiPositionKey(positionValue.position, positionValue.role ?? roleValue);\n    }\n  }\n  if (typeof positionValue === 'string') {\n    const normalized = (LEGACY_POSITION_ALIASES[positionValue] ?? positionValue).trim();\n    if (normalized === 'at_depth') {\n      const roleName = normalizeRoleName(roleValue) ?? 'system';\n      if (roleName === 'assistant') return 'at_depth_as_assistant';\n      if (roleName === 'user') return 'at_depth_as_user';\n      return 'at_depth_as_system';\n    }\n    return normalized;\n  }\n  if (typeof positionValue === 'number' && !Number.isNaN(positionValue)) {\n    if (positionValue === 4) {\n      const roleName = normalizeRoleName(roleValue) ?? 'system';\n      if (roleName === 'assistant') return 'at_depth_as_assistant';\n      if (roleName === 'user') return 'at_depth_as_user';\n      return 'at_depth_as_system';\n    }\n    const mapped = POSITION_NUMERIC_TO_UI[positionValue];\n    if (mapped) return mapped;\n  }\n  return 'before_character_definition';\n};\n\nconst mapPositionToUiString = (positionValue, roleValue) => resolveUiPositionKey(positionValue, roleValue);\n\nconst extractPositionDetails = (positionValue, { fallbackRole = null, fallbackDepth = null, fallbackOrder = null } = {}) => {\n  const fallbackRoleName = normalizeRoleName(fallbackRole);\n  const details = {\n    type: 'before_character_definition',\n    role: null,\n    depth: null,\n    order: parseOptionalNumber(fallbackOrder),\n    uiKey: 'before_character_definition',\n  };\n\n  const setOrder = value => {\n    const parsed = parseOptionalNumber(value);\n    if (parsed !== null) details.order = parsed;\n  };\n  const setDepth = value => {\n    const parsed = parseOptionalNumber(value);\n    if (parsed !== null) details.depth = parsed;\n  };\n\n  setOrder(fallbackOrder);\n  setDepth(fallbackDepth);\n\n  if (positionValue && typeof positionValue === 'object') {\n    if (typeof positionValue.type === 'string' && positionValue.type) {\n      const normalizedType = (LEGACY_POSITION_ALIASES[positionValue.type] ?? positionValue.type).trim();\n      details.type = normalizedType === 'at_depth_as_system' ? 'at_depth' : normalizedType;\n      const roleName = normalizeRoleName(positionValue.role) ?? fallbackRoleName;\n      if (details.type === 'at_depth') {\n        details.role = roleName ?? 'system';\n        setDepth(positionValue.depth);\n        details.uiKey =\n          details.role === 'assistant'\n            ? 'at_depth_as_assistant'\n            : details.role === 'user'\n              ? 'at_depth_as_user'\n              : 'at_depth_as_system';\n      } else {\n        details.role = null;\n        details.depth = null;\n        details.uiKey = details.type;\n      }\n      setOrder(positionValue.order);\n      return details;\n    }\n    if (typeof positionValue.position === 'number' && !Number.isNaN(positionValue.position)) {\n      const roleName = normalizeRoleName(positionValue.role) ?? fallbackRoleName;\n      const uiKey = resolveUiPositionKey(positionValue.position, roleName);\n      details.uiKey = uiKey;\n      if (uiKey.startsWith('at_depth')) {\n        details.type = 'at_depth';\n        details.role = roleName ?? 'system';\n        setDepth(positionValue.depth);\n      } else {\n        details.type = uiKey;\n        details.role = null;\n        details.depth = null;\n      }\n      setOrder(positionValue.order);\n      return details;\n    }\n  }\n\n  const uiKey = resolveUiPositionKey(positionValue, fallbackRoleName);\n  details.uiKey = uiKey;\n\n  if (uiKey.startsWith('at_depth')) {\n    details.type = 'at_depth';\n    details.role = uiKey === 'at_depth_as_assistant' ? 'assistant' : uiKey === 'at_depth_as_user' ? 'user' : 'system';\n    if (details.depth === null) {\n      details.depth = parseOptionalNumber(fallbackDepth);\n    }\n  } else {\n    details.type = uiKey;\n    details.role = null;\n    details.depth = null;\n  }\n\n  return details;\n};\n\nconst buildRawPosition = (uiKeyInput, { depth, order, basePosition } = {}) => {\n  const baseDetails = extractPositionDetails(basePosition ?? null);\n  const normalizedKey = (LEGACY_POSITION_ALIASES[uiKeyInput] ?? uiKeyInput ?? baseDetails.uiKey)\n    .toString()\n    .trim() || baseDetails.uiKey || 'before_character_definition';\n  const mapping =\n    POSITION_UI_TO_STRUCT[normalizedKey] ??\n    POSITION_UI_TO_STRUCT[baseDetails.uiKey] ??\n    POSITION_UI_TO_STRUCT.before_character_definition;\n\n  const result = { type: mapping.type };\n  const parsedOrder = parseOptionalNumber(order);\n  const resolvedOrder =\n    parsedOrder !== null\n      ? parsedOrder\n      : baseDetails.order !== null && baseDetails.order !== undefined\n        ? baseDetails.order\n        : 0;\n  result.order = resolvedOrder;\n\n  if (mapping.type === 'at_depth') {\n    const role = mapping.role ?? baseDetails.role ?? 'system';\n    result.role = role;\n    const parsedDepth = parseOptionalNumber(depth);\n    const resolvedDepth =\n      parsedDepth !== null\n        ? parsedDepth\n        : baseDetails.depth !== null && baseDetails.depth !== undefined\n          ? baseDetails.depth\n          : 0;\n    result.depth = resolvedDepth;\n  }\n\n  return result;\n};\n\nexport const normalizeWorldbookEntry = entry => {\n  if (!entry || typeof entry !== 'object') return entry;\n  const clone = cloneEntry(entry);\n\n  if (!clone.strategy || typeof clone.strategy !== 'object') {\n    clone.strategy = {};\n  }\n  const strategy = clone.strategy;\n  const statusDef = resolveWorldbookStatus(inferStatusIdFromEntry(clone)) ?? DEFAULT_WORLD_BOOK_STATUS;\n  strategy.type = statusDef.strategyType;\n  clone.type = statusDef.strategyType;\n  clone.statusId = statusDef.id;\n\n  const keys = sanitizeKeyArray(strategy.keys ?? clone.keys ?? clone.key ?? clone.keywords);\n  strategy.keys = [...keys];\n  clone.keys = [...keys];\n  clone.key = [...keys];\n  clone.keywords = [...keys];\n\n  const secondaryKeys = sanitizeKeyArray(\n    strategy.keys_secondary?.keys ?? clone.keysecondary ?? clone.key_secondary ?? [],\n  );\n  if (!strategy.keys_secondary || typeof strategy.keys_secondary !== 'object') {\n    strategy.keys_secondary = { logic: 'and_any', keys: [] };\n  }\n  strategy.keys_secondary.keys = [...secondaryKeys];\n  clone.keysecondary = [...secondaryKeys];\n\n  const logicString = normalizeLogicString(strategy.keys_secondary.logic ?? clone.logic ?? clone.selectiveLogic);\n  strategy.keys_secondary.logic = logicString;\n  clone.logic = logicString;\n  clone.selectiveLogic = LOGIC_STRING_TO_ENUM[logicString];\n\n  const positionDetails = extractPositionDetails(clone.position, {\n    fallbackRole: clone.role,\n    fallbackDepth: clone.depth,\n    fallbackOrder: clone.order ?? clone.insertion_order ?? clone.displayIndex,\n  });\n  clone.position = positionDetails.uiKey;\n  clone.depth = positionDetails.type === 'at_depth' ? (positionDetails.depth ?? 0) : null;\n  clone.order = positionDetails.order ?? 0;\n  clone.role = positionDetails.role;\n\n  const probability = parseOptionalNumber(clone.probability);\n  clone.probability = probability === null ? 100 : probability;\n\n  if (!clone.recursion || typeof clone.recursion !== 'object') {\n    clone.recursion = { prevent_incoming: false, prevent_outgoing: false, delay_until: null };\n  }\n  clone.prevent_recursion = toBooleanStrict(\n    clone.prevent_recursion ?? clone.preventRecursion ?? clone.recursion.prevent_outgoing,\n  );\n  clone.exclude_recursion = toBooleanStrict(\n    clone.exclude_recursion ?? clone.excludeRecursion ?? clone.recursion.prevent_incoming,\n  );\n  clone.recursion.prevent_outgoing = clone.prevent_recursion;\n  clone.recursion.prevent_incoming = clone.exclude_recursion;\n\n  clone.case_sensitive = toBooleanStrict(clone.case_sensitive ?? clone.caseSensitive ?? false);\n  clone.caseSensitive = clone.case_sensitive;\n\n  clone.match_whole_words = toBooleanStrict(clone.match_whole_words ?? clone.matchWholeWords ?? false);\n  clone.matchWholeWords = clone.match_whole_words;\n\n  clone.enabled = clone.disable !== undefined ? !clone.disable : clone.enabled ?? true;\n\n  return clone;\n};\n\nconst convertUiEntryToRaw = (uiEntry, baseEntry = {}) => {\n  const raw = cloneEntry(baseEntry);\n  const uiClone = cloneEntry(uiEntry);\n\n  const resolvedStatus =\n    resolveWorldbookStatus(uiClone.statusId ?? uiClone.strategy?.type ?? uiClone.type) ?? DEFAULT_WORLD_BOOK_STATUS;\n  if (!raw.strategy || typeof raw.strategy !== 'object') {\n    raw.strategy = {};\n  }\n  raw.strategy.type = resolvedStatus.strategyType;\n  raw.type = resolvedStatus.strategyType;\n  raw.statusId = resolvedStatus.id;\n  uiClone.statusId = resolvedStatus.id;\n  if (!uiClone.strategy || typeof uiClone.strategy !== 'object') {\n    uiClone.strategy = {};\n  }\n  uiClone.strategy.type = resolvedStatus.strategyType;\n  uiClone.type = resolvedStatus.strategyType;\n\n  const numericUid = parseOptionalNumber(uiClone.uid);\n  if (numericUid !== null) raw.uid = numericUid;\n\n  if (uiClone.name !== undefined) raw.name = uiClone.name;\n  if (uiClone.comment !== undefined) raw.comment = uiClone.comment;\n  if (uiClone.content !== undefined) raw.content = uiClone.content;\n\n  if (!raw.strategy || typeof raw.strategy !== 'object') {\n    raw.strategy = {};\n  }\n  const strategy = raw.strategy;\n\n  const keys = sanitizeKeyArray(uiClone.keys ?? strategy.keys ?? raw.keys ?? raw.key ?? raw.keywords);\n  strategy.keys = [...keys];\n  raw.keys = [...keys];\n  raw.key = [...keys];\n  raw.keywords = [...keys];\n\n  const secondaryKeys = sanitizeKeyArray(\n    uiClone.keysecondary ?? strategy.keys_secondary?.keys ?? raw.keysecondary,\n  );\n  if (!strategy.keys_secondary || typeof strategy.keys_secondary !== 'object') {\n    strategy.keys_secondary = { logic: 'and_any', keys: [] };\n  }\n  strategy.keys_secondary.keys = [...secondaryKeys];\n  raw.keysecondary = [...secondaryKeys];\n\n  const logicString = normalizeLogicString(\n    uiClone.logic ?? strategy.keys_secondary.logic ?? raw.logic ?? raw.selectiveLogic,\n  );\n  strategy.keys_secondary.logic = logicString;\n  raw.logic = logicString;\n  raw.selectiveLogic = LOGIC_STRING_TO_ENUM[logicString];\n\n  if (uiClone.enabled !== undefined) {\n    raw.enabled = Boolean(uiClone.enabled);\n    raw.disable = !raw.enabled;\n  }\n\n  const probability = parseOptionalNumber(uiClone.probability);\n  if (probability !== null) {\n    raw.probability = probability;\n    raw.useProbability = probability !== 100;\n  } else if (raw.probability !== undefined) {\n    raw.useProbability = raw.probability !== 100;\n  }\n\n  const order = parseOptionalNumber(uiClone.order);\n  const depth = parseOptionalNumber(uiClone.depth);\n  const positionStruct = buildRawPosition(uiClone.position ?? raw.position, {\n    depth,\n    order,\n    basePosition: raw.position,\n  });\n  raw.position = positionStruct;\n  if (positionStruct.type === 'at_depth') {\n    raw.depth = positionStruct.depth ?? 0;\n    raw.role = positionStruct.role ?? 'system';\n  } else {\n    raw.depth = null;\n    raw.role = null;\n  }\n  if (positionStruct.order !== undefined) {\n    raw.order = positionStruct.order;\n    raw.insertion_order = positionStruct.order;\n    raw.displayIndex = positionStruct.order;\n  }\n\n  if (!raw.recursion || typeof raw.recursion !== 'object') {\n    raw.recursion = { prevent_incoming: false, prevent_outgoing: false, delay_until: null };\n  }\n  const recursion = raw.recursion;\n  if (uiClone.prevent_recursion !== undefined) {\n    recursion.prevent_outgoing = Boolean(uiClone.prevent_recursion);\n  }\n  if (uiClone.exclude_recursion !== undefined) {\n    recursion.prevent_incoming = Boolean(uiClone.exclude_recursion);\n  }\n  raw.preventRecursion = recursion.prevent_outgoing;\n  raw.prevent_recursion = recursion.prevent_outgoing;\n  raw.excludeRecursion = recursion.prevent_incoming;\n  raw.exclude_recursion = recursion.prevent_incoming;\n\n  const resolveBool = (uiValue, currentValue) => {\n    if (uiValue === undefined) return currentValue;\n    return toBooleanStrict(uiValue);\n  };\n\n  const caseSensitiveValue = resolveBool(uiClone.case_sensitive, raw.caseSensitive ?? raw.case_sensitive);\n  if (caseSensitiveValue !== undefined) {\n    raw.caseSensitive = caseSensitiveValue;\n    raw.case_sensitive = caseSensitiveValue;\n  }\n\n  const matchWholeWordsValue = resolveBool(uiClone.match_whole_words, raw.matchWholeWords ?? raw.match_whole_words);\n  if (matchWholeWordsValue !== undefined) {\n    raw.matchWholeWords = matchWholeWordsValue;\n    raw.match_whole_words = matchWholeWordsValue;\n  }\n\n  return raw;\n};\n\n\nconst resolveNumericUid = value => {\n  if (typeof value === 'number' && Number.isInteger(value)) return value;\n  const parsed = Number(value);\n  return Number.isInteger(parsed) ? parsed : null;\n};\n\nconst inferStatusIdFromEntry = entry => {\n  if (!entry || typeof entry !== 'object') return DEFAULT_STATUS_ID;\n  const rawType = entry?.strategy?.type ?? entry?.type;\n  const normalized = normalizeWorldbookStatusId(rawType);\n  return normalized ?? DEFAULT_STATUS_ID;\n};\n\nconst toTargetMeta = target => {\n  if (target && typeof target === 'object') {\n    const candidateUid =\n      resolveNumericUid(target.uid ?? target.id ?? target.entryUid ?? target.entry_id ?? null);\n    return {\n      uid: candidateUid,\n      tempUid: target.tempUid ?? target.temp_uid ?? null,\n      name: target.name ?? '',\n    };\n  }\n  return { uid: resolveNumericUid(target), tempUid: null, name: '' };\n};\n\nconst makeEntryMeta = (entry, fallback = {}) => {\n  const targetMeta = toTargetMeta(entry);\n  const fallbackMeta = toTargetMeta(fallback);\n  return {\n    uid: targetMeta.uid ?? fallbackMeta.uid ?? null,\n    tempUid: entry?.tempUid ?? entry?.temp_uid ?? fallbackMeta.tempUid ?? null,\n    name: entry?.name ?? fallbackMeta.name ?? '',\n    previousStatus: inferStatusIdFromEntry(entry ?? {}),\n  };\n};\n\nconst makeTargetMeta = target => {\n  const meta = toTargetMeta(target);\n  return {\n    uid: meta.uid,\n    tempUid: meta.tempUid,\n    name: meta.name,\n    previousStatus: null,\n  };\n};\n\nconst makeStatusRecord = (meta, overrides = {}) => ({\n  uid: meta?.uid ?? null,\n  tempUid: meta?.tempUid ?? null,\n  name: meta?.name ?? '',\n  previousStatus: meta?.previousStatus ?? null,\n  newStatus: overrides.newStatus ?? null,\n  alreadyApplied: Boolean(overrides.alreadyApplied),\n  reason: overrides.reason ?? null,\n  error: overrides.error ?? null,\n});\n\nconst STATUS_CHANGE_REASON = Object.freeze({\n  UNSAVED_ENTRY: 'UNSAVED_ENTRY',\n  DUPLICATE_SELECTION: 'DUPLICATE_SELECTION',\n  ENTRY_NOT_FOUND: 'ENTRY_NOT_FOUND',\n  API_ERROR: 'API_ERROR',\n  STATUS_NOT_APPLIED: 'STATUS_NOT_APPLIED',\n});\n\nconst sanitizeKeysForUpdate = keys => sanitizeKeyArray(keys);\n\nconst isCharacterNotFoundError = (error) => {\n  if (!error) return false;\n  const message = String(error?.message ?? error ?? '').toLowerCase();\n  return message.includes('\u672A\u627E\u5230\u540D\u4E3A') || (message.includes('character') && message.includes('not found'));\n};\n\nexport const TavernAPI = {\n  createWorldbook: errorCatched(async name => await getTavernHelper().createWorldbook(name, [])),\n  deleteWorldbook: errorCatched(async name => await getTavernHelper().deleteWorldbook(name)),\n  getWorldbooks: errorCatched(async () => await getTavernHelper().getWorldbookNames()),\n  getCharData: errorCatched(async () => await getTavernHelper().getCharData()),\n  getRegexes: errorCatched(async () => await getTavernHelper().getTavernRegexes({ scope: 'all' })),\n  replaceRegexes: errorCatched(async (regexes, options = {}) => {\n    const scope = options?.scope ?? 'all';\n    const payload = Array.isArray(regexes) ? regexes : [];\n    normalizeRegexPayloadOrder(payload);\n    await getTavernHelper().replaceTavernRegexes(payload, { scope });\n  }),\n  getGlobalWorldbookNames: errorCatched(async () => await getTavernHelper().getGlobalWorldbookNames()),\n  rebindGlobalWorldbooks: errorCatched(async bookNames => await getTavernHelper().rebindGlobalWorldbooks(bookNames)),\n  getCharWorldbookNames: errorCatched(async charData => {\n    try {\n      const characterName = charData?.name;\n      if (!characterName) {\n        console.warn('[RegexLoreHub] getCharWorldbookNames \u8C03\u7528\u7F3A\u5C11\u89D2\u8272\u540D\u79F0\u3002');\n        return null;\n      }\n      return await getTavernHelper().getCharWorldbookNames(characterName);\n    } catch (error) {\n      if (isCharacterNotFoundError(error)) {\n        console.warn('[RegexLoreHub] \u672A\u627E\u5230\u6307\u5B9A\u89D2\u8272\u5361\uFF0C\u8DF3\u8FC7\u89D2\u8272\u4E16\u754C\u4E66\u52A0\u8F7D\u3002', error);\n        return null;\n      }\n      throw error;\n    }\n  }),\n  getCurrentCharWorldbookNames: errorCatched(async () => {\n    try {\n      return await getTavernHelper().getCharWorldbookNames('current');\n    } catch (error) {\n      if (isCharacterNotFoundError(error)) {\n        console.warn('[RegexLoreHub] \u672A\u627E\u5230\u5F53\u524D\u89D2\u8272\u5361\uFF0C\u8DF3\u8FC7\u89D2\u8272\u4E16\u754C\u4E66\u52A0\u8F7D\u3002', error);\n        return null;\n      }\n      throw error;\n    }\n  }),\n  getChatWorldbookName: errorCatched(async () => await getTavernHelper().getChatWorldbookName('current')),\n  getOrCreateChatWorldbook: errorCatched(async name => await getTavernHelper().getOrCreateChatWorldbook('current', name)),\n  rebindChatWorldbook: errorCatched(async name => await getTavernHelper().rebindChatWorldbook('current', name)),\n  getWorldbook: errorCatched(async name => await getTavernHelper().getWorldbook(name)),\n  updateWorldbookWith: errorCatched(async (name, updater) => await getTavernHelper().updateWorldbookWith(name, updater)),\n  replaceWorldbook: errorCatched(async (name, entries) => await getTavernHelper().replaceWorldbook(name, entries)),\n  createWorldbookEntries: errorCatched(async (name, entries) => await getTavernHelper().createWorldbookEntries(name, entries)),\n  deleteWorldbookEntries: errorCatched(async (name, uids) => {\n    const uidsSet = new Set(uids);\n    return await getTavernHelper().deleteWorldbookEntries(name, entry => uidsSet.has(entry.uid));\n  }),\n  saveSettings: errorCatched(async () => await getTavernHelper().builtin.saveSettings()),\n  rebindCharWorldbooks: errorCatched(async lorebooks => await getTavernHelper().rebindCharWorldbooks('current', lorebooks)),\n  get Character() {\n    return getTavernHelper().Character;\n  },\n};\n\nexport const updateWorldbookEntries = errorCatched(async (bookName, entryUpdates) => {\n  if (!Array.isArray(entryUpdates) || entryUpdates.length === 0) return;\n\n  const updatesByUid = new Map();\n  const pendingUidSet = new Set();\n\n  entryUpdates.forEach(update => {\n    if (!update || typeof update !== 'object') return;\n    const uid = parseOptionalNumber(update.uid);\n    if (uid === null) return;\n    pendingUidSet.add(uid);\n    const existing = updatesByUid.get(uid) ?? {};\n    updatesByUid.set(uid, { ...existing, ...update });\n  });\n\n  if (pendingUidSet.size === 0) return;\n\n  const localEntries = safeGetLorebookEntries(bookName);\n  const localEntryMap = new Map(\n    localEntries\n      .map(entry => [parseOptionalNumber(entry?.uid), entry])\n      .filter(([uid]) => uid !== null),\n  );\n\n  const updater = currentEntries =>\n    currentEntries.map(entry => {\n      const uid = parseOptionalNumber(entry?.uid);\n      if (uid === null || !pendingUidSet.has(uid)) return entry;\n      const localEntry = localEntryMap.get(uid);\n      if (!localEntry) return entry;\n      const mergedLocal = cloneEntry(localEntry);\n      const partialUpdate = updatesByUid.get(uid);\n      if (partialUpdate && typeof partialUpdate === 'object') {\n        // \u5148\u5C06\u8C03\u7528\u65B9\u4F20\u5165\u7684\u589E\u91CF\u6570\u636E\u5408\u5E76\u5230\u672C\u5730\u6761\u76EE\uFF0C\u518D\u7EDF\u4E00\u4EA4\u7ED9\u8F6C\u6362\u51FD\u6570\u5904\u7406\n        Object.entries(partialUpdate).forEach(([key, value]) => {\n          if (key === 'uid' || key === 'tempUid') return;\n          if (Array.isArray(value)) {\n            mergedLocal[key] = value.map(item => (typeof item === 'object' && item !== null ? cloneEntry(item) : item));\n          } else if (value && typeof value === 'object') {\n            mergedLocal[key] = cloneEntry(value);\n          } else {\n            mergedLocal[key] = value;\n          }\n        });\n      }\n      return convertUiEntryToRaw(mergedLocal, entry);\n    });\n\n  const updatedEntries = await TavernAPI.updateWorldbookWith(bookName, updater);\n\n  const normalizedEntries = Array.isArray(updatedEntries)\n    ? updatedEntries.map(normalizeWorldbookEntry)\n    : [];\n  safeSetLorebookEntries(bookName, normalizedEntries);\n  updateBookSummary(bookName);\n\n  await TavernAPI.saveSettings();\n  return updatedEntries;\n});\n\nconst buildStatusSummary = (statusDef, successRecords, failedRecords, ignoredRecords, requestedCount) => {\n  const successCount = successRecords.length;\n  const failedCount = failedRecords.length;\n  const ignoredCount = ignoredRecords.length;\n  const alreadyAppliedCount = successRecords.filter(record => record.alreadyApplied).length;\n  const appliedCount = successCount - alreadyAppliedCount;\n  const ignoredUnsavedCount = ignoredRecords.filter(\n    record => record.reason === STATUS_CHANGE_REASON.UNSAVED_ENTRY,\n  ).length;\n\n  let status = 'skipped';\n  if (successCount > 0 && failedCount === 0) status = 'success';\n  else if (successCount > 0 && failedCount > 0) status = 'partial';\n  else if (failedCount > 0) status = 'failed';\n\n  return {\n    status,\n    successCount,\n    failedCount,\n    ignoredCount,\n    alreadyAppliedCount,\n    appliedCount,\n    ignoredUnsavedCount,\n    requestedCount,\n    targetStatusId: statusDef.id,\n    targetStatusLabel: statusDef.label,\n  };\n};\n\nexport const updateWorldbookEntriesStatus = async (bookName, targets, targetStatusId, options = {}) => {\n  const normalizedTargets = Array.isArray(targets)\n    ? targets.filter(item => item !== undefined && item !== null)\n    : targets !== undefined && targets !== null\n      ? [targets]\n      : [];\n  const requestedCount = normalizedTargets.length;\n\n  const statusDef = resolveWorldbookStatus(targetStatusId);\n  if (!statusDef) {\n    return {\n      ok: false,\n      targetStatusId: normalizeWorldbookStatusId(targetStatusId),\n      targetStatusLabel: '',\n      targetStrategyType: null,\n      success: [],\n      failed: [],\n      ignored: [],\n      summary: {\n        status: 'failed',\n        successCount: 0,\n        failedCount: 0,\n        ignoredCount: 0,\n        alreadyAppliedCount: 0,\n        appliedCount: 0,\n        ignoredUnsavedCount: 0,\n        requestedCount,\n        targetStatusId: normalizeWorldbookStatusId(targetStatusId),\n        targetStatusLabel: '',\n      },\n      errorCode: 'INVALID_STATUS',\n    };\n  }\n\n  if (!bookName || typeof bookName !== 'string') {\n    const fallbackStatus = DEFAULT_WORLD_BOOK_STATUS;\n    return {\n      ok: false,\n      targetStatusId: fallbackStatus.id,\n      targetStatusLabel: fallbackStatus.label,\n      targetStrategyType: fallbackStatus.strategyType,\n      success: [],\n      failed: [],\n      ignored: [],\n      summary: buildStatusSummary(fallbackStatus, [], [], [], requestedCount),\n      errorCode: 'INVALID_BOOK_NAME',\n    };\n  }\n\n  const entries = safeGetLorebookEntries(bookName);\n  const entryMap = new Map(entries.map(entry => [resolveNumericUid(entry?.uid), entry]));\n  const processedUids = new Set();\n\n  const successRecords = [];\n  const failedRecords = [];\n  const ignoredRecords = [];\n\n  const pendingUpdates = [];\n  const pendingMeta = new Map();\n\n  normalizedTargets.forEach(target => {\n    const targetMeta = makeTargetMeta(target);\n    if (targetMeta.uid === null) {\n      ignoredRecords.push(\n        makeStatusRecord(targetMeta, { reason: STATUS_CHANGE_REASON.UNSAVED_ENTRY }),\n      );\n      return;\n    }\n\n    if (processedUids.has(targetMeta.uid)) {\n      const duplicateEntry = entryMap.get(targetMeta.uid);\n      const duplicateMeta = duplicateEntry ? makeEntryMeta(duplicateEntry, targetMeta) : targetMeta;\n      ignoredRecords.push(\n        makeStatusRecord(duplicateMeta, { reason: STATUS_CHANGE_REASON.DUPLICATE_SELECTION }),\n      );\n      return;\n    }\n    processedUids.add(targetMeta.uid);\n\n    const currentEntry = entryMap.get(targetMeta.uid);\n    if (!currentEntry) {\n      failedRecords.push(\n        makeStatusRecord(targetMeta, { reason: STATUS_CHANGE_REASON.ENTRY_NOT_FOUND }),\n      );\n      return;\n    }\n\n    const entryMeta = makeEntryMeta(currentEntry, targetMeta);\n\n    if (entryMeta.previousStatus === statusDef.id) {\n      successRecords.push(\n        makeStatusRecord(entryMeta, {\n          newStatus: statusDef.id,\n          alreadyApplied: true,\n        }),\n      );\n      return;\n    }\n\n    const nextStrategy = cloneEntry(currentEntry.strategy ?? {});\n    nextStrategy.type = statusDef.strategyType;\n\n    pendingUpdates.push({\n      uid: entryMeta.uid,\n      statusId: statusDef.id,\n      strategy: nextStrategy,\n      type: statusDef.strategyType,\n    });\n    pendingMeta.set(entryMeta.uid, entryMeta);\n  });\n\n  let updateResult;\n  if (pendingUpdates.length > 0) {\n    updateResult = await updateWorldbookEntries(bookName, pendingUpdates);\n  }\n\n  if (pendingMeta.size > 0) {\n    const latestEntries = safeGetLorebookEntries(bookName);\n    const latestMap = new Map(\n      latestEntries.map(entry => [resolveNumericUid(entry?.uid), entry]),\n    );\n    const apiFailed = pendingUpdates.length > 0 && !Array.isArray(updateResult);\n    pendingMeta.forEach(entryMeta => {\n      const latestEntry = latestMap.get(entryMeta.uid);\n      const latestStatus = inferStatusIdFromEntry(latestEntry);\n      if (!latestEntry || latestStatus !== statusDef.id) {\n        failedRecords.push(\n          makeStatusRecord(entryMeta, {\n            reason: apiFailed\n              ? STATUS_CHANGE_REASON.API_ERROR\n              : STATUS_CHANGE_REASON.STATUS_NOT_APPLIED,\n          }),\n        );\n        return;\n      }\n\n      successRecords.push(\n        makeStatusRecord(entryMeta, {\n          newStatus: statusDef.id,\n        }),\n      );\n    });\n  }\n\n  const summary = buildStatusSummary(\n    statusDef,\n    successRecords,\n    failedRecords,\n    ignoredRecords,\n    requestedCount,\n  );\n\n  return {\n    ok: summary.status === 'success',\n    targetStatusId: statusDef.id,\n    targetStatusLabel: statusDef.label,\n    targetStrategyType: statusDef.strategyType,\n    targetToastLabel: statusDef.toastLabel ?? statusDef.label,\n    success: successRecords,\n    failed: failedRecords,\n    ignored: ignoredRecords,\n    summary,\n    options,\n  };\n};\n\nexport const updateWorldbookEntryStatus = async (bookName, target, targetStatusId, options = {}) =>\n  updateWorldbookEntriesStatus(bookName, target === undefined ? [] : [target], targetStatusId, options);\n\n\nconst ensurePendingLorebookUpdateMap = bookName => {\n  if (!appState.pendingLorebookUpdates.has(bookName)) {\n    appState.pendingLorebookUpdates.set(bookName, new Map());\n  }\n  return appState.pendingLorebookUpdates.get(bookName);\n};\n\nexport const queueLorebookEntryUpdate = (bookName, entryIdentifier, partialUpdate = {}) => {\n  if (!bookName || !partialUpdate || typeof partialUpdate !== 'object') return;\n  const numericUid = resolveNumericUid(entryIdentifier);\n  const key = String(entryIdentifier);\n  const updatesMap = ensurePendingLorebookUpdateMap(bookName);\n  const existing =\n    updatesMap.get(key) ??\n    {\n      uid: numericUid,\n      tempUid: numericUid == null ? key : null,\n      data: {},\n    };\n\n  if (numericUid != null) {\n    existing.uid = numericUid;\n  }\n\n  if (!existing.data || typeof existing.data !== 'object') {\n    existing.data = {};\n  }\n\n  const payload = { ...partialUpdate };\n  if (Array.isArray(payload.keys)) {\n    payload.keys = sanitizeKeysForUpdate(payload.keys);\n  }\n\n  Object.entries(payload).forEach(([field, value]) => {\n    if (value !== undefined) {\n      existing.data[field] = value;\n    }\n  });\n\n  updatesMap.set(key, existing);\n};\n\nexport const queueRegexUpdate = regexId => {\n  if (regexId === undefined || regexId === null) return;\n  appState.pendingRegexUpdates.add(regexId);\n};\n\nconst migratePendingLorebookUpdate = (bookName, tempUid, newUid) => {\n  const numericUid = resolveNumericUid(newUid);\n  if (!bookName || tempUid == null || numericUid == null) return;\n  const updatesMap = appState.pendingLorebookUpdates.get(bookName);\n  if (!updatesMap || !(updatesMap instanceof Map)) return;\n\n  const tempKey = String(tempUid);\n  const record = updatesMap.get(tempKey);\n  if (!record) return;\n\n  updatesMap.delete(tempKey);\n\n  const newKey = String(numericUid);\n  const target =\n    updatesMap.get(newKey) ??\n    {\n      uid: numericUid,\n      tempUid: null,\n      data: {},\n    };\n\n  target.uid = numericUid;\n  if (!target.data || typeof target.data !== 'object') {\n    target.data = {};\n  }\n  if (record.data && typeof record.data === 'object') {\n    target.data = { ...record.data, ...target.data };\n  }\n\n  updatesMap.set(newKey, target);\n};\n\nlet loadAllDataPromise = null;\n\nconst performLoadAllData = async () => {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  const parentWin = getParentWin();\n  const TavernHelper = getTavernHelper();\n  const $content = $(`#${PANEL_ID}-content`, parentDoc);\n\n  syncContextWithAppState(); // <--- \u5728\u6B64\u5904\u6DFB\u52A0\u8C03\u7528\n\n  const createLoadingUI = () => {\n    const html = `\n      <div class=\"rlh-loading\">\n        <div class=\"rlh-loading-spinner\" aria-hidden=\"true\"></div>\n        <div class=\"rlh-loading-text\">\n          <p class=\"rlh-loading-title\">\u6B63\u5728\u52A0\u8F7D\u6570\u636E...</p>\n          <p class=\"rlh-loading-status\">\u521D\u59CB\u5316...</p>\n          <div class=\"rlh-loading-bar\" role=\"progressbar\" aria-valuemin=\"0\" aria-valuemax=\"100\" aria-valuenow=\"0\">\n            <div class=\"rlh-loading-bar-inner\"></div>\n          </div>\n          <div class=\"rlh-loading-progress\">0%</div>\n          <p class=\"rlh-loading-detail\"></p>\n        </div>\n      </div>\n    `;\n    $content.html(html);\n    const $status = $content.find('.rlh-loading-status');\n    const $detail = $content.find('.rlh-loading-detail');\n    const $progress = $content.find('.rlh-loading-progress');\n    const $bar = $content.find('.rlh-loading-bar-inner');\n    const $barContainer = $content.find('.rlh-loading-bar');\n\n    let total = 1;\n    let current = 0;\n\n    const updateBar = () => {\n      const safeTotal = Math.max(1, total);\n      const ratio = Math.min(current / safeTotal, 1);\n      const percent = Math.round(ratio * 100);\n      $bar.css('width', `${percent}%`);\n      $barContainer.attr('aria-valuenow', percent);\n      $progress.text(`${percent}%`);\n    };\n\n    updateBar();\n\n    return {\n      setProgress(currentValue, totalValue, status, detail) {\n        total = Math.max(1, totalValue);\n        current = Math.max(0, Math.min(currentValue, total));\n        if (status) $status.text(status);\n        if (detail !== undefined) $detail.text(detail);\n        updateBar();\n      },\n      setStatus(status, detail) {\n        if (status) $status.text(status);\n        if (detail !== undefined) $detail.text(detail);\n      },\n    };\n  };\n\n  const loading = createLoadingUI();\n  let totalSteps = 4;\n  let progressCurrent = 0;\n\n  const advanceProgress = (status, detail) => {\n    progressCurrent = Math.min(progressCurrent + 1, totalSteps);\n    loading.setProgress(progressCurrent, totalSteps, status, detail);\n  };\n\n  loading.setProgress(progressCurrent, totalSteps, '\u51C6\u5907\u52A0\u8F7D\u6570\u636E...', '\u6B63\u5728\u68C0\u67E5\u8FD0\u884C\u73AF\u5883');\n\n  try {\n    // \u9632\u5FA1\u6027\u68C0\u67E5\uFF1A\u786E\u4FDDSillyTavern API\u53EF\u7528\n    if (!parentWin.SillyTavern || !parentWin.SillyTavern.getContext) {\n      console.warn('[RegexLoreHub] SillyTavern API not available, initializing with empty data');\n      appState.regexes.global = [];\n      appState.regexes.character = [];\n      appState.allLorebooks = [];\n      appState.lorebooks.character = [];\n      appState.chatLorebook = null;\n      safeClearLorebookEntries();\n      appState.isDataLoaded = true;\n      renderContent();\n      return;\n    }\n\n    advanceProgress('\u83B7\u53D6\u57FA\u7840\u6570\u636E...', '\u6B63\u5728\u5411 SillyTavern \u8BF7\u6C42\u6570\u636E');\n    const context = parentWin.SillyTavern?.getContext?.() || {};\n    const allCharacters = Array.isArray(context.characters) ? context.characters : [];\n    const hasActiveCharacter = context.characterId !== undefined && context.characterId !== null;\n    const hasActiveChat = context.chatId !== undefined && context.chatId !== null;\n\n    let charData = null,\n      charLinkedBooks = null,\n      chatLorebook = null;\n\n    // \u4F7F\u7528Promise.allSettled\u6765\u907F\u514D\u5355\u4E2A\u5931\u8D25\u5F71\u54CD\u6574\u4F53\n    const promises = [\n      TavernAPI.getRegexes().catch(() => []),\n      TavernAPI.getGlobalWorldbookNames().catch(() => ([])),\n      TavernAPI.getWorldbooks().catch(() => []),\n    ];\n\n    if (hasActiveCharacter) {\n      promises.push(TavernAPI.getCharData().catch(() => null));\n      promises.push(TavernAPI.getCurrentCharWorldbookNames().catch(() => null));\n    } else {\n      promises.push(Promise.resolve(null), Promise.resolve(null));\n    }\n\n    if (hasActiveChat) {\n      // \u53EA\u6709\u5728\u786E\u5B9E\u6709\u6D3B\u8DC3\u804A\u5929\u65F6\u624D\u5C1D\u8BD5\u83B7\u53D6\u804A\u5929\u4E16\u754C\u4E66\n      promises.push(\n        TavernAPI.getChatWorldbookName().catch(error => {\n          console.warn('[RegexLoreHub] Failed to get chat worldbook:', error);\n          return null;\n        }),\n      );\n    } else {\n      promises.push(Promise.resolve(null));\n    }\n\n    const results = await Promise.allSettled(promises);\n\n    advanceProgress('\u89E3\u6790\u6570\u636E\u7ED3\u6784...', `\u68C0\u6D4B\u5230 ${allCharacters.length} \u4E2A\u89D2\u8272\uFF0C\u6B63\u5728\u6574\u7406\u6570\u636E`);\n\n\n    // \u5B89\u5168\u63D0\u53D6\u7ED3\u679C\n    const allUIRegexes = results[0].status === 'fulfilled' ? results[0].value : [];\n    const enabledGlobalBookNames = results[1].status === 'fulfilled' ? results[1].value : [];\n    const allBookFileNames = results[2].status === 'fulfilled' ? results[2].value : [];\n    charData = results[3]?.status === 'fulfilled' ? results[3].value : null;\n    charLinkedBooks = results[4]?.status === 'fulfilled' ? results[4].value : null;\n    chatLorebook = results[5]?.status === 'fulfilled' ? results[5].value : null;\n\n    syncContextWithAppState({ charData }); // \u786E\u4FDD\u89D2\u8272\u540D\u5728\u521D\u6B21\u6E32\u67D3\u524D\u5DF2\u5C31\u7EEA\n\n    appState.regexes.global = Array.isArray(allUIRegexes) ? allUIRegexes.filter(r => r.scope === 'global') : [];\n    updateRegexOrderMetadata(appState.regexes.global);\n    updateCharacterRegexes(allUIRegexes, charData);\n\n    \n\n    safeClearLorebookEntries();\n    if (!(appState.pendingLorebookUpdates instanceof Map)) {\n      appState.pendingLorebookUpdates = new Map();\n    } else {\n      appState.pendingLorebookUpdates.clear();\n    }\n    if (!(appState.pendingRegexUpdates instanceof Set)) {\n      appState.pendingRegexUpdates = new Set();\n    } else {\n      appState.pendingRegexUpdates.clear();\n    }\n    appState.lorebookUsage.clear();\n    const knownBookNames = new Set(Array.isArray(allBookFileNames) ? allBookFileNames : []);\n\n    // \u5B89\u5168\u5904\u7406\u89D2\u8272\u4E16\u754C\u4E66\n    if (Array.isArray(allCharacters) && allCharacters.length > 0) {\n      try {\n        await Promise.all(\n          allCharacters.map(async char => {\n            if (!char || !char.name) return;\n            try {\n              let books = null;\n              try {\n                const result = TavernHelper.getCharWorldbookNames(char.name);\n                // \u68C0\u67E5\u662F\u5426\u4E3A Promise\n                if (result && typeof result.then === 'function') {\n                  books = await result;\n                } else {\n                  books = result;\n                }\n              } catch (error) {\n                console.warn(`[RegexLoreHub] Error getting worldbooks for character \"${char.name}\":`, error);\n                books = null;\n              }\n              if (books && typeof books === 'object') {\n                const bookSet = new Set();\n                if (books.primary && typeof books.primary === 'string') bookSet.add(books.primary);\n                if (Array.isArray(books.additional)) {\n                  books.additional.forEach(b => typeof b === 'string' && bookSet.add(b));\n                }\n\n                bookSet.forEach(bookName => {\n                  if (typeof bookName === 'string') {\n                    if (!appState.lorebookUsage.has(bookName)) {\n                      appState.lorebookUsage.set(bookName, []);\n                    }\n                    appState.lorebookUsage.get(bookName).push(char.name);\n                    knownBookNames.add(bookName);\n                    console.log(`[RegexLoreHub] Character \"${char.name}\" uses worldbook \"${bookName}\"`);\n                  }\n                });\n              }\n            } catch (charError) {\n              console.warn(`[RegexLoreHub] Error processing character ${char.name}:`, charError);\n            }\n          }),\n        );\n      } catch (charProcessingError) {\n        console.warn('[RegexLoreHub] Error processing characters:', charProcessingError);\n      }\n    }\n\n    const enabledGlobalBooks = new Set(Array.isArray(enabledGlobalBookNames) ? enabledGlobalBookNames : []);\n    appState.allLorebooks = (Array.isArray(allBookFileNames) ? allBookFileNames : []).map(name => ({\n      name: name,\n      enabled: enabledGlobalBooks.has(name),\n      entryCount: 0,\n      enabledEntryCount: 0,\n      entriesLoaded: false,\n    }));\n\n    const charBookSet = new Set();\n    if (charLinkedBooks && typeof charLinkedBooks === 'object') {\n      if (charLinkedBooks.primary && typeof charLinkedBooks.primary === 'string') {\n        charBookSet.add(charLinkedBooks.primary);\n      }\n      if (Array.isArray(charLinkedBooks.additional)) {\n        charLinkedBooks.additional.forEach(name => typeof name === 'string' && charBookSet.add(name));\n      }\n    }\n    appState.lorebooks.character = Array.from(charBookSet);\n    appState.chatLorebook = typeof chatLorebook === 'string' ? chatLorebook : null;\n    if (typeof chatLorebook === 'string') {\n      knownBookNames.add(chatLorebook);\n    }\n\n    advanceProgress('\u6784\u5EFA\u7D22\u5F15...', '\u4E16\u754C\u4E66\u5217\u8868\u5DF2\u52A0\u8F7D');\n\n    \n\n    appState.isDataLoaded = true;\n    advanceProgress('\u6E32\u67D3\u754C\u9762...', '\u6570\u636E\u52A0\u8F7D\u5B8C\u6210');\n    renderContent();\n\n    prefetchGlobalBookSummaries();\n  } catch (error) {\n    console.error('[RegexLoreHub] Error in loadAllData:', error);\n    // \u53D1\u751F\u4E25\u91CD\u9519\u8BEF\u65F6\uFF0C\u663E\u793A\u53CB\u597D\u7684\u9519\u8BEF\u4FE1\u606F\n    $content.html(`\n                <div class=\"rlh-error-wrapper\">\n                    <p class=\"rlh-error-title\">\n                        <i class=\"fa-solid fa-exclamation-triangle\"></i> \u6570\u636E\u52A0\u8F7D\u5931\u8D25\n                    </p>\n                    <p class=\"rlh-error-text\">\n                        \u8BF7\u68C0\u67E5\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\uFF0C\u6216\u5C1D\u8BD5\u5237\u65B0\u9875\u9762\u3002\n                    </p>\n                    <button class=\"rlh-modal-btn rlh-error-retry-btn\" onclick=\"$('#${REFRESH_BTN_ID}').click()\">\n                        <i class=\"fa-solid fa-refresh\"></i> \u91CD\u8BD5\n                    </button>\n                </div>\n            `);\n    throw error; // \u8BA9errorCatched\u6355\u83B7\u5E76\u663E\u793A\u901A\u7528\u9519\u8BEF\u6D88\u606F\n  }\n};\n\nexport const loadAllData = errorCatched(async (force = false) => {\n  if (force) {\n    appState.isDataLoaded = false;\n  } else if (appState.isDataLoaded) {\n    return;\n  }\n\n  if (loadAllDataPromise) {\n    await loadAllDataPromise;\n    if (!force) {\n      return;\n    }\n  }\n\n  loadAllDataPromise = performLoadAllData();\n  try {\n    await loadAllDataPromise;\n  } finally {\n    loadAllDataPromise = null;\n  }\n});\n\n\n\nlet isPrefetchingGlobalSummaries = false;\nconst PREFETCH_MAX_CONCURRENCY = 3;\n\n// \u7B80\u5355\u7684\u5EF6\u8FDF\u5DE5\u5177\uFF0C\u7528\u4E8E\u5728\u5927\u91CF\u8BF7\u6C42\u95F4\u7559\u51FA\u547C\u5438\u7A7A\u95F4\nconst sleep = ms => new Promise(resolve => setTimeout(resolve, ms));\n\n// \u83B7\u53D6\u9876\u90E8\u9884\u52A0\u8F7D\u8FDB\u5EA6\u6761\u76F8\u5173\u7684 DOM \u5143\u7D20\nconst getPrefetchElements = () => {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  if (!$ || !parentDoc) return {};\n  const $indicator = $(`#${PREFETCH_INDICATOR_ID}`, parentDoc);\n  if (!$indicator.length) return {};\n  const $text = $indicator.find(`#${PREFETCH_PROGRESS_TEXT_ID}`);\n  const $bar = $indicator.find(`#${PREFETCH_PROGRESS_BAR_ID}`);\n  const $barContainer = $indicator.find('.rlh-prefetch-bar');\n  return { $indicator, $text, $bar, $barContainer };\n};\n\nconst setPrefetchIndicatorVisibility = visible => {\n  const { $indicator, $bar, $barContainer } = getPrefetchElements();\n  if (!$indicator) return;\n  $indicator.attr('data-visible', visible ? 'true' : 'false');\n  $indicator.attr('aria-hidden', visible ? 'false' : 'true');\n  if (!visible) {\n    if ($bar?.length) $bar.css('width', '0%');\n    if ($barContainer?.length) $barContainer.attr('aria-valuenow', 0);\n  }\n};\n\nconst updatePrefetchIndicatorContent = (current, total) => {\n  const { $indicator, $text, $bar, $barContainer } = getPrefetchElements();\n  if (!$indicator) return;\n  const safeTotal = total > 0 ? total : 1;\n  const clamped = Math.min(current, total);\n  const percent = Math.round((clamped / safeTotal) * 100);\n  const message = `\u540E\u53F0\u52A0\u8F7D\u4E16\u754C\u4E66 (${clamped}/${total})\uFF0C\u4E0D\u5F71\u54CD\u5176\u4ED6\u64CD\u4F5C`;\n  if ($text?.length) $text.text(message);\n  if ($bar?.length) $bar.css('width', `${Math.min(percent, 100)}%`);\n  if ($barContainer?.length) $barContainer.attr('aria-valuenow', Math.min(percent, 100));\n};\n\nconst hidePrefetchIndicator = () => {\n  setPrefetchIndicatorVisibility(false);\n};\n\n// \u6839\u636E\u52A0\u8F7D\u7ED3\u679C\u5373\u65F6\u5237\u65B0\u5217\u8868\u4E2D\u7684\u6761\u76EE\u7EDF\u8BA1\nconst updateGlobalBookStatsDisplay = bookName => {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  if (!$ || !parentDoc) return;\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\n  if (!$panel.length) return;\n  const $group = $panel.find('.rlh-book-group').filter((_, el) => $(el).data('book-name') === bookName);\n  if (!$group.length) return;\n  const book = appState.allLorebooks.find(b => b.name === bookName);\n  if (!book) return;\n  $group.find('.rlh-book-stats').text(`\u6761\u76EE: ${book.enabledEntryCount} / ${book.entryCount}`);\n};\n\nconst showPrefetchIndicator = total => {\n  if (total <= 0) {\n    hidePrefetchIndicator();\n    return;\n  }\n  setPrefetchIndicatorVisibility(true);\n  updatePrefetchIndicatorContent(0, total);\n};\n\n// \u540E\u53F0\u9010\u672C\u52A0\u8F7D\u5168\u5C40\u4E16\u754C\u4E66\u6761\u76EE\uFF0C\u4EE5\u586B\u5145\u7EDF\u8BA1\u6570\u636E\uFF0C\u4E0D\u963B\u585E\u4E3B\u754C\u9762\nexport const prefetchGlobalBookSummaries = errorCatched(async () => {\n  if (isPrefetchingGlobalSummaries) return;\n  const booksToPrefetch = appState.allLorebooks.filter(book => !book.entriesLoaded);\n  if (booksToPrefetch.length === 0) {\n    hidePrefetchIndicator();\n    return;\n  }\n\n  isPrefetchingGlobalSummaries = true;\n  showPrefetchIndicator(booksToPrefetch.length);\n\n  try {\n    let completed = 0;\n    const queue = [...booksToPrefetch];\n\n    const worker = async () => {\n      while (queue.length > 0) {\n        const book = queue.shift();\n        if (!book) break;\n\n        try {\n          await loadLorebookEntriesIfNeeded(book.name);\n          updateGlobalBookStatsDisplay(book.name);\n        } finally {\n          completed += 1;\n          updatePrefetchIndicatorContent(completed, booksToPrefetch.length);\n        }\n\n        await sleep(30);\n      }\n    };\n\n    // \u4F7F\u7528\u6709\u9650\u5E76\u53D1\uFF0C\u907F\u514D\u4E00\u6B21\u6027\u89E6\u53D1\u8FC7\u591A API \u8BF7\u6C42\n    const workerCount = Math.min(PREFETCH_MAX_CONCURRENCY, queue.length);\n    await Promise.all(Array.from({ length: workerCount }, () => worker()));\n  } finally {\n    await sleep(260);\n    hidePrefetchIndicator();\n    isPrefetchingGlobalSummaries = false;\n  }\n});\n\nexport const resolveUnboundGlobalLorebooks = () => {\n  const books = Array.isArray(appState.allLorebooks) ? appState.allLorebooks : [];\n  const statsByName = new Map();\n  const unboundNames = new Set();\n  let totalUsableBooks = 0;\n\n  books.forEach(rawBook => {\n    const stats = resolveLorebookBindingStats(rawBook);\n    if (!stats.name) return;\n    totalUsableBooks += 1;\n    statsByName.set(stats.name, stats);\n    if (stats.bindingCount === 0) {\n      unboundNames.add(stats.name);\n    }\n  });\n\n  return {\n    totalBooks: totalUsableBooks,\n    unboundNames,\n    statsByName,\n  };\n};\n\nexport const refreshCharacterData = errorCatched(async () => {\n  // \u68C0\u67E5\u662F\u5426\u6709\u6D3B\u8DC3\u7684\u804A\u5929\n  const parentWin = getParentWin();\n  const context = parentWin.SillyTavern?.getContext?.() || {};\n  const hasActiveChat = context.chatId !== undefined && context.chatId !== null;\n\n  const promises = [TavernAPI.getCharData(), TavernAPI.getCurrentCharWorldbookNames(), TavernAPI.getRegexes()];\n\n  // \u53EA\u6709\u5728\u6709\u6D3B\u8DC3\u804A\u5929\u65F6\u624D\u83B7\u53D6\u804A\u5929\u4E16\u754C\u4E66\n  if (hasActiveChat) {\n    promises.push(\n      TavernAPI.getChatWorldbookName().catch(error => {\n        console.warn('[RegexLoreHub] Failed to get chat worldbook in refreshCharacterData:', error);\n        return null;\n      }),\n    );\n  } else {\n    promises.push(Promise.resolve(null));\n  }\n\n  const [charData, charBooks, allUIRegexes, chatWorldbook] = await Promise.all(promises);\n\n  updateCharacterRegexes(allUIRegexes, charData);\n  syncContextWithAppState({ charData }); // \u5237\u65B0\u65F6\u8865\u9F50\u89D2\u8272\u540D\u79F0\n  updateCharacterLorebooks(charBooks);\n  appState.chatLorebook = chatWorldbook;\n  const newBooksToLoad = appState.lorebooks.character.filter(name => !safeHasLorebookEntries(name));\n  if (newBooksToLoad.length > 0) {\n    await Promise.all(\n      newBooksToLoad.map(async name => {\n        const entries = await TavernAPI.getWorldbook(name); // \u4F7F\u7528\u65B0\u7684API\n        safeSetLorebookEntries(name, entries.map(normalizeWorldbookEntry));\n      }),\n    );\n  }\n});\n\nexport function updateCharacterRegexes(allUIRegexes, charData) {\n  const characterUIRegexes = allUIRegexes?.filter(r => r.scope === 'character') || [];\n  let cardRegexes = [];\n  if (charData && TavernAPI.Character) {\n    try {\n      const character = new TavernAPI.Character(charData);\n      cardRegexes = (character.getRegexScripts() || []).map((r, i) => ({\n        id: r.id || `card-${Date.now()}-${i}`,\n        script_name: r.scriptName || '\u672A\u547D\u540D\u5361\u5185\u6B63\u5219',\n        find_regex: r.findRegex,\n        replace_string: r.replaceString,\n        enabled: !r.disabled,\n        scope: 'character',\n        source: 'card',\n      }));\n    } catch (e) {\n      console.warn('\u65E0\u6CD5\u89E3\u6790\u89D2\u8272\u5361\u6B63\u5219\u811A\u672C:', e);\n    }\n  }\n  const uiRegexIdentifiers = new Set(\n    characterUIRegexes.map(r => `${r.script_name}::${r.find_regex}::${r.replace_string}`),\n  );\n  const uniqueCardRegexes = cardRegexes.filter(r => {\n    const identifier = `${r.script_name}::${r.find_regex}::${r.replace_string}`;\n    return !uiRegexIdentifiers.has(identifier);\n  });\n  appState.regexes.character = [...characterUIRegexes, ...uniqueCardRegexes];\n  updateRegexOrderMetadata(appState.regexes.character);\n}\n\nexport function updateCharacterLorebooks(charBooks) {\n  let characterBookNames = [];\n  if (charBooks) {\n    if (charBooks.primary) characterBookNames.push(charBooks.primary);\n    if (charBooks.additional) characterBookNames.push(...charBooks.additional);\n  }\n  appState.lorebooks.character = [...new Set(characterBookNames)];\n}\n\n/**\n * \u8BA1\u7B97\u5E76\u66F4\u65B0\u6307\u5B9A\u4E16\u754C\u4E66\u7684\u6761\u76EE\u603B\u6570\u548C\u542F\u7528\u6761\u76EE\u6570\u3002\n * @param {string} bookName - \u8981\u66F4\u65B0\u7684\u4E16\u754C\u4E66\u7684\u540D\u79F0\u3002\n */\nexport const updateBookSummary = bookName => {\n  const entries = safeGetLorebookEntries(bookName);\n  const book = appState.allLorebooks.find(b => b.name === bookName);\n  if (book) {\n    book.entryCount = entries.length;\n    book.enabledEntryCount = entries.filter(entry => entry.enabled).length;\n  }\n};\n\n/**\n * \u5728\u5185\u5B58\u4E2D\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684 Lorebook entry \u5BF9\u8C61\uFF0C\u5E76\u5C06\u5176\u6DFB\u52A0\u5230 appState \u7684\u6761\u76EE\u5217\u8868\u9876\u90E8\u3002\n * @param {string} bookName - \u6240\u5C5E\u4E16\u754C\u4E66\u7684\u540D\u79F0\u3002\n * @returns {object} \u65B0\u521B\u5EFA\u7684\u4E34\u65F6 entry \u5BF9\u8C61\u3002\n */\nexport const createInMemoryEntry = bookName => {\n  const newEntry = {\n    uid: `temp-${Date.now()}`, // \u4E34\u65F6\u552F\u4E00ID\n    name: '\u65B0\u6761\u76EE',\n    comment: '',\n    content: '',\n    keys: [],\n    key: [],\n    keysecondary: [],\n    statusId: DEFAULT_STATUS_ID,\n    enabled: true,\n    disable: false,\n    is_temp: true, // \u6807\u8BB0\u4E3A\u4E34\u65F6\u6761\u76EE\n    // \u6839\u636E WorldbookEntry \u7C7B\u578B\u5B9A\u4E49\u6DFB\u52A0\u5176\u4ED6\u9ED8\u8BA4\u5B57\u6BB5\n    selective: true,\n    selectiveLogic: LOGIC_STRING_TO_ENUM.and_any,\n    logic: 'and_any',\n    constant: false,\n    position: 'before_character_definition',\n    depth: null,\n    order: 0,\n    probability: 100,\n    useProbability: false,\n    case_sensitive: false,\n    match_whole_words: false,\n    prevent_recursion: false,\n    exclude_recursion: false,\n    type: DEFAULT_WORLD_BOOK_STATUS?.strategyType ?? 'constant',\n    strategy: {\n      type: DEFAULT_WORLD_BOOK_STATUS?.strategyType ?? 'constant',\n      keys: [],\n      keys_secondary: { logic: 'and_any', keys: [] },\n      scan_depth: 'same_as_global',\n    },\n  };\n\n  const entries = safeGetLorebookEntries(bookName);\n  entries.unshift(newEntry);\n  safeSetLorebookEntries(bookName, entries);\n\n  return newEntry;\n};\n\n/**\n * \u4F7F\u7528\u4ECE\u670D\u52A1\u5668\u83B7\u53D6\u7684\u771F\u5B9E\u6570\u636E\u66F4\u65B0\u5185\u5B58\u4E2D\u7684\u4E34\u65F6 entry\u3002\n * @param {string} bookName - \u6240\u5C5E\u4E16\u754C\u4E66\u7684\u540D\u79F0\u3002\n * @param {string} tempId - \u8981\u66F4\u65B0\u7684\u6761\u76EE\u7684\u4E34\u65F6ID\u3002\n * @param {object} serverData - \u4ECE\u670D\u52A1\u5668\u8FD4\u56DE\u7684\u771F\u5B9E entry \u6570\u636E\u3002\n */\nexport const updateInMemoryEntry = (bookName, tempId, serverData) => {\n  const entries = safeGetLorebookEntries(bookName);\n  const entryIndex = entries.findIndex(e => e.uid === tempId);\n\n  if (entryIndex !== -1) {\n    // \u5408\u5E76\u670D\u52A1\u5668\u6570\u636E\uFF0C\u540C\u65F6\u79FB\u9664\u4E34\u65F6\u6807\u8BB0\n    const normalizedServerData = normalizeWorldbookEntry(serverData);\n    const updatedEntry = { ...entries[entryIndex], ...normalizedServerData, is_temp: false };\n    entries[entryIndex] = updatedEntry;\n    safeSetLorebookEntries(bookName, entries);\n    migratePendingLorebookUpdate(bookName, tempId, updatedEntry.uid);\n  } else {\n    console.warn(`[RegexLoreHub] \u5728\u66F4\u65B0\u65F6\u627E\u4E0D\u5230\u4E34\u65F6\u6761\u76EE: ${tempId}`);\n  }\n};\n/**\n * \u6309\u9700\u52A0\u8F7D\u6307\u5B9A\u4E16\u754C\u4E66\u7684\u6761\u76EE\uFF0C\u5982\u679C\u5C1A\u672A\u52A0\u8F7D\u6216\u9700\u8981\u5F3A\u5236\u5237\u65B0\u3002\n * @param {string} bookName - \u8981\u52A0\u8F7D\u6761\u76EE\u7684\u4E16\u754C\u4E66\u540D\u79F0\u3002\n * @param {boolean} [force=false] - \u662F\u5426\u5F3A\u5236\u91CD\u65B0\u52A0\u8F7D\uFF0C\u5373\u4F7F\u7528\u6237\u6570\u636E\u5DF2\u5B58\u5728\u3002\n */\nexport const loadLorebookEntriesIfNeeded = errorCatched(async (bookName, force = false) => {\n  const book = appState.allLorebooks.find(b => b.name === bookName);\n\n  // \u4F7F\u7528 safeHasLorebookEntries \u68C0\u67E5\u771F\u5B9E\u6570\u636E\u662F\u5426\u5B58\u5728\uFF0C\u800C\u4E0D\u662F\u4F9D\u8D56\u53EF\u80FD\u88AB\u9884\u53D6\u884C\u4E3A\u6C61\u67D3\u7684 entriesLoaded \u6807\u5FD7\n  if (!book || (safeHasLorebookEntries(bookName) && !force)) {\n    return;\n  }\n\n  try {\n    let entries = await TavernAPI.getWorldbook(bookName);\n\n    // \u7EDF\u4E00\u5F52\u4E00\u5316\u5B57\u6BB5\uFF0C\u517C\u5BB9\u65B0\u65E7\u4E16\u754C\u4E66\u7ED3\u6784\n    entries = entries.map(normalizeWorldbookEntry);\n\n    safeSetLorebookEntries(bookName, entries);\n    book.entriesLoaded = true;\n    updateBookSummary(bookName);\n  } catch (error) {\n    console.error(`[RegexLoreHub] Failed to load entries for worldbook \"${bookName}\":`, error);\n    // \u5373\u4F7F\u5931\u8D25\uFF0C\u4E5F\u6807\u8BB0\u4E3A\u5DF2\u52A0\u8F7D\uFF0C\u4EE5\u907F\u514D\u91CD\u590D\u5C1D\u8BD5\uFF0C\u9664\u975E\u7528\u6237\u624B\u52A8\u5237\u65B0\n    book.entriesLoaded = true;\n    // \u53EF\u4EE5\u9009\u62E9\u5728\u8FD9\u91CC\u8BBE\u7F6E\u4E00\u4E2A\u9519\u8BEF\u72B6\u6001\n  }\n});\n\n/**\n * \u7EDF\u4E00\u7684\u4FDD\u5B58\u51FD\u6570\uFF0C\u8D1F\u8D23\u5C06\u6240\u6709\u5F85\u529E\u7684\u4FEE\u6539\uFF08\u5982\u4E16\u754C\u4E66\u6761\u76EE\u3001\u6B63\u5219\u7B49\uFF09\u4E00\u6B21\u6027\u63D0\u4EA4\u3002\n * \u5185\u7F6E\u4E86UI\u72B6\u6001\u66F4\u65B0\u548C\u81EA\u52A8\u91CD\u8BD5\u903B\u8F91\u3002\n */\nexport const saveAllChanges = errorCatched(async (options = {}) => {\n  const { silent = false } = options;\n  const MAX_RETRIES = 3;\n  const RETRY_DELAY = 3000; // 3\u79D2\n\n  let attempts = 0;\n\n  const delay = ms => new Promise(resolve => setTimeout(resolve, ms));\n\n  const triggerUIUpdate = () => {\n    if (silent) renderSaveStatus();\n    else renderContent();\n  };\n\n  const flushLorebookUpdates = async () => {\n    if (!(appState.pendingLorebookUpdates instanceof Map)) {\n      appState.pendingLorebookUpdates = new Map();\n      return false;\n    }\n\n    let didSave = false;\n\n    for (const [bookName, updatesMap] of [...appState.pendingLorebookUpdates.entries()]) {\n      if (!(updatesMap instanceof Map) || updatesMap.size === 0) continue;\n\n      const payload = [];\n      const processedKeys = [];\n\n      for (const [key, record] of updatesMap.entries()) {\n        const uid = record?.uid;\n        if (typeof uid !== 'number' || Number.isNaN(uid)) continue;\n\n        const data = record?.data;\n        if (!data || Object.keys(data).length === 0) {\n          processedKeys.push(key);\n          continue;\n        }\n\n        payload.push({ uid, ...data });\n        processedKeys.push(key);\n      }\n\n      if (payload.length === 0) {\n        processedKeys.forEach(k => updatesMap.delete(k));\n        if (updatesMap.size === 0) {\n          appState.pendingLorebookUpdates.delete(bookName);\n        }\n        continue;\n      }\n\n      const result = await updateWorldbookEntries(bookName, payload);\n      if (result) {\n        didSave = true;\n        processedKeys.forEach(k => updatesMap.delete(k));\n        if (updatesMap.size === 0) {\n          appState.pendingLorebookUpdates.delete(bookName);\n        }\n      }\n    }\n\n    return didSave;\n  };\n\n  const flushRegexUpdates = async () => {\n    if (!(appState.pendingRegexUpdates instanceof Set)) {\n      appState.pendingRegexUpdates = new Set();\n      return false;\n    }\n    if (appState.pendingRegexUpdates.size === 0) {\n      return false;\n    }\n\n    updateRegexOrderMetadata(appState.regexes.global);\n    updateRegexOrderMetadata(appState.regexes.character);\n    const allRegexes = [...appState.regexes.global, ...appState.regexes.character];\n    await TavernAPI.replaceRegexes(allRegexes.filter(r => r.source !== 'card'));\n    await TavernAPI.saveSettings();\n    appState.pendingRegexUpdates.clear();\n    return true;\n  };\n\n  const performSave = async () => {\n    console.log('[RegexLoreHub] \u6267\u884C\u7EDF\u4E00\u4FDD\u5B58\u64CD\u4F5C...');\n    const loreSaved = await flushLorebookUpdates();\n    const regexSaved = await flushRegexUpdates();\n    if (!loreSaved && !regexSaved) {\n      console.log('[RegexLoreHub] \u6CA1\u6709\u5F85\u4FDD\u5B58\u7684\u66F4\u6539\u3002');\n    } else {\n      console.log('[RegexLoreHub] \u4FDD\u5B58\u64CD\u4F5C\u5B8C\u6210\u3002');\n    }\n    return true;\n  };\n\n  while (attempts < MAX_RETRIES) {\n    try {\n      appState.saveRetryAttempt = attempts + 1;\n      appState.saveStatus = attempts === 0 ? 'saving' : 'retrying';\n      triggerUIUpdate();\n\n      await performSave();\n\n      appState.saveStatus = 'success';\n      appState.saveRetryAttempt = 0;\n      triggerUIUpdate();\n\n      await delay(1500);\n      appState.saveStatus = 'idle';\n      triggerUIUpdate();\n\n      console.log('[RegexLoreHub] \u6240\u6709\u66F4\u6539\u5DF2\u6210\u529F\u4FDD\u5B58\u3002');\n      return;\n    } catch (error) {\n      attempts++;\n      console.error(`[RegexLoreHub] \u4FDD\u5B58\u5931\u8D25\uFF0C\u5C1D\u8BD5\u6B21\u6570 ${attempts}/${MAX_RETRIES}:`, error);\n\n      if (attempts >= MAX_RETRIES) {\n        appState.saveStatus = 'failed';\n        triggerUIUpdate();\n        console.error('[RegexLoreHub] \u6240\u6709\u91CD\u8BD5\u5747\u5931\u8D25\uFF0C\u5DF2\u505C\u6B62\u4FDD\u5B58\u3002');\n        throw new Error('\u81EA\u52A8\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u8FDE\u63A5\u6216\u624B\u52A8\u4FDD\u5B58\u3002');\n      }\n\n      await delay(RETRY_DELAY);\n    }\n  }\n});\n\n/**\n * \u540C\u6B65 SillyTavern \u7684\u4E0A\u4E0B\u6587\u4FE1\u606F\u5230 appState\u3002\n * \u8FD9\u662F\u786E\u4FDDUI\u5C42\u603B\u80FD\u83B7\u53D6\u5230\u6700\u65B0\u3001\u6700\u53EF\u9760\u89D2\u8272\u4FE1\u606F\u7684\u5173\u952E\u3002\n */\nconst normalizeCharacterName = value => {\n  if (typeof value !== 'string') return null;\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : null;\n};\n\nconst extractNameFromCharacter = character => {\n  if (!character || typeof character !== 'object') return null;\n  return (\n    normalizeCharacterName(character.name) ||\n    normalizeCharacterName(character.display_name) ||\n    normalizeCharacterName(character.title) ||\n    normalizeCharacterName(character.metadata?.name) ||\n    normalizeCharacterName(character.filename) ||\n    normalizeCharacterName(character.external_id)\n  );\n};\n\nconst extractNameFromCharData = data => {\n  if (!data || typeof data !== 'object') return null;\n  return (\n    normalizeCharacterName(data.name) ||\n    normalizeCharacterName(data.char_name) ||\n    normalizeCharacterName(data.display_name) ||\n    normalizeCharacterName(data.metadata?.name) ||\n    normalizeCharacterName(data.data?.name) ||\n    normalizeCharacterName(data.data?.char_name) ||\n    normalizeCharacterName(data.data?.display_name)\n  );\n};\n\nconst matchCharacterById = (character, targetId) => {\n  if (!character || targetId === undefined || targetId === null) return false;\n  const normalizedTarget = String(targetId);\n  const candidateIds = [\n    character.id,\n    character.characterId,\n    character.metadata?.characterId,\n    character.metadata?.id,\n    character.external_id,\n    character.filename,\n  ].map(value => (value === undefined || value === null ? null : String(value)));\n  return candidateIds.some(id => id && id === normalizedTarget);\n};\n\nexport const syncContextWithAppState = ({ charData = null } = {}) => {\n  const parentWin = getParentWin();\n  const context = parentWin.SillyTavern?.getContext?.() || {};\n  const characters = Array.isArray(context.characters) ? context.characters : [];\n  const characterId =\n    context.characterId !== undefined && context.characterId !== null ? context.characterId : null;\n\n  // \u4F18\u5148\u4F7F\u7528\u4E0A\u4E0B\u6587\u63D0\u4F9B\u7684\u89D2\u8272\u540D\n  let characterName =\n    normalizeCharacterName(context.name) ||\n    extractNameFromCharacter(context.character);\n\n  // \u6839\u636E\u89D2\u8272ID\u5728\u89D2\u8272\u5217\u8868\u4E2D\u67E5\u627E\u540D\u79F0\n  if (!characterName && characterId !== null) {\n    const matchedCharacter = characters.find(char => matchCharacterById(char, characterId));\n    if (matchedCharacter) {\n      characterName = extractNameFromCharacter(matchedCharacter);\n    }\n  }\n\n  // \u5982\u679C\u5DF2\u7ECF\u62FF\u5230\u89D2\u8272\u6570\u636E\uFF0C\u5C1D\u8BD5\u4ECE\u89D2\u8272\u6570\u636E\u4E2D\u63D0\u53D6\u540D\u79F0\n  if (!characterName && charData) {\n    characterName = extractNameFromCharData(charData);\n  }\n\n  // \u515C\u5E95\uFF1A\u4EC5\u6709\u4E00\u4E2A\u89D2\u8272\u65F6\u76F4\u63A5\u4F7F\u7528\u5176\u540D\u79F0\n  if (!characterName && characters.length === 1) {\n    characterName = extractNameFromCharacter(characters[0]);\n  }\n\n  appState.characterContext.name = characterName ?? null;\n  appState.characterContext.id = characterId;\n  console.log('[RegexLoreHub] Context synced with appState:', appState.characterContext);\n};\n", "import {\n  appState,\n  safeGetLorebookEntries,\n  safeDeleteLorebookEntries,\n  errorCatched,\n  showModal,\n  showToast,\n  showProgressToast,\n  get$,\n  getParentDoc,\n  getParentWin,\n  escapeHtml,\n  decodeSelectionPart,\n  buildLoreSelectionPrefix,\n  POSITION_MENU_ID,\n  POSITION_MENU_BUTTON_ID,\n  LOREBOOK_OPTIONS,\n} from '../../core.js';\n\nimport {\n  TavernAPI,\n  loadAllData,\n  loadLorebookEntriesIfNeeded,\n  updateBookSummary,\n  updateWorldbookEntries, // \u5BFC\u5165\u65B0\u7684\u66F4\u65B0\u51FD\u6570\n} from '../../dataLayer.js';\n\nimport { renderContent, getViewContext } from '../render/index.js';\n\n// --- \u4E16\u754C\u4E66\u4E8B\u4EF6\u5904\u7406 ---\nexport function createLorebookHandlers(deps = {}) {\n  const $ = deps.$ ?? get$();\n  const parentDoc = deps.parentDoc ?? getParentDoc();\n  const parentWin = deps.parentWin ?? getParentWin();\n  const refreshLorebookData = async (bookName, { showLoading = true } = {}) => {\n    const targetName = (bookName ?? '').toString().trim();\n    if (!targetName) return;\n    const previousLoading = appState.loadingBookName;\n    try {\n      if (showLoading) {\n        appState.loadingBookName = targetName;\n        renderContent();\n      }\n      await loadLorebookEntriesIfNeeded(targetName, true);\n    } finally {\n      appState.loadingBookName = previousLoading && previousLoading !== targetName ? previousLoading : null;\n      renderContent();\n    }\n  };\n\n  const handleEnterLorebookDetail = errorCatched(async (bookName) => {\n    appState.activeView = 'global-lore-detail';\n    appState.activeBookName = bookName;\n\n    // \u5F3A\u5236\u663E\u793A\u52A0\u8F7D\u72B6\u6001\uFF0C\u907F\u514D\u7ADE\u6001\u6761\u4EF6\n    appState.loadingBookName = bookName;\n    renderContent(); // \u7ACB\u5373\u6E32\u67D3\u4EE5\u663E\u793A\u52A0\u8F7D\u72B6\u6001\n\n    await loadLorebookEntriesIfNeeded(bookName);\n\n    appState.loadingBookName = null;\n    renderContent(); // \u518D\u6B21\u6E32\u67D3\u4EE5\u663E\u793A\u52A0\u8F7D\u540E\u7684\u5185\u5BB9\n  });\n\n\n  const handleExitLorebookDetail = errorCatched(async () => {\n    appState.activeView = 'global-lore-list';\n    appState.activeBookName = null;\n\n    // \u91CD\u7F6E\u72B6\u6001\n    appState.selectedItems.clear();\n    appState.globalSearch = { term: '', replace: '' };\n\n    // \u6E05\u7A7AUI\u8F93\u5165\n    const $searchInput = $(`#${'rlh-global-search-input'}`, parentDoc);\n    if ($searchInput.length) {\n      $searchInput.val('');\n    }\n\n    renderContent();\n  });\n\n\n  const updateLinkedCharacters = async (oldBookName, newBookName, progressToast, attemptInfo = {}) => {\n    const linkedChars = appState.lorebookUsage.get(oldBookName) || [];\n    if (linkedChars.length === 0) return;\n\n    const context = parentWin.SillyTavern.getContext();\n    const originalCharId = context.characterId;\n    let processedCount = 0;\n    const totalCount = linkedChars.length;\n    const { currentAttempt = 1, totalAttempts = 1 } = attemptInfo;\n    progressToast?.update?.(\n      `\u6B63\u5728\u66F4\u65B0 ${totalCount} \u4E2A\u5173\u8054\u89D2\u8272... (${processedCount}/${totalCount})\uFF08\u5C1D\u8BD5 ${currentAttempt}/${totalAttempts}\uFF09`,\n    );\n\n    const failedCharacters = [];\n\n    try {\n      for (const charName of linkedChars) {\n        try {\n          const charIndex =\n            parentWin.Character?.findCharacterIndex?.(charName) ??\n            context.characters.findIndex(c => c.name === charName);\n          if (charIndex === -1) {\n            console.warn(`[RegexLoreHub] Character \"${charName}\" not found, skipping...`);\n            continue;\n          }\n\n          console.log(`[RegexLoreHub] Switching to character \"${charName}\" (index: ${charIndex})`);\n          await context.selectCharacterById(charIndex);\n\n          const charBooks = await TavernAPI.getCharWorldbookNames({ name: charName });\n          if (!charBooks) {\n            console.warn(`[RegexLoreHub] Failed to get worldbooks for character \"${charName}\"`);\n            failedCharacters.push({ name: charName, error: new Error('\u65E0\u6CD5\u83B7\u53D6\u4E16\u754C\u4E66\u5217\u8868') });\n            continue;\n          }\n\n          console.log(`[RegexLoreHub] Current worldbooks for \"${charName}\":`, charBooks);\n          let updated = false;\n          if (charBooks.primary === oldBookName) {\n            console.log(`[RegexLoreHub] Updating primary lorebook from \"${oldBookName}\" to \"${newBookName}\"`);\n            charBooks.primary = newBookName;\n            updated = true;\n          }\n          if (Array.isArray(charBooks.additional)) {\n            const index = charBooks.additional.indexOf(oldBookName);\n            if (index > -1) {\n              console.log(\n                `[RegexLoreHub] Updating additional lorebook at index ${index} from \"${oldBookName}\" to \"${newBookName}\"`,\n              );\n              charBooks.additional[index] = newBookName;\n              updated = true;\n            }\n          }\n\n          if (updated) {\n            console.log(`[RegexLoreHub] Saving updated lorebooks for \"${charName}\":`, charBooks);\n            await TavernAPI.rebindCharWorldbooks(charBooks);\n            console.log(`[RegexLoreHub] Successfully updated lorebooks for \"${charName}\"`);\n          } else {\n            console.log(`[RegexLoreHub] No updates needed for character \"${charName}\"`);\n          }\n        } catch (charError) {\n          console.error(`[RegexLoreHub] Failed to update lorebook for character \"${charName}\":`, charError);\n          failedCharacters.push({ name: charName, error: charError });\n        }\n        processedCount++;\n        progressToast?.update?.(\n          `\u6B63\u5728\u66F4\u65B0 ${totalCount} \u4E2A\u5173\u8054\u89D2\u8272... (${processedCount}/${totalCount})\uFF08\u5C1D\u8BD5 ${currentAttempt}/${totalAttempts}\uFF09`,\n        );\n      }\n    } finally {\n      if (context.characterId !== originalCharId) {\n        await context.selectCharacterById(originalCharId);\n      }\n    }\n\n    if (failedCharacters.length > 0) {\n      const names = failedCharacters.map(item => item.name).join(', ');\n      const aggregatedError = new Error(`\u4EE5\u4E0B\u89D2\u8272\u7684\u4E16\u754C\u4E66\u7ED1\u5B9A\u672A\u6210\u529F\u66F4\u65B0\uFF1A${names}`);\n      aggregatedError.details = failedCharacters;\n      throw aggregatedError;\n    }\n  };\n\n\n\n  const handleRenameBook = errorCatched(async event => {\n    event.stopPropagation();\n    const $trigger = $(event.currentTarget);\n    const $bookSource = $trigger.closest('.rlh-book-group, .rlh-detail-view');\n    const isDetailView = $bookSource.hasClass('rlh-detail-view');\n    const oldName = $bookSource.data('book-name') || appState.activeBookName;\n    if (!oldName) return;\n\n    let newName;\n    try {\n      newName = await showModal({\n        type: 'prompt',\n        title: '\u91CD\u547D\u540D\u4E16\u754C\u4E66',\n        text: '\u8BF7\u8F93\u5165\u65B0\u7684\u4E16\u754C\u4E66\u540D\u79F0\uFF1A',\n        value: oldName,\n      });\n    } catch {\n      return;\n    }\n\n    newName = newName.trim();\n    if (!newName || newName === oldName) {\n      return;\n    }\n\n    if (appState.allLorebooks.some(b => b.name === newName)) {\n      await showModal({ type: 'alert', title: '\u91CD\u547D\u540D\u5931\u8D25', text: '\u8BE5\u540D\u79F0\u7684\u4E16\u754C\u4E66\u5DF2\u5B58\u5728\uFF0C\u8BF7\u9009\u62E9\u5176\u4ED6\u540D\u79F0\u3002' });\n      return;\n    }\n\n    const linkedCharacters = appState.lorebookUsage.get(oldName) || [];\n    const isChatLinked = appState.chatLorebook === oldName;\n    const chatCount = isChatLinked ? 1 : 0;\n    const totalBindings = linkedCharacters.length + chatCount;\n\n    console.log(\n      `[RegexLoreHub] Renaming lorebook \"${oldName}\" to \"${newName}\", linked characters:`,\n      linkedCharacters,\n      'chat linked:',\n      isChatLinked,\n    );\n\n    let confirmText = `\u6B64\u64CD\u4F5C\u5C06\u66F4\u65B0 ${totalBindings} \u4E2A\u7ED1\u5B9A\u5173\u7CFB`;\n    if (linkedCharacters.length > 0) {\n      confirmText += `\uFF0C\u9700\u8981\u4E34\u65F6\u5207\u6362\u5230 ${linkedCharacters.length} \u4E2A\u5173\u8054\u89D2\u8272\u5361\u6765\u66F4\u65B0\u4E16\u754C\u4E66\u94FE\u63A5`;\n    }\n    confirmText += `\uFF0C\u671F\u95F4\u8BF7\u52FF\u64CD\u4F5C\u3002\\n\\n`;\n\n    if (linkedCharacters.length > 0) {\n      confirmText += `\u5173\u8054\u89D2\u8272\u5361\uFF1A${linkedCharacters.join(', ')}\\n`;\n    }\n    if (isChatLinked) {\n      confirmText += `\u5173\u8054\u804A\u5929\uFF1A\u5F53\u524D\u804A\u5929\\n`;\n    }\n\n    if (appState.activeTab === 'global-lore') {\n      confirmText += `\\n\u26A0\uFE0F \u91CD\u8981\u63D0\u793A\uFF1A\u7531\u4E8ESillyTavern API\u9650\u5236\uFF0C\u65E0\u6CD5\u76F4\u63A5\u5217\u51FA\u6240\u6709*\u804A\u5929\u4E16\u754C\u4E66*\u7ED1\u5B9A\u3002\u5982\u679C\u6B64\u4E16\u754C\u4E66\u4E0E*\u804A\u5929*\u7ED1\u5B9A\uFF0C\u91CD\u547D\u540D\u540E\u9700\u8981\u624B\u52A8\u68C0\u67E5\u90A3\u4E9B\u804A\u5929\u7ED1\u5B9A\u72B6\u6001\u3002\\n`;\n    }\n\n    confirmText += `\\n\u662F\u5426\u7EE7\u7EED\uFF1F`;\n\n    try {\n      await showModal({\n        type: 'confirm',\n        title: '\u786E\u8BA4\u91CD\u547D\u540D',\n        text: confirmText,\n      });\n    } catch {\n      return;\n    }\n\n    const RETRY_SETTINGS = { maxAttempts: 3, delayMs: 600 };\n    const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));\n    const cleanupTasks = [];\n    const registerCleanupTask = (description, action) => {\n      const task = {\n        id: `cleanup-${cleanupTasks.length + 1}`,\n        description,\n        action,\n        status: 'pending',\n        lastError: null,\n      };\n      cleanupTasks.push(task);\n      return task;\n    };\n    const getStatusText = status => {\n      if (status === 'success') return '\u5DF2\u5B8C\u6210';\n      if (status === 'failed') return '\u5931\u8D25';\n      if (status === 'running') return '\u6267\u884C\u4E2D';\n      return '\u5F85\u6267\u884C';\n    };\n    const runCleanupTasks = async (onlyFailed = false) => {\n      for (const task of cleanupTasks) {\n        if (onlyFailed && task.status === 'success') continue;\n        try {\n          task.status = 'running';\n          await task.action();\n          task.status = 'success';\n          task.lastError = null;\n        } catch (taskError) {\n          task.status = 'failed';\n          task.lastError = taskError;\n        }\n      }\n    };\n    const buildCleanupModalHtml = errorMessage => {\n      const tasksHtml = cleanupTasks.length\n        ? `<ul class=\"rlh-cleanup-task-list\">${cleanupTasks\n            .map(\n              task =>\n                `<li class=\"rlh-cleanup-task\" data-task-id=\"${task.id}\" data-status=\"${task.status}\">\n                  <span class=\"rlh-cleanup-task-title\">${escapeHtml(task.description)}</span>\n                  <span class=\"rlh-cleanup-task-status\">${escapeHtml(getStatusText(task.status))}</span>\n                  ${\n                    task.lastError\n                      ? `<div class=\"rlh-cleanup-task-error\">${escapeHtml(task.lastError.message ?? String(task.lastError))}</div>`\n                      : ''\n                  }\n                </li>`,\n            )\n            .join('')}</ul>`\n        : '<p class=\"rlh-cleanup-empty\">\u6CA1\u6709\u9700\u8981\u6267\u884C\u7684\u6E05\u7406\u4EFB\u52A1\u3002</p>';\n      return `\n        <div class=\"rlh-cleanup-modal\">\n          <p class=\"rlh-cleanup-error\">${escapeHtml(errorMessage)}</p>\n          ${tasksHtml}\n          ${\n            cleanupTasks.length\n              ? '<button type=\"button\" class=\"rlh-modal-btn rlh-cleanup-retry\">\u91CD\u8BD5\u6E05\u7406</button>'\n              : ''\n          }\n          <p class=\"rlh-cleanup-hint\">\u5982\u6E05\u7406\u591A\u6B21\u5931\u8D25\uFF0C\u8BF7\u67E5\u770B\u63A7\u5236\u53F0\u6216\u5728 SillyTavern \u4E2D\u624B\u52A8\u6062\u590D\u3002</p>\n        </div>\n      `;\n    };\n    const presentCleanupModal = async errorMessage => {\n      const modalPromise = showModal({\n        type: 'alert',\n        title: '\u91CD\u547D\u540D\u5931\u8D25',\n        html: buildCleanupModalHtml(errorMessage),\n      });\n      setTimeout(() => {\n        const $overlay = $('.rlh-modal-overlay', parentDoc).last();\n        if ($overlay.length === 0) return;\n        const refreshList = () => {\n          cleanupTasks.forEach(task => {\n            const $item = $overlay.find(`[data-task-id=\"${task.id}\"]`);\n            if ($item.length === 0) return;\n            $item.attr('data-status', task.status);\n            $item.find('.rlh-cleanup-task-status').text(getStatusText(task.status));\n            const $error = $item.find('.rlh-cleanup-task-error');\n            if (task.lastError) {\n              if ($error.length) {\n                $error.text(task.lastError.message ?? String(task.lastError));\n              } else {\n                $item.append(\n                  `<div class=\"rlh-cleanup-task-error\">${escapeHtml(task.lastError.message ?? String(task.lastError))}</div>`,\n                );\n              }\n            } else if ($error.length) {\n              $error.remove();\n            }\n          });\n        };\n        refreshList();\n        const $retryBtn = $overlay.find('.rlh-cleanup-retry');\n        if ($retryBtn.length) {\n          $retryBtn.on('click', async e => {\n            e.preventDefault();\n            if ($retryBtn.prop('disabled')) return;\n            $retryBtn.prop('disabled', true).text('\u6B63\u5728\u91CD\u8BD5...');\n            await runCleanupTasks(true);\n            refreshList();\n            $retryBtn.prop('disabled', false).text('\u91CD\u8BD5\u6E05\u7406');\n          });\n        }\n      }, 0);\n      await modalPromise;\n    };\n    const retryOperation = async (operation, { description, onAttempt, onError } = {}) => {\n      let attempt = 0;\n      let lastError;\n      while (attempt < RETRY_SETTINGS.maxAttempts) {\n        attempt += 1;\n        onAttempt?.(attempt, RETRY_SETTINGS.maxAttempts);\n        try {\n          return await operation(attempt, RETRY_SETTINGS.maxAttempts);\n        } catch (error) {\n          lastError = error;\n          console.warn(`[RegexLoreHub] ${description} \u7B2C ${attempt} \u6B21\u5C1D\u8BD5\u5931\u8D25:`, error);\n          onError?.(error, attempt, RETRY_SETTINGS.maxAttempts);\n          if (attempt >= RETRY_SETTINGS.maxAttempts) break;\n          await sleep(RETRY_SETTINGS.delayMs);\n        }\n      }\n      throw lastError ?? new Error(`${description} \u5931\u8D25`);\n    };\n\n    const progressToast = showProgressToast('\u5F00\u59CB\u91CD\u547D\u540D...');\n    const currentChatLorebook = appState.chatLorebook;\n    let globalBooksBeforeUpdate = null;\n    let shouldVerifyGlobal = false;\n    let shouldVerifyChat = false;\n\n    try {\n      progressToast.update('\u6B63\u5728\u521B\u5EFA\u65B0\u4E16\u754C\u4E66...');\n      const createSuccess = await TavernAPI.createWorldbook(newName);\n      if (!createSuccess) {\n        throw new Error('\u521B\u5EFA\u65B0\u4E16\u754C\u4E66\u6587\u4EF6\u5931\u8D25\u3002');\n      }\n      registerCleanupTask(`\u5220\u9664\u65B0\u5EFA\u7684\u4E16\u754C\u4E66 \"${newName}\"`, async () => {\n        const names = (await TavernAPI.getWorldbooks()) ?? [];\n        if (!names.includes(newName)) return;\n        await TavernAPI.deleteWorldbook(newName);\n        const verifyNames = (await TavernAPI.getWorldbooks()) ?? [];\n        if (verifyNames.includes(newName)) {\n          throw new Error('\u65B0\u4E16\u754C\u4E66\u4ECD\u5B58\u5728\uFF0C\u5220\u9664\u5931\u8D25\u3002');\n        }\n      });\n\n      const oldEntries = [...safeGetLorebookEntries(oldName)];\n      if (oldEntries.length > 0) {\n        const entriesToCreate = oldEntries.map(entry => {\n          const newEntry = { ...entry };\n          delete newEntry.uid;\n          delete newEntry.tempUid;\n          delete newEntry.temp_uid;\n          return newEntry;\n        });\n        await retryOperation(\n          async () => {\n            await TavernAPI.replaceWorldbook(newName, entriesToCreate);\n            const createdEntries = await TavernAPI.getWorldbook(newName);\n            const createdCount = Array.isArray(createdEntries) ? createdEntries.length : 0;\n            if (createdCount !== entriesToCreate.length) {\n              throw new Error(\n                `\u590D\u5236\u6761\u76EE\u6821\u9A8C\u5931\u8D25\uFF08\u671F\u671B ${entriesToCreate.length} \u6761\uFF0C\u5B9E\u9645 ${createdCount} \u6761\uFF09\u3002`,\n              );\n            }\n          },\n          {\n            description: '\u590D\u5236\u6761\u76EE',\n            onAttempt: (attempt, total) => {\n              const suffix = attempt > 1 ? `\uFF08\u5C1D\u8BD5 ${attempt}/${total}\uFF09` : '';\n              progressToast.update(`\u6B63\u5728\u590D\u5236\u6761\u76EE...${suffix}`);\n            },\n          },\n        );\n      }\n\n      if (linkedCharacters.length > 0) {\n        await retryOperation(\n          async (attempt, total) =>\n            await updateLinkedCharacters(oldName, newName, progressToast, {\n              currentAttempt: attempt,\n              totalAttempts: total,\n            }),\n          {\n            description: '\u66F4\u65B0\u89D2\u8272\u7ED1\u5B9A',\n            onAttempt: (attempt, total) => {\n              const suffix = attempt > 1 ? `\uFF08\u5C1D\u8BD5 ${attempt}/${total}\uFF09` : '';\n              progressToast.update(`\u6B63\u5728\u66F4\u65B0\u89D2\u8272\u7ED1\u5B9A...${suffix}`);\n            },\n          },\n        );\n        registerCleanupTask(\n          `\u6062\u590D ${linkedCharacters.length} \u4E2A\u89D2\u8272\u7684\u4E16\u754C\u4E66\u7ED1\u5B9A`,\n          async () => {\n            await updateLinkedCharacters(newName, oldName, null, { currentAttempt: 1, totalAttempts: 1 });\n          },\n        );\n      }\n\n      progressToast.update('\u6B63\u5728\u66F4\u65B0\u5168\u5C40\u8BBE\u7F6E...');\n      const enabledGlobalBooks = await TavernAPI.getGlobalWorldbookNames();\n      const globalNeedsUpdate = Array.isArray(enabledGlobalBooks) && enabledGlobalBooks.includes(oldName);\n      let targetGlobalBooks = null;\n      if (globalNeedsUpdate) {\n        globalBooksBeforeUpdate = [...enabledGlobalBooks];\n        targetGlobalBooks = globalBooksBeforeUpdate.map(name => (name === oldName ? newName : name));\n        await retryOperation(\n          async () => {\n            await TavernAPI.rebindGlobalWorldbooks(targetGlobalBooks);\n            const verifyBooks = await TavernAPI.getGlobalWorldbookNames();\n            if (\n              !Array.isArray(verifyBooks) ||\n              !verifyBooks.includes(newName) ||\n              verifyBooks.includes(oldName)\n            ) {\n              throw new Error('\u5168\u5C40\u4E16\u754C\u4E66\u5217\u8868\u66F4\u65B0\u6821\u9A8C\u5931\u8D25\u3002');\n            }\n          },\n          {\n            description: '\u66F4\u65B0\u5168\u5C40\u8BBE\u7F6E',\n            onAttempt: (attempt, total) => {\n              const suffix = attempt > 1 ? `\uFF08\u5C1D\u8BD5 ${attempt}/${total}\uFF09` : '';\n              progressToast.update(`\u6B63\u5728\u66F4\u65B0\u5168\u5C40\u8BBE\u7F6E...${suffix}`);\n            },\n          },\n        );\n        registerCleanupTask('\u56DE\u6EDA\u5168\u5C40\u4E16\u754C\u4E66\u7ED1\u5B9A', async () => {\n          if (!Array.isArray(globalBooksBeforeUpdate)) return;\n          await TavernAPI.rebindGlobalWorldbooks(globalBooksBeforeUpdate);\n          const verifyBooks = await TavernAPI.getGlobalWorldbookNames();\n          if (\n            !Array.isArray(verifyBooks) ||\n            verifyBooks.includes(newName) ||\n            !verifyBooks.includes(oldName)\n          ) {\n            throw new Error('\u5168\u5C40\u4E16\u754C\u4E66\u56DE\u6EDA\u6821\u9A8C\u5931\u8D25\u3002');\n          }\n        });\n        shouldVerifyGlobal = true;\n      }\n\n      if (isChatLinked) {\n        await retryOperation(\n          async () => {\n            await TavernAPI.rebindChatWorldbook(newName);\n            const verifyChat = await TavernAPI.getChatWorldbookName();\n            if (verifyChat !== newName) {\n              throw new Error(`\u804A\u5929\u4E16\u754C\u4E66\u4ECD\u4E3A ${verifyChat ?? '\u672A\u7ED1\u5B9A'}`);\n            }\n          },\n          {\n            description: '\u66F4\u65B0\u804A\u5929\u7ED1\u5B9A',\n            onAttempt: (attempt, total) => {\n              const suffix = attempt > 1 ? `\uFF08\u5C1D\u8BD5 ${attempt}/${total}\uFF09` : '';\n              progressToast.update(`\u6B63\u5728\u66F4\u65B0\u804A\u5929\u7ED1\u5B9A...${suffix}`);\n            },\n          },\n        );\n        appState.chatLorebook = newName;\n        registerCleanupTask('\u6062\u590D\u804A\u5929\u4E16\u754C\u4E66\u7ED1\u5B9A', async () => {\n          await TavernAPI.rebindChatWorldbook(oldName);\n          const verifyChat = await TavernAPI.getChatWorldbookName();\n          if (verifyChat !== oldName) {\n            throw new Error(`\u804A\u5929\u4E16\u754C\u4E66\u4ECD\u4E3A ${verifyChat ?? '\u672A\u7ED1\u5B9A'}`);\n          }\n          appState.chatLorebook = oldName;\n        });\n        shouldVerifyChat = true;\n      }\n\n      progressToast.update('\u6B63\u5728\u66F4\u65B0\u5185\u90E8\u6620\u5C04...');\n      if (appState.lorebookUsage.has(oldName)) {\n        const linkedChars = appState.lorebookUsage.get(oldName);\n        appState.lorebookUsage.delete(oldName);\n        appState.lorebookUsage.set(newName, linkedChars);\n        console.log(`[RegexLoreHub] Updated lorebookUsage mapping from \"${oldName}\" to \"${newName}\"`);\n      }\n\n      await retryOperation(\n        async () => {\n          await TavernAPI.deleteWorldbook(oldName);\n          const names = (await TavernAPI.getWorldbooks()) ?? [];\n          if (names.includes(oldName)) {\n            throw new Error('\u65E7\u4E16\u754C\u4E66\u4ECD\u5B58\u5728\uFF0C\u5220\u9664\u5931\u8D25\u3002');\n          }\n        },\n        {\n          description: '\u5220\u9664\u65E7\u4E16\u754C\u4E66',\n          onAttempt: (attempt, total) => {\n            const suffix = attempt > 1 ? `\uFF08\u5C1D\u8BD5 ${attempt}/${total}\uFF09` : '';\n            progressToast.update(`\u6B63\u5728\u5220\u9664\u65E7\u4E16\u754C\u4E66...${suffix}`);\n          },\n        },\n      );\n      cleanupTasks.length = 0;\n\n      progressToast.update('\u6B63\u5728\u5237\u65B0\u6570\u636E...');\n      const expectedChatLorebook = appState.chatLorebook;\n      await loadAllData(true);\n\n      if (expectedChatLorebook && appState.chatLorebook !== expectedChatLorebook) {\n        console.log(`[RegexLoreHub] Restoring chat lorebook state after data refresh: \"${expectedChatLorebook}\"`);\n        appState.chatLorebook = expectedChatLorebook;\n      }\n\n      const allBookNames = appState.allLorebooks.map(book => book.name);\n      if (!allBookNames.includes(newName)) {\n        console.warn(`[RegexLoreHub] \u9A8C\u8BC1\u5931\u8D25\uFF1A\u5237\u65B0\u540E\u672A\u627E\u5230\u65B0\u4E16\u754C\u4E66 \"${newName}\"\u3002`);\n      }\n      if (allBookNames.includes(oldName)) {\n        console.warn(`[RegexLoreHub] \u9A8C\u8BC1\u5931\u8D25\uFF1A\u5237\u65B0\u540E\u65E7\u4E16\u754C\u4E66 \"${oldName}\" \u4ECD\u7136\u5B58\u5728\u3002`);\n      }\n\n      if (shouldVerifyGlobal) {\n        const finalGlobalBooks = await TavernAPI.getGlobalWorldbookNames();\n        if (!Array.isArray(finalGlobalBooks) || !finalGlobalBooks.includes(newName)) {\n          console.warn(`[RegexLoreHub] \u9A8C\u8BC1\u5931\u8D25\uFF1A\u5168\u5C40\u4E16\u754C\u4E66\u672A\u5305\u542B \"${newName}\"\u3002`, finalGlobalBooks);\n        }\n        if (Array.isArray(finalGlobalBooks) && finalGlobalBooks.includes(oldName)) {\n          console.warn(`[RegexLoreHub] \u9A8C\u8BC1\u5931\u8D25\uFF1A\u5168\u5C40\u4E16\u754C\u4E66\u4ECD\u5305\u542B \"${oldName}\"\u3002`, finalGlobalBooks);\n        }\n      }\n\n      if (shouldVerifyChat) {\n        try {\n          const finalChatLorebook = await TavernAPI.getChatWorldbookName();\n          if (finalChatLorebook !== newName) {\n            console.warn(\n              `[RegexLoreHub] \u9A8C\u8BC1\u5931\u8D25\uFF1A\u804A\u5929\u4E16\u754C\u4E66\u672A\u66F4\u65B0\u4E3A \"${newName}\"\uFF0C\u5F53\u524D\u503C \"${finalChatLorebook ?? '\u672A\u7ED1\u5B9A'}\"\u3002`,\n            );\n            appState.chatLorebook = finalChatLorebook;\n          }\n        } catch (verifyError) {\n          console.warn('[RegexLoreHub] \u9A8C\u8BC1\u804A\u5929\u4E16\u754C\u4E66\u72B6\u6001\u5931\u8D25:', verifyError);\n        }\n      }\n\n      progressToast.remove();\n      showToast('\u4E16\u754C\u4E66\u91CD\u547D\u540D\u6210\u529F');\n      if (isDetailView) {\n        await handleEnterLorebookDetail(newName);\n      } else {\n        renderContent();\n      }\n    } catch (error) {\n      progressToast.remove();\n      console.error('[RegexLoreHub] Rename failed:', error);\n      if (cleanupTasks.length > 0) {\n        await runCleanupTasks();\n        await presentCleanupModal(error?.message ?? '\u91CD\u547D\u540D\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF\u3002');\n      } else {\n        await showModal({\n          type: 'alert',\n          title: '\u91CD\u547D\u540D\u5931\u8D25',\n          text: `\u64CD\u4F5C\u5931\u8D25: ${error?.message ?? '\u672A\u77E5\u9519\u8BEF'}`,\n        });\n      }\n\n      await loadAllData(true);\n\n      if (currentChatLorebook && appState.chatLorebook !== currentChatLorebook) {\n        console.log(`[RegexLoreHub] Restoring chat lorebook state after error recovery: \"${currentChatLorebook}\"`);\n        appState.chatLorebook = currentChatLorebook;\n      }\n\n      try {\n        const context = parentWin.SillyTavern.getContext() || {};\n        const hasActiveChat = context.chatId !== undefined && context.chatId !== null;\n        if (hasActiveChat) {\n          const finalChatLorebook = await TavernAPI.getChatWorldbookName();\n          if (finalChatLorebook !== appState.chatLorebook) {\n            console.log(`[RegexLoreHub] Final chat lorebook sync after error recovery: \"${finalChatLorebook}\"`);\n            appState.chatLorebook = finalChatLorebook;\n          }\n        }\n      } catch (syncError) {\n        console.warn('[RegexLoreHub] Failed to sync chat lorebook state after error recovery:', syncError);\n      }\n    }\n  });\n\n\n\n  const handleCreateLorebook = errorCatched(async (event, previousValue = '') => {\n    let newName;\n    try {\n      newName = await showModal({\n        type: 'prompt',\n        title: '\u65B0\u5EFA\u4E16\u754C\u4E66',\n        text: '\u8BF7\u8F93\u5165\u65B0\u4E16\u754C\u4E66\u7684\u540D\u79F0:',\n        value: previousValue,\n      });\n    } catch {\n      return; // \u7528\u6237\u53D6\u6D88\n    }\n\n    newName = newName.trim();\n    if (!newName) {\n      return;\n    }\n\n    if (appState.allLorebooks.some(book => book.name === newName)) {\n      await showModal({ type: 'alert', title: '\u9519\u8BEF', text: '\u5DF2\u5B58\u5728\u540C\u540D\u4E16\u754C\u4E66\u3002' });\n      // \u91CD\u65B0\u6253\u5F00\u8F93\u5165\u6846\u5E76\u4FDD\u7559\u7528\u6237\u8F93\u5165\n      return handleCreateLorebook(event, newName);\n    }\n\n    const $button = event ? $(event.currentTarget) : null;\n    if ($button) {\n      $button.prop('disabled', true).addClass('rlh-loading');\n    }\n\n    try {\n      const success = await TavernAPI.createWorldbook(newName);\n      if (success) {\n        // \u5173\u952E\u4F18\u5316\uFF1A\u624B\u52A8\u66F4\u65B0\u72B6\u6001\uFF0C\u907F\u514D\u5168\u5C40\u5237\u65B0\n        appState.allLorebooks.push({\n          name: newName,\n          enabled: false,\n          entryCount: 0,\n          enabledEntryCount: 0,\n          entriesLoaded: true, // \u65B0\u4E66\u6CA1\u6709\u6761\u76EE\uFF0C\u53EF\u89C6\u4E3A\u5DF2\u52A0\u8F7D\n        });\n\n        // \u76F4\u63A5\u8FDB\u5165\u65B0\u521B\u5EFA\u7684\u4E16\u754C\u4E66\u8BE6\u60C5\u9875\n        await handleEnterLorebookDetail(newName);\n      } else {\n        await showModal({ type: 'alert', title: '\u521B\u5EFA\u5931\u8D25', text: '\u521B\u5EFA\u4E16\u754C\u4E66\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002' });\n      }\n    } finally {\n      if ($button) {\n        $button.prop('disabled', false).removeClass('rlh-loading');\n      }\n    }\n  });\n\n\n\n  const handleDeleteLorebook = errorCatched(async event => {\n  event.stopPropagation();\n  const $trigger = $(event.currentTarget);\n  const $bookSource = $trigger.closest('.rlh-book-group, .rlh-detail-view');\n  const bookName = $bookSource.data('book-name') || appState.activeBookName;\n  if (!bookName) return;\n  const isDetailView = $bookSource.hasClass('rlh-detail-view');\n  try {\n    await showModal({\n      type: 'confirm',\n      title: '\u786E\u8BA4\u5220\u9664',\n      text: `\u60A8\u786E\u5B9A\u8981\u6C38\u4E45\u5220\u9664\u4E16\u754C\u4E66 \"${bookName}\" \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`,\n    });\n  } catch {\n    return;\n  }\n\n  const success = await TavernAPI.deleteWorldbook(bookName);\n  if (success) {\n    appState.allLorebooks = appState.allLorebooks.filter(b => b.name !== bookName);\n    safeDeleteLorebookEntries(bookName);\n    if (appState.lorebookUsage instanceof Map && appState.lorebookUsage.has(bookName)) {\n      appState.lorebookUsage.delete(bookName);\n    }\n    if (Array.isArray(appState.lorebooks?.character)) {\n      appState.lorebooks.character = appState.lorebooks.character.filter(name => name !== bookName);\n    }\n    if (appState.chatLorebook === bookName) {\n      appState.chatLorebook = null;\n    }\n    if (appState.activeCharacterBook === bookName) {\n      appState.activeCharacterBook = null;\n    }\n    if (appState.activeBookName === bookName) {\n      appState.activeBookName = null;\n    }\n    if (isDetailView) {\n      await handleExitLorebookDetail();\n    } else {\n      renderContent();\n    }\n    showToast('\u5220\u9664\u6210\u529F');\n  } else {\n    await showModal({ type: 'alert', title: '\u5220\u9664\u5931\u8D25', text: '\u5220\u9664\u4E16\u754C\u4E66\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002' });\n  }\n  });\n\n\n\n  const handleBatchSetRecursion = errorCatched(async event => {\n  const $trigger = $(event.currentTarget);\n  const rawDatasetName = ($trigger.data('book-name') ?? '').toString().trim();\n  const context = getViewContext();\n  const fallbackNames = [\n    rawDatasetName,\n    context?.activeBookName ?? '',\n    appState.activeBookName ?? '',\n    appState.activeCharacterBook ?? '',\n    appState.chatLorebook ?? '',\n  ];\n  const bookName = fallbackNames.find(name => typeof name === 'string' && name.trim().length > 0)?.trim() ?? '';\n\n  if (!bookName) {\n    await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u9009\u62E9\u6216\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u3002' });\n    return;\n  }\n\n  let entries = [...safeGetLorebookEntries(bookName)];\n  if (!entries || entries.length === 0) {\n    await loadLorebookEntriesIfNeeded(bookName);\n    entries = [...safeGetLorebookEntries(bookName)];\n  }\n\n  if (!entries || entries.length === 0) {\n    await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BE5\u4E16\u754C\u4E66\u6CA1\u6709\u6761\u76EE\u53EF\u64CD\u4F5C\u3002' });\n    return;\n  }\n\n  try {\n    await showModal({\n      type: 'confirm',\n      title: '\u786E\u8BA4\u64CD\u4F5C',\n      text: `\u786E\u5B9A\u8981\u4E3A \"${bookName}\" \u4E2D\u7684\u6240\u6709\u6761\u76EE\u5F00\u542F\u201C\u9632\u6B62\u9012\u5F52\u201D\u548C\u201C\u4E0D\u53EF\u88AB\u9012\u5F52\u201D\u5417\uFF1F\u6B64\u64CD\u4F5C\u4F1A\u963B\u6B62\u4E16\u754C\u4E66\u6761\u76EE\u5F7C\u6B64\u89E6\u53D1\u3002`,\n    });\n  } catch {\n    return; // \u7528\u6237\u53D6\u6D88\n  }\n\n  const updates = entries.map(entry => ({\n    uid: entry.uid,\n    prevent_recursion: true,\n    exclude_recursion: true,\n  }));\n\n  await updateWorldbookEntries(bookName, updates);\n\n  // \u66F4\u65B0\u672C\u5730\u72B6\u6001\n  entries.forEach(entry => {\n    entry.prevent_recursion = true;\n    entry.exclude_recursion = true;\n    if (!entry.recursion || typeof entry.recursion !== 'object') {\n      entry.recursion = {};\n    }\n    entry.recursion.prevent_outgoing = true;\n    entry.recursion.prevent_incoming = true;\n  });\n\n  // \u5982\u679C\u6709\u6253\u5F00\u7684\u7F16\u8F91\u5668\uFF0C\u5219\u66F4\u65B0\u5176\u4E2D\u7684\u590D\u9009\u6846\n  updates.forEach(update => {\n    const $openEditor = $(\n      `#${'rlh-panel'}-content .rlh-item-container[data-book-name=\"${bookName}\"][data-id=\"${update.uid}\"] .rlh-collapsible-content:visible`,\n      parentDoc,\n    );\n    if ($openEditor.length) {\n      $openEditor.find('.rlh-edit-prevent-recursion').prop('checked', true);\n      $openEditor.find('.rlh-edit-exclude-recursion').prop('checked', true);\n    }\n  });\n\n  showToast('\u5DF2\u4E3A\u6240\u6709\u6761\u76EE\u5F00\u542F\u201C\u9632\u6B62\u9012\u5F52\u201D\u548C\u201C\u4E0D\u53EF\u88AB\u9012\u5F52\u201D');\n\n  await refreshLorebookData(bookName);\n  });\n\n\n\n  const handleFixKeywords = errorCatched(async event => {\n  const $trigger = $(event.currentTarget);\n  const rawDatasetName = ($trigger.data('book-name') ?? '').toString().trim();\n  const context = getViewContext();\n  const fallbackNames = [\n    rawDatasetName,\n    context?.activeBookName ?? '',\n    appState.activeBookName ?? '',\n    appState.activeCharacterBook ?? '',\n    appState.chatLorebook ?? '',\n  ];\n  const bookName = fallbackNames.find(name => typeof name === 'string' && name.trim().length > 0)?.trim() ?? '';\n\n  if (!bookName) {\n    await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u9009\u62E9\u6216\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u3002' });\n    return;\n  }\n\n  let entries = [...safeGetLorebookEntries(bookName)];\n  if (!entries || entries.length === 0) {\n    await loadLorebookEntriesIfNeeded(bookName);\n    entries = [...safeGetLorebookEntries(bookName)];\n  }\n\n  if (!entries || entries.length === 0) {\n    await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BE5\u4E16\u754C\u4E66\u6CA1\u6709\u6761\u76EE\u53EF\u64CD\u4F5C\u3002' });\n    return;\n  }\n\n  try {\n    await showModal({\n      type: 'confirm',\n      title: '\u786E\u8BA4\u64CD\u4F5C',\n      text: `\u786E\u5B9A\u8981\u4E3A \"${bookName}\" \u4E2D\u7684\u6240\u6709\u6761\u76EE\u4FEE\u590D\u5173\u952E\u8BCD\uFF08\u5C06\u4E2D\u6587\u9017\u53F7\u66FF\u6362\u4E3A\u82F1\u6587\u9017\u53F7\uFF09\u5417\uFF1F`,\n    });\n  } catch {\n    return; // \u7528\u6237\u53D6\u6D88\n  }\n\n  let changedCount = 0;\n  const updates = entries\n    .map(entry => {\n      const originalKeysString = (entry.keys || []).join(', ');\n      // \u4FEE\u590D\u4E2D\u6587\u9017\u53F7\u548C\u591A\u4F59\u7684\u7A7A\u683C\n      const newKeysString = originalKeysString.replace(/\uFF0C/g, ',').replace(/,+/g, ',').trim();\n      const newKeysArray = newKeysString\n        .split(',')\n        .map(k => k.trim())\n        .filter(Boolean);\n      const finalKeysString = newKeysArray.join(', ');\n\n      if (originalKeysString !== finalKeysString) {\n        changedCount++;\n        return {\n          uid: entry.uid,\n          keys: newKeysArray,\n        };\n      }\n      return null;\n    })\n    .filter(Boolean);\n\n  if (updates.length > 0) {\n    await updateWorldbookEntries(bookName, updates);\n\n    // \u66F4\u65B0\u672C\u5730\u72B6\u6001\n    updates.forEach(update => {\n      const entry = entries.find(e => e.uid === update.uid);\n      if (entry) {\n        entry.keys = update.keys;\n      }\n    });\n\n    // \u5982\u679C\u6709\u6253\u5F00\u7684\u7F16\u8F91\u5668\uFF0C\u5219\u66F4\u65B0\u5176\u4E2D\u7684\u8F93\u5165\u6846\n    updates.forEach(update => {\n      const $openEditor = $(\n        `#${'rlh-panel'}-content .rlh-item-container[data-book-name=\"${bookName}\"][data-id=\"${update.uid}\"] .rlh-collapsible-content:visible`,\n        parentDoc,\n      );\n      if ($openEditor.length) {\n        $openEditor.find('.rlh-edit-keys').val(update.keys.join(', '));\n      }\n    });\n\n    showToast(`\u6210\u529F\u4FEE\u590D\u4E86 ${changedCount} \u4E2A\u6761\u76EE\u7684\u5173\u952E\u8BCD`);\n\n    await refreshLorebookData(bookName);\n  } else {\n    await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u6240\u6709\u6761\u76EE\u7684\u5173\u952E\u8BCD\u683C\u5F0F\u90FD\u6B63\u786E\uFF0C\u65E0\u9700\u4FEE\u590D\u3002' });\n  }\n  });\n\n\n\n  const applyUnifiedPosition = errorCatched(async ({ bookName, positionValue }) => {\n    const targetPosition = (positionValue ?? '').toString().trim();\n    if (!targetPosition) return;\n\n    const context = getViewContext();\n    const fallbackNames = [\n      bookName,\n      context?.activeBookName ?? '',\n      appState.activeBookName ?? '',\n      appState.activeCharacterBook ?? '',\n      appState.chatLorebook ?? '',\n    ];\n    const resolvedBookName =\n      fallbackNames.find(name => typeof name === 'string' && name.trim().length > 0)?.trim() ?? '';\n\n    if (!resolvedBookName) {\n      await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u9009\u62E9\u6216\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u3002' });\n      return;\n    }\n\n    let entries = [...safeGetLorebookEntries(resolvedBookName)];\n    if (!entries.length) {\n      await loadLorebookEntriesIfNeeded(resolvedBookName);\n      entries = [...safeGetLorebookEntries(resolvedBookName)];\n    }\n\n    if (!entries.length) {\n      await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BE5\u4E16\u754C\u4E66\u6CA1\u6709\u6761\u76EE\u53EF\u64CD\u4F5C\u3002' });\n      return;\n    }\n\n    const isEntryMultiSelect = appState.multiSelectMode && appState.multiSelectTarget === 'entry';\n    let targetEntries = entries;\n    if (isEntryMultiSelect) {\n      const selectionPrefix = buildLoreSelectionPrefix(resolvedBookName);\n      const selectedUidSet = new Set();\n      appState.selectedItems.forEach(key => {\n        if (typeof key !== 'string' || !key.startsWith(selectionPrefix)) return;\n        const encodedId = key.slice(selectionPrefix.length);\n        const decodedId = decodeSelectionPart(encodedId);\n        const numericId = Number(decodedId);\n        if (Number.isFinite(numericId)) selectedUidSet.add(numericId);\n      });\n      if (selectedUidSet.size === 0) {\n        await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u5DF2\u5F00\u542F\u591A\u9009\uFF0C\u8BF7\u5148\u52FE\u9009\u8981\u7EDF\u4E00\u4F4D\u7F6E\u7684\u6761\u76EE\u3002' });\n        return;\n      }\n      targetEntries = entries.filter(entry => selectedUidSet.has(Number(entry?.uid)));\n      if (!targetEntries.length) {\n        await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u672A\u80FD\u5339\u914D\u5230\u5DF2\u9009\u62E9\u7684\u6761\u76EE\uFF0C\u8BF7\u91CD\u65B0\u9009\u62E9\u540E\u518D\u8BD5\u3002' });\n        return;\n      }\n    }\n\n    const optionLabel = LOREBOOK_OPTIONS.position?.[targetPosition] ?? targetPosition;\n\n    const updates = targetEntries\n      .filter(entry => (entry?.position ?? '').toString() !== targetPosition)\n      .map(entry => ({ uid: entry.uid, position: targetPosition }));\n\n    if (!updates.length) {\n      const scopeLabel = isEntryMultiSelect ? '\u6240\u9009\u6761\u76EE' : '\u6240\u6709\u6761\u76EE';\n      await showModal({ type: 'alert', title: '\u63D0\u793A', text: `${scopeLabel}\u7684\u4F4D\u7F6E\u5DF2\u7ECF\u662F\u300C${optionLabel}\u300D\u3002` });\n      return;\n    }\n\n    try {\n      const targetCount = targetEntries.length;\n      const scopeLabel = isEntryMultiSelect ? '\u9009\u4E2D\u7684\u6761\u76EE' : `\"${resolvedBookName}\" \u4E2D\u7684\u6761\u76EE`;\n      await showModal({\n        type: 'confirm',\n        title: '\u786E\u8BA4\u64CD\u4F5C',\n        text: `\u786E\u5B9A\u8981\u5C06 ${scopeLabel}\uFF08\u5171 ${targetCount} \u4E2A\uFF09\u8BBE\u7F6E\u4E3A\u300C${optionLabel}\u300D\u5417\uFF1F`,\n      });\n    } catch {\n      return;\n    }\n\n    await updateWorldbookEntries(resolvedBookName, updates);\n\n    const refreshedEntries = safeGetLorebookEntries(resolvedBookName);\n    const uniquePositions = new Set(\n      refreshedEntries.map(entry => (entry?.position ?? 'before_character_definition').toString()),\n    );\n    const unifiedPosition = uniquePositions.size === 1 ? uniquePositions.values().next().value : null;\n\n    updates.forEach(update => {\n      const selector = `#${'rlh-panel'}-content .rlh-item-container[data-book-name=\"${resolvedBookName}\"][data-id=\"${update.uid}\"]`;\n      const $container = $(selector, parentDoc);\n      if ($container.length) {\n        const $positionSelect = $container.find('.rlh-edit-position');\n        if ($positionSelect.length) {\n          $positionSelect.val(targetPosition).trigger('change');\n        }\n      }\n    });\n\n    const $menu = $(`#${POSITION_MENU_ID}`, parentDoc);\n    if ($menu.length) {\n      $menu.attr('data-book-name', resolvedBookName);\n      const $button = $(`#${POSITION_MENU_BUTTON_ID}`, parentDoc);\n      if ($button.length) {\n        $button.removeAttr('disabled');\n        $button.attr('data-book-name', resolvedBookName);\n      }\n      const $options = $menu.find('.rlh-position-option');\n      $options.each(function () {\n        const $option = $(this);\n        const value = ($option.data('position-value') ?? '').toString();\n        const isActive = unifiedPosition && value === unifiedPosition;\n        $option.toggleClass('active', isActive);\n        $option.attr('aria-selected', isActive ? 'true' : 'false');\n        $option.attr('data-book-name', resolvedBookName);\n      });\n    }\n\n    showToast(`\u5DF2\u66F4\u65B0 ${updates.length} \u4E2A\u6761\u76EE\u7684\u4F4D\u7F6E\u4E3A\u300C${optionLabel}\u300D`);\n\n    await refreshLorebookData(resolvedBookName);\n  });\n\n\n\n  const handleCreateChatLorebook = errorCatched(async () => {\n  const bookName = await TavernAPI.getOrCreateChatWorldbook();\n  if (bookName) {\n    showToast(`\u5DF2\u521B\u5EFA\u5E76\u7ED1\u5B9A\u804A\u5929\u4E16\u754C\u4E66: ${bookName}`);\n    await loadAllData(true);\n  } else {\n    await showModal({ type: 'alert', title: '\u64CD\u4F5C\u5931\u8D25', text: '\u65E0\u6CD5\u521B\u5EFA\u6216\u7ED1\u5B9A\u804A\u5929\u4E16\u754C\u4E66\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002' });\n  }\n  });\n\n\n  const handleUnlinkChatLorebook = errorCatched(async () => {\n  const bookName = appState.chatLorebook;\n  if (!bookName) return;\n\n  try {\n    await showModal({\n      type: 'confirm',\n      title: '\u786E\u8BA4\u89E3\u9664\u7ED1\u5B9A',\n      text: `\u60A8\u786E\u5B9A\u8981\u89E3\u9664\u4E0E\u804A\u5929\u4E16\u754C\u4E66 \"${bookName}\" \u7684\u7ED1\u5B9A\u5417\uFF1F\u4E16\u754C\u4E66\u672C\u8EAB\u4E0D\u4F1A\u88AB\u5220\u9664\u3002`,\n    });\n  } catch {\n    return; // \u7528\u6237\u53D6\u6D88\n  }\n\n  await TavernAPI.rebindChatWorldbook(null);\n  appState.chatLorebook = null;\n  showToast('\u5DF2\u89E3\u9664\u7ED1\u5B9A');\n  renderContent();\n  });\n\n\n  const handleRefreshLorebookDetail = errorCatched(async () => {\n    const bookName = appState.activeBookName;\n    if (!bookName) return;\n\n    appState.loadingBookName = bookName;\n    renderContent();\n\n    await loadLorebookEntriesIfNeeded(bookName, true); // \u5F3A\u5236\u5237\u65B0\n\n    appState.loadingBookName = null;\n    renderContent();\n  });\n\n\n  return {\n    handleEnterLorebookDetail,\n    handleExitLorebookDetail,\n    handleRefreshLorebookDetail,\n    handleCreateLorebook,\n    handleDeleteLorebook,\n    handleRenameBook,\n    handleBatchSetRecursion,\n    handleFixKeywords,\n    applyUnifiedPosition,\n    handleCreateChatLorebook,\n    handleUnlinkChatLorebook,\n  };\n}\n", "import {\n  LOREBOOK_OPTIONS,\n  appState,\n  safeGetLorebookEntries,\n  safeSetLorebookEntries,\n  errorCatched,\n  showToast,\n  showModal,\n  escapeHtml,\n  get$,\n  getParentDoc,\n  debounce,\n  WORLD_BOOK_STATUS_LIST,\n  DEFAULT_WORLD_BOOK_STATUS,\n  resolveWorldbookStatus,\n} from '../../core.js';\nimport {\n  TavernAPI,\n  createInMemoryEntry,\n  updateInMemoryEntry,\n  saveAllChanges,\n  updateBookSummary,\n  updateWorldbookEntries, // \u5BFC\u5165\u65B0\u7684\u66F4\u65B0\u51FD\u6570\n  queueLorebookEntryUpdate,\n  queueRegexUpdate,\n  normalizeWorldbookEntry,\n} from '../../dataLayer.js';\nimport {\n  getViewContext,\n  prependEntry,\n  buildLoreEntryViewerHTML,\n  buildRegexViewerHTML,\n  updateEntryStatusDom,\n} from '../render/index.js';\n\n// --- \u6761\u76EE\u4E8B\u4EF6\u5904\u7406 ---\nexport function createItemHandlers(deps = {}) {\n  const $ = deps.$ ?? get$();\n  const parentDoc = deps.parentDoc ?? getParentDoc();\n  // \u5B9A\u4F4D\u5F53\u524D\u7F16\u8F91\u7684\u6B63\u5219\u9879\uFF0C\u4FBF\u4E8E\u5728\u8F93\u5165\u65F6\u540C\u6B65\u72B6\u6001\n  const findRegexItemById = (rawId) => {\n    const targetId = String(rawId);\n    const fromGlobal = appState.regexes.global.find(item => String(item.id) === targetId);\n    if (fromGlobal) return fromGlobal;\n    return appState.regexes.character.find(item => String(item.id) === targetId) ?? null;\n  };\n\n  // \u5C06\u8F93\u5165\u503C\u5199\u5165\u6B63\u5219\u9879\uFF0C\u81EA\u52A8\u5904\u7406\u5D4C\u5957\u5B57\u6BB5\u548C\u7C7B\u578B\u8F6C\u6362\n  const applyRegexFieldUpdate = (regexItem, fieldPath, rawValue) => {\n    if (!regexItem || !fieldPath) return;\n    let value = rawValue;\n    if (typeof value !== 'boolean') {\n      value = value ?? '';\n    }\n    if (fieldPath === 'min_depth' || fieldPath === 'max_depth') {\n      const numeric = parseInt(value, 10);\n      value = Number.isNaN(numeric) ? null : numeric;\n    }\n    const segments = fieldPath.split('.');\n    if (segments.length === 1) {\n      regexItem[segments[0]] = value;\n      return;\n    }\n    let cursor = regexItem;\n    for (let i = 0; i < segments.length - 1; i++) {\n      const key = segments[i];\n      if (!cursor[key] || typeof cursor[key] !== 'object') {\n        cursor[key] = {};\n      }\n      cursor = cursor[key];\n    }\n    cursor[segments[segments.length - 1]] = value;\n  };\n\n  // \u521B\u5EFA\u4E00\u4E2A\u9632\u6296\u51FD\u6570\u7528\u4E8E\u81EA\u52A8\u4FDD\u5B58\n  const debouncedSave = debounce(() => saveAllChanges({ silent: true }), 1000);\n\n  const handleEditorInput = errorCatched(async event => {\n    const $target = $(event.currentTarget);\n    const $container = $target.closest('.rlh-item-container');\n    const type = $container.data('type');\n    const id = $container.data('id');\n    const numericId = Number(id);\n    const field = $target.data('field');\n    if (!field) return;\n    if (type === 'lore') {\n      const bookName = $container.data('book-name');\n      const entries = safeGetLorebookEntries(bookName);\n      const entry = entries.find(item => {\n        const itemUid = item?.uid;\n        if (typeof itemUid === 'number' && !Number.isNaN(numericId)) {\n          return itemUid === numericId;\n        }\n        return String(itemUid) === String(id);\n      });\n      if (!entry) return;\n      // \u5B9E\u65F6\u66F4\u65B0\u5185\u5B58\u4E2D\u7684\u72B6\u6001\uFF0C\u800C\u4E0D\u662F\u76F4\u63A5\u8C03\u7528API\n      let value;\n      if ($target.is(':checkbox')) {\n        value = $target.is(':checked');\n      } else if ($target.is('[contenteditable=\"true\"]')) {\n        const element = $target.get(0);\n        if (element) {\n          const blockTags = new Set(['div', 'p', 'li', 'ul', 'ol', 'blockquote', 'pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'table', 'tr']);\n          const parts = [];\n          const appendText = textValue => {\n            if (!textValue) return;\n            parts.push(textValue);\n          };\n          const appendNewline = () => {\n            if (!parts.length) {\n              parts.push('\\n');\n              return;\n            }\n            const last = parts[parts.length - 1];\n            if (last?.endsWith('\\n')) return;\n            parts.push('\\n');\n          };\n          const collectText = node => {\n            if (!node) return;\n            const nodeType = node.nodeType;\n            if (nodeType === Node.TEXT_NODE) {\n              appendText(node.nodeValue || '');\n              return;\n            }\n            if (nodeType !== Node.ELEMENT_NODE) return;\n            const tag = node.nodeName.toLowerCase();\n            if (tag === 'br') {\n              parts.push('\\n');\n              return;\n            }\n            if (tag === 'style' || tag === 'script') return;\n            node.childNodes.forEach(child => collectText(child));\n            if (blockTags.has(tag)) appendNewline();\n          };\n          collectText(element);\n          value = parts.join('');\n          value = value.replace(/\\u00a0/g, ' ');\n          value = value.replace(/\\r?\\n/g, '\\n');\n        } else {\n          value = '';\n        }\n      } else {\n        value = $target.val();\n      }\n      // \u7279\u6B8A\u5904\u7406\u9700\u8981\u7C7B\u578B\u8F6C\u6362\u7684\u5B57\u6BB5\n      if (field === 'statusId') {\n        const statusMeta = resolveWorldbookStatus(value) ?? DEFAULT_WORLD_BOOK_STATUS;\n        entry.statusId = statusMeta.id;\n        if (!entry.strategy || typeof entry.strategy !== 'object') {\n          entry.strategy = {};\n        }\n        entry.strategy.type = statusMeta.strategyType;\n        entry.type = statusMeta.strategyType;\n        queueLorebookEntryUpdate(bookName, entry.uid ?? id, {\n          statusId: statusMeta.id,\n          strategy: { ...(entry.strategy ?? {}), type: statusMeta.strategyType },\n          type: statusMeta.strategyType,\n        });\n        updateEntryStatusDom(bookName, entry.uid ?? id, statusMeta.id);\n        debouncedSave();\n        return;\n      }\n      if (field === 'keys') {\n        entry.keys = value.split(',').map(k => k.trim()).filter(Boolean);\n      } else if (['depth', 'order', 'probability'].includes(field)) {\n        const numValue = parseInt(value, 10);\n        entry[field] = isNaN(numValue) ? ($target.attr('placeholder') === '\u4F8B\u5982: 0' ? null : 100) : numValue;\n      } else {\n        entry[field] = value;\n      }\n      const pendingValue = Array.isArray(entry[field]) ? [...entry[field]] : entry[field];\n      queueLorebookEntryUpdate(bookName, entry.uid ?? id, { [field]: pendingValue });\n    } else if (type === 'regex') {\n      const regexItem = findRegexItemById(id);\n      if (!regexItem) return;\n      let value;\n      if ($target.is(':checkbox')) {\n        value = $target.is(':checked');\n      } else {\n        value = $target.val();\n      }\n      applyRegexFieldUpdate(regexItem, field, value);\n      queueRegexUpdate(regexItem.id);\n    }\n    // \u89E6\u53D1\u9632\u6296\u4FDD\u5B58\n    debouncedSave();\n  });\n  const buildLoreEntryEditorHtml = (entry) => {\n    const positionOptions = Object.entries(LOREBOOK_OPTIONS.position)\n      .map(([value, text]) => `<option value=\"${value}\" ${entry.position === value ? 'selected' : ''}>${text}</option>`)\n      .join('');\n    const logicOptions = Object.entries(LOREBOOK_OPTIONS.logic)\n      .map(([value, text]) => `<option value=\"${value}\" ${entry.logic === value ? 'selected' : ''}>${text}</option>`)\n      .join('');\n    const keywordsText = Array.isArray(entry.keys) ? entry.keys.join(', ') : '';\n    const contentText = entry.content || '';\n    const currentStatusId = entry.statusId ?? DEFAULT_WORLD_BOOK_STATUS.id;\n    entry.statusId = currentStatusId;\n    const statusMeta = resolveWorldbookStatus(currentStatusId) ?? DEFAULT_WORLD_BOOK_STATUS;\n    if (!entry.strategy || typeof entry.strategy !== 'object') {\n      entry.strategy = {};\n    }\n    entry.strategy.type = statusMeta.strategyType;\n    entry.type = statusMeta.strategyType;\n    const statusOptions = WORLD_BOOK_STATUS_LIST.map(status => {\n      const selected = currentStatusId === status.id ? 'selected' : '';\n      return `<option value=\"${status.id}\" ${selected}>${status.label}</option>`;\n    }).join('');\n    return `\n      <div class=\"rlh-editor-wrapper\" data-mode=\"edit\">\n        <div class=\"rlh-editor-group\"><h5>\u72B6\u6001</h5>\n          <div class=\"rlh-editor-grid\">\n            <div class=\"rlh-grid-item\"><label>\u6FC0\u6D3B\u72B6\u6001</label><select class=\"rlh-edit-status rlh-select-nudge\" data-field=\"statusId\">${statusOptions}</select></div>\n          </div>\n        </div>\n        <div class=\"rlh-editor-field\">\n          <label>\u5173\u952E\u8BCD (\u9017\u53F7\u5206\u9694)</label>\n          <input type=\"text\" class=\"rlh-edit-keys\" data-field=\"keys\" value=\"${escapeHtml(keywordsText)}\">\n        </div>\n        <div class=\"rlh-editor-field\">\n          <label>\u5185\u5BB9</label>\n          <div class=\"rlh-edit-content\" data-field=\"content\" contenteditable=\"true\">${escapeHtml(contentText)}</div>\n        </div>\n        <div class=\"rlh-editor-group\"><h5>\u63D2\u5165\u89C4\u5219</h5>\n          <div class=\"rlh-editor-grid\">\n            <div class=\"rlh-grid-item\"><label>\u4F4D\u7F6E</label><select class=\"rlh-edit-position rlh-select-nudge\" data-field=\"position\">${positionOptions}</select></div>\n            <div class=\"rlh-grid-item rlh-depth-container\"><label>\u6DF1\u5EA6</label><input type=\"number\" class=\"rlh-edit-depth\" data-field=\"depth\" placeholder=\"\u4F8B\u5982: 0\" value=\"${entry.depth ?? ''}\"></div>\n            <div class=\"rlh-grid-item\"><label>\u987A\u5E8F</label><input type=\"number\" class=\"rlh-edit-order\" data-field=\"order\" placeholder=\"\u4F8B\u5982: 100\" value=\"${entry.order ?? ''}\"></div>\n          </div>\n        </div>\n        <div class=\"rlh-editor-group\"><h5>\u6FC0\u6D3B\u903B\u8F91</h5>\n          <div class=\"rlh-editor-grid\">\n            <div class=\"rlh-grid-item\"><label>\u6982\u7387 (%)</label><input type=\"number\" class=\"rlh-edit-probability\" data-field=\"probability\" min=\"0\" max=\"100\" placeholder=\"100\" value=\"${entry.probability ?? ''}\"></div>\n            <div class=\"rlh-grid-item\"><label>\u5173\u952E\u8BCD\u903B\u8F91</label><select class=\"rlh-edit-logic rlh-select-nudge\" data-field=\"logic\">${logicOptions}</select></div>\n          </div>\n        </div>\n        <div class=\"rlh-editor-group\"><h5>\u5339\u914D\u4E0E\u9012\u5F52</h5>\n          <div class=\"rlh-editor-options-row\">\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-case-sensitive\" data-field=\"case_sensitive\" ${entry.case_sensitive ? 'checked' : ''}> \u5927\u5C0F\u5199\u654F\u611F</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-match-whole\" data-field=\"match_whole_words\" ${entry.match_whole_words ? 'checked' : ''}> \u5168\u8BCD\u5339\u914D</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-prevent-recursion\" data-field=\"prevent_recursion\" ${entry.prevent_recursion ? 'checked' : ''}> \u9632\u6B62\u9012\u5F52</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-exclude-recursion\" data-field=\"exclude_recursion\" ${entry.exclude_recursion ? 'checked' : ''}> \u4E0D\u53EF\u88AB\u9012\u5F52</label>\n          </div>\n        </div>\n      </div>\n    `;\n  };\n  const buildRegexEditorHtml = (regexItem) => {\n    const destination = regexItem?.destination ?? {};\n    const source = regexItem?.source ?? {};\n    const findValue = escapeHtml(regexItem?.find_regex ?? '');\n    const replaceValue = escapeHtml(regexItem?.replace_string ?? '');\n    const minDepthValue = escapeHtml(String(regexItem?.min_depth ?? ''));\n    const maxDepthValue = escapeHtml(String(regexItem?.max_depth ?? ''));\n    return `\n      <div class=\"rlh-editor-wrapper\" data-mode=\"edit\">\n        <div class=\"rlh-editor-field\">\n          <label>\u67E5\u627E\u6B63\u5219\u8868\u8FBE\u5F0F</label>\n          <textarea class=\"rlh-edit-find\" data-field=\"find_regex\">${findValue}</textarea>\n        </div>\n        <div class=\"rlh-editor-field\">\n          <label>\u66FF\u6362\u4E3A</label>\n          <textarea class=\"rlh-edit-replace\" data-field=\"replace_string\">${replaceValue}</textarea>\n        </div>\n        <div class=\"rlh-editor-group\">\n          <h5>\u77ED\u6682</h5>\n          <div class=\"rlh-editor-options-row\">\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-dest-display\" data-field=\"destination.display\" ${destination.display ? 'checked' : ''}> \u4EC5\u683C\u5F0F\u663E\u793A</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-dest-prompt\" data-field=\"destination.prompt\" ${destination.prompt ? 'checked' : ''}> \u4EC5\u683C\u5F0F\u63D0\u793A\u8BCD</label>\n          </div>\n        </div>\n        <div class=\"rlh-editor-group\">\n          <h5>\u4F5C\u7528\u8303\u56F4</h5>\n          <div class=\"rlh-editor-options-row\">\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-user\" data-field=\"source.user_input\" ${source.user_input ? 'checked' : ''}> \u7528\u6237\u8F93\u5165</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-ai\" data-field=\"source.ai_output\" ${source.ai_output ? 'checked' : ''}> AI\u8F93\u51FA</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-slash\" data-field=\"source.slash_command\" ${source.slash_command ? 'checked' : ''}> \u659C\u6760\u547D\u4EE4</label>\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-world\" data-field=\"source.world_info\" ${source.world_info ? 'checked' : ''}> \u4E16\u754C\u4E66</label>\n          </div>\n        </div>\n        <div class=\"rlh-editor-group\">\n          <h5>\u6DF1\u5EA6</h5>\n          <div class=\"rlh-depth-inputs\">\n            <input type=\"number\" class=\"rlh-edit-depth-min\" data-field=\"min_depth\" placeholder=\"\u6700\u5C0F\u6DF1\u5EA6\" value=\"${minDepthValue}\">\n            <input type=\"number\" class=\"rlh-edit-depth-max\" data-field=\"max_depth\" placeholder=\"\u6700\u5927\u6DF1\u5EA6\" value=\"${maxDepthValue}\">\n          </div>\n        </div>\n      </div>\n    `;\n  };\n\n  const updateRenameButtonState = ($container, mode) => {\n  const $button = $container.find('.rlh-rename-btn').first();\n  if (!$button.length) return;\n  const $icon = $button.find('i').first();\n  if (mode === 'edit') {\n    $button.attr('title', '\u9000\u51FA\u7F16\u8F91\u6A21\u5F0F');\n    $button.attr('data-rename-mode', 'exit');\n    if ($icon.length) {\n      $icon.removeClass('fa-pencil').addClass('fa-eye');\n    }\n  } else {\n    $button.attr('title', '\u91CD\u547D\u540D\u5E76\u7F16\u8F91');\n    $button.attr('data-rename-mode', 'rename');\n    if ($icon.length) {\n      $icon.removeClass('fa-eye').addClass('fa-pencil');\n    }\n  }\n};\n\n  const bindLoreEditorInputs = $content => {\n    $content.on('input.rlh change.rlh', 'input, textarea, select, [contenteditable=\"true\"]', handleEditorInput);\n    $content.find('.rlh-edit-position').trigger('change');\n  };\n\n  const switchLoreEntryMode = (mode, $container, entry, { animate = true, searchTerm } = {}) => {\n    const $content = $container.find('.rlh-collapsible-content').first();\n    if (!$content.length) return;\n\n    const isViewMode = mode === 'view';\n    const normalizedTerm = typeof searchTerm === 'string'\n      ? searchTerm\n      : ($container.data('searchTerm') || '');\n\n    const html = isViewMode\n      ? buildLoreEntryViewerHTML(entry, normalizedTerm)\n      : buildLoreEntryEditorHtml(entry);\n\n    if (isViewMode) {\n      $container.data('searchTerm', normalizedTerm);\n      $container.attr('data-search-term', normalizedTerm);\n    }\n\n    $content.stop(true, true);\n    $content.off('input.rlh change.rlh');\n    $content.html(html);\n\n    $container.attr('data-entry-mode', mode);\n    $content.attr('data-entry-mode', mode);\n    $container.toggleClass('rlh-editing', !isViewMode);\n    updateRenameButtonState($container, mode);\n\n    const $nameSpan = $container.find('.rlh-item-name').first();\n    if ($nameSpan.length) {\n      if (isViewMode) {\n        $nameSpan.show().removeAttr('aria-hidden');\n      } else {\n        $nameSpan.hide().attr('aria-hidden', 'true');\n      }\n    }\n\n    const finalize = () => {\n      if (!isViewMode) {\n        bindLoreEditorInputs($content);\n      }\n    };\n\n    const animateReveal = done => {\n      const el = $content[0];\n      if (!el) {\n        done();\n        return;\n      }\n\n      const duration = 280;\n      const easeInOut = t => (t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t);\n\n      el.style.display = 'block';\n      el.style.overflow = 'hidden';\n      const startHeight = 0;\n      const targetHeight = el.scrollHeight;\n      el.style.height = `${startHeight}px`;\n      el.style.opacity = '0';\n\n      let startTime = null;\n      const step = timestamp => {\n        if (!startTime) startTime = timestamp;\n        const progress = Math.min((timestamp - startTime) / duration, 1);\n        const eased = easeInOut(progress);\n        const currentHeight = startHeight + (targetHeight - startHeight) * eased;\n        el.style.height = `${currentHeight}px`;\n        el.style.opacity = String(0.6 + 0.4 * eased);\n\n        if (progress < 1) {\n          requestAnimationFrame(step);\n        } else {\n          el.style.height = '';\n          el.style.opacity = '';\n          el.style.overflow = '';\n          done();\n        }\n      };\n\n      requestAnimationFrame(step);\n    };\n\n    if (!$content.is(':visible')) {\n      if (animate) {\n        animateReveal(finalize);\n      } else {\n        $content.show();\n        finalize();\n      }\n    } else {\n      finalize();\n    }\n  };\n\n  const renderLoreEntryViewer = ($container, entry, searchTerm, options = {}) => {\n    switchLoreEntryMode('view', $container, entry, { ...options, searchTerm });\n  };\n\n  const renderLoreEntryEditor = ($container, entry, options = {}) => {\n    switchLoreEntryMode('edit', $container, entry, options);\n  };\n  const renderRegexViewer = ($container, regexItem, searchTerm, { animate = true } = {}) => {\n    const $content = $container.find('.rlh-collapsible-content').first();\n    if (!$content.length) return;\n    const normalizedTerm = typeof searchTerm === 'string' ? searchTerm : '';\n    $container.data('searchTerm', normalizedTerm);\n    $container.attr('data-search-term', normalizedTerm);\n    const viewerHtml = buildRegexViewerHTML(regexItem, normalizedTerm);\n    $content.stop(true, true);\n    $content.off('input.rlh change.rlh');\n    $content.html(viewerHtml);\n    $container.attr('data-entry-mode', 'view');\n    $content.attr('data-entry-mode', 'view');\n    $container.removeClass('rlh-editing');\n    updateRenameButtonState($container, 'view');\n    const $nameSpan = $container.find('.rlh-item-name').first();\n    if ($nameSpan.length) {\n      $nameSpan.show().removeAttr('aria-hidden');\n    }\n    if (!$content.is(':visible')) {\n      if (animate) $content.slideDown(200);\n      else $content.show();\n    }\n  };\n  const renderRegexEditor = ($container, regexItem, { animate = true } = {}) => {\n    const $content = $container.find('.rlh-collapsible-content').first();\n    if (!$content.length) return;\n    const editorHtml = buildRegexEditorHtml(regexItem);\n    $content.stop(true, true);\n    $content.off('input.rlh change.rlh');\n    const bindInputs = () => {\n      $content.on('input.rlh change.rlh', 'input, textarea, select, [contenteditable=\"true\"]', handleEditorInput);\n    };\n    $content.html(editorHtml);\n    $container.attr('data-entry-mode', 'edit');\n    $content.attr('data-entry-mode', 'edit');\n    $container.addClass('rlh-editing');\n    updateRenameButtonState($container, 'edit');\n    const $nameSpan = $container.find('.rlh-item-name').first();\n    if ($nameSpan.length) {\n      $nameSpan.hide().attr('aria-hidden', 'true');\n    }\n    if (!$content.is(':visible')) {\n      if (animate) $content.slideDown(200, bindInputs);\n      else {\n        $content.show();\n        bindInputs();\n      }\n    } else {\n      bindInputs();\n    }\n  };\n\n  const enterLoreEdit = ($container, options = {}) => {\n    const { animate = false, silent = false } = options;\n    if (!$container.length) return false;\n    if (appState.multiSelectMode) {\n      if (!silent) showToast('\u8BF7\u5148\u9000\u51FA\u591A\u9009\u6A21\u5F0F\u540E\u518D\u7F16\u8F91\u3002', 'info');\n      return false;\n    }\n    const bookName = $container.data('book-name');\n    const entryId = Number($container.data('id'));\n    if (!bookName || Number.isNaN(entryId)) return false;\n    const entry = safeGetLorebookEntries(bookName).find(e => e.uid === entryId);\n    if (!entry) return false;\n    renderLoreEntryEditor($container, entry, { animate });\n    return true;\n  };\n\n  const exitLoreEdit = ($container, options = {}) => {\n    const { animate = false } = options;\n    if (!$container.length) return false;\n    const bookName = $container.data('book-name');\n    const entryId = Number($container.data('id'));\n    if (!bookName || Number.isNaN(entryId)) return false;\n    const entry = safeGetLorebookEntries(bookName).find(e => e.uid === entryId);\n    if (!entry) return false;\n    const searchTerm = $container.data('searchTerm') || '';\n    renderLoreEntryViewer($container, entry, searchTerm, { animate });\n    return true;\n  };\n\n  const enterRegexEdit = ($container, options = {}) => {\n    const { animate = false, silent = false } = options;\n    if (!$container.length) return false;\n    if (appState.multiSelectMode) {\n      if (!silent) showToast('\u8BF7\u5148\u9000\u51FA\u591A\u9009\u6A21\u5F0F\u540E\u518D\u7F16\u8F91\u3002', 'info');\n      return false;\n    }\n    const id = $container.data('id');\n    const regexItem = findRegexItemById(id);\n    if (!regexItem) return false;\n    renderRegexEditor($container, regexItem, { animate });\n    return true;\n  };\n\n  const exitRegexEdit = ($container, options = {}) => {\n    const { animate = false } = options;\n    if (!$container.length) return false;\n    const id = $container.data('id');\n    const regexItem = findRegexItemById(id);\n    if (!regexItem) return false;\n    const searchTerm = $container.data('searchTerm') || '';\n    renderRegexViewer($container, regexItem, searchTerm, { animate });\n    return true;\n  };\n\n\n  const handleEntryEnterEdit = errorCatched(async event => {\n    event.preventDefault();\n    event.stopPropagation();\n    const $container = $(event.currentTarget).closest('.rlh-item-container');\n    enterLoreEdit($container, { animate: false });\n  });\n  const handleEntryExitEdit = errorCatched(async event => {\n    event.preventDefault();\n    event.stopPropagation();\n    const $container = $(event.currentTarget).closest('.rlh-item-container');\n    exitLoreEdit($container, { animate: false });\n  });\n  const handleRegexEnterEdit = errorCatched(async event => {\n    event.preventDefault();\n    event.stopPropagation();\n    const $container = $(event.currentTarget).closest('.rlh-item-container');\n    enterRegexEdit($container, { animate: false });\n  });\n  const handleRegexExitEdit = errorCatched(async event => {\n    event.preventDefault();\n    event.stopPropagation();\n    const $container = $(event.currentTarget).closest('.rlh-item-container');\n    exitRegexEdit($container, { animate: false });\n  });\n  const handleToggleState = errorCatched(async event => {\n  event.stopPropagation();\n  const $button = $(event.currentTarget);\n  const $elementToSort = $button.closest('.rlh-book-group, .rlh-item-container');\n  if ($elementToSort.hasClass('renaming')) return;\n  const isEnabling = !$elementToSort.hasClass('enabled');\n  const parentList = $elementToSort.parent();\n  if ($button.hasClass('rlh-global-toggle')) {\n    $button.addClass('rlh-loading');\n    try {\n      const bookName = $elementToSort.data('book-name');\n      const currentBooks = new Set(await TavernAPI.getGlobalWorldbookNames() || []);\n      if (isEnabling) currentBooks.add(bookName);\n      else currentBooks.delete(bookName);\n      await TavernAPI.rebindGlobalWorldbooks(Array.from(currentBooks));\n      await TavernAPI.saveSettings();\n      const bookState = appState.allLorebooks.find(b => b.name === bookName);\n      if (bookState) bookState.enabled = isEnabling;\n    } finally {\n      $button.removeClass('rlh-loading');\n    }\n  } else {\n    const type = $elementToSort.data('type');\n    const id = $elementToSort.data('id');\n    if (type === 'lore') {\n      const bookName = $elementToSort.data('book-name');\n      await updateWorldbookEntries(bookName, [{ uid: Number(id), enabled: isEnabling }]);\n      const entry = safeGetLorebookEntries(bookName).find(e => e.uid === Number(id));\n      if (entry) entry.enabled = isEnabling;\n    } else {\n      const allServerRegexes = await TavernAPI.getRegexes();\n      const regex = allServerRegexes.find(r => r.id === id);\n      if (regex) {\n        regex.enabled = isEnabling;\n        await TavernAPI.replaceRegexes(allServerRegexes.filter(r => r.source !== 'card'));\n        await TavernAPI.saveSettings();\n        const localRegex =\n          appState.regexes.global.find(r => r.id === id) || appState.regexes.character.find(r => r.id === id);\n        if (localRegex) localRegex.enabled = isEnabling;\n      }\n    }\n  }\n  showToast(isEnabling ? '\u5DF2\u542F\u7528' : '\u5DF2\u7981\u7528');\n  $elementToSort.toggleClass('enabled', isEnabling);\n  const items = parentList.children().get();\n  items.sort((a, b) => {\n    const aEnabled = $(a).hasClass('enabled');\n    const bEnabled = $(b).hasClass('enabled');\n    if (aEnabled !== bEnabled) return bEnabled - aEnabled;\n    const aName = $(a).find('.rlh-item-name').text().trim();\n    const bName = $(b).find('.rlh-item-name').text().trim();\n    return aName.localeCompare(bName);\n  });\n  parentList.append(items);\n  });\n  const handleRename = errorCatched(async event => {\n    event.stopPropagation();\n    const $button = $(event.currentTarget);\n    const $container = $button.closest('.rlh-item-container');\n    if (!$container.length) return;\n\n    const type = $container.data('type');\n    const isEditing = $container.attr('data-entry-mode') === 'edit';\n\n    if (isEditing) {\n      exitRenameMode($container);\n      if (type === 'lore') exitLoreEdit($container, { animate: false });\n      else exitRegexEdit($container, { animate: false });\n      return;\n    }\n\n    if (appState.multiSelectMode) {\n      showToast('\u8BF7\u5148\u9000\u51FA\u591A\u9009\u6A21\u5F0F\u540E\u518D\u7F16\u8F91\u3002', 'info');\n      return;\n    }\n\n    const $header = $container.find('.rlh-item-header').first();\n    const $nameSpan = $header.find('.rlh-item-name').first();\n    const oldName = $nameSpan.clone().children().remove().end().text().trim();\n    const renameUIHtml = `<div class=\"rlh-rename-ui\"><div class=\"rlh-rename-input-wrapper\"><input type=\"text\" class=\"rlh-rename-input\" value=\"${escapeHtml(oldName)}\" /><button class=\"rlh-action-btn-icon rlh-rename-save-btn\" title=\"\u786E\u8BA4\"><i class=\"fa-solid fa-check\"></i></button></div></div>`;\n\n    let entered = false;\n    if (type === 'lore') entered = enterLoreEdit($container, { animate: false, silent: true });\n    else entered = enterRegexEdit($container, { animate: false, silent: true });\n    if (!entered) return;\n\n    if (!$header.find('.rlh-rename-ui').length) {\n      $container.addClass('renaming');\n      $header.append(renameUIHtml);\n    }\n\n    $header.find('.rlh-rename-input').focus().select();\n  });\n  const exitRenameMode = ($container, newName = null) => {\n    const $header = $container.find('.rlh-item-header').first();\n    const $nameSpan = $header.find('.rlh-item-name').first();\n    if (newName) {\n      $nameSpan.text(newName);\n    }\n    $header.find('.rlh-rename-ui').remove();\n    if ($nameSpan.length && $container.attr('data-entry-mode') !== 'edit') {\n      $nameSpan.show().removeAttr('aria-hidden');\n    }\n    $container.removeClass('renaming');\n  };\n  const handleConfirmRename = errorCatched(async event => {\n    event.stopPropagation();\n    const $container = $(event.currentTarget).closest('.rlh-item-container');\n    const type = $container.data('type');\n    const exitEditMode = () => {\n      if (type === 'lore') {\n        exitLoreEdit($container, { animate: false });\n      } else {\n        exitRegexEdit($container, { animate: false });\n      }\n    };\n    const $input = $container.find('.rlh-rename-input');\n    const newName = $input.val().trim();\n    const oldName = $container.find('.rlh-item-name').first().text().trim();\n    if (!newName || newName === oldName) {\n      exitRenameMode($container, oldName);\n      exitEditMode();\n      return;\n    }\n    const id = $container.data('id');\n    if (type === 'lore') {\n      const bookName = $container.data('book-name');\n      await updateWorldbookEntries(bookName, [{ uid: Number(id), name: newName }]);\n      const entries = [...safeGetLorebookEntries(bookName)];\n      const entry = entries.find(e => e.uid === Number(id));\n      if (entry) entry.name = newName;\n    } else {\n      // type === 'regex'\n      const allServerRegexes = await TavernAPI.getRegexes();\n      const regex = allServerRegexes.find(r => r.id === id);\n      if (regex) {\n        regex.script_name = newName;\n        await TavernAPI.replaceRegexes(allServerRegexes.filter(r => r.source !== 'card'));\n        await TavernAPI.saveSettings();\n        const localRegex =\n          appState.regexes.global.find(r => r.id === id) || appState.regexes.character.find(r => r.id === id);\n        if (localRegex) localRegex.script_name = newName;\n      }\n    }\n    exitRenameMode($container, newName);\n    exitEditMode();\n    showToast('\u91CD\u547D\u540D\u6210\u529F');\n  });\n\n  const handleRenameKeydown = errorCatched(async event => {\n  if (event.key === 'Enter') {\n    $(event.currentTarget).siblings('.rlh-rename-save-btn').click();\n  } else if (event.key === 'Escape') {\n    event.preventDefault();\n    const $container = $(event.currentTarget).closest('.rlh-item-container');\n    exitRenameMode($container);\n  }\n  });\n  const handleEditorExpandToggle = errorCatched(async event => {\n    event.stopPropagation();\n    const $button = $(event.currentTarget);\n    const $editorWrapper = $button.closest('.rlh-editor-wrapper');\n    // \u540C\u65F6\u5904\u7406 textarea \u548C contenteditable div\uFF0C\u786E\u4FDD\u529F\u80FD\u5728\u4E24\u79CD\u7F16\u8F91\u5668\u4E2D\u90FD\u53EF\u7528\n    const $editors = $editorWrapper.find('textarea, .rlh-edit-content');\n    // \u901A\u8FC7\u68C0\u67E5\u56FE\u6807\u7684 class \u6765\u5224\u65AD\u5F53\u524D\u72B6\u6001\uFF0C\u5B9E\u73B0\u81EA\u5305\u542B\u903B\u8F91\n    const isCollapsed = $button.find('i').hasClass('fa-expand');\n    if (isCollapsed) {\n      // \u5982\u679C\u662F\u6536\u7F29\u72B6\u6001\uFF0C\u5219\u5C55\u5F00\n      $button.attr('title', '\u6536\u7F29').find('i').removeClass('fa-expand').addClass('fa-compress');\n      $editors.each(function () {\n        // \u81EA\u52A8\u8C03\u6574\u9AD8\u5EA6\u4EE5\u9002\u5E94\u5185\u5BB9\n        this.style.height = 'auto';\n        this.style.height = this.scrollHeight + 'px';\n      });\n    } else {\n      // \u5982\u679C\u662F\u5C55\u5F00\u72B6\u6001\uFF0C\u5219\u6536\u7F29\n      $button.attr('title', '\u5C55\u5F00').find('i').removeClass('fa-compress').addClass('fa-expand');\n      $editors.css('height', ''); // \u6062\u590D\u9ED8\u8BA4\u9AD8\u5EA6\n    }\n  });\n  const handleCreateEntry = debounce(errorCatched(async (event) => {\n    const $button = $(event.currentTarget);\n    const explicitBookName = $button.data('book-name');\n    const context = getViewContext();\n    const activeBookName = context.activeBookName ?? appState.activeBookName ?? appState.activeCharacterBook ?? appState.chatLorebook ?? '';\n    const bookName = explicitBookName || activeBookName;\n    if (!bookName) {\n      await showModal({ type: 'alert', title: '\u521B\u5EFA\u5931\u8D25', text: '\u5F53\u524D\u6CA1\u6709\u9009\u4E2D\u7684\u4E16\u754C\u4E66\uFF0C\u65E0\u6CD5\u521B\u5EFA\u6761\u76EE\u3002' });\n      return;\n    }\n    // 1. \u524D\u7AEF\u7ACB\u5373\u54CD\u5E94\uFF1A\u521B\u5EFA\u5185\u5B58\u4E2D\u7684\u4E34\u65F6\u6761\u76EE\n    const tempEntry = createInMemoryEntry(bookName);\n    // 2. \u7ACB\u5373\u6E32\u67D3\u65B0\u6761\u76EE\u5230\u5217\u8868\u9876\u90E8\u5E76\u5C55\u5F00\n    const $newEntryDom = prependEntry(tempEntry, bookName);\n    // \u81EA\u52A8\u89E6\u53D1\u91CD\u547D\u540D\n    if ($newEntryDom && $newEntryDom.length) {\n      const renameButton = $newEntryDom.find('.rlh-rename-btn');\n      if (renameButton.length) {\n        renameButton.trigger('click');\n      }\n    }\n    try {\n      // 3. \u5F02\u6B65\u8C03\u7528API\n      const result = await TavernAPI.createWorldbookEntries(bookName, [{\n        name: tempEntry.name,\n        enabled: tempEntry.enabled,\n        keys: tempEntry.keys,\n      }]);\n      if (result && result.new_entries && result.new_entries.length > 0) {\n        safeSetLorebookEntries(bookName, result.worldbook.map(normalizeWorldbookEntry));\n        const serverEntry = result.new_entries[0];\n        if (serverEntry) {\n          // 4. API\u6210\u529F\u540E\uFF0C\u7528\u771F\u5B9E\u6570\u636E\u66F4\u65B0\u5185\u5B58\u6761\u76EE\u548CDOM\n          updateInMemoryEntry(bookName, tempEntry.uid, serverEntry);\n          const $entryDom = $(`#${'rlh-panel'} .rlh-item-container[data-id=\"${tempEntry.uid}\"]`, parentDoc);\n          if ($entryDom.length) {\n            $entryDom.attr('data-id', serverEntry.uid);\n            $entryDom.data('id', serverEntry.uid); // \u66F4\u65B0jQuery data\n          }\n        }\n        updateBookSummary(bookName);\n        showToast('\u65B0\u6761\u76EE\u5DF2\u521B\u5EFA');\n      } else {\n        throw new Error('API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u4E0D\u6B63\u786E');\n      }\n    } catch (error) {\n      // 5. API\u5931\u8D25\u540E\uFF0C\u663E\u793A\u9519\u8BEF\u5E76\u4FDD\u6301\u524D\u7AEF\u6761\u76EE\u53EF\u7F16\u8F91\n      console.error('[RegexLoreHub] Create entry failed:', error);\n      showModal({ type: 'alert', title: '\u521B\u5EFA\u5931\u8D25', text: `\u521B\u5EFA\u65B0\u6761\u76EE\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u4F46\u60A8\u4ECD\u53EF\u7F16\u8F91\u5F53\u524D\u5185\u5BB9\u5E76\u624B\u52A8\u4FDD\u5B58\u3002\u9519\u8BEF: ${error.message}` });\n    }\n  }), 300);\n  const handleDeleteEntry = errorCatched(async event => {\n  event.stopPropagation();\n  const $item = $(event.currentTarget).closest('.rlh-item-container');\n  const bookName = $item.data('book-name');\n  const uid = Number($item.data('id'));\n  const entryName = $item.find('.rlh-item-name').text().trim();\n  try {\n    await showModal({ type: 'confirm', title: '\u786E\u8BA4\u5220\u9664', text: `\u60A8\u786E\u5B9A\u8981\u5220\u9664\u6761\u76EE \"${entryName}\" \u5417\uFF1F` });\n  } catch {\n    return;\n  }\n  const result = await TavernAPI.deleteWorldbookEntries(bookName, [uid]);\n  // \u4F7F\u7528\u65B0\u7684API\u54CD\u5E94\u7ED3\u6784\n  if (result && result.deleted_entries && result.deleted_entries.length > 0) {\n    safeSetLorebookEntries(bookName, result.worldbook.map(normalizeWorldbookEntry));\n    updateBookSummary(bookName);\n    $item.slideUp(300, () => $item.remove());\n    showToast('\u5220\u9664\u6210\u529F');\n  } else {\n    await showModal({ type: 'alert', title: '\u5220\u9664\u5931\u8D25', text: '\u5220\u9664\u6761\u76EE\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002' });\n  }\n  });\n  const handlePositionChange = errorCatched(async event => {\n  const $select = $(event.currentTarget);\n  const $depthContainer = $select.closest('.rlh-editor-grid').find('.rlh-depth-container');\n  if ($select.val().startsWith('at_depth')) {\n    $depthContainer.slideDown(200);\n  } else {\n    $depthContainer.slideUp(200);\n  }\n  });\n  return {\n    handleToggleState,\n    handleEditorInput,\n    renderLoreEntryViewer,\n    renderLoreEntryEditor,\n    renderRegexViewer,\n    renderRegexEditor,\n    handleEntryEnterEdit,\n    handleEntryExitEdit,\n    handleRegexEnterEdit,\n    handleRegexExitEdit,\n    handleRename,\n    handleConfirmRename,\n    handleRenameKeydown,\n    handleEditorExpandToggle,\n    handleCreateEntry,\n    handleDeleteEntry,\n    handlePositionChange,\n  };\n}\n", "import {\n  buildSearchRegex,\n  PANEL_ID,\n  BUTTON_ID,\n  SEARCH_INPUT_ID,\n  REPLACE_INPUT_ID,\n  CREATE_LOREBOOK_BTN_ID,\n  TOGGLE_COLLAPSE_BTN_ID,\n  appState,\n  DOM_ID,\n  safeGetLorebookEntries,\n  safeSetLorebookEntries,\n  safeDeleteLorebookEntries,\n  errorCatched,\n  showModal,\n  showToast,\n  showProgressToast,\n  get$,\n  getParentDoc,\n  escapeHtml,\n  SORT_MENU_ID,\n  SORT_MENU_BUTTON_ID,\n  POSITION_MENU_ID,\n  POSITION_MENU_BUTTON_ID,\n  UNIFIED_STATUS_MENU_ID,\n  UNIFIED_STATUS_BUTTON_ID,\n  WORLD_BOOK_STATUS_LIST,\n  DEFAULT_WORLD_BOOK_STATUS,\n  resolveWorldbookStatus,\n  decodeSelectionPart,\n  buildBookSelectionKey,\n  buildLoreSelectionKey,\n  buildLoreSelectionPrefix,\n  buildRegexSelectionKey,\n  THEME_MENU_WRAPPER_ID,\n  THEME_MENU_ID,\n  THEME_TOGGLE_BTN_ID,\n  THEME_OPTION_CLASS,\n  setActiveTheme,\n  getActiveTheme,\n} from '../../core.js';\n\nimport {\n  TavernAPI,\n  loadAllData,\n  loadLorebookEntriesIfNeeded,\n  saveAllChanges,\n  syncContextWithAppState,\n  refreshCharacterData,\n  updateBookSummary,\n  normalizeWorldbookEntry,\n  updateWorldbookEntries,\n  updateWorldbookEntriesStatus,\n  updateRegexOrderMetadata,\n  saveThemePreference,\n} from '../../dataLayer.js';\n\nimport { renderContent, getViewContext, getContextInstanceKey } from '../render/index.js';\nimport { getGlobalLorebookMatches } from '../render/lorebook.js';\nimport { getRegexMatches } from '../render/regex.js';\nimport {\n  updateSelectionCount,\n  setActiveCollapseState,\n  setActiveSortMode,\n  buildReplaceConfirmationHTML,\n  updateEntryStatusDom,\n} from '../render/shared.js';\n\n/**\n * \u663E\u793A\u4E00\u4E2A\u786E\u8BA4\u5F39\u7A97\uFF0C\u8BE6\u7EC6\u5217\u51FA\u5C06\u88AB\u66FF\u6362\u7684\u4E16\u754C\u4E66\u53CA\u5176\u6761\u76EE\u3002\n * @param {Array<object>} matches - \u5339\u914D\u9879\u6570\u7EC4\u3002\n * @param {object} stats - \u5206\u7C7B\u7EDF\u8BA1\u5BF9\u8C61\u3002\n * @param {string} searchTerm - \u8981\u641C\u7D22\u7684\u8BCD\u3002\n * @param {string} replaceTerm - \u7528\u4E8E\u66FF\u6362\u7684\u8BCD\u3002\n * @returns {Promise<boolean>} - \u7528\u6237\u786E\u8BA4\u5219 resolve(true)\uFF0C\u5426\u5219 reject\u3002\n */\nconst showReplaceConfirmationModal = (matches, stats, booksMatchedByNameOnly, searchTerm, replaceTerm, context) => {\n\n  const modalContent = buildReplaceConfirmationHTML(matches, stats, booksMatchedByNameOnly, searchTerm, replaceTerm, context);\n\n  // 2. \u8C03\u7528\u6838\u5FC3 showModal\n  return showModal({\n    type: 'confirm',\n    title: '\u786E\u8BA4\u66FF\u6362',\n    html: modalContent,\n  });\n};\n\n// \u9876\u90E8\u5DE5\u5177\u680F\u6298\u53E0/\u5C55\u5F00\u6309\u94AE\nexport const toggleToolbar = errorCatched(async event => {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\n  if (!$panel.length) return;\n\n  let $toolbarShell = $panel.find(`#${DOM_ID.TOOLBAR_SHELL}`);\n  if (!$toolbarShell.length) {\n    $toolbarShell = $panel.find('.rlh-toolbar-shell').first();\n    if ($toolbarShell.length) {\n      $toolbarShell.attr('id', DOM_ID.TOOLBAR_SHELL);\n    }\n  }\n  if (!$toolbarShell.length) return;\n\n  const willCollapse = !$toolbarShell.hasClass('rlh-toolbar-shell--collapsed');\n\n  event?.preventDefault?.();\n  event?.stopPropagation?.();\n\n  $toolbarShell.toggleClass('rlh-toolbar-shell--collapsed', willCollapse);\n  $toolbarShell.attr('aria-hidden', String(willCollapse));\n\n  appState.isToolbarCollapsed = willCollapse;\n\n  const $toggleButton = event?.currentTarget ? $(event.currentTarget) : $panel.find(`#${DOM_ID.TOGGLE_TOOLBAR_BTN}`);\n  if ($toggleButton.length) {\n    $toggleButton.text(willCollapse ? '\u5C55\u5F00\u5DE5\u5177\u680F' : '\u6298\u53E0\u5DE5\u5177\u680F');\n    $toggleButton.attr('aria-expanded', String(!willCollapse));\n    $toggleButton.attr('title', willCollapse ? '\u5C55\u5F00\u5DE5\u5177\u680F' : '\u6298\u53E0\u5DE5\u5177\u680F');\n  }\n});\n// --- UI \u4E8B\u4EF6\u5904\u7406 ---\nexport function createUIHandlers(deps = {}) {\n  const $ = deps.$ ?? get$();\n  const parentDoc = deps.parentDoc ?? getParentDoc();\n  const lorebookHandlers = deps.lorebookHandlers;\n  const itemHandlers = deps.itemHandlers;\n  const getTargetKeyPrefix = () => {\n    switch (appState.multiSelectTarget) {\n      case 'book':\n        return 'book:';\n      case 'entry':\n        return 'lore:';\n      case 'regex':\n        return 'regex:';\n      default:\n        return '';\n    }\n  };\n\n  const parseSelectionKey = rawKey => {\n    const key = String(rawKey ?? '');\n    const firstSepIndex = key.indexOf(':');\n    if (firstSepIndex === -1) {\n      return { type: key, raw: '' };\n    }\n\n    const type = key.slice(0, firstSepIndex);\n    const remainder = key.slice(firstSepIndex + 1);\n\n    if (type === 'book') {\n      return { type, bookName: decodeSelectionPart(remainder) };\n    }\n\n    if (type === 'lore') {\n      const lastSepIndex = remainder.lastIndexOf(':');\n      if (lastSepIndex === -1) {\n        return { type, bookName: decodeSelectionPart(remainder), entryId: null };\n      }\n      const rawBook = remainder.slice(0, lastSepIndex);\n      const rawEntryId = remainder.slice(lastSepIndex + 1);\n      return {\n        type,\n        bookName: decodeSelectionPart(rawBook),\n        entryId: decodeSelectionPart(rawEntryId),\n      };\n    }\n\n    if (type === 'regex') {\n      return { type, regexId: decodeSelectionPart(remainder) };\n    }\n\n    return { type, raw: remainder };\n  };\n\n  const getUnifiedStatusElements = () => ({\n    $menu: $(`#${UNIFIED_STATUS_MENU_ID}`, parentDoc),\n    $button: $(`#${UNIFIED_STATUS_BUTTON_ID}`, parentDoc),\n  });\n\n  const getSelectedEntriesByBook = () => {\n    const selectedEntriesByBook = new Map();\n    for (const itemKey of appState.selectedItems) {\n      const { type, bookName, entryId } = parseSelectionKey(itemKey);\n      if (type === 'lore' && bookName) {\n        const numericId = Number(entryId);\n        const uid = Number.isFinite(numericId) ? numericId : entryId;\n        if (uid === null || uid === undefined || uid === '') continue;\n        if (!selectedEntriesByBook.has(bookName)) selectedEntriesByBook.set(bookName, []);\n        selectedEntriesByBook.get(bookName).push(uid);\n      }\n    }\n    return selectedEntriesByBook;\n  };\n\n  let unifiedStatusMenuListenersActive = false;\n\n  function closeUnifiedStatusMenu() {\n    const { $menu, $button } = getUnifiedStatusElements();\n    if ($menu.length) {\n      $menu.attr('data-open', 'false');\n    }\n    if ($button.length) {\n      $button.attr('aria-expanded', 'false');\n    }\n    if (unifiedStatusMenuListenersActive) {\n      $(parentDoc).off('click.rlhUnifiedStatus', handleUnifiedStatusMenuOutsideClick);\n      unifiedStatusMenuListenersActive = false;\n    }\n  }\n\n  function handleUnifiedStatusMenuOutsideClick(event) {\n    const { $menu, $button } = getUnifiedStatusElements();\n    if (!$menu.length) return;\n    const $target = $(event.target);\n    if ($target.closest(`#${UNIFIED_STATUS_MENU_ID}`).length) return;\n    if ($button.length && $target.closest(`#${UNIFIED_STATUS_BUTTON_ID}`).length) return;\n    closeUnifiedStatusMenu();\n  }\n\n  function openUnifiedStatusMenu() {\n    const { $menu, $button } = getUnifiedStatusElements();\n    if (!$menu.length || !$button.length) return;\n    $menu.attr('data-open', 'true');\n    $button.attr('aria-expanded', 'true');\n    if (!unifiedStatusMenuListenersActive) {\n      $(parentDoc).on('click.rlhUnifiedStatus', handleUnifiedStatusMenuOutsideClick);\n      unifiedStatusMenuListenersActive = true;\n    }\n  }\n\n  const updateUnifiedStatusButtonState = () => {\n    const { $menu, $button } = getUnifiedStatusElements();\n    if (!$button.length) return;\n    const context = getViewContext();\n    const isEntryContext = context?.type === 'lore';\n    if (!isEntryContext) {\n      $button.attr('disabled', 'disabled').attr('title', '\u7EDF\u4E00\u72B6\u6001\u4EC5\u5728\u6761\u76EE\u89C6\u56FE\u53EF\u7528');\n      if ($menu.length && $menu.attr('data-open') === 'true') closeUnifiedStatusMenu();\n      return;\n    }\n\n    const fallbackNames = [\n      context?.activeBookName,\n      appState.activeBookName,\n      appState.activeCharacterBook,\n      appState.chatLorebook,\n    ];\n    let resolvedBookName =\n      fallbackNames.find(name => typeof name === 'string' && name.trim().length > 0)?.toString().trim() ?? '';\n\n    const selectedEntriesMap = getSelectedEntriesByBook();\n    if (!resolvedBookName && selectedEntriesMap.size === 1) {\n      resolvedBookName = [...selectedEntriesMap.keys()][0] ?? '';\n    }\n    const entries = resolvedBookName ? safeGetLorebookEntries(resolvedBookName) : [];\n    const hasEntries = entries.length > 0;\n\n    const isEntryMultiSelect = appState.multiSelectMode && appState.multiSelectTarget === 'entry';\n    let selectedTotal = 0;\n    selectedEntriesMap.forEach(list => {\n      if (Array.isArray(list)) selectedTotal += list.length;\n    });\n    const shouldEnable = isEntryMultiSelect ? selectedTotal > 0 : hasEntries;\n\n    let tooltip;\n    if (isEntryMultiSelect) {\n      tooltip = selectedTotal > 0\n        ? `\u591A\u9009\u6A21\u5F0F\uFF1A\u5C06\u5BF9\u5DF2\u9009\u4E2D\u7684 ${selectedTotal} \u4E2A\u6761\u76EE\u7EDF\u4E00\u72B6\u6001`\n        : '\u5DF2\u5F00\u542F\u591A\u9009\uFF0C\u8BF7\u5148\u52FE\u9009\u8981\u8C03\u6574\u72B6\u6001\u7684\u6761\u76EE';\n    } else if (hasEntries) {\n      tooltip = `\u5C06\u5BF9\u300C${resolvedBookName || '\u5F53\u524D\u4E16\u754C\u4E66'}\u300D\u7684\u6240\u6709\u6761\u76EE\u7EDF\u4E00\u72B6\u6001`;\n    } else {\n      tooltip = resolvedBookName ? `\u300C${resolvedBookName}\u300D\u6682\u65E0\u6761\u76EE\u53EF\u8C03\u6574` : '\u8BF7\u5148\u6253\u5F00\u9700\u8981\u7EDF\u4E00\u72B6\u6001\u7684\u4E16\u754C\u4E66';\n    }\n\n    $button.attr('title', tooltip);\n    if (shouldEnable) {\n      $button.removeAttr('disabled');\n    } else {\n      $button.attr('disabled', 'disabled');\n      if ($menu.length && $menu.attr('data-open') === 'true') closeUnifiedStatusMenu();\n    }\n  };\n\n  const updatePositionButtonState = () => {\n    const { $menu, $button } = getPositionMenuElements();\n    if (!$button.length) return;\n    const context = getViewContext();\n\n    const fallbackNames = [\n      context?.activeBookName,\n      appState.activeBookName,\n      appState.activeCharacterBook,\n      appState.chatLorebook,\n    ];\n    let resolvedBookName =\n      fallbackNames.find(name => typeof name === 'string' && name.trim().length > 0)?.toString().trim() ?? '';\n\n    const selectedEntriesMap = getSelectedEntriesByBook();\n    if (!resolvedBookName && selectedEntriesMap.size === 1) {\n      resolvedBookName = [...selectedEntriesMap.keys()][0] ?? '';\n    }\n\n    const entries = resolvedBookName ? safeGetLorebookEntries(resolvedBookName) : [];\n    const hasEntries = entries.length > 0;\n    const isEntryMultiSelect = appState.multiSelectMode && appState.multiSelectTarget === 'entry';\n    let selectedTotal = 0;\n    selectedEntriesMap.forEach(list => {\n      if (Array.isArray(list)) selectedTotal += list.length;\n    });\n    const shouldEnable = isEntryMultiSelect ? selectedTotal > 0 : hasEntries;\n\n    let tooltip;\n    if (isEntryMultiSelect) {\n      tooltip = selectedTotal > 0\n        ? `\u591A\u9009\u6A21\u5F0F\uFF1A\u5C06\u5BF9\u5DF2\u9009\u4E2D\u7684 ${selectedTotal} \u4E2A\u6761\u76EE\u7EDF\u4E00\u4F4D\u7F6E`\n        : '\u5DF2\u5F00\u542F\u591A\u9009\uFF0C\u8BF7\u5148\u52FE\u9009\u8981\u8C03\u6574\u4F4D\u7F6E\u7684\u6761\u76EE';\n    } else if (hasEntries) {\n      tooltip = `\u5C06\u5BF9\u300C${resolvedBookName || '\u5F53\u524D\u4E16\u754C\u4E66'}\u300D\u7684\u6240\u6709\u6761\u76EE\u7EDF\u4E00\u4F4D\u7F6E`;\n    } else {\n      tooltip = resolvedBookName ? `\u300C${resolvedBookName}\u300D\u6682\u65E0\u6761\u76EE\u53EF\u8C03\u6574` : '\u8BF7\u5148\u6253\u5F00\u9700\u8981\u7EDF\u4E00\u4F4D\u7F6E\u7684\u4E16\u754C\u4E66';\n    }\n\n    $button.attr('title', tooltip);\n    if (shouldEnable) {\n      $button.removeAttr('disabled');\n    } else {\n      $button.attr('disabled', 'disabled');\n      if ($menu.length) $menu.attr('data-open', 'false');\n    }\n  };\n\n  const syncToolbarState = () => {\n    updateSelectionCount();\n    updateUnifiedStatusButtonState();\n    updatePositionButtonState();\n  };\n\n  const getVisibleSelectKeys = () => {\n    if (!appState.multiSelectMode) return [];\n    const $panel = $(`#${PANEL_ID}`, parentDoc);\n    if (!$panel.length) return [];\n\n    let selector;\n    switch (appState.multiSelectTarget) {\n      case 'book':\n        selector = '.rlh-book-group[data-select-key]';\n        break;\n      case 'entry':\n        selector = '.rlh-item-container[data-select-key][data-type=\"lore\"]';\n        break;\n      case 'regex':\n        selector = '.rlh-item-container[data-select-key][data-type=\"regex\"]';\n        break;\n      default:\n        selector = '[data-select-key]';\n        break;\n    }\n\n    const keys = [];\n    $panel.find(selector).each((_, el) => {\n      const $el = $(el);\n      if (!$el.is(':visible')) return;\n      const key = $el.data('select-key');\n      if (key) keys.push(String(key));\n    });\n    return keys;\n  };\n\n  const hasSelectionForCurrentTarget = () => {\n    if (!appState.selectedItems || appState.selectedItems.size === 0) return false;\n    const prefix = getTargetKeyPrefix();\n    if (!prefix) return appState.selectedItems.size > 0;\n    for (const key of appState.selectedItems) {\n      if (key.startsWith(prefix)) return true;\n    }\n    return false;\n  };\n\n  const resolveSelectionKey = $container => {\n    if (!$container || !$container.length) return null;\n    if ($container.hasClass('rlh-book-group')) {\n      if (appState.multiSelectTarget !== 'book') return null;\n      const bookName = $container.data('book-name');\n      return bookName ? buildBookSelectionKey(bookName) : null;\n    }\n    if ($container.hasClass('rlh-item-container')) {\n      const itemType = $container.data('type');\n      const itemId = $container.data('id');\n      if (itemType === 'lore' && appState.multiSelectTarget === 'entry') {\n        const bookName = $container.data('book-name');\n        return bookName != null && itemId != null ? buildLoreSelectionKey(bookName, itemId) : null;\n      }\n      if (itemType === 'regex' && appState.multiSelectTarget === 'regex') {\n        return itemId != null ? buildRegexSelectionKey(itemId) : null;\n      }\n    }\n    return null;\n  };\n\n  const toggleSelectionForContainer = $container => {\n    const itemKey = resolveSelectionKey($container);\n    if (!itemKey) return false;\n    if (appState.selectedItems.has(itemKey)) {\n      appState.selectedItems.delete(itemKey);\n      $container.removeClass('selected');\n      $container.find('.rlh-multi-select-checkbox').prop('checked', false);\n    } else {\n      appState.selectedItems.add(itemKey);\n      $container.addClass('selected');\n      $container.find('.rlh-multi-select-checkbox').prop('checked', true);\n    }\n    syncToolbarState();\n    return true;\n  };\n\n  const handleGlobalSearch = errorCatched(async (event) => {\n    const $target = $(event.currentTarget);\n    const value = $target.val();\n\n    if ($target.attr('id') === 'rlh-global-search-input') {\n        appState.globalSearch.term = value;\n    } else if ($target.attr('id') === 'rlh-global-replace-input') {\n        appState.globalSearch.replace = value;\n    }\n\n    // \u4EC5\u5F53\u641C\u7D22\u8BCD\u53D8\u5316\u65F6\u624D\u91CD\u7ED8\u4EE5\u5E94\u7528\u9AD8\u4EAE\n    if ($target.attr('id') === 'rlh-global-search-input') {\n        renderContent();\n    }\n  });\n  const handleSearchInputKeydown = errorCatched(async event => {\n    if (event.key === 'Enter') {\n      event.preventDefault();\n      const term = event.currentTarget.value ?? '';\n      appState.globalSearch.term = term;\n      renderContent();\n    }\n  });\n\n  const normalizeBookNames = (names = []) => {\n    const unique = new Set();\n    names.forEach(name => {\n      if (typeof name !== 'string') return;\n      const trimmed = name.trim();\n      if (trimmed) unique.add(trimmed);\n    });\n    return Array.from(unique);\n  };\n\n  const ensureEntriesLoadedForBooks = async names => {\n    const targets = normalizeBookNames(names);\n    if (!targets.length) return true;\n\n    const pending = targets.filter(name => {\n      const meta = appState.allLorebooks.find(book => book.name === name);\n      if (meta?.entriesLoaded) return false;\n      const cachedEntries = safeGetLorebookEntries(name);\n      return !Array.isArray(cachedEntries) || cachedEntries.length === 0;\n    });\n\n    if (!pending.length) return true;\n\n    const progressToast = showProgressToast(`\u6B63\u5728\u52A0\u8F7D ${pending.length} \u672C\u4E16\u754C\u4E66\u7684\u6761\u76EE...`);\n    try {\n      await Promise.all(pending.map(name => loadLorebookEntriesIfNeeded(name)));\n      progressToast.remove();\n      return true;\n    } catch (error) {\n      progressToast.remove();\n      console.error('[RegexLoreHub] Failed to load entries before replace:', error);\n      await showModal({\n        type: 'alert',\n        title: '\u52A0\u8F7D\u5931\u8D25',\n        text: '\u5728\u6267\u884C\u66FF\u6362\u524D\u52A0\u8F7D\u4E16\u754C\u4E66\u6761\u76EE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002',\n      });\n      return false;\n    }\n  };\n\n  const handleSearchClear = errorCatched(async () => {\n    const $input = $(`#${SEARCH_INPUT_ID}`, parentDoc);\n    if ($input.length) $input.val('');\n    appState.globalSearch.term = '';\n    renderContent();\n  });\n\n  const handleReplace = errorCatched(async () => {\n    const searchTerm = $(`#${SEARCH_INPUT_ID}`, parentDoc).val();\n    const replaceTerm = $(`#${REPLACE_INPUT_ID}`, parentDoc).val();\n    const context = getViewContext();\n\n    if (!searchTerm) {\n      await showModal({ type: 'alert', title: '\u66FF\u6362\u5931\u8D25', text: '\u8BF7\u5148\u8F93\u5165\u641C\u7D22\u8BCD\u3002' });\n      return;\n    }\n\n    // \u66FF\u6362\u8BCD\u53EF\u4EE5\u4E3A\u7A7A\uFF0C\u8868\u793A\u5220\u9664\n    // if (!replaceTerm) {\n    //   await showModal({ type: 'alert', title: '\u66FF\u6362\u5931\u8D25', text: '\u8BF7\u5148\u8F93\u5165\u66FF\u6362\u8BCD\u3002' });\n    //   return;\n    // }\n\n    // \u6838\u5FC3\u903B\u8F91\uFF1A\u5728\u5168\u5C40\u641C\u7D22\u524D\uFF0C\u786E\u4FDD\u6240\u6709\u4E16\u754C\u4E66\u6761\u76EE\u5DF2\u52A0\u8F7D\n    if (context.view === 'global-lore-list') {\n      const booksToLoad = appState.allLorebooks.filter(b => !b.entriesLoaded);\n      if (booksToLoad.length > 0) {\n        const progressToast = showProgressToast(`\u6B63\u5728\u52A0\u8F7D ${booksToLoad.length} \u672C\u4E16\u754C\u4E66\u7684\u6761\u76EE...`);\n        try {\n          await Promise.all(booksToLoad.map(b => loadLorebookEntriesIfNeeded(b.name)));\n          progressToast.remove();\n        } catch (error) {\n          progressToast.remove();\n          console.error('[RegexLoreHub] Failed to load entries before replace:', error);\n          await showModal({\n            type: 'alert',\n            title: '\u52A0\u8F7D\u5931\u8D25',\n            text: '\u5728\u6267\u884C\u66FF\u6362\u524D\u52A0\u8F7D\u4E16\u754C\u4E66\u6761\u76EE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002',\n          });\n          return;\n        }\n      }\n    }\n\n    let matches, stats, booksMatchedByNameOnly;\n    let modalContext;\n\n    if (context.type === 'lore') {\n      modalContext = { type: 'lorebook', bookNames: [] };\n\n      if (context.view === 'global-lore-list') {\n        ({ matches, stats, booksMatchedByNameOnly } = getGlobalLorebookMatches(searchTerm));\n      } else if (context.view === 'global-lore-detail') {\n        const activeName = normalizeBookNames([context.activeBookName]);\n        if (!activeName.length) {\n          await showModal({ type: 'alert', title: '\u64CD\u4F5C\u65E0\u6548', text: '\u8BF7\u5148\u9009\u62E9\u8981\u66FF\u6362\u7684\u4E16\u754C\u4E66\u3002' });\n          return;\n        }\n        if (!(await ensureEntriesLoadedForBooks(activeName))) return;\n        ({ matches, stats, booksMatchedByNameOnly } = getGlobalLorebookMatches(searchTerm, false, { bookNames: activeName }));\n        modalContext.bookNames = activeName;\n      } else if (context.id === 'char-lore') {\n        const activeNames = normalizeBookNames([context.activeBookName, appState.activeCharacterBook]);\n        if (!activeNames.length) {\n          await showModal({ type: 'alert', title: '\u64CD\u4F5C\u65E0\u6548', text: '\u5F53\u524D\u6CA1\u6709\u53EF\u7528\u7684\u89D2\u8272\u4E16\u754C\u4E66\uFF0C\u65E0\u6CD5\u6267\u884C\u66FF\u6362\u3002' });\n          return;\n        }\n        if (!(await ensureEntriesLoadedForBooks(activeNames))) return;\n        ({ matches, stats, booksMatchedByNameOnly } = getGlobalLorebookMatches(searchTerm, false, { bookNames: activeNames }));\n        modalContext.bookNames = activeNames;\n      } else if (context.id === 'chat-lore') {\n        const activeNames = normalizeBookNames([context.activeBookName, appState.chatLorebook]);\n        if (!activeNames.length) {\n          await showModal({ type: 'alert', title: '\u64CD\u4F5C\u65E0\u6548', text: '\u5F53\u524D\u6CA1\u6709\u53EF\u7528\u7684\u804A\u5929\u4E16\u754C\u4E66\uFF0C\u65E0\u6CD5\u6267\u884C\u66FF\u6362\u3002' });\n          return;\n        }\n        if (!(await ensureEntriesLoadedForBooks(activeNames))) return;\n        ({ matches, stats, booksMatchedByNameOnly } = getGlobalLorebookMatches(searchTerm, false, { bookNames: activeNames }));\n        modalContext.bookNames = activeNames;\n      } else {\n        await showModal({ type: 'alert', title: '\u64CD\u4F5C\u65E0\u6548', text: '\u5F53\u524D\u89C6\u56FE\u4E0D\u652F\u6301\u66FF\u6362\u529F\u80FD\u3002' });\n        return;\n      }\n    } else if (context.type === 'regex') {\n      ({ matches, stats } = getRegexMatches(searchTerm));\n      modalContext = 'regex';\n    } else {\n      await showModal({ type: 'alert', title: '\u64CD\u4F5C\u65E0\u6548', text: '\u672A\u77E5\u7684\u89C6\u56FE\u7C7B\u578B\uFF0C\u65E0\u6CD5\u6267\u884C\u66FF\u6362\u3002' });\n      return;\n    }\n\n    if ((!matches || matches.length === 0) && (!booksMatchedByNameOnly || booksMatchedByNameOnly.length === 0)) {\n      await showModal({ type: 'alert', title: '\u65E0\u5339\u914D\u9879', text: '\u672A\u627E\u5230\u53EF\u66FF\u6362\u7684\u6761\u76EE\u3002' });\n      return;\n    }\n\n    try {\n      // \u4F7F\u7528\u65B0\u7684\u8BE6\u7EC6\u786E\u8BA4\u5F39\u7A97\uFF0C\u5E76\u4F20\u9012 stats \u5BF9\u8C61\n      await showReplaceConfirmationModal(matches, stats, booksMatchedByNameOnly, searchTerm, replaceTerm, modalContext);\n\n      // \u7528\u6237\u786E\u8BA4\u540E\u6267\u884C\u66FF\u6362\n      const progressToast = showProgressToast('\u6B63\u5728\u6267\u884C\u66FF\u6362...');\n      try {\n        await performReplace(matches, searchTerm, replaceTerm);\n        progressToast.remove();\n        showToast('\u66FF\u6362\u5B8C\u6210');\n        renderContent(); // \u5237\u65B0\u89C6\u56FE\n      } catch (error) {\n        progressToast.remove();\n        console.error('[RegexLoreHub] Replace error:', error);\n        await showModal({\n          type: 'alert',\n          title: '\u66FF\u6362\u5931\u8D25',\n          text: '\u66FF\u6362\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u3002',\n        });\n      }\n    } catch (error) {\n      // \u7528\u6237\u5728\u786E\u8BA4\u5F39\u7A97\u4E2D\u70B9\u51FB\u4E86\u201C\u53D6\u6D88\u201D\uFF0C\u65E0\u9700\u4EFB\u4F55\u64CD\u4F5C\n      console.log('[RegexLoreHub] Replace operation cancelled by user.');\n    }\n  });\n  const handleToolbarToggleCollapse = errorCatched(async () => {\n    const context = getViewContext();\n    if (!context.showCollapseToggle) return;\n\n    const key = getContextInstanceKey(context);\n    const current = appState.collapseStateByContext.get(key) ?? 'expanded';\n    const nextState = current === 'collapsed' ? 'expanded' : 'collapsed';\n    setActiveCollapseState(context, nextState);\n\n    // \u67E5\u627E\u6240\u6709\u53EF\u89C1\u7684\u3001\u53EF\u6298\u53E0\u7684\u9876\u5C42\u5143\u7D20\n    const $containers = $(\n      `#${PANEL_ID}-content .rlh-item-container:visible, #${PANEL_ID}-content .rlh-book-group:visible`,\n      parentDoc,\n    );\n\n    $containers.each(function () {\n      const $container = $(this);\n      const $content = $container.find('.rlh-collapsible-content').first();\n      const isCurrentlyVisible = $content.is(':visible');\n      const $header = $container.find('.rlh-item-header, .rlh-global-book-header').first();\n\n      // \u5982\u679C\u9700\u8981\u5C55\u5F00\u4F46\u5F53\u524D\u662F\u6298\u53E0\u7684\uFF0C\u5219\u89E6\u53D1\u70B9\u51FB\uFF08\u5E26\u6279\u91CF\u64CD\u4F5C\u6807\u8BB0\uFF09\n      if (nextState === 'expanded' && !isCurrentlyVisible) {\n        $header.trigger('click.rlh', { bulk: true });\n      }\n      // \u5982\u679C\u9700\u8981\u6298\u53E0\u4F46\u5F53\u524D\u662F\u5C55\u5F00\u7684\uFF0C\u4E5F\u89E6\u53D1\u70B9\u51FB\n      else if (nextState === 'collapsed' && isCurrentlyVisible) {\n        $header.trigger('click.rlh', { bulk: true });\n      }\n    });\n\n    // \u624B\u52A8\u66F4\u65B0\u6309\u94AE\u72B6\u6001\u4EE5\u907F\u514D\u5B8C\u5168\u91CD\u7ED8\n    const $button = $(`#${TOGGLE_COLLAPSE_BTN_ID}`, parentDoc);\n    if ($button.length) {\n      const iconClass = nextState === 'collapsed' ? 'fa-expand-arrows-alt' : 'fa-compress-arrows-alt';\n      const label = nextState === 'collapsed' ? '\u5168\u90E8\u5C55\u5F00' : '\u5168\u90E8\u6298\u53E0';\n      $button.attr('data-collapse-state', nextState);\n      $button.find('i').removeClass('fa-expand-arrows-alt fa-compress-arrows-alt').addClass(iconClass);\n      $button.find('span').text(label);\n    }\n  });\n\n\n\n\n  let sortMenuListenersActive = false;\n\n  function getSortMenuElements() {\n    return {\n      $menu: $(`#${SORT_MENU_ID}`, parentDoc),\n      $button: $(`#${SORT_MENU_BUTTON_ID}`, parentDoc),\n    };\n  }\n\n  function handleSortMenuOutsideClick(event) {\n    if (!sortMenuListenersActive) return;\n    const $target = $(event.target);\n    if ($target.closest(`#${SORT_MENU_ID}`).length) return;\n    if ($target.closest(`#${SORT_MENU_BUTTON_ID}`).length) return;\n    closeSortMenu();\n  }\n\n  function handleSortMenuKeydown(event) {\n    if (event.key !== 'Escape') return;\n    const { $button } = getSortMenuElements();\n    closeSortMenu();\n    if ($button.length) {\n      $button.trigger('focus');\n    }\n  }\n\n  function attachSortMenuListeners() {\n    if (sortMenuListenersActive) return;\n    $(parentDoc).on('click.rlhSortMenu', handleSortMenuOutsideClick);\n    $(parentDoc).on('keydown.rlhSortMenu', handleSortMenuKeydown);\n    sortMenuListenersActive = true;\n  }\n\n  function detachSortMenuListeners() {\n    if (!sortMenuListenersActive) return;\n    $(parentDoc).off('click.rlhSortMenu', handleSortMenuOutsideClick);\n    $(parentDoc).off('keydown.rlhSortMenu', handleSortMenuKeydown);\n    sortMenuListenersActive = false;\n  }\n\n  function closeSortMenu() {\n    const { $menu, $button } = getSortMenuElements();\n    if (!$menu.length) return;\n    $menu.attr('data-open', 'false').removeClass('open');\n    if ($button.length) {\n      $button.attr('aria-expanded', 'false');\n    }\n    detachSortMenuListeners();\n  }\n\n  function openSortMenu() {\n    const { $menu, $button } = getSortMenuElements();\n    if (!$menu.length) return;\n    $menu.attr('data-open', 'true').addClass('open');\n    if ($button.length) {\n      $button.attr('aria-expanded', 'true');\n    }\n    attachSortMenuListeners();\n  }\n\n  const handleSortMenuToggle = errorCatched(async event => {\n    event.preventDefault();\n    event.stopPropagation();\n    const { $menu } = getSortMenuElements();\n    if (!$menu.length) return;\n    const isOpen = $menu.attr('data-open') === 'true';\n    if (isOpen) closeSortMenu();\n  else openSortMenu();\n});\n\n\n\n  const handleSortOptionSelect = errorCatched(async event => {\n    event.preventDefault();\n    const sortValue = $(event.currentTarget).data('sort-value');\n    if (!sortValue) return;\n    closeSortMenu();\n    const context = getViewContext();\n    setActiveSortMode(context, sortValue);\n    renderContent();\n  });\n\n\n\n  let themeMenuListenersActive = false;\n\n  const getThemeMenuElements = () => ({\n    $wrapper: $(`#${THEME_MENU_WRAPPER_ID}`, parentDoc),\n    $menu: $(`#${THEME_MENU_ID}`, parentDoc),\n    $button: $(`#${THEME_TOGGLE_BTN_ID}`, parentDoc),\n  });\n\n  function handleThemeMenuOutsideClick(event) {\n    if (!themeMenuListenersActive) return;\n    const { $wrapper } = getThemeMenuElements();\n    if (!$wrapper.length) return;\n    const target = event?.target ?? null;\n    if (target && $wrapper[0]?.contains(target)) return;\n    closeThemeMenu();\n  }\n\n  function handleThemeMenuKeydown(event) {\n    if (event.key !== 'Escape') return;\n    const { $button } = getThemeMenuElements();\n    closeThemeMenu();\n    if ($button.length) {\n      $button.trigger('focus');\n    }\n  }\n\n  function attachThemeMenuListeners() {\n    if (themeMenuListenersActive) return;\n    $(parentDoc).on('click.rlhThemeMenu', handleThemeMenuOutsideClick);\n    $(parentDoc).on('keydown.rlhThemeMenu', handleThemeMenuKeydown);\n    themeMenuListenersActive = true;\n  }\n\n  function detachThemeMenuListeners() {\n    if (!themeMenuListenersActive) return;\n    $(parentDoc).off('click.rlhThemeMenu', handleThemeMenuOutsideClick);\n    $(parentDoc).off('keydown.rlhThemeMenu', handleThemeMenuKeydown);\n    themeMenuListenersActive = false;\n  }\n\n  function closeThemeMenu() {\n    const { $wrapper, $menu, $button } = getThemeMenuElements();\n    if ($wrapper.length) {\n      $wrapper.removeClass('open');\n    }\n    if ($menu.length) {\n      $menu.attr('data-open', 'false');\n    }\n    if ($button.length) {\n      $button.attr('aria-expanded', 'false');\n    }\n    detachThemeMenuListeners();\n  }\n\n  function openThemeMenu() {\n    const { $wrapper, $menu, $button } = getThemeMenuElements();\n    if (!$wrapper.length || !$menu.length) return;\n    $wrapper.addClass('open');\n    $menu.attr('data-open', 'true');\n    if ($button.length) {\n      $button.attr('aria-expanded', 'true');\n    }\n    attachThemeMenuListeners();\n  }\n\n  const handleThemeMenuToggle = errorCatched(event => {\n    event.preventDefault();\n    event.stopPropagation();\n    const { $wrapper } = getThemeMenuElements();\n    if (!$wrapper.length) return;\n    const isOpen = $wrapper.hasClass('open');\n    if (isOpen) closeThemeMenu();\n    else openThemeMenu();\n  });\n\n  const handleThemeOptionSelect = errorCatched(async event => {\n    event.preventDefault();\n    const $option = $(event.currentTarget);\n    if (!$option.hasClass(THEME_OPTION_CLASS)) {\n      closeThemeMenu();\n      return;\n    }\n    const rawThemeId = $option.data('themeId');\n    const themeId = typeof rawThemeId === 'string' || typeof rawThemeId === 'number' ? String(rawThemeId).trim() : '';\n    if (!themeId) {\n      closeThemeMenu();\n      return;\n    }\n    const currentTheme = getActiveTheme();\n    if (!currentTheme || currentTheme.id !== themeId) {\n      const theme = setActiveTheme(themeId, { reason: 'user' });\n      if (theme) {\n        await saveThemePreference(theme.id);\n      }\n    }\n    closeThemeMenu();\n  });\n\n\n\n  let positionMenuListenersActive = false;\n\n  function getPositionMenuElements() {\n    return {\n      $menu: $(`#${POSITION_MENU_ID}`, parentDoc),\n      $button: $(`#${POSITION_MENU_BUTTON_ID}`, parentDoc),\n    };\n  }\n\n  function handlePositionMenuOutsideClick(event) {\n    if (!positionMenuListenersActive) return;\n    const $target = $(event.target);\n    if ($target.closest(`#${POSITION_MENU_ID}`).length) return;\n    if ($target.closest(`#${POSITION_MENU_BUTTON_ID}`).length) return;\n    closePositionMenu();\n  }\n\n  function handlePositionMenuKeydown(event) {\n    if (event.key !== 'Escape') return;\n    const { $button } = getPositionMenuElements();\n    closePositionMenu();\n    if ($button.length) {\n      $button.trigger('focus');\n    }\n  }\n\n  function attachPositionMenuListeners() {\n    if (positionMenuListenersActive) return;\n    $(parentDoc).on('click.rlhPositionMenu', handlePositionMenuOutsideClick);\n    $(parentDoc).on('keydown.rlhPositionMenu', handlePositionMenuKeydown);\n    positionMenuListenersActive = true;\n  }\n\n  function detachPositionMenuListeners() {\n    if (!positionMenuListenersActive) return;\n    $(parentDoc).off('click.rlhPositionMenu', handlePositionMenuOutsideClick);\n    $(parentDoc).off('keydown.rlhPositionMenu', handlePositionMenuKeydown);\n    positionMenuListenersActive = false;\n  }\n\n  function closePositionMenu() {\n    const { $menu, $button } = getPositionMenuElements();\n    if (!$menu.length) return;\n    $menu.attr('data-open', 'false').removeClass('open');\n    if ($button.length) {\n      $button.attr('aria-expanded', 'false');\n    }\n    detachPositionMenuListeners();\n  }\n\n  function openPositionMenu() {\n    const { $menu, $button } = getPositionMenuElements();\n    if (!$menu.length) return;\n    if ($button.is('[disabled]')) return;\n    $menu.attr('data-open', 'true').addClass('open');\n    if ($button.length) {\n      $button.attr('aria-expanded', 'true');\n    }\n    attachPositionMenuListeners();\n  }\n\n  const handlePositionMenuToggle = errorCatched(async event => {\n    event.preventDefault();\n    event.stopPropagation();\n    syncToolbarState();\n    const { $menu } = getPositionMenuElements();\n    if (!$menu.length) return;\n    const isOpen = $menu.attr('data-open') === 'true';\n    if (isOpen) closePositionMenu();\n    else openPositionMenu();\n  });\n\n  const handlePositionOptionSelect = errorCatched(async event => {\n    event.preventDefault();\n    const $option = $(event.currentTarget);\n    const positionValue = ($option.data('position-value') ?? '').toString().trim();\n    const bookName = ($option.data('book-name') ?? $option.closest(`#${POSITION_MENU_ID}`).data('book-name') ?? '')\n      .toString()\n      .trim();\n\n    closePositionMenu();\n\n    if (!positionValue) return;\n    if (lorebookHandlers?.applyUnifiedPosition) {\n      await lorebookHandlers.applyUnifiedPosition({ bookName, positionValue });\n    }\n  });\n\n  const handleUnifiedStatusMenuToggle = errorCatched(async event => {\n    event.preventDefault();\n    event.stopPropagation();\n    syncToolbarState();\n    const { $menu, $button } = getUnifiedStatusElements();\n    if (!$menu.length || !$button.length) return;\n    if ($button.is(':disabled')) return;\n    const isOpen = $menu.attr('data-open') === 'true';\n    if (isOpen) closeUnifiedStatusMenu();\n    else openUnifiedStatusMenu();\n  });\n\n  const handleUnifiedStatusOptionSelect = errorCatched(async event => {\n    event.preventDefault();\n    const $option = $(event.currentTarget);\n    const statusId = ($option.data('status-id') ?? '').toString().trim();\n    if (!statusId) return;\n    closeUnifiedStatusMenu();\n\n    const isEntryMultiSelect = appState.multiSelectMode && appState.multiSelectTarget === 'entry';\n    let entriesByBook = getSelectedEntriesByBook();\n\n    if (isEntryMultiSelect && entriesByBook.size === 0) {\n      await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5DF2\u4FDD\u5B58\u7684\u6761\u76EE\u3002' });\n      syncToolbarState();\n      return;\n    }\n\n    if (!isEntryMultiSelect) {\n      const context = getViewContext();\n      const fallbackNames = [\n        context?.activeBookName,\n        appState.activeBookName,\n        appState.activeCharacterBook,\n        appState.chatLorebook,\n      ];\n      const resolvedBookName =\n        fallbackNames.find(name => typeof name === 'string' && name.trim().length > 0)?.toString().trim() ?? '';\n      if (!resolvedBookName) {\n        await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u4EE5\u4FBF\u6267\u884C\u7EDF\u4E00\u72B6\u6001\u3002' });\n        syncToolbarState();\n        return;\n      }\n      let entries = [...safeGetLorebookEntries(resolvedBookName)];\n      if (!entries.length) {\n        await loadLorebookEntriesIfNeeded(resolvedBookName);\n        entries = [...safeGetLorebookEntries(resolvedBookName)];\n      }\n      if (!entries.length) {\n        await showModal({ type: 'alert', title: '\u63D0\u793A', text: `\u300C${resolvedBookName}\u300D\u6682\u65E0\u6761\u76EE\u53EF\u64CD\u4F5C\u3002` });\n        syncToolbarState();\n        return;\n      }\n      const uids = [];\n      entries.forEach(entry => {\n        const numericUid = Number(entry?.uid);\n        if (Number.isFinite(numericUid)) uids.push(numericUid);\n      });\n      if (!uids.length) {\n        await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u5F53\u524D\u6CA1\u6709\u5DF2\u4FDD\u5B58\u7684\u6761\u76EE\u53EF\u64CD\u4F5C\u3002' });\n        syncToolbarState();\n        return;\n      }\n      entriesByBook = new Map([[resolvedBookName, uids]]);\n    }\n\n    const statusMeta = resolveWorldbookStatus(statusId) ?? DEFAULT_WORLD_BOOK_STATUS;\n    const toastLabel = statusMeta.toastLabel ?? statusMeta.label;\n    const totalTargets = Array.from(entriesByBook.values()).reduce((sum, list) => sum + list.length, 0);\n    const progressToast = showProgressToast(`\u6B63\u5728\u66F4\u65B0 ${totalTargets} \u4E2A\u6761\u76EE\u7684\u72B6\u6001...`);\n\n    let appliedCount = 0;\n    let alreadyCount = 0;\n    let failedCount = 0;\n    let ignoredCount = 0;\n    let unsavedCount = 0;\n    const failureDetails = [];\n\n    try {\n      const viewContext = getViewContext();\n      let processedBooks = 0;\n      for (const [bookName, entryIds] of entriesByBook.entries()) {\n        processedBooks += 1;\n        progressToast.update(`\u6B63\u5728\u66F4\u65B0\u300C${bookName}\u300D (${processedBooks}/${entriesByBook.size})`);\n        const result = await updateWorldbookEntriesStatus(bookName, entryIds, statusMeta.id, {\n          context: viewContext?.id ?? 'unknown',\n        }).catch(error => {\n          console.error('[RegexLoreHub] \u6279\u91CF\u72B6\u6001\u66F4\u65B0\u5F02\u5E38:', error);\n          failureDetails.push({ bookName, reason: error?.message ?? '\u672A\u77E5\u9519\u8BEF' });\n          failedCount += entryIds.length;\n          return null;\n        });\n\n        if (!result) {\n          continue;\n        }\n\n        const summary = result.summary ?? {\n          appliedCount: 0,\n          alreadyAppliedCount: 0,\n          failedCount: 0,\n          ignoredCount: 0,\n          ignoredUnsavedCount: 0,\n        };\n\n        appliedCount += summary.appliedCount ?? 0;\n        alreadyCount += summary.alreadyAppliedCount ?? 0;\n        failedCount += summary.failedCount ?? 0;\n        ignoredCount += summary.ignoredCount ?? 0;\n        unsavedCount += summary.ignoredUnsavedCount ?? 0;\n\n        if (Array.isArray(result.failed)) {\n          result.failed.forEach(record => {\n            failureDetails.push({\n              bookName,\n              name: record.name ?? `#${record.uid ?? record.tempUid ?? '\u672A\u77E5'}`,\n              reason: record.reason ?? '\u672A\u8BF4\u660E',\n            });\n          });\n        }\n\n        if (Array.isArray(result.ignored)) {\n          result.ignored\n            .filter(record => record.reason && record.reason !== 'UNSAVED_ENTRY')\n            .forEach(record => {\n              failureDetails.push({\n                bookName,\n                name: record.name ?? `#${record.uid ?? record.tempUid ?? '\u672A\u77E5'}`,\n                reason: record.reason,\n              });\n            });\n        }\n\n        if (Array.isArray(result.success)) {\n          result.success.forEach(record => {\n            const targetUid = record.uid ?? record.tempUid;\n            if (targetUid != null) {\n              updateEntryStatusDom(bookName, targetUid, statusMeta.id);\n            }\n          });\n        }\n      }\n    } finally {\n      progressToast.remove();\n    }\n\n    const ignoredOtherCount = Math.max(ignoredCount - unsavedCount, 0);\n\n    let message = '';\n    if (\n      appliedCount > 0\n      && failedCount === 0\n      && unsavedCount === 0\n      && ignoredOtherCount === 0\n    ) {\n      message = `${appliedCount} \u4E2A\u6761\u76EE\u7684\u72B6\u6001\u5DF2\u66F4\u65B0\u4E3A\u300C${toastLabel}\u300D`;\n      if (alreadyCount > 0) {\n        message += `\uFF08\u5176\u4E2D ${alreadyCount} \u4E2A\u539F\u672C\u5DF2\u5904\u4E8E\u8BE5\u72B6\u6001\uFF09`;\n      }\n    } else {\n      const parts = [];\n      if (appliedCount > 0) {\n        parts.push(`${appliedCount} \u4E2A\u6761\u76EE\u66F4\u65B0\u4E3A\u300C${toastLabel}\u300D`);\n      }\n      if (alreadyCount > 0) {\n        parts.push(`${alreadyCount} \u4E2A\u539F\u672C\u5DF2\u5904\u4E8E\u8BE5\u72B6\u6001`);\n      }\n      if (failedCount > 0) {\n        parts.push(`${failedCount} \u4E2A\u6761\u76EE\u66F4\u65B0\u5931\u8D25`);\n      }\n      if (unsavedCount > 0) {\n        parts.push(`\u5FFD\u7565 ${unsavedCount} \u4E2A\u672A\u4FDD\u5B58\u6761\u76EE`);\n      }\n      if (ignoredOtherCount > 0) {\n        parts.push(`\u8DF3\u8FC7 ${ignoredOtherCount} \u4E2A\u6761\u76EE`);\n      }\n      message = parts.length > 0 ? parts.join('\uFF1B') : '\u672A\u6267\u884C\u4EFB\u4F55\u72B6\u6001\u66F4\u65B0\uFF0C\u8BF7\u786E\u8BA4\u5DF2\u9009\u62E9\u6709\u6548\u6761\u76EE\u3002';\n    }\n\n    let toastType = 'success';\n    if (failedCount > 0) {\n      toastType = appliedCount > 0 ? 'warning' : 'error';\n    } else if (unsavedCount > 0 || ignoredOtherCount > 0) {\n      toastType = 'info';\n    }\n\n    showToast(message, toastType);\n\n    if (failureDetails.length) {\n      console.warn('[RegexLoreHub] \u72B6\u6001\u66F4\u65B0\u8BE6\u60C5\uFF08\u4EC5\u65E5\u5FD7\uFF09:', failureDetails);\n    }\n\n    syncToolbarState();\n  });\n\n\n\n  const handleCharacterBookSwitch = errorCatched(async event => {\n    const value = ($(event.currentTarget).val() ?? '').toString().trim();\n    if (!value || appState.activeCharacterBook === value) return;\n    appState.activeCharacterBook = value;\n    renderContent();\n  });\n\n\n\n  const handleSelectionCheckboxChange = errorCatched(async event => {\n    const $checkbox = $(event.currentTarget);\n    const selectKey = $checkbox.data('select-key');\n    if (!selectKey) return;\n    if (!appState.multiSelectMode) {\n      $checkbox.prop('checked', false);\n      return;\n    }\n    const isChecked = $checkbox.is(':checked');\n    if (isChecked) appState.selectedItems.add(selectKey);\n    else appState.selectedItems.delete(selectKey);\n    $checkbox.closest('[data-select-key]').toggleClass('selected', isChecked);\n    syncToolbarState();\n  });\n\n\n\n  // \u6267\u884C\u66FF\u6362\u64CD\u4F5C\u7684\u51FD\u6570\n\n\n\n  const performReplace = async (matches, searchTerm, replaceTerm) => {\n    const replaceRegex = buildSearchRegex(searchTerm, false);\n    const updatesByBook = new Map();\n\n    const keysAreEqual = (a, b) => {\n      if (!Array.isArray(a) || !Array.isArray(b)) return false;\n      if (a.length !== b.length) return false;\n      for (let index = 0; index < a.length; index += 1) {\n        if (a[index] !== b[index]) return false;\n      }\n      return true;\n    };\n\n    for (const match of matches) {\n      const { bookName, entry } = match ?? {};\n      if (!bookName || !entry) {\n        throw new Error('\u4EC5\u652F\u6301\u4E16\u754C\u4E66\u6761\u76EE\u7684\u6279\u91CF\u66FF\u6362\u3002');\n      }\n\n      const uid = Number(entry?.uid);\n      if (!Number.isFinite(uid)) continue;\n\n      const update = { uid };\n      let hasChange = false;\n\n      if (Array.isArray(entry.keys)) {\n        const newKeys = entry.keys.map(key => key.replace(replaceRegex, replaceTerm));\n        if (!keysAreEqual(entry.keys, newKeys)) {\n          update.keys = newKeys;\n          hasChange = true;\n        }\n      }\n\n      if (typeof entry.content === 'string') {\n        const newContent = entry.content.replace(replaceRegex, replaceTerm);\n        if (newContent !== entry.content) {\n          update.content = newContent;\n          hasChange = true;\n        }\n      }\n\n      if (typeof entry.name === 'string') {\n        const newName = entry.name.replace(replaceRegex, replaceTerm);\n        if (newName !== entry.name) {\n          update.name = newName;\n          hasChange = true;\n        }\n      }\n\n      if (typeof entry.comment === 'string') {\n        const newComment = entry.comment.replace(replaceRegex, replaceTerm);\n        if (newComment !== entry.comment) {\n          update.comment = newComment;\n          hasChange = true;\n        }\n      }\n\n      if (!hasChange) continue;\n\n      if (!updatesByBook.has(bookName)) {\n        updatesByBook.set(bookName, []);\n      }\n      updatesByBook.get(bookName).push(update);\n    }\n\n    for (const [bookName, updates] of updatesByBook.entries()) {\n      if (updates.length === 0) continue;\n      await updateWorldbookEntries(bookName, updates);\n    }\n  };\n\n  // \u83B7\u53D6\u5168\u5C40\u4E16\u754C\u4E66\u5339\u914D\u9879\u7684\u51FD\u6570\n\n\n\n\n  const togglePanel = errorCatched(async () => {\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\n  if ($panel.is(':visible')) {\n    hidePanel();\n  } else {\n    await showPanel();\n  }\n  });\n\n\n\n  const hidePanel = async () => {\n    // \u5F02\u6B65\u4FDD\u5B58\u6240\u6709\u66F4\u6539\uFF0C\u5E76\u5728\u540E\u53F0\u5904\u7406\u7ED3\u679C\n    showToast('\u6B63\u5728\u540E\u53F0\u4FDD\u5B58\u6570\u636E...', 'info');\n    saveAllChanges()\n      .then(() => {\n        showToast('\u6570\u636E\u4FDD\u5B58\u6210\u529F\uFF01', 'success');\n      })\n      .catch(error => {\n        console.error('[RegexLoreHub] Background save failed:', error);\n        showToast('\u540E\u53F0\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u65E5\u5FD7\u3002', 'error');\n      });\n\n    // \u7ACB\u5373\u9690\u85CF\u9762\u677F\uFF0C\u65E0\u9700\u7B49\u5F85\u4FDD\u5B58\u5B8C\u6210\n    const $panel = $(`#${PANEL_ID}`, parentDoc);\n    const $parentBody = $('body', parentDoc);\n    $panel.hide();\n    $(`#${BUTTON_ID}`, parentDoc).removeClass('active');\n    $parentBody.off('mousedown.rlh-outside-click');\n  };\n\n\n\n  const showPanel = async () => {\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\n  const $parentBody = $('body', parentDoc);\n  $panel.css('display', 'flex');\n  $(`#${BUTTON_ID}`, parentDoc).addClass('active');\n\n  $parentBody.on('mousedown.rlh-outside-click', function (event) {\n    if (\n      $(event.target).closest(`#${PANEL_ID}`).length === 0 &&\n      $(event.target).closest(`#${BUTTON_ID}`).length === 0\n    ) {\n      hidePanel();\n    }\n  });\n\n  if (!appState.isDataLoaded) {\n    await loadAllData();\n  } else {\n    renderContent();\n  }\n  };\n\nconst handleTabRefresh = errorCatched(async tabId => {\n  appState.isLoadingTabData = true;\n  renderContent();\n\n  try {\n    await refreshCharacterData();\n\n    // \u786E\u4FDD\u65B0\u51FA\u73B0\u7684\u4E16\u754C\u4E66\u5728\u7F13\u5B58\u4E2D\u6709\u5143\u6570\u636E\uFF0C\u907F\u514D\u52A0\u8F7D\u6761\u76EE\u65F6\u7F3A\u5931\n    const ensureBookMeta = name => {\n      if (!name) return null;\n      if (!Array.isArray(appState.allLorebooks)) {\n        appState.allLorebooks = [];\n      }\n      let book = appState.allLorebooks.find(b => b.name === name);\n      if (!book) {\n        book = { name, enabled: false, entryCount: 0, enabledEntryCount: 0, entriesLoaded: false };\n        appState.allLorebooks.push(book);\n      }\n      return book;\n    };\n\n    if (tabId === 'char-lore') {\n      const books = Array.isArray(appState.lorebooks.character) ? appState.lorebooks.character : [];\n      for (const bookName of books) {\n        ensureBookMeta(bookName);\n        await loadLorebookEntriesIfNeeded(bookName, true);\n      }\n    } else if (tabId === 'chat-lore') {\n      const chatBookName = appState.chatLorebook;\n      if (chatBookName) {\n        ensureBookMeta(chatBookName);\n        await loadLorebookEntriesIfNeeded(chatBookName, true);\n      }\n    }\n  } catch (error) {\n    console.error(`[RegexLoreHub] Error refreshing tab ${tabId}:`, error);\n    // \u4F7F\u7528\u5DF2\u6709\u7684\u9519\u8BEF\u5904\u7406\u51FD\u6570\u62A5\u544A\u9519\u8BEF\n    errorCatched(() => { throw error; })();\n  } finally {\n    appState.isLoadingTabData = false;\n    renderContent();\n  }\n});\n\n\n\n  const updateActiveViewForTab = tabId => {\n    switch (tabId) {\n      case 'char-lore':\n        appState.activeView = 'char-lore';\n        break;\n      case 'chat-lore':\n        appState.activeView = 'chat-lore';\n        break;\n      case 'global-regex':\n        appState.activeView = 'global-regex';\n        break;\n      case 'char-regex':\n        appState.activeView = 'char-regex';\n        break;\n      case 'global-lore':\n      default:\n        if (appState.activeView !== 'global-lore-detail') {\n          appState.activeView = 'global-lore-list';\n        }\n        break;\n    }\n  };\n\n  const switchTab = errorCatched(async event => {\n  const targetTab = $(event.currentTarget).data('tab');\n\n  // \u65B0\u589E\u903B\u8F91\uFF1A\u5982\u679C\u5F53\u524D\u5728\u8BE6\u60C5\u9875\uFF0C\u70B9\u51FB\u5168\u5C40\u4E16\u754C\u4E66\u6807\u7B7E\u5219\u8FD4\u56DE\u5217\u8868\n  if (targetTab === 'global-lore' && appState.activeView === 'global-lore-detail') {\n    await lorebookHandlers.handleExitLorebookDetail();\n    return;\n  }\n\n  appState.activeTab = targetTab;\n  updateActiveViewForTab(targetTab);\n  $(`#${PANEL_ID} .rlh-tab`, parentDoc).removeClass('active');\n  $(event.currentTarget).addClass('active');\n  $(`#${CREATE_LOREBOOK_BTN_ID}`, parentDoc).toggle(appState.activeTab === 'global-lore');\n  appState.selectedItems.clear();\n  const shouldRefreshCharLore = targetTab === 'char-lore' && !appState.charLoreInitialSynced;\n  if (shouldRefreshCharLore) {\n    await loadAllData();\n    appState.charLoreInitialSynced = true;\n  }\n\n  // \u65B0\u589E\uFF1A\u5982\u679C\u5207\u6362\u5230\u89D2\u8272\u6216\u804A\u5929\u4E16\u754C\u4E66\uFF0C\u5219\u89E6\u53D1\u5237\u65B0\n  if (targetTab === 'char-lore' || targetTab === 'chat-lore') {\n    await handleTabRefresh(targetTab);\n  } else {\n    renderContent();\n  }\n  });\n\n\n\n  const toggleMultiSelectMode = errorCatched(async event => {\n  appState.multiSelectMode = !appState.multiSelectMode;\n  appState.selectedItems.clear();\n  $(`#rlh-multi-select-btn`, parentDoc).toggleClass('active', appState.multiSelectMode);\n  $(`#rlh-multi-select-controls`, parentDoc).toggleClass('active', appState.multiSelectMode);\n  renderContent();\n  syncToolbarState();\n});\n\n\n\n  const handleSelectAll = errorCatched(async () => {\n  if (!appState.multiSelectMode) return;\n  const keys = getVisibleSelectKeys();\n  if (!keys.length) return;\n  keys.forEach(key => appState.selectedItems.add(key));\n  renderContent();\n  syncToolbarState();\n});\n\n\n\n  const handleSelectNone = errorCatched(async () => {\n  if (!appState.multiSelectMode) return;\n  const prefix = getTargetKeyPrefix();\n  let changed = false;\n  if (!prefix) {\n    if (appState.selectedItems.size === 0) return;\n    appState.selectedItems.clear();\n    changed = true;\n  } else {\n    const keys = [...appState.selectedItems];\n    keys.forEach(key => {\n      if (key.startsWith(prefix)) {\n        appState.selectedItems.delete(key);\n        changed = true;\n      }\n    });\n  }\n  if (changed) {\n    renderContent();\n    syncToolbarState();\n  }\n});\n\n\n\n  const handleSelectInvert = errorCatched(async () => {\n  if (!appState.multiSelectMode) return;\n  const keys = getVisibleSelectKeys();\n  if (!keys.length) return;\n  keys.forEach(key => {\n    if (appState.selectedItems.has(key)) appState.selectedItems.delete(key);\n    else appState.selectedItems.add(key);\n  });\n  renderContent();\n  syncToolbarState();\n});\n\n\n\n  const handleBatchEnable = errorCatched(async () => {\n  if (!appState.multiSelectMode) return;\n  if (!hasSelectionForCurrentTarget())\n    return await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u9009\u62E9\u8981\u542F\u7528\u7684\u9879\u76EE\u3002' });\n  await performBatchOperation(true);\n  showToast('\u6279\u91CF\u542F\u7528\u6210\u529F');\n  });\n\n\n\n  const handleBatchDisable = errorCatched(async () => {\n  if (!appState.multiSelectMode) return;\n  if (!hasSelectionForCurrentTarget())\n    return await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u9009\u62E9\u8981\u7981\u7528\u7684\u9879\u76EE\u3002' });\n  await performBatchOperation(false);\n  showToast('\u6279\u91CF\u7981\u7528\u6210\u529F');\n  });\n\n\n\n  const handleBatchDelete = errorCatched(async () => {\n  if (!appState.multiSelectMode) return;\n  const selectedBooks = new Set();\n  const selectedEntries = new Map();\n  const selectedRegexIds = new Set();\n  let totalEntriesToDelete = 0;\n\n  for (const key of appState.selectedItems) {\n    const { type, bookName, entryId, regexId } = parseSelectionKey(key);\n    if (type === 'book' && bookName) {\n      selectedBooks.add(bookName);\n    } else if (type === 'lore' && bookName) {\n      const numericId = Number(entryId);\n      if (!Number.isFinite(numericId)) continue;\n      if (!selectedEntries.has(bookName)) {\n        selectedEntries.set(bookName, []);\n      }\n      selectedEntries.get(bookName).push(numericId);\n      totalEntriesToDelete++;\n    } else if (type === 'regex') {\n      const normalizedRegexId = regexId != null && regexId !== '' ? String(regexId) : '';\n      if (normalizedRegexId) {\n        selectedRegexIds.add(normalizedRegexId);\n      }\n    }\n  }\n\n  if (selectedBooks.size === 0 && totalEntriesToDelete === 0 && selectedRegexIds.size === 0) {\n    return await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u9009\u62E9\u8981\u5220\u9664\u7684\u9879\u76EE\u3002' });\n  }\n\n  let confirmText = '\u60A8\u786E\u5B9A\u8981\u6C38\u4E45\u5220\u9664';\n  const parts = [];\n  if (selectedBooks.size > 0) parts.push(`\u9009\u4E2D\u7684 ${selectedBooks.size} \u672C\u4E16\u754C\u4E66`);\n  if (totalEntriesToDelete > 0) parts.push(`${totalEntriesToDelete} \u4E2A\u6761\u76EE`);\n  if (selectedRegexIds.size > 0) parts.push(`${selectedRegexIds.size} \u4E2A\u6B63\u5219`);\n  confirmText += ` ${parts.join('\u548C')} \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`;\n\n  try {\n    await showModal({ type: 'confirm', title: '\u786E\u8BA4\u5220\u9664', text: confirmText });\n  } catch {\n    return; // User cancelled\n  }\n\n  const progressToast = showProgressToast('\u5F00\u59CB\u5220\u9664...');\n  try {\n    let deletedBooksCount = 0;\n    let deletedEntriesCount = 0;\n    let deletedRegexCount = 0;\n    let processedEntries = 0;\n    let processedBooks = 0;\n\n    // \u5148\u5220\u9664\u6761\u76EE\n    const entriesToDelete = Array.from(selectedEntries.entries());\n    for (const [bookName, uids] of entriesToDelete) {\n      if (selectedBooks.has(bookName)) {\n        processedEntries += uids.length;\n        continue;\n      }\n\n      progressToast.update(`\u6B63\u5728\u5220\u9664\u6761\u76EE... (${processedEntries}/${totalEntriesToDelete})`);\n      const result = await TavernAPI.deleteWorldbookEntries(bookName, uids);\n      processedEntries += uids.length;\n\n      if (result && result.deleted_entries && result.deleted_entries.length > 0) {\n        deletedEntriesCount += result.deleted_entries.length;\n        safeSetLorebookEntries(bookName, result.worldbook.map(normalizeWorldbookEntry));\n        uids.forEach(uid => appState.selectedItems.delete(buildLoreSelectionKey(bookName, uid)));\n      }\n    }\n\n    // \u518D\u5220\u9664\u6574\u4E2A\u4E16\u754C\u4E66\n    const booksToDelete = Array.from(selectedBooks);\n    for (const bookName of booksToDelete) {\n      progressToast.update(`\u6B63\u5728\u5220\u9664\u4E16\u754C\u4E66... (${processedBooks + 1}/${booksToDelete.length})`);\n      if (await TavernAPI.deleteWorldbook(bookName)) {\n        deletedBooksCount++;\n        appState.allLorebooks = appState.allLorebooks.filter(b => b.name !== bookName);\n        safeDeleteLorebookEntries(bookName);\n        appState.selectedItems.delete(buildBookSelectionKey(bookName));\n        const lorePrefix = buildLoreSelectionPrefix(bookName);\n        for (const key of [...appState.selectedItems]) {\n          if (key.startsWith(lorePrefix)) {\n            appState.selectedItems.delete(key);\n          }\n        }\n      }\n      processedBooks++;\n    }\n\n    // \u65B0\u589E\uFF1A\u5220\u9664\u6B63\u5219\u8868\u8FBE\u5F0F\n    if (selectedRegexIds.size > 0) {\n      progressToast.update(`\u6B63\u5728\u5220\u9664 ${selectedRegexIds.size} \u4E2A\u6B63\u5219...`);\n      const allServerRegexes = await TavernAPI.getRegexes();\n      const regexesToKeep = allServerRegexes.filter(r => !selectedRegexIds.has(String(r.id)));\n\n      // \u53EA\u66FF\u6362\u975E\u5361\u7247\u5185\u6B63\u5219\n      await TavernAPI.replaceRegexes(regexesToKeep.filter(r => r.source !== 'card'));\n      await TavernAPI.saveSettings();\n\n      deletedRegexCount = allServerRegexes.length - regexesToKeep.length;\n\n      // \u66F4\u65B0\u672C\u5730\u72B6\u6001\n      appState.regexes.global = appState.regexes.global.filter(r => !selectedRegexIds.has(String(r.id)));\n      appState.regexes.character = appState.regexes.character.filter(r => !selectedRegexIds.has(String(r.id)));\n      updateRegexOrderMetadata(appState.regexes.global);\n      updateRegexOrderMetadata(appState.regexes.character);\n      selectedRegexIds.forEach(id => appState.selectedItems.delete(buildRegexSelectionKey(id)));\n    }\n\n    progressToast.remove();\n\n    const messageParts = [];\n    if (deletedBooksCount > 0) messageParts.push(`\u6210\u529F\u5220\u9664 ${deletedBooksCount} \u672C\u4E16\u754C\u4E66`);\n    if (deletedEntriesCount > 0) messageParts.push(`\u6210\u529F\u5220\u9664 ${deletedEntriesCount} \u4E2A\u6761\u76EE`);\n    if (deletedRegexCount > 0) messageParts.push(`\u6210\u529F\u5220\u9664 ${deletedRegexCount} \u4E2A\u6B63\u5219`);\n\n    if (messageParts.length > 0) {\n      showToast(messageParts.join('\uFF0C'));\n      // \u5220\u9664\u6210\u529F\u540E\u9000\u51FA\u591A\u9009\u6A21\u5F0F\n      if (appState.multiSelectMode) {\n        toggleMultiSelectMode();\n      } else {\n        renderContent();\n      }\n    } else {\n      await showModal({ type: 'alert', title: '\u5220\u9664\u5931\u8D25', text: '\u5220\u9664\u9879\u76EE\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002' });\n    }\n  } catch (error) {\n    progressToast.remove();\n    console.error('[RegexLoreHub] Batch delete failed:', error);\n    await showModal({ type: 'alert', title: '\u5220\u9664\u5931\u8D25', text: `\u64CD\u4F5C\u5931\u8D25: ${error.message}` });\n    await loadAllData(true); // \u53D1\u751F\u9519\u8BEF\u65F6\u91CD\u65B0\u52A0\u8F7D\u4EE5\u540C\u6B65\u72B6\u6001\n  }\n  });\n\n\n\n  const handleCleanOrphanLorebooks = errorCatched(async () => {\n    if (!Array.isArray(appState.allLorebooks) || appState.allLorebooks.length === 0) {\n      await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u6CA1\u6709\u627E\u5230\u53EF\u4EE5\u6E05\u7406\u7684\u4E16\u754C\u4E66\u3002' });\n      return;\n    }\n\n    const orphanBooks = appState.allLorebooks\n      .filter(book => {\n        const usageList = appState.lorebookUsage instanceof Map ? appState.lorebookUsage.get(book.name) : [];\n        const linkedChars = Array.isArray(usageList) ? usageList : [];\n        return !book.enabled && linkedChars.length === 0;\n      })\n      .map(book => book.name);\n\n    if (orphanBooks.length === 0) {\n      await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u6CA1\u6709\u627E\u5230\u672A\u542F\u7528\u4E14\u672A\u7ED1\u5B9A\u89D2\u8272\u5361\u7684\u4E16\u754C\u4E66\u3002' });\n      return;\n    }\n\n    appState.multiSelectMode = true;\n    appState.multiSelectTarget = 'book';\n    appState.selectedItems.clear();\n    orphanBooks.forEach(name => appState.selectedItems.add(buildBookSelectionKey(name)));\n    renderContent();\n\n    const confirmText = '\u5C06\u5220\u9664 ' + orphanBooks.length + ' \u672C\u672A\u542F\u7528\u4E14\u672A\u7ED1\u5B9A\u89D2\u8272\u5361\u7684\u4E16\u754C\u4E66\u3002\u56E0API\u9650\u5236\uFF0C\u65E0\u6CD5\u76F4\u63A5\u83B7\u53D6\u804A\u5929\u7ED1\u5B9A\u4E16\u754C\u4E66\uFF0C\u5B58\u5728\u8BEF\u5220\u8BE5\u4E16\u754C\u4E66\u7684\u53EF\u80FD\u3002\u786E\u5B9A\u7EE7\u7EED\u5417\uFF1F';\n\n\n    try {\n      await showModal({ type: 'confirm', title: '\u786E\u8BA4\u6E05\u7406\u5B64\u7ACB\u4E16\u754C\u4E66', text: confirmText });\n    } catch {\n      return;\n    }\n\n    const progressToast = showProgressToast('\u5F00\u59CB\u6E05\u7406\u5B64\u7ACB\u4E16\u754C\u4E66...');\n    const failedBooks = [];\n    let deletedCount = 0;\n\n    try {\n      for (let index = 0; index < orphanBooks.length; index += 1) {\n        const bookName = orphanBooks[index];\n        progressToast.update('\u6B63\u5728\u5220\u9664\u7B2C ' + (index + 1) + ' / ' + orphanBooks.length + ' \u672C\u4E16\u754C\u4E66...');\n        const success = await TavernAPI.deleteWorldbook(bookName);\n        if (success) {\n          deletedCount += 1;\n          appState.allLorebooks = appState.allLorebooks.filter(book => book.name !== bookName);\n          safeDeleteLorebookEntries(bookName);\n          if (appState.lorebookUsage instanceof Map && appState.lorebookUsage.has(bookName)) {\n            appState.lorebookUsage.delete(bookName);\n          }\n          if (Array.isArray(appState.lorebooks?.character)) {\n            appState.lorebooks.character = appState.lorebooks.character.filter(name => name !== bookName);\n          }\n          if (appState.chatLorebook === bookName) {\n            appState.chatLorebook = null;\n          }\n          if (appState.activeCharacterBook === bookName) {\n            appState.activeCharacterBook = null;\n          }\n          if (appState.activeBookName === bookName) {\n            appState.activeBookName = null;\n          }\n          appState.selectedItems.delete(buildBookSelectionKey(bookName));\n          const lorePrefix = buildLoreSelectionPrefix(bookName);\n          for (const key of [...appState.selectedItems]) {\n            if (key.startsWith(lorePrefix)) {\n              appState.selectedItems.delete(key);\n            }\n          }\n        } else {\n          failedBooks.push(bookName);\n        }\n      }\n    } catch (error) {\n      progressToast.remove();\n      console.error('[RegexLoreHub] Clean orphan lorebooks failed:', error);\n      await showModal({ type: 'alert', title: '\u64CD\u4F5C\u5931\u8D25', text: '\u6E05\u7406\u5B64\u7ACB\u4E16\u754C\u4E66\u65F6\u53D1\u751F\u9519\u8BEF\uFF1A' + (error?.message || error) });\n      await loadAllData(true);\n      return;\n    }\n\n    progressToast.remove();\n\n    if (deletedCount > 0) {\n      showToast('\u5DF2\u5220\u9664 ' + deletedCount + ' \u672C\u5B64\u7ACB\u4E16\u754C\u4E66');\n    }\n\n    if (failedBooks.length > 0) {\n      appState.selectedItems.clear();\n      failedBooks.forEach(name => appState.selectedItems.add(buildBookSelectionKey(name)));\n      await showModal({ type: 'alert', title: '\u90E8\u5206\u5220\u9664\u5931\u8D25', text: '\u4EE5\u4E0B\u4E16\u754C\u4E66\u672A\u80FD\u5220\u9664\uFF1A' + failedBooks.join('\u3001') });\n    } else {\n      appState.selectedItems.clear();\n      appState.multiSelectMode = false;\n    }\n\n    renderContent();\n  });\n\n\n\n  const performBatchOperation = errorCatched(async enable => {\n  const selectedBookNames = new Set();\n  const selectedEntriesByBook = new Map();\n  const selectedRegexIds = new Set();\n  let needsRegexUpdate = false;\n  let needsSettingsUpdate = false;\n\n  for (const itemKey of appState.selectedItems) {\n    const { type, bookName, entryId, regexId } = parseSelectionKey(itemKey);\n    if (type === 'book' && bookName) {\n      selectedBookNames.add(bookName);\n    } else if (type === 'lore' && bookName) {\n      const numericId = Number(entryId);\n      if (!Number.isFinite(numericId)) continue;\n      if (!selectedEntriesByBook.has(bookName)) selectedEntriesByBook.set(bookName, []);\n      selectedEntriesByBook.get(bookName).push(numericId);\n    } else if (type === 'regex') {\n      const normalizedRegexId = regexId != null && regexId !== '' ? String(regexId) : '';\n      if (normalizedRegexId) {\n        selectedRegexIds.add(normalizedRegexId);\n      }\n    }\n  }\n\n  if (selectedBookNames.size > 0) {\n    let currentBooks = new Set(await TavernAPI.getGlobalWorldbookNames() || []);\n    selectedBookNames.forEach(name => (enable ? currentBooks.add(name) : currentBooks.delete(name)));\n    await TavernAPI.rebindGlobalWorldbooks(Array.from(currentBooks));\n    needsSettingsUpdate = true;\n    selectedBookNames.forEach(name => {\n      const book = appState.allLorebooks.find(b => b.name === name);\n      if (book) book.enabled = enable;\n    });\n  }\n\n  if (selectedEntriesByBook.size > 0) {\n    for (const [bookName, entryIds] of selectedEntriesByBook) {\n      const entries = [...safeGetLorebookEntries(bookName)];\n      if (entries) {\n        const updates = entryIds\n          .map(uid => {\n            const entry = entries.find(e => e.uid === uid);\n            if (entry) {\n              entry.enabled = enable;\n              return { uid, enabled: enable };\n            }\n            return null;\n          })\n          .filter(Boolean);\n        if (updates.length > 0) await updateWorldbookEntries(bookName, updates);\n      }\n    }\n  }\n\n  await TavernAPI.saveSettings();\n\n  if (selectedRegexIds.size > 0) {\n    const allServerRegexes = await TavernAPI.getRegexes();\n    allServerRegexes.forEach(regex => {\n      if (selectedRegexIds.has(String(regex.id))) regex.enabled = enable;\n    });\n    await TavernAPI.replaceRegexes(allServerRegexes.filter(r => r.source !== 'card'));\n    needsRegexUpdate = true;\n    [appState.regexes.global, appState.regexes.character].forEach(list =>\n      list.forEach(r => {\n        if (selectedRegexIds.has(String(r.id))) r.enabled = enable;\n      }),\n    );\n  }\n\n  if (needsSettingsUpdate || needsRegexUpdate) await TavernAPI.saveSettings();\n\n  appState.selectedItems.clear();\n  renderContent();\n  });\n\n\n\n  const handleHeaderClick = errorCatched(async (event, data) => {\n  const $target = $(event.target);\n  const $container = $(event.currentTarget).closest('.rlh-item-container, .rlh-book-group');\n\n  // 1. \u68C0\u67E5\u662F\u5426\u70B9\u51FB\u5728\u53EF\u4EA4\u4E92\u7684\u5B50\u63A7\u4EF6\u4E0A\n  if ($target.closest('.rlh-item-controls, .rlh-rename-ui').length > 0) {\n    return;\n  }\n\n  // 2. \u5982\u679C\u662F\u591A\u9009\u6A21\u5F0F\uFF0C\u53EA\u5904\u7406\u9009\u62E9\u903B\u8F91\n  if (appState.multiSelectMode) {\n    if (toggleSelectionForContainer($container)) return;\n  }\n\n  if (\n    !appState.multiSelectMode &&\n    appState.activeTab === 'global-lore' &&\n    appState.activeView === 'global-lore-list' &&\n    $container.is('.rlh-book-group') &&\n    $target.closest('.rlh-book-title-wrapper').length > 0\n  ) {\n    const bookName = $container.data('book-name');\n    if (bookName && lorebookHandlers?.handleEnterLorebookDetail) {\n      await lorebookHandlers.handleEnterLorebookDetail(bookName);\n    }\n    return;\n  }\n\n  // 3. \u975E\u591A\u9009\u6A21\u5F0F\u4E0B\u7684\u9ED8\u8BA4\u5C55\u5F00/\u6298\u53E0\u903B\u8F91\n  if ($container.hasClass('from-card') || $container.hasClass('renaming')) return;\n\n  const $content = $container.find('.rlh-collapsible-content').first();\n\n  // \u5BF9\u4E8E\u975E\u5168\u5C40\u4E16\u754C\u4E66\u9875\u9762\u7684\u4E16\u754C\u4E66\u7EC4\uFF0C\u6267\u884C\u5C55\u5F00/\u6298\u53E0\n  if ($container.is('.rlh-book-group') && appState.activeTab !== 'global-lore') {\n    $content.slideToggle(200);\n    return;\n  }\n\n  // \u5BF9\u4E8E\u6761\u76EE\uFF0C\u5C55\u5F00/\u6298\u53E0\u7F16\u8F91\u5668\n  if ($container.is('.rlh-item-container')) {\n    if ($content.is(':visible')) {\n      $content.stop(true, true).slideUp(200, () => {\n        $content.off('input.rlh');\n        $content.empty();\n        $content.attr('data-entry-mode', 'collapsed');\n      });\n      $container.attr('data-entry-mode', 'collapsed');\n      return;\n    }\n\n    // \u5728\u975E\u6279\u91CF\u64CD\u4F5C\u65F6\uFF0C\u624D\u6267\u884C\u624B\u98CE\u7434\u6548\u679C\uFF08\u6298\u53E0\u5176\u4ED6\u5DF2\u5C55\u5F00\u7684\u6761\u76EE\uFF09\n    if (!data?.bulk) {\n      $container.siblings('.rlh-item-container').find('.rlh-collapsible-content:visible').slideUp(200).empty();\n    }\n\n    const type = $container.data('type');\n    const id = $container.data('id');\n    const storedSearchTerm = $container.data('searchTerm');\n    const attrSearchTerm = $container.attr('data-search-term');\n    const effectiveSearchTerm = typeof storedSearchTerm === 'string' && storedSearchTerm.length > 0\n      ? storedSearchTerm\n      : typeof attrSearchTerm === 'string' && attrSearchTerm.length > 0\n      ? attrSearchTerm\n      : '';\n\n    if (type === 'lore') {\n      const bookName = $container.data('book-name');\n      const entries = [...safeGetLorebookEntries(bookName)];\n      const entry = entries.find(e => e.uid === Number(id));\n      if (!entry) return;\n      itemHandlers.renderLoreEntryViewer($container, entry, effectiveSearchTerm, { animate: true });\n      return;\n    }\n\n    if (type === 'regex') {\n      const regexItem = [...appState.regexes.global, ...appState.regexes.character].find(r => r.id === id);\n      if (!regexItem) return;\n      const currentMode = $container.attr('data-entry-mode');\n      if (currentMode === 'edit') {\n        itemHandlers.renderRegexEditor($container, regexItem, { animate: true });\n      } else {\n        itemHandlers.renderRegexViewer($container, regexItem, effectiveSearchTerm, { animate: true });\n      }\n      return;\n    }\n\n  }\n  });\n\n\n\n  const handleMultiSelectContainerClick = errorCatched(async event => {\n  if (!appState.multiSelectMode) return;\n  const $target = $(event.target);\n  if (\n    $target.closest('.rlh-item-controls, .rlh-rename-ui, .rlh-action-btn, .rlh-action-btn-icon, .rlh-toggle-btn, .rlh-selection-control, .rlh-multi-select-checkbox, .rlh-item-header, .rlh-global-book-header').length > 0\n  ) {\n    return;\n  }\n  const $container = $(event.currentTarget).closest('.rlh-item-container, .rlh-book-group');\n  if (!$container.length) return;\n  if (toggleSelectionForContainer($container)) {\n    event.stopPropagation();\n    event.preventDefault();\n  }\n  });\n\n\n\n  const handleEditEntriesToggle = errorCatched(async event => {\n  event.stopPropagation();\n  const $button = $(event.currentTarget);\n  const $bookGroup = $button.closest('.rlh-book-group');\n  const isEnteringEditMode = !$bookGroup.hasClass('editing-entries');\n\n  // \u5207\u6362\u7F16\u8F91\u72B6\u6001\n  $bookGroup.toggleClass('editing-entries');\n\n  if (isEnteringEditMode) {\n    // **\u8FDB\u5165** \u7F16\u8F91\u6A21\u5F0F\n    // 1. \u5982\u679C\u591A\u9009\u672A\u6FC0\u6D3B\uFF0C\u5219\u81EA\u52A8\u6FC0\u6D3B\u5E76\u66F4\u65B0\u76F8\u5173UI\n    if (!appState.multiSelectMode) {\n      appState.multiSelectMode = true;\n      $(`#rlh-multi-select-btn`, parentDoc).addClass('active');\n      $(`#rlh-multi-select-controls`, parentDoc).addClass('active');\n      // \u624B\u52A8\u4E3A\u6240\u6709\u53EF\u89C1\u9879\u76EE\u6DFB\u52A0\u591A\u9009\u6A21\u5F0F\u7684class\uFF0C\u800C\u4E0D\u662F\u91CD\u7ED8\u6574\u4E2A\u9762\u677F\n      $(`#${PANEL_ID}`, parentDoc).addClass('rlh-multi-select-mode');\n    }\n\n    // 2. \u5F3A\u5236\u5C55\u5F00\u5185\u5BB9\n    $bookGroup.find('.rlh-collapsible-content').first().slideDown(200);\n\n    // 3. \u66F4\u65B0\u6309\u94AE\u72B6\u6001\n    $button.attr('title', '\u5B8C\u6210\u7F16\u8F91').find('i').removeClass('fa-pen-to-square').addClass('fa-check-square');\n    $button.addClass('active');\n  } else {\n    // **\u9000\u51FA** \u7F16\u8F91\u6A21\u5F0F\n    // 1. \u4EC5\u66F4\u65B0\u6309\u94AE\u72B6\u6001\n    $button.attr('title', '\u7F16\u8F91/\u9009\u62E9\u6761\u76EE').find('i').removeClass('fa-check-square').addClass('fa-pen-to-square');\n    $button.removeClass('active');\n  }\n  });\n\n\n\n  const handleRefresh = errorCatched(async event => {\n    const $button = $(event.currentTarget);\n    const $icon = $button.find('i');\n    $icon.addClass('fa-spin');\n\n    // \u5728\u5168\u5C40\u5237\u65B0\u524D\uFF0C\u4FDD\u62A4\u8BE6\u60C5\u89C6\u56FE\u4E2D\u7684\u5F53\u524D\u4E16\u754C\u4E66\u6761\u76EE\n    let cachedEntries = null;\n    if (appState.activeView === 'global-lore-detail' && appState.activeBookName) {\n      cachedEntries = safeGetLorebookEntries(appState.activeBookName);\n      console.log(`[RegexLoreHub] \u5168\u5C40\u5237\u65B0\u65F6\u7F13\u5B58\u8BE6\u60C5\u89C6\u56FE\u6761\u76EE: ${appState.activeBookName}`);\n    }\n\n    syncContextWithAppState();\n    await loadAllData(true);\n\n    // \u6062\u590D\u8BE6\u60C5\u89C6\u56FE\u7684\u7F13\u5B58\u6761\u76EE\n    if (cachedEntries && appState.activeView === 'global-lore-detail' && appState.activeBookName) {\n      safeSetLorebookEntries(appState.activeBookName, cachedEntries);\n      updateBookSummary(appState.activeBookName);\n      console.log(`[RegexLoreHub] \u6062\u590D\u8BE6\u60C5\u89C6\u56FE\u6761\u76EE: ${appState.activeBookName}`);\n      // \u5F02\u6B65\u5F3A\u5236\u5237\u65B0\u4EE5\u83B7\u53D6\u6700\u65B0\u6570\u636E\n      loadLorebookEntriesIfNeeded(appState.activeBookName, true).catch(error => {\n        console.warn(`[RegexLoreHub] \u6062\u590D\u540E\u5237\u65B0\u6761\u76EE\u5931\u8D25: ${appState.activeBookName}`, error);\n      });\n      renderContent();\n    }\n\n    setTimeout(() => $icon.removeClass('fa-spin'), 500);\n  });\n\n\n\n  const handlePrimaryCreateButtonClick = errorCatched(async (event) => {\n    if (appState.activeView === 'global-lore-list') {\n      if (lorebookHandlers?.handleCreateLorebook) {\n        await lorebookHandlers.handleCreateLorebook(event);\n      }\n    } else if (appState.activeView === 'global-lore-detail') {\n      if (!appState.activeBookName) return;\n\n      if (itemHandlers?.handleCreateEntry) {\n\n        const mockEvent = { currentTarget: $(`<button data-book-name=\"${appState.activeBookName}\"></button>`) };\n\n        await itemHandlers.handleCreateEntry(mockEvent);\n\n      }\n\n    }\n  });\n\n\n\n  return {\n\n    handleGlobalSearch,\n\n    handleSearchClear,\n\n    handleSearchInputKeydown,\n\n    handleReplace,\n\n    handleToolbarToggleCollapse,\n\n    handleSortMenuToggle,\n\n    handleSortOptionSelect,\n\n    handleThemeMenuToggle,\n\n    handleThemeOptionSelect,\n\n    handlePositionMenuToggle,\n\n    handlePositionOptionSelect,\n\n    handleUnifiedStatusMenuToggle,\n\n    handleUnifiedStatusOptionSelect,\n\n    handleCharacterBookSwitch,\n\n    handleSelectionCheckboxChange,\n\n    togglePanel,\n\n    switchTab,\n\n    toggleMultiSelectMode,\n\n    handleSelectAll,\n\n    handleSelectNone,\n\n    handleSelectInvert,\n\n    handleBatchEnable,\n\n    handleBatchDisable,\n\n    handleBatchDelete,\n\n    handleCleanOrphanLorebooks,\n\n    handleHeaderClick,\n\n    handleMultiSelectContainerClick,\n\n    handleEditEntriesToggle,\n\n    handleRefresh,\n\n    handlePrimaryCreateButtonClick,\n\n  };\n}\n", "import {\n  appState,\n  showToast,\n  buildBookSelectionKey,\n  safeGetLorebookEntries,\n  errorCatched,\n  emitAnalyticsEvent,\n} from '../../../core.js';\nimport { resolveUnboundGlobalLorebooks } from '../../../dataLayer.js';\nimport { renderContent } from '../../render/index.js';\nimport { matchEntry } from '../../render/shared.js';\n\nconst getBookName = book => {\n  if (!book && book !== 0) return '';\n  if (typeof book === 'string') return book.trim();\n  if (book && typeof book === 'object' && typeof book.name === 'string') return book.name.trim();\n  return String(book ?? '').trim();\n};\n\nconst nowMs = () => {\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function') {\n    return performance.now();\n  }\n  return Date.now();\n};\n\nexport const createSelectUnboundBooksHandler = () => {\n  const handleSelectUnboundBooks = errorCatched(async event => {\n    event?.preventDefault?.();\n    event?.stopPropagation?.();\n\n    if (appState.activeView !== 'global-lore-list') {\n      showToast('\u8BE5\u64CD\u4F5C\u4EC5\u5728\u5168\u5C40\u4E16\u754C\u4E66\u5217\u8868\u89C6\u56FE\u53EF\u7528', 'info');\n      return;\n    }\n\n    if (appState.activeTab !== 'global-lore') {\n      showToast('\u8BE5\u64CD\u4F5C\u4EC5\u5728\u5168\u5C40\u4E16\u754C\u4E66\u5217\u8868\u53EF\u7528', 'info');\n      return;\n    }\n\n    const start = nowMs();\n    const { totalBooks, unboundNames, statsByName } = resolveUnboundGlobalLorebooks();\n    const books = Array.isArray(appState.allLorebooks) ? appState.allLorebooks : [];\n\n    const searchTermRaw =\n      typeof appState.globalSearch?.term === 'string' ? appState.globalSearch.term.trim() : '';\n    const normalizedTerm = searchTermRaw.toLowerCase();\n    const activeGlobalBookName = getBookName(appState.activeBookName);\n\n    const hasSearchTerm = Boolean(normalizedTerm && normalizedTerm.length);\n    const filteredBooks = hasSearchTerm\n      ? books.filter(book => {\n          const name = getBookName(book);\n          if (!name) return false;\n          const bookNameMatches = appState.searchFilters.bookName && name.toLowerCase().includes(normalizedTerm);\n          if (bookNameMatches) {\n            return true;\n          }\n          const entries = safeGetLorebookEntries(name);\n          if (!Array.isArray(entries) || entries.length === 0) {\n            return false;\n          }\n          return entries.some(entry => matchEntry(entry, normalizedTerm));\n        })\n      : books;\n\n    const visibleBooksWithName = filteredBooks\n      .map(book => {\n        const name = getBookName(book);\n        return { book, name };\n      })\n      .filter(({ name }) => typeof name === 'string' && name.length > 0);\n\n    const visibleNames = visibleBooksWithName.map(({ name }) => name);\n\n    const visibleUnboundNames = visibleBooksWithName\n      .filter(({ book, name }) => {\n        if (!name) return false;\n        if (activeGlobalBookName && name === activeGlobalBookName) return false;\n        if (book && book.enabled) return false;\n        if (unboundNames.has(name)) return true;\n        const stats = statsByName.get(name);\n        return stats ? stats.bindingCount === 0 : false;\n      })\n      .map(({ name }) => name);\n\n    if (visibleUnboundNames.length === 0) {\n      showToast('\u6CA1\u6709\u672A\u7ED1\u5B9A\u7684\u4E16\u754C\u4E66', 'info');\n      emitAnalyticsEvent({\n        category: 'lorebook',\n        action: 'select_unbound',\n        value: 0,\n        label: 'global_unbound_select',\n        feature: 'select_unbound_lorebooks',\n        view: appState.activeView,\n        meta: {\n          searchTerm: searchTermRaw,\n          visibleBookCount: visibleNames.length,\n          totalBookCount: totalBooks,\n          unboundTotal: unboundNames.size,\n        },\n      });\n      return;\n    }\n\n    appState.multiSelectMode = true;\n    appState.multiSelectTarget = 'book';\n    appState.selectedItems.clear();\n    visibleUnboundNames.forEach(name => {\n      const key = buildBookSelectionKey(name);\n      if (key) {\n        appState.selectedItems.add(key);\n      }\n    });\n\n    const end = nowMs();\n    const duration = Math.max(0, Math.round(end - start));\n\n    renderContent();\n    showToast(\n      `\u5DF2\u9009\u4E2D ${visibleUnboundNames.length} \u672C\u672A\u7ED1\u5B9A\u7684\u4E16\u754C\u4E66\uFF0C\u8BF7\u786E\u8BA4\u8FD9\u4E9B\u4E16\u754C\u4E66\u672A\u5728\u804A\u5929\u4E2D\u4F7F\u7528\uFF0C\u907F\u514D\u8BEF\u5220\u804A\u5929\u4E16\u754C\u4E66\u3002`,\n      'success',\n    );\n    console.log(\n      `[RegexLoreHub] \u9009\u62E9\u5B64\u7ACB\u4E16\u754C\u4E66\uFF1A\u5339\u914D ${visibleUnboundNames.length} / \u53EF\u89C1 ${visibleNames.length} / \u5168\u91CF ${totalBooks}\uFF0C\u8017\u65F6 ${duration}ms\u3002`,\n    );\n\n    emitAnalyticsEvent({\n      category: 'lorebook',\n      action: 'select_unbound',\n      value: visibleUnboundNames.length,\n      label: 'global_unbound_select',\n      feature: 'select_unbound_lorebooks',\n      view: appState.activeView,\n      meta: {\n        searchTerm: searchTermRaw,\n        visibleBookCount: visibleNames.length,\n        totalBookCount: totalBooks,\n        unboundTotal: unboundNames.size,\n        selectionCount: visibleUnboundNames.length,\n        durationMs: duration,\n      },\n    });\n  });\n\n  return {\n    handleSelectUnboundBooks,\n  };\n};\n", "import { get$, getParentDoc, getParentWin } from '../../core.js';\nimport { createLorebookHandlers } from './lorebook.js';\nimport { createItemHandlers } from './item.js';\nimport { createUIHandlers } from './ui.js';\nimport { createSelectUnboundBooksHandler } from './worldbook/selectUnboundBooks.js';\n\n// --- \u7EDF\u4E00\u5BFC\u51FA ---\nexport function createHandlers() {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  const parentWin = getParentWin();\n\n  const sharedDeps = { $, parentDoc, parentWin };\n\n  const lorebookHandlers = createLorebookHandlers(sharedDeps);\n  const itemHandlers = createItemHandlers(sharedDeps);\n  const uiHandlers = createUIHandlers({ ...sharedDeps, lorebookHandlers, itemHandlers });\n  const worldbookHandlers = createSelectUnboundBooksHandler();\n\n  return {\n    ...lorebookHandlers,\n    ...itemHandlers,\n    ...uiHandlers,\n    ...worldbookHandlers,\n  };\n}\n", "// \u81EA\u52A8\u751F\u6210\u7684\u6587\u4EF6\uFF0C\u8BF7\u52FF\u76F4\u63A5\u4FEE\u6539\u3002\nexport const builtCSS = `\n/*! tailwindcss v4.1.13 | MIT License | https://tailwindcss.com */\n@layer theme{:root,:host{--rlh-default-transition-duration:.15s;--rlh-default-transition-timing-function:cubic-bezier(.4,0,.2,1)}}@layer utilities;@layer base{#regex-lore-hub-panel *{text-shadow:none!important}#regex-lore-hub-panel{--rlh-panel-radius:20px;--rlh-focus-ring:0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-focus-ring:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}#regex-lore-hub-panel{--rlh-bg-color:#f5f7fb;--rlh-surface-color:#fffd;--rlh-text-color:#0f172a;--rlh-em-color:#475569;--rlh-border-color:#bfc8f5;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)12%,transparent)}}#regex-lore-hub-panel{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)20%,transparent)}}#regex-lore-hub-panel{--rlh-shadow-color:#0f172a2e;--rlh-header-bg:#eef2ffd9;--rlh-input-bg:#ffffffeb;--rlh-accent-color:#4f46e5;--rlh-green:#10b981;--rlh-red:#ef4444;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)18%,transparent)}}#regex-lore-hub-panel{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)18%,transparent)}}#regex-lore-hub-panel{--rlh-status-constant:#22c55e;--rlh-status-selective:#3b82f6;--rlh-status-vectorized:#a855f7}#regex-lore-hub-panel.dark{--rlh-bg-color:#101827;--rlh-surface-color:#111827cc;--rlh-text-color:#f9fafb;--rlh-em-color:#cbd5e1;--rlh-border-color:#2d3748;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)14%,transparent)}}#regex-lore-hub-panel.dark{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)22%,transparent)}}#regex-lore-hub-panel.dark{--rlh-shadow-color:#02061780;--rlh-header-bg:#0f172ae6;--rlh-input-bg:#1f2937d9;--rlh-accent-color:#6366f1;--rlh-green:#10b981;--rlh-red:#fb7185;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)20%,transparent)}}#regex-lore-hub-panel.dark{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)20%,transparent)}}#regex-lore-hub-panel.dark{--rlh-status-constant:#34d399;--rlh-status-selective:#60a5fa;--rlh-status-vectorized:#c084fc}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-bg-color:#f9f5d7;--rlh-surface-color:#fbf1c7eb;--rlh-text-color:#3c3836;--rlh-em-color:#7c6f64;--rlh-border-color:#d5ab7e;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)16%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)26%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-shadow-color:#3c383633;--rlh-header-bg:#ebdbb2d9;--rlh-input-bg:#fbf1c7e6;--rlh-accent-color:#d65d0e;--rlh-green:#98971a;--rlh-red:#cc241d;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)18%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)18%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox{--rlh-status-constant:#98971a;--rlh-status-selective:#458588;--rlh-status-vectorized:#b16286}@keyframes rlhFadeInUp{0%{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}@keyframes rlhSoftPulse{}@keyframes rlhToastIn{0%{opacity:0;transform:translate(-50%)translateY(28px)scale(.96)}60%{opacity:1;transform:translate(-50%)translateY(-4px)scale(1.02)}to{opacity:1;transform:translate(-50%)translateY(0)scale(1)}}@keyframes rlhHighlightPulse{0%{background-color:#fde68a}50%{background-color:#facc15}to{background-color:#fde68a}}}@layer components{#regex-lore-hub-panel{z-index:10000;width:100%;height:100dvh;min-height:100svh;color:var(--rlh-text-color);background:var(--rlh-bg-color);justify-content:center;align-items:center;padding:clamp(.8rem,1.5vw,1.3rem);display:none;position:fixed;inset:0}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{background:color-mix(in srgb,var(--rlh-bg-color)92%,transparent)}}#regex-lore-hub-panel{-webkit-backdrop-filter:blur(24px);backdrop-filter:blur(24px);font-family:Inter,Segoe UI,Microsoft YaHei,sans-serif;transition:opacity .25s}@media (max-width:1024px){#regex-lore-hub-panel{justify-content:flex-start;align-items:stretch}}#regex-lore-hub-panel .rlh-shell{border-radius:var(--rlh-panel-radius);background:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);width:min(1250px,100%);height:100%;box-shadow:0 32px 120px -60px var(--rlh-shadow-color);flex-direction:column;gap:clamp(.45rem,1vw,.75rem);margin:0 auto;padding:clamp(.75rem,1.4vw,1.15rem);animation:.3s ease-out both rlhFadeInUp;display:flex;position:relative;overflow:hidden}#regex-lore-hub-panel .rlh-shell:before{content:\"\";background:radial-gradient(circle at top right,var(--rlh-accent-color)0%,transparent 60%),radial-gradient(circle at bottom left,var(--rlh-green)0%,transparent 65%);position:absolute;inset:-140px}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-shell:before{background:radial-gradient(circle at top right,color-mix(in srgb,var(--rlh-accent-color)24%,transparent)0%,transparent 60%),radial-gradient(circle at bottom left,color-mix(in srgb,var(--rlh-green)18%,transparent)0%,transparent 65%)}}#regex-lore-hub-panel .rlh-shell:before{opacity:.32;pointer-events:none}@media (max-width:768px){#regex-lore-hub-panel .rlh-shell{border-radius:14px;padding:.55rem}}@media (min-width:1360px){#regex-lore-hub-panel .rlh-shell{border-radius:20px;padding:1.05rem 1.3rem}}.rlh-shell-header{justify-content:space-between;align-items:center;gap:.55rem;padding-block:.08rem;display:flex}.rlh-shell-title{flex-direction:column;gap:.18rem;display:flex}.rlh-shell-title h4{color:var(--rlh-text-color);margin:0;font-size:clamp(1rem,2vw,1.3rem);font-weight:600;line-height:1.2}.rlh-shell-meta{color:var(--rlh-em-color);align-items:center;gap:.35rem;font-size:max(.8125rem,13px);line-height:1.2;display:inline-flex;margin:0!important}.rlh-shell-version{background:var(--rlh-accent-color);border-radius:9999px;align-items:center;padding:.1rem .55rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-shell-version{background:color-mix(in srgb,var(--rlh-accent-color)16%,transparent)}}.rlh-shell-version{color:var(--rlh-text-color);font-size:.78rem;font-weight:600}.rlh-shell-dot{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-shell-dot{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-shell-dot{font-size:max(.8125rem,13px);line-height:1}.rlh-shell-updated{color:var(--rlh-em-color);font-size:.78rem}.rlh-shell-actions{align-items:center;gap:.4rem;display:flex}.rlh-shell-right{align-items:center;gap:.6rem;margin-left:auto;display:flex}.rlh-prefetch-indicator{text-align:right;flex-direction:column;align-items:flex-end;gap:.35rem;width:clamp(200px,34vw,320px);display:none}.rlh-prefetch-indicator[data-visible=true]{display:flex}.rlh-prefetch-text{color:var(--rlh-em-color);white-space:normal;font-size:.78rem}#rlh-prefetch-progress-text{width:100%}.rlh-prefetch-bar{background:var(--rlh-accent-color);border-radius:9999px;width:100%;height:4px;position:relative}@supports (color:color-mix(in lab, red, red)){.rlh-prefetch-bar{background:color-mix(in srgb,var(--rlh-accent-color)20%,transparent)}}.rlh-prefetch-bar{overflow:hidden}.rlh-prefetch-bar-inner{border-radius:inherit;background:var(--rlh-accent-color);width:0%;height:100%;transition:width .25s;display:block}.rlh-icon-button,.rlh-close-button{width:2.25rem;height:2.25rem;color:var(--rlh-text-color);cursor:pointer;background-color:#0000;border:1px solid #0000;border-radius:9999px;justify-content:center;align-items:center;transition:color .2s,background-color .2s,border-color .2s;display:inline-flex}.rlh-icon-button:hover,.rlh-close-button:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-icon-button:hover,.rlh-close-button:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-theme-toggle{border:1px solid var(--rlh-accent-color);border-radius:9999px;align-items:center;gap:.35rem;padding:.4rem .9rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle{border:1px solid color-mix(in srgb,var(--rlh-accent-color)28%,transparent)}}.rlh-theme-toggle{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle{background-color:color-mix(in srgb,var(--rlh-accent-color)12%,transparent)}}.rlh-theme-toggle{color:var(--rlh-text-color);cursor:pointer;font-size:.85rem;font-weight:500;transition:background-color .2s,color .2s,border-color .2s}.rlh-theme-toggle:hover{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)18%,transparent)}}.rlh-theme-toggle .rlh-theme-toggle-label{white-space:nowrap}.rlh-theme-toggle-caret{margin-left:.45rem;font-size:.78rem;transition:transform .2s}.rlh-theme-menu{align-items:center;display:inline-flex;position:relative}.rlh-theme-menu-list{min-width:12rem;padding:.55rem}.rlh-theme-option{justify-content:space-between;align-items:center;gap:.6rem;width:100%;padding:.45rem .65rem;display:flex}.rlh-theme-option-text{flex-direction:column;align-items:flex-start;gap:.18rem;display:flex}.rlh-theme-option-meta{color:var(--rlh-em-color);font-size:.78rem}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option-meta{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-theme-option-check{color:var(--rlh-accent-color);opacity:0;transition:opacity .18s,transform .18s;transform:scale(.92)}.rlh-theme-option[data-active=true] .rlh-theme-option-check{opacity:1;transform:scale(1)}.rlh-theme-option[data-active=true]{background-color:var(--rlh-selected-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option[data-active=true]{background-color:color-mix(in srgb,var(--rlh-selected-bg)72%,transparent)}}.rlh-theme-option[data-active=true]{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option[data-active=true]{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-theme-option[data-active=true]{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option[data-active=true]{color:color-mix(in srgb,var(--rlh-text-color)88%,var(--rlh-accent-color)12%)}}.rlh-theme-option[data-active=true] .rlh-theme-option-meta{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-option[data-active=true] .rlh-theme-option-meta{color:color-mix(in srgb,var(--rlh-em-color)65%,var(--rlh-accent-color)20%)}}.rlh-theme-menu.open .rlh-theme-toggle-caret{transform:rotate(180deg)}.rlh-tab-nav{background-color:var(--rlh-header-bg);flex-wrap:wrap;gap:.4rem;padding:.35rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-tab-nav{background-color:color-mix(in srgb,var(--rlh-header-bg)85%,transparent)}}.rlh-tab-nav{border:1px solid var(--rlh-border-color);border-radius:9999px}@supports (color:color-mix(in lab, red, red)){.rlh-tab-nav{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-tab{color:var(--rlh-em-color);cursor:pointer;border-radius:9999px;justify-content:center;align-items:center;gap:.55rem;padding:.4rem 1.1rem;font-size:.9rem;font-weight:500;transition:color .2s,background-color .2s,transform .2s;display:inline-flex}.rlh-tab:hover{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color)}.rlh-tab.active{background-color:var(--rlh-selected-bg);color:var(--rlh-text-color);box-shadow:inset 0 0 0 1px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-tab.active{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)60%,transparent)}}.rlh-tab-text-short{display:none}@media (max-width:640px){.rlh-tab-text-full{display:none}.rlh-tab-text-short{display:inline}}.rlh-main-area{flex-direction:column;flex:auto;gap:clamp(.6rem,1.4vw,1rem);width:100%;min-height:0;padding:0;display:flex}.rlh-toolbar-shell{flex-direction:column;gap:clamp(.6rem,1.3vw,.95rem);width:100%;display:flex}.rlh-toolbar-container,.rlh-replace-container{flex-direction:column;gap:clamp(.65rem,1.1vw,.9rem);display:flex}.rlh-toolbar-inner{background-color:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:clamp(.125rem,.3vw,.25rem);padding:clamp(.25rem,.5vw,.4rem);display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{background-color:color-mix(in srgb,var(--rlh-surface-color)95%,var(--rlh-accent-color)5%)}}.rlh-toolbar-inner{border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{border:1px solid color-mix(in srgb,var(--rlh-accent-color)24%,var(--rlh-border-color))}}.rlh-toolbar-inner{box-shadow:0 16px 42px -34px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{box-shadow:0 16px 42px -34px color-mix(in srgb,var(--rlh-shadow-color)78%,transparent)}}@media (max-width:768px){.rlh-toolbar-inner{border-radius:14px;padding:.55rem}.rlh-toolbar-section{gap:.4rem;padding:.45rem}}@media (min-width:1360px){.rlh-toolbar-inner{gap:1.1rem;padding:1.05rem 1.3rem}.rlh-toolbar-section{gap:.8rem;padding:.6rem .8rem}}.rlh-toolbar-section{background-color:#0000;border:none;border-radius:12px;flex-direction:column;gap:clamp(.1rem,.3vw,.2rem);padding:clamp(.1rem,.25vw,.2rem);display:flex}.rlh-toolbar-section--search,.rlh-toolbar-section--actions,.rlh-toolbar-section--multiselect{background-color:#0000}.rlh-toolbar-section--actions{flex-direction:row;align-items:center}.rlh-search-section-grid{flex-wrap:nowrap;align-items:stretch;gap:clamp(.25rem,.7vw,.5rem);display:flex}.rlh-search-section-main{flex:18rem;min-width:0}.rlh-search-section-multiselect{flex:0 14rem;justify-content:flex-start;align-items:flex-start;min-width:10rem;max-width:20rem;padding:5px 0 0;display:flex}.rlh-search-section-multiselect .rlh-multi-select-module{flex-direction:column;align-items:flex-start;gap:.25rem;width:100%;display:flex}.rlh-toolbar-section--actions .rlh-toolbar-actions{flex-wrap:wrap;justify-content:flex-start;align-items:center;gap:clamp(.25rem,.6vw,.45rem);width:100%;display:flex;overflow:visible}.rlh-toolbar-section--actions .rlh-toolbar-actions>*{flex-shrink:0}@media (max-width:960px){.rlh-search-section-grid{flex-direction:column}.rlh-search-section-main,.rlh-search-section-multiselect{flex:100%;max-width:none}.rlh-search-box{grid-template-columns:minmax(0,1fr);grid-template-areas:\"row\"\"replace\"\"meta\"}.rlh-replace-body{grid-template-columns:minmax(0,1fr) auto}}.rlh-content-pane{flex-direction:column;flex:auto;gap:clamp(.8rem,1.6vw,1.2rem);min-height:0;padding:0;display:flex}.rlh-content-pane>*{min-width:0}@media (max-width:768px){.rlh-content-pane{gap:.6rem}}.rlh-toolbar-btn{border:1px solid var(--rlh-accent-color);border-radius:12px;justify-content:flex-start;align-items:center;gap:.35rem;padding:.125rem .75rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{border:1px solid color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}.rlh-toolbar-btn{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-toolbar-btn{color:var(--rlh-text-color);cursor:pointer;box-shadow:inset 0 0 0 1px var(--rlh-accent-color);font-size:.9rem;font-weight:500}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)25%,transparent)}}.rlh-toolbar-btn{transition:color .2s,background-color .2s,border-color .2s,box-shadow .2s,transform .2s}.rlh-toolbar-icon-btn{border:1px solid var(--rlh-accent-color);border-radius:12px;justify-content:center;align-items:center;width:2.1rem;height:2.1rem;padding:0;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{border:1px solid color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}.rlh-toolbar-icon-btn{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-toolbar-icon-btn{color:var(--rlh-text-color);cursor:pointer;line-height:1;transition:color .2s,background-color .2s,border-color .2s,box-shadow .2s,transform .2s}.rlh-toolbar-icon-btn i{font-size:.95rem}.rlh-toolbar-icon-btn:hover{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)92%,var(--rlh-accent-color)20%)}}.rlh-toolbar-icon-btn:hover{color:var(--rlh-text-color)}.rlh-toolbar-icon-btn:focus{box-shadow:0 0 0 2px var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:focus{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-search-row .rlh-toolbar-icon-btn,.rlh-replace-body .rlh-toolbar-icon-btn{width:2rem;height:2rem}.rlh-toolbar-btn i{font-size:.95rem}.rlh-toggle-btn i,.rlh-action-btn-icon i,.rlh-toolbar-btn i{transition:transform .25s}.rlh-toolbar-btn span{white-space:nowrap}.rlh-toggle-btn:hover i,.rlh-action-btn-icon:hover i,.rlh-toolbar-btn:hover i{transform:translateY(-1px)scale(1.08)}.rlh-toolbar-group--leading .rlh-toolbar-btn,.rlh-toolbar-group--actions .rlh-toolbar-btn{width:100%}.rlh-toolbar-btn:hover{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)26%,var(--rlh-surface-color))}}.rlh-toolbar-btn:hover{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-border-color)30%)}}.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px var(--rlh-accent-color),0 10px 22px -16px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent),0 10px 22px -16px var(--rlh-shadow-color)}}.rlh-toolbar-btn:hover{color:var(--rlh-text-color);transform:translateY(-1px)scale(1.01)}.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{cursor:not-allowed;opacity:.55;box-shadow:none;border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{border-color:color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{color:color-mix(in srgb,var(--rlh-text-color)55%,var(--rlh-surface-color)45%)}}.rlh-toolbar-btn:focus-visible{box-shadow:0 0 0 2px var(--rlh-accent-color),inset 0 0 0 1.5px var(--rlh-accent-color);outline:none;animation:1.1s ease-out rlhSoftPulse}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:focus-visible{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)40%,transparent),inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-toolbar-btn.active{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{background-color:color-mix(in srgb,var(--rlh-accent-color)32%,var(--rlh-surface-color))}}.rlh-toolbar-btn.active{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{border-color:color-mix(in srgb,var(--rlh-accent-color)75%,var(--rlh-border-color)25%)}}.rlh-toolbar-btn.active{box-shadow:inset 0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)50%,transparent)}}.rlh-toolbar-btn.active{color:var(--rlh-text-color)}#regex-lore-hub-panel .rlh-toolbar-btn,#regex-lore-hub-panel .rlh-toolbar-btn:hover,#regex-lore-hub-panel .rlh-toolbar-btn.active{color:var(--rlh-text-color)!important}#regex-lore-hub-panel .rlh-toolbar-btn:disabled,#regex-lore-hub-panel .rlh-toolbar-btn.disabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-toolbar-btn:disabled,#regex-lore-hub-panel .rlh-toolbar-btn.disabled{color:color-mix(in srgb,var(--rlh-text-color)55%,var(--rlh-surface-color)45%)}}#regex-lore-hub-panel .rlh-toolbar-icon-btn,#regex-lore-hub-panel .rlh-action-btn-icon,#regex-lore-hub-panel .rlh-toggle-btn,#regex-lore-hub-panel .rlh-icon-button,#regex-lore-hub-panel .rlh-close-button,#regex-lore-hub-panel .rlh-search-action-btn,#regex-lore-hub-panel .rlh-multi-select-action-btn{color:var(--rlh-text-color)!important}#regex-lore-hub-panel .rlh-multi-select-action-btn.enable{color:var(--rlh-green)!important}#regex-lore-hub-panel .rlh-multi-select-action-btn.disable{color:var(--rlh-red)!important}#regex-lore-hub-panel .rlh-rename-save-btn{color:var(--rlh-green)!important}#regex-lore-hub-panel .rlh-rename-cancel-btn{color:var(--rlh-red)!important}#regex-lore-hub-panel .rlh-toolbar-toggle-btn{color:var(--rlh-text-color)!important}#regex-lore-hub-panel .rlh-toolbar-toggle-btn:hover{color:var(--rlh-accent-color)!important}#regex-lore-hub-panel .rlh-action-btn{color:#fff!important}#regex-lore-hub-panel .rlh-action-btn.rlh-maximize-btn,#regex-lore-hub-panel .rlh-modal-btn{color:var(--rlh-text-color)!important}#regex-lore-hub-panel .rlh-modal-btn.rlh-modal-ok{color:#fff!important}#regex-lore-hub-panel .rlh-modal-btn.rlh-modal-cancel,#regex-lore-hub-panel .rlh-error-retry-btn{color:var(--rlh-red)!important}#regex-lore-hub-panel .rlh-error-retry-btn:hover{color:#fff!important}.rlh-search-field{border:1px solid var(--rlh-border-color);border-radius:12px;align-items:center;gap:0;width:100%;min-width:0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-field{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-field{background-color:var(--rlh-input-bg);transition:border-color .2s,box-shadow .2s,color .2s;overflow:hidden}.rlh-search-row{grid-area:row;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:.125rem;width:100%;display:grid}.rlh-search-box{border:1px solid var(--rlh-border-color);border-radius:12px;grid-template-columns:minmax(0,1fr) auto;grid-template-areas:\"row replace\"\"meta meta\";gap:.125rem;padding:.2rem .3rem;display:grid}@supports (color:color-mix(in lab, red, red)){.rlh-search-box{border:1px solid color-mix(in srgb,var(--rlh-border-color)45%,transparent)}}.rlh-search-box{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-box{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,transparent)}}.rlh-search-box{box-shadow:0 8px 28px -24px var(--rlh-shadow-color)}.rlh-search-field .rlh-search-input{min-width:0;color:inherit;background:0 0;border:none;flex:auto;padding:.4rem .6rem;font-size:1rem}.rlh-search-field .rlh-search-input:focus{box-shadow:none;border:none;outline:none}.rlh-search-field:focus-within{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-field:focus-within{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-search-field:focus-within{box-shadow:var(--rlh-focus-ring);color:var(--rlh-text-color)}.rlh-search-meta{color:var(--rlh-em-color);flex-direction:row;grid-area:meta;align-items:center;gap:.4rem;font-size:.85rem;display:flex}.rlh-search-scope{color:var(--rlh-accent-color);font-weight:500}@supports (color:color-mix(in lab, red, red)){.rlh-search-scope{color:color-mix(in srgb,var(--rlh-accent-color)65%,var(--rlh-text-color))}}@media (max-width:1200px){.rlh-search-section-grid{flex-direction:column}.rlh-search-section-main,.rlh-search-section-multiselect{flex:100%;max-width:none}.rlh-search-box{grid-template-columns:minmax(0,1fr);grid-template-areas:\"row\"\"replace\"\"meta\"}.rlh-replace-body{grid-template-columns:minmax(0,1fr) auto}.rlh-search-meta{flex-wrap:wrap;justify-content:flex-start;gap:.35rem}}.rlh-sort-menu,.rlh-position-menu{align-items:center;width:auto;min-width:0;margin-left:auto;display:inline-flex;position:relative}.rlh-unified-status{align-items:stretch;min-width:0;display:inline-flex;position:relative}.rlh-unified-status-menu{border:1px solid var(--rlh-border-color);border-radius:12px;flex-direction:column;gap:.15rem;min-width:12rem;padding:.5rem;display:flex;position:absolute;top:calc(100% + .5rem);right:0}@supports (color:color-mix(in lab, red, red)){.rlh-unified-status-menu{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-unified-status-menu{background:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-unified-status-menu{background:color-mix(in srgb,var(--rlh-surface-color)95%,transparent)}}.rlh-unified-status-menu{box-shadow:0 24px 60px -28px var(--rlh-shadow-color);opacity:0;pointer-events:none;z-index:30;transition:opacity .18s,transform .18s;transform:translateY(8px)}.rlh-unified-status[data-open=true] .rlh-unified-status-menu{opacity:1;pointer-events:auto;transform:translate(0)}.rlh-unified-status-option{width:100%;color:inherit;cursor:pointer;background:0 0;border:none;border-radius:10px;justify-content:space-between;align-items:center;gap:.6rem;padding:.45rem .5rem;font-size:.85rem;font-weight:500;transition:background-color .18s,color .18s;display:flex}.rlh-unified-status-option:hover,.rlh-unified-status-option:focus-visible{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-unified-status-option:hover,.rlh-unified-status-option:focus-visible{background:color-mix(in srgb,var(--rlh-hover-bg)75%,transparent)}}.rlh-unified-status-option:hover,.rlh-unified-status-option:focus-visible{outline:none}.rlh-unified-status-option__label{text-align:right;flex:auto;min-width:0}.rlh-sort-menu-list,.rlh-position-menu-list{background-color:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);border-radius:14px;min-width:10rem;padding:.5rem;list-style:none;position:absolute;top:calc(100% + .5rem);right:0}@supports (color:color-mix(in lab, red, red)){.rlh-sort-menu-list,.rlh-position-menu-list{border:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-sort-menu-list,.rlh-position-menu-list{box-shadow:0 24px 60px -36px var(--rlh-shadow-color);z-index:99;opacity:0;visibility:hidden;pointer-events:none;transition:opacity var(--rlh-default-transition-duration)var(--rlh-default-transition-timing-function),transform var(--rlh-default-transition-duration)var(--rlh-default-transition-timing-function),visibility 0s linear var(--rlh-default-transition-duration);will-change:opacity,transform;flex-direction:column;gap:.35rem;display:flex;transform:translateY(6px)scale(.98)}.rlh-toolbar-group--actions .rlh-sort-menu-list,.rlh-toolbar-group--actions .rlh-position-menu-list{left:0;right:auto}.rlh-sort-menu.open .rlh-sort-menu-list,.rlh-position-menu.open .rlh-position-menu-list{opacity:1;visibility:visible;pointer-events:auto;transition-delay:0s,0s,0s;transform:translateY(0)scale(1)}.rlh-sort-option,.rlh-position-option{width:100%;color:var(--rlh-text-color);cursor:pointer;background-color:#0000;border:1px solid #0000;border-radius:10px;justify-content:space-between;align-items:center;gap:.4rem;padding:.4rem .6rem;font-size:.9rem;transition:background-color .2s,border-color .2s,color .2s;display:flex}.rlh-sort-option:hover,.rlh-position-option:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option:hover,.rlh-position-option:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-sort-option.active,.rlh-position-option.active{background-color:var(--rlh-selected-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option.active,.rlh-position-option.active{border-color:color-mix(in srgb,var(--rlh-accent-color)60%,transparent)}}.rlh-sort-option.active,.rlh-position-option.active{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option.active,.rlh-position-option.active{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-replace-body{grid-area:replace;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:.25rem;width:100%;display:grid}.rlh-info-text{color:var(--rlh-em-color);font-size:.9rem}@supports (color:color-mix(in lab, red, red)){.rlh-info-text{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-info-text{margin:.5rem 0}.rlh-info-text-small{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}@supports (color:color-mix(in lab, red, red)){.rlh-info-text-small{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-chat-lore-empty{text-align:center;background-color:var(--rlh-hover-bg);border-radius:16px;flex-direction:column;justify-content:center;align-items:center;gap:1rem;padding:2rem 1.5rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-chat-lore-empty{background-color:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}.rlh-chat-lore-empty{border:1px dashed var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-chat-lore-empty{border:1px dashed color-mix(in srgb,var(--rlh-border-color)75%,transparent)}}.rlh-detail-view{background-color:var(--rlh-surface-color);border-radius:18px;flex-direction:column;gap:.6rem;padding:.6rem .8rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-detail-view{background-color:color-mix(in srgb,var(--rlh-surface-color)94%,transparent)}}.rlh-detail-view{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-detail-view{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-detail-view{box-shadow:0 24px 70px -50px var(--rlh-shadow-color)}@media (max-width:768px){.rlh-detail-view{gap:.6rem;padding:.6rem .8rem}.rlh-detail-header{gap:.4rem;padding:.4rem .6rem}.rlh-detail-content{gap:.4rem}.rlh-entry-list-wrapper{gap:.4rem;padding:.4rem 0}.rlh-detail-header h2{font-size:1rem;line-height:1.1}}.rlh-detail-header{grid-template-columns:auto 1fr auto;align-items:center;gap:.4rem;padding:.4rem .6rem;display:grid}.rlh-detail-header h2{color:var(--rlh-text-color);text-align:center;white-space:nowrap;text-overflow:ellipsis;min-width:0;margin:0;padding-inline:.5rem;font-size:1.1rem;font-weight:600;overflow:hidden}.rlh-detail-header .rlh-back-to-list-btn{justify-self:start}.rlh-detail-header .rlh-item-controls{justify-self:end;align-items:center;gap:.4rem;display:inline-flex}.rlh-detail-content,.rlh-entry-list-wrapper{flex-direction:column;gap:.4rem;display:flex}.rlh-entry-list-wrapper .rlh-item-container{animation:.3s ease-out both rlhFadeListItem}@keyframes rlhFadeListItem{0%{opacity:0;transform:translateY(6px)scale(.95)}to{opacity:1;transform:translateY(0)scale(1)}}.rlh-regex-list{flex-direction:column;gap:.45rem;display:flex;position:relative}.rlh-regex-list.sorting-active{border:1.5px dashed var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{border:1.5px dashed color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}.rlh-regex-list.sorting-active{box-shadow:0 0 0 3px var(--rlh-accent-color),0 20px 50px -30px var(--rlh-shadow-color);border-radius:14px;padding:.35rem .45rem}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-accent-color)12%,transparent),0 20px 50px -30px var(--rlh-shadow-color)}}.rlh-regex-list.sorting-active{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{background:color-mix(in srgb,var(--rlh-hover-bg)45%,transparent)}}.rlh-regex-list.sorting-active .rlh-item-container{border-radius:12px}.rlh-regex-list .sortable-ghost{opacity:.2;transform:scale(.98)}.rlh-regex-list .sortable-chosen{box-shadow:0 18px 40px -28px var(--rlh-shadow-color);transform:rotate(.4deg)}.rlh-sorting-fallback{opacity:.7!important;transform:scale(1.02)!important}.rlh-entry-list-wrapper>*{margin:0}.rlh-order-indicator{background-color:var(--rlh-hover-bg);min-width:1.75rem;color:var(--rlh-accent-color);border-radius:9999px;justify-content:center;align-items:center;padding:.1rem .5rem;font-size:max(.8125rem,13px);font-weight:600;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-order-indicator{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-selection-control{justify-content:center;align-items:center;margin-right:.35rem;display:inline-flex}.rlh-selection-control input{cursor:pointer;width:1rem;height:1rem;accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-selection-control input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}.rlh-drag-handle{color:var(--rlh-em-color);justify-content:center;align-items:center;margin-right:.35rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-drag-handle{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-drag-handle{cursor:grab}.rlh-drag-handle:active{cursor:grabbing}.rlh-editor-group{border-top:1px solid var(--rlh-border-color);flex-direction:column;gap:.6rem;padding:.75rem 0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-editor-group{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-editor-group:first-of-type{border-top:none;padding-top:0}.rlh-editor-group h5{color:var(--rlh-em-color);font-size:.85rem;font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-editor-group h5{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-editor-grid{grid-template-columns:repeat(auto-fit,minmax(14rem,1fr));gap:.6rem;display:grid}.rlh-grid-item,.rlh-depth-container{flex-direction:column;gap:.4rem;display:flex}.rlh-depth-inputs{flex-wrap:wrap;gap:.6rem;display:flex}.rlh-editor-options-row{flex-wrap:wrap;gap:.4rem;display:flex}.rlh-editor-option-item{background-color:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.35rem;padding:.35rem .65rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-editor-option-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}.rlh-editor-option-item{color:var(--rlh-em-color);font-size:.85rem}.rlh-editor-option-item input{accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-editor-option-item input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}.rlh-select-nudge{min-width:8rem}.rlh-rename-ui{width:100%}.rlh-rename-input-wrapper{border:1px solid var(--rlh-border-color);border-radius:12px;align-items:center;gap:.4rem;width:100%;padding:.4rem .6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-rename-input-wrapper{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-rename-input-wrapper{background-color:var(--rlh-input-bg)}.rlh-rename-input{color:var(--rlh-text-color);background:0 0;border:none;outline:none;flex:1;font-size:.9rem}.rlh-rename-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)75%,transparent)}}.rlh-rename-save-btn{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-save-btn{border-color:color-mix(in srgb,var(--rlh-green)55%,transparent)}}.rlh-rename-cancel-btn{color:var(--rlh-red);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-cancel-btn{border-color:color-mix(in srgb,var(--rlh-red)55%,transparent)}}.rlh-global-toggle,.rlh-item-toggle{transition:background-color .2s,border-color .2s,color .2s}.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{border-color:color-mix(in srgb,var(--rlh-green)65%,transparent)}}.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{background-color:var(--rlh-green-bg)}.rlh-clickable-header{cursor:pointer}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{box-shadow:0 36px 120px -60px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{box-shadow:0 36px 120px -60px color-mix(in srgb,var(--rlh-accent-color)30%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{color:color-mix(in srgb,var(--rlh-accent-color)65%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{font-size:max(.8125rem,13px)}.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{box-shadow:0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-item-container.rlh-collapsed .rlh-item-header,.rlh-book-group.rlh-collapsed .rlh-global-book-header{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.rlh-collapsed .rlh-item-header,.rlh-book-group.rlh-collapsed .rlh-global-book-header{background-color:color-mix(in srgb,var(--rlh-hover-bg)45%,transparent)}}.sortable-ghost{opacity:.75;background-color:var(--rlh-selected-bg)}@supports (color:color-mix(in lab, red, red)){.sortable-ghost{background-color:color-mix(in srgb,var(--rlh-selected-bg)85%,transparent)}}.sortable-ghost{border:1px dashed var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.sortable-ghost{border:1px dashed color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}.rlh-search-controls{flex-wrap:wrap;align-items:center;gap:.7rem;display:flex}#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{border:1px solid var(--rlh-border-color);border-radius:12px;width:100%;min-width:0;padding:.4rem .6rem}@supports (color:color-mix(in lab, red, red)){#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);font-size:1rem;transition:border-color .2s,box-shadow .2s}#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{box-shadow:var(--rlh-focus-ring)}#rlh-search-input::placeholder,.rlh-search-input::placeholder,#rlh-replace-input::placeholder,.rlh-replace-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){#rlh-search-input::placeholder,.rlh-search-input::placeholder,#rlh-replace-input::placeholder,.rlh-replace-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-multi-select-module{flex-direction:column;align-items:flex-start;gap:.25rem;display:flex}.rlh-search-action-btn,.rlh-multi-select-action-btn{border:1px solid var(--rlh-border-color);border-radius:10px;justify-content:center;align-items:center;gap:.2rem;padding:.3rem .5rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-action-btn,.rlh-multi-select-action-btn{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-action-btn,.rlh-multi-select-action-btn{color:var(--rlh-text-color);cursor:pointer;background:0 0;font-size:.78rem;line-height:1;transition:color .2s,background-color .2s,border-color .2s,transform .2s}.rlh-multi-select-action-btn:active{transform:scale(.95)}.rlh-search-action-btn:hover,.rlh-multi-select-action-btn:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-action-btn:hover,.rlh-multi-select-action-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-multi-select-actions{flex-wrap:nowrap;align-items:center;gap:.3rem;display:inline-flex}.rlh-multi-select-action-btn.enable{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.enable{border-color:color-mix(in srgb,var(--rlh-green)60%,transparent)}}.rlh-multi-select-action-btn.enable{background-color:var(--rlh-green-bg)}.rlh-multi-select-action-btn.disable{color:var(--rlh-red);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.disable{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-multi-select-action-btn.disable{background-color:var(--rlh-red-bg)}#rlh-search-filters-container,.rlh-filter-list{flex-wrap:wrap;gap:.6rem;display:flex}.rlh-filter-item{background-color:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.4rem;padding:.4rem .65rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)65%,transparent)}}.rlh-filter-item{color:var(--rlh-em-color);font-size:.85rem}.rlh-filter-item input{accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}#rlh-multi-select-controls{align-items:center;gap:.35rem;display:none}#rlh-multi-select-controls.active{flex-wrap:wrap;display:flex}@media (max-width:960px){.rlh-multi-select-module{align-items:stretch;gap:.35rem}#rlh-multi-select-controls{flex-wrap:wrap;justify-content:flex-start;align-items:flex-start}.rlh-multi-select-actions{flex-wrap:wrap;justify-content:flex-start}}.rlh-content-pane{-webkit-overflow-scrolling:touch;scrollbar-gutter:stable both-edges;flex-direction:column;flex:auto;gap:1rem;min-height:0;padding-right:.25rem;display:flex;overflow:hidden auto}#regex-lore-hub-panel-content{-webkit-overflow-scrolling:touch;scrollbar-gutter:stable both-edges;scroll-behavior:smooth;flex:auto;min-height:clamp(18rem,48vh,32rem);padding-right:clamp(.25rem,.8vw,.5rem);display:block;overflow:hidden auto}#regex-lore-hub-panel-content>*+*{margin-top:clamp(.8rem,1.4vw,1.1rem)}#regex-lore-hub-panel-content::-webkit-scrollbar{width:6px}#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{background-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{border-radius:9999px}.rlh-book-group,.rlh-item-container{border:1px solid var(--rlh-border-color);border-radius:16px;flex-direction:column;min-height:0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-book-group,.rlh-item-container{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{background-color:color-mix(in srgb,var(--rlh-surface-color)94%,transparent)}}.rlh-book-group,.rlh-item-container{box-shadow:0 18px 50px -40px var(--rlh-shadow-color);overflow:hidden}.rlh-book-group-header{justify-content:center;align-items:center;padding:.85rem 1rem;display:flex;position:relative}.rlh-book-group-title{color:var(--rlh-text-color);text-align:center;white-space:nowrap;text-overflow:ellipsis;max-width:calc(100% - 8rem);margin:0;font-size:1.1rem;font-weight:600;overflow:hidden}.rlh-book-group-header .rlh-item-controls{align-items:center;gap:.4rem;display:inline-flex;position:absolute;top:50%;right:1rem;transform:translateY(-50%)}.rlh-global-book-header,.rlh-item-header{cursor:pointer;justify-content:flex-start;align-items:center;gap:.6rem;padding:.85rem 1rem;transition:background-color .2s,border-color .2s;display:flex}.rlh-global-book-header{flex-wrap:wrap;align-items:flex-start}.rlh-global-book-header .rlh-book-title-wrapper{flex:auto;min-width:0}.rlh-global-book-header .rlh-item-name{white-space:normal;word-break:break-word;flex:0 auto;min-width:0}.rlh-global-book-header .rlh-book-stats{white-space:nowrap}.rlh-global-book-header .rlh-item-controls{flex:none;margin-top:.1rem;margin-left:auto}.rlh-global-book-header.enabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{color:color-mix(in srgb,var(--rlh-text-color)70%,var(--rlh-accent-color)30%)}}.rlh-global-book-header.enabled{background:linear-gradient(135deg,var(--rlh-accent-color)0%,var(--rlh-accent-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{background:linear-gradient(135deg,color-mix(in srgb,var(--rlh-accent-color)32%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-accent-color)18%,var(--rlh-surface-color))100%)}}.rlh-global-book-header.enabled{box-shadow:0 18px 45px -30px var(--rlh-accent-color),inset 0 0 0 1px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{box-shadow:0 18px 45px -30px color-mix(in srgb,var(--rlh-accent-color)50%,transparent),inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-global-book-header.enabled .rlh-item-name{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled .rlh-item-name{color:color-mix(in srgb,var(--rlh-accent-color)85%,var(--rlh-text-color))}}.rlh-global-book-header.enabled .rlh-book-stats{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled .rlh-book-stats{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-em-color))}}.rlh-global-book-header.enabled:hover{background:linear-gradient(135deg,var(--rlh-accent-color)0%,var(--rlh-accent-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled:hover{background:linear-gradient(135deg,color-mix(in srgb,var(--rlh-accent-color)38%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-accent-color)22%,var(--rlh-surface-color))100%)}}.rlh-global-book-header:hover,.rlh-item-header:hover{background-color:var(--rlh-hover-bg)}.rlh-item-header-main{flex:auto;align-items:center;gap:.5rem;min-width:0;display:flex}.rlh-item-title-row{flex-wrap:wrap;align-items:center;gap:.45rem;display:inline-flex}.rlh-status-badge{--badge-color:var(--rlh-accent-color);letter-spacing:.01em;background:var(--badge-color);border-radius:999px;align-items:center;gap:.35rem;padding:.15rem .55rem;font-size:.75rem;font-weight:600;line-height:1;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-status-badge{background:color-mix(in srgb,var(--badge-color)18%,transparent)}}.rlh-status-badge{color:var(--badge-color)}@supports (color:color-mix(in lab, red, red)){.rlh-status-badge{color:color-mix(in srgb,var(--badge-color)80%,white 5%)}}.rlh-status-badge{white-space:nowrap}.rlh-status-badge i{font-size:.55rem}.rlh-status-badge__text{display:inline-block;transform:translateY(.5px)}.rlh-status-badge--constant{--badge-color:var(--rlh-status-constant)}.rlh-status-badge--selective{--badge-color:var(--rlh-status-selective)}.rlh-status-badge--vectorized{--badge-color:var(--rlh-status-vectorized)}.rlh-item-name{color:var(--rlh-text-color);flex-shrink:0;font-size:.95rem;font-weight:500}@media (max-width:720px){.rlh-item-header{flex-wrap:wrap;align-items:flex-start;gap:.45rem;padding:.7rem .75rem}.rlh-item-header-main{flex-direction:column;align-items:flex-start;gap:.3rem;width:100%}.rlh-item-name{text-overflow:ellipsis;white-space:nowrap;flex:auto;min-width:0;max-width:100%;overflow:hidden}.rlh-book-group-header{justify-content:flex-start;align-items:flex-start}.rlh-book-group-title{text-align:left;width:100%;max-width:100%}.rlh-item-controls{flex-direction:row;justify-content:flex-end;align-self:flex-start;align-items:center;gap:.18rem;width:auto}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{border-width:1px;border-radius:.6rem;width:1.55rem;height:1.55rem;padding:0}.rlh-item-controls .rlh-toggle-btn i,.rlh-item-controls .rlh-action-btn-icon i{font-size:max(.8125rem,13px)}.rlh-detail-header .rlh-item-controls{justify-self:flex-end}.rlh-book-group-header .rlh-item-controls{justify-content:flex-end;align-items:center;margin-top:.25rem;margin-left:auto;position:static;transform:none}.rlh-item-meta{gap:.25rem;font-size:.74rem}.rlh-item-meta-chip{gap:.2rem;padding:.12rem .45rem}}.rlh-item-meta{color:var(--rlh-em-color);flex-wrap:wrap;align-items:center;gap:.35rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta{color:color-mix(in srgb,var(--rlh-em-color)92%,transparent)}}.rlh-item-meta{font-size:.78rem}.rlh-item-meta-chip{background:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.25rem;padding:.15rem .55rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)70%,transparent)}}.rlh-item-meta-chip{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip{border:1px solid color-mix(in srgb,var(--rlh-border-color)50%,transparent)}}.rlh-item-meta-chip{line-height:1.2}.rlh-item-meta-chip i{color:var(--rlh-accent-color);font-size:.7rem}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip i{color:color-mix(in srgb,var(--rlh-accent-color)75%,var(--rlh-em-color))}}#regex-lore-hub-panel.dark .rlh-item-meta-chip{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}#regex-lore-hub-panel.dark .rlh-item-meta-chip{border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-item-meta-chip{border-color:color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-meta-chip{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-meta-chip{border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-theme-gruvbox .rlh-item-meta-chip{border-color:color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-item-controls{flex-wrap:wrap;align-items:center;gap:.35rem;margin-left:auto;display:inline-flex}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{flex-shrink:0}@media (max-width:960px){.rlh-item-controls{gap:.28rem}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:2rem;height:2rem}}@media (max-width:900px) and (min-width:721px){.rlh-item-controls{flex-direction:column;align-items:flex-end;gap:.22rem;width:auto}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:1.75rem;height:1.75rem}.rlh-item-name{flex:auto;min-width:0;max-width:100%}}.rlh-toggle-btn,.rlh-action-btn-icon{border:1px solid var(--rlh-border-color);border-radius:9999px;justify-content:center;align-items:center;width:2.25rem;height:2.25rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toggle-btn,.rlh-action-btn-icon{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-toggle-btn,.rlh-action-btn-icon{color:var(--rlh-text-color);cursor:pointer;background:0 0;transition:color .2s,background-color .2s,border-color .2s,transform .2s}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{transform:translateY(-1px)scale(1.03)}.rlh-item-container.enabled .rlh-item-name,.rlh-book-group.enabled .rlh-item-name{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.enabled .rlh-item-name,.rlh-book-group.enabled .rlh-item-name{color:color-mix(in srgb,var(--rlh-accent-color)80%,var(--rlh-text-color))}}.rlh-collapsible-content{border-top:1px solid var(--rlh-border-color);margin-top:.75rem;padding:0 1rem 1rem;display:none}@supports (color:color-mix(in lab, red, red)){.rlh-collapsible-content{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-collapsible-content{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-collapsible-content{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,transparent)}}.rlh-entry-actions{border-bottom:1px dashed var(--rlh-border-color);flex-wrap:wrap;gap:.6rem;padding:.9rem 1rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-entry-actions{border-bottom:1px dashed color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-action-btn{background-color:var(--rlh-accent-color);color:#fff;cursor:pointer;border:none;border-radius:12px;justify-content:center;align-items:center;gap:.4rem;padding:.55rem 1rem;font-size:.9rem;font-weight:500;transition:transform .2s,opacity .2s;display:inline-flex}.rlh-action-btn:hover{opacity:.9}.rlh-action-btn.rlh-maximize-btn{border:1px solid var(--rlh-em-color);background:0 0}@supports (color:color-mix(in lab, red, red)){.rlh-action-btn.rlh-maximize-btn{border:1px solid color-mix(in srgb,var(--rlh-em-color)45%,transparent)}}.rlh-action-btn.rlh-maximize-btn{color:var(--rlh-em-color)}.rlh-editor-wrapper{flex-direction:column;gap:1rem;display:flex}.rlh-editor-field{flex-direction:column;gap:.35rem;display:flex}.rlh-editor-field label{background-color:var(--rlh-header-bg);padding:.55rem .85rem;display:block}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field label{background-color:color-mix(in srgb,var(--rlh-header-bg)82%,transparent)}}.rlh-editor-field label{border-bottom:1px solid var(--rlh-border-color);border-radius:12px 12px 0 0}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field label{border-bottom:1px solid color-mix(in srgb,var(--rlh-border-color)68%,transparent)}}.rlh-editor-field label{color:var(--rlh-text-color);margin:0;font-size:.875rem;font-weight:600;line-height:1.3}.rlh-editor-field label+*{border-top-left-radius:0;border-top-right-radius:0;margin-top:0}.rlh-viewer-field{gap:0}.rlh-regex-viewer{grid-template-columns:repeat(auto-fit,minmax(14rem,1fr));gap:.75rem;display:grid}.rlh-regex-viewer>.rlh-editor-field:nth-child(-n+2){grid-column:1/-1}.rlh-entry-viewer{flex-direction:column;gap:.75rem;display:flex}.rlh-viewer-field label{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-field label{background-color:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}.rlh-viewer-field label{border-bottom-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-field label{border-bottom-color:color-mix(in srgb,var(--rlh-accent-color)28%,transparent)}}.rlh-viewer-text{border:1px solid var(--rlh-border-color);padding:.6rem .85rem}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-text{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-viewer-text{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);white-space:pre-wrap;border-top:none;border-radius:0 0 12px 12px;line-height:1.5}.rlh-viewer-text>article{margin:0}.rlh-editor-field .rlh-edit-content,.rlh-editor-field article{border-top:none;border-radius:0 0 12px 12px;margin-top:0}#regex-lore-hub-panel.dark .rlh-editor-field label{background-color:var(--rlh-header-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-editor-field label{background-color:color-mix(in srgb,var(--rlh-header-bg)70%,transparent)}}#regex-lore-hub-panel.dark .rlh-editor-field label{border-bottom-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-editor-field label{border-bottom-color:color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-field label{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-field label{background-color:color-mix(in srgb,var(--rlh-hover-bg)70%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-field label{border-bottom-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-field label{border-bottom-color:color-mix(in srgb,var(--rlh-accent-color)32%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-text{border-color:color-mix(in srgb,var(--rlh-border-color)50%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{background-color:var(--rlh-input-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-text{background-color:color-mix(in srgb,var(--rlh-input-bg)90%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{border-top:none}.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{border:1px solid var(--rlh-border-color);border-radius:12px;width:100%;padding:.55rem .75rem}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);transition:border-color .2s,box-shadow .2s}.rlh-editor-field label+:is(input,textarea,select){border-top:none;border-radius:0 0 12px 12px}.rlh-editor-field textarea{resize:vertical;min-height:8rem}.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{box-shadow:var(--rlh-focus-ring)}.rlh-toast-notification,.rlh-progress-toast{background-color:var(--rlh-accent-color);color:#fff;box-shadow:0 24px 120px -40px var(--rlh-shadow-color);opacity:0;pointer-events:none;z-index:10002;border-radius:9999px;padding:.9rem 1.3rem;font-size:.9rem;font-weight:500;transition:opacity .25s,transform .25s;position:fixed;bottom:clamp(1rem,4vw,2rem);left:50%;transform:translate(-50%)translateY(20px)}.rlh-progress-toast{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-progress-toast{background-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-toast-notification.visible,.rlh-progress-toast.visible{opacity:1;animation:.38s cubic-bezier(.3,.7,.4,1.1) both rlhToastIn;transform:translate(-50%)translateY(0)}.rlh-modal-overlay{z-index:10003;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);background:#0206178c;justify-content:center;align-items:center;display:flex;position:fixed;inset:0}.rlh-modal-content{background:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);width:min(420px,90%);box-shadow:0 30px 120px -60px var(--rlh-shadow-color);border-radius:16px;margin:auto;overflow:hidden}.rlh-modal-header{border-bottom:1px solid var(--rlh-border-color);padding:1rem 1.25rem;font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-modal-header{border-bottom:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-body{color:var(--rlh-em-color);flex-direction:column;gap:.6rem;padding:1.1rem 1.25rem;display:flex}.rlh-modal-footer{border-top:1px solid var(--rlh-border-color);justify-content:flex-end;gap:.6rem;padding:.9rem 1.25rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-modal-footer{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-btn{border:1px solid var(--rlh-border-color);border-radius:12px;padding:.55rem 1.1rem}@supports (color:color-mix(in lab, red, red)){.rlh-modal-btn{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-btn{color:var(--rlh-text-color);cursor:pointer;background:0 0;font-weight:500;transition:background-color .2s,border-color .2s}.rlh-modal-btn:hover{background-color:var(--rlh-hover-bg)}.rlh-modal-btn.rlh-modal-ok{background-color:var(--rlh-accent-color);color:#fff;border-color:#0000}.rlh-modal-btn.rlh-modal-cancel{background-color:var(--rlh-red-bg);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-modal-btn.rlh-modal-cancel{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-modal-btn.rlh-modal-cancel{color:var(--rlh-red)}.rlh-loading{background:var(--rlh-surface-color);border-radius:20px;align-items:center;gap:1.25rem;padding:1.4rem 1.6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-loading{background:color-mix(in srgb,var(--rlh-surface-color)96%,transparent)}}.rlh-loading{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-loading{border:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-loading{box-shadow:0 24px 80px -50px var(--rlh-shadow-color)}.rlh-loading-spinner{border:3px solid var(--rlh-em-color);border-radius:9999px;width:2.6rem;height:2.6rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-spinner{border:3px solid color-mix(in srgb,var(--rlh-em-color)35%,transparent)}}.rlh-loading-spinner{border-top-color:var(--rlh-accent-color);animation:.9s linear infinite rlh-spin}.rlh-loading-text{flex-direction:column;flex:1;gap:.55rem;display:flex}.rlh-loading-title{color:var(--rlh-text-color);font-size:.95rem;font-weight:600}.rlh-loading-status{color:var(--rlh-text-color);font-size:.9rem}.rlh-loading-detail{color:var(--rlh-em-color);font-size:.82rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-detail{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-loading-bar{background:var(--rlh-hover-bg);border-radius:9999px;width:100%;height:.4rem;position:relative}@supports (color:color-mix(in lab, red, red)){.rlh-loading-bar{background:color-mix(in srgb,var(--rlh-hover-bg)75%,transparent)}}.rlh-loading-bar{overflow:hidden}.rlh-loading-bar-inner{background:linear-gradient(90deg,var(--rlh-accent-color),var(--rlh-accent-color));width:0%;height:100%}@supports (color:color-mix(in lab, red, red)){.rlh-loading-bar-inner{background:linear-gradient(90deg,var(--rlh-accent-color),color-mix(in srgb,var(--rlh-accent-color)70%,transparent))}}.rlh-loading-bar-inner{transition:width .3s}.rlh-loading-progress{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}@supports (color:color-mix(in lab, red, red)){.rlh-loading-progress{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-menu-icon{width:1.1rem;height:1.1rem;color:var(--rlh-accent-color);justify-content:center;align-items:center;display:inline-flex}@keyframes rlh-spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.rlh-edit-content{border:1px solid var(--rlh-border-color);border-radius:0 0 12px 12px;min-height:6rem;padding:.75rem}@supports (color:color-mix(in lab, red, red)){.rlh-edit-content{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-edit-content{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);white-space:pre-wrap}.rlh-error-wrapper{text-align:center;border:1px dashed var(--rlh-red);border-radius:16px;padding:1.5rem}@supports (color:color-mix(in lab, red, red)){.rlh-error-wrapper{border:1px dashed color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-error-wrapper{background-color:var(--rlh-red-bg)}.rlh-error-title{color:var(--rlh-red);margin-bottom:.75rem;font-weight:600}.rlh-error-text{color:var(--rlh-em-color);font-size:.9rem}.rlh-error-retry-btn{border:1px solid var(--rlh-red);color:var(--rlh-red);cursor:pointer;background-color:#0000;border-radius:9999px;margin-top:1rem;padding:.55rem 1.1rem;transition:background-color .2s}.rlh-error-retry-btn:hover{background-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-error-retry-btn:hover{background-color:color-mix(in srgb,var(--rlh-red)18%,transparent)}}.rlh-error-retry-btn:hover{color:#fff}.rlh-search-card,.rlh-filters-card{background:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:.9rem;padding:1rem 1.1rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-card,.rlh-filters-card{background:color-mix(in srgb,var(--rlh-surface-color)92%,transparent)}}.rlh-search-card,.rlh-filters-card{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-card,.rlh-filters-card{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-card,.rlh-filters-card{box-shadow:0 20px 60px -40px var(--rlh-shadow-color)}.rlh-section-title{letter-spacing:.08em;text-transform:uppercase;color:var(--rlh-em-color);font-size:max(.8125rem,13px);font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-section-title{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-toast-notification.success{background-color:var(--rlh-green)}.rlh-toast-notification.error{background-color:var(--rlh-red)}.rlh-toast-notification.info{background-color:var(--rlh-accent-color)}@media (prefers-reduced-motion:reduce){#regex-lore-hub-panel .rlh-shell,.rlh-toolbar-btn:focus-visible{animation:none}.rlh-toast-notification.visible,.rlh-progress-toast.visible{transition:opacity .2s,transform .2s;animation:none}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover,.rlh-toolbar-btn:hover,.rlh-toggle-btn:hover i,.rlh-action-btn-icon:hover i,.rlh-toolbar-btn:hover i{transform:none}}.rlh-breadcrumbs{align-items:center;gap:.4rem;margin-bottom:.5rem;font-size:.9rem;display:flex}.rlh-breadcrumb-item{color:var(--rlh-em-color);text-decoration:none;transition:color .2s}.rlh-breadcrumb-item:hover{color:var(--rlh-accent-color)}.rlh-breadcrumb-item.active{color:var(--rlh-text-color);pointer-events:none;font-weight:500}.rlh-breadcrumb-separator{color:var(--rlh-em-color)}.rlh-empty-state{text-align:center;background-color:var(--rlh-hover-bg);border-radius:16px;flex-direction:column;justify-content:center;align-items:center;margin-top:1rem;padding:2rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-empty-state{background-color:color-mix(in srgb,var(--rlh-hover-bg)50%,transparent)}}.rlh-empty-state{border:1px dashed var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-empty-state{border:1px dashed color-mix(in srgb,var(--rlh-border-color)80%,transparent)}}.rlh-empty-icon{color:var(--rlh-accent-color);background-color:var(--rlh-selected-bg);border-radius:9999px;justify-content:center;align-items:center;width:4rem;height:4rem;margin-bottom:1rem;font-size:2rem;display:flex}.rlh-empty-state h4{color:var(--rlh-text-color);margin-bottom:.5rem;font-size:1.1rem;font-weight:600}.rlh-empty-state p{color:var(--rlh-em-color);max-width:300px}.rlh-book-group{transition:box-shadow .2s,border-color .2s;position:relative}.rlh-book-group.enabled{border-left:3px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{border-left:3px solid color-mix(in srgb,var(--rlh-accent-color)80%,transparent)}}.rlh-book-group.enabled{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color))}}.rlh-book-group.enabled{background:linear-gradient(160deg,var(--rlh-accent-color)0%,var(--rlh-surface-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{background:linear-gradient(160deg,color-mix(in srgb,var(--rlh-accent-color)20%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-surface-color)96%,transparent)100%)}}.rlh-book-group.enabled{box-shadow:0 26px 70px -46px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{box-shadow:0 26px 70px -46px color-mix(in srgb,var(--rlh-accent-color)58%,transparent)}}.rlh-book-title-wrapper{flex-direction:column;flex:1;gap:.2rem;display:flex}.rlh-book-stats{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}.rlh-book-summary{background-color:var(--rlh-hover-bg);padding:.5rem 1rem;font-size:.85rem}@supports (color:color-mix(in lab, red, red)){.rlh-book-summary{background-color:color-mix(in srgb,var(--rlh-hover-bg)40%,transparent)}}.rlh-book-summary{border-top:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-summary{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-used-by-chars span{background-color:var(--rlh-selected-bg);border-radius:9999px;margin:.1rem;padding:.1rem .5rem;font-size:max(.8125rem,13px);display:inline-block}.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{border:1px solid var(--rlh-border-color);border-radius:12px;padding:.45rem .65rem}@supports (color:color-mix(in lab, red, red)){.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{background-color:var(--rlh-input-bg);color:var(--rlh-text-color)}.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{box-shadow:var(--rlh-focus-ring)}.rlh-loading{pointer-events:none;opacity:.5;position:relative}.rlh-loading>i{visibility:hidden}.rlh-loading:after{content:\"\";border:2px solid oklch(70.7% .022 261.325);border-top-color:oklch(62.3% .214 259.815);border-radius:50%;width:16px;height:16px;margin-top:-8px;margin-left:-8px;animation:.8s linear infinite rlh-spin;position:absolute;top:50%;left:50%}.rlh-highlight{color:#1f2937;background-color:#facc15;animation:.5s ease-out rlhHighlightPulse}.rlh-replace-confirm-modal{color:var(--rlh-text-color);flex-direction:column;gap:.6rem;display:flex}.rlh-replace-stats{background:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-replace-stats{background:color-mix(in srgb,var(--rlh-accent-color)6%,transparent)}}.rlh-replace-stats{border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-replace-stats{border:1px solid color-mix(in srgb,var(--rlh-accent-color)22%,transparent)}}.rlh-replace-stats{border-radius:10px;padding:.6rem .8rem}.rlh-replace-stats h4{color:var(--rlh-text-color);margin:0 0 .4rem;font-weight:600}.rlh-replace-stats ul{margin:0;padding-left:1.1rem}.rlh-confirm-scroll-list{border:1px solid var(--rlh-border-color);background:var(--rlh-surface-color);border-radius:10px;max-height:12rem;padding:.4rem .25rem;overflow-y:auto}.rlh-confirm-entry-list{margin:0;padding:.25rem .25rem .25rem .5rem;list-style:none}.rlh-confirm-entry-item{border-radius:8px;padding:.35rem .5rem;transition:background-color .15s}.rlh-confirm-entry-item:hover{background:var(--rlh-hover-bg)}.rlh-toolbar-btn:focus-visible,.rlh-icon-button:focus-visible,.rlh-close-button:focus-visible,.rlh-toggle-btn:focus-visible,.rlh-action-btn-icon:focus-visible,.rlh-toolbar-icon-btn:focus-visible{outline-offset:2px;outline:3px solid var(--rlh-accent-color)!important;box-shadow:0 0 0 5px var(--rlh-accent-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:focus-visible,.rlh-icon-button:focus-visible,.rlh-close-button:focus-visible,.rlh-toggle-btn:focus-visible,.rlh-action-btn-icon:focus-visible,.rlh-toolbar-icon-btn:focus-visible{box-shadow:0 0 0 5px color-mix(in srgb,var(--rlh-accent-color)20%,transparent)!important}}input:focus-visible,select:focus-visible,textarea:focus-visible,[contenteditable]:focus-visible{outline:3px solid var(--rlh-accent-color);outline-offset:2px}}.rlh-toolbar-toggle-btn{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color);border:1px solid var(--rlh-border-color);cursor:pointer;border-radius:8px;justify-content:center;align-items:center;padding:.5rem 1rem;transition:background-color .2s,color .2s;display:inline-flex}.rlh-toolbar-toggle-btn:hover{background-color:var(--rlh-selected-bg);color:var(--rlh-accent-color)}#regex-lore-hub-toolbar-shell{transition:max-height .3s ease-in-out}.rlh-toolbar-shell--collapsed{max-height:0;margin-top:0;margin-bottom:0;padding-top:0;padding-bottom:0;overflow:hidden}@media (max-width:640px){.rlh-toggle-btn,.rlh-action-btn-icon,.rlh-toolbar-icon-btn,.rlh-icon-button,.rlh-close-button{width:44px;height:44px;padding:.5rem;min-width:44px!important;min-height:44px!important}.rlh-multi-select-action-btn{padding:.6rem .8rem;min-width:44px!important;min-height:44px!important}.rlh-item-controls{gap:.5rem!important}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:44px!important;height:44px!important}}\n`;\n", "import { loadAllData, loadThemePreference } from '../dataLayer.js';\n\nimport {\n\n  DOM_ID,\n  PANEL_ID,\n\n  BUTTON_ID,\n\n  BUTTON_ICON_URL,\n\n  BUTTON_TOOLTIP,\n\n  BUTTON_TEXT_IN_MENU,\n\n  CLOSE_BTN_ID,\n\n  SEARCH_INPUT_ID,\n\n  REFRESH_BTN_ID,\n\n  CORE_TOOLBAR_ID,\n\n  REPLACE_TOOL_CONTAINER_ID,\n\n  REPLACE_TOGGLE_BTN_ID,\n\n  REPLACE_INPUT_ID,\n\n  TOGGLE_COLLAPSE_BTN_ID,\n\n  TOGGLE_RECURSION_BTN_ID,\n\n  FIX_KEYWORDS_BTN_ID,\n\n  SORT_MENU_BUTTON_ID,\n\n  POSITION_MENU_BUTTON_ID,\n  UNIFIED_STATUS_BUTTON_ID,\n\n  CREATE_LOREBOOK_BTN_ID,\n\n  CHARACTER_BOOK_SWITCH_ID,\n\n  PREFETCH_INDICATOR_ID,\n\n  PREFETCH_PROGRESS_TEXT_ID,\n\n  PREFETCH_PROGRESS_BAR_ID,\n  appState,\n  showModal,\n  syncThemeToDom,\n  listThemes,\n  getActiveTheme,\n  getThemeLabel,\n  setActiveTheme,\n  onThemeChange,\n  THEME_MENU_WRAPPER_ID,\n  THEME_MENU_ID,\n  THEME_TOGGLE_BTN_ID,\n  THEME_TOGGLE_LABEL_ID,\n  THEME_OPTION_CLASS,\n  escapeHtml,\n\n  get$,\n\n  getParentDoc,\n\n  getParentWin,\n\n} from '../core.js';\n\nimport { toggleToolbar } from './handlers/ui.js';\n\nimport { renderContent } from './render/index.js';\n\nimport { builtCSS } from '../styles/generated.js';\n\nconst LOCAL_SORTABLE_URL = (() => {\n  try {\n    // \u57FA\u4E8E\u5F53\u524D\u6A21\u5757\u8DEF\u5F84\u63A8\u5BFC vendor \u76EE\u5F55\u4E0B\u7684 Sortable \u8D44\u6E90\n    return new URL('../vendor/Sortable.min.js', import.meta.url).href;\n  } catch (error) {\n    console.error('[RegexLoreHub] \u8BA1\u7B97 SortableJS \u672C\u5730\u8DEF\u5F84\u5931\u8D25\uFF1A', error);\n    return '';\n  }\n})();\n\nconst normalizeUrl = value => {\n  if (!value || typeof value !== 'string') return '';\n  return value.trim().replace(/\\\\/g, '/').replace(/\\/+$/, '');\n};\n\nconst joinUrlSegments = (base, segment) => {\n  const normalizedBase = normalizeUrl(base);\n  if (!normalizedBase) return '';\n  const cleanedSegment = segment.replace(/^\\/+/, '');\n  return `${normalizedBase}/${cleanedSegment}`;\n};\n\nconst collectSortableCandidateUrls = (parentDoc, parentWin) => {\n  const candidates = [];\n  const addCandidate = url => {\n    if (!url || typeof url !== 'string') return;\n    const trimmed = url.trim();\n    if (!trimmed) return;\n    if (!candidates.includes(trimmed)) candidates.push(trimmed);\n  };\n\n  addCandidate(joinUrlSegments(appState.paths?.vendor, 'Sortable.min.js'));\n  addCandidate(joinUrlSegments(appState.paths?.rlhRoot, 'vendor/Sortable.min.js'));\n\n  try {\n    addCandidate(new URL('../vendor/Sortable.min.js', import.meta.url).href);\n  } catch (error) {\n    console.warn('[RegexLoreHub] \u57FA\u4E8E\u6A21\u5757\u8DEF\u5F84\u63A8\u5BFC Sortable \u8D44\u6E90\u5931\u8D25\uFF1A', error);\n  }\n\n  try {\n    if (parentDoc) {\n      const scriptEls = parentDoc.querySelectorAll('script[src]');\n      scriptEls.forEach(scriptEl => {\n        const src = scriptEl.getAttribute('src');\n        if (!src || !/regex[-_]lore[-_]hub/i.test(src)) return;\n        try {\n          const absolute = new URL(src, parentWin?.location?.href || window.location.href);\n          const base = normalizeUrl(absolute.href.replace(/\\/[^/]*$/, ''));\n          addCandidate(joinUrlSegments(base, 'vendor/Sortable.min.js'));\n          addCandidate(joinUrlSegments(base, 'src/vendor/Sortable.min.js'));\n        } catch (innerError) {\n          console.warn('[RegexLoreHub] \u5BBF\u4E3B\u811A\u672C\u8DEF\u5F84\u63A8\u5BFC\u5931\u8D25\uFF1A', innerError);\n        }\n      });\n    }\n  } catch (error) {\n    console.warn('[RegexLoreHub] \u904D\u5386\u5BBF\u4E3B\u811A\u672C\u8282\u70B9\u5931\u8D25\uFF1A', error);\n  }\n\n  addCandidate(LOCAL_SORTABLE_URL);\n  addCandidate('https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js');\n\n  return candidates.filter(Boolean);\n};\n\n\n\nexport async function initializeUI(createHandlers) {\n\n  const $ = get$();\n\n  const parentDoc = getParentDoc();\n\n  const parentWin = getParentWin();\n\n  try {\n    const storedThemeId = await loadThemePreference();\n    if (storedThemeId) {\n      const restoredTheme = setActiveTheme(storedThemeId, {\n        applyToDom: false,\n        silent: true,\n        reason: 'restore',\n      });\n      if (!restoredTheme) {\n        console.warn('[RegexLoreHub] \u65E0\u6CD5\u6062\u590D\u5B58\u50A8\u7684\u4E3B\u9898\uFF0CID:', storedThemeId);\n      }\n    } else {\n      setActiveTheme('dark', { applyToDom: false, silent: true, reason: 'initial-default' });\n    }\n  } catch (error) {\n    console.warn('[RegexLoreHub] \u8BFB\u53D6\u4E3B\u9898\u504F\u597D\u5931\u8D25\uFF1A', error);\n  }\n\n\n\n\n  const handlers = createHandlers();\n\n  const describeScheme = scheme => {\n    if (scheme === 'dark') return '\u6697\u8272';\n    if (scheme === 'light') return '\u4EAE\u8272';\n    return '\u81EA\u5B9A\u4E49';\n  };\n\n  const renderThemeMenuOptions = () => {\n    const $menu = $(`#${THEME_MENU_ID}`, parentDoc);\n    if (!$menu.length) return;\n    const activeTheme = getActiveTheme();\n    const activeId = activeTheme?.id ?? '';\n    const themes = listThemes();\n    const itemsHtml = themes\n      .map(theme => {\n        const themeId = typeof theme?.id === 'string' ? theme.id.trim() : '';\n        const isActive = themeId && themeId === activeId;\n        const label = escapeHtml(getThemeLabel(themeId));\n        const schemeLabel = escapeHtml(describeScheme(theme?.colorScheme));\n        return `\n          <button type=\"button\" class=\"rlh-sort-option ${THEME_OPTION_CLASS}\" data-theme-id=\"${escapeHtml(\n            themeId,\n          )}\" role=\"menuitemradio\" aria-checked=\"${isActive ? 'true' : 'false'}\" data-active=\"${isActive}\">\n            <span class=\"rlh-theme-option-text\">\n              <span class=\"rlh-theme-option-name\">${label}</span>\n              <span class=\"rlh-theme-option-meta\">${schemeLabel}</span>\n            </span>\n            <span class=\"rlh-theme-option-check\"><i class=\"fa-solid fa-check\" aria-hidden=\"true\"></i></span>\n          </button>`;\n      })\n      .join('');\n    $menu.html(itemsHtml);\n  };\n\n  const updateThemeToggleUI = theme => {\n    const activeTheme = theme ?? getActiveTheme();\n    const activeId = activeTheme?.id ?? '';\n    const activeLabel = getThemeLabel(activeId);\n    const $label = $(`#${THEME_TOGGLE_LABEL_ID}`, parentDoc);\n    if ($label.length) {\n      $label.text(activeTheme ? `\u4E3B\u9898\uFF1A${activeLabel}` : '\u4E3B\u9898\uFF1A\u672A\u8BBE\u7F6E');\n    }\n    const $wrapper = $(`#${THEME_MENU_WRAPPER_ID}`, parentDoc);\n    if ($wrapper.length) {\n      $wrapper.attr('data-active-theme', activeId);\n    }\n    const $options = $(`#${THEME_MENU_ID}`, parentDoc).find(`.${THEME_OPTION_CLASS}`);\n    $options.each((_, element) => {\n      const $option = $(element);\n      const optionId = String($option.data('themeId') ?? '').trim();\n      const isActive = optionId === activeId && Boolean(activeId);\n      $option.attr('data-active', String(isActive));\n      $option.attr('aria-checked', String(isActive));\n    });\n  };\n\n  onThemeChange(({ theme }) => {\n    renderThemeMenuOptions();\n    updateThemeToggleUI(theme);\n  });\n  function injectCSS() {\n\n    const existingStyle = parentDoc.getElementById(`${PANEL_ID}-styles`);\n\n    if (existingStyle) {\n\n      existingStyle.textContent = builtCSS;\n\n      return;\n\n    }\n\n    const styleElement = parentDoc.createElement('style');\n\n    styleElement.id = `${PANEL_ID}-styles`;\n\n    styleElement.textContent = builtCSS;\n\n    parentDoc.head.appendChild(styleElement);\n\n  }\n\n\n\n\n  function loadSortableJS(callback) {\n    appState.isDragSortDisabled = false;\n\n    if (parentWin.Sortable) {\n      if (typeof callback === 'function') {\n        try {\n          callback();\n        } catch (error) {\n          console.error('[RegexLoreHub] \u521D\u59CB\u5316\u56DE\u8C03\u6267\u884C\u5931\u8D25\uFF1A', error);\n        }\n      }\n      return;\n    }\n\n    let hasFinished = false;\n    const safeInvokeCallback = () => {\n      if (hasFinished) return;\n      hasFinished = true;\n      if (typeof callback === 'function') {\n        try {\n          callback();\n        } catch (error) {\n          console.error('[RegexLoreHub] \u521D\u59CB\u5316\u56DE\u8C03\u6267\u884C\u5931\u8D25\uFF1A', error);\n        }\n      }\n    };\n\n    const candidateUrls = collectSortableCandidateUrls(parentDoc, parentWin);\n\n    const handleTotalFailure = lastError => {\n      if (!parentDoc) {\n        appState.isDragSortDisabled = true;\n        console.error('[RegexLoreHub] \u65E0\u6CD5\u52A0\u8F7D SortableJS\uFF1A\u5BBF\u4E3B\u6587\u6863\u4E0D\u53EF\u8BBF\u95EE\u3002', lastError);\n        safeInvokeCallback();\n        return;\n      }\n\n      const attemptedUrls = candidateUrls.length ? `\u5C1D\u8BD5\u8DEF\u5F84\uFF1A${candidateUrls.join(', ')}` : '\u672A\u627E\u5230\u53EF\u7528\u5019\u9009\u8DEF\u5F84\u3002';\n      const inlineFallback = async () => {\n        if (typeof (parentWin.fetch || window.fetch) !== 'function') throw lastError || new Error('fetch not available');\n        const fetchImpl = parentWin.fetch ? parentWin.fetch.bind(parentWin) : window.fetch.bind(window);\n        const inlineUrl =\n          (() => {\n            try {\n              return new URL('../vendor/Sortable.min.js', import.meta.url).href;\n            } catch (error) {\n              console.warn('[RegexLoreHub] \u5185\u8054\u56DE\u9000\u8DEF\u5F84\u89E3\u6790\u5931\u8D25\uFF1A', error);\n              return '';\n            }\n          })() || candidateUrls[0] || '';\n\n        if (!inlineUrl) throw lastError || new Error('missing inline url');\n\n        const response = await fetchImpl(inlineUrl, { cache: 'no-cache' });\n        if (!response.ok) throw new Error(`HTTP ${response.status} ${response.statusText}`);\n        const scriptText = await response.text();\n        const inlineScript = parentDoc.createElement('script');\n        inlineScript.textContent = scriptText;\n        parentDoc.head.appendChild(inlineScript);\n        console.warn('[RegexLoreHub] SortableJS \u5DF2\u901A\u8FC7\u5185\u8054\u6A21\u5F0F\u52A0\u8F7D\u3002');\n        appState.isDragSortDisabled = false;\n        safeInvokeCallback();\n      };\n\n      inlineFallback()\n        .catch(error => {\n          appState.isDragSortDisabled = true;\n          console.error('[RegexLoreHub] Failed to load SortableJS.', error ?? lastError);\n          showModal({\n            type: 'alert',\n            title: '\u9519\u8BEF',\n            text: `\u65E0\u6CD5\u52A0\u8F7D\u62D6\u62FD\u6392\u5E8F\u5E93\uFF0C\u8BF7\u68C0\u67E5\u8D44\u6E90\u8DEF\u5F84\u914D\u7F6E\u3002${attemptedUrls}`,\n          }).catch(() => {});\n          safeInvokeCallback();\n        })\n        .finally(() => {});\n    };\n\n    if (!candidateUrls.length) {\n      handleTotalFailure(new Error('Sortable candidate URLs not found.'));\n      return;\n    }\n\n    const attemptLoad = index => {\n      if (index >= candidateUrls.length) {\n        handleTotalFailure(new Error('All Sortable candidates failed.'));\n        return;\n      }\n\n      const url = candidateUrls[index];\n      const scriptEl = parentWin.document.createElement('script');\n      scriptEl.src = url;\n      scriptEl.dataset.rlhSortableCandidate = String(index);\n\n      scriptEl.onload = () => {\n        appState.isDragSortDisabled = false;\n        console.log('[RegexLoreHub] SortableJS loaded successfully.', url);\n        appState.paths = appState.paths || {};\n        appState.paths.vendor = normalizeUrl(url.replace(/\\/Sortable\\.min\\.js(?:\\?.*)?$/, ''));\n        appState.paths.rlhRoot =\n          appState.paths.vendor?.replace(/\\/vendor$/, '') || appState.paths.rlhRoot || '';\n        safeInvokeCallback();\n      };\n\n      scriptEl.onerror = event => {\n        scriptEl.remove();\n        console.warn('[RegexLoreHub] SortableJS \u52A0\u8F7D\u5931\u8D25\uFF0C\u5C1D\u8BD5\u4E0B\u4E00\u4E2A\u5019\u9009\u3002', url, event?.error);\n        attemptLoad(index + 1);\n      };\n\n      parentWin.document.head.appendChild(scriptEl);\n    };\n\n    attemptLoad(0);\n  }\n\n\n\n\n\n  function initializeScript() {\n\n    console.log('[RegexLoreHub] Initializing UI and button...');\n\n\n\n\n\n    if ($(`#${PANEL_ID}`, parentDoc).length > 0) {\n\n      console.log('[RegexLoreHub] Panel already exists. Skipping UI creation.');\n\n      return;\n\n    }\n\n\n\n\n\n    injectCSS();\n\n\n\n\n\n    const panelHtml = `\n      <div id=\"${PANEL_ID}\">\n\n        <div class=\"rlh-shell\">\n\n          <header class=\"rlh-shell-header\">\n\n            <div class=\"rlh-shell-title\">\n\n              <h4>${BUTTON_TOOLTIP}</h4>\n\n              <p class=\"rlh-shell-meta\"><span class=\"rlh-shell-version\">v3.2</span><span class=\"rlh-shell-dot\">\u00B7</span><span class=\"rlh-shell-updated\">\u66F4\u65B0\u4E8E 2025 \u5E74 10 \u6708 21 \u65E5</span></p>\n\n            </div>\n\n            <div class=\"rlh-shell-right\">\n\n              <div id=\"${PREFETCH_INDICATOR_ID}\" class=\"rlh-prefetch-indicator\" data-visible=\"false\" aria-hidden=\"true\">\n\n                <div id=\"${PREFETCH_PROGRESS_TEXT_ID}\" class=\"rlh-prefetch-text\" aria-live=\"polite\">\u540E\u53F0\u52A0\u8F7D\u4E16\u754C\u4E66 (0/0)\uFF0C\u4E0D\u5F71\u54CD\u5176\u4ED6\u64CD\u4F5C</div>\n\n                <div class=\"rlh-prefetch-bar\" role=\"progressbar\" aria-valuemin=\"0\" aria-valuemax=\"100\" aria-valuenow=\"0\">\n\n                  <span id=\"${PREFETCH_PROGRESS_BAR_ID}\" class=\"rlh-prefetch-bar-inner\"></span>\n\n                </div>\n\n              </div>\n\n              <button type=\"button\" id=\"${DOM_ID.TOGGLE_TOOLBAR_BTN}\" class=\"rlh-toolbar-toggle-btn\" title=\"\u6298\u53E0\u5DE5\u5177\u680F\" aria-controls=\"${DOM_ID.TOOLBAR_SHELL}\" aria-expanded=\"true\">\u6298\u53E0\u5DE5\u5177\u680F</button>\n\n              <div class=\"rlh-shell-actions\">\n\n                <div id=\"${THEME_MENU_WRAPPER_ID}\" class=\"rlh-theme-menu rlh-sort-menu\" data-open=\"false\">\n\n                  <button type=\"button\" id=\"${THEME_TOGGLE_BTN_ID}\" class=\"rlh-theme-toggle\" title=\"\u5207\u6362\u4E3B\u9898\" aria-haspopup=\"true\" aria-expanded=\"false\" aria-controls=\"${THEME_MENU_ID}\">\n\n                    <i class=\"fa-solid fa-palette\" aria-hidden=\"true\"></i>\n\n                    <span id=\"${THEME_TOGGLE_LABEL_ID}\" class=\"rlh-theme-toggle-label\">\u4E3B\u9898\uFF1A\u52A0\u8F7D\u4E2D</span>\n\n                    <i class=\"fa-solid fa-caret-down rlh-theme-toggle-caret\" aria-hidden=\"true\"></i>\n\n                  </button>\n\n                  <div id=\"${THEME_MENU_ID}\" class=\"rlh-sort-menu-list rlh-theme-menu-list\" role=\"menu\"></div>\n\n                </div>\n\n                <button type=\"button\" id=\"${REFRESH_BTN_ID}\" class=\"rlh-icon-button rlh-refresh-button\" title=\"\u5237\u65B0\u6570\u636E\">\n\n                  <i class=\"fa-solid fa-arrows-rotate\"></i>\n\n                </button>\n\n                <button type=\"button\" id=\"${CLOSE_BTN_ID}\" class=\"rlh-icon-button rlh-close-button\" title=\"\u5173\u95ED\u9762\u677F\">\n\n                  <i class=\"fa-solid fa-xmark\"></i>\n\n                </button>\n\n              </div>\n\n            </div>\n\n          </header>\n\n\n\n\n\n          <nav class=\"rlh-tab-nav\">\n\n            <div class=\"rlh-tab active\" data-tab=\"global-lore\"><span class=\"rlh-tab-text-full\">\u5168\u5C40\u4E16\u754C\u4E66</span><span class=\"rlh-tab-text-short\">\u5168\u5C40\u4E66</span></div>\n\n            <div class=\"rlh-tab\" data-tab=\"char-lore\"><span class=\"rlh-tab-text-full\">\u89D2\u8272\u4E16\u754C\u4E66</span><span class=\"rlh-tab-text-short\">\u89D2\u8272\u4E66</span></div>\n\n            <div class=\"rlh-tab\" data-tab=\"chat-lore\"><span class=\"rlh-tab-text-full\">\u804A\u5929\u4E16\u754C\u4E66</span><span class=\"rlh-tab-text-short\">\u804A\u5929\u4E66</span></div>\n\n            <div class=\"rlh-tab\" data-tab=\"global-regex\"><span class=\"rlh-tab-text-full\">\u5168\u5C40\u6B63\u5219</span><span class=\"rlh-tab-text-short\">\u5168\u5C40\u6B63\u5219</span></div>\n\n            <div class=\"rlh-tab\" data-tab=\"char-regex\"><span class=\"rlh-tab-text-full\">\u89D2\u8272\u6B63\u5219</span><span class=\"rlh-tab-text-short\">\u89D2\u8272\u6B63\u5219</span></div>\n\n          </nav>\n\n          <div id=\"${DOM_ID.TOOLBAR_SHELL}\" class=\"rlh-toolbar-shell\">\n\n            <div id=\"${CORE_TOOLBAR_ID}\" class=\"rlh-toolbar-container\"></div>\n\n            <div id=\"${REPLACE_TOOL_CONTAINER_ID}\" class=\"rlh-replace-container\"></div>\n\n          </div>\n\n          <div class=\"rlh-content-pane\">\n\n            <div id=\"${PANEL_ID}-content\"></div>\n\n          </div>\n\n          <footer class=\"rlh-shell-footer\">\n\n            <div id=\"regex-lore-hub-save-status\" class=\"rlh-save-status\"></div>\n\n          </footer>\n\n        </div>\n\n      </div>`;\n\n\n\n\n\n    $('body', parentDoc).append(panelHtml);\n    syncThemeToDom();\n    renderThemeMenuOptions();\n    updateThemeToggleUI();\n\n\n    const buttonHtml = `<div id=\"${BUTTON_ID}\" class=\"list-group-item flex-container flexGap5 interactable\" title=\"${BUTTON_TOOLTIP}\"><span class=\"rlh-menu-icon\"><i class=\"fa-solid fa-layer-group\"></i></span><span>${BUTTON_TEXT_IN_MENU}</span></div>`;\n\n    const $extensionsMenu = $(`#extensionsMenu`, parentDoc);\n\n    if ($extensionsMenu.find(`#${BUTTON_ID}`).length === 0) {\n\n      $extensionsMenu.append(buttonHtml);\n\n      console.log(`[RegexLoreHub] Button #${BUTTON_ID} appended to #extensionsMenu.`);\n\n    }\n\n\n\n\n\n    const $panel = $(`#${PANEL_ID}`, parentDoc);\n\n    const $parentBody = $('body', parentDoc);\n\n    $parentBody.off('.rlh').on('click.rlh', `#${BUTTON_ID}`, handlers.togglePanel);\n\n\n\n\n\n    $panel\n\n      .off('.rlh')\n\n      .on('click.rlh', `#${CLOSE_BTN_ID}`, handlers.togglePanel)\n\n      .on('click.rlh', '.rlh-tab', handlers.switchTab)\n\n      .on('click.rlh', '.rlh-item-header, .rlh-global-book-header', handlers.handleHeaderClick)\n\n      .on('click.rlh', '.rlh-item-container', handlers.handleMultiSelectContainerClick)\n\n      .on('click.rlh', '.rlh-book-group', handlers.handleMultiSelectContainerClick)\n\n      .on('click.rlh', '.rlh-back-to-list-btn', handlers.handleExitLorebookDetail) // \u65B0\u589E\u7ED1\u5B9A\n\n      .on('click.rlh', '.rlh-toggle-btn', handlers.handleToggleState)\n\n      .on('click.rlh', '.rlh-refresh-detail-btn', handlers.handleRefreshLorebookDetail)\n\n      .on('click.rlh', '.rlh-entry-edit-btn', handlers.handleEntryEnterEdit)\n\n      .on('click.rlh', '.rlh-entry-view-btn', handlers.handleEntryExitEdit)\n\n      .on('click.rlh', '.rlh-regex-edit-btn', handlers.handleRegexEnterEdit)\n\n      .on('click.rlh', '.rlh-regex-view-btn', handlers.handleRegexExitEdit)\n\n      .on('keydown.rlh', `#${SEARCH_INPUT_ID}`, handlers.handleSearchInputKeydown)\n\n      .on('click.rlh', '#rlh-search-clear-btn', handlers.handleSearchClear)\n\n      .on('input.rlh', `#${SEARCH_INPUT_ID}, #${REPLACE_INPUT_ID}`, handlers.handleGlobalSearch) // \u8BE6\u60C5\u9875\u641C\u7D22/\u66FF\u6362\u6846\n\n      .on('change.rlh', '#rlh-search-filters-container input', renderContent)\n\n      .on('change.rlh', `#${CHARACTER_BOOK_SWITCH_ID}`, handlers.handleCharacterBookSwitch)\n\n      .on('click.rlh', `#${TOGGLE_COLLAPSE_BTN_ID}`, handlers.handleToolbarToggleCollapse)\n\n      .on('click.rlh', `#${SORT_MENU_BUTTON_ID}`, handlers.handleSortMenuToggle)\n\n      .on('click.rlh', '.rlh-sort-option', handlers.handleSortOptionSelect)\n\n      .on('click.rlh', `#${THEME_TOGGLE_BTN_ID}`, handlers.handleThemeMenuToggle)\n\n      .on('click.rlh', `#${THEME_MENU_ID} .${THEME_OPTION_CLASS}`, handlers.handleThemeOptionSelect)\n\n      .on('click.rlh', `#${POSITION_MENU_BUTTON_ID}`, handlers.handlePositionMenuToggle)\n\n      .on('click.rlh', '.rlh-position-option', handlers.handlePositionOptionSelect)\n\n      .on('click.rlh', `#${UNIFIED_STATUS_BUTTON_ID}`, handlers.handleUnifiedStatusMenuToggle)\n\n      .on('click.rlh', '.rlh-unified-status-option', handlers.handleUnifiedStatusOptionSelect)\n\n      .on('change.rlh', '.rlh-multi-select-checkbox', handlers.handleSelectionCheckboxChange)\n\n      .on('click.rlh', `#${REFRESH_BTN_ID}`, handlers.handleRefresh)\n\n      .on('click.rlh', '#rlh-multi-select-btn', handlers.toggleMultiSelectMode)\n\n      .on('click.rlh', '#rlh-select-all-btn', handlers.handleSelectAll)\n\n      .on('click.rlh', '#rlh-select-none-btn', handlers.handleSelectNone)\n\n      .on('click.rlh', '#rlh-select-invert-btn', handlers.handleSelectInvert)\n\n      .on('click.rlh', '.rlh-select-unbound', handlers.handleSelectUnboundBooks)\n\n      .on('click.rlh', '#rlh-batch-enable-btn', handlers.handleBatchEnable)\n\n      .on('click.rlh', '#rlh-batch-disable-btn', handlers.handleBatchDisable)\n\n      .on('click.rlh', '#rlh-batch-delete-btn', handlers.handleBatchDelete)\n\n      .on('click.rlh', '.rlh-clean-orphan-books-btn', handlers.handleCleanOrphanLorebooks)\n\n      .on('click.rlh', `#${CREATE_LOREBOOK_BTN_ID}`, handlers.handlePrimaryCreateButtonClick)\n\n      .on('click.rlh', '.rlh-rename-book-btn', handlers.handleRenameBook)\n\n      .on('click.rlh', '.rlh-edit-entries-btn', handlers.handleEditEntriesToggle)\n\n      .on('click.rlh', '.rlh-delete-book-btn', handlers.handleDeleteLorebook)\n\n      .on('click.rlh', '.rlh-create-entry-btn', handlers.handleCreateEntry)\n\n      .on('click.rlh', '#regex-lore-hub-create-lorebook-btn', handlers.handleCreateLorebook)\n\n      .on('click.rlh', '.rlh-delete-entry-btn', handlers.handleDeleteEntry)\n\n      .on('click.rlh', '.rlh-batch-recursion-btn', handlers.handleBatchSetRecursion)\n\n      .on('click.rlh', '.rlh-fix-keywords-btn', handlers.handleFixKeywords)\n\n      .on('click.rlh', '.rlh-rename-btn', handlers.handleRename)\n\n      .on('click.rlh', '.rlh-rename-save-btn', handlers.handleConfirmRename)\n\n      .on('keydown.rlh', '.rlh-rename-input', handlers.handleRenameKeydown)\n\n      .on('change.rlh', '.rlh-edit-position', handlers.handlePositionChange)\n\n      .on('click.rlh', '#rlh-create-chat-lore-btn', handlers.handleCreateChatLorebook)\n\n      .on('click.rlh', '.rlh-unlink-chat-lore-btn', handlers.handleUnlinkChatLorebook)\n\n      .on('click.rlh', `#${DOM_ID.TOGGLE_TOOLBAR_BTN}`, toggleToolbar)\n      .on('click.rlh', '#rlh-replace-btn', handlers.handleReplace);\n\n    if (appState.isToolbarCollapsed) {\n\n      const $toolbarShell = $(`#${DOM_ID.TOOLBAR_SHELL}`, parentDoc);\n\n      $toolbarShell.addClass('rlh-toolbar-shell--collapsed');\n\n      const $toggleBtn = $(`#${DOM_ID.TOGGLE_TOOLBAR_BTN}`, parentDoc);\n\n      if ($toggleBtn.length) {\n\n        $toggleBtn.text('\u5C55\u5F00\u5DE5\u5177\u680F').attr('aria-expanded', 'false').attr('title', '\u5C55\u5F00\u5DE5\u5177\u680F');\n\n      }\n\n    }\n\n\n\n\n\n    console.log('[RegexLoreHub] All UI and events initialized.');\n\n\n\n\n\n    loadAllData();\n\n  }\n\n\n\n\n\n  loadSortableJS(initializeScript);\n\n}\n", "let jqInstance = null;\nlet tavernHelperInstance = null;\n\nexport function setEnv($, TavernHelper) {\n  jqInstance = $;\n  tavernHelperInstance = TavernHelper;\n}\n\nexport function get$() {\n  if (jqInstance) return jqInstance;\n  const parentWin = window.parent || window;\n  if (parentWin?.jQuery) return parentWin.jQuery;\n  return null;\n}\n\nexport function getTavernHelper() {\n  if (tavernHelperInstance) return tavernHelperInstance;\n  const parentWin = window.parent || window;\n  if (parentWin?.TavernHelper) return parentWin.TavernHelper;\n  return null;\n}\n\nfunction onReady(callback) {\n  const domSelector = '#extensionsMenu';\n  const maxRetries = 100; // \u6700\u591A\u7B49\u5F8520\u79D2\n  let retries = 0;\n\n  console.log(\n    `[RegexLoreHub] Starting readiness check. Polling for DOM element \"${domSelector}\" AND core APIs (TavernHelper, jQuery).`,\n  );\n\n  const interval = setInterval(() => {\n    const parentDoc = window.parent?.document;\n    const parentWin = window.parent;\n\n    const domReady = !!parentDoc && parentDoc.querySelector(domSelector) !== null;\n    const apiReady =\n      !!(parentWin && parentWin.TavernHelper) &&\n      typeof parentWin.TavernHelper.getCharData === 'function' &&\n      !!parentWin.jQuery;\n\n    if (domReady && apiReady) {\n      clearInterval(interval);\n      console.log(\n        `[RegexLoreHub] SUCCESS: Both DOM (\"${domSelector}\") and Core APIs are ready. Initializing script.`,\n      );\n      try {\n        const result = callback(parentWin.jQuery, parentWin.TavernHelper);\n        if (result?.catch) {\n          result.catch(error => {\n            console.error('[RegexLoreHub] FATAL: Error during main callback execution.', error);\n          });\n        }\n      } catch (error) {\n        console.error('[RegexLoreHub] FATAL: Error during main callback execution.', error);\n      }\n    } else {\n      retries++;\n      if (retries > maxRetries) {\n        clearInterval(interval);\n        console.error('[RegexLoreHub] FATAL: Readiness check timed out.');\n        if (!domReady) console.error(`[RegexLoreHub] -> Failure: DOM element \"${domSelector}\" not found.`);\n        if (!apiReady)\n          console.error(\n            `[RegexLoreHub] -> Failure: Core APIs not available. TavernHelper: ${!!parentWin?.TavernHelper}, jQuery: ${!!parentWin?.jQuery}`,\n          );\n      }\n    }\n  }, 150);\n}\n\nimport { createHandlers } from './ui/handlers/index.js';\nimport { initializeUI } from './ui/shell.js';\n\nasync function main($, TavernHelper) {\n  setEnv($, TavernHelper);\n\n  try {\n    await initializeUI(createHandlers);\n  } catch (error) {\n    console.error('[RegexLoreHub] FATAL: Failed to bootstrap application.', error);\n  }\n}\n\nonReady(main);\n"],
  "mappings": "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",
  "names": ["PANEL_ID", "BUTTON_ID", "BUTTON_TOOLTIP", "BUTTON_TEXT_IN_MENU", "CLOSE_BTN_ID", "SEARCH_INPUT_ID", "REFRESH_BTN_ID", "CORE_TOOLBAR_ID", "REPLACE_TOOL_CONTAINER_ID", "REPLACE_INPUT_ID", "TOGGLE_COLLAPSE_BTN_ID", "TOGGLE_RECURSION_BTN_ID", "FIX_KEYWORDS_BTN_ID", "SORT_MENU_ID", "SORT_MENU_BUTTON_ID", "POSITION_MENU_ID", "POSITION_MENU_BUTTON_ID", "UNIFIED_STATUS_MENU_ID", "UNIFIED_STATUS_BUTTON_ID", "CREATE_LOREBOOK_BTN_ID", "CHARACTER_BOOK_SWITCH_ID", "PREFETCH_INDICATOR_ID", "PREFETCH_PROGRESS_TEXT_ID", "PREFETCH_PROGRESS_BAR_ID", "THEME_MENU_WRAPPER_ID", "THEME_MENU_ID", "THEME_TOGGLE_BTN_ID", "THEME_TOGGLE_LABEL_ID", "THEME_OPTION_CLASS", "DOM_ID", "normalizeUrlBase", "value", "computeDefaultModuleRoot", "baseUrl", "error", "detectRootFromParent", "parentWin", "parentDoc", "scripts", "scriptEl", "src", "absoluteUrl", "normalized", "trimmed", "innerError", "RLH_ROOT_URL", "THEME_TOKEN_ENTRIES", "THEME_VARIABLES_MAP", "token", "varName", "THEME_VARIABLES", "THEME_TOKEN_LIST", "sanitizeThemeId", "value", "normalizeThemeClasses", "classes", "list", "unique", "item", "str", "themeRegistry", "themeOrder", "themeListeners", "themeState", "storeThemeConfig", "config", "a", "b", "themeA", "themeB", "normalizeThemeConfig", "rawConfig", "normalizedId", "normalizedLabel", "normalizedDescription", "normalizedOrder", "normalizedClasses", "normalizedScheme", "metadata", "applyThemeToPanel", "themeConfig", "parentDoc", "getParentDoc", "panelEl", "PANEL_ID", "className", "classesToApply", "error", "emitThemeChange", "previousTheme", "reason", "payload", "listener", "parentWin", "getParentWin", "CustomEvt", "ensureActiveThemeInternal", "byActive", "fallback", "first", "registerTheme", "normalized", "getThemeDefinition", "themeId", "listThemes", "id", "getActiveTheme", "getThemeLabel", "theme", "setActiveTheme", "options", "applyToDom", "silent", "resolvedId", "targetTheme", "changed", "applied", "syncThemeToDom", "activeTheme", "onThemeChange", "WORLD_BOOK_STATUS_DEFINITIONS", "THEME_VARIABLES", "normalizedStatusDefinitions", "def", "statusMap", "WORLD_BOOK_STATUS_MAP", "WORLD_BOOK_STATUS_LIST", "DEFAULT_WORLD_BOOK_STATUS", "DEFAULT_STATUS_ID", "normalizeWorldbookStatusId", "key", "resolveWorldbookStatus", "statusId", "LOREBOOK_OPTIONS", "DEFAULT_FILTER_LABELS", "REGEX_FILTER_LABELS", "FILTER_DEFINITIONS", "SORT_OPTION_DEFINITIONS", "appState", "themeState", "RLH_ROOT_URL", "normalizeLorebookName", "value", "pushUniqueString", "targetSet", "rawValue", "str", "encodeSelectionPart", "decodeSelectionPart", "buildBookSelectionKey", "name", "normalized", "buildLoreSelectionKey", "bookName", "entryId", "normalizedBook", "entryPart", "buildLoreSelectionPrefix", "buildRegexSelectionKey", "identifier", "resolveLorebookBindingStats", "bookOrName", "charNames", "charIds", "book", "appendCharName", "appendCharId", "usageList", "bindingCount", "ANALYTICS_EVENT_NAME", "ANALYTICS_DEFAULT_FEATURE", "ANALYTICS_DEFAULT_VERSION", "ANALYTICS_THROTTLE_INTERVAL_MS", "analyticsThrottleState", "emitAnalyticsEvent", "payload", "now", "rawCategory", "rawAction", "category", "action", "throttleKey", "lastTrigger", "defaultViewRaw", "appState", "normalizedFeature", "normalizedView", "detail", "parentWin", "getParentWin", "CustomEvt", "error", "safeGetLorebookEntries", "bookName", "entries", "safeSetLorebookEntries", "safeDeleteLorebookEntries", "safeClearLorebookEntries", "safeHasLorebookEntries", "getParentDoc", "escapeHtml", "text", "div", "highlightText", "searchTerm", "escapedText", "htmlSafeSearchTerm", "regexSpecialChars", "escapedSearchTerm", "char", "regex", "showToast", "message", "type", "duration", "$", "get$", "parentDoc", "$panel", "PANEL_ID", "iconClass", "toastHtml", "$toast", "showProgressToast", "initialMessage", "newMessage", "showModal", "options", "resolve", "reject", "title", "html", "placeholder", "value", "buttonsHtml", "inputHtml", "bodyContent", "modalHtml", "$modal", "$input", "closeModal", "isSuccess", "val", "e", "errorCatched", "fn", "context", "notify", "toastType", "toastDuration", "toastMessage", "modalTitle", "modalText", "args", "debounce", "func", "delay", "timeout", "buildSearchRegex", "caseSensitive", "escapedTerm", "flags", "UI_TEXTS", "getContextInstanceKey", "context", "getActiveCollapseState", "key", "appState", "setActiveCollapseState", "state", "getActiveSortMode", "options", "stored", "defaultValue", "setActiveSortMode", "mode", "escapeAttr", "value", "escapeHtml", "resolveStatusMeta", "statusId", "resolveWorldbookStatus", "DEFAULT_WORLD_BOOK_STATUS", "buildStatusBadge", "shortLabel", "withIcon", "statusMeta", "label", "iconHtml", "buildUnifiedStatusOptionsHtml", "WORLD_BOOK_STATUS_LIST", "status", "badgeHtml", "buildFilterCheckboxes", "filtersState", "filters", "items", "definition", "FILTER_DEFINITIONS", "DEFAULT_FILTER_LABELS", "isChecked", "buildSortMenu", "currentSort", "option", "SORT_OPTION_DEFINITIONS", "isActive", "menuListId", "SORT_MENU_ID", "SORT_MENU_BUTTON_ID", "buildPositionMenu", "selectionMap", "lastSep", "encodedName", "encodedEntryId", "name", "decodeSelectionPart", "entryId", "bookName", "entries", "safeGetLorebookEntries", "hasEntries", "isEntryMultiSelect", "selectedForBook", "shouldEnable", "tooltip", "uniquePositions", "entry", "activePosition", "POSITION_MENU_ID", "buttonAttributes", "POSITION_MENU_BUTTON_ID", "LOREBOOK_OPTIONS", "attributes", "containerAttributes", "renderToolbar", "$toolbar", "$replaceContainer", "collapseState", "sortMode", "multiSelectClasses", "multiSelectAttributes", "multiSelectButtonHtml", "multiSelectControlsClass", "multiSelectControlsHtml", "multiSelectModuleHtml", "unifiedStatusModuleHtml", "menuId", "UNIFIED_STATUS_MENU_ID", "listId", "optionsHtml", "containerClasses", "resolvedBookName", "selectedTotal", "sum", "list", "UNIFIED_STATUS_BUTTON_ID", "collapseButtonHtml", "TOGGLE_COLLAPSE_BTN_ID", "recursionButtonHtml", "targetBookName", "TOGGLE_RECURSION_BTN_ID", "fixKeywordsButtonHtml", "FIX_KEYWORDS_BTN_ID", "positionMenuHtml", "sortMenuHtml", "filtersHtml", "scopeLabel", "searchPlaceholder", "searchValue", "searchRowHtml", "SEARCH_INPUT_ID", "replaceValue", "replacePanelHtml", "REPLACE_INPUT_ID", "searchMetaHtml", "searchBoxHtml", "createEntryButtonHtml", "bookNameForCreate", "disabled", "buttonClasses", "actionTitle", "iconClass", "createBookButtonHtml", "selectUnboundButtonHtml", "searchSectionHtml", "actionsItems", "actionsSectionHtml", "toolbarHtml", "lorePrefix", "buildLoreSelectionPrefix", "hasSelection", "$unifiedButton", "matchEntry", "searchTerm", "term", "matchRegex", "item", "createGlobalLorebookElement", "book", "forceShowAllEntries", "filteredEntries", "$", "get$", "usedByChars", "usedByHtml", "char", "highlightedBookName", "highlightText", "selectionAllowed", "selectionKey", "buildBookSelectionKey", "hasSelectionKey", "isSelected", "selectionControl", "$element", "$content", "$entryActions", "allEntries", "a", "b", "entriesToShow", "$listWrapper", "createItemElement", "convertMultilineToHtml", "html", "buildViewerPlaceholder", "text", "buildLoreEntryViewerHTML", "statusBadgeHtml", "keywordsText", "keywordsHtml", "rawContent", "contentHtml", "hasValue", "formatViewerText", "placeholder", "buildViewerField", "field", "body", "buildViewerGroup", "title", "fields", "layout", "headingHtml", "positionLabel", "pos", "depthValue", "orderValue", "hasLogic", "logicKey", "logicBaseLabel", "logicValue", "probabilityValue", "keywordsField", "contentField", "insertRuleGroup", "UI_TEXTS", "activationGroup", "matchingGroup", "buildRegexViewerHTML", "findRaw", "replaceRaw", "normalizedTerm", "findHtml", "replaceHtml", "destination", "source", "minDepth", "maxDepth", "destinationLabels", "destinationText", "activeSources", "sourceText", "hasMin", "hasMax", "depthText", "metaHtml", "row", "type", "isLore", "id", "fromCard", "isExpanded", "dragRequested", "dragDisabled", "dragHandleTitle", "dragHandleDisabledAttrs", "dragHandleHtml", "buildLoreSelectionKey", "buildRegexSelectionKey", "target", "controlsHtml", "headerTitle", "highlightedName", "positionKey", "positionLabelRaw", "orderNumber", "fallbackOrder", "effectiveOrder", "orderLabel", "dragStateAttr", "initialMode", "viewerHtml", "prependEntry", "parentDoc", "getParentDoc", "$newEntryDom", "updateSelectionCount", "updateEntryStatusDom", "numericIdCandidate", "isNumericTarget", "matchEntryId", "candidate", "numericCandidate", "$container", "_", "el", "$el", "candidateBook", "candidateId", "$titleRow", "$existingBadge", "targetEntry", "buildReplaceConfirmationHTML", "matches", "stats", "booksMatchedByNameOnly", "replaceTerm", "summaryHtml", "listHtml", "booksOnlyHtml", "buildStatsList", "statsData", "count", "scopeText", "totalBooks", "m", "totalEntries", "matchedFields", "hitFields", "fieldsText", "entryName", "hitDetails", "statsItems", "renderSaveStatus", "$statusContainer", "statusClass", "reorderLoreEntriesInState", "orderedIds", "entryMap", "reordered", "index", "safeSetLorebookEntries", "initializeLoreEntrySortable", "parentWin", "getParentWin", "hasWrapper", "markDragDisabled", "listEl", "errorCatched", "evt", "oldIndex", "newIndex", "node", "saveAllChanges", "GLOBAL_LIST_CHUNK_SIZE", "globalListRenderHandle", "globalListProgressEl", "cancelPendingGlobalListRender", "parentWin", "getParentWin", "type", "id", "clearFn", "sortLoreEntries", "entries", "sortMode", "list", "b", "diff", "getGlobalLorebookMatches", "searchTerm", "caseSensitive", "options", "matches", "booksMatchedByNameOnly", "stats", "normalizedSearchTerm", "bookNames", "targetNames", "name", "allBooks", "appState", "books", "book", "knownNames", "flags", "searchRegex", "matchedBooksForName", "matchedEntriesForName", "matchedEntriesForKeywords", "matchedEntriesForContent", "addedEntries", "safeGetLorebookEntries", "isBookNameMatch", "bookHasEntryMatches", "entry", "currentMatch", "entryHasMatch", "matchedKeywordsCount", "k", "renderGlobalLoreTabView", "context", "$container", "renderGlobalLoreDetailView", "renderGlobalLoreListView", "$", "get$", "parentDoc", "getParentDoc", "normalizedTerm", "getActiveSortMode", "a", "filteredBooks", "matchEntry", "total", "chunkSize", "currentIndex", "updateProgress", "completed", "appendNodes", "nodes", "fragment", "node", "renderChunk", "end", "i", "domNode", "createGlobalLorebookElement", "progressRef", "scheduleNextChunk", "callback", "bookName", "escapeHtml", "loadingHtml", "collapseState", "getActiveCollapseState", "detailHtml", "visibleEntries", "$content", "message", "entriesHtml", "createItemElement", "renderCharacterLorebookView", "linkedBooks", "characterName", "activeBookName", "optionsHtml", "CHARACTER_BOOK_SWITCH_ID", "$bookElement", "$bookContainer", "$listWrapper", "bookMeta", "loadLorebookEntriesIfNeeded", "renderContent", "baseEntries", "bookNameMatches", "matchingEntries", "entriesToShow", "canReorder", "initializeLoreEntrySortable", "renderChatLorebookView", "context", "searchTerm", "$container", "$", "get$", "bookName", "appState", "parentWin", "getParentWin", "characterName", "escapeHtml", "sortMode", "getActiveSortMode", "collapseState", "getActiveCollapseState", "$bookContainer", "$listWrapper", "bookMeta", "b", "loadLorebookEntriesIfNeeded", "renderContent", "baseEntries", "safeGetLorebookEntries", "a", "entries", "sortLoreEntries", "matchingEntries", "entry", "matchEntry", "canReorder", "createItemElement", "message", "initializeLoreEntrySortable", "cancelGlobalLoreListRender", "cancelPendingGlobalListRender", "sortRegexEntries", "entries", "sortMode", "list", "b", "diff", "getRegexMatches", "searchTerm", "caseSensitive", "matches", "stats", "scripts", "appState", "flags", "searchRegex", "matchedScriptsForName", "matchedScriptsForContent", "addedScripts", "script", "hasMatch", "contentToSearch", "renderRegexView", "context", "itemList", "$container", "title", "$", "get$", "parentWin", "getParentWin", "getActiveSortMode", "collapseState", "getActiveCollapseState", "items", "label", "hostContext", "filteredItems", "item", "matchRegex", "listId", "$listContainer", "canReorder", "index", "$element", "createItemElement", "listEl", "dragNoticeClass", "sortable", "errorCatched", "evt", "oldIndex", "newIndex", "scope", "targetList", "moved", "updateRegexOrderMetadata", "saveAllChanges", "normalizeSearchTerm", "value", "getViewContext", "tab", "appState", "view", "base", "DEFAULT_FILTER_LABELS", "bookName", "activeCharacterBook", "fallbackBook", "name", "REGEX_FILTER_LABELS", "ensureSearchFiltersDefaults", "context", "contextKey", "key", "renderContent", "$", "get$", "parentDoc", "getParentDoc", "$panel", "PANEL_ID", "ensureLayoutNodes", "emptySet", "$toolbarRow", "$tabNav", "$toolbar", "CORE_TOOLBAR_ID", "$replaceContainer", "REPLACE_TOOL_CONTAINER_ID", "$contentPane", "$content", "searchTerm", "selector", "$checkbox", "viewContext", "cancelGlobalLoreListRender", "renderToolbar", "renderSaveStatus", "updateSelectionCount", "renderGlobalLoreTabView", "renderCharacterLorebookView", "renderChatLorebookView", "renderRegexView", "LOGIC_STRING_TO_ENUM", "LOGIC_ENUM_TO_STRING", "ROLE_NAME_TO_ENUM", "ROLE_ENUM_TO_NAME", "POSITION_UI_TO_STRUCT", "POSITION_NUMERIC_TO_UI", "LEGACY_POSITION_ALIASES", "THEME_SETTINGS_NAMESPACE", "THEME_SETTINGS_KEY", "loadThemePreference", "errorCatched", "storedTheme", "extensionSettings", "getTavernHelper", "container", "candidate", "error", "rawValue", "getParentWin", "saveThemePreference", "themeId", "normalized", "persisted", "helper", "namespaceKey", "cloneEntry", "source", "sanitizeKeyArray", "keys", "key", "str", "ORDER_FIELD_KEYS", "updateRegexOrderMetadata", "regexList", "regex", "index", "normalizeRegexPayloadOrder", "regexes", "buckets", "scope", "list", "toBooleanStrict", "value", "parseOptionalNumber", "numeric", "normalizeLogicString", "normalizeRoleName", "value", "normalized", "ROLE_NAME_TO_ENUM", "mapped", "ROLE_ENUM_TO_NAME", "resolveUiPositionKey", "positionValue", "roleValue", "normalizedType", "LEGACY_POSITION_ALIASES", "roleName", "POSITION_NUMERIC_TO_UI", "extractPositionDetails", "positionValue", "fallbackRole", "fallbackDepth", "fallbackOrder", "fallbackRoleName", "normalizeRoleName", "details", "parseOptionalNumber", "setOrder", "value", "parsed", "setDepth", "normalizedType", "LEGACY_POSITION_ALIASES", "roleName", "uiKey", "resolveUiPositionKey", "buildRawPosition", "uiKeyInput", "depth", "order", "basePosition", "baseDetails", "normalizedKey", "mapping", "POSITION_UI_TO_STRUCT", "result", "parsedOrder", "resolvedOrder", "role", "parsedDepth", "resolvedDepth", "normalizeWorldbookEntry", "entry", "clone", "cloneEntry", "strategy", "statusDef", "resolveWorldbookStatus", "inferStatusIdFromEntry", "DEFAULT_WORLD_BOOK_STATUS", "keys", "sanitizeKeyArray", "secondaryKeys", "logicString", "normalizeLogicString", "LOGIC_STRING_TO_ENUM", "positionDetails", "probability", "toBooleanStrict", "convertUiEntryToRaw", "uiEntry", "baseEntry", "raw", "uiClone", "resolvedStatus", "numericUid", "positionStruct", "recursion", "resolveBool", "uiValue", "currentValue", "caseSensitiveValue", "matchWholeWordsValue", "resolveNumericUid", "DEFAULT_STATUS_ID", "rawType", "normalizeWorldbookStatusId", "toTargetMeta", "target", "makeEntryMeta", "fallback", "targetMeta", "fallbackMeta", "makeTargetMeta", "meta", "makeStatusRecord", "overrides", "STATUS_CHANGE_REASON", "sanitizeKeysForUpdate", "isCharacterNotFoundError", "error", "message", "TavernAPI", "errorCatched", "name", "getTavernHelper", "regexes", "options", "scope", "payload", "normalizeRegexPayloadOrder", "bookNames", "charData", "characterName", "updater", "entries", "uids", "uidsSet", "lorebooks", "updateWorldbookEntries", "bookName", "entryUpdates", "updatesByUid", "pendingUidSet", "update", "uid", "existing", "localEntries", "safeGetLorebookEntries", "localEntryMap", "currentEntries", "localEntry", "mergedLocal", "partialUpdate", "key", "item", "updatedEntries", "normalizedEntries", "safeSetLorebookEntries", "updateBookSummary", "buildStatusSummary", "successRecords", "failedRecords", "ignoredRecords", "requestedCount", "successCount", "failedCount", "ignoredCount", "alreadyAppliedCount", "record", "appliedCount", "ignoredUnsavedCount", "status", "updateWorldbookEntriesStatus", "targets", "targetStatusId", "normalizedTargets", "fallbackStatus", "entryMap", "processedUids", "pendingUpdates", "pendingMeta", "duplicateEntry", "duplicateMeta", "currentEntry", "entryMeta", "nextStrategy", "updateResult", "latestEntries", "latestMap", "apiFailed", "latestEntry", "latestStatus", "summary", "ensurePendingLorebookUpdateMap", "bookName", "appState", "queueLorebookEntryUpdate", "entryIdentifier", "partialUpdate", "numericUid", "resolveNumericUid", "key", "updatesMap", "existing", "payload", "sanitizeKeysForUpdate", "field", "value", "queueRegexUpdate", "regexId", "migratePendingLorebookUpdate", "tempUid", "newUid", "tempKey", "record", "newKey", "target", "loadAllDataPromise", "performLoadAllData", "$", "get$", "parentDoc", "getParentDoc", "parentWin", "getParentWin", "TavernHelper", "getTavernHelper", "$content", "PANEL_ID", "syncContextWithAppState", "loading", "$status", "$detail", "$progress", "$bar", "$barContainer", "total", "current", "updateBar", "safeTotal", "ratio", "percent", "currentValue", "totalValue", "status", "detail", "totalSteps", "progressCurrent", "advanceProgress", "safeClearLorebookEntries", "renderContent", "context", "allCharacters", "hasActiveCharacter", "hasActiveChat", "charData", "charLinkedBooks", "chatLorebook", "promises", "TavernAPI", "error", "results", "allUIRegexes", "enabledGlobalBookNames", "allBookFileNames", "r", "updateRegexOrderMetadata", "updateCharacterRegexes", "knownBookNames", "char", "books", "result", "bookSet", "b", "charError", "charProcessingError", "enabledGlobalBooks", "name", "charBookSet", "prefetchGlobalBookSummaries", "REFRESH_BTN_ID", "loadAllData", "errorCatched", "force", "isPrefetchingGlobalSummaries", "PREFETCH_MAX_CONCURRENCY", "sleep", "ms", "resolve", "getPrefetchElements", "$indicator", "PREFETCH_INDICATOR_ID", "$text", "PREFETCH_PROGRESS_TEXT_ID", "PREFETCH_PROGRESS_BAR_ID", "setPrefetchIndicatorVisibility", "visible", "updatePrefetchIndicatorContent", "clamped", "message", "hidePrefetchIndicator", "updateGlobalBookStatsDisplay", "$panel", "$group", "_", "el", "book", "showPrefetchIndicator", "booksToPrefetch", "completed", "queue", "worker", "loadLorebookEntriesIfNeeded", "workerCount", "resolveUnboundGlobalLorebooks", "statsByName", "unboundNames", "totalUsableBooks", "rawBook", "stats", "resolveLorebookBindingStats", "refreshCharacterData", "charBooks", "chatWorldbook", "updateCharacterLorebooks", "newBooksToLoad", "safeHasLorebookEntries", "entries", "safeSetLorebookEntries", "normalizeWorldbookEntry", "characterUIRegexes", "cardRegexes", "i", "e", "uiRegexIdentifiers", "uniqueCardRegexes", "identifier", "characterBookNames", "updateBookSummary", "safeGetLorebookEntries", "entry", "createInMemoryEntry", "newEntry", "DEFAULT_STATUS_ID", "LOGIC_STRING_TO_ENUM", "DEFAULT_WORLD_BOOK_STATUS", "updateInMemoryEntry", "tempId", "serverData", "entryIndex", "normalizedServerData", "updatedEntry", "saveAllChanges", "options", "silent", "MAX_RETRIES", "RETRY_DELAY", "attempts", "delay", "triggerUIUpdate", "renderSaveStatus", "flushLorebookUpdates", "didSave", "processedKeys", "uid", "data", "k", "updateWorldbookEntries", "flushRegexUpdates", "allRegexes", "performSave", "loreSaved", "regexSaved", "normalizeCharacterName", "trimmed", "extractNameFromCharacter", "character", "extractNameFromCharData", "matchCharacterById", "targetId", "normalizedTarget", "id", "characters", "characterId", "characterName", "matchedCharacter", "createLorebookHandlers", "deps", "$", "get$", "parentDoc", "getParentDoc", "parentWin", "getParentWin", "refreshLorebookData", "bookName", "showLoading", "targetName", "previousLoading", "appState", "renderContent", "loadLorebookEntriesIfNeeded", "handleEnterLorebookDetail", "errorCatched", "handleExitLorebookDetail", "$searchInput", "updateLinkedCharacters", "oldBookName", "newBookName", "progressToast", "attemptInfo", "linkedChars", "context", "originalCharId", "processedCount", "totalCount", "currentAttempt", "totalAttempts", "failedCharacters", "charName", "charIndex", "c", "charBooks", "TavernAPI", "updated", "index", "charError", "names", "item", "aggregatedError", "handleRenameBook", "event", "$bookSource", "isDetailView", "oldName", "newName", "showModal", "b", "linkedCharacters", "isChatLinked", "chatCount", "totalBindings", "confirmText", "RETRY_SETTINGS", "sleep", "ms", "resolve", "cleanupTasks", "registerCleanupTask", "description", "action", "task", "getStatusText", "status", "runCleanupTasks", "onlyFailed", "taskError", "buildCleanupModalHtml", "errorMessage", "tasksHtml", "escapeHtml", "presentCleanupModal", "modalPromise", "$overlay", "refreshList", "$item", "$error", "$retryBtn", "e", "retryOperation", "operation", "onAttempt", "onError", "attempt", "lastError", "error", "showProgressToast", "currentChatLorebook", "globalBooksBeforeUpdate", "shouldVerifyGlobal", "shouldVerifyChat", "oldEntries", "safeGetLorebookEntries", "entriesToCreate", "entry", "newEntry", "createdEntries", "createdCount", "total", "suffix", "enabledGlobalBooks", "globalNeedsUpdate", "targetGlobalBooks", "name", "verifyBooks", "verifyChat", "expectedChatLorebook", "loadAllData", "allBookNames", "book", "finalGlobalBooks", "finalChatLorebook", "verifyError", "showToast", "syncError", "handleCreateLorebook", "previousValue", "$button", "handleDeleteLorebook", "safeDeleteLorebookEntries", "handleBatchSetRecursion", "rawDatasetName", "getViewContext", "entries", "updates", "updateWorldbookEntries", "update", "$openEditor", "handleFixKeywords", "changedCount", "originalKeysString", "newKeysArray", "k", "finalKeysString", "applyUnifiedPosition", "positionValue", "targetPosition", "resolvedBookName", "isEntryMultiSelect", "targetEntries", "selectionPrefix", "buildLoreSelectionPrefix", "selectedUidSet", "key", "encodedId", "decodedId", "decodeSelectionPart", "numericId", "optionLabel", "LOREBOOK_OPTIONS", "targetCount", "scopeLabel", "refreshedEntries", "uniquePositions", "unifiedPosition", "selector", "$container", "$positionSelect", "$menu", "POSITION_MENU_ID", "POSITION_MENU_BUTTON_ID", "$option", "value", "isActive", "handleCreateChatLorebook", "handleUnlinkChatLorebook", "handleRefreshLorebookDetail", "createItemHandlers", "deps", "$", "get$", "parentDoc", "getParentDoc", "findRegexItemById", "rawId", "targetId", "fromGlobal", "appState", "item", "applyRegexFieldUpdate", "regexItem", "fieldPath", "rawValue", "value", "numeric", "segments", "cursor", "i", "key", "debouncedSave", "debounce", "saveAllChanges", "handleEditorInput", "errorCatched", "event", "$target", "$container", "type", "id", "numericId", "field", "bookName", "entry", "safeGetLorebookEntries", "itemUid", "element", "blockTags", "parts", "appendText", "textValue", "appendNewline", "collectText", "node", "nodeType", "tag", "child", "statusMeta", "resolveWorldbookStatus", "DEFAULT_WORLD_BOOK_STATUS", "queueLorebookEntryUpdate", "updateEntryStatusDom", "k", "numValue", "pendingValue", "queueRegexUpdate", "buildLoreEntryEditorHtml", "positionOptions", "LOREBOOK_OPTIONS", "text", "logicOptions", "keywordsText", "contentText", "currentStatusId", "WORLD_BOOK_STATUS_LIST", "status", "selected", "escapeHtml", "buildRegexEditorHtml", "destination", "source", "findValue", "replaceValue", "minDepthValue", "maxDepthValue", "updateRenameButtonState", "mode", "$button", "$icon", "bindLoreEditorInputs", "$content", "switchLoreEntryMode", "animate", "searchTerm", "isViewMode", "normalizedTerm", "html", "buildLoreEntryViewerHTML", "$nameSpan", "finalize", "animateReveal", "done", "el", "duration", "easeInOut", "t", "startHeight", "targetHeight", "startTime", "step", "timestamp", "progress", "eased", "currentHeight", "renderLoreEntryViewer", "options", "renderLoreEntryEditor", "renderRegexViewer", "viewerHtml", "buildRegexViewerHTML", "renderRegexEditor", "editorHtml", "bindInputs", "enterLoreEdit", "silent", "showToast", "entryId", "e", "exitLoreEdit", "enterRegexEdit", "exitRegexEdit", "handleEntryEnterEdit", "handleEntryExitEdit", "handleRegexEnterEdit", "handleRegexExitEdit", "handleToggleState", "$elementToSort", "isEnabling", "parentList", "currentBooks", "TavernAPI", "bookState", "b", "updateWorldbookEntries", "allServerRegexes", "regex", "r", "localRegex", "items", "a", "aEnabled", "bEnabled", "aName", "bName", "handleRename", "exitRenameMode", "$header", "oldName", "renameUIHtml", "entered", "newName", "handleConfirmRename", "exitEditMode", "handleRenameKeydown", "handleEditorExpandToggle", "$editors", "handleCreateEntry", "explicitBookName", "activeBookName", "getViewContext", "showModal", "tempEntry", "createInMemoryEntry", "$newEntryDom", "prependEntry", "renameButton", "result", "safeSetLorebookEntries", "normalizeWorldbookEntry", "serverEntry", "updateInMemoryEntry", "$entryDom", "updateBookSummary", "error", "handleDeleteEntry", "$item", "uid", "entryName", "handlePositionChange", "$select", "$depthContainer", "showReplaceConfirmationModal", "matches", "stats", "booksMatchedByNameOnly", "searchTerm", "replaceTerm", "context", "modalContent", "buildReplaceConfirmationHTML", "showModal", "toggleToolbar", "errorCatched", "event", "$", "get$", "parentDoc", "getParentDoc", "$panel", "PANEL_ID", "$toolbarShell", "DOM_ID", "willCollapse", "appState", "$toggleButton", "createUIHandlers", "deps", "lorebookHandlers", "itemHandlers", "getTargetKeyPrefix", "parseSelectionKey", "rawKey", "key", "firstSepIndex", "type", "remainder", "decodeSelectionPart", "lastSepIndex", "rawBook", "rawEntryId", "getUnifiedStatusElements", "UNIFIED_STATUS_MENU_ID", "UNIFIED_STATUS_BUTTON_ID", "getSelectedEntriesByBook", "selectedEntriesByBook", "itemKey", "bookName", "entryId", "numericId", "uid", "unifiedStatusMenuListenersActive", "closeUnifiedStatusMenu", "$menu", "$button", "handleUnifiedStatusMenuOutsideClick", "$target", "openUnifiedStatusMenu", "updateUnifiedStatusButtonState", "getViewContext", "resolvedBookName", "name", "selectedEntriesMap", "hasEntries", "safeGetLorebookEntries", "isEntryMultiSelect", "selectedTotal", "list", "shouldEnable", "tooltip", "updatePositionButtonState", "getPositionMenuElements", "syncToolbarState", "updateSelectionCount", "getVisibleSelectKeys", "selector", "keys", "_", "el", "$el", "hasSelectionForCurrentTarget", "prefix", "resolveSelectionKey", "$container", "buildBookSelectionKey", "itemType", "itemId", "buildLoreSelectionKey", "buildRegexSelectionKey", "toggleSelectionForContainer", "handleGlobalSearch", "value", "renderContent", "handleSearchInputKeydown", "term", "normalizeBookNames", "names", "unique", "trimmed", "ensureEntriesLoadedForBooks", "targets", "pending", "book", "cachedEntries", "progressToast", "showProgressToast", "loadLorebookEntriesIfNeeded", "error", "handleSearchClear", "$input", "SEARCH_INPUT_ID", "handleReplace", "REPLACE_INPUT_ID", "booksToLoad", "b", "modalContext", "getGlobalLorebookMatches", "activeName", "activeNames", "getRegexMatches", "performReplace", "showToast", "handleToolbarToggleCollapse", "getContextInstanceKey", "nextState", "setActiveCollapseState", "isCurrentlyVisible", "$header", "TOGGLE_COLLAPSE_BTN_ID", "iconClass", "label", "sortMenuListenersActive", "getSortMenuElements", "SORT_MENU_ID", "SORT_MENU_BUTTON_ID", "handleSortMenuOutsideClick", "closeSortMenu", "handleSortMenuKeydown", "attachSortMenuListeners", "detachSortMenuListeners", "openSortMenu", "handleSortMenuToggle", "handleSortOptionSelect", "sortValue", "setActiveSortMode", "themeMenuListenersActive", "getThemeMenuElements", "THEME_MENU_WRAPPER_ID", "THEME_MENU_ID", "THEME_TOGGLE_BTN_ID", "handleThemeMenuOutsideClick", "$wrapper", "target", "closeThemeMenu", "handleThemeMenuKeydown", "attachThemeMenuListeners", "detachThemeMenuListeners", "openThemeMenu", "handleThemeMenuToggle", "handleThemeOptionSelect", "$option", "THEME_OPTION_CLASS", "rawThemeId", "themeId", "currentTheme", "getActiveTheme", "theme", "setActiveTheme", "saveThemePreference", "positionMenuListenersActive", "POSITION_MENU_ID", "POSITION_MENU_BUTTON_ID", "handlePositionMenuOutsideClick", "closePositionMenu", "handlePositionMenuKeydown", "attachPositionMenuListeners", "detachPositionMenuListeners", "openPositionMenu", "handlePositionMenuToggle", "handlePositionOptionSelect", "positionValue", "handleUnifiedStatusMenuToggle", "handleUnifiedStatusOptionSelect", "statusId", "entriesByBook", "entries", "uids", "entry", "numericUid", "statusMeta", "resolveWorldbookStatus", "DEFAULT_WORLD_BOOK_STATUS", "toastLabel", "totalTargets", "sum", "appliedCount", "alreadyCount", "failedCount", "ignoredCount", "unsavedCount", "failureDetails", "viewContext", "processedBooks", "entryIds", "result", "updateWorldbookEntriesStatus", "summary", "record", "targetUid", "updateEntryStatusDom", "ignoredOtherCount", "message", "parts", "toastType", "handleCharacterBookSwitch", "handleSelectionCheckboxChange", "$checkbox", "selectKey", "isChecked", "replaceRegex", "buildSearchRegex", "updatesByBook", "keysAreEqual", "a", "index", "match", "update", "hasChange", "newKeys", "newContent", "newName", "newComment", "updates", "updateWorldbookEntries", "togglePanel", "hidePanel", "showPanel", "saveAllChanges", "$parentBody", "BUTTON_ID", "loadAllData", "handleTabRefresh", "tabId", "refreshCharacterData", "ensureBookMeta", "books", "chatBookName", "updateActiveViewForTab", "switchTab", "targetTab", "CREATE_LOREBOOK_BTN_ID", "toggleMultiSelectMode", "handleSelectAll", "handleSelectNone", "changed", "handleSelectInvert", "handleBatchEnable", "performBatchOperation", "handleBatchDisable", "handleBatchDelete", "selectedBooks", "selectedEntries", "selectedRegexIds", "totalEntriesToDelete", "regexId", "normalizedRegexId", "confirmText", "deletedBooksCount", "deletedEntriesCount", "deletedRegexCount", "processedEntries", "entriesToDelete", "TavernAPI", "safeSetLorebookEntries", "normalizeWorldbookEntry", "booksToDelete", "safeDeleteLorebookEntries", "lorePrefix", "buildLoreSelectionPrefix", "allServerRegexes", "regexesToKeep", "r", "updateRegexOrderMetadata", "id", "messageParts", "handleCleanOrphanLorebooks", "orphanBooks", "usageList", "linkedChars", "failedBooks", "deletedCount", "enable", "selectedBookNames", "needsRegexUpdate", "needsSettingsUpdate", "currentBooks", "e", "regex", "handleHeaderClick", "data", "$content", "storedSearchTerm", "attrSearchTerm", "effectiveSearchTerm", "regexItem", "handleMultiSelectContainerClick", "handleEditEntriesToggle", "$bookGroup", "isEnteringEditMode", "handleRefresh", "$icon", "syncContextWithAppState", "updateBookSummary", "handlePrimaryCreateButtonClick", "mockEvent", "getBookName", "book", "nowMs", "createSelectUnboundBooksHandler", "errorCatched", "event", "appState", "showToast", "start", "totalBooks", "unboundNames", "statsByName", "resolveUnboundGlobalLorebooks", "books", "searchTermRaw", "normalizedTerm", "activeGlobalBookName", "visibleBooksWithName", "name", "entries", "safeGetLorebookEntries", "entry", "matchEntry", "visibleNames", "visibleUnboundNames", "stats", "emitAnalyticsEvent", "key", "buildBookSelectionKey", "end", "duration", "renderContent", "createHandlers", "$", "get$", "parentDoc", "getParentDoc", "parentWin", "getParentWin", "sharedDeps", "lorebookHandlers", "createLorebookHandlers", "itemHandlers", "createItemHandlers", "uiHandlers", "createUIHandlers", "worldbookHandlers", "createSelectUnboundBooksHandler", "builtCSS", "LOCAL_SORTABLE_URL", "error", "normalizeUrl", "value", "joinUrlSegments", "base", "segment", "normalizedBase", "cleanedSegment", "collectSortableCandidateUrls", "parentDoc", "parentWin", "candidates", "addCandidate", "url", "trimmed", "appState", "scriptEl", "src", "absolute", "innerError", "initializeUI", "createHandlers", "$", "get$", "getParentDoc", "getParentWin", "storedThemeId", "loadThemePreference", "setActiveTheme", "handlers", "describeScheme", "scheme", "renderThemeMenuOptions", "$menu", "THEME_MENU_ID", "activeId", "getActiveTheme", "itemsHtml", "listThemes", "theme", "themeId", "isActive", "label", "escapeHtml", "getThemeLabel", "schemeLabel", "THEME_OPTION_CLASS", "updateThemeToggleUI", "activeTheme", "activeLabel", "$label", "THEME_TOGGLE_LABEL_ID", "$wrapper", "THEME_MENU_WRAPPER_ID", "_", "element", "$option", "onThemeChange", "injectCSS", "existingStyle", "PANEL_ID", "builtCSS", "styleElement", "loadSortableJS", "callback", "hasFinished", "safeInvokeCallback", "candidateUrls", "handleTotalFailure", "lastError", "attemptedUrls", "fetchImpl", "inlineUrl", "response", "scriptText", "inlineScript", "showModal", "attemptLoad", "index", "event", "initializeScript", "panelHtml", "BUTTON_TOOLTIP", "PREFETCH_INDICATOR_ID", "PREFETCH_PROGRESS_TEXT_ID", "PREFETCH_PROGRESS_BAR_ID", "DOM_ID", "THEME_TOGGLE_BTN_ID", "REFRESH_BTN_ID", "CLOSE_BTN_ID", "CORE_TOOLBAR_ID", "REPLACE_TOOL_CONTAINER_ID", "syncThemeToDom", "buttonHtml", "BUTTON_ID", "BUTTON_TEXT_IN_MENU", "$extensionsMenu", "$panel", "SEARCH_INPUT_ID", "REPLACE_INPUT_ID", "renderContent", "CHARACTER_BOOK_SWITCH_ID", "TOGGLE_COLLAPSE_BTN_ID", "SORT_MENU_BUTTON_ID", "POSITION_MENU_BUTTON_ID", "UNIFIED_STATUS_BUTTON_ID", "CREATE_LOREBOOK_BTN_ID", "toggleToolbar", "$toggleBtn", "loadAllData", "jqInstance", "tavernHelperInstance", "setEnv", "$", "TavernHelper", "get$", "parentWin", "getTavernHelper", "onReady", "callback", "domSelector", "retries", "interval", "parentDoc", "domReady", "apiReady", "result", "error", "main", "initializeUI", "createHandlers"]
}

{
  "version": 3,
  "sources": ["../src/core.js", "../src/ui/render/shared.js", "../src/ui/render/lorebook.js", "../src/ui/render/regex.js", "../src/ui/render/index.js", "../src/dataLayer.js", "../src/ui/handlers/lorebook.js", "../src/ui/handlers/item.js", "../src/ui/handlers/ui.js", "../src/ui/handlers/index.js", "../src/styles/generated.js", "../src/ui/shell.js", "../src/appBootstrap.js"],
  "sourcesContent": ["import { get$ } from './appBootstrap.js';\r\n\r\nexport { get$, getTavernHelper } from './appBootstrap.js';\r\n\r\nexport const PANEL_ID = 'regex-lore-hub-panel';\r\nexport const BUTTON_ID = 'regex-lore-hub-button';\r\nexport const BUTTON_ICON_URL = 'https://i.postimg.cc/bY23wb9Y/IMG-20250626-000247.png';\r\nexport const BUTTON_TOOLTIP = '\u4E16\u754C\u4E66&\u6B63\u5219\u7BA1\u7406\u5668';\r\nexport const BUTTON_TEXT_IN_MENU = '\u4E16\u754C\u4E66&\u6B63\u5219\u7BA1\u7406\u5668';\r\nexport const CLOSE_BTN_ID = 'rlh-close-btn';\r\nexport const SEARCH_INPUT_ID = 'rlh-search-input';\r\nexport const REFRESH_BTN_ID = 'rlh-refresh-btn';\r\nexport const CORE_TOOLBAR_ID = 'rlh-core-toolbar';\r\nexport const REPLACE_TOOL_CONTAINER_ID = 'rlh-replace-tool-container';\r\nexport const REPLACE_TOGGLE_BTN_ID = 'rlh-replace-toggle-btn';\r\nexport const REPLACE_INPUT_ID = 'rlh-replace-input';\r\nexport const TOGGLE_COLLAPSE_BTN_ID = 'rlh-toggle-collapse-btn';\r\nexport const TOGGLE_RECURSION_BTN_ID = 'rlh-toggle-recursion-btn';\r\nexport const FIX_KEYWORDS_BTN_ID = 'rlh-fix-keywords-btn';\r\nexport const SORT_MENU_ID = 'rlh-sort-menu';\nexport const SORT_MENU_BUTTON_ID = 'rlh-sort-menu-btn';\nexport const POSITION_MENU_ID = 'rlh-position-menu';\nexport const POSITION_MENU_BUTTON_ID = 'rlh-position-menu-btn';\nexport const CREATE_LOREBOOK_BTN_ID = 'rlh-create-primary-btn';\r\nexport const CHARACTER_BOOK_SWITCH_ID = 'rlh-character-book-switch';\r\nexport const PREFETCH_INDICATOR_ID = 'rlh-prefetch-indicator';\r\nexport const PREFETCH_PROGRESS_TEXT_ID = 'rlh-prefetch-progress-text';\r\nexport const PREFETCH_PROGRESS_BAR_ID = 'rlh-prefetch-progress-bar';\r\nexport const DOM_ID = {\r\n  TOOLBAR_SHELL: 'regex-lore-hub-toolbar-shell',\r\n  TOGGLE_TOOLBAR_BTN: 'regex-lore-hub-toggle-toolbar-btn',\r\n};\r\n\r\nexport const LOREBOOK_OPTIONS = {\r\n  position: {\r\n    before_character_definition: '\u89D2\u8272\u5B9A\u4E49\u524D',\r\n    after_character_definition: '\u89D2\u8272\u5B9A\u4E49\u540E',\r\n    before_example_messages: '\u804A\u5929\u793A\u4F8B\u524D',\r\n    after_example_messages: '\u804A\u5929\u793A\u4F8B\u540E',\r\n    before_author_note: '\u4F5C\u8005\u7B14\u8BB0\u524D',\r\n    after_author_note: '\u4F5C\u8005\u7B14\u8BB0\u540E',\r\n    at_depth_as_system: '@D \u2699 \u7CFB\u7EDF',\r\n    at_depth_as_assistant: '@D \uD83D\uDDE8\uFE0F \u89D2\u8272',\r\n    at_depth_as_user: '@D \uD83D\uDC64 \u7528\u6237',\r\n  },\r\n  logic: {\r\n    and_any: '\u4EFB\u4E00 AND',\r\n    and_all: '\u6240\u6709 AND',\r\n    not_any: '\u4EFB\u4E00 NOT',\r\n    not_all: '\u6240\u6709 NOT',\r\n  },\r\n};\r\n\r\nexport const DEFAULT_FILTER_LABELS = {\r\n  bookName: '\u4E66\u540D',\r\n  entryName: '\u6761\u76EE\u540D',\r\n  keywords: '\u5173\u952E\u8BCD',\r\n  content: '\u5185\u5BB9',\r\n};\r\n\r\nexport const REGEX_FILTER_LABELS = {\r\n  entryName: '\u540D\u79F0',\r\n  content: '\u5185\u5BB9',\r\n};\r\n\r\nexport const FILTER_DEFINITIONS = {\r\n  bookName: { id: 'rlh-filter-book-name' },\r\n  entryName: { id: 'rlh-filter-entry-name' },\r\n  keywords: { id: 'rlh-filter-keywords' },\r\n  content: { id: 'rlh-filter-content' },\r\n};\r\n\r\nexport const SORT_OPTION_DEFINITIONS = {\n  status: { value: 'status', label: '\u6309\u542F\u7528\u72B6\u6001' },\n  name: { value: 'name', label: '\u540D\u79F0\u6392\u5E8F' },\n};\n\r\nexport const appState = {\r\n  regexes: { global: [], character: [] },\r\n  lorebooks: { character: [] },\r\n  chatLorebook: null,\r\n  allLorebooks: [],\r\n  lorebookEntries: new Map(),\r\n  pendingLorebookUpdates: new Map(), // \u5F85\u4FDD\u5B58\u7684\u4E16\u754C\u4E66\u5B57\u6BB5\u66F4\u65B0\r\n  pendingRegexUpdates: new Set(), // \u5F85\u4FDD\u5B58\u7684\u6B63\u5219\u66F4\u65B0\r\n  lorebookUsage: new Map(),\r\n  activeTab: 'global-lore',\r\n  activeView: 'global-lore-list',\r\n  activeBookName: null,\r\n  activeCharacterBook: null,\r\n  charLoreInitialSynced: false,\r\n  pendingHighlightEntry: null,\r\n  isDataLoaded: false,\r\n  isLoadingTabData: false,\r\n  loadingBookName: null,\r\n  searchFilters: { bookName: true, entryName: true, keywords: true, content: true },\r\n  multiSelectMode: false,\r\n  multiSelectTarget: 'book',\r\n  selectedItems: new Set(),\r\n  globalSearch: { term: '', replace: '' },\r\n  searchFilterContextsInitialized: new Set(),\r\n  collapseStateByContext: new Map(),\r\n  sortModeByContext: new Map(),\r\n  characterContext: { name: null, id: null }, // \u65B0\u589E\uFF1A\u7528\u4E8E\u7F13\u5B58\u89D2\u8272\u4E0A\u4E0B\u6587\r\n  saveStatus: 'idle',\r\n  saveRetryAttempt: 0,\r\n  isToolbarCollapsed: true,\r\n};\r\n\r\nexport const safeGetLorebookEntries = bookName => {\r\n  try {\r\n    if (!appState.lorebookEntries || !(appState.lorebookEntries instanceof Map)) {\r\n      console.warn('[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...');\r\n      appState.lorebookEntries = new Map();\r\n    }\r\n    if (typeof appState.lorebookEntries.get !== 'function') {\r\n      console.warn('[RegexLoreHub] appState.lorebookEntries.get is not a function, reinitializing...');\r\n      appState.lorebookEntries = new Map();\r\n    }\r\n    const entries = appState.lorebookEntries.get(bookName);\r\n    return Array.isArray(entries) ? entries : [];\r\n  } catch (error) {\r\n    console.error('[RegexLoreHub] Error in safeGetLorebookEntries:', error);\r\n    appState.lorebookEntries = new Map();\r\n    return [];\r\n  }\r\n};\r\n\r\nexport const safeSetLorebookEntries = (bookName, entries) => {\r\n  try {\r\n    if (!appState.lorebookEntries || !(appState.lorebookEntries instanceof Map)) {\r\n      console.warn('[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...');\r\n      appState.lorebookEntries = new Map();\r\n    }\r\n    if (typeof appState.lorebookEntries.set !== 'function') {\r\n      console.warn('[RegexLoreHub] appState.lorebookEntries.set is not a function, reinitializing...');\r\n      appState.lorebookEntries = new Map();\r\n    }\r\n    appState.lorebookEntries.set(bookName, Array.isArray(entries) ? entries : []);\r\n  } catch (error) {\r\n    console.error('[RegexLoreHub] Error in safeSetLorebookEntries:', error);\r\n    appState.lorebookEntries = new Map();\r\n    appState.lorebookEntries.set(bookName, Array.isArray(entries) ? entries : []);\r\n  }\r\n};\r\n\r\nexport const safeDeleteLorebookEntries = bookName => {\r\n  try {\r\n    if (!appState.lorebookEntries || !(appState.lorebookEntries instanceof Map)) {\r\n      console.warn('[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...');\r\n      appState.lorebookEntries = new Map();\r\n      return;\r\n    }\r\n    if (typeof appState.lorebookEntries.delete !== 'function') {\r\n      console.warn('[RegexLoreHub] appState.lorebookEntries.delete is not a function, reinitializing...');\r\n      appState.lorebookEntries = new Map();\r\n      return;\r\n    }\r\n    appState.lorebookEntries.delete(bookName);\r\n  } catch (error) {\r\n    console.error('[RegexLoreHub] Error in safeDeleteLorebookEntries:', error);\r\n    appState.lorebookEntries = new Map();\r\n  }\r\n};\r\n\r\nexport const safeClearLorebookEntries = () => {\r\n  try {\r\n    if (!appState.lorebookEntries || !(appState.lorebookEntries instanceof Map)) {\r\n      console.warn('[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...');\r\n      appState.lorebookEntries = new Map();\r\n      return;\r\n    }\r\n    if (typeof appState.lorebookEntries.clear !== 'function') {\r\n      console.warn('[RegexLoreHub] appState.lorebookEntries.clear is not a function, reinitializing...');\r\n      appState.lorebookEntries = new Map();\r\n      return;\r\n    }\r\n    appState.lorebookEntries.clear();\r\n  } catch (error) {\r\n    console.error('[RegexLoreHub] Error in safeClearLorebookEntries:', error);\r\n    appState.lorebookEntries = new Map();\r\n  }\r\n};\r\n\r\nexport const safeHasLorebookEntries = bookName => {\r\n  try {\r\n    if (!appState.lorebookEntries || !(appState.lorebookEntries instanceof Map)) {\r\n      console.warn('[RegexLoreHub] appState.lorebookEntries is not a Map, reinitializing...');\r\n      appState.lorebookEntries = new Map();\r\n      return false;\r\n    }\r\n    if (typeof appState.lorebookEntries.has !== 'function') {\r\n      console.warn('[RegexLoreHub] appState.lorebookEntries.has is not a function, reinitializing...');\r\n      appState.lorebookEntries = new Map();\r\n      return false;\r\n    }\r\n    return appState.lorebookEntries.has(bookName);\r\n  } catch (error) {\r\n    console.error('[RegexLoreHub] Error in safeHasLorebookEntries:', error);\r\n    appState.lorebookEntries = new Map();\r\n    return false;\r\n  }\r\n};\r\n\r\nexport function getParentWin() {\r\n  return window.parent || window;\r\n}\r\n\r\nexport function getParentDoc() {\r\n  return getParentWin().document;\r\n}\r\n\r\nexport const escapeHtml = text => {\r\n  if (typeof text !== 'string') return String(text);\r\n  const div = getParentDoc().createElement('div');\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n};\r\n\r\nexport const highlightText = (text, searchTerm) => {\r\n  if (!searchTerm || !text) return escapeHtml(text);\r\n  const escapedText = escapeHtml(text);\r\n  const htmlSafeSearchTerm = escapeHtml(searchTerm);\r\n  const regexSpecialChars = new Set(['.', '*', '+', '?', '^', '$', '{', '}', '(', ')', '|', '[', ']', '\\\\\\\\']);\r\n  let escapedSearchTerm = '';\r\n  for (const char of htmlSafeSearchTerm) {\r\n    escapedSearchTerm += regexSpecialChars.has(char) ? '\\\\' + char : char;\r\n  }\r\n  const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');\r\n  return escapedText.replace(regex, '<mark class=\"rlh-highlight\">$1</mark>');\r\n};\r\n\r\nexport const showToast = (message, type = 'success', duration = 2000) => {\r\n  const $ = get$();\r\n  const parentDoc = getParentDoc();\r\n  if (!$ || !parentDoc) return;\r\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\r\n  if ($panel.length === 0) return;\r\n\r\n  $panel.find('.rlh-toast-notification').remove();\r\n\r\n  const iconClass = {\r\n    success: 'fa-check-circle',\r\n    error: 'fa-times-circle',\r\n    info: 'fa-info-circle',\r\n  }[type];\r\n\r\n  const toastHtml = `\r\n    <div class=\"rlh-toast-notification ${type}\">\r\n      <i class=\"fa-solid ${iconClass}\"></i> ${escapeHtml(message)}\r\n    </div>\r\n  `;\r\n\r\n  const $toast = $(toastHtml);\r\n  $panel.append($toast);\r\n\r\n  setTimeout(() => $toast.addClass('visible'), 10);\r\n\r\n  setTimeout(() => {\r\n    $toast.removeClass('visible');\r\n    setTimeout(() => $toast.remove(), 300);\r\n  }, duration);\r\n};\r\n\r\nexport const showProgressToast = (initialMessage = '\u6B63\u5728\u5904\u7406...') => {\r\n  const $ = get$();\r\n  const parentDoc = getParentDoc();\r\n  if (!$ || !parentDoc) return { update: () => {}, remove: () => {} };\r\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\r\n  if ($panel.length === 0) return { update: () => {}, remove: () => {} };\r\n  $panel.find('.rlh-progress-toast').remove();\r\n  const toastHtml = `<div class=\"rlh-progress-toast\"><i class=\"fa-solid fa-spinner fa-spin\"></i> <span class=\"rlh-progress-text\">${escapeHtml(initialMessage)}</span></div>`;\r\n  const $toast = $(toastHtml);\r\n  $panel.append($toast);\r\n  setTimeout(() => $toast.addClass('visible'), 10);\r\n  const update = newMessage => {\r\n    $toast.find('.rlh-progress-text').html(escapeHtml(newMessage));\r\n  };\r\n  const remove = () => {\r\n    $toast.removeClass('visible');\r\n    setTimeout(() => $toast.remove(), 300);\r\n  };\r\n  return { update, remove };\r\n};\r\n\r\nexport const showModal = options => {\r\n  const $ = get$();\r\n  const parentDoc = getParentDoc();\r\n  if (!$ || !parentDoc) return Promise.reject();\r\n  return new Promise((resolve, reject) => {\r\n    const { type = 'alert', title = '\u901A\u77E5', text = '', html = '', placeholder = '', value = '' } = options || {};\r\n    let buttonsHtml = '';\r\n    if (type === 'alert') buttonsHtml = '<button class=\"rlh-modal-btn rlh-modal-ok\">\u786E\u5B9A</button>';\r\n    else if (type === 'confirm')\r\n      buttonsHtml =\r\n        '<button class=\"rlh-modal-btn rlh-modal-cancel\">\u53D6\u6D88</button><button class=\"rlh-modal-btn rlh-modal-ok\">\u786E\u8BA4</button>';\r\n    else if (type === 'prompt')\r\n      buttonsHtml =\r\n        '<button class=\"rlh-modal-btn rlh-modal-cancel\">\u53D6\u6D88</button><button class=\"rlh-modal-btn rlh-modal-ok\">\u786E\u5B9A</button>';\r\n\r\n    const inputHtml =\r\n      type === 'prompt'\r\n        ? `<input type=\"text\" class=\"rlh-modal-input\" placeholder=\"${escapeHtml(placeholder)}\" value=\"${escapeHtml(value)}\">`\r\n        : '';\r\n\r\n    // \u4F18\u5148\u4F7F\u7528 html \u5185\u5BB9\uFF0C\u5426\u5219\u56DE\u9000\u5230 text\r\n    const bodyContent = html ? html : `<p>${escapeHtml(text)}</p>`;\r\n\r\n    const modalHtml = `<div class=\"rlh-modal-overlay\"><div class=\"rlh-modal-content\"><div class=\"rlh-modal-header\">${escapeHtml(title)}</div><div class=\"rlh-modal-body\">${bodyContent}${inputHtml}</div><div class=\"rlh-modal-footer\">${buttonsHtml}</div></div></div>`;\r\n\r\n    const $modal = $(modalHtml).hide();\r\n    const $panel = $(`#${PANEL_ID}`, parentDoc);\r\n    if ($panel.length > 0) $panel.append($modal);\r\n    else $('body', parentDoc).append($modal);\r\n\r\n    $modal.fadeIn(200);\r\n    const $input = $modal.find('.rlh-modal-input');\r\n    if (type === 'prompt') $input.focus().select();\r\n\r\n    const closeModal = (isSuccess, val) => {\r\n      $modal.fadeOut(200, () => {\r\n        $modal.remove();\r\n        if (isSuccess) resolve(val);\r\n        else reject();\r\n      });\r\n    };\r\n\r\n    $modal.on('click', '.rlh-modal-ok', () => {\r\n      const val = type === 'prompt' ? $input.val() : true;\r\n      if (type === 'prompt' && !String(val).trim()) {\r\n        $input.addClass('rlh-input-error');\r\n        setTimeout(() => $input.removeClass('rlh-input-error'), 500);\r\n        return;\r\n      }\r\n      closeModal(true, val);\r\n    });\r\n    $modal.on('click', '.rlh-modal-cancel', () => closeModal(false));\r\n    if (type === 'prompt') {\r\n      $input.on('keydown', e => {\r\n        if (e.key === 'Enter') $modal.find('.rlh-modal-ok').click();\r\n        else if (e.key === 'Escape') $modal.find('.rlh-modal-cancel').click();\r\n      });\r\n    }\r\n  });\r\n};\r\n\r\nexport const errorCatched = (fn, context = 'RegexLoreHub', options = {}) => {\n  const {\n    notify = 'toast',\n    toastType = 'error',\n    toastDuration = 4000,\n    toastMessage = '\u64CD\u4F5C\u53D1\u751F\u5F02\u5E38\uFF0C\u8BF7\u67E5\u770B\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u3002',\n    modalTitle = '\u811A\u672C\u5F02\u5E38',\n    modalText = '\u64CD\u4F5C\u4E2D\u53D1\u751F\u672A\u77E5\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u3002',\n  } = options ?? {};\n\n  return async (...args) => {\n    try {\n      return await fn(...args);\n    } catch (error) {\n      if (!error) return;\n      console.error(`[${context}] Error:`, error);\n\n      if (notify === 'modal') {\n        await showModal({ type: 'alert', title: modalTitle, text: modalText });\n        return;\n      }\n\n      if (notify === 'toast') {\n        showToast(toastMessage, toastType, toastDuration);\n      }\n    }\n  };\n};\n\r\n/**\r\n * \u521B\u5EFA\u4E00\u4E2A\u9632\u6296\u51FD\u6570\uFF0C\u8BE5\u51FD\u6570\u4F1A\u4ECE\u4E0A\u4E00\u6B21\u88AB\u8C03\u7528\u540E\uFF0C\u5EF6\u8FDF `delay` \u6BEB\u79D2\u540E\u8C03\u7528 `func` \u65B9\u6CD5\u3002\r\n * @param {Function} func \u8981\u9632\u6296\u7684\u51FD\u6570\u3002\r\n * @param {number} delay \u5EF6\u8FDF\u7684\u6BEB\u79D2\u6570\u3002\r\n * @returns {Function} \u8FD4\u56DE\u4E00\u4E2A\u65B0\u7684\u9632\u6296\u51FD\u6570\u3002\r\n */\r\nexport function debounce(func, delay) {\r\n  let timeout;\r\n  return function (...args) {\r\n    const context = this;\r\n    clearTimeout(timeout);\r\n    timeout = setTimeout(() => func.apply(context, args), delay);\r\n  };\r\n}\r\n\r\n/**\r\n * \u6839\u636E\u7ED9\u5B9A\u7684\u641C\u7D22\u8BCD\u548C\u9009\u9879\u6784\u5EFA\u4E00\u4E2A\u6B63\u5219\u8868\u8FBE\u5F0F\u5BF9\u8C61\u3002\r\n * @param {string} searchTerm - \u7528\u4E8E\u641C\u7D22\u7684\u5B57\u7B26\u4E32\u3002\r\n * @param {boolean} caseSensitive - \u662F\u5426\u533A\u5206\u5927\u5C0F\u5199\u3002\r\n * @returns {RegExp} - \u6784\u5EFA\u597D\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\u5BF9\u8C61\u3002\r\n */\r\nexport const buildSearchRegex = (searchTerm, caseSensitive) => {\r\n  const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\\]\\/\\\\]/g, '\\\\$&');\r\n  const flags = caseSensitive ? 'g' : 'gi';\r\n  return new RegExp(escapedTerm, flags);\r\n};\r\n\r\nexport const UI_TEXTS = {\r\n  INSERT_RULES_TITLE: '\u63D2\u5165\u89C4\u5219',\r\n  // ... \u672A\u6765\u53EF\u4EE5\u6DFB\u52A0\u66F4\u591AUI\u6587\u672C\r\n};\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n", "import {\n  SEARCH_INPUT_ID,\n  CORE_TOOLBAR_ID,\n  REPLACE_INPUT_ID,\n  TOGGLE_COLLAPSE_BTN_ID,\n  TOGGLE_RECURSION_BTN_ID,\n  FIX_KEYWORDS_BTN_ID,\n  SORT_MENU_ID,\n  SORT_MENU_BUTTON_ID,\n  POSITION_MENU_ID,\n  POSITION_MENU_BUTTON_ID,\n  FILTER_DEFINITIONS,\n  SORT_OPTION_DEFINITIONS,\n  DEFAULT_FILTER_LABELS,\n  LOREBOOK_OPTIONS,\n  appState,\n  highlightText,\n  escapeHtml,\n  get$,\n  getParentDoc,\n  getParentWin,\n  errorCatched,\n  safeGetLorebookEntries,\n  safeSetLorebookEntries,\n  UI_TEXTS,\n} from '../../core.js';\nimport { saveAllChanges } from '../../dataLayer.js';\r\n\r\nexport const getContextInstanceKey = context => context.instanceKey || context.id || 'default';\r\n\r\nexport const getActiveCollapseState = context => {\r\n  const key = getContextInstanceKey(context);\r\n  return appState.collapseStateByContext.get(key) ?? 'expanded';\r\n};\r\n\r\nexport const setActiveCollapseState = (context, state) => {\r\n  const key = getContextInstanceKey(context);\r\n  appState.collapseStateByContext.set(key, state);\r\n};\r\n\r\nexport const getActiveSortMode = context => {\n  const options = Array.isArray(context.sortOptions) ? context.sortOptions : [];\n  if (!options.length) return null;\n  const key = getContextInstanceKey(context);\n  const stored = appState.sortModeByContext.get(key);\n  if (stored && options.includes(stored)) {\n    return stored;\n  }\n  const defaultValue = options[0];\n  appState.sortModeByContext.set(key, defaultValue);\n  return defaultValue;\n};\n\nexport const setActiveSortMode = (context, mode) => {\n  const options = context.sortOptions ?? [];\n  if (!options.includes(mode)) return;\n  const key = getContextInstanceKey(context);\n  appState.sortModeByContext.set(key, mode);\n};\n\r\nconst escapeAttr = value => escapeHtml(String(value ?? ''));\r\n\r\nconst buildFilterCheckboxes = (context, filtersState) => {\n  const filters = context.visibleFilters ?? [];\r\n  if (!filters.length) return '';\r\n\r\n  const items = filters\r\n    .map(key => {\r\n      const definition = FILTER_DEFINITIONS[key];\r\n      if (!definition) return '';\r\n      const label = context.filterLabels?.[key] ?? DEFAULT_FILTER_LABELS[key] ?? key;\r\n      const isChecked = filtersState[key];\r\n      return `<label class=\"rlh-filter-item\"><input type=\"checkbox\" id=\"${definition.id}\" data-filter-key=\"${key}\" ${isChecked ? 'checked' : ''}>${label}</label>`;\r\n    })\r\n    .filter(Boolean)\r\n    .join('');\r\n\r\n  if (!items) return '';\r\n  return `<div class=\"rlh-filter-list\" id=\"rlh-search-filters-container\">${items}</div>`;\r\n};\r\n\r\nconst buildSortMenu = (context, currentSort) => {\n  const options = Array.isArray(context.sortOptions) ? context.sortOptions : [];\n  if (!options.length) return '';\n\n  const items = options\n    .map(key => {\n      const option = SORT_OPTION_DEFINITIONS[key];\n      if (!option) return '';\n      const isActive = option.value === currentSort;\n      return `<li role=\"presentation\"><button type=\"button\" class=\"rlh-sort-option${isActive ? ' active' : ''}\" data-sort-value=\"${option.value}\" role=\"option\" aria-selected=\"${isActive ? 'true' : 'false'}\">${option.label}</button></li>`;\n    })\n    .filter(Boolean)\n    .join('');\n\n  if (!items) return '';\n  const menuListId = `${SORT_MENU_ID}-list`;\n\n  return `<div class=\"rlh-sort-menu\" id=\"${SORT_MENU_ID}\" data-open=\"false\"><button type=\"button\" id=\"${SORT_MENU_BUTTON_ID}\" class=\"rlh-toolbar-btn\" data-current-sort=\"${currentSort ?? ''}\" aria-haspopup=\"listbox\" aria-expanded=\"false\" aria-controls=\"${menuListId}\"><i class=\"fa-solid fa-sort\"></i><span>\u6392\u5E8F</span></button><ul class=\"rlh-sort-menu-list\" id=\"${menuListId}\" role=\"listbox\" aria-labelledby=\"${SORT_MENU_BUTTON_ID}\">${items}</ul></div>`;\n};\n\nconst buildPositionMenu = context => {\n  if (!context.showPositionMenu) return '';\r\n\r\n  const bookName = context.activeBookName?.toString().trim() ?? '';\r\n  const entries = bookName ? safeGetLorebookEntries(bookName) : [];\r\n  const hasEntries = entries.length > 0;\r\n\r\n  const uniquePositions = new Set(\r\n    entries.map(entry => (entry?.position ?? 'before_character_definition').toString()),\r\n  );\r\n  const activePosition = uniquePositions.size === 1 ? uniquePositions.values().next().value : null;\r\n\r\n  const menuListId = `${POSITION_MENU_ID}-list`;\r\n  const buttonAttributes = [\r\n    'type=\"button\"',\r\n    `id=\"${POSITION_MENU_BUTTON_ID}\"`,\r\n    'class=\"rlh-toolbar-btn\"',\r\n    'aria-haspopup=\"listbox\"',\r\n    'aria-expanded=\"false\"',\r\n    `aria-controls=\"${menuListId}\"`,\r\n  ];\r\n\r\n  if (!bookName || !hasEntries) {\r\n    buttonAttributes.push('disabled');\r\n  }\r\n\r\n  if (bookName) {\r\n    buttonAttributes.push(`data-book-name=\"${escapeHtml(bookName)}\"`);\r\n  }\r\n\r\n  const items = Object.entries(LOREBOOK_OPTIONS.position)\r\n    .map(([value, label]) => {\r\n      const isActive = hasEntries && activePosition === value;\r\n      const attributes = [\r\n        'type=\"button\"',\r\n        `class=\"rlh-position-option${isActive ? ' active' : ''}\"`,\r\n        `data-position-value=\"${escapeHtml(value)}\"`,\r\n        `role=\"option\"`,\r\n        `aria-selected=\"${isActive ? 'true' : 'false'}\"`,\r\n      ];\r\n      if (bookName) {\r\n        attributes.push(`data-book-name=\"${escapeHtml(bookName)}\"`);\r\n      }\r\n      return `<li role=\"presentation\"><button ${attributes.join(' ')}>${escapeHtml(label)}</button></li>`;\n    })\n    .join('');\n\r\n  const containerAttributes = [\r\n    'class=\"rlh-position-menu\"',\r\n    `id=\"${POSITION_MENU_ID}\"`,\r\n    'data-open=\"false\"',\r\n  ];\r\n\r\n  if (bookName) {\r\n    containerAttributes.push(`data-book-name=\"${escapeHtml(bookName)}\"`);\r\n  }\r\n\r\n  return `<div ${containerAttributes.join(' ')}><button ${buttonAttributes.join(' ')}><i class=\"fa-solid fa-map-pin\"></i><span>\u7EDF\u4E00\u4F4D\u7F6E</span></button><ul class=\"rlh-position-menu-list\" id=\"${menuListId}\" role=\"listbox\" aria-labelledby=\"${POSITION_MENU_BUTTON_ID}\">${items}</ul></div>`;\n};\r\n\r\nexport const renderToolbar = (context, { $toolbar, $replaceContainer }) => {\n  const collapseState = getActiveCollapseState(context);\n  const sortMode = (context.sortOptions?.length ?? 0) ? getActiveSortMode(context) : null;\n\n  const multiSelectClasses = ['rlh-toolbar-btn'];\n  if (appState.multiSelectMode) multiSelectClasses.push('active');\r\n  if (!context.supportsMultiSelect) multiSelectClasses.push('disabled');\r\n\r\n  const multiSelectAttributes = [\r\n    'type=\"button\"',\r\n    'id=\"rlh-multi-select-btn\"',\r\n    `class=\"${multiSelectClasses.join(' ')}\"`,\r\n    `data-target=\"${context.supportsMultiSelect ? context.multiSelectTarget : ''}\"`,\r\n  ];\r\n  if (!context.supportsMultiSelect) multiSelectAttributes.push('disabled');\r\n\r\n  const multiSelectButtonHtml = `<button ${multiSelectAttributes.join(' ')}><i class=\"fa-solid fa-check-double\"></i><span>\u591A\u9009\u6A21\u5F0F</span></button>`;\r\n\r\n  const multiSelectControlsClass = ['rlh-multi-select-controls'];\r\n  if (appState.multiSelectMode) multiSelectControlsClass.push('active');\r\n  const multiSelectControlsHtml = context.supportsMultiSelect\r\n    ? `\r\n        <div id=\"rlh-multi-select-controls\" class=\"${multiSelectControlsClass.join(' ')}\">\r\n          <div class=\"rlh-multi-select-actions\">\r\n            <button class=\"rlh-multi-select-action-btn\" id=\"rlh-select-all-btn\" title=\"\u5168\u9009\">\u5168</button>\r\n            <button class=\"rlh-multi-select-action-btn\" id=\"rlh-select-none-btn\" title=\"\u6E05\u9664\">\u6E05</button>\r\n            <button class=\"rlh-multi-select-action-btn\" id=\"rlh-select-invert-btn\" title=\"\u53CD\u9009\">\u53CD</button>\r\n            <button class=\"rlh-multi-select-action-btn enable\" id=\"rlh-batch-enable-btn\" title=\"\u542F\u7528\">\u5F00</button>\r\n            <button class=\"rlh-multi-select-action-btn disable\" id=\"rlh-batch-disable-btn\" title=\"\u7981\u7528\">\u5173</button>\r\n            <button class=\"rlh-multi-select-action-btn disable\" id=\"rlh-batch-delete-btn\" title=\"\u5220\u9664\">\u5220</button>\r\n          </div>\r\n          <span class=\"rlh-selection-count\" id=\"rlh-selection-count\">\u5DF2\u9009\u62E9: ${appState.selectedItems.size}</span>\r\n        </div>\r\n      `\r\n    : '';\r\n  const multiSelectModuleHtml = `\r\n        <div class=\"rlh-multi-select-module\">\r\n          ${multiSelectButtonHtml}\r\n          ${multiSelectControlsHtml}\r\n        </div>\r\n      `;\r\n\r\n  let collapseButtonHtml = '';\r\n  if (context.showCollapseToggle) {\r\n    const icon = collapseState === 'collapsed' ? 'fa-expand-arrows-alt' : 'fa-compress-arrows-alt';\r\n    const label = collapseState === 'collapsed' ? '\u5168\u90E8\u5C55\u5F00' : '\u5168\u90E8\u6298\u53E0';\r\n    collapseButtonHtml = `<button type=\"button\" id=\"${TOGGLE_COLLAPSE_BTN_ID}\" class=\"rlh-toolbar-btn\" data-collapse-state=\"${collapseState}\"><i class=\"fa-solid ${icon}\"></i><span>${label}</span></button>`;\r\n  }\r\n\r\n  const recursionButtonHtml = context.showRecursion\r\n    ? (() => {\r\n        const targetBookName = context.activeBookName ?? '';\r\n        const attributes = [\r\n          'type=\"button\"',\r\n          `id=\"${TOGGLE_RECURSION_BTN_ID}\"`,\r\n          'class=\"rlh-toolbar-btn rlh-batch-recursion-btn\"',\r\n        ];\r\n        if (targetBookName) {\r\n          attributes.push(`data-book-name=\"${escapeHtml(targetBookName)}\"`);\r\n        } else {\r\n          attributes.push('disabled');\r\n        }\r\n        return `<button ${attributes.join(' ')}><i class=\"fa-solid fa-shield-halved\"></i><span>\u5168\u5F00\u9632\u9012\u5F52</span></button>`;\r\n      })()\r\n    : '';\r\n\r\n  const fixKeywordsButtonHtml = context.showFixKeywords\r\n    ? (() => {\r\n        const targetBookName = context.activeBookName ?? '';\r\n        const attributes = [\r\n          'type=\"button\"',\r\n          `id=\"${FIX_KEYWORDS_BTN_ID}\"`,\r\n          'class=\"rlh-toolbar-btn rlh-fix-keywords-btn\"',\r\n        ];\r\n        if (targetBookName) {\r\n          attributes.push(`data-book-name=\"${escapeHtml(targetBookName)}\"`);\r\n        } else {\r\n          attributes.push('disabled');\r\n        }\r\n        return `<button ${attributes.join(' ')}><i class=\"fa-solid fa-check-double\"></i><span>\u4FEE\u590D\u5173\u952E\u8BCD</span></button>`;\r\n      })()\r\n    : '';\r\n\r\n  const positionMenuHtml = buildPositionMenu(context);\n  const sortMenuHtml = buildSortMenu(context, sortMode);\n  const filtersHtml = buildFilterCheckboxes(context, appState.searchFilters);\r\n  const scopeLabel = escapeHtml(context.scopeLabel);\r\n  const searchPlaceholder = escapeHtml(context.searchPlaceholder);\r\n  const searchValue = escapeAttr(appState.globalSearch.term ?? '');\r\n\r\n  const searchFieldHtml = `<label class=\"rlh-search-field\">\r\n          <input type=\"search\" id=\"${SEARCH_INPUT_ID}\" class=\"rlh-search-input\" placeholder=\"${searchPlaceholder}\" value=\"${searchValue}\" autocomplete=\"off\" />\r\n        </label>`;\r\n  const clearButtonHtml = `<button type=\"button\" id=\"rlh-search-clear-btn\" class=\"rlh-toolbar-icon-btn\" title=\"\u6E05\u7A7A\"><i class=\"fa-solid fa-eraser\"></i></button>`;\r\n  const searchRowHtml = `<div class=\"rlh-search-row\">${searchFieldHtml}${clearButtonHtml}</div>`;\r\n  const replaceValue = escapeAttr(appState.globalSearch.replace ?? '');\r\n  const replacePanelHtml = context.showReplace\r\n    ? `<div class=\"rlh-replace-body\"><input type=\"text\" id=\"${REPLACE_INPUT_ID}\" class=\"rlh-replace-input\" placeholder=\"\u66FF\u6362\u4E3A...\" value=\"${replaceValue}\" /><button type=\"button\" id=\"rlh-replace-btn\" class=\"rlh-toolbar-icon-btn rlh-replace-action\" title=\"\u66FF\u6362\"><i class=\"fa-solid fa-repeat\"></i></button></div>`\r\n    : '';\r\n  const searchMetaHtml = `<div class=\"rlh-search-meta\">\r\n          ${filtersHtml}\r\n          <span class=\"rlh-search-scope\">${scopeLabel}</span>\r\n        </div>`;\r\n  const searchBoxHtml = `<div class=\"rlh-search-box\">${searchRowHtml}${replacePanelHtml}${searchMetaHtml}</div>`;\r\n\r\n  let createEntryButtonHtml = '';\r\n  if (context.primaryAction?.visible && context.primaryAction.scope === 'entry') {\r\n    const bookNameForCreate = context.activeBookName ?? '';\r\n    const disabled = !bookNameForCreate;\r\n    const buttonClasses = ['rlh-toolbar-btn', 'rlh-create-entry-btn'];\r\n    if (disabled) buttonClasses.push('disabled');\r\n    const attributes = [\r\n      'type=\"button\"',\r\n      `class=\"${buttonClasses.join(' ')}\"`,\r\n    ];\r\n    const actionTitle = context.primaryAction.title ?? context.primaryAction.label ?? '';\r\n    if (actionTitle) attributes.push(`title=\"${escapeHtml(actionTitle)}\"`);\r\n    if (disabled) attributes.push('disabled');\r\n    else attributes.push(`data-book-name=\"${escapeHtml(bookNameForCreate)}\"`);\r\n    const iconClass = context.primaryAction.icon ? context.primaryAction.icon : 'fa-file-circle-plus';\r\n    const label = escapeHtml(context.primaryAction.label ?? '\u65B0\u5EFA\u6761\u76EE');\r\n    createEntryButtonHtml = `<button ${attributes.join(' ')}><i class=\"fa-solid ${iconClass}\"></i><span>${label}</span></button>`;\r\n  }\r\n\r\n  let createBookButtonHtml = '';\r\n  if (context.primaryAction?.visible && context.primaryAction.scope === 'book') {\r\n    const buttonClasses = ['rlh-toolbar-btn', 'rlh-create-book-btn'];\r\n    const attributes = [\r\n      'type=\"button\"',\r\n      'id=\"regex-lore-hub-create-lorebook-btn\"',\r\n      `class=\"${buttonClasses.join(' ')}\"`,\r\n    ];\r\n    const actionTitle = context.primaryAction.title ?? context.primaryAction.label ?? '';\r\n    if (actionTitle) attributes.push(`title=\"${escapeHtml(actionTitle)}\"`);\r\n    const iconClass = context.primaryAction.icon ? context.primaryAction.icon : 'fa-plus';\r\n    const label = escapeHtml(context.primaryAction.label ?? '\u65B0\u5EFA\u4E16\u754C\u4E66');\r\n    createBookButtonHtml = `<button ${attributes.join(' ')}><i class=\"fa-solid ${iconClass}\"></i><span>${label}</span></button>`;\r\n  }\r\n\r\n  const searchSectionHtml = `\r\n    <div class=\"rlh-toolbar-section rlh-toolbar-section--search\">\r\n      <div class=\"rlh-search-section-grid\">\r\n        <div class=\"rlh-search-section-main\">\r\n          ${searchBoxHtml}\r\n        </div>\r\n        <div class=\"rlh-search-section-multiselect\">\r\n          ${multiSelectModuleHtml}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  `;\r\n\r\n  const actionsItems = [\r\n    createBookButtonHtml,\r\n    createEntryButtonHtml,\r\n    context.showCollapseToggle ? collapseButtonHtml : '',\n    recursionButtonHtml,\n    fixKeywordsButtonHtml,\n    positionMenuHtml,\n    sortMenuHtml,\n  ].filter(Boolean);\n\r\n  const actionsSectionHtml = actionsItems.length\r\n    ? `\r\n        <div class=\"rlh-toolbar-section rlh-toolbar-section--actions\">\r\n          <div class=\"rlh-toolbar-actions\">\r\n            ${actionsItems.join('')}\r\n          </div>\r\n        </div>\r\n      `\r\n    : '';\r\n\r\n  const toolbarSectionsHtml = [searchSectionHtml, actionsSectionHtml].filter(Boolean).join('');\r\n\r\n  const toolbarHtml = `\r\n    <div class=\"rlh-toolbar-inner\">\r\n      ${toolbarSectionsHtml}\r\n    </div>\r\n\r\n  `;\r\n\r\n  $toolbar.html(toolbarHtml);\r\n\r\n  $replaceContainer.empty();\r\n};\r\n\r\nexport const matchEntry = (entry, searchTerm) => {\r\n  const term = searchTerm.toLowerCase();\r\n  if (!term) return true;\r\n  if (appState.searchFilters.entryName && (entry.name || '').toLowerCase().includes(term)) {\r\n    return true;\r\n  }\r\n  if (appState.searchFilters.keywords && entry.keys.join(' ').toLowerCase().includes(term)) {\r\n    return true;\r\n  }\r\n  if (appState.searchFilters.content && entry.content && entry.content.toLowerCase().includes(term)) {\r\n    return true;\r\n  }\r\n  return false;\r\n};\r\n\r\nexport const matchRegex = (item, searchTerm) => {\r\n  const term = searchTerm.toLowerCase();\r\n  if (appState.searchFilters.entryName && (item.script_name || '').toLowerCase().includes(term)) {\r\n    return true;\r\n  }\r\n  if (appState.searchFilters.content && (item.find_regex || '').toLowerCase().includes(term)) {\r\n    return true;\r\n  }\r\n  if (appState.searchFilters.content && (item.replace_string || '').toLowerCase().includes(term)) {\r\n    return true;\r\n  }\r\n  return false;\r\n};\r\n\r\nexport const createGlobalLorebookElement = (book, searchTerm, forceShowAllEntries, filteredEntries) => {\r\n  const $ = get$();\r\n  const usedByChars = appState.lorebookUsage.get(book.name) || [];\r\n  const usedByHtml =\r\n    usedByChars.length > 0\r\n      ? `<div class=\"rlh-used-by-chars\">\u4F7F\u7528\u8005: ${usedByChars.map(char => `<span>${escapeHtml(char)}</span>`).join(', ')}</div>`\r\n      : '';\r\n\r\n  const highlightedBookName = highlightText(book.name, searchTerm);\r\n  const selectionAllowed = appState.multiSelectMode && appState.multiSelectTarget === 'book';\r\n  const selectionKey = `book:${book.name}`;\r\n  const isSelected = selectionAllowed && appState.selectedItems.has(selectionKey);\r\n  const selectionControl = selectionAllowed\r\n    ? `<label class=\"rlh-selection-control\"><input type=\"checkbox\" class=\"rlh-multi-select-checkbox\" data-select-key=\"${escapeHtml(selectionKey)}\" ${isSelected ? 'checked' : ''}></label>`\r\n    : '';\r\n\r\n  const $element = $(`\r\n      <div class=\"rlh-book-group\" data-book-name=\"${escapeHtml(book.name)}\" data-select-key=\"${escapeHtml(selectionKey)}\">\r\n          <div class=\"rlh-global-book-header rlh-clickable-header\">\r\n              ${selectionControl}\r\n              <div class=\"rlh-book-title-wrapper\">\r\n                  <span class=\"rlh-item-name\">${highlightedBookName}</span>\r\n                  <div class=\"rlh-book-stats\">\u6761\u76EE: ${book.enabledEntryCount} / ${book.entryCount}</div>\r\n              </div>\r\n              <div class=\"rlh-item-controls\">\r\n                  <button class=\"rlh-action-btn-icon rlh-rename-book-btn\" title=\"\u91CD\u547D\u540D\u4E16\u754C\u4E66\"><i class=\"fa-solid fa-pen-to-square\"></i></button>\r\n                  <button class=\"rlh-toggle-btn rlh-global-toggle\" title=\"\u542F\u7528/\u7981\u7528\u6574\u4E2A\u4E16\u754C\u4E66\"><i class=\"fa-solid fa-power-off\"></i></button>\r\n                  <button class=\"rlh-action-btn-icon rlh-delete-book-btn\" title=\"\u5220\u9664\u4E16\u754C\u4E66\"><i class=\"fa-solid fa-folder-minus\"></i></button>\r\n              </div>\r\n          </div>\r\n          ${usedByChars.length > 0 ? `<div class=\"rlh-book-summary\">${usedByHtml}</div>` : ''}\r\n          <div class=\"rlh-collapsible-content\"></div>\r\n      </div>\r\n    `);\r\n\r\n  $element.toggleClass('enabled', book.enabled);\r\n  $element.find('.rlh-global-book-header').toggleClass('enabled', book.enabled);\r\n  $element.toggleClass('selected', isSelected);\r\n\r\n  const $content = $element.find('.rlh-collapsible-content');\r\n  const $entryActions = $(\r\n    `<div class=\"rlh-entry-actions\"><button class=\"rlh-action-btn rlh-create-entry-btn\" data-book-name=\"${escapeHtml(book.name)}\"><i class=\"fa-solid fa-plus\"></i> \u65B0\u5EFA\u6761\u76EE</button><button class=\"rlh-action-btn rlh-batch-recursion-btn\" data-book-name=\"${escapeHtml(book.name)}\"><i class=\"fa-solid fa-shield-halved\"></i> \u5168\u5F00\u9632\u9012\u5F52</button><button class=\"rlh-action-btn rlh-fix-keywords-btn\" data-book-name=\"${escapeHtml(book.name)}\"><i class=\"fa-solid fa-check-double\"></i> \u4FEE\u590D\u5173\u952E\u8BCD</button></div>`,\r\n  );\r\n  $content.append($entryActions);\r\n\r\n  let allEntries = [...safeGetLorebookEntries(book.name)].sort(\r\n    (a, b) => ((a.display_index ?? Number.MAX_SAFE_INTEGER) - (b.display_index ?? Number.MAX_SAFE_INTEGER)),\r\n  );\r\n  let entriesToShow = forceShowAllEntries ? allEntries : filteredEntries || [];\r\n\r\n  if (entriesToShow && entriesToShow.length > 0) {\r\n    const $listWrapper = $('<div class=\"rlh-entry-list-wrapper\"></div>');\r\n    entriesToShow.forEach(entry => $listWrapper.append(createItemElement(entry, 'lore', book.name, searchTerm, { enableDrag: false })));\r\n    $content.append($listWrapper);\r\n  } else if (searchTerm) {\r\n    $content.append(`<div class=\"rlh-info-text-small\">\u65E0\u5339\u914D\u9879</div>`);\r\n  }\r\n\r\n  return $element;\r\n};\r\n\r\nconst convertMultilineToHtml = html => (typeof html === 'string' ? html.replace(/\\r?\\n/g, '<br>') : html);\r\nconst buildViewerPlaceholder = text => `<span class=\"rlh-viewer-empty\">${escapeHtml(text)}</span>`;\r\n\r\nexport const buildLoreEntryViewerHTML = (entry, searchTerm) => {\r\n  const keywords = Array.isArray(entry?.keys) ? entry.keys : [];\r\n  const keywordsText = keywords.join(', ');\r\n  const keywordsHtml = keywordsText\r\n    ? convertMultilineToHtml(searchTerm ? highlightText(keywordsText, searchTerm) : escapeHtml(keywordsText))\r\n    : buildViewerPlaceholder('\u6682\u65E0\u5173\u952E\u8BCD');\r\n  const rawContent = entry?.content ?? '';\r\n  const contentHtml = rawContent\r\n    ? convertMultilineToHtml(searchTerm ? highlightText(rawContent, searchTerm) : escapeHtml(rawContent))\r\n    : buildViewerPlaceholder('\u6682\u65E0\u5185\u5BB9');\r\n\r\n  const hasValue = value => value !== undefined && value !== null && value !== '';\r\n  const formatViewerText = (value, placeholder = '\u672A\u8BBE\u7F6E') => {\r\n    if (!hasValue(value)) {\r\n      return buildViewerPlaceholder(placeholder);\r\n    }\r\n    return escapeHtml(String(value));\r\n  };\r\n\r\n  const buildViewerField = field => {\r\n    if (!field) return '';\r\n    const { label, value, placeholder, html } = field;\r\n    const body = html !== undefined ? html : formatViewerText(value, placeholder);\r\n    return `\r\n      <div class=\"rlh-editor-field rlh-viewer-field\">\r\n        <label>${label}</label>\r\n        <div class=\"rlh-viewer-text\">${body}</div>\r\n      </div>\r\n    `;\r\n  };\r\n\r\n  const buildViewerGroup = (title, fields, options = {}) => {\r\n    if (!fields.length) return '';\r\n    const layout = options.layout ?? 'grid';\r\n    const headingHtml = title ? `<h5>${title}</h5>` : '';\r\n    let contentHtml = '';\r\n    if (layout === 'grid') {\r\n      const itemsHtml = fields\r\n        .map(field => `\r\n          <div class=\"rlh-grid-item\">${buildViewerField(field)}</div>`)\r\n        .join('');\r\n      contentHtml = `\r\n        <div class=\"rlh-editor-grid\">${itemsHtml}\r\n        </div>\r\n      `;\r\n    } else {\r\n      contentHtml = fields.map(buildViewerField).join('');\r\n    }\r\n    return `\r\n      <div class=\"rlh-editor-group rlh-viewer-group\">\r\n        ${headingHtml}\r\n        ${contentHtml}\r\n      </div>\r\n    `;\r\n  };\r\n\r\n    const positionLabel = (() => {\r\n      const pos = entry?.position;\r\n      if (!hasValue(pos)) return null;\r\n\r\n      // \u65B0\u7248\uFF1Aposition \u662F\u4E00\u4E2A\u5E26 type \u5C5E\u6027\u7684\u5BF9\u8C61\r\n      if (typeof pos === 'object' && pos !== null && typeof pos.type === 'string' && pos.type) {\r\n        return LOREBOOK_OPTIONS.position?.[pos.type] ?? pos.type;\r\n      }\r\n\r\n      // \u65E7\u7248\uFF1Aposition \u662F\u4E00\u4E2A\u5B57\u7B26\u4E32\r\n      if (typeof pos === 'string') {\r\n        return LOREBOOK_OPTIONS.position?.[pos] ?? pos;\r\n      }\r\n\r\n      // \u5BF9\u4E8E\u6240\u6709\u5176\u4ED6\u610F\u5916\u60C5\u51B5\uFF08\u5982\u65E0 type \u7684\u5BF9\u8C61\uFF09\uFF0C\u5B89\u5168\u5730\u8FD4\u56DE null\r\n      return null;\r\n    })();\r\n  const depthValue = hasValue(entry?.depth) ? entry.depth : null;\r\n  const orderValue = hasValue(entry?.order) ? entry.order : null;\r\n\r\n  const hasLogic = hasValue(entry?.logic);\r\n  const logicKey = hasLogic ? entry.logic : 'and_any';\r\n  const logicBaseLabel = LOREBOOK_OPTIONS.logic?.[logicKey] ?? logicKey;\r\n  const logicValue = hasLogic ? logicBaseLabel : `${logicBaseLabel} (\u9ED8\u8BA4)`;\r\n\r\n  const probabilityValue = hasValue(entry?.probability)\r\n    ? `${entry.probability}%`\r\n    : '100% (\u9ED8\u8BA4)';\r\n\r\n  const keywordsField = buildViewerField({ label: '\u5173\u952E\u8BCD', html: keywordsHtml });\r\n  const contentField = buildViewerField({\r\n    label: '\u5185\u5BB9',\r\n    html: `<article class=\"rlh:prose rlh:dark:rlh:prose-invert max-w-none\">${contentHtml}</article>`,\r\n  });\r\n\r\n  const insertRuleGroup = buildViewerGroup(UI_TEXTS.INSERT_RULES_TITLE, [\r\n    { label: '\u4F4D\u7F6E', value: positionLabel, placeholder: '\u672A\u8BBE\u7F6E' },\r\n    { label: '\u6DF1\u5EA6', value: depthValue, placeholder: '\u672A\u8BBE\u7F6E' },\r\n    { label: '\u987A\u5E8F', value: orderValue, placeholder: '\u672A\u8BBE\u7F6E' },\r\n  ], { layout: 'grid' });\r\n  const activationGroup = buildViewerGroup('\u6FC0\u6D3B\u903B\u8F91', [\r\n    { label: '\u6982\u7387', value: probabilityValue, placeholder: '100% (\u9ED8\u8BA4)' },\r\n    { label: '\u5173\u952E\u8BCD\u903B\u8F91', value: logicValue, placeholder: '\u4EFB\u4E00 AND (\u9ED8\u8BA4)' },\r\n  ], { layout: 'grid' });\r\n  const matchingGroup = buildViewerGroup('\u5339\u914D\u4E0E\u9012\u5F52', [\r\n    { label: '\u5927\u5C0F\u5199\u654F\u611F', value: entry?.case_sensitive ? '\u5F00\u542F' : '\u5173\u95ED', placeholder: '\u5173\u95ED' },\r\n    { label: '\u5168\u8BCD\u5339\u914D', value: entry?.match_whole_words ? '\u5F00\u542F' : '\u5173\u95ED', placeholder: '\u5173\u95ED' },\r\n    { label: '\u9632\u6B62\u9012\u5F52', value: entry?.prevent_recursion ? '\u5F00\u542F' : '\u5173\u95ED', placeholder: '\u5173\u95ED' },\r\n    { label: '\u4E0D\u53EF\u88AB\u9012\u5F52', value: entry?.exclude_recursion ? '\u5F00\u542F' : '\u5173\u95ED', placeholder: '\u5173\u95ED' },\r\n  ], { layout: 'grid' });\r\n\r\n  return `\r\n    <div class=\"rlh-entry-viewer\" data-mode=\"view\">\r\n      ${keywordsField}\r\n      ${contentField}\r\n      ${insertRuleGroup}\r\n      ${activationGroup}\r\n      ${matchingGroup}\r\n    </div>\r\n  `;\r\n};\r\n\r\nexport const buildRegexViewerHTML = (item, searchTerm) => {\r\n  const findRaw = item?.find_regex ?? '';\r\n  const replaceRaw = item?.replace_string ?? '';\r\n  const normalizedTerm = typeof searchTerm === 'string' ? searchTerm : '';\r\n  const findHtml = findRaw\r\n    ? convertMultilineToHtml(normalizedTerm ? highlightText(findRaw, normalizedTerm) : escapeHtml(findRaw))\r\n    : buildViewerPlaceholder('\u6682\u65E0\u67E5\u627E\u6B63\u5219');\r\n  const replaceHtml = replaceRaw\r\n    ? convertMultilineToHtml(normalizedTerm ? highlightText(replaceRaw, normalizedTerm) : escapeHtml(replaceRaw))\r\n    : buildViewerPlaceholder('\u6682\u65E0\u66FF\u6362\u5185\u5BB9');\r\n\r\n  const destination = item?.destination ?? {};\r\n  const source = item?.source ?? {};\r\n  const minDepth = item?.min_depth;\r\n  const maxDepth = item?.max_depth;\r\n\r\n  const destinationLabels = [];\r\n  if (destination.display) destinationLabels.push('\u4EC5\u683C\u5F0F\u663E\u793A');\r\n  if (destination.prompt) destinationLabels.push('\u4EC5\u683C\u5F0F\u63D0\u793A\u8BCD');\r\n  const destinationText = destinationLabels.length\r\n    ? destinationLabels.join(' / ')\r\n    : '\u683C\u5F0F\u4E0E\u63D0\u793A\u8BCD';\r\n\r\n  const sourceMapping = {\r\n    user_input: '\u7528\u6237\u8F93\u5165',\r\n    ai_output: 'AI\u8F93\u51FA',\r\n    slash_command: '\u659C\u6760\u547D\u4EE4',\r\n    world_info: '\u4E16\u754C\u4E66',\r\n  };\r\n  const activeSources = Object.entries(sourceMapping)\r\n    .filter(([key]) => Boolean(source?.[key]))\r\n    .map(([, label]) => label);\r\n  const sourceText = activeSources.length === 0\r\n    ? '\u672A\u9009\u62E9\u4F5C\u7528\u8303\u56F4'\r\n    : activeSources.length === 4\r\n    ? '\u5168\u90E8\u6765\u6E90'\r\n    : activeSources.join(' / ');\r\n\r\n  const hasMin = minDepth !== undefined && minDepth !== null && minDepth !== '';\r\n  const hasMax = maxDepth !== undefined && maxDepth !== null && maxDepth !== '';\r\n  let depthText = '\u65E0\u6DF1\u5EA6\u9650\u5236';\r\n  if (hasMin && hasMax) depthText = `${minDepth} - ${maxDepth}`;\r\n  else if (hasMin) depthText = `>= ${minDepth}`;\r\n  else if (hasMax) depthText = `<= ${maxDepth}`;\r\n\r\n  const metaRows = [\r\n    { label: '\u8F93\u51FA\u8BBE\u7F6E', value: destinationText },\r\n    { label: '\u4F5C\u7528\u8303\u56F4', value: sourceText },\r\n    { label: '\u6DF1\u5EA6\u8303\u56F4', value: depthText },\r\n  ];\r\n\r\n  const metaHtml = metaRows\r\n    .map(row => `\r\n      <div class=\"rlh-editor-field rlh-viewer-field\">\r\n        <label>${row.label}</label>\r\n        <div class=\"rlh-viewer-text\">${escapeHtml(String(row.value ?? ''))}</div>\r\n      </div>\r\n    `)\r\n    .join('');\r\n\r\n  return `\r\n    <div class=\"rlh-regex-viewer\" data-mode=\"view\">\r\n      <div class=\"rlh-editor-field rlh-viewer-field\">\r\n        <label>\u67E5\u627E\u6B63\u5219\u8868\u8FBE\u5F0F</label>\r\n        <article class=\"rlh:prose rlh:dark:rlh:prose-invert max-w-none\">${findHtml}</article>\r\n      </div>\r\n      <div class=\"rlh-editor-field rlh-viewer-field\">\r\n        <label>\u66FF\u6362\u4E3A</label>\r\n        <article class=\"rlh:prose rlh:dark:rlh:prose-invert max-w-none\">${replaceHtml}</article>\r\n      </div>\r\n      ${metaHtml}\r\n    </div>\r\n  `;\r\n};\r\n\r\nexport const createItemElement = (item, type, bookName = '', searchTerm = '', options = {}) => {\r\n  const $ = get$();\r\n  const isLore = type === 'lore';\r\n  const id = isLore ? item.uid : item.id;\r\n  const name = isLore ? item.name || '\u65E0\u6807\u9898\u6761\u76EE' : item.script_name || '\u672A\u547D\u540D\u6B63\u5219';\r\n  const fromCard = item.source === 'card';\r\n  const collapseState = options.collapseState ?? 'expanded';\r\n  const isExpanded = options.isExpanded ?? false;\r\n  const enableDrag = options.enableDrag ?? true;\r\n  const selectionKey = options.selectionKey ?? (isLore ? `lore:${bookName}:${id}` : `regex:${id}`);\r\n  const target = appState.multiSelectTarget;\r\n  const selectionAllowed =\r\n    appState.multiSelectMode &&\r\n    ((target === 'entry' && isLore) || (target === 'regex' && !isLore));\r\n  const isSelected = selectionAllowed && appState.selectedItems.has(selectionKey);\r\n\r\n  let controlsHtml = '';\r\n\r\n  if (isLore) {\r\n    controlsHtml = `\r\n      <button class=\"rlh-action-btn-icon rlh-rename-btn\" title=\"\u91CD\u547D\u540D\u5E76\u7F16\u8F91\"><i class=\"fa-solid fa-pencil\"></i></button>\r\n      <button class=\"rlh-toggle-btn rlh-item-toggle\" title=\"\u542F\u7528/\u7981\u7528\u6B64\u6761\u76EE\"><i class=\"fa-solid fa-power-off\"></i></button>\r\n      <button class=\"rlh-action-btn-icon rlh-delete-entry-btn\" title=\"\u5220\u9664\u6761\u76EE\"><i class=\"fa-solid fa-trash-can\"></i></button>\r\n    `;\r\n  } else if (fromCard) {\r\n    controlsHtml = '<button class=\"rlh-toggle-btn rlh-item-toggle\" title=\"\u542F\u7528/\u7981\u7528\u6B64\u6761\u76EE\"><i class=\"fa-solid fa-power-off\"></i></button>';\r\n  } else {\r\n    controlsHtml = `\r\n      <button class=\"rlh-action-btn-icon rlh-rename-btn\" title=\"\u91CD\u547D\u540D\u5E76\u7F16\u8F91\"><i class=\"fa-solid fa-pencil\"></i></button>\r\n      <button class=\"rlh-toggle-btn rlh-item-toggle\" title=\"\u542F\u7528/\u7981\u7528\u6B64\u6761\u76EE\"><i class=\"fa-solid fa-power-off\"></i></button>\r\n    `;\r\n  }\r\n\r\n  const dragHandleHtml = enableDrag && !fromCard ? '<span class=\"rlh-drag-handle\" title=\"\u62D6\u62FD\u6392\u5E8F\"><i class=\"fa-solid fa-grip-vertical\"></i></span>'\r\n    : '';\r\n\r\n  const selectionControl = selectionAllowed\r\n    ? `<label class=\"rlh-selection-control\"><input type=\"checkbox\" class=\"rlh-multi-select-checkbox\" data-select-key=\"${escapeHtml(selectionKey)}\" ${isSelected ? 'checked' : ''}></label>`\r\n    : '';\r\n\r\n  const headerTitle = fromCard\r\n    ? '\u6B64\u6761\u76EE\u6765\u81EA\u89D2\u8272\u5361\uFF0C\u90E8\u5206\u64CD\u4F5C\u53D7\u9650'\r\n    : selectionAllowed\r\n    ? '\u70B9\u51FB\u9009\u62E9/\u53D6\u6D88\u9009\u62E9'\r\n    : '\u70B9\u51FB\u5C55\u5F00/\u7F16\u8F91';\r\n\r\n  const highlightedName = highlightText(name, searchTerm);\n\n  let metaHtml = '';\n  if (isLore) {\n    const positionKey = (item.position ?? 'before_character_definition').toString();\n    const positionLabelRaw = LOREBOOK_OPTIONS.position?.[positionKey] ?? '\u9ED8\u8BA4\u4F4D\u7F6E';\n    const positionLabel = escapeHtml(positionLabelRaw);\n    const orderNumber = Number(item.order);\n    const fallbackOrder = Number(item.display_index);\n    const effectiveOrder = Number.isFinite(orderNumber)\n      ? `#${orderNumber}`\n      : Number.isFinite(fallbackOrder)\n      ? `#${fallbackOrder}`\n      : '\u672A\u8BBE\u7F6E';\n    const orderLabel = escapeHtml(effectiveOrder);\n    metaHtml = `\n          <div class=\"rlh-item-meta\" title=\"\u63D2\u5165\u4E0E\u987A\u5E8F\u4FE1\u606F\">\n            <span class=\"rlh-item-meta-chip\"><i class=\"fa-solid fa-map-pin\"></i>\u63D2\u5165 ${positionLabel}</span>\n            <span class=\"rlh-item-meta-chip\"><i class=\"fa-solid fa-list-ol\"></i>\u987A\u5E8F ${orderLabel}</span>\n          </div>\n        `;\n  }\n\n  const $element = $(\n    `<div class=\"rlh-item-container ${fromCard ? 'from-card' : ''}\" data-type=\"${type}\" data-id=\"${id}\" ${isLore ? `data-book-name=\"${escapeHtml(bookName)}\"` : ''} data-select-key=\"${escapeHtml(selectionKey)}\">\n      <div class=\"rlh-item-header\" title=\"${headerTitle}\">\n        ${selectionControl}\n        ${dragHandleHtml}\n        <div class=\"rlh-item-header-main\">\n          <span class=\"rlh-item-name\">${highlightedName}</span>\n          ${metaHtml}\n        </div>\n        <div class=\"rlh-item-controls\">${controlsHtml}</div>\n      </div>\n      <div class=\"rlh-collapsible-content\"></div>\n    </div>`\n  );\n\r\n  $element.data('searchTerm', searchTerm);\r\n  $element.attr('data-search-term', typeof searchTerm === 'string' ? searchTerm : '');\r\n  $element.toggleClass('enabled', item.enabled);\r\n  $element.toggleClass('selected', isSelected);\r\n\r\n  const $content = $element.find('.rlh-collapsible-content');\r\n  let initialMode = options.initialMode;\r\n  if (!initialMode && searchTerm) {\r\n    initialMode = 'viewer';\r\n  }\r\n\r\n  if (isExpanded) {\r\n    $element.removeClass('rlh-collapsed');\r\n    $content.show();\r\n    $element.attr('data-entry-mode', 'edit');\r\n  } else if (initialMode === 'viewer') {\r\n    const viewerHtml = isLore\r\n      ? buildLoreEntryViewerHTML(item, searchTerm)\r\n      : buildRegexViewerHTML(item, searchTerm);\r\n    $content.html(viewerHtml);\r\n    $content.show();\r\n    $element.removeClass('rlh-collapsed');\r\n    $element.attr('data-entry-mode', 'view');\r\n  } else if (collapseState === 'collapsed') {\r\n    $element.addClass('rlh-collapsed');\r\n    $content.hide();\r\n    $element.attr('data-entry-mode', initialMode ?? 'collapsed');\r\n  } else {\r\n    $element.removeClass('rlh-collapsed');\r\n    $element.attr('data-entry-mode', initialMode ?? 'collapsed');\r\n  }\r\n\r\n  return $element;\r\n};\r\n\r\nexport const prependEntry = (entry, bookName) => {\r\n  const $ = get$();\r\n  const parentDoc = getParentDoc();\r\n  const $listWrapper = $('.rlh-entry-list-wrapper', parentDoc);\r\n\r\n  if ($listWrapper.length > 0) {\r\n    $listWrapper.find('.rlh-info-text').remove();\r\n\r\n    const $newEntryDom = createItemElement(entry, 'lore', bookName, '', { isExpanded: true });\r\n    $listWrapper.prepend($newEntryDom);\r\n    return $newEntryDom;\r\n  }\r\n  return null;\r\n};\r\n\r\nexport const updateSelectionCount = () => {\r\n  const $ = get$();\r\n  const parentDoc = getParentDoc();\r\n  $(`#rlh-selection-count`, parentDoc).text(`\u5DF2\u9009\u62E9: ${appState.selectedItems.size}`);\r\n};\r\n\r\nexport const buildReplaceConfirmationHTML = (matches, stats, booksMatchedByNameOnly, searchTerm, replaceTerm, context) => {\r\n  let summaryHtml = '';\r\n  let listHtml = '';\r\n  let booksOnlyHtml = '';\r\n\r\n  const buildStatsList = (statsData) => {\r\n    return Object.entries(statsData)\r\n      .filter(([, count]) => count > 0)\r\n      .map(([label, count]) => `<li>- ${escapeHtml(label)}\uFF1A<strong>${count}</strong> \u4E2A</li>`)\r\n      .join('');\r\n  };\r\n\r\n  if (context === 'lorebook') {\r\n    const totalBooks = new Set(matches.map(m => m.bookName)).size + (booksMatchedByNameOnly?.length ?? 0);\r\n    const totalEntries = matches.length;\r\n\r\n    summaryHtml = `\r\n      <div class=\"rlh-replace-stats\">\r\n        <p>- \u5171\u5339\u914D\u5230 ${totalBooks} \u672C\u4E16\u754C\u4E66\uFF0C\u5176\u4E2D ${totalEntries} \u4E2A\u6761\u76EE\u5C06\u88AB\u4FEE\u6539\u3002</p>\r\n        <p>- \u547D\u4E2D\u8BE6\u60C5\uFF1A</p>\r\n        <ul>\r\n          <li>- \u4E66\u540D\uFF1A<strong>${stats.bookName}</strong> \u4E2A</li>\r\n          <li>- \u6761\u76EE\u540D\uFF1A<strong>${stats.entryName}</strong> \u4E2A</li>\r\n          <li>- \u5173\u952E\u8BCD\uFF1A<strong>${stats.keywords}</strong> \u4E2A</li>\r\n          <li>- \u5185\u5BB9\uFF1A<strong>${stats.content}</strong> \u4E2A</li>\r\n        </ul>\r\n      </div>\r\n    `;\r\n\r\n    const listItemsHtml = matches.map(({ bookName, entry, matchedFields }) => {\r\n      const hitFields = [];\r\n      if (matchedFields) {\r\n        if (matchedFields.entryName) hitFields.push('\u6761\u76EE\u540D');\r\n        if (matchedFields.keywords > 0) hitFields.push('\u5173\u952E\u8BCD');\r\n        if (matchedFields.content) hitFields.push('\u5185\u5BB9');\r\n      }\r\n      const fieldsText = hitFields.join('\u3001');\r\n      const entryName = escapeHtml(entry.name || '\u65E0\u6807\u9898\u6761\u76EE');\r\n      const hitDetails = fieldsText ? `\uFF08${fieldsText}\uFF09` : '';\r\n      return `<li class=\"rlh-confirm-entry-item\">${escapeHtml(bookName)}: ${entryName}${hitDetails}</li>`;\r\n    }).join('');\r\n\r\n    listHtml = `<ul class=\"rlh-confirm-entry-list\">${listItemsHtml}</ul>`;\r\n\r\n    if (booksMatchedByNameOnly && booksMatchedByNameOnly.length > 0) {\r\n      const bookItems = booksMatchedByNameOnly.map(name => `<li class=\"rlh-confirm-entry-item\">${escapeHtml(name)}</li>`).join('');\r\n      booksOnlyHtml = `\r\n        <hr>\r\n        <h4>\u4EC5\u4E66\u540D\u5339\u914D (\u4E0D\u4F1A\u88AB\u66FF\u6362):</h4>\r\n        <div class=\"rlh-confirm-scroll-list rlh-confirm-scroll-list--secondary\">\r\n          <ul class=\"rlh-confirm-entry-list\">${bookItems}</ul>\r\n        </div>\r\n      `;\r\n    }\r\n\r\n  } else if (context === 'regex') {\r\n    const statsData = { '\u540D\u79F0\u5339\u914D': stats.name, '\u5185\u5BB9\u5339\u914D': stats.content };\r\n    const statsItems = buildStatsList(statsData);\r\n    if (statsItems) {\r\n      summaryHtml = `<div class=\"rlh-replace-stats\"><h4>\u66FF\u6362\u7EDF\u8BA1\u6458\u8981\uFF1A</h4><ul>${statsItems}</ul></div>`;\r\n    }\r\n    listHtml = `<ul class=\"rlh-confirm-entry-list\">${matches.map(item => `<li class=\"rlh-confirm-entry-item\">${escapeHtml(item.script_name || '\u672A\u547D\u540D\u6B63\u5219')}</li>`).join('')}</ul>`;\r\n  }\r\n\r\n  return `\r\n    <div class=\"rlh-replace-confirm-modal\">\r\n      <p>\u786E\u5B9A\u8981\u5C06 <strong>\"${escapeHtml(searchTerm)}\"</strong> \u66FF\u6362\u4E3A <strong>\"${escapeHtml(replaceTerm)}\"</strong> \u5417\uFF1F</p>\r\n      <p>\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\u3002</p>\r\n      <hr>\r\n      ${summaryHtml}\r\n      <hr>\r\n      <h4>\u5C06\u8981\u4FEE\u6539\u7684\u6761\u76EE\u5217\u8868\uFF1A</h4>\r\n      <div class=\"rlh-confirm-scroll-list rlh-overflow-y-auto rlh-max-h-48\">\r\n        ${listHtml}\r\n      </div>\r\n      ${booksOnlyHtml}\r\n    </div>\r\n  `;\r\n};\r\n\r\nexport const renderSaveStatus = () => {\r\n  const $ = get$();\r\n  const parentDoc = getParentDoc();\r\n  const $statusContainer = $('#regex-lore-hub-save-status', parentDoc);\r\n  if (!$statusContainer.length) return;\r\n\r\n  const status = appState.saveStatus;\r\n  let html = '';\r\n  let statusClass = '';\r\n\r\n  switch (status) {\r\n    case 'saving':\r\n      html = '<i class=\"fa-solid fa-spinner fa-spin\"></i> \u6B63\u5728\u4FDD\u5B58...';\r\n      statusClass = 'saving';\r\n      break;\r\n    case 'retrying':\r\n      html = `<i class=\"fa-solid fa-triangle-exclamation fa-fade\"></i> \u81EA\u52A8\u4FDD\u5B58\u5931\u8D25\uFF0C\u6B63\u5728\u91CD\u8BD5... (${appState.saveRetryAttempt}/3)`;\r\n      statusClass = 'retrying';\r\n      break;\r\n    case 'success':\r\n      html = '<i class=\"fa-solid fa-check-circle\"></i> \u6570\u636E\u5DF2\u4FDD\u5B58';\r\n      statusClass = 'success';\r\n      break;\r\n    case 'failed':\r\n      html = '<i class=\"fa-solid fa-circle-xmark\"></i> \u81EA\u52A8\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u8FDE\u63A5\u6216\u624B\u52A8\u4FDD\u5B58\u3002';\r\n      statusClass = 'failed';\r\n      break;\r\n    case 'idle':\r\n    default:\r\n      html = '';\r\n      statusClass = 'idle';\r\n      break;\r\n  }\r\n\r\n  $statusContainer.html(html);\r\n  $statusContainer.attr('class', `rlh-save-status ${statusClass}`);\r\n};\r\n\r\nconst reorderLoreEntriesInState = (bookName, orderedIds) => {\r\n  const entries = safeGetLorebookEntries(bookName);\r\n  if (!Array.isArray(entries) || !entries.length) return null;\r\n  if (!Array.isArray(orderedIds) || orderedIds.length !== entries.length) return null;\r\n\r\n  const entryMap = new Map(entries.map(entry => [String(entry.uid ?? ''), entry]));\r\n  const reordered = [];\r\n\r\n  orderedIds.forEach(id => {\r\n    const key = String(id ?? '');\r\n    if (!entryMap.has(key)) return;\r\n    reordered.push(entryMap.get(key));\r\n    entryMap.delete(key);\r\n  });\r\n\r\n  if (!reordered.length) return null;\r\n\r\n  entryMap.forEach(entry => reordered.push(entry));\r\n\r\n  reordered.forEach((entry, index) => {\r\n    entry.display_index = index;\r\n    if (entry.order === undefined || entry.order === null || Number.isNaN(Number(entry.order))) {\r\n      entry.order = index;\r\n    }\r\n  });\r\n\r\n  safeSetLorebookEntries(bookName, reordered);\r\n  return reordered;\r\n};\r\n\r\nexport const initializeLoreEntrySortable = ($listWrapper, bookName, options = {}) => {\r\n  const parentWin = getParentWin();\r\n  const enabled = options.enabled ?? false;\r\n  if (!enabled || !$listWrapper?.length || !parentWin?.Sortable) return;\r\n  const listEl = $listWrapper[0];\r\n  if (!listEl) return;\r\n  const itemCount = $listWrapper.find('.rlh-item-container').length;\r\n  if (itemCount < 2) return;\r\n\r\n  parentWin.Sortable.create(listEl, {\r\n    animation: 150,\r\n    handle: '.rlh-drag-handle',\r\n    ghostClass: 'sortable-ghost',\r\n    chosenClass: 'sortable-chosen',\r\n    onEnd: errorCatched(async evt => {\r\n      const { oldIndex, newIndex } = evt;\r\n      if (oldIndex === newIndex) return;\r\n      const orderedIds = Array.from(listEl.querySelectorAll('.rlh-item-container'))\r\n        .map(node => node.getAttribute('data-id'))\r\n        .filter(Boolean);\r\n      if (!reorderLoreEntriesInState(bookName, orderedIds)) return;\r\n      await saveAllChanges();\r\n    }, 'RegexLoreHub.Sortable'),\r\n  });\r\n};\r\n", "import {\n  appState,\n  safeGetLorebookEntries,\n  escapeHtml,\n  get$,\n  getParentDoc,\n  getParentWin,\n  CHARACTER_BOOK_SWITCH_ID,\n} from '../../core.js';\nimport { loadLorebookEntriesIfNeeded } from '../../dataLayer.js';\nimport { renderContent } from './index.js';\nimport {\n  createItemElement,\n  createGlobalLorebookElement,\n  getActiveSortMode,\n  getActiveCollapseState,\n  matchEntry,\n  initializeLoreEntrySortable,\n} from './shared.js';\n\r\nconst GLOBAL_LIST_CHUNK_SIZE = 6;\r\nlet globalListRenderHandle = null;\r\nlet globalListProgressEl = null;\r\n\r\nconst cancelPendingGlobalListRender = () => {\r\n  if (!globalListRenderHandle && !globalListProgressEl) return;\r\n  const parentWin = getParentWin();\r\n  if (globalListRenderHandle) {\r\n    const { type, id } = globalListRenderHandle;\r\n    if (type === 'idle' && parentWin?.cancelIdleCallback) {\r\n      parentWin.cancelIdleCallback(id);\r\n    } else if (type === 'raf' && parentWin?.cancelAnimationFrame) {\r\n      parentWin.cancelAnimationFrame(id);\r\n    } else if (type === 'timeout') {\r\n      const clearFn = parentWin?.clearTimeout ?? (typeof clearTimeout === 'function' ? clearTimeout : null);\r\n      if (clearFn) clearFn(id);\r\n    }\r\n    globalListRenderHandle = null;\r\n  }\r\n  if (globalListProgressEl) {\r\n    globalListProgressEl.remove();\r\n    globalListProgressEl = null;\r\n  }\r\n};\r\n\r\nconst sortLoreEntries = (entries, sortMode) => {\n  const list = Array.isArray(entries) ? [...entries] : [];\n  if (sortMode === 'status') {\n    return list.sort((a, b) => {\n      const diff = Number(b.enabled) - Number(a.enabled);\n      if (diff !== 0) return diff;\n      return (a.name || '').localeCompare(b.name || '', 'zh');\n    });\n  }\n  return list.sort((a, b) => (a.name || '\u65E0\u6807\u9898\u6761\u76EE').localeCompare(b.name || '\u65E0\u6807\u9898\u6761\u76EE', 'zh'));\n};\n\r\nexport const getGlobalLorebookMatches = (searchTerm, caseSensitive = false) => {\n  const matches = [];\r\n  const booksMatchedByNameOnly = [];\r\n  const stats = { bookName: 0, entryName: 0, keywords: 0, content: 0 };\r\n  if (!searchTerm) return { matches, stats, booksMatchedByNameOnly };\r\n\r\n  const books = appState.allLorebooks;\r\n  const flags = caseSensitive ? '' : 'i';\r\n  const searchRegex = new RegExp(searchTerm.replace(/[.*+?^${}()|[\\/\\\\]/g, '\\\\$&'), flags);\r\n\r\n  const matchedBooksForName = new Set();\r\n  const matchedEntriesForName = new Set();\r\n  const matchedEntriesForKeywords = new Set();\r\n  const matchedEntriesForContent = new Set();\r\n  const addedEntries = new Set();\r\n\r\n  for (const book of books) {\r\n    const entries = safeGetLorebookEntries(book.name);\r\n    const isBookNameMatch = searchRegex.test(book.name);\r\n    let bookHasEntryMatches = false;\r\n\r\n    if (isBookNameMatch) {\r\n      matchedBooksForName.add(book.name);\r\n    }\r\n\r\n    for (const entry of entries) {\r\n      const currentMatch = {\r\n        bookName: false,\r\n        entryName: false,\r\n        keywords: 0,\r\n        content: false,\r\n      };\r\n      let entryHasMatch = false;\r\n\r\n      if (searchRegex.test(entry.name || '')) {\r\n        matchedEntriesForName.add(entry.uid);\r\n        currentMatch.entryName = true;\r\n        entryHasMatch = true;\r\n      }\r\n\r\n      if (Array.isArray(entry.keys)) {\r\n        const matchedKeywordsCount = entry.keys.filter(k => searchRegex.test(k)).length;\r\n        if (matchedKeywordsCount > 0) {\r\n          currentMatch.keywords = matchedKeywordsCount;\r\n          matchedEntriesForKeywords.add(entry.uid);\r\n          entryHasMatch = true;\r\n        }\r\n      }\r\n\r\n      if (searchRegex.test(entry.content || '')) {\r\n        matchedEntriesForContent.add(entry.uid);\r\n        currentMatch.content = true;\r\n        entryHasMatch = true;\r\n      }\r\n\r\n      if (entryHasMatch) {\r\n        bookHasEntryMatches = true;\r\n        if (!addedEntries.has(entry.uid)) {\r\n          matches.push({ bookName: book.name, entry, matchedFields: currentMatch });\r\n          addedEntries.add(entry.uid);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (isBookNameMatch && !bookHasEntryMatches) {\r\n      booksMatchedByNameOnly.push(book.name);\r\n    }\r\n  }\r\n\r\n  stats.bookName = matchedBooksForName.size;\r\n  stats.entryName = matchedEntriesForName.size;\r\n  stats.keywords = matchedEntriesForKeywords.size;\r\n  stats.content = matchedEntriesForContent.size;\r\n\r\n  return { matches, stats, booksMatchedByNameOnly };\r\n};\r\n\r\nexport const renderGlobalLoreTabView = (context, searchTerm, $container) => {\r\n  if (context.view === 'global-lore-detail') {\r\n    renderGlobalLoreDetailView(context, searchTerm, $container);\r\n  } else {\r\n    renderGlobalLoreListView(context, searchTerm, $container);\r\n  }\r\n};\r\n\r\nconst renderGlobalLoreListView = (context, searchTerm, $container) => {\r\n  cancelPendingGlobalListRender();\r\n\r\n  const $ = get$();\r\n  const parentDoc = getParentDoc();\r\n  const parentWin = getParentWin();\r\n\r\n  const normalizedTerm = typeof searchTerm === 'string' ? searchTerm : '';\n  const sortMode = getActiveSortMode(context);\n  const books = [...appState.allLorebooks];\n\n  if (sortMode === 'status') {\n    books.sort((a, b) => {\n      const diff = Number(b.enabled) - Number(a.enabled);\n      if (diff !== 0) return diff;\n      return a.name.localeCompare(b.name, 'zh');\n    });\n  } else {\n    books.sort((a, b) => a.name.localeCompare(b.name, 'zh'));\n  }\n\r\n  if (!books.length) {\r\n    const emptyHtml = `\r\n      <div class=\"rlh-empty-state\">\r\n        <div class=\"rlh-empty-icon\"><i class=\"fa-solid fa-book-bookmark\"></i></div>\r\n        <h4>\u6CA1\u6709\u4E16\u754C\u4E66</h4>\r\n        <p>\u70B9\u51FB\u53F3\u4E0A\u89D2\u7684\u201C<i class=\"fa-solid fa-plus\"></i>\u201D\u6309\u94AE\u6765\u521B\u5EFA\u4F60\u7684\u7B2C\u4E00\u4E2A\u4E16\u754C\u4E66\u5427\uFF01</p>\r\n      </div>\r\n    `;\r\n    $container.html(emptyHtml);\r\n    return;\r\n  }\r\n\r\n  const filteredBooks = normalizedTerm\r\n    ? books.filter(book => {\r\n        const bookNameMatches = appState.searchFilters.bookName && book.name.toLowerCase().includes(normalizedTerm);\r\n        if (bookNameMatches) return true;\r\n\r\n        const entries = safeGetLorebookEntries(book.name);\r\n        return entries.some(entry => matchEntry(entry, normalizedTerm));\r\n      })\r\n    : books;\r\n\r\n  if (!filteredBooks.length) {\r\n    $container.html('<p class=\"rlh-info-text\">\u672A\u627E\u5230\u5339\u914D\u7684\u4E16\u754C\u4E66\u3002</p>');\r\n    return;\r\n  }\r\n\r\n  $container.empty();\r\n\r\n  const total = filteredBooks.length;\r\n  const chunkSize =\n    total <= GLOBAL_LIST_CHUNK_SIZE\n      ? total\n      : Math.min(GLOBAL_LIST_CHUNK_SIZE, Math.max(3, Math.ceil(total / 5)));\n  let currentIndex = 0;\r\n\r\n  globalListProgressEl =\r\n    total > chunkSize\r\n      ? $('<p class=\"rlh-info-text-small\" aria-live=\"polite\"></p>')\r\n      : null;\r\n\r\n  const updateProgress = () => {\r\n    if (!globalListProgressEl) return;\r\n    const completed = Math.min(currentIndex, total);\r\n    globalListProgressEl\r\n      .text(`\u6B63\u5728\u52A0\u8F7D\u4E16\u754C\u4E66\u5217\u8868 (${completed}/${total})\uFF0C\u8BF7\u7A0D\u5019...`)\r\n      .appendTo($container);\r\n  };\r\n\r\n  const appendNodes = nodes => {\r\n    if (!nodes.length) return;\r\n    const fragment =\r\n      parentDoc && typeof parentDoc.createDocumentFragment === 'function'\r\n        ? parentDoc.createDocumentFragment()\r\n        : null;\r\n    if (fragment) {\r\n      nodes.forEach(node => fragment.appendChild(node));\r\n      $container.append(fragment);\r\n    } else {\r\n      nodes.forEach(node => $container.append(node));\r\n    }\r\n  };\r\n\r\n  const renderChunk = () => {\r\n    const end = Math.min(currentIndex + chunkSize, total);\r\n    const nodes = [];\r\n    for (let i = currentIndex; i < end; i++) {\r\n      const element = createGlobalLorebookElement(filteredBooks[i], searchTerm, true, null);\r\n      const domNode = element.get(0);\r\n      if (domNode) nodes.push(domNode);\r\n    }\r\n    appendNodes(nodes);\r\n    currentIndex = end;\r\n    updateProgress();\r\n\r\n    if (currentIndex >= total && globalListProgressEl) {\r\n      const progressRef = globalListProgressEl;\r\n      const clearFn = parentWin?.setTimeout ?? setTimeout;\r\n      clearFn(() => {\r\n        if (globalListProgressEl === progressRef) {\r\n          progressRef.remove();\r\n          globalListProgressEl = null;\r\n        }\r\n      }, 320);\r\n    }\r\n  };\r\n\r\n  const scheduleNextChunk = () => {\r\n    const callback = () => {\r\n      globalListRenderHandle = null;\r\n      renderChunk();\r\n      if (currentIndex < total) {\r\n        scheduleNextChunk();\r\n      }\r\n    };\r\n\r\n    if (parentWin?.requestIdleCallback) {\r\n      const id = parentWin.requestIdleCallback(callback, { timeout: 120 });\r\n      globalListRenderHandle = { type: 'idle', id };\r\n    } else if (parentWin?.requestAnimationFrame) {\r\n      const id = parentWin.requestAnimationFrame(callback);\r\n      globalListRenderHandle = { type: 'raf', id };\r\n    } else {\r\n      const scheduleFn = parentWin?.setTimeout ?? setTimeout;\r\n      const id = scheduleFn(callback, 16);\r\n      globalListRenderHandle = { type: 'timeout', id };\r\n    }\r\n  };\r\n\r\n  renderChunk();\r\n\r\n  if (currentIndex < total) {\r\n    scheduleNextChunk();\r\n  } else if (globalListProgressEl) {\r\n    globalListProgressEl.remove();\r\n    globalListProgressEl = null;\r\n  }\r\n};\r\n\r\nconst renderGlobalLoreDetailView = (context, searchTerm, $container) => {\r\n  cancelPendingGlobalListRender();\r\n\r\n  const $ = get$();\r\n  const bookName = context?.activeBookName ?? appState.activeBookName;\r\n  const book = appState.allLorebooks.find(b => b.name === bookName);\r\n  if (!book) {\r\n    $container.html(`<p class=\"rlh-info-text\">\u9519\u8BEF\uFF1A\u672A\u627E\u5230\u540D\u4E3A \"${escapeHtml(bookName)}\" \u7684\u4E16\u754C\u4E66\u3002</p>`);\r\n    return;\r\n  }\r\n\r\n  if (appState.loadingBookName === bookName) {\r\n    const loadingHtml = `\r\n        <div class=\"rlh-detail-view\" data-book-name=\"${escapeHtml(bookName)}\">\r\n          <header class=\"rlh-detail-header\">\r\n            <button class=\"rlh-action-btn-icon rlh-back-to-list-btn\" title=\"\u8FD4\u56DE\u4E16\u754C\u4E66\u5217\u8868\"><i class=\"fa-solid fa-arrow-left\"></i></button>\r\n            <h2>${escapeHtml(bookName)}</h2>\r\n            <div class=\"rlh-item-controls\">\r\n              <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\u91CD\u547D\u540D\u4E16\u754C\u4E66\">\u91CD\u547D\u540D</button>\r\n              <button class=\"rlh-toolbar-btn rlh-delete-book-btn\" title=\"\u5220\u9664\u4E16\u754C\u4E66\">\u5220\u9664</button>\r\n            </div>\r\n          </header>\r\n          <div class=\"rlh-detail-content\">\r\n            <p class=\"rlh-info-text\">\u52A0\u8F7D\u4E2D...</p>\r\n          </div>\r\n        </div>\r\n      `;\r\n    $container.html(loadingHtml);\r\n    return;\r\n  }\r\n\r\n  $container.append(`<div class=\"rlh-info-text-small\">\u5F53\u524D\u4E16\u754C\u4E66\uFF1A${escapeHtml(bookName)}</div>`);\r\n\r\n  const sortMode = getActiveSortMode(context);\r\n  const collapseState = getActiveCollapseState(context);\r\n  const entries = sortLoreEntries(safeGetLorebookEntries(bookName), sortMode);\r\n  const detailHtml = `\r\n        <div class=\"rlh-detail-view\" data-book-name=\"${escapeHtml(bookName)}\">\r\n          <header class=\"rlh-detail-header\">\r\n            <button class=\"rlh-action-btn-icon rlh-back-to-list-btn\" title=\"\u8FD4\u56DE\u4E16\u754C\u4E66\u5217\u8868\"><i class=\"fa-solid fa-arrow-left\"></i></button>\r\n            <h2>${escapeHtml(bookName)}</h2>\r\n            <div class=\"rlh-item-controls\">\r\n              <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\u91CD\u547D\u540D\u4E16\u754C\u4E66\">\u91CD\u547D\u540D</button>\r\n              <button class=\"rlh-toolbar-btn rlh-delete-book-btn\" title=\"\u5220\u9664\u4E16\u754C\u4E66\">\u5220\u9664</button>\r\n            </div>\r\n          </header>\r\n          <div class=\"rlh-detail-content\">\r\n          </div>\r\n        </div>\r\n      `;\r\n  $container.html(detailHtml);\r\n\r\n  const visibleEntries = searchTerm\r\n    ? entries.filter(entry => matchEntry(entry, searchTerm))\r\n    : entries;\r\n\r\n  const $content = $container.find('.rlh-detail-content');\r\n\r\n  if (!visibleEntries.length) {\r\n    const message = entries.length\r\n      ? '\u65E0\u5339\u914D\u6761\u76EE'\r\n      : '\u8FD9\u672C\u4E66\u8FD8\u6CA1\u6709\u6761\u76EE\uFF0C\u70B9\u51FB\u5DE5\u5177\u680F\u7684\u201C\u65B0\u5EFA\u6761\u76EE\u201D\u6309\u94AE\uFF0C\u4E3A\u5B83\u6DFB\u52A0\u5185\u5BB9\u3002';\r\n    $content.html(`<p class=\"rlh-info-text\">${message}</p>`);\r\n    return;\r\n  }\r\n\r\n  const entriesHtml = `\r\n    <p class=\"rlh-info-text-small\">\u5171 ${entries.length} \u4E2A\u6761\u76EE</p>\r\n    <div class=\"rlh-entry-list-wrapper\">\r\n      ${visibleEntries\r\n        .map(entry => createItemElement(entry, 'lore', bookName, searchTerm, { collapseState, enableDrag: false }).prop('outerHTML'))\r\n        .join('')}\r\n    </div>\r\n  `;\r\n  $content.html(entriesHtml);\r\n};\r\n\r\nexport const getCharacterLorebookMatches = searchTerm => {\r\n  let matches = [];\r\n  const linkedBooks = appState.lorebooks.character;\r\n  const parentWin = getParentWin();\r\n  const context = parentWin.SillyTavern?.getContext?.() || {};\r\n  const hasActiveCharacter = context.characterId !== undefined && context.characterId !== null;\r\n\r\n  if (!hasActiveCharacter || linkedBooks.length === 0) {\r\n    return matches;\r\n  }\r\n\r\n  let activeBookName = appState.activeCharacterBook;\r\n  if (!activeBookName || !linkedBooks.includes(activeBookName)) {\r\n    activeBookName = linkedBooks[0];\r\n    appState.activeCharacterBook = activeBookName;\r\n  }\r\n\r\n  if (!activeBookName) {\r\n    return matches;\r\n  }\r\n\r\n  const targetBooks = [activeBookName];\r\n  const normalizedSearch = typeof searchTerm === 'string' ? searchTerm.toLowerCase() : '';\r\n  const hasSearch = Boolean(normalizedSearch);\r\n\r\n  targetBooks.forEach(bookName => {\r\n    const entries = [...safeGetLorebookEntries(bookName)].sort(\r\n      (a, b) => ((a.display_index ?? Number.MAX_SAFE_INTEGER) - (b.display_index ?? Number.MAX_SAFE_INTEGER)),\r\n    );\r\n\r\n    if (!hasSearch) {\r\n      entries.forEach(entry => {\r\n        matches.push({ bookName, entry });\r\n      });\r\n    } else {\r\n      entries.forEach(entry => {\r\n        const nameMatches = (entry.name || '').toLowerCase().includes(normalizedSearch);\r\n        const keywordsMatches = Array.isArray(entry.keys)\r\n          ? entry.keys.join(' ').toLowerCase().includes(normalizedSearch)\r\n          : false;\r\n        const contentMatches = entry.content && entry.content.toLowerCase().includes(normalizedSearch);\r\n        const bookMatches =\r\n          appState.searchFilters.bookName && bookName.toLowerCase().includes(normalizedSearch);\r\n        const entryMatches =\r\n          (appState.searchFilters.entryName && nameMatches) ||\r\n          (appState.searchFilters.keywords && keywordsMatches) ||\r\n          (appState.searchFilters.content && contentMatches);\r\n\r\n        if (bookMatches || entryMatches) {\r\n          matches.push({ bookName, entry });\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  return matches;\r\n};\r\n\r\nexport const renderCharacterLorebookView = (context, searchTerm, $container) => {\r\n  const $ = get$();\r\n  const linkedBooks = appState.lorebooks.character;\r\n  const characterName = appState.characterContext.name ?? '';\r\n  const hasActiveCharacter = appState.characterContext.id !== null;\r\n\r\n  if (!hasActiveCharacter) {\r\n    $container.html('<p class=\"rlh-info-text\">\u8BF7\u5148\u52A0\u8F7D\u4E00\u4E2A\u89D2\u8272\u4EE5\u7BA1\u7406\u89D2\u8272\u4E16\u754C\u4E66\u3002</p>');\r\n    return;\r\n  }\r\n\r\n  if (linkedBooks.length === 0) {\r\n    $container.html('<p class=\"rlh-info-text\">\u5F53\u524D\u89D2\u8272\u6CA1\u6709\u7ED1\u5B9A\u7684\u4E16\u754C\u4E66\u3002\u70B9\u51FB\u540C\u6B65\u6309\u94AE\u5237\u65B0\u3002</p>');\r\n    return;\r\n  }\r\n\r\n  let activeBookName = appState.activeCharacterBook;\r\n  if (!activeBookName || !linkedBooks.includes(activeBookName)) {\r\n    activeBookName = linkedBooks[0];\r\n    appState.activeCharacterBook = activeBookName;\r\n  }\r\n\r\n  const sortMode = getActiveSortMode(context);\r\n  const collapseState = getActiveCollapseState(context);\r\n\r\n  if (linkedBooks.length > 1) {\r\n    const optionsHtml = linkedBooks\r\n      .map(name => `<option value=\"${escapeHtml(name)}\"${name === activeBookName ? ' selected' : ''}>${escapeHtml(name)}</option>`)\r\n      .join('');\r\n    $container.append(`<div class=\"rlh-book-switcher\"><label>\u5F53\u524D\u89D2\u8272\u540D\uFF1A${escapeHtml(characterName)}<select id=\"${CHARACTER_BOOK_SWITCH_ID}\" class=\"rlh-input\">${optionsHtml}</select></label></div>`);\r\n  } else {\r\n    $container.append(`<div class=\"rlh-info-text-small\">\u5F53\u524D\u89D2\u8272\u540D\uFF1A${escapeHtml(characterName)}</div>`);\r\n  }\r\n\r\n  const renderBook = bookName => {\r\n    const $bookContainer = $(\r\n      `<div class=\"rlh-book-group\" data-book-name=\"${escapeHtml(bookName)}\">\r\n        <div class=\"rlh-book-group-header\">\r\n          <h2 class=\"rlh-book-group-title\">${escapeHtml(bookName)}</h2>\r\n          <div class=\"rlh-item-controls\">\r\n            <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\u91CD\u547D\u540D\u4E16\u754C\u4E66\">\u91CD\u547D\u540D</button>\r\n            <button class=\"rlh-toolbar-btn rlh-delete-book-btn\" title=\"\u5220\u9664\u4E16\u754C\u4E66\">\u5220\u9664</button>\r\n          </div>\r\n        </div>\r\n        <div class=\"rlh-entry-list-wrapper\"></div>\r\n      </div>`\r\n    );\r\n\r\n    const $listWrapper = $bookContainer.find('.rlh-entry-list-wrapper');\r\n    const bookMeta = appState.allLorebooks.find(b => b.name === bookName);\r\n    if (bookMeta && !bookMeta.entriesLoaded) {\r\n      if (!bookMeta.loadingEntries) {\r\n        bookMeta.loadingEntries = true;\r\n        loadLorebookEntriesIfNeeded(bookName)\r\n          .finally(() => {\r\n            bookMeta.loadingEntries = false;\r\n            renderContent();\r\n          });\r\n      }\r\n      $listWrapper.append('<p class=\"rlh-info-text\">\u52A0\u8F7D\u4E2D...</p>');\r\n      return $bookContainer;\r\n    }\r\n\r\n    const baseEntries = [...safeGetLorebookEntries(bookName)].sort(\r\n      (a, b) => ((a.display_index ?? Number.MAX_SAFE_INTEGER) - (b.display_index ?? Number.MAX_SAFE_INTEGER)),\r\n    );\r\n    const entries = sortLoreEntries(baseEntries, sortMode);\r\n\r\n    const bookNameMatches =\r\n      !searchTerm ||\r\n      (appState.searchFilters.bookName && bookName.toLowerCase().includes(searchTerm));\r\n\r\n    const matchingEntries = searchTerm\r\n      ? entries.filter(entry => matchEntry(entry, searchTerm))\r\n      : entries;\r\n\r\n    const entriesToShow = bookNameMatches && !searchTerm ? entries : matchingEntries;\n    const canReorder = false;\n\r\n    if (!entriesToShow.length) {\r\n      if (searchTerm) {\r\n        $listWrapper.append('<p class=\"rlh-info-text-small\">\u65E0\u5339\u914D\u6761\u76EE</p>');\r\n      } else {\r\n        $listWrapper.append('<p class=\"rlh-info-text-small\">\u8FD9\u672C\u4E16\u754C\u4E66\u6682\u65F6\u6CA1\u6709\u6761\u76EE\u3002</p>');\r\n      }\r\n    } else {\r\n      entriesToShow.forEach(entry => {\r\n        $listWrapper.append(\r\n          createItemElement(entry, 'lore', bookName, searchTerm, { collapseState, enableDrag: canReorder }),\r\n        );\r\n      });\r\n    }\r\n\r\n    initializeLoreEntrySortable($listWrapper, bookName, { enabled: canReorder });\r\n\r\n    return $bookContainer;\r\n  };\r\n\r\n  const $bookElement = renderBook(activeBookName);\r\n  if ($bookElement) {\r\n    $bookElement.attr('data-active', 'true');\r\n    $container.append($bookElement);\r\n  } else if (searchTerm) {\r\n    $container.append('<p class=\"rlh-info-text\">\u672A\u627E\u5230\u5339\u914D\u7684\u6761\u76EE\u3002</p>');\r\n  } else {\r\n    $container.append('<p class=\"rlh-info-text\">\u672A\u80FD\u52A0\u8F7D\u5F53\u524D\u4E16\u754C\u4E66\uFF0C\u8BF7\u5C1D\u8BD5\u5237\u65B0\u6570\u636E\u3002</p>');\r\n  }\r\n};\r\n\r\nexport const getChatLorebookMatches = searchTerm => {\r\n  let matches = [];\r\n  const bookName = appState.chatLorebook;\r\n  const parentWin = getParentWin();\r\n  const context = parentWin.SillyTavern?.getContext?.() || {};\r\n  const hasActiveChat = context.chatId !== undefined && context.chatId !== null;\r\n\r\n  if (!hasActiveChat || !bookName) {\r\n    return matches;\r\n  }\r\n\r\n  const entries = [...safeGetLorebookEntries(bookName)].sort(\r\n    (a, b) => ((a.display_index ?? Number.MAX_SAFE_INTEGER) - (b.display_index ?? Number.MAX_SAFE_INTEGER)),\r\n  );\r\n\r\n  if (!searchTerm) {\r\n    entries.forEach(entry => {\r\n      matches.push({ bookName, entry });\r\n    });\r\n  } else {\r\n    entries.forEach(entry => {\r\n      let entryNameMatches =\r\n        appState.searchFilters.entryName && (entry.name || '').toLowerCase().includes(searchTerm.toLowerCase());\r\n      let keywordsMatch =\r\n        appState.searchFilters.keywords && entry.keys.join(' ').toLowerCase().includes(searchTerm.toLowerCase());\r\n      let contentMatch =\r\n        appState.searchFilters.content &&\r\n        entry.content &&\r\n        entry.content.toLowerCase().includes(searchTerm.toLowerCase());\r\n\r\n      if (entryNameMatches || keywordsMatch || contentMatch) {\r\n        matches.push({ bookName, entry });\r\n      }\r\n    });\r\n  }\r\n\r\n  return matches;\r\n};\r\n\r\nexport const renderChatLorebookView = (context, searchTerm, $container) => {\r\n  const $ = get$();\r\n  const bookName = appState.chatLorebook;\r\n  const parentWin = getParentWin();\r\n  const characterName = appState.characterContext.name ?? '';\r\n  const hasActiveChat = parentWin.SillyTavern?.getContext?.()?.chatId !== null;\r\n\r\n  if (!hasActiveChat) {\r\n    $container.html('<p class=\"rlh-info-text\">\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A\u804A\u5929\u4EE5\u7BA1\u7406\u804A\u5929\u4E16\u754C\u4E66\u3002</p>');\r\n    return;\r\n  }\r\n\r\n  if (!bookName) {\r\n    $container.html(`\r\n      <div class=\"rlh-chat-lore-empty\">\r\n        <p class=\"rlh-info-text\">\u5F53\u524D\u804A\u5929\u6CA1\u6709\u7ED1\u5B9A\u7684\u4E16\u754C\u4E66\u3002</p>\r\n        <button class=\"rlh-action-btn\" id=\"rlh-create-chat-lore-btn\"><i class=\"fa-solid fa-plus\"></i> \u521B\u5EFA\u5E76\u7ED1\u5B9A\u804A\u5929\u4E16\u754C\u4E66</button>\r\n      </div>\r\n    `);\r\n    return;\r\n  }\r\n\r\n  $container.append(`<div class=\"rlh-info-text-small\">\u5F53\u524D\u804A\u5929\u89D2\u8272\u540D\uFF1A${escapeHtml(characterName)}</div>`);\r\n\r\n  const sortMode = getActiveSortMode(context);\r\n  const collapseState = getActiveCollapseState(context);\r\n\r\n  const $bookContainer = $(\r\n    `<div class=\"rlh-book-group\" data-book-name=\"${escapeHtml(bookName)}\">\r\n      <div class=\"rlh-book-group-header\">\r\n        <h2 class=\"rlh-book-group-title\">${escapeHtml(bookName)} (\u804A\u5929\u4E13\u7528)</h2>\r\n        <div class=\"rlh-item-controls\">\r\n          <button class=\"rlh-toolbar-btn rlh-rename-book-btn\" title=\"\u91CD\u547D\u540D\u4E16\u754C\u4E66\">\u91CD\u547D\u540D</button>\r\n          <button class=\"rlh-toolbar-btn rlh-unlink-chat-lore-btn\" title=\"\u89E3\u9664\u7ED1\u5B9A\">\u89E3\u9664\u7ED1\u5B9A</button>\r\n        </div>\r\n      </div>\r\n      <div class=\"rlh-entry-list-wrapper\"></div>\r\n    </div>`\r\n  );\r\n  const $listWrapper = $bookContainer.find('.rlh-entry-list-wrapper');\r\n  const bookMeta = appState.allLorebooks.find(b => b.name === bookName);\r\n  if (bookMeta && !bookMeta.entriesLoaded) {\r\n    if (!bookMeta.loadingEntries) {\r\n      bookMeta.loadingEntries = true;\r\n      loadLorebookEntriesIfNeeded(bookName)\r\n        .finally(() => {\r\n          bookMeta.loadingEntries = false;\r\n          renderContent();\r\n        });\r\n    }\r\n    $listWrapper.append('<p class=\"rlh-info-text\">\u52A0\u8F7D\u4E2D...</p>');\r\n    $container.append($bookContainer);\r\n    return;\r\n  }\r\n\r\n  const baseEntries = [...safeGetLorebookEntries(bookName)].sort(\r\n    (a, b) => ((a.display_index ?? Number.MAX_SAFE_INTEGER) - (b.display_index ?? Number.MAX_SAFE_INTEGER)),\r\n  );\r\n  const entries = sortLoreEntries(baseEntries, sortMode);\r\n\r\n  const matchingEntries = searchTerm\r\n    ? entries.filter(entry => matchEntry(entry, searchTerm))\r\n    : entries;\r\n  const canReorder = false;\n\r\n  if (!matchingEntries.length) {\r\n    const message = entries.length ? '\u65E0\u5339\u914D\u6761\u76EE' : '\u8FD9\u672C\u4E66\u8FD8\u6CA1\u6709\u6761\u76EE\u3002';\r\n    $listWrapper.append(`<p class=\"rlh-info-text-small\">${message}</p>`);\r\n  } else {\r\n    matchingEntries.forEach(entry => {\r\n      $listWrapper.append(\r\n        createItemElement(entry, 'lore', bookName, searchTerm, { collapseState, enableDrag: canReorder }),\r\n      );\r\n    });\r\n  }\r\n\r\n  initializeLoreEntrySortable($listWrapper, bookName, { enabled: canReorder });\r\n\r\n  $container.append($bookContainer);\r\n};\r\nexport const cancelGlobalLoreListRender = () => cancelPendingGlobalListRender();\r\n", "import {\n  appState,\n  errorCatched,\n  get$,\n  getParentWin,\n} from '../../core.js';\nimport { saveAllChanges, updateRegexOrderMetadata } from '../../dataLayer.js';\nimport { createItemElement, getActiveSortMode, getActiveCollapseState, matchRegex } from './shared.js';\n\nconst sortRegexEntries = (entries, sortMode) => {\n  const list = Array.isArray(entries) ? [...entries] : [];\n  if (sortMode === 'status') {\n    return list.sort((a, b) => {\n      const diff = Number(b.enabled) - Number(a.enabled);\n      if (diff !== 0) return diff;\n      return (a.script_name || '').localeCompare(b.script_name || '', 'zh');\n    });\n  }\n  if (sortMode === 'name') {\n    return list.sort((a, b) => (a.script_name || '').localeCompare(b.script_name || '', 'zh'));\n  }\n  return list;\n};\n\nexport const getRegexMatches = (searchTerm, caseSensitive = false) => {\n  const matches = [];\n  const stats = { name: 0, content: 0 };\n  if (!searchTerm) return { matches, stats };\n\n  const scripts = [...appState.regexes.global, ...appState.regexes.character];\n  const flags = caseSensitive ? '' : 'i';\n  const searchRegex = new RegExp(searchTerm.replace(/[.*+?^${}()|[\\/\\\\]/g, '\\\\$&'), flags);\n\n  const matchedScriptsForName = new Set();\n  const matchedScriptsForContent = new Set();\n  const addedScripts = new Set();\n\n  for (const script of scripts) {\n    let hasMatch = false;\n    if (searchRegex.test(script.script_name || '')) {\n      matchedScriptsForName.add(script.script_name);\n      hasMatch = true;\n    }\n\n    const contentToSearch = `${script.find_regex || ''} ${script.replace_string || ''}`;\n    if (searchRegex.test(contentToSearch)) {\n      matchedScriptsForContent.add(script.script_name);\n      hasMatch = true;\n    }\n\n    if (hasMatch && !addedScripts.has(script.id)) {\n      matches.push(script);\n      addedScripts.add(script.id);\n    }\n  }\n\n  stats.name = matchedScriptsForName.size;\n  stats.content = matchedScriptsForContent.size;\n\n  return { matches, stats };\n};\n\nexport const renderRegexView = (context, itemList, searchTerm, $container, title) => {\n  const $ = get$();\n  const parentWin = getParentWin();\n  const sortMode = getActiveSortMode(context);\n  const collapseState = getActiveCollapseState(context);\n  const items = sortRegexEntries(itemList ?? [], sortMode);\n  const label = title ?? (context.id === 'char-regex' ? '\u89D2\u8272\u6B63\u5219' : '\u5168\u5C40\u6B63\u5219');\n\n  if (context.id === 'char-regex') {\n    const hostContext = parentWin.SillyTavern?.getContext?.() || {};\n    const hasActiveCharacter = hostContext.characterId !== undefined && hostContext.characterId !== null;\n    if (!hasActiveCharacter) {\n      $container.html('<p class=\"rlh-info-text\">\u8BF7\u5148\u52A0\u8F7D\u4E00\u4E2A\u89D2\u8272\u4EE5\u7BA1\u7406\u89D2\u8272\u6B63\u5219\u3002</p>');\n      return;\n    }\n  }\n\n  if (!items.length) {\n    $container.html(`<p class=\"rlh-info-text\">\u6CA1\u6709${label}\u3002\u70B9\u51FB\u540C\u6B65\u6309\u94AE\u5237\u65B0\u3002</p>`);\n    return;\n  }\n\n  const filteredItems = searchTerm ? items.filter(item => matchRegex(item, searchTerm)) : items;\n\n  if (!filteredItems.length) {\n    $container.html(`<p class=\"rlh-info-text\">\u6CA1\u6709\u5339\u914D\u7684${label}\u3002</p>`);\n    return;\n  }\n\n  const listId = `rlh-regex-list-${context.id}`;\n  const $listContainer = $(`<div id=\"${listId}\" class=\"rlh-regex-list\"></div>`);\n  $container.append($listContainer);\n\n  const canReorder = !searchTerm;\n\n  filteredItems.forEach((item, index) => {\n    const $element = createItemElement(item, 'regex', '', searchTerm, {\n      collapseState,\n      selectionKey: `regex:${item.id}`,\n      enableDrag: canReorder,\n    });\n    $element.find('.rlh-item-name').prepend(`<span class=\"rlh-order-indicator\">#${index + 1}</span> `);\n    $listContainer.append($element);\n  });\n\n  const listEl = $listContainer[0];\n  if (canReorder && listEl && parentWin.Sortable) {\n    const sortable = parentWin.Sortable.create(listEl, {\n      animation: 150,\n      handle: '.rlh-drag-handle',\n      forceFallback: true,\n      fallbackOnBody: true,\n      fallbackTolerance: 6,\n      delayOnTouchOnly: true,\n      touchStartThreshold: 8,\n      fallbackClass: 'rlh-sorting-fallback',\n      onStart: () => {\n        $listContainer.addClass('sorting-active');\n      },\n      onEnd: errorCatched(async evt => {\n        $listContainer.removeClass('sorting-active');\n        const { oldIndex, newIndex } = evt;\n        if (oldIndex === newIndex) return;\n\n        const scope = context.id === 'global-regex' ? 'global' : 'character';\n        const targetList = appState.regexes[scope];\n        if (!Array.isArray(targetList)) return;\n\n        const [moved] = targetList.splice(oldIndex, 1);\n        if (!moved) return;\n        targetList.splice(newIndex, 0, moved);\n        updateRegexOrderMetadata(targetList);\n\n        if (!(appState.pendingRegexUpdates instanceof Set)) {\n          appState.pendingRegexUpdates = new Set();\n        }\n        appState.pendingRegexUpdates.add(scope);\n\n        await saveAllChanges({ silent: true });\n        $container.empty();\n        renderRegexView(context, targetList, searchTerm, $container, title);\n      }, 'RegexLoreHub.RegexSortable'),\n    });\n  }\n};\n", "import {\r\n  PANEL_ID,\r\n  CORE_TOOLBAR_ID,\r\n  REPLACE_TOOL_CONTAINER_ID,\r\n  DEFAULT_FILTER_LABELS,\r\n  REGEX_FILTER_LABELS,\r\n  appState,\r\n  get$,\r\n  getParentDoc,\r\n} from '../../core.js';\r\nimport { renderGlobalLoreTabView, renderCharacterLorebookView, renderChatLorebookView, cancelGlobalLoreListRender } from './lorebook.js';\r\nimport { renderRegexView } from './regex.js';\r\nimport { renderToolbar, renderSaveStatus, updateSelectionCount } from './shared.js';\r\nexport * from './shared.js';\r\n\r\nconst normalizeSearchTerm = value => value?.toString().trim().toLowerCase() ?? '';\r\n\r\nexport const getViewContext = () => {\r\n  const tab = appState.activeTab;\r\n  const view = appState.activeView;\r\n\r\n  const base = {\r\n    tab,\r\n    view,\r\n    id: `${tab}`,\r\n    instanceKey: `${tab}`,\r\n    activeBookName: appState.activeBookName,\r\n    type: 'lore',\r\n    scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u89C6\u56FE',\r\n    replaceScopeLabel: '\u5728\u5F53\u524D\u89C6\u56FE\u4E2D\u66FF\u6362',\r\n    searchPlaceholder: '\u641C\u7D22...',\r\n    visibleFilters: ['entryName', 'keywords', 'content'],\r\n    filterLabels: DEFAULT_FILTER_LABELS,\r\n    defaultFilters: { entryName: true, keywords: true, content: true },\r\n    showReplace: true,\r\n    showRecursion: false,\r\n    showFixKeywords: false,\r\n    showCollapseToggle: false,\r\n    showPositionMenu: false,\r\n    sortOptions: [],\r\n    multiSelectTarget: 'entry',\r\n    supportsMultiSelect: true,\r\n    primaryAction: { visible: false },\r\n  };\r\n\r\n  if (tab === 'global-lore') {\r\n    if (view === 'global-lore-detail') {\r\n      const bookName = appState.activeBookName ?? '';\r\n      return {\r\n        ...base,\r\n        id: 'global-lore-detail',\r\n        instanceKey: bookName ? `global-lore-detail:${bookName}` : 'global-lore-detail',\r\n        activeBookName: bookName,\r\n        scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u4E16\u754C\u4E66',\r\n        replaceScopeLabel: '\u5728\u5F53\u524D\u4E16\u754C\u4E66\u4E2D\u66FF\u6362',\r\n        searchPlaceholder: '\u641C\u7D22...',\r\n        visibleFilters: ['bookName', 'entryName', 'keywords', 'content'],\r\n        defaultFilters: { bookName: false, entryName: true, keywords: true, content: true },\r\n        showRecursion: true,\r\n        showFixKeywords: true,\r\n        showCollapseToggle: true,\r\n        showPositionMenu: true,\r\n        sortOptions: ['status', 'name'],\r\n        multiSelectTarget: 'entry',\r\n        primaryAction: {\r\n          visible: true,\r\n          icon: 'fa-file-circle-plus',\r\n          label: '\u65B0\u5EFA\u6761\u76EE',\r\n          title: '\u65B0\u5EFA\u6761\u76EE',\r\n          scope: 'entry',\r\n        },\r\n      };\r\n    }\r\n\r\n    return {\r\n      ...base,\r\n      id: 'global-lore-list',\r\n      instanceKey: 'global-lore-list',\r\n      activeBookName: null,\r\n      scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u5168\u90E8\u4E16\u754C\u4E66',\r\n      replaceScopeLabel: '\u5728\u5339\u914D\u5230\u7684\u4E16\u754C\u4E66\u6216\u6761\u76EE\u4E2D\u66FF\u6362',\r\n      visibleFilters: ['bookName', 'entryName', 'keywords', 'content'],\r\n      defaultFilters: { bookName: true, entryName: true, keywords: true, content: true },\r\n      showReplace: true,\r\n      showRecursion: false,\r\n      showFixKeywords: false,\r\n      showCollapseToggle: false,\r\n      showPositionMenu: false,\r\n      showCleanOrphanBooks: true,\r\n      sortOptions: ['status', 'name'],\r\n      multiSelectTarget: 'book',\r\n      primaryAction: {\r\n        visible: true,\r\n        icon: 'fa-plus',\r\n        label: '\u65B0\u5EFA\u4E16\u754C\u4E66',\r\n        title: '\u65B0\u5EFA\u4E16\u754C\u4E66',\r\n        scope: 'book',\r\n      },\r\n    };\r\n  }\r\n\r\n  if (tab === 'char-lore') {\r\n    return {\r\n      ...base,\r\n      id: 'char-lore',\r\n      instanceKey: 'char-lore',\r\n      activeBookName: appState.activeCharacterBook,\r\n      scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u4E16\u754C\u4E66',\r\n      replaceScopeLabel: '\u5728\u5F53\u524D\u4E16\u754C\u4E66\u4E2D\u66FF\u6362',\r\n      visibleFilters: ['entryName', 'keywords', 'content'],\r\n      defaultFilters: { bookName: false, entryName: true, keywords: true, content: true },\r\n      showRecursion: true,\r\n      showFixKeywords: true,\r\n      showCollapseToggle: true,\r\n      showPositionMenu: true,\r\n      sortOptions: ['status', 'name'],\r\n      multiSelectTarget: 'entry',\r\n      primaryAction: {\r\n        visible: true,\r\n        icon: 'fa-file-circle-plus',\r\n        label: '\u65B0\u5EFA\u6761\u76EE',\r\n        title: '\u65B0\u5EFA\u6761\u76EE',\r\n        scope: 'entry',\r\n      },\r\n    };\r\n  }\r\n\r\n  if (tab === 'chat-lore') {\r\n    return {\r\n      ...base,\r\n      id: 'chat-lore',\r\n      instanceKey: 'chat-lore',\r\n      activeBookName: appState.chatLorebook,\r\n      scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u5F53\u524D\u4E16\u754C\u4E66',\r\n      replaceScopeLabel: '\u5728\u5F53\u524D\u4E16\u754C\u4E66\u4E2D\u66FF\u6362',\r\n      visibleFilters: ['entryName', 'keywords', 'content'],\r\n      defaultFilters: { bookName: false, entryName: true, keywords: true, content: true },\r\n      showRecursion: true,\r\n      showFixKeywords: true,\r\n      showCollapseToggle: true,\r\n      showPositionMenu: true,\r\n      sortOptions: ['status', 'name'],\r\n      multiSelectTarget: 'entry',\r\n      primaryAction: {\r\n        visible: true,\r\n        icon: 'fa-file-circle-plus',\r\n        label: '\u65B0\u5EFA\u6761\u76EE',\r\n        title: '\u65B0\u5EFA\u6761\u76EE',\r\n        scope: 'entry',\r\n      },\r\n    };\r\n  }\r\n\r\n  if (tab === 'global-regex') {\r\n    return {\r\n      ...base,\r\n      id: 'global-regex',\r\n      instanceKey: 'global-regex',\r\n      type: 'regex',\r\n      scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u5168\u5C40\u6B63\u5219\u8868\u8FBE\u5F0F',\r\n      replaceScopeLabel: '\u5728\u5168\u5C40\u6B63\u5219\u4E2D\u66FF\u6362',\r\n      visibleFilters: ['entryName', 'content'],\r\n      filterLabels: { ...DEFAULT_FILTER_LABELS, ...REGEX_FILTER_LABELS },\r\n      defaultFilters: { bookName: false, entryName: true, keywords: false, content: true },\r\n      showRecursion: false,\r\n      showFixKeywords: false,\r\n      showCollapseToggle: true,\r\n      showPositionMenu: false,\r\n      sortOptions: [],\r\n      multiSelectTarget: 'regex',\r\n      supportsMultiSelect: true,\r\n      primaryAction: { visible: false },\r\n    };\r\n  }\r\n\r\n  if (tab === 'char-regex') {\r\n    return {\r\n      ...base,\r\n      id: 'char-regex',\r\n      instanceKey: 'char-regex',\r\n      type: 'regex',\r\n      scopeLabel: '\u641C\u7D22\u8303\u56F4\uFF1A\u89D2\u8272\u6B63\u5219\u8868\u8FBE\u5F0F',\r\n      replaceScopeLabel: '\u5728\u89D2\u8272\u6B63\u5219\u4E2D\u66FF\u6362',\r\n      visibleFilters: ['entryName', 'content'],\r\n      filterLabels: { ...DEFAULT_FILTER_LABELS, ...REGEX_FILTER_LABELS },\r\n      defaultFilters: { bookName: false, entryName: true, keywords: false, content: true },\r\n      showRecursion: false,\r\n      showFixKeywords: false,\r\n      showCollapseToggle: true,\r\n      showPositionMenu: false,\r\n      sortOptions: [],\r\n      multiSelectTarget: 'regex',\r\n      supportsMultiSelect: false,\r\n      primaryAction: { visible: false },\r\n    };\r\n  }\r\n\r\n  return {\r\n    ...base,\r\n    id: 'unknown',\r\n    instanceKey: 'unknown',\r\n    supportsMultiSelect: false,\r\n  };\r\n};\r\n\r\nconst ensureSearchFiltersDefaults = context => {\r\n  const contextKey = context.id;\r\n  if (!contextKey) return;\r\n  if (!appState.searchFilterContextsInitialized.has(contextKey)) {\r\n    (context.visibleFilters ?? []).forEach(key => {\r\n      appState.searchFilters[key] = true;\r\n    });\r\n    appState.searchFilterContextsInitialized.add(contextKey);\r\n  }\r\n\r\n  if ((context.id === 'char-lore' || context.id === 'chat-lore') && appState.searchFilters.keywords === undefined) {\r\n    appState.searchFilters.keywords = true;\r\n  }\r\n};\r\n\r\nexport const renderContent = () => {\r\n  const $ = get$();\r\n  const parentDoc = getParentDoc();\r\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\r\n\r\n  const ensureLayoutNodes = () => {\r\n    if (!$panel.length) {\r\n      const emptySet = $([]);\r\n      return {\r\n        $toolbarRow: emptySet,\r\n        $toolbar: emptySet,\r\n        $replaceContainer: emptySet,\r\n        $content: emptySet,\r\n      };\r\n    }\r\n\r\n    let $toolbarRow = $panel.find('.rlh-toolbar-shell').first();\r\n    if (!$toolbarRow.length) {\r\n      const $tabNav = $panel.find('.rlh-tab-nav').first();\r\n      $toolbarRow = $('<div class=\"rlh-toolbar-shell\"></div>');\r\n      if ($tabNav.length) {\r\n        $toolbarRow.insertAfter($tabNav);\r\n      } else {\r\n        $panel.prepend($toolbarRow);\r\n      }\r\n    }\r\n\r\n    let $toolbar = $toolbarRow.find(`#${CORE_TOOLBAR_ID}`);\r\n    if (!$toolbar.length) {\r\n      $toolbar = $(`<div id=\"${CORE_TOOLBAR_ID}\" class=\"rlh-toolbar-container\"></div>`);\r\n      $toolbarRow.append($toolbar);\r\n    }\r\n\r\n    let $replaceContainer = $toolbarRow.find(`#${REPLACE_TOOL_CONTAINER_ID}`);\r\n    if (!$replaceContainer.length) {\r\n      $replaceContainer = $(`<div id=\"${REPLACE_TOOL_CONTAINER_ID}\" class=\"rlh-replace-container\"></div>`);\r\n      $toolbarRow.append($replaceContainer);\r\n    }\r\n\r\n    let $contentPane = $panel.find('.rlh-content-pane').first();\r\n    if (!$contentPane.length) {\r\n      $contentPane = $('<div class=\"rlh-content-pane\"></div>');\r\n      $contentPane.insertAfter($toolbarRow);\r\n    }\r\n\r\n    let $content = $contentPane.find(`#${PANEL_ID}-content`);\r\n    if (!$content.length) {\r\n      $content = $(`<div id=\"${PANEL_ID}-content\"></div>`);\r\n      $contentPane.append($content);\r\n    }\r\n\r\n    return { $toolbarRow, $toolbar, $replaceContainer, $content };\r\n  };\r\n\r\n  const searchTerm = normalizeSearchTerm(appState.globalSearch.term ?? '');\r\n\r\n  const filterSelectors = [\r\n    ['bookName', '#rlh-filter-book-name'],\r\n    ['entryName', '#rlh-filter-entry-name'],\r\n    ['keywords', '#rlh-filter-keywords'],\r\n    ['content', '#rlh-filter-content'],\r\n  ];\r\n  filterSelectors.forEach(([key, selector]) => {\r\n    const $checkbox = $panel.find(selector);\r\n    if ($checkbox.length) {\r\n      appState.searchFilters[key] = $checkbox.is(':checked');\r\n    }\r\n  });\r\n\r\n  const { $toolbar, $replaceContainer, $content } = ensureLayoutNodes();\r\n  $toolbar.empty();\r\n  $replaceContainer.empty();\r\n  $content.empty();\r\n\r\n  const viewContext = getViewContext();\r\n  ensureSearchFiltersDefaults(viewContext);\r\n\r\n  if (viewContext.tab !== 'global-lore') {\r\n    cancelGlobalLoreListRender();\r\n  }\r\n\r\n  if (!viewContext.supportsMultiSelect && appState.multiSelectMode) {\r\n    appState.multiSelectMode = false;\r\n    appState.selectedItems.clear();\r\n  }\r\n\r\n  if (appState.multiSelectMode) {\r\n    if (appState.multiSelectTarget !== viewContext.multiSelectTarget) {\r\n      appState.multiSelectTarget = viewContext.multiSelectTarget;\r\n      appState.selectedItems.clear();\r\n    }\r\n  } else {\r\n    appState.multiSelectTarget = viewContext.multiSelectTarget;\r\n  }\r\n\r\n  $panel.toggleClass('rlh-multi-select-mode', appState.multiSelectMode);\r\n\r\n  renderToolbar(viewContext, { $toolbar, $replaceContainer });\r\n  renderSaveStatus();\r\n  updateSelectionCount();\r\n\r\n  if (appState.isLoadingTabData) {\r\n    $content.html('<p class=\"rlh-info-text\">\u52A0\u8F7D\u4E2D...</p>');\r\n    return;\r\n  }\r\n\r\n  switch (viewContext.tab) {\r\n    case 'global-lore':\r\n      renderGlobalLoreTabView(viewContext, searchTerm, $content);\r\n      break;\r\n    case 'char-lore':\r\n      renderCharacterLorebookView(viewContext, searchTerm, $content);\r\n      break;\r\n    case 'chat-lore':\r\n      renderChatLorebookView(viewContext, searchTerm, $content);\r\n      break;\r\n    case 'global-regex':\r\n      renderRegexView(viewContext, appState.regexes.global, searchTerm, $content, '\u5168\u5C40\u6B63\u5219');\r\n      break;\r\n    case 'char-regex':\r\n      renderRegexView(viewContext, appState.regexes.character, searchTerm, $content, '\u89D2\u8272\u6B63\u5219');\r\n      break;\r\n    default:\r\n      $content.html('<p class=\"rlh-info-text\">\u5F53\u524D\u89C6\u56FE\u672A\u5B9E\u73B0\u3002</p>');\r\n      break;\r\n  }\r\n};\r\n", "import {\r\n  PANEL_ID,\r\n  REFRESH_BTN_ID,\r\n  PREFETCH_INDICATOR_ID,\r\n  PREFETCH_PROGRESS_BAR_ID,\r\n  PREFETCH_PROGRESS_TEXT_ID,\r\n  appState,\r\n  safeClearLorebookEntries,\r\n  safeSetLorebookEntries,\r\n  safeHasLorebookEntries,\r\n  safeGetLorebookEntries,\r\n  errorCatched,\r\n  get$,\r\n  getParentDoc,\r\n  getParentWin,\r\n  getTavernHelper,\r\n} from './core.js';\r\nimport { renderContent } from './ui/render/index.js';\r\nimport { renderSaveStatus } from './ui/render/shared.js';\r\n\r\nconst LOGIC_STRING_TO_ENUM = Object.freeze({\r\n  and_any: 0,\r\n  not_all: 1,\r\n  not_any: 2,\r\n  and_all: 3,\r\n});\r\n\r\nconst LOGIC_ENUM_TO_STRING = Object.freeze({\r\n  0: 'and_any',\r\n  1: 'not_all',\r\n  2: 'not_any',\r\n  3: 'and_all',\r\n});\r\n\r\nconst ROLE_NAME_TO_ENUM = Object.freeze({\r\n  system: 0,\r\n  user: 1,\r\n  assistant: 2,\r\n});\r\n\r\nconst ROLE_ENUM_TO_NAME = Object.freeze({\r\n  0: 'system',\r\n  1: 'user',\r\n  2: 'assistant',\r\n});\r\n\r\nconst POSITION_UI_TO_STRUCT = Object.freeze({\r\n  before_character_definition: { type: 'before_character_definition' },\r\n  after_character_definition: { type: 'after_character_definition' },\r\n  before_example_messages: { type: 'before_example_messages' },\r\n  after_example_messages: { type: 'after_example_messages' },\r\n  before_author_note: { type: 'before_author_note' },\r\n  after_author_note: { type: 'after_author_note' },\r\n  at_depth_as_system: { type: 'at_depth', role: 'system' },\r\n  at_depth_as_assistant: { type: 'at_depth', role: 'assistant' },\r\n  at_depth_as_user: { type: 'at_depth', role: 'user' },\r\n});\r\n\r\nconst POSITION_NUMERIC_TO_UI = Object.freeze({\r\n  0: 'before_character_definition',\r\n  1: 'after_character_definition',\r\n  2: 'before_author_note',\r\n  3: 'after_author_note',\r\n  4: 'at_depth_as_system',\r\n  5: 'before_example_messages',\r\n  6: 'after_example_messages',\r\n});\r\n\r\nconst LEGACY_POSITION_ALIASES = Object.freeze({\r\n  before_char: 'before_character_definition',\r\n  after_char: 'after_character_definition',\r\n  before_an: 'before_author_note',\r\n  after_an: 'after_author_note',\r\n  before_em: 'before_example_messages',\r\n  after_em: 'after_example_messages',\r\n  at_depth: 'at_depth_as_system',\r\n  depth_system: 'at_depth_as_system',\r\n  depth_character: 'at_depth_as_assistant',\r\n  depth_user: 'at_depth_as_user',\r\n});\r\n\r\nconst cloneEntry = source => (source ? JSON.parse(JSON.stringify(source)) : {});\r\n\r\nconst sanitizeKeyArray = keys =>\n  Array.isArray(keys)\n    ? keys\n        .map(key => {\n          if (typeof key === 'string') return key.trim();\n          if (key instanceof RegExp) return key.source;\n          if (key && typeof key === 'object') {\n            if (typeof key.pattern === 'string') return key.pattern.trim();\n            if (typeof key.source === 'string') return key.source.trim();\n          }\n          if (key !== null && key !== undefined && typeof key.toString === 'function') {\n            const str = key.toString();\n            return typeof str === 'string' ? str.trim() : '';\n          }\n          return '';\n        })\n        .filter(Boolean)\n    : [];\n\n// \u6309\u987A\u5E8F\u4E3A\u6B63\u5219\u5199\u5165\u987A\u5E8F\u5B57\u6BB5\uFF0C\u786E\u4FDD\u5BBF\u4E3B\u754C\u9762\u80FD\u591F\u8BFB\u53D6\u5230\u6700\u65B0\u7684\u6267\u884C\u987A\u5E8F\nconst ORDER_FIELD_KEYS = ['order', 'displayIndex', 'display_index', 'sort_order', 'script_order'];\n\nexport const updateRegexOrderMetadata = (regexList = []) => {\n  if (!Array.isArray(regexList) || regexList.length === 0) return;\n  regexList.forEach((regex, index) => {\n    if (!regex || typeof regex !== 'object' || regex.source === 'card') return;\n    ORDER_FIELD_KEYS.forEach(key => {\n      regex[key] = index;\n    });\n    if (regex?.position && typeof regex.position === 'object' && 'order' in regex.position) {\n      regex.position.order = index;\n    }\n  });\n};\n\nconst normalizeRegexPayloadOrder = regexes => {\n  if (!Array.isArray(regexes) || regexes.length === 0) return regexes;\n  const buckets = new Map([\n    ['global', []],\n    ['character', []],\n  ]);\n\n  regexes.forEach(regex => {\n    if (!regex || typeof regex !== 'object' || regex.source === 'card') return;\n    const scope = regex.scope === 'character' ? 'character' : 'global';\n    buckets.get(scope).push(regex);\n  });\n\n  buckets.forEach(list => updateRegexOrderMetadata(list));\n  return regexes;\n};\n\r\nconst toBooleanStrict = value => {\r\n  if (value === true || value === false) return value;\r\n  if (value === null || value === undefined) return false;\r\n  if (typeof value === 'string') {\r\n    const normalized = value.trim().toLowerCase();\r\n    return ['1', 'true', 'yes', 'on'].includes(normalized);\r\n  }\r\n  return Boolean(value);\r\n};\r\n\r\nconst parseOptionalNumber = value => {\r\n  if (value === '' || value === null || value === undefined) return null;\r\n  const numeric = Number(value);\r\n  return Number.isNaN(numeric) ? null : numeric;\r\n};\r\n\r\nconst normalizeLogicString = value => {\r\n  if (value === null || value === undefined) return 'and_any';\r\n  if (typeof value === 'number' && !Number.isNaN(value)) {\r\n    const mapped = LOGIC_ENUM_TO_STRING[value] ?? LOGIC_ENUM_TO_STRING[value.toString()];\r\n    return mapped ?? 'and_any';\r\n  }\r\n  const str = value.toString().trim().toLowerCase();\r\n  if (LOGIC_STRING_TO_ENUM[str] !== undefined) return str;\r\n  if (LOGIC_ENUM_TO_STRING[str] !== undefined) return LOGIC_ENUM_TO_STRING[str];\r\n  return 'and_any';\r\n};\r\n\r\nconst mapEnumLogicToUi = value => normalizeLogicString(value);\r\n\r\nconst mapUiLogicToEnum = value => LOGIC_STRING_TO_ENUM[normalizeLogicString(value)] ?? LOGIC_STRING_TO_ENUM.and_any;\r\n\r\nconst normalizeRoleName = value => {\r\n  if (typeof value === 'string') {\r\n    const normalized = value.trim().toLowerCase();\r\n    if (ROLE_NAME_TO_ENUM[normalized] !== undefined) return normalized;\r\n  }\r\n  if (typeof value === 'number' && !Number.isNaN(value)) {\r\n    const mapped = ROLE_ENUM_TO_NAME[value] ?? ROLE_ENUM_TO_NAME[value.toString()];\r\n    if (mapped) return mapped;\r\n  }\r\n  return null;\r\n};\r\n\r\nconst resolveUiPositionKey = (positionValue, roleValue) => {\r\n  if (positionValue === undefined || positionValue === null) {\r\n    return 'before_character_definition';\r\n  }\r\n  if (typeof positionValue === 'object' && positionValue !== null) {\r\n    if (typeof positionValue.type === 'string' && positionValue.type) {\r\n      const normalizedType = (LEGACY_POSITION_ALIASES[positionValue.type] ?? positionValue.type).trim();\r\n      if (normalizedType === 'at_depth' || normalizedType === 'at_depth_as_system') {\r\n        const roleName = normalizeRoleName(positionValue.role ?? roleValue) ?? 'system';\r\n        if (roleName === 'assistant') return 'at_depth_as_assistant';\r\n        if (roleName === 'user') return 'at_depth_as_user';\r\n        return 'at_depth_as_system';\r\n      }\r\n      if (normalizedType.startsWith('at_depth_as_')) {\r\n        return normalizedType;\r\n      }\r\n      return normalizedType;\r\n    }\r\n    if (typeof positionValue.position === 'number' && !Number.isNaN(positionValue.position)) {\r\n      return resolveUiPositionKey(positionValue.position, positionValue.role ?? roleValue);\r\n    }\r\n  }\r\n  if (typeof positionValue === 'string') {\r\n    const normalized = (LEGACY_POSITION_ALIASES[positionValue] ?? positionValue).trim();\r\n    if (normalized === 'at_depth') {\r\n      const roleName = normalizeRoleName(roleValue) ?? 'system';\r\n      if (roleName === 'assistant') return 'at_depth_as_assistant';\r\n      if (roleName === 'user') return 'at_depth_as_user';\r\n      return 'at_depth_as_system';\r\n    }\r\n    return normalized;\r\n  }\r\n  if (typeof positionValue === 'number' && !Number.isNaN(positionValue)) {\r\n    if (positionValue === 4) {\r\n      const roleName = normalizeRoleName(roleValue) ?? 'system';\r\n      if (roleName === 'assistant') return 'at_depth_as_assistant';\r\n      if (roleName === 'user') return 'at_depth_as_user';\r\n      return 'at_depth_as_system';\r\n    }\r\n    const mapped = POSITION_NUMERIC_TO_UI[positionValue];\r\n    if (mapped) return mapped;\r\n  }\r\n  return 'before_character_definition';\r\n};\r\n\r\nconst mapPositionToUiString = (positionValue, roleValue) => resolveUiPositionKey(positionValue, roleValue);\r\n\r\nconst extractPositionDetails = (positionValue, { fallbackRole = null, fallbackDepth = null, fallbackOrder = null } = {}) => {\r\n  const fallbackRoleName = normalizeRoleName(fallbackRole);\r\n  const details = {\r\n    type: 'before_character_definition',\r\n    role: null,\r\n    depth: null,\r\n    order: parseOptionalNumber(fallbackOrder),\r\n    uiKey: 'before_character_definition',\r\n  };\r\n\r\n  const setOrder = value => {\r\n    const parsed = parseOptionalNumber(value);\r\n    if (parsed !== null) details.order = parsed;\r\n  };\r\n  const setDepth = value => {\r\n    const parsed = parseOptionalNumber(value);\r\n    if (parsed !== null) details.depth = parsed;\r\n  };\r\n\r\n  setOrder(fallbackOrder);\r\n  setDepth(fallbackDepth);\r\n\r\n  if (positionValue && typeof positionValue === 'object') {\r\n    if (typeof positionValue.type === 'string' && positionValue.type) {\r\n      const normalizedType = (LEGACY_POSITION_ALIASES[positionValue.type] ?? positionValue.type).trim();\r\n      details.type = normalizedType === 'at_depth_as_system' ? 'at_depth' : normalizedType;\r\n      const roleName = normalizeRoleName(positionValue.role) ?? fallbackRoleName;\r\n      if (details.type === 'at_depth') {\r\n        details.role = roleName ?? 'system';\r\n        setDepth(positionValue.depth);\r\n        details.uiKey =\r\n          details.role === 'assistant'\r\n            ? 'at_depth_as_assistant'\r\n            : details.role === 'user'\r\n              ? 'at_depth_as_user'\r\n              : 'at_depth_as_system';\r\n      } else {\r\n        details.role = null;\r\n        details.depth = null;\r\n        details.uiKey = details.type;\r\n      }\r\n      setOrder(positionValue.order);\r\n      return details;\r\n    }\r\n    if (typeof positionValue.position === 'number' && !Number.isNaN(positionValue.position)) {\r\n      const roleName = normalizeRoleName(positionValue.role) ?? fallbackRoleName;\r\n      const uiKey = resolveUiPositionKey(positionValue.position, roleName);\r\n      details.uiKey = uiKey;\r\n      if (uiKey.startsWith('at_depth')) {\r\n        details.type = 'at_depth';\r\n        details.role = roleName ?? 'system';\r\n        setDepth(positionValue.depth);\r\n      } else {\r\n        details.type = uiKey;\r\n        details.role = null;\r\n        details.depth = null;\r\n      }\r\n      setOrder(positionValue.order);\r\n      return details;\r\n    }\r\n  }\r\n\r\n  const uiKey = resolveUiPositionKey(positionValue, fallbackRoleName);\r\n  details.uiKey = uiKey;\r\n\r\n  if (uiKey.startsWith('at_depth')) {\r\n    details.type = 'at_depth';\r\n    details.role = uiKey === 'at_depth_as_assistant' ? 'assistant' : uiKey === 'at_depth_as_user' ? 'user' : 'system';\r\n    if (details.depth === null) {\r\n      details.depth = parseOptionalNumber(fallbackDepth);\r\n    }\r\n  } else {\r\n    details.type = uiKey;\r\n    details.role = null;\r\n    details.depth = null;\r\n  }\r\n\r\n  return details;\r\n};\r\n\r\nconst buildRawPosition = (uiKeyInput, { depth, order, basePosition } = {}) => {\r\n  const baseDetails = extractPositionDetails(basePosition ?? null);\r\n  const normalizedKey = (LEGACY_POSITION_ALIASES[uiKeyInput] ?? uiKeyInput ?? baseDetails.uiKey)\r\n    .toString()\r\n    .trim() || baseDetails.uiKey || 'before_character_definition';\r\n  const mapping =\r\n    POSITION_UI_TO_STRUCT[normalizedKey] ??\r\n    POSITION_UI_TO_STRUCT[baseDetails.uiKey] ??\r\n    POSITION_UI_TO_STRUCT.before_character_definition;\r\n\r\n  const result = { type: mapping.type };\r\n  const parsedOrder = parseOptionalNumber(order);\r\n  const resolvedOrder =\r\n    parsedOrder !== null\r\n      ? parsedOrder\r\n      : baseDetails.order !== null && baseDetails.order !== undefined\r\n        ? baseDetails.order\r\n        : 0;\r\n  result.order = resolvedOrder;\r\n\r\n  if (mapping.type === 'at_depth') {\r\n    const role = mapping.role ?? baseDetails.role ?? 'system';\r\n    result.role = role;\r\n    const parsedDepth = parseOptionalNumber(depth);\r\n    const resolvedDepth =\r\n      parsedDepth !== null\r\n        ? parsedDepth\r\n        : baseDetails.depth !== null && baseDetails.depth !== undefined\r\n          ? baseDetails.depth\r\n          : 0;\r\n    result.depth = resolvedDepth;\r\n  }\r\n\r\n  return result;\r\n};\r\n\r\nexport const normalizeWorldbookEntry = entry => {\r\n  if (!entry || typeof entry !== 'object') return entry;\r\n  const clone = cloneEntry(entry);\r\n\r\n  if (!clone.strategy || typeof clone.strategy !== 'object') {\r\n    clone.strategy = {};\r\n  }\r\n  const strategy = clone.strategy;\r\n\r\n  const keys = sanitizeKeyArray(strategy.keys ?? clone.keys ?? clone.key ?? clone.keywords);\r\n  strategy.keys = [...keys];\r\n  clone.keys = [...keys];\r\n  clone.key = [...keys];\r\n  clone.keywords = [...keys];\r\n\r\n  const secondaryKeys = sanitizeKeyArray(\r\n    strategy.keys_secondary?.keys ?? clone.keysecondary ?? clone.key_secondary ?? [],\r\n  );\r\n  if (!strategy.keys_secondary || typeof strategy.keys_secondary !== 'object') {\r\n    strategy.keys_secondary = { logic: 'and_any', keys: [] };\r\n  }\r\n  strategy.keys_secondary.keys = [...secondaryKeys];\r\n  clone.keysecondary = [...secondaryKeys];\r\n\r\n  const logicString = normalizeLogicString(strategy.keys_secondary.logic ?? clone.logic ?? clone.selectiveLogic);\r\n  strategy.keys_secondary.logic = logicString;\r\n  clone.logic = logicString;\r\n  clone.selectiveLogic = LOGIC_STRING_TO_ENUM[logicString];\r\n\r\n  const positionDetails = extractPositionDetails(clone.position, {\r\n    fallbackRole: clone.role,\r\n    fallbackDepth: clone.depth,\r\n    fallbackOrder: clone.order ?? clone.insertion_order ?? clone.displayIndex,\r\n  });\r\n  clone.position = positionDetails.uiKey;\r\n  clone.depth = positionDetails.type === 'at_depth' ? (positionDetails.depth ?? 0) : null;\r\n  clone.order = positionDetails.order ?? 0;\r\n  clone.role = positionDetails.role;\r\n\r\n  const probability = parseOptionalNumber(clone.probability);\r\n  clone.probability = probability === null ? 100 : probability;\r\n\r\n  if (!clone.recursion || typeof clone.recursion !== 'object') {\r\n    clone.recursion = { prevent_incoming: false, prevent_outgoing: false, delay_until: null };\r\n  }\r\n  clone.prevent_recursion = toBooleanStrict(\r\n    clone.prevent_recursion ?? clone.preventRecursion ?? clone.recursion.prevent_outgoing,\r\n  );\r\n  clone.exclude_recursion = toBooleanStrict(\r\n    clone.exclude_recursion ?? clone.excludeRecursion ?? clone.recursion.prevent_incoming,\r\n  );\r\n  clone.recursion.prevent_outgoing = clone.prevent_recursion;\r\n  clone.recursion.prevent_incoming = clone.exclude_recursion;\r\n\r\n  clone.case_sensitive = toBooleanStrict(clone.case_sensitive ?? clone.caseSensitive ?? false);\r\n  clone.caseSensitive = clone.case_sensitive;\r\n\r\n  clone.match_whole_words = toBooleanStrict(clone.match_whole_words ?? clone.matchWholeWords ?? false);\r\n  clone.matchWholeWords = clone.match_whole_words;\r\n\r\n  clone.enabled = clone.disable !== undefined ? !clone.disable : clone.enabled ?? true;\r\n\r\n  return clone;\r\n};\r\n\r\nconst convertUiEntryToRaw = (uiEntry, baseEntry = {}) => {\r\n  const raw = cloneEntry(baseEntry);\r\n  const uiClone = cloneEntry(uiEntry);\r\n\r\n  const numericUid = parseOptionalNumber(uiClone.uid);\r\n  if (numericUid !== null) raw.uid = numericUid;\r\n\r\n  if (uiClone.name !== undefined) raw.name = uiClone.name;\r\n  if (uiClone.comment !== undefined) raw.comment = uiClone.comment;\r\n  if (uiClone.content !== undefined) raw.content = uiClone.content;\r\n\r\n  if (!raw.strategy || typeof raw.strategy !== 'object') {\r\n    raw.strategy = {};\r\n  }\r\n  const strategy = raw.strategy;\r\n\r\n  const keys = sanitizeKeyArray(uiClone.keys ?? strategy.keys ?? raw.keys ?? raw.key ?? raw.keywords);\r\n  strategy.keys = [...keys];\r\n  raw.keys = [...keys];\r\n  raw.key = [...keys];\r\n  raw.keywords = [...keys];\r\n\r\n  const secondaryKeys = sanitizeKeyArray(\r\n    uiClone.keysecondary ?? strategy.keys_secondary?.keys ?? raw.keysecondary,\r\n  );\r\n  if (!strategy.keys_secondary || typeof strategy.keys_secondary !== 'object') {\r\n    strategy.keys_secondary = { logic: 'and_any', keys: [] };\r\n  }\r\n  strategy.keys_secondary.keys = [...secondaryKeys];\r\n  raw.keysecondary = [...secondaryKeys];\r\n\r\n  const logicString = normalizeLogicString(\r\n    uiClone.logic ?? strategy.keys_secondary.logic ?? raw.logic ?? raw.selectiveLogic,\r\n  );\r\n  strategy.keys_secondary.logic = logicString;\r\n  raw.logic = logicString;\r\n  raw.selectiveLogic = LOGIC_STRING_TO_ENUM[logicString];\r\n\r\n  if (uiClone.enabled !== undefined) {\r\n    raw.enabled = Boolean(uiClone.enabled);\r\n    raw.disable = !raw.enabled;\r\n  }\r\n\r\n  const probability = parseOptionalNumber(uiClone.probability);\r\n  if (probability !== null) {\r\n    raw.probability = probability;\r\n    raw.useProbability = probability !== 100;\r\n  } else if (raw.probability !== undefined) {\r\n    raw.useProbability = raw.probability !== 100;\r\n  }\r\n\r\n  const order = parseOptionalNumber(uiClone.order);\r\n  const depth = parseOptionalNumber(uiClone.depth);\r\n  const positionStruct = buildRawPosition(uiClone.position ?? raw.position, {\r\n    depth,\r\n    order,\r\n    basePosition: raw.position,\r\n  });\r\n  raw.position = positionStruct;\r\n  if (positionStruct.type === 'at_depth') {\r\n    raw.depth = positionStruct.depth ?? 0;\r\n    raw.role = positionStruct.role ?? 'system';\r\n  } else {\r\n    raw.depth = null;\r\n    raw.role = null;\r\n  }\r\n  if (positionStruct.order !== undefined) {\r\n    raw.order = positionStruct.order;\r\n    raw.insertion_order = positionStruct.order;\r\n    raw.displayIndex = positionStruct.order;\r\n  }\r\n\r\n  if (!raw.recursion || typeof raw.recursion !== 'object') {\r\n    raw.recursion = { prevent_incoming: false, prevent_outgoing: false, delay_until: null };\r\n  }\r\n  const recursion = raw.recursion;\r\n  if (uiClone.prevent_recursion !== undefined) {\r\n    recursion.prevent_outgoing = Boolean(uiClone.prevent_recursion);\r\n  }\r\n  if (uiClone.exclude_recursion !== undefined) {\r\n    recursion.prevent_incoming = Boolean(uiClone.exclude_recursion);\r\n  }\r\n  raw.preventRecursion = recursion.prevent_outgoing;\r\n  raw.prevent_recursion = recursion.prevent_outgoing;\r\n  raw.excludeRecursion = recursion.prevent_incoming;\r\n  raw.exclude_recursion = recursion.prevent_incoming;\r\n\r\n  const resolveBool = (uiValue, currentValue) => {\r\n    if (uiValue === undefined) return currentValue;\r\n    return toBooleanStrict(uiValue);\r\n  };\r\n\r\n  const caseSensitiveValue = resolveBool(uiClone.case_sensitive, raw.caseSensitive ?? raw.case_sensitive);\r\n  if (caseSensitiveValue !== undefined) {\r\n    raw.caseSensitive = caseSensitiveValue;\r\n    raw.case_sensitive = caseSensitiveValue;\r\n  }\r\n\r\n  const matchWholeWordsValue = resolveBool(uiClone.match_whole_words, raw.matchWholeWords ?? raw.match_whole_words);\r\n  if (matchWholeWordsValue !== undefined) {\r\n    raw.matchWholeWords = matchWholeWordsValue;\r\n    raw.match_whole_words = matchWholeWordsValue;\r\n  }\r\n\r\n  return raw;\r\n};\r\n\r\n\r\nconst resolveNumericUid = value => {\r\n  if (typeof value === 'number' && Number.isInteger(value)) return value;\r\n  const parsed = Number(value);\r\n  return Number.isInteger(parsed) ? parsed : null;\r\n};\r\n\r\nconst sanitizeKeysForUpdate = keys => sanitizeKeyArray(keys);\r\n\r\nconst isCharacterNotFoundError = (error) => {\r\n  if (!error) return false;\r\n  const message = String(error?.message ?? error ?? '').toLowerCase();\r\n  return message.includes('\u672A\u627E\u5230\u540D\u4E3A') || (message.includes('character') && message.includes('not found'));\r\n};\r\n\r\nexport const TavernAPI = {\r\n  createWorldbook: errorCatched(async name => await getTavernHelper().createWorldbook(name, [])),\r\n  deleteWorldbook: errorCatched(async name => await getTavernHelper().deleteWorldbook(name)),\r\n  getWorldbooks: errorCatched(async () => await getTavernHelper().getWorldbookNames()),\r\n  getCharData: errorCatched(async () => await getTavernHelper().getCharData()),\r\n  getRegexes: errorCatched(async () => await getTavernHelper().getTavernRegexes({ scope: 'all' })),\r\n  replaceRegexes: errorCatched(async (regexes, options = {}) => {\n    const scope = options?.scope ?? 'all';\n    const payload = Array.isArray(regexes) ? regexes : [];\n    normalizeRegexPayloadOrder(payload);\n    await getTavernHelper().replaceTavernRegexes(payload, { scope });\n  }),\n  getGlobalWorldbookNames: errorCatched(async () => await getTavernHelper().getGlobalWorldbookNames()),\r\n  rebindGlobalWorldbooks: errorCatched(async bookNames => await getTavernHelper().rebindGlobalWorldbooks(bookNames)),\r\n  getCharWorldbookNames: errorCatched(async charData => {\r\n    try {\r\n      const characterName = charData?.name;\r\n      if (!characterName) {\r\n        console.warn('[RegexLoreHub] getCharWorldbookNames \u8C03\u7528\u7F3A\u5C11\u89D2\u8272\u540D\u79F0\u3002');\r\n        return null;\r\n      }\r\n      return await getTavernHelper().getCharWorldbookNames(characterName);\r\n    } catch (error) {\r\n      if (isCharacterNotFoundError(error)) {\r\n        console.warn('[RegexLoreHub] \u672A\u627E\u5230\u6307\u5B9A\u89D2\u8272\u5361\uFF0C\u8DF3\u8FC7\u89D2\u8272\u4E16\u754C\u4E66\u52A0\u8F7D\u3002', error);\r\n        return null;\r\n      }\r\n      throw error;\r\n    }\r\n  }),\r\n  getCurrentCharWorldbookNames: errorCatched(async () => {\r\n    try {\r\n      return await getTavernHelper().getCharWorldbookNames('current');\r\n    } catch (error) {\r\n      if (isCharacterNotFoundError(error)) {\r\n        console.warn('[RegexLoreHub] \u672A\u627E\u5230\u5F53\u524D\u89D2\u8272\u5361\uFF0C\u8DF3\u8FC7\u89D2\u8272\u4E16\u754C\u4E66\u52A0\u8F7D\u3002', error);\r\n        return null;\r\n      }\r\n      throw error;\r\n    }\r\n  }),\r\n  getChatWorldbookName: errorCatched(async () => await getTavernHelper().getChatWorldbookName('current')),\r\n  getOrCreateChatWorldbook: errorCatched(async name => await getTavernHelper().getOrCreateChatWorldbook('current', name)),\r\n  rebindChatWorldbook: errorCatched(async name => await getTavernHelper().rebindChatWorldbook('current', name)),\r\n  getWorldbook: errorCatched(async name => await getTavernHelper().getWorldbook(name)),\r\n  updateWorldbookWith: errorCatched(async (name, updater) => await getTavernHelper().updateWorldbookWith(name, updater)),\r\n  replaceWorldbook: errorCatched(async (name, entries) => await getTavernHelper().replaceWorldbook(name, entries)),\r\n  createWorldbookEntries: errorCatched(async (name, entries) => await getTavernHelper().createWorldbookEntries(name, entries)),\r\n  deleteWorldbookEntries: errorCatched(async (name, uids) => {\r\n    const uidsSet = new Set(uids);\r\n    return await getTavernHelper().deleteWorldbookEntries(name, entry => uidsSet.has(entry.uid));\r\n  }),\r\n  saveSettings: errorCatched(async () => await getTavernHelper().builtin.saveSettings()),\r\n  rebindCharWorldbooks: errorCatched(async lorebooks => await getTavernHelper().rebindCharWorldbooks('current', lorebooks)),\r\n  get Character() {\r\n    return getTavernHelper().Character;\r\n  },\r\n};\r\n\r\nexport const updateWorldbookEntries = errorCatched(async (bookName, entryUpdates) => {\r\n  if (!Array.isArray(entryUpdates) || entryUpdates.length === 0) return;\r\n\r\n  const updatesByUid = new Map();\r\n  const pendingUidSet = new Set();\r\n\r\n  entryUpdates.forEach(update => {\r\n    if (!update || typeof update !== 'object') return;\r\n    const uid = parseOptionalNumber(update.uid);\r\n    if (uid === null) return;\r\n    pendingUidSet.add(uid);\r\n    const existing = updatesByUid.get(uid) ?? {};\r\n    updatesByUid.set(uid, { ...existing, ...update });\r\n  });\r\n\r\n  if (pendingUidSet.size === 0) return;\r\n\r\n  const localEntries = safeGetLorebookEntries(bookName);\r\n  const localEntryMap = new Map(\r\n    localEntries\r\n      .map(entry => [parseOptionalNumber(entry?.uid), entry])\r\n      .filter(([uid]) => uid !== null),\r\n  );\r\n\r\n  const updater = currentEntries =>\r\n    currentEntries.map(entry => {\r\n      const uid = parseOptionalNumber(entry?.uid);\r\n      if (uid === null || !pendingUidSet.has(uid)) return entry;\r\n      const localEntry = localEntryMap.get(uid);\r\n      if (!localEntry) return entry;\r\n      const mergedLocal = cloneEntry(localEntry);\r\n      const partialUpdate = updatesByUid.get(uid);\r\n      if (partialUpdate && typeof partialUpdate === 'object') {\r\n        // \u5148\u5C06\u8C03\u7528\u65B9\u4F20\u5165\u7684\u589E\u91CF\u6570\u636E\u5408\u5E76\u5230\u672C\u5730\u6761\u76EE\uFF0C\u518D\u7EDF\u4E00\u4EA4\u7ED9\u8F6C\u6362\u51FD\u6570\u5904\u7406\r\n        Object.entries(partialUpdate).forEach(([key, value]) => {\r\n          if (key === 'uid' || key === 'tempUid') return;\r\n          if (Array.isArray(value)) {\r\n            mergedLocal[key] = value.map(item => (typeof item === 'object' && item !== null ? cloneEntry(item) : item));\r\n          } else if (value && typeof value === 'object') {\r\n            mergedLocal[key] = cloneEntry(value);\r\n          } else {\r\n            mergedLocal[key] = value;\r\n          }\r\n        });\r\n      }\r\n      return convertUiEntryToRaw(mergedLocal, entry);\r\n    });\r\n\r\n  const updatedEntries = await TavernAPI.updateWorldbookWith(bookName, updater);\r\n\r\n  const normalizedEntries = Array.isArray(updatedEntries)\r\n    ? updatedEntries.map(normalizeWorldbookEntry)\r\n    : [];\r\n  safeSetLorebookEntries(bookName, normalizedEntries);\r\n  updateBookSummary(bookName);\r\n\r\n  await TavernAPI.saveSettings();\r\n  return updatedEntries;\r\n});\r\n\r\n\r\nconst ensurePendingLorebookUpdateMap = bookName => {\r\n  if (!appState.pendingLorebookUpdates.has(bookName)) {\r\n    appState.pendingLorebookUpdates.set(bookName, new Map());\r\n  }\r\n  return appState.pendingLorebookUpdates.get(bookName);\r\n};\r\n\r\nexport const queueLorebookEntryUpdate = (bookName, entryIdentifier, partialUpdate = {}) => {\r\n  if (!bookName || !partialUpdate || typeof partialUpdate !== 'object') return;\r\n  const numericUid = resolveNumericUid(entryIdentifier);\r\n  const key = String(entryIdentifier);\r\n  const updatesMap = ensurePendingLorebookUpdateMap(bookName);\r\n  const existing =\r\n    updatesMap.get(key) ??\r\n    {\r\n      uid: numericUid,\r\n      tempUid: numericUid == null ? key : null,\r\n      data: {},\r\n    };\r\n\r\n  if (numericUid != null) {\r\n    existing.uid = numericUid;\r\n  }\r\n\r\n  if (!existing.data || typeof existing.data !== 'object') {\r\n    existing.data = {};\r\n  }\r\n\r\n  const payload = { ...partialUpdate };\r\n  if (Array.isArray(payload.keys)) {\r\n    payload.keys = sanitizeKeysForUpdate(payload.keys);\r\n  }\r\n\r\n  Object.entries(payload).forEach(([field, value]) => {\r\n    if (value !== undefined) {\r\n      existing.data[field] = value;\r\n    }\r\n  });\r\n\r\n  updatesMap.set(key, existing);\r\n};\r\n\r\nexport const queueRegexUpdate = regexId => {\r\n  if (regexId === undefined || regexId === null) return;\r\n  appState.pendingRegexUpdates.add(regexId);\r\n};\r\n\r\nconst migratePendingLorebookUpdate = (bookName, tempUid, newUid) => {\r\n  const numericUid = resolveNumericUid(newUid);\r\n  if (!bookName || tempUid == null || numericUid == null) return;\r\n  const updatesMap = appState.pendingLorebookUpdates.get(bookName);\r\n  if (!updatesMap || !(updatesMap instanceof Map)) return;\r\n\r\n  const tempKey = String(tempUid);\r\n  const record = updatesMap.get(tempKey);\r\n  if (!record) return;\r\n\r\n  updatesMap.delete(tempKey);\r\n\r\n  const newKey = String(numericUid);\r\n  const target =\r\n    updatesMap.get(newKey) ??\r\n    {\r\n      uid: numericUid,\r\n      tempUid: null,\r\n      data: {},\r\n    };\r\n\r\n  target.uid = numericUid;\r\n  if (!target.data || typeof target.data !== 'object') {\r\n    target.data = {};\r\n  }\r\n  if (record.data && typeof record.data === 'object') {\r\n    target.data = { ...record.data, ...target.data };\r\n  }\r\n\r\n  updatesMap.set(newKey, target);\r\n};\r\n\r\nlet loadAllDataPromise = null;\r\n\r\nconst performLoadAllData = async () => {\r\n  const $ = get$();\r\n  const parentDoc = getParentDoc();\r\n  const parentWin = getParentWin();\r\n  const TavernHelper = getTavernHelper();\r\n  const $content = $(`#${PANEL_ID}-content`, parentDoc);\r\n\r\n  syncContextWithAppState(); // <--- \u5728\u6B64\u5904\u6DFB\u52A0\u8C03\u7528\r\n\r\n  const createLoadingUI = () => {\r\n    const html = `\r\n      <div class=\"rlh-loading\">\r\n        <div class=\"rlh-loading-spinner\" aria-hidden=\"true\"></div>\r\n        <div class=\"rlh-loading-text\">\r\n          <p class=\"rlh-loading-title\">\u6B63\u5728\u52A0\u8F7D\u6570\u636E...</p>\r\n          <p class=\"rlh-loading-status\">\u521D\u59CB\u5316...</p>\r\n          <div class=\"rlh-loading-bar\" role=\"progressbar\" aria-valuemin=\"0\" aria-valuemax=\"100\" aria-valuenow=\"0\">\r\n            <div class=\"rlh-loading-bar-inner\"></div>\r\n          </div>\r\n          <div class=\"rlh-loading-progress\">0%</div>\r\n          <p class=\"rlh-loading-detail\"></p>\r\n        </div>\r\n      </div>\r\n    `;\r\n    $content.html(html);\r\n    const $status = $content.find('.rlh-loading-status');\r\n    const $detail = $content.find('.rlh-loading-detail');\r\n    const $progress = $content.find('.rlh-loading-progress');\r\n    const $bar = $content.find('.rlh-loading-bar-inner');\r\n    const $barContainer = $content.find('.rlh-loading-bar');\r\n\r\n    let total = 1;\r\n    let current = 0;\r\n\r\n    const updateBar = () => {\r\n      const safeTotal = Math.max(1, total);\r\n      const ratio = Math.min(current / safeTotal, 1);\r\n      const percent = Math.round(ratio * 100);\r\n      $bar.css('width', `${percent}%`);\r\n      $barContainer.attr('aria-valuenow', percent);\r\n      $progress.text(`${percent}%`);\r\n    };\r\n\r\n    updateBar();\r\n\r\n    return {\r\n      setProgress(currentValue, totalValue, status, detail) {\r\n        total = Math.max(1, totalValue);\r\n        current = Math.max(0, Math.min(currentValue, total));\r\n        if (status) $status.text(status);\r\n        if (detail !== undefined) $detail.text(detail);\r\n        updateBar();\r\n      },\r\n      setStatus(status, detail) {\r\n        if (status) $status.text(status);\r\n        if (detail !== undefined) $detail.text(detail);\r\n      },\r\n    };\r\n  };\r\n\r\n  const loading = createLoadingUI();\r\n  let totalSteps = 4;\r\n  let progressCurrent = 0;\r\n\r\n  const advanceProgress = (status, detail) => {\r\n    progressCurrent = Math.min(progressCurrent + 1, totalSteps);\r\n    loading.setProgress(progressCurrent, totalSteps, status, detail);\r\n  };\r\n\r\n  loading.setProgress(progressCurrent, totalSteps, '\u51C6\u5907\u52A0\u8F7D\u6570\u636E...', '\u6B63\u5728\u68C0\u67E5\u8FD0\u884C\u73AF\u5883');\r\n\r\n  try {\r\n    // \u9632\u5FA1\u6027\u68C0\u67E5\uFF1A\u786E\u4FDDSillyTavern API\u53EF\u7528\r\n    if (!parentWin.SillyTavern || !parentWin.SillyTavern.getContext) {\r\n      console.warn('[RegexLoreHub] SillyTavern API not available, initializing with empty data');\r\n      appState.regexes.global = [];\r\n      appState.regexes.character = [];\r\n      appState.allLorebooks = [];\r\n      appState.lorebooks.character = [];\r\n      appState.chatLorebook = null;\r\n      safeClearLorebookEntries();\r\n      appState.isDataLoaded = true;\r\n      renderContent();\r\n      return;\r\n    }\r\n\r\n    advanceProgress('\u83B7\u53D6\u57FA\u7840\u6570\u636E...', '\u6B63\u5728\u5411 SillyTavern \u8BF7\u6C42\u6570\u636E');\r\n    const context = parentWin.SillyTavern?.getContext?.() || {};\r\n    const allCharacters = Array.isArray(context.characters) ? context.characters : [];\r\n    const hasActiveCharacter = context.characterId !== undefined && context.characterId !== null;\r\n    const hasActiveChat = context.chatId !== undefined && context.chatId !== null;\r\n\r\n    let charData = null,\r\n      charLinkedBooks = null,\r\n      chatLorebook = null;\r\n\r\n    // \u4F7F\u7528Promise.allSettled\u6765\u907F\u514D\u5355\u4E2A\u5931\u8D25\u5F71\u54CD\u6574\u4F53\r\n    const promises = [\r\n      TavernAPI.getRegexes().catch(() => []),\r\n      TavernAPI.getGlobalWorldbookNames().catch(() => ([])),\r\n      TavernAPI.getWorldbooks().catch(() => []),\r\n    ];\r\n\r\n    if (hasActiveCharacter) {\r\n      promises.push(TavernAPI.getCharData().catch(() => null));\r\n      promises.push(TavernAPI.getCurrentCharWorldbookNames().catch(() => null));\r\n    } else {\r\n      promises.push(Promise.resolve(null), Promise.resolve(null));\r\n    }\r\n\r\n    if (hasActiveChat) {\r\n      // \u53EA\u6709\u5728\u786E\u5B9E\u6709\u6D3B\u8DC3\u804A\u5929\u65F6\u624D\u5C1D\u8BD5\u83B7\u53D6\u804A\u5929\u4E16\u754C\u4E66\r\n      promises.push(\r\n        TavernAPI.getChatWorldbookName().catch(error => {\r\n          console.warn('[RegexLoreHub] Failed to get chat worldbook:', error);\r\n          return null;\r\n        }),\r\n      );\r\n    } else {\r\n      promises.push(Promise.resolve(null));\r\n    }\r\n\r\n    const results = await Promise.allSettled(promises);\r\n\r\n    advanceProgress('\u89E3\u6790\u6570\u636E\u7ED3\u6784...', `\u68C0\u6D4B\u5230 ${allCharacters.length} \u4E2A\u89D2\u8272\uFF0C\u6B63\u5728\u6574\u7406\u6570\u636E`);\r\n\r\n\r\n    // \u5B89\u5168\u63D0\u53D6\u7ED3\u679C\r\n    const allUIRegexes = results[0].status === 'fulfilled' ? results[0].value : [];\r\n    const enabledGlobalBookNames = results[1].status === 'fulfilled' ? results[1].value : [];\r\n    const allBookFileNames = results[2].status === 'fulfilled' ? results[2].value : [];\r\n    charData = results[3]?.status === 'fulfilled' ? results[3].value : null;\r\n    charLinkedBooks = results[4]?.status === 'fulfilled' ? results[4].value : null;\r\n    chatLorebook = results[5]?.status === 'fulfilled' ? results[5].value : null;\r\n\r\n    syncContextWithAppState({ charData }); // \u786E\u4FDD\u89D2\u8272\u540D\u5728\u521D\u6B21\u6E32\u67D3\u524D\u5DF2\u5C31\u7EEA\r\n\r\n    appState.regexes.global = Array.isArray(allUIRegexes) ? allUIRegexes.filter(r => r.scope === 'global') : [];\n    updateRegexOrderMetadata(appState.regexes.global);\n    updateCharacterRegexes(allUIRegexes, charData);\n\r\n    \r\n\r\n    safeClearLorebookEntries();\r\n    if (!(appState.pendingLorebookUpdates instanceof Map)) {\r\n      appState.pendingLorebookUpdates = new Map();\r\n    } else {\r\n      appState.pendingLorebookUpdates.clear();\r\n    }\r\n    if (!(appState.pendingRegexUpdates instanceof Set)) {\r\n      appState.pendingRegexUpdates = new Set();\r\n    } else {\r\n      appState.pendingRegexUpdates.clear();\r\n    }\r\n    appState.lorebookUsage.clear();\r\n    const knownBookNames = new Set(Array.isArray(allBookFileNames) ? allBookFileNames : []);\r\n\r\n    // \u5B89\u5168\u5904\u7406\u89D2\u8272\u4E16\u754C\u4E66\r\n    if (Array.isArray(allCharacters) && allCharacters.length > 0) {\r\n      try {\r\n        await Promise.all(\r\n          allCharacters.map(async char => {\r\n            if (!char || !char.name) return;\r\n            try {\r\n              let books = null;\r\n              try {\r\n                const result = TavernHelper.getCharWorldbookNames(char.name);\r\n                // \u68C0\u67E5\u662F\u5426\u4E3A Promise\r\n                if (result && typeof result.then === 'function') {\r\n                  books = await result;\r\n                } else {\r\n                  books = result;\r\n                }\r\n              } catch (error) {\r\n                console.warn(`[RegexLoreHub] Error getting worldbooks for character \"${char.name}\":`, error);\r\n                books = null;\r\n              }\r\n              if (books && typeof books === 'object') {\r\n                const bookSet = new Set();\r\n                if (books.primary && typeof books.primary === 'string') bookSet.add(books.primary);\r\n                if (Array.isArray(books.additional)) {\r\n                  books.additional.forEach(b => typeof b === 'string' && bookSet.add(b));\r\n                }\r\n\r\n                bookSet.forEach(bookName => {\r\n                  if (typeof bookName === 'string') {\r\n                    if (!appState.lorebookUsage.has(bookName)) {\r\n                      appState.lorebookUsage.set(bookName, []);\r\n                    }\r\n                    appState.lorebookUsage.get(bookName).push(char.name);\r\n                    knownBookNames.add(bookName);\r\n                    console.log(`[RegexLoreHub] Character \"${char.name}\" uses worldbook \"${bookName}\"`);\r\n                  }\r\n                });\r\n              }\r\n            } catch (charError) {\r\n              console.warn(`[RegexLoreHub] Error processing character ${char.name}:`, charError);\r\n            }\r\n          }),\r\n        );\r\n      } catch (charProcessingError) {\r\n        console.warn('[RegexLoreHub] Error processing characters:', charProcessingError);\r\n      }\r\n    }\r\n\r\n    const enabledGlobalBooks = new Set(Array.isArray(enabledGlobalBookNames) ? enabledGlobalBookNames : []);\r\n    appState.allLorebooks = (Array.isArray(allBookFileNames) ? allBookFileNames : []).map(name => ({\r\n      name: name,\r\n      enabled: enabledGlobalBooks.has(name),\r\n      entryCount: 0,\r\n      enabledEntryCount: 0,\r\n      entriesLoaded: false,\r\n    }));\r\n\r\n    const charBookSet = new Set();\r\n    if (charLinkedBooks && typeof charLinkedBooks === 'object') {\r\n      if (charLinkedBooks.primary && typeof charLinkedBooks.primary === 'string') {\r\n        charBookSet.add(charLinkedBooks.primary);\r\n      }\r\n      if (Array.isArray(charLinkedBooks.additional)) {\r\n        charLinkedBooks.additional.forEach(name => typeof name === 'string' && charBookSet.add(name));\r\n      }\r\n    }\r\n    appState.lorebooks.character = Array.from(charBookSet);\r\n    appState.chatLorebook = typeof chatLorebook === 'string' ? chatLorebook : null;\r\n    if (typeof chatLorebook === 'string') {\r\n      knownBookNames.add(chatLorebook);\r\n    }\r\n\r\n    advanceProgress('\u6784\u5EFA\u7D22\u5F15...', '\u4E16\u754C\u4E66\u5217\u8868\u5DF2\u52A0\u8F7D');\r\n\r\n    \r\n\r\n    appState.isDataLoaded = true;\r\n    advanceProgress('\u6E32\u67D3\u754C\u9762...', '\u6570\u636E\u52A0\u8F7D\u5B8C\u6210');\r\n    renderContent();\r\n\r\n    prefetchGlobalBookSummaries();\r\n  } catch (error) {\r\n    console.error('[RegexLoreHub] Error in loadAllData:', error);\r\n    // \u53D1\u751F\u4E25\u91CD\u9519\u8BEF\u65F6\uFF0C\u663E\u793A\u53CB\u597D\u7684\u9519\u8BEF\u4FE1\u606F\r\n    $content.html(`\r\n                <div class=\"rlh-error-wrapper\">\r\n                    <p class=\"rlh-error-title\">\r\n                        <i class=\"fa-solid fa-exclamation-triangle\"></i> \u6570\u636E\u52A0\u8F7D\u5931\u8D25\r\n                    </p>\r\n                    <p class=\"rlh-error-text\">\r\n                        \u8BF7\u68C0\u67E5\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\uFF0C\u6216\u5C1D\u8BD5\u5237\u65B0\u9875\u9762\u3002\r\n                    </p>\r\n                    <button class=\"rlh-modal-btn rlh-error-retry-btn\" onclick=\"$('#${REFRESH_BTN_ID}').click()\">\r\n                        <i class=\"fa-solid fa-refresh\"></i> \u91CD\u8BD5\r\n                    </button>\r\n                </div>\r\n            `);\r\n    throw error; // \u8BA9errorCatched\u6355\u83B7\u5E76\u663E\u793A\u901A\u7528\u9519\u8BEF\u6D88\u606F\r\n  }\r\n};\r\n\r\nexport const loadAllData = errorCatched(async (force = false) => {\r\n  if (force) {\r\n    appState.isDataLoaded = false;\r\n  } else if (appState.isDataLoaded) {\r\n    return;\r\n  }\r\n\r\n  if (loadAllDataPromise) {\r\n    await loadAllDataPromise;\r\n    if (!force) {\r\n      return;\r\n    }\r\n  }\r\n\r\n  loadAllDataPromise = performLoadAllData();\r\n  try {\r\n    await loadAllDataPromise;\r\n  } finally {\r\n    loadAllDataPromise = null;\r\n  }\r\n});\r\n\r\n\r\n\r\nlet isPrefetchingGlobalSummaries = false;\r\nconst PREFETCH_MAX_CONCURRENCY = 3;\r\n\r\n// \u7B80\u5355\u7684\u5EF6\u8FDF\u5DE5\u5177\uFF0C\u7528\u4E8E\u5728\u5927\u91CF\u8BF7\u6C42\u95F4\u7559\u51FA\u547C\u5438\u7A7A\u95F4\r\nconst sleep = ms => new Promise(resolve => setTimeout(resolve, ms));\r\n\r\n// \u83B7\u53D6\u9876\u90E8\u9884\u52A0\u8F7D\u8FDB\u5EA6\u6761\u76F8\u5173\u7684 DOM \u5143\u7D20\r\nconst getPrefetchElements = () => {\r\n  const $ = get$();\r\n  const parentDoc = getParentDoc();\r\n  if (!$ || !parentDoc) return {};\r\n  const $indicator = $(`#${PREFETCH_INDICATOR_ID}`, parentDoc);\r\n  if (!$indicator.length) return {};\r\n  const $text = $indicator.find(`#${PREFETCH_PROGRESS_TEXT_ID}`);\r\n  const $bar = $indicator.find(`#${PREFETCH_PROGRESS_BAR_ID}`);\r\n  const $barContainer = $indicator.find('.rlh-prefetch-bar');\r\n  return { $indicator, $text, $bar, $barContainer };\r\n};\r\n\r\nconst setPrefetchIndicatorVisibility = visible => {\r\n  const { $indicator, $bar, $barContainer } = getPrefetchElements();\r\n  if (!$indicator) return;\r\n  $indicator.attr('data-visible', visible ? 'true' : 'false');\r\n  $indicator.attr('aria-hidden', visible ? 'false' : 'true');\r\n  if (!visible) {\r\n    if ($bar?.length) $bar.css('width', '0%');\r\n    if ($barContainer?.length) $barContainer.attr('aria-valuenow', 0);\r\n  }\r\n};\r\n\r\nconst updatePrefetchIndicatorContent = (current, total) => {\r\n  const { $indicator, $text, $bar, $barContainer } = getPrefetchElements();\r\n  if (!$indicator) return;\r\n  const safeTotal = total > 0 ? total : 1;\r\n  const clamped = Math.min(current, total);\r\n  const percent = Math.round((clamped / safeTotal) * 100);\r\n  const message = `\u540E\u53F0\u52A0\u8F7D\u4E16\u754C\u4E66 (${clamped}/${total})\uFF0C\u4E0D\u5F71\u54CD\u5176\u4ED6\u64CD\u4F5C`;\r\n  if ($text?.length) $text.text(message);\r\n  if ($bar?.length) $bar.css('width', `${Math.min(percent, 100)}%`);\r\n  if ($barContainer?.length) $barContainer.attr('aria-valuenow', Math.min(percent, 100));\r\n};\r\n\r\nconst hidePrefetchIndicator = () => {\r\n  setPrefetchIndicatorVisibility(false);\r\n};\r\n\r\n// \u6839\u636E\u52A0\u8F7D\u7ED3\u679C\u5373\u65F6\u5237\u65B0\u5217\u8868\u4E2D\u7684\u6761\u76EE\u7EDF\u8BA1\r\nconst updateGlobalBookStatsDisplay = bookName => {\r\n  const $ = get$();\r\n  const parentDoc = getParentDoc();\r\n  if (!$ || !parentDoc) return;\r\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\r\n  if (!$panel.length) return;\r\n  const $group = $panel.find('.rlh-book-group').filter((_, el) => $(el).data('book-name') === bookName);\r\n  if (!$group.length) return;\r\n  const book = appState.allLorebooks.find(b => b.name === bookName);\r\n  if (!book) return;\r\n  $group.find('.rlh-book-stats').text(`\u6761\u76EE: ${book.enabledEntryCount} / ${book.entryCount}`);\r\n};\r\n\r\nconst showPrefetchIndicator = total => {\r\n  if (total <= 0) {\r\n    hidePrefetchIndicator();\r\n    return;\r\n  }\r\n  setPrefetchIndicatorVisibility(true);\r\n  updatePrefetchIndicatorContent(0, total);\r\n};\r\n\r\n// \u540E\u53F0\u9010\u672C\u52A0\u8F7D\u5168\u5C40\u4E16\u754C\u4E66\u6761\u76EE\uFF0C\u4EE5\u586B\u5145\u7EDF\u8BA1\u6570\u636E\uFF0C\u4E0D\u963B\u585E\u4E3B\u754C\u9762\r\nexport const prefetchGlobalBookSummaries = errorCatched(async () => {\r\n  if (isPrefetchingGlobalSummaries) return;\r\n  const booksToPrefetch = appState.allLorebooks.filter(book => !book.entriesLoaded);\r\n  if (booksToPrefetch.length === 0) {\r\n    hidePrefetchIndicator();\r\n    return;\r\n  }\r\n\r\n  isPrefetchingGlobalSummaries = true;\r\n  showPrefetchIndicator(booksToPrefetch.length);\r\n\r\n  try {\r\n    let completed = 0;\r\n    const queue = [...booksToPrefetch];\r\n\r\n    const worker = async () => {\r\n      while (queue.length > 0) {\r\n        const book = queue.shift();\r\n        if (!book) break;\r\n\r\n        try {\r\n          await loadLorebookEntriesIfNeeded(book.name);\r\n          updateGlobalBookStatsDisplay(book.name);\r\n        } finally {\r\n          completed += 1;\r\n          updatePrefetchIndicatorContent(completed, booksToPrefetch.length);\r\n        }\r\n\r\n        await sleep(30);\r\n      }\r\n    };\r\n\r\n    // \u4F7F\u7528\u6709\u9650\u5E76\u53D1\uFF0C\u907F\u514D\u4E00\u6B21\u6027\u89E6\u53D1\u8FC7\u591A API \u8BF7\u6C42\r\n    const workerCount = Math.min(PREFETCH_MAX_CONCURRENCY, queue.length);\r\n    await Promise.all(Array.from({ length: workerCount }, () => worker()));\r\n  } finally {\r\n    await sleep(260);\r\n    hidePrefetchIndicator();\r\n    isPrefetchingGlobalSummaries = false;\r\n  }\r\n});\r\n\r\nexport const refreshCharacterData = errorCatched(async () => {\r\n  // \u68C0\u67E5\u662F\u5426\u6709\u6D3B\u8DC3\u7684\u804A\u5929\r\n  const parentWin = getParentWin();\r\n  const context = parentWin.SillyTavern?.getContext?.() || {};\r\n  const hasActiveChat = context.chatId !== undefined && context.chatId !== null;\r\n\r\n  const promises = [TavernAPI.getCharData(), TavernAPI.getCurrentCharWorldbookNames(), TavernAPI.getRegexes()];\r\n\r\n  // \u53EA\u6709\u5728\u6709\u6D3B\u8DC3\u804A\u5929\u65F6\u624D\u83B7\u53D6\u804A\u5929\u4E16\u754C\u4E66\r\n  if (hasActiveChat) {\r\n    promises.push(\r\n      TavernAPI.getChatWorldbookName().catch(error => {\r\n        console.warn('[RegexLoreHub] Failed to get chat worldbook in refreshCharacterData:', error);\r\n        return null;\r\n      }),\r\n    );\r\n  } else {\r\n    promises.push(Promise.resolve(null));\r\n  }\r\n\r\n  const [charData, charBooks, allUIRegexes, chatWorldbook] = await Promise.all(promises);\r\n\r\n  updateCharacterRegexes(allUIRegexes, charData);\r\n  syncContextWithAppState({ charData }); // \u5237\u65B0\u65F6\u8865\u9F50\u89D2\u8272\u540D\u79F0\r\n  updateCharacterLorebooks(charBooks);\r\n  appState.chatLorebook = chatWorldbook;\r\n  const newBooksToLoad = appState.lorebooks.character.filter(name => !safeHasLorebookEntries(name));\r\n  if (newBooksToLoad.length > 0) {\r\n    await Promise.all(\r\n      newBooksToLoad.map(async name => {\r\n        const entries = await TavernAPI.getWorldbook(name); // \u4F7F\u7528\u65B0\u7684API\r\n        safeSetLorebookEntries(name, entries.map(normalizeWorldbookEntry));\r\n      }),\r\n    );\r\n  }\r\n});\r\n\r\nexport function updateCharacterRegexes(allUIRegexes, charData) {\r\n  const characterUIRegexes = allUIRegexes?.filter(r => r.scope === 'character') || [];\r\n  let cardRegexes = [];\r\n  if (charData && TavernAPI.Character) {\r\n    try {\r\n      const character = new TavernAPI.Character(charData);\r\n      cardRegexes = (character.getRegexScripts() || []).map((r, i) => ({\r\n        id: r.id || `card-${Date.now()}-${i}`,\r\n        script_name: r.scriptName || '\u672A\u547D\u540D\u5361\u5185\u6B63\u5219',\r\n        find_regex: r.findRegex,\r\n        replace_string: r.replaceString,\r\n        enabled: !r.disabled,\r\n        scope: 'character',\r\n        source: 'card',\r\n      }));\r\n    } catch (e) {\r\n      console.warn('\u65E0\u6CD5\u89E3\u6790\u89D2\u8272\u5361\u6B63\u5219\u811A\u672C:', e);\r\n    }\r\n  }\r\n  const uiRegexIdentifiers = new Set(\r\n    characterUIRegexes.map(r => `${r.script_name}::${r.find_regex}::${r.replace_string}`),\r\n  );\r\n  const uniqueCardRegexes = cardRegexes.filter(r => {\r\n    const identifier = `${r.script_name}::${r.find_regex}::${r.replace_string}`;\r\n    return !uiRegexIdentifiers.has(identifier);\r\n  });\r\n  appState.regexes.character = [...characterUIRegexes, ...uniqueCardRegexes];\n  updateRegexOrderMetadata(appState.regexes.character);\n}\n\r\nexport function updateCharacterLorebooks(charBooks) {\r\n  let characterBookNames = [];\r\n  if (charBooks) {\r\n    if (charBooks.primary) characterBookNames.push(charBooks.primary);\r\n    if (charBooks.additional) characterBookNames.push(...charBooks.additional);\r\n  }\r\n  appState.lorebooks.character = [...new Set(characterBookNames)];\r\n}\r\n\r\n/**\r\n * \u8BA1\u7B97\u5E76\u66F4\u65B0\u6307\u5B9A\u4E16\u754C\u4E66\u7684\u6761\u76EE\u603B\u6570\u548C\u542F\u7528\u6761\u76EE\u6570\u3002\r\n * @param {string} bookName - \u8981\u66F4\u65B0\u7684\u4E16\u754C\u4E66\u7684\u540D\u79F0\u3002\r\n */\r\nexport const updateBookSummary = bookName => {\r\n  const entries = safeGetLorebookEntries(bookName);\r\n  const book = appState.allLorebooks.find(b => b.name === bookName);\r\n  if (book) {\r\n    book.entryCount = entries.length;\r\n    book.enabledEntryCount = entries.filter(entry => entry.enabled).length;\r\n  }\r\n};\r\n\r\n/**\r\n * \u5728\u5185\u5B58\u4E2D\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684 Lorebook entry \u5BF9\u8C61\uFF0C\u5E76\u5C06\u5176\u6DFB\u52A0\u5230 appState \u7684\u6761\u76EE\u5217\u8868\u9876\u90E8\u3002\r\n * @param {string} bookName - \u6240\u5C5E\u4E16\u754C\u4E66\u7684\u540D\u79F0\u3002\r\n * @returns {object} \u65B0\u521B\u5EFA\u7684\u4E34\u65F6 entry \u5BF9\u8C61\u3002\r\n */\r\nexport const createInMemoryEntry = bookName => {\r\n  const newEntry = {\r\n    uid: `temp-${Date.now()}`, // \u4E34\u65F6\u552F\u4E00ID\r\n    name: '\u65B0\u6761\u76EE',\r\n    comment: '',\r\n    content: '',\r\n    keys: [],\r\n    key: [],\r\n    keysecondary: [],\r\n    enabled: true,\r\n    disable: false,\r\n    is_temp: true, // \u6807\u8BB0\u4E3A\u4E34\u65F6\u6761\u76EE\r\n    // \u6839\u636E WorldbookEntry \u7C7B\u578B\u5B9A\u4E49\u6DFB\u52A0\u5176\u4ED6\u9ED8\u8BA4\u5B57\u6BB5\r\n    selective: true,\r\n    selectiveLogic: LOGIC_STRING_TO_ENUM.and_any,\r\n    logic: 'and_any',\r\n    constant: false,\r\n    position: 'before_character_definition',\r\n    depth: null,\r\n    order: 0,\r\n    probability: 100,\r\n    useProbability: false,\r\n    case_sensitive: false,\r\n    match_whole_words: false,\r\n    prevent_recursion: false,\r\n    exclude_recursion: false,\r\n  };\r\n\r\n  const entries = safeGetLorebookEntries(bookName);\r\n  entries.unshift(newEntry);\r\n  safeSetLorebookEntries(bookName, entries);\r\n\r\n  return newEntry;\r\n};\r\n\r\n/**\r\n * \u4F7F\u7528\u4ECE\u670D\u52A1\u5668\u83B7\u53D6\u7684\u771F\u5B9E\u6570\u636E\u66F4\u65B0\u5185\u5B58\u4E2D\u7684\u4E34\u65F6 entry\u3002\r\n * @param {string} bookName - \u6240\u5C5E\u4E16\u754C\u4E66\u7684\u540D\u79F0\u3002\r\n * @param {string} tempId - \u8981\u66F4\u65B0\u7684\u6761\u76EE\u7684\u4E34\u65F6ID\u3002\r\n * @param {object} serverData - \u4ECE\u670D\u52A1\u5668\u8FD4\u56DE\u7684\u771F\u5B9E entry \u6570\u636E\u3002\r\n */\r\nexport const updateInMemoryEntry = (bookName, tempId, serverData) => {\r\n  const entries = safeGetLorebookEntries(bookName);\r\n  const entryIndex = entries.findIndex(e => e.uid === tempId);\r\n\r\n  if (entryIndex !== -1) {\r\n    // \u5408\u5E76\u670D\u52A1\u5668\u6570\u636E\uFF0C\u540C\u65F6\u79FB\u9664\u4E34\u65F6\u6807\u8BB0\r\n    const normalizedServerData = normalizeWorldbookEntry(serverData);\r\n    const updatedEntry = { ...entries[entryIndex], ...normalizedServerData, is_temp: false };\r\n    entries[entryIndex] = updatedEntry;\r\n    safeSetLorebookEntries(bookName, entries);\r\n    migratePendingLorebookUpdate(bookName, tempId, updatedEntry.uid);\r\n  } else {\r\n    console.warn(`[RegexLoreHub] \u5728\u66F4\u65B0\u65F6\u627E\u4E0D\u5230\u4E34\u65F6\u6761\u76EE: ${tempId}`);\r\n  }\r\n};\r\n/**\r\n * \u6309\u9700\u52A0\u8F7D\u6307\u5B9A\u4E16\u754C\u4E66\u7684\u6761\u76EE\uFF0C\u5982\u679C\u5C1A\u672A\u52A0\u8F7D\u6216\u9700\u8981\u5F3A\u5236\u5237\u65B0\u3002\r\n * @param {string} bookName - \u8981\u52A0\u8F7D\u6761\u76EE\u7684\u4E16\u754C\u4E66\u540D\u79F0\u3002\r\n * @param {boolean} [force=false] - \u662F\u5426\u5F3A\u5236\u91CD\u65B0\u52A0\u8F7D\uFF0C\u5373\u4F7F\u7528\u6237\u6570\u636E\u5DF2\u5B58\u5728\u3002\r\n */\r\nexport const loadLorebookEntriesIfNeeded = errorCatched(async (bookName, force = false) => {\r\n  const book = appState.allLorebooks.find(b => b.name === bookName);\r\n\r\n  // \u4F7F\u7528 safeHasLorebookEntries \u68C0\u67E5\u771F\u5B9E\u6570\u636E\u662F\u5426\u5B58\u5728\uFF0C\u800C\u4E0D\u662F\u4F9D\u8D56\u53EF\u80FD\u88AB\u9884\u53D6\u884C\u4E3A\u6C61\u67D3\u7684 entriesLoaded \u6807\u5FD7\r\n  if (!book || (safeHasLorebookEntries(bookName) && !force)) {\r\n    return;\r\n  }\r\n\r\n  try {\r\n    let entries = await TavernAPI.getWorldbook(bookName);\r\n\r\n    // \u7EDF\u4E00\u5F52\u4E00\u5316\u5B57\u6BB5\uFF0C\u517C\u5BB9\u65B0\u65E7\u4E16\u754C\u4E66\u7ED3\u6784\r\n    entries = entries.map(normalizeWorldbookEntry);\r\n\r\n    safeSetLorebookEntries(bookName, entries);\r\n    book.entriesLoaded = true;\r\n    updateBookSummary(bookName);\r\n  } catch (error) {\r\n    console.error(`[RegexLoreHub] Failed to load entries for worldbook \"${bookName}\":`, error);\r\n    // \u5373\u4F7F\u5931\u8D25\uFF0C\u4E5F\u6807\u8BB0\u4E3A\u5DF2\u52A0\u8F7D\uFF0C\u4EE5\u907F\u514D\u91CD\u590D\u5C1D\u8BD5\uFF0C\u9664\u975E\u7528\u6237\u624B\u52A8\u5237\u65B0\r\n    book.entriesLoaded = true;\r\n    // \u53EF\u4EE5\u9009\u62E9\u5728\u8FD9\u91CC\u8BBE\u7F6E\u4E00\u4E2A\u9519\u8BEF\u72B6\u6001\r\n  }\r\n});\r\n\r\n/**\r\n * \u7EDF\u4E00\u7684\u4FDD\u5B58\u51FD\u6570\uFF0C\u8D1F\u8D23\u5C06\u6240\u6709\u5F85\u529E\u7684\u4FEE\u6539\uFF08\u5982\u4E16\u754C\u4E66\u6761\u76EE\u3001\u6B63\u5219\u7B49\uFF09\u4E00\u6B21\u6027\u63D0\u4EA4\u3002\r\n * \u5185\u7F6E\u4E86UI\u72B6\u6001\u66F4\u65B0\u548C\u81EA\u52A8\u91CD\u8BD5\u903B\u8F91\u3002\r\n */\r\nexport const saveAllChanges = errorCatched(async (options = {}) => {\r\n  const { silent = false } = options;\r\n  const MAX_RETRIES = 3;\r\n  const RETRY_DELAY = 3000; // 3\u79D2\r\n\r\n  let attempts = 0;\r\n\r\n  const delay = ms => new Promise(resolve => setTimeout(resolve, ms));\r\n\r\n  const triggerUIUpdate = () => {\r\n    if (silent) renderSaveStatus();\r\n    else renderContent();\r\n  };\r\n\r\n  const flushLorebookUpdates = async () => {\r\n    if (!(appState.pendingLorebookUpdates instanceof Map)) {\r\n      appState.pendingLorebookUpdates = new Map();\r\n      return false;\r\n    }\r\n\r\n    let didSave = false;\r\n\r\n    for (const [bookName, updatesMap] of [...appState.pendingLorebookUpdates.entries()]) {\r\n      if (!(updatesMap instanceof Map) || updatesMap.size === 0) continue;\r\n\r\n      const payload = [];\r\n      const processedKeys = [];\r\n\r\n      for (const [key, record] of updatesMap.entries()) {\r\n        const uid = record?.uid;\r\n        if (typeof uid !== 'number' || Number.isNaN(uid)) continue;\r\n\r\n        const data = record?.data;\r\n        if (!data || Object.keys(data).length === 0) {\r\n          processedKeys.push(key);\r\n          continue;\r\n        }\r\n\r\n        payload.push({ uid, ...data });\r\n        processedKeys.push(key);\r\n      }\r\n\r\n      if (payload.length === 0) {\r\n        processedKeys.forEach(k => updatesMap.delete(k));\r\n        if (updatesMap.size === 0) {\r\n          appState.pendingLorebookUpdates.delete(bookName);\r\n        }\r\n        continue;\r\n      }\r\n\r\n      const result = await updateWorldbookEntries(bookName, payload);\r\n      if (result) {\r\n        didSave = true;\r\n        processedKeys.forEach(k => updatesMap.delete(k));\r\n        if (updatesMap.size === 0) {\r\n          appState.pendingLorebookUpdates.delete(bookName);\r\n        }\r\n      }\r\n    }\r\n\r\n    return didSave;\r\n  };\r\n\r\n  const flushRegexUpdates = async () => {\r\n    if (!(appState.pendingRegexUpdates instanceof Set)) {\r\n      appState.pendingRegexUpdates = new Set();\r\n      return false;\r\n    }\r\n    if (appState.pendingRegexUpdates.size === 0) {\r\n      return false;\r\n    }\r\n\r\n    updateRegexOrderMetadata(appState.regexes.global);\n    updateRegexOrderMetadata(appState.regexes.character);\n    const allRegexes = [...appState.regexes.global, ...appState.regexes.character];\n    await TavernAPI.replaceRegexes(allRegexes.filter(r => r.source !== 'card'));\n    await TavernAPI.saveSettings();\r\n    appState.pendingRegexUpdates.clear();\r\n    return true;\r\n  };\r\n\r\n  const performSave = async () => {\r\n    console.log('[RegexLoreHub] \u6267\u884C\u7EDF\u4E00\u4FDD\u5B58\u64CD\u4F5C...');\r\n    const loreSaved = await flushLorebookUpdates();\r\n    const regexSaved = await flushRegexUpdates();\r\n    if (!loreSaved && !regexSaved) {\r\n      console.log('[RegexLoreHub] \u6CA1\u6709\u5F85\u4FDD\u5B58\u7684\u66F4\u6539\u3002');\r\n    } else {\r\n      console.log('[RegexLoreHub] \u4FDD\u5B58\u64CD\u4F5C\u5B8C\u6210\u3002');\r\n    }\r\n    return true;\r\n  };\r\n\r\n  while (attempts < MAX_RETRIES) {\r\n    try {\r\n      appState.saveRetryAttempt = attempts + 1;\r\n      appState.saveStatus = attempts === 0 ? 'saving' : 'retrying';\r\n      triggerUIUpdate();\r\n\r\n      await performSave();\r\n\r\n      appState.saveStatus = 'success';\r\n      appState.saveRetryAttempt = 0;\r\n      triggerUIUpdate();\r\n\r\n      await delay(1500);\r\n      appState.saveStatus = 'idle';\r\n      triggerUIUpdate();\r\n\r\n      console.log('[RegexLoreHub] \u6240\u6709\u66F4\u6539\u5DF2\u6210\u529F\u4FDD\u5B58\u3002');\r\n      return;\r\n    } catch (error) {\r\n      attempts++;\r\n      console.error(`[RegexLoreHub] \u4FDD\u5B58\u5931\u8D25\uFF0C\u5C1D\u8BD5\u6B21\u6570 ${attempts}/${MAX_RETRIES}:`, error);\r\n\r\n      if (attempts >= MAX_RETRIES) {\r\n        appState.saveStatus = 'failed';\r\n        triggerUIUpdate();\r\n        console.error('[RegexLoreHub] \u6240\u6709\u91CD\u8BD5\u5747\u5931\u8D25\uFF0C\u5DF2\u505C\u6B62\u4FDD\u5B58\u3002');\r\n        throw new Error('\u81EA\u52A8\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u8FDE\u63A5\u6216\u624B\u52A8\u4FDD\u5B58\u3002');\r\n      }\r\n\r\n      await delay(RETRY_DELAY);\r\n    }\r\n  }\r\n});\r\n\r\n/**\r\n * \u540C\u6B65 SillyTavern \u7684\u4E0A\u4E0B\u6587\u4FE1\u606F\u5230 appState\u3002\r\n * \u8FD9\u662F\u786E\u4FDDUI\u5C42\u603B\u80FD\u83B7\u53D6\u5230\u6700\u65B0\u3001\u6700\u53EF\u9760\u89D2\u8272\u4FE1\u606F\u7684\u5173\u952E\u3002\r\n */\r\nconst normalizeCharacterName = value => {\r\n  if (typeof value !== 'string') return null;\r\n  const trimmed = value.trim();\r\n  return trimmed.length > 0 ? trimmed : null;\r\n};\r\n\r\nconst extractNameFromCharacter = character => {\r\n  if (!character || typeof character !== 'object') return null;\r\n  return (\r\n    normalizeCharacterName(character.name) ||\r\n    normalizeCharacterName(character.display_name) ||\r\n    normalizeCharacterName(character.title) ||\r\n    normalizeCharacterName(character.metadata?.name) ||\r\n    normalizeCharacterName(character.filename) ||\r\n    normalizeCharacterName(character.external_id)\r\n  );\r\n};\r\n\r\nconst extractNameFromCharData = data => {\r\n  if (!data || typeof data !== 'object') return null;\r\n  return (\r\n    normalizeCharacterName(data.name) ||\r\n    normalizeCharacterName(data.char_name) ||\r\n    normalizeCharacterName(data.display_name) ||\r\n    normalizeCharacterName(data.metadata?.name) ||\r\n    normalizeCharacterName(data.data?.name) ||\r\n    normalizeCharacterName(data.data?.char_name) ||\r\n    normalizeCharacterName(data.data?.display_name)\r\n  );\r\n};\r\n\r\nconst matchCharacterById = (character, targetId) => {\r\n  if (!character || targetId === undefined || targetId === null) return false;\r\n  const normalizedTarget = String(targetId);\r\n  const candidateIds = [\r\n    character.id,\r\n    character.characterId,\r\n    character.metadata?.characterId,\r\n    character.metadata?.id,\r\n    character.external_id,\r\n    character.filename,\r\n  ].map(value => (value === undefined || value === null ? null : String(value)));\r\n  return candidateIds.some(id => id && id === normalizedTarget);\r\n};\r\n\r\nexport const syncContextWithAppState = ({ charData = null } = {}) => {\r\n  const parentWin = getParentWin();\r\n  const context = parentWin.SillyTavern?.getContext?.() || {};\r\n  const characters = Array.isArray(context.characters) ? context.characters : [];\r\n  const characterId =\r\n    context.characterId !== undefined && context.characterId !== null ? context.characterId : null;\r\n\r\n  // \u4F18\u5148\u4F7F\u7528\u4E0A\u4E0B\u6587\u63D0\u4F9B\u7684\u89D2\u8272\u540D\r\n  let characterName =\r\n    normalizeCharacterName(context.name) ||\r\n    extractNameFromCharacter(context.character);\r\n\r\n  // \u6839\u636E\u89D2\u8272ID\u5728\u89D2\u8272\u5217\u8868\u4E2D\u67E5\u627E\u540D\u79F0\r\n  if (!characterName && characterId !== null) {\r\n    const matchedCharacter = characters.find(char => matchCharacterById(char, characterId));\r\n    if (matchedCharacter) {\r\n      characterName = extractNameFromCharacter(matchedCharacter);\r\n    }\r\n  }\r\n\r\n  // \u5982\u679C\u5DF2\u7ECF\u62FF\u5230\u89D2\u8272\u6570\u636E\uFF0C\u5C1D\u8BD5\u4ECE\u89D2\u8272\u6570\u636E\u4E2D\u63D0\u53D6\u540D\u79F0\r\n  if (!characterName && charData) {\r\n    characterName = extractNameFromCharData(charData);\r\n  }\r\n\r\n  // \u515C\u5E95\uFF1A\u4EC5\u6709\u4E00\u4E2A\u89D2\u8272\u65F6\u76F4\u63A5\u4F7F\u7528\u5176\u540D\u79F0\r\n  if (!characterName && characters.length === 1) {\r\n    characterName = extractNameFromCharacter(characters[0]);\r\n  }\r\n\r\n  appState.characterContext.name = characterName ?? null;\r\n  appState.characterContext.id = characterId;\r\n  console.log('[RegexLoreHub] Context synced with appState:', appState.characterContext);\r\n};\r\n", "import {\r\n  appState,\r\n  safeGetLorebookEntries,\r\n  safeDeleteLorebookEntries,\r\n  errorCatched,\r\n  showModal,\r\n  showToast,\r\n  showProgressToast,\r\n  get$,\r\n  getParentDoc,\r\n  getParentWin,\r\n  POSITION_MENU_ID,\r\n  POSITION_MENU_BUTTON_ID,\r\n  LOREBOOK_OPTIONS,\r\n} from '../../core.js';\r\n\r\nimport {\r\n  TavernAPI,\r\n  loadAllData,\r\n  loadLorebookEntriesIfNeeded,\r\n  updateBookSummary,\r\n  updateWorldbookEntries, // \u5BFC\u5165\u65B0\u7684\u66F4\u65B0\u51FD\u6570\r\n} from '../../dataLayer.js';\r\n\r\nimport { renderContent, getViewContext } from '../render/index.js';\r\n\r\n// --- \u4E16\u754C\u4E66\u4E8B\u4EF6\u5904\u7406 ---\r\nexport function createLorebookHandlers(deps = {}) {\r\n  const $ = deps.$ ?? get$();\r\n  const parentDoc = deps.parentDoc ?? getParentDoc();\r\n  const parentWin = deps.parentWin ?? getParentWin();\r\n  const refreshLorebookData = async (bookName, { showLoading = true } = {}) => {\r\n    const targetName = (bookName ?? '').toString().trim();\r\n    if (!targetName) return;\r\n    const previousLoading = appState.loadingBookName;\r\n    try {\r\n      if (showLoading) {\r\n        appState.loadingBookName = targetName;\r\n        renderContent();\r\n      }\r\n      await loadLorebookEntriesIfNeeded(targetName, true);\r\n    } finally {\r\n      appState.loadingBookName = previousLoading && previousLoading !== targetName ? previousLoading : null;\r\n      renderContent();\r\n    }\r\n  };\r\n\r\n  const handleEnterLorebookDetail = errorCatched(async (bookName) => {\r\n    appState.activeView = 'global-lore-detail';\r\n    appState.activeBookName = bookName;\r\n\r\n    // \u5F3A\u5236\u663E\u793A\u52A0\u8F7D\u72B6\u6001\uFF0C\u907F\u514D\u7ADE\u6001\u6761\u4EF6\r\n    appState.loadingBookName = bookName;\r\n    renderContent(); // \u7ACB\u5373\u6E32\u67D3\u4EE5\u663E\u793A\u52A0\u8F7D\u72B6\u6001\r\n\r\n    await loadLorebookEntriesIfNeeded(bookName);\r\n\r\n    appState.loadingBookName = null;\r\n    renderContent(); // \u518D\u6B21\u6E32\u67D3\u4EE5\u663E\u793A\u52A0\u8F7D\u540E\u7684\u5185\u5BB9\r\n  });\r\n\r\n\r\n  const handleExitLorebookDetail = errorCatched(async () => {\r\n    appState.activeView = 'global-lore-list';\r\n    appState.activeBookName = null;\r\n\r\n    // \u91CD\u7F6E\u72B6\u6001\r\n    appState.selectedItems.clear();\r\n    appState.globalSearch = { term: '', replace: '' };\r\n\r\n    // \u6E05\u7A7AUI\u8F93\u5165\r\n    const $searchInput = $(`#${'rlh-global-search-input'}`, parentDoc);\r\n    if ($searchInput.length) {\r\n      $searchInput.val('');\r\n    }\r\n\r\n    renderContent();\r\n  });\r\n\r\n\r\n  const updateLinkedCharacters = errorCatched(async (oldBookName, newBookName, progressToast) => {\r\n  const linkedChars = appState.lorebookUsage.get(oldBookName) || [];\r\n  if (linkedChars.length === 0) return;\r\n\r\n  const context = parentWin.SillyTavern.getContext();\r\n  const originalCharId = context.characterId;\r\n  let processedCount = 0;\r\n  const totalCount = linkedChars.length;\r\n  progressToast.update(`\u6B63\u5728\u66F4\u65B0 ${totalCount} \u4E2A\u5173\u8054\u89D2\u8272... (0/${totalCount})`);\r\n\r\n  for (const charName of linkedChars) {\r\n    try {\r\n      // \u4F7F\u7528\u6B63\u786E\u7684\u65B9\u6CD5\u83B7\u53D6\u89D2\u8272\u7D22\u5F15\r\n      const charIndex =\r\n        parentWin.Character?.findCharacterIndex?.(charName) ??\r\n        context.characters.findIndex(c => c.name === charName);\r\n      if (charIndex === -1) {\r\n        console.warn(`[RegexLoreHub] Character \"${charName}\" not found, skipping...`);\r\n        continue;\r\n      }\r\n\r\n      console.log(`[RegexLoreHub] Switching to character \"${charName}\" (index: ${charIndex})`);\r\n      await context.selectCharacterById(charIndex);\r\n\r\n      const charBooks = await TavernAPI.getCharWorldbookNames({ name: charName });\r\n      if (!charBooks) {\r\n        console.warn(`[RegexLoreHub] Failed to get worldbooks for character \"${charName}\"`);\r\n        continue;\r\n      }\r\n\r\n      console.log(`[RegexLoreHub] Current worldbooks for \"${charName}\":`, charBooks);\r\n      let updated = false;\r\n      if (charBooks.primary === oldBookName) {\r\n        console.log(`[RegexLoreHub] Updating primary lorebook from \"${oldBookName}\" to \"${newBookName}\"`);\r\n        charBooks.primary = newBookName;\r\n        updated = true;\r\n      }\r\n      if (charBooks.additional) {\r\n        const index = charBooks.additional.indexOf(oldBookName);\r\n        if (index > -1) {\r\n          console.log(\r\n            `[RegexLoreHub] Updating additional lorebook at index ${index} from \"${oldBookName}\" to \"${newBookName}\"`,\r\n          );\r\n          charBooks.additional[index] = newBookName;\r\n          updated = true;\r\n        }\r\n      }\r\n\r\n      if (updated) {\r\n        console.log(`[RegexLoreHub] Saving updated lorebooks for \"${charName}\":`, charBooks);\r\n        await TavernAPI.rebindCharWorldbooks(charBooks);\r\n        console.log(`[RegexLoreHub] Successfully updated lorebooks for \"${charName}\"`);\r\n      } else {\r\n        console.log(`[RegexLoreHub] No updates needed for character \"${charName}\"`);\r\n      }\r\n    } catch (charError) {\r\n      console.error(`[RegexLoreHub] Failed to update lorebook for character \"${charName}\":`, charError);\r\n    }\r\n    processedCount++;\r\n    progressToast.update(`\u6B63\u5728\u66F4\u65B0 ${totalCount} \u4E2A\u5173\u8054\u89D2\u8272... (${processedCount}/${totalCount})`);\r\n  }\r\n\r\n  if (context.characterId !== originalCharId) {\r\n    await context.selectCharacterById(originalCharId);\r\n  }\r\n  });\r\n\r\n\r\n\r\n  const handleRenameBook = errorCatched(async event => {\r\n  event.stopPropagation();\r\n  const $trigger = $(event.currentTarget);\r\n  const $bookSource = $trigger.closest('.rlh-book-group, .rlh-detail-view');\r\n  const isDetailView = $bookSource.hasClass('rlh-detail-view');\r\n  const oldName = $bookSource.data('book-name') || appState.activeBookName;\r\n  if (!oldName) return;\r\n\r\n  let newName;\r\n  try {\r\n    newName = await showModal({\r\n      type: 'prompt',\r\n      title: '\u91CD\u547D\u540D\u4E16\u754C\u4E66',\r\n      text: '\u8BF7\u8F93\u5165\u65B0\u7684\u4E16\u754C\u4E66\u540D\u79F0\uFF1A',\r\n      value: oldName,\r\n    });\r\n  } catch {\r\n    return; // User cancelled\r\n  }\r\n\r\n  newName = newName.trim();\r\n  if (!newName || newName === oldName) {\r\n    return;\r\n  }\r\n\r\n  if (appState.allLorebooks.some(b => b.name === newName)) {\r\n    await showModal({ type: 'alert', title: '\u91CD\u547D\u540D\u5931\u8D25', text: '\u8BE5\u540D\u79F0\u7684\u4E16\u754C\u4E66\u5DF2\u5B58\u5728\uFF0C\u8BF7\u9009\u62E9\u5176\u4ED6\u540D\u79F0\u3002' });\r\n    return;\r\n  }\r\n\r\n  const linkedCharacters = appState.lorebookUsage.get(oldName) || [];\r\n  const isChatLinked = appState.chatLorebook === oldName;\r\n  const chatCount = isChatLinked ? 1 : 0;\r\n  const totalBindings = linkedCharacters.length + chatCount;\r\n\r\n  console.log(\r\n    `[RegexLoreHub] Renaming lorebook \"${oldName}\" to \"${newName}\", linked characters:`,\r\n    linkedCharacters,\r\n    'chat linked:',\r\n    isChatLinked,\r\n  );\r\n\r\n  let confirmText = `\u6B64\u64CD\u4F5C\u5C06\u66F4\u65B0 ${totalBindings} \u4E2A\u7ED1\u5B9A\u5173\u7CFB`;\r\n  if (linkedCharacters.length > 0) {\r\n    confirmText += `\uFF0C\u9700\u8981\u4E34\u65F6\u5207\u6362\u5230 ${linkedCharacters.length} \u4E2A\u5173\u8054\u89D2\u8272\u5361\u6765\u66F4\u65B0\u4E16\u754C\u4E66\u94FE\u63A5`;\r\n  }\r\n  confirmText += `\uFF0C\u671F\u95F4\u8BF7\u52FF\u64CD\u4F5C\u3002\\n\\n`;\r\n\r\n  if (linkedCharacters.length > 0) {\r\n    confirmText += `\u5173\u8054\u89D2\u8272\u5361\uFF1A${linkedCharacters.join(', ')}\\n`;\r\n  }\r\n  if (isChatLinked) {\r\n    confirmText += `\u5173\u8054\u804A\u5929\uFF1A\u5F53\u524D\u804A\u5929\\n`;\r\n  }\r\n\r\n  // \u5728\u5168\u5C40\u4E16\u754C\u4E66\u9875\u9762\u6DFB\u52A0API\u9650\u5236\u63D0\u793A\r\n  if (appState.activeTab === 'global-lore') {\r\n    confirmText += `\\n\u26A0\uFE0F \u91CD\u8981\u63D0\u793A\uFF1A\u7531\u4E8ESillyTavern API\u9650\u5236\uFF0C\u65E0\u6CD5\u76F4\u63A5\u5217\u51FA\u6240\u6709*\u804A\u5929\u4E16\u754C\u4E66*\u7ED1\u5B9A\u3002\u5982\u679C\u6B64\u4E16\u754C\u4E66\u4E0E*\u804A\u5929*\u7ED1\u5B9A\uFF0C\u91CD\u547D\u540D\u540E\u9700\u8981\u624B\u52A8\u68C0\u67E5\u90A3\u4E9B\u804A\u5929\u7ED1\u5B9A\u72B6\u6001\u3002\\n`;\r\n  }\r\n\r\n  confirmText += `\\n\u662F\u5426\u7EE7\u7EED\uFF1F`;\r\n\r\n  try {\r\n    await showModal({\r\n      type: 'confirm',\r\n      title: '\u786E\u8BA4\u91CD\u547D\u540D',\r\n      text: confirmText,\r\n    });\r\n  } catch {\r\n    return; // User cancelled\r\n  }\r\n\r\n  const progressToast = showProgressToast('\u5F00\u59CB\u91CD\u547D\u540D...');\r\n  try {\r\n    progressToast.update('\u6B63\u5728\u521B\u5EFA\u65B0\u4E16\u754C\u4E66...');\r\n    const createSuccess = await TavernAPI.createWorldbook(newName);\r\n    if (!createSuccess) {\r\n      throw new Error('\u521B\u5EFA\u65B0\u4E16\u754C\u4E66\u6587\u4EF6\u5931\u8D25\u3002');\r\n    }\r\n\r\n    const oldEntries = [...safeGetLorebookEntries(oldName)];\r\n    if (oldEntries.length > 0) {\r\n      progressToast.update('\u6B63\u5728\u590D\u5236\u6761\u76EE...');\r\n      const entriesToCreate = oldEntries.map(entry => {\r\n        const newEntry = { ...entry };\r\n        delete newEntry.uid;\r\n        return newEntry;\r\n      });\r\n      await TavernAPI.createWorldbookEntries(newName, entriesToCreate);\r\n    }\r\n\r\n    await updateLinkedCharacters(oldName, newName, progressToast);\r\n\r\n    progressToast.update('\u6B63\u5728\u66F4\u65B0\u5168\u5C40\u8BBE\u7F6E...');\r\n    const enabledGlobalBooks = await TavernAPI.getGlobalWorldbookNames();\r\n    if (enabledGlobalBooks && enabledGlobalBooks.includes(oldName)) {\r\n      const newGlobalBooks = enabledGlobalBooks.map(name =>\r\n        name === oldName ? newName : name,\r\n      );\r\n      await TavernAPI.rebindGlobalWorldbooks(newGlobalBooks);\r\n      console.log(`[RegexLoreHub] Updated global lorebook settings from \"${oldName}\" to \"${newName}\"`);\r\n\r\n      // \u9A8C\u8BC1\u5168\u5C40\u8BBE\u7F6E\u66F4\u65B0\u662F\u5426\u6210\u529F\r\n      const updatedGlobalBooks = await TavernAPI.getGlobalWorldbookNames();\r\n      if (\r\n        !updatedGlobalBooks ||\r\n        !updatedGlobalBooks.includes(newName)\r\n      ) {\r\n        console.warn(`[RegexLoreHub] Global lorebook settings update verification failed for \"${newName}\"`);\r\n      }\r\n    }\r\n\r\n    if (appState.chatLorebook === oldName) {\r\n      progressToast.update('\u6B63\u5728\u66F4\u65B0\u804A\u5929\u7ED1\u5B9A...');\r\n      await TavernAPI.rebindChatWorldbook(newName);\r\n      appState.chatLorebook = newName;\r\n      console.log(`[RegexLoreHub] Updated chat lorebook from \"${oldName}\" to \"${newName}\"`);\r\n\r\n      // \u7ACB\u5373\u9A8C\u8BC1\u804A\u5929\u4E16\u754C\u4E66\u66F4\u65B0\u662F\u5426\u6210\u529F\r\n      try {\r\n        const updatedChatLorebook = await TavernAPI.getChatWorldbookName();\r\n        if (updatedChatLorebook !== newName) {\r\n          console.warn(\r\n            `[RegexLoreHub] Chat lorebook update verification failed. Expected: \"${newName}\", Got: \"${updatedChatLorebook}\"`,\r\n          );\r\n          appState.chatLorebook = updatedChatLorebook;\r\n        }\r\n      } catch (verifyError) {\r\n        console.warn('[RegexLoreHub] Failed to verify chat lorebook update:', verifyError);\r\n      }\r\n    }\r\n\r\n    progressToast.update('\u6B63\u5728\u66F4\u65B0\u5185\u90E8\u6620\u5C04...');\r\n    // \u66F4\u65B0 lorebookUsage \u6620\u5C04\r\n    if (appState.lorebookUsage.has(oldName)) {\r\n      const linkedChars = appState.lorebookUsage.get(oldName);\r\n      appState.lorebookUsage.delete(oldName);\r\n      appState.lorebookUsage.set(newName, linkedChars);\r\n      console.log(`[RegexLoreHub] Updated lorebookUsage mapping from \"${oldName}\" to \"${newName}\"`);\r\n    }\r\n\r\n    progressToast.update('\u6B63\u5728\u5220\u9664\u65E7\u4E16\u754C\u4E66...');\r\n    await TavernAPI.deleteWorldbook(oldName);\r\n\r\n    progressToast.update('\u6B63\u5728\u5237\u65B0\u6570\u636E...');\r\n    // \u4FDD\u5B58\u5F53\u524D\u804A\u5929\u4E16\u754C\u4E66\u72B6\u6001\uFF0C\u9632\u6B62\u5728\u6570\u636E\u5237\u65B0\u65F6\u4E22\u5931\r\n    const currentChatLorebook = appState.chatLorebook;\r\n    await loadAllData(true);\r\n\r\n    // \u5982\u679C\u804A\u5929\u4E16\u754C\u4E66\u5728\u5237\u65B0\u540E\u53D1\u751F\u4E86\u610F\u5916\u53D8\u5316\uFF0C\u6062\u590D\u6B63\u786E\u7684\u72B6\u6001\r\n    if (currentChatLorebook && appState.chatLorebook !== currentChatLorebook) {\r\n      console.log(`[RegexLoreHub] Restoring chat lorebook state after data refresh: \"${currentChatLorebook}\"`);\r\n      appState.chatLorebook = currentChatLorebook;\r\n    }\r\n\r\n    // \u5F3A\u5236\u540C\u6B65\u804A\u5929\u4E16\u754C\u4E66\u72B6\u6001\uFF0C\u786E\u4FDD\u5728\u6240\u6709\u9875\u9762\u90FD\u80FD\u6B63\u786E\u53CD\u6620\u6700\u65B0\u72B6\u6001\r\n    try {\r\n      // \u68C0\u67E5\u662F\u5426\u6709\u6D3B\u8DC3\u7684\u804A\u5929\r\n      const context = parentWin.SillyTavern.getContext() || {};\r\n      const hasActiveChat = context.chatId !== undefined && context.chatId !== null;\r\n\r\n      if (hasActiveChat) {\r\n        const finalChatLorebook = await TavernAPI.getChatWorldbookName();\r\n        if (finalChatLorebook !== appState.chatLorebook) {\r\n          console.log(`[RegexLoreHub] Final chat lorebook sync: \"${finalChatLorebook}\"`);\r\n          appState.chatLorebook = finalChatLorebook;\r\n        }\r\n      }\r\n    } catch (syncError) {\r\n      console.warn('[RegexLoreHub] Failed to sync final chat lorebook state:', syncError);\r\n    }\r\n\r\n    progressToast.remove();\r\n    showToast('\u4E16\u754C\u4E66\u91CD\u547D\u540D\u6210\u529F');\r\n    if (isDetailView) {\r\n      await handleEnterLorebookDetail(newName);\r\n    } else {\r\n      renderContent();\r\n    }\r\n  } catch (error) {\r\n    progressToast.remove();\r\n    console.error('[RegexLoreHub] Rename failed:', error);\r\n    await showModal({ type: 'alert', title: '\u91CD\u547D\u540D\u5931\u8D25', text: `\u64CD\u4F5C\u5931\u8D25: ${error.message}` });\r\n    // Attempt to clean up the newly created book if rename fails midway\r\n    if (appState.allLorebooks.some(b => b.name === newName)) {\r\n      await TavernAPI.deleteWorldbook(newName);\r\n    }\r\n\r\n    // \u4FDD\u5B58\u5F53\u524D\u804A\u5929\u4E16\u754C\u4E66\u72B6\u6001\uFF0C\u9632\u6B62\u5728\u9519\u8BEF\u6062\u590D\u65F6\u4E22\u5931\r\n    const currentChatLorebook = appState.chatLorebook;\r\n    await loadAllData(true);\r\n\r\n    // \u6062\u590D\u804A\u5929\u4E16\u754C\u4E66\u72B6\u6001\uFF08\u5982\u679C\u5728\u9519\u8BEF\u5904\u7406\u8FC7\u7A0B\u4E2D\u88AB\u610F\u5916\u66F4\u6539\uFF09\r\n    if (currentChatLorebook && appState.chatLorebook !== currentChatLorebook) {\r\n      console.log(`[RegexLoreHub] Restoring chat lorebook state after error recovery: \"${currentChatLorebook}\"`);\r\n      appState.chatLorebook = currentChatLorebook;\r\n    }\r\n\r\n    // \u5728\u9519\u8BEF\u6062\u590D\u540E\u4E5F\u5F3A\u5236\u540C\u6B65\u804A\u5929\u4E16\u754C\u4E66\u72B6\u6001\r\n    try {\r\n      // \u68C0\u67E5\u662F\u5426\u6709\u6D3B\u8DC3\u7684\u804A\u5929\r\n      const context = parentWin.SillyTavern.getContext() || {};\r\n      const hasActiveChat = context.chatId !== undefined && context.chatId !== null;\r\n\r\n      if (hasActiveChat) {\r\n        const finalChatLorebook = await TavernAPI.getChatWorldbookName();\r\n        if (finalChatLorebook !== appState.chatLorebook) {\r\n          console.log(`[RegexLoreHub] Final chat lorebook sync after error recovery: \"${finalChatLorebook}\"`);\r\n          appState.chatLorebook = finalChatLorebook;\r\n        }\r\n      }\r\n    } catch (syncError) {\r\n      console.warn('[RegexLoreHub] Failed to sync chat lorebook state after error recovery:', syncError);\r\n    }\r\n  }\r\n  });\r\n\r\n\r\n\r\n  const handleCreateLorebook = errorCatched(async (event, previousValue = '') => {\r\n    let newName;\r\n    try {\r\n      newName = await showModal({\r\n        type: 'prompt',\r\n        title: '\u65B0\u5EFA\u4E16\u754C\u4E66',\r\n        text: '\u8BF7\u8F93\u5165\u65B0\u4E16\u754C\u4E66\u7684\u540D\u79F0:',\r\n        value: previousValue,\r\n      });\r\n    } catch {\r\n      return; // \u7528\u6237\u53D6\u6D88\r\n    }\r\n\r\n    newName = newName.trim();\r\n    if (!newName) {\r\n      return;\r\n    }\r\n\r\n    if (appState.allLorebooks.some(book => book.name === newName)) {\r\n      await showModal({ type: 'alert', title: '\u9519\u8BEF', text: '\u5DF2\u5B58\u5728\u540C\u540D\u4E16\u754C\u4E66\u3002' });\r\n      // \u91CD\u65B0\u6253\u5F00\u8F93\u5165\u6846\u5E76\u4FDD\u7559\u7528\u6237\u8F93\u5165\r\n      return handleCreateLorebook(event, newName);\r\n    }\r\n\r\n    const $button = event ? $(event.currentTarget) : null;\r\n    if ($button) {\r\n      $button.prop('disabled', true).addClass('rlh-loading');\r\n    }\r\n\r\n    try {\r\n      const success = await TavernAPI.createWorldbook(newName);\r\n      if (success) {\r\n        // \u5173\u952E\u4F18\u5316\uFF1A\u624B\u52A8\u66F4\u65B0\u72B6\u6001\uFF0C\u907F\u514D\u5168\u5C40\u5237\u65B0\r\n        appState.allLorebooks.push({\r\n          name: newName,\r\n          enabled: false,\r\n          entryCount: 0,\r\n          enabledEntryCount: 0,\r\n          entriesLoaded: true, // \u65B0\u4E66\u6CA1\u6709\u6761\u76EE\uFF0C\u53EF\u89C6\u4E3A\u5DF2\u52A0\u8F7D\r\n        });\r\n\r\n        // \u76F4\u63A5\u8FDB\u5165\u65B0\u521B\u5EFA\u7684\u4E16\u754C\u4E66\u8BE6\u60C5\u9875\r\n        await handleEnterLorebookDetail(newName);\r\n      } else {\r\n        await showModal({ type: 'alert', title: '\u521B\u5EFA\u5931\u8D25', text: '\u521B\u5EFA\u4E16\u754C\u4E66\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002' });\r\n      }\r\n    } finally {\r\n      if ($button) {\r\n        $button.prop('disabled', false).removeClass('rlh-loading');\r\n      }\r\n    }\r\n  });\r\n\r\n\r\n\r\n  const handleDeleteLorebook = errorCatched(async event => {\r\n  event.stopPropagation();\r\n  const $trigger = $(event.currentTarget);\r\n  const $bookSource = $trigger.closest('.rlh-book-group, .rlh-detail-view');\r\n  const bookName = $bookSource.data('book-name') || appState.activeBookName;\r\n  if (!bookName) return;\r\n  const isDetailView = $bookSource.hasClass('rlh-detail-view');\r\n  try {\r\n    await showModal({\r\n      type: 'confirm',\r\n      title: '\u786E\u8BA4\u5220\u9664',\r\n      text: `\u60A8\u786E\u5B9A\u8981\u6C38\u4E45\u5220\u9664\u4E16\u754C\u4E66 \"${bookName}\" \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`,\r\n    });\r\n  } catch {\r\n    return;\r\n  }\r\n\r\n  const success = await TavernAPI.deleteWorldbook(bookName);\r\n  if (success) {\r\n    appState.allLorebooks = appState.allLorebooks.filter(b => b.name !== bookName);\r\n    safeDeleteLorebookEntries(bookName);\r\n    if (appState.lorebookUsage instanceof Map && appState.lorebookUsage.has(bookName)) {\r\n      appState.lorebookUsage.delete(bookName);\r\n    }\r\n    if (Array.isArray(appState.lorebooks?.character)) {\r\n      appState.lorebooks.character = appState.lorebooks.character.filter(name => name !== bookName);\r\n    }\r\n    if (appState.chatLorebook === bookName) {\r\n      appState.chatLorebook = null;\r\n    }\r\n    if (appState.activeCharacterBook === bookName) {\r\n      appState.activeCharacterBook = null;\r\n    }\r\n    if (appState.activeBookName === bookName) {\r\n      appState.activeBookName = null;\r\n    }\r\n    if (isDetailView) {\r\n      await handleExitLorebookDetail();\r\n    } else {\r\n      renderContent();\r\n    }\r\n    showToast('\u5220\u9664\u6210\u529F');\r\n  } else {\r\n    await showModal({ type: 'alert', title: '\u5220\u9664\u5931\u8D25', text: '\u5220\u9664\u4E16\u754C\u4E66\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002' });\r\n  }\r\n  });\r\n\r\n\r\n\r\n  const handleBatchSetRecursion = errorCatched(async event => {\r\n  const $trigger = $(event.currentTarget);\r\n  const rawDatasetName = ($trigger.data('book-name') ?? '').toString().trim();\r\n  const context = getViewContext();\r\n  const fallbackNames = [\r\n    rawDatasetName,\r\n    context?.activeBookName ?? '',\r\n    appState.activeBookName ?? '',\r\n    appState.activeCharacterBook ?? '',\r\n    appState.chatLorebook ?? '',\r\n  ];\r\n  const bookName = fallbackNames.find(name => typeof name === 'string' && name.trim().length > 0)?.trim() ?? '';\r\n\r\n  if (!bookName) {\r\n    await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u9009\u62E9\u6216\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u3002' });\r\n    return;\r\n  }\r\n\r\n  let entries = [...safeGetLorebookEntries(bookName)];\r\n  if (!entries || entries.length === 0) {\r\n    await loadLorebookEntriesIfNeeded(bookName);\r\n    entries = [...safeGetLorebookEntries(bookName)];\r\n  }\r\n\r\n  if (!entries || entries.length === 0) {\r\n    await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BE5\u4E16\u754C\u4E66\u6CA1\u6709\u6761\u76EE\u53EF\u64CD\u4F5C\u3002' });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await showModal({\r\n      type: 'confirm',\r\n      title: '\u786E\u8BA4\u64CD\u4F5C',\r\n      text: `\u786E\u5B9A\u8981\u4E3A \"${bookName}\" \u4E2D\u7684\u6240\u6709\u6761\u76EE\u5F00\u542F\u201C\u9632\u6B62\u9012\u5F52\u201D\u548C\u201C\u4E0D\u53EF\u88AB\u9012\u5F52\u201D\u5417\uFF1F\u6B64\u64CD\u4F5C\u4F1A\u963B\u6B62\u4E16\u754C\u4E66\u6761\u76EE\u5F7C\u6B64\u89E6\u53D1\u3002`,\r\n    });\r\n  } catch {\r\n    return; // \u7528\u6237\u53D6\u6D88\r\n  }\r\n\r\n  const updates = entries.map(entry => ({\r\n    uid: entry.uid,\r\n    prevent_recursion: true,\r\n    exclude_recursion: true,\r\n  }));\r\n\r\n  await updateWorldbookEntries(bookName, updates);\r\n\r\n  // \u66F4\u65B0\u672C\u5730\u72B6\u6001\r\n  entries.forEach(entry => {\r\n    entry.prevent_recursion = true;\r\n    entry.exclude_recursion = true;\r\n    if (!entry.recursion || typeof entry.recursion !== 'object') {\r\n      entry.recursion = {};\r\n    }\r\n    entry.recursion.prevent_outgoing = true;\r\n    entry.recursion.prevent_incoming = true;\r\n  });\r\n\r\n  // \u5982\u679C\u6709\u6253\u5F00\u7684\u7F16\u8F91\u5668\uFF0C\u5219\u66F4\u65B0\u5176\u4E2D\u7684\u590D\u9009\u6846\r\n  updates.forEach(update => {\r\n    const $openEditor = $(\r\n      `#${'rlh-panel'}-content .rlh-item-container[data-book-name=\"${bookName}\"][data-id=\"${update.uid}\"] .rlh-collapsible-content:visible`,\r\n      parentDoc,\r\n    );\r\n    if ($openEditor.length) {\r\n      $openEditor.find('.rlh-edit-prevent-recursion').prop('checked', true);\r\n      $openEditor.find('.rlh-edit-exclude-recursion').prop('checked', true);\r\n    }\r\n  });\r\n\r\n  showToast('\u5DF2\u4E3A\u6240\u6709\u6761\u76EE\u5F00\u542F\u201C\u9632\u6B62\u9012\u5F52\u201D\u548C\u201C\u4E0D\u53EF\u88AB\u9012\u5F52\u201D');\r\n\r\n  await refreshLorebookData(bookName);\r\n  });\r\n\r\n\r\n\r\n  const handleFixKeywords = errorCatched(async event => {\r\n  const $trigger = $(event.currentTarget);\r\n  const rawDatasetName = ($trigger.data('book-name') ?? '').toString().trim();\r\n  const context = getViewContext();\r\n  const fallbackNames = [\r\n    rawDatasetName,\r\n    context?.activeBookName ?? '',\r\n    appState.activeBookName ?? '',\r\n    appState.activeCharacterBook ?? '',\r\n    appState.chatLorebook ?? '',\r\n  ];\r\n  const bookName = fallbackNames.find(name => typeof name === 'string' && name.trim().length > 0)?.trim() ?? '';\r\n\r\n  if (!bookName) {\r\n    await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u9009\u62E9\u6216\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u3002' });\r\n    return;\r\n  }\r\n\r\n  let entries = [...safeGetLorebookEntries(bookName)];\r\n  if (!entries || entries.length === 0) {\r\n    await loadLorebookEntriesIfNeeded(bookName);\r\n    entries = [...safeGetLorebookEntries(bookName)];\r\n  }\r\n\r\n  if (!entries || entries.length === 0) {\r\n    await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BE5\u4E16\u754C\u4E66\u6CA1\u6709\u6761\u76EE\u53EF\u64CD\u4F5C\u3002' });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await showModal({\r\n      type: 'confirm',\r\n      title: '\u786E\u8BA4\u64CD\u4F5C',\r\n      text: `\u786E\u5B9A\u8981\u4E3A \"${bookName}\" \u4E2D\u7684\u6240\u6709\u6761\u76EE\u4FEE\u590D\u5173\u952E\u8BCD\uFF08\u5C06\u4E2D\u6587\u9017\u53F7\u66FF\u6362\u4E3A\u82F1\u6587\u9017\u53F7\uFF09\u5417\uFF1F`,\r\n    });\r\n  } catch {\r\n    return; // \u7528\u6237\u53D6\u6D88\r\n  }\r\n\r\n  let changedCount = 0;\r\n  const updates = entries\r\n    .map(entry => {\r\n      const originalKeysString = (entry.keys || []).join(', ');\r\n      // \u4FEE\u590D\u4E2D\u6587\u9017\u53F7\u548C\u591A\u4F59\u7684\u7A7A\u683C\r\n      const newKeysString = originalKeysString.replace(/\uFF0C/g, ',').replace(/,+/g, ',').trim();\r\n      const newKeysArray = newKeysString\r\n        .split(',')\r\n        .map(k => k.trim())\r\n        .filter(Boolean);\r\n      const finalKeysString = newKeysArray.join(', ');\r\n\r\n      if (originalKeysString !== finalKeysString) {\r\n        changedCount++;\r\n        return {\r\n          uid: entry.uid,\r\n          keys: newKeysArray,\r\n        };\r\n      }\r\n      return null;\r\n    })\r\n    .filter(Boolean);\r\n\r\n  if (updates.length > 0) {\r\n    await updateWorldbookEntries(bookName, updates);\r\n\r\n    // \u66F4\u65B0\u672C\u5730\u72B6\u6001\r\n    updates.forEach(update => {\r\n      const entry = entries.find(e => e.uid === update.uid);\r\n      if (entry) {\r\n        entry.keys = update.keys;\r\n      }\r\n    });\r\n\r\n    // \u5982\u679C\u6709\u6253\u5F00\u7684\u7F16\u8F91\u5668\uFF0C\u5219\u66F4\u65B0\u5176\u4E2D\u7684\u8F93\u5165\u6846\r\n    updates.forEach(update => {\r\n      const $openEditor = $(\r\n        `#${'rlh-panel'}-content .rlh-item-container[data-book-name=\"${bookName}\"][data-id=\"${update.uid}\"] .rlh-collapsible-content:visible`,\r\n        parentDoc,\r\n      );\r\n      if ($openEditor.length) {\r\n        $openEditor.find('.rlh-edit-keys').val(update.keys.join(', '));\r\n      }\r\n    });\r\n\r\n    showToast(`\u6210\u529F\u4FEE\u590D\u4E86 ${changedCount} \u4E2A\u6761\u76EE\u7684\u5173\u952E\u8BCD`);\r\n\r\n    await refreshLorebookData(bookName);\r\n  } else {\r\n    await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u6240\u6709\u6761\u76EE\u7684\u5173\u952E\u8BCD\u683C\u5F0F\u90FD\u6B63\u786E\uFF0C\u65E0\u9700\u4FEE\u590D\u3002' });\r\n  }\r\n  });\r\n\r\n\r\n\r\n  const applyUnifiedPosition = errorCatched(async ({ bookName, positionValue }) => {\r\n    const targetPosition = (positionValue ?? '').toString().trim();\r\n    if (!targetPosition) return;\r\n\r\n    const context = getViewContext();\r\n    const fallbackNames = [\r\n      bookName,\r\n      context?.activeBookName ?? '',\r\n      appState.activeBookName ?? '',\r\n      appState.activeCharacterBook ?? '',\r\n      appState.chatLorebook ?? '',\r\n    ];\r\n    const resolvedBookName =\r\n      fallbackNames.find(name => typeof name === 'string' && name.trim().length > 0)?.trim() ?? '';\r\n\r\n    if (!resolvedBookName) {\r\n      await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u9009\u62E9\u6216\u6253\u5F00\u4E00\u4E2A\u4E16\u754C\u4E66\u3002' });\r\n      return;\r\n    }\r\n\r\n    let entries = [...safeGetLorebookEntries(resolvedBookName)];\r\n    if (!entries.length) {\r\n      await loadLorebookEntriesIfNeeded(resolvedBookName);\r\n      entries = [...safeGetLorebookEntries(resolvedBookName)];\r\n    }\r\n\r\n    if (!entries.length) {\r\n      await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BE5\u4E16\u754C\u4E66\u6CA1\u6709\u6761\u76EE\u53EF\u64CD\u4F5C\u3002' });\r\n      return;\r\n    }\r\n\r\n    const optionLabel = LOREBOOK_OPTIONS.position?.[targetPosition] ?? targetPosition;\r\n\r\n    const updates = entries\r\n      .filter(entry => (entry?.position ?? '').toString() !== targetPosition)\r\n      .map(entry => ({ uid: entry.uid, position: targetPosition }));\r\n\r\n    if (!updates.length) {\r\n      await showModal({ type: 'alert', title: '\u63D0\u793A', text: `\u6240\u6709\u6761\u76EE\u7684\u4F4D\u7F6E\u5DF2\u7ECF\u662F\u300C${optionLabel}\u300D\u3002` });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      await showModal({\r\n        type: 'confirm',\r\n        title: '\u786E\u8BA4\u64CD\u4F5C',\r\n        text: `\u786E\u5B9A\u8981\u5C06 \"${resolvedBookName}\" \u4E2D\u7684 ${entries.length} \u4E2A\u6761\u76EE\u5168\u90E8\u8BBE\u7F6E\u4E3A\u300C${optionLabel}\u300D\u5417\uFF1F`,\r\n      });\r\n    } catch {\r\n      return;\r\n    }\r\n\r\n    await updateWorldbookEntries(resolvedBookName, updates);\r\n\r\n    const refreshedEntries = safeGetLorebookEntries(resolvedBookName);\r\n    const uniquePositions = new Set(\r\n      refreshedEntries.map(entry => (entry?.position ?? 'before_character_definition').toString()),\r\n    );\r\n    const unifiedPosition = uniquePositions.size === 1 ? uniquePositions.values().next().value : null;\r\n\r\n    updates.forEach(update => {\r\n      const selector = `#${'rlh-panel'}-content .rlh-item-container[data-book-name=\"${resolvedBookName}\"][data-id=\"${update.uid}\"]`;\r\n      const $container = $(selector, parentDoc);\r\n      if ($container.length) {\r\n        const $positionSelect = $container.find('.rlh-edit-position');\r\n        if ($positionSelect.length) {\r\n          $positionSelect.val(targetPosition).trigger('change');\r\n        }\r\n      }\r\n    });\r\n\r\n    const $menu = $(`#${POSITION_MENU_ID}`, parentDoc);\r\n    if ($menu.length) {\r\n      $menu.attr('data-book-name', resolvedBookName);\r\n      const $button = $(`#${POSITION_MENU_BUTTON_ID}`, parentDoc);\r\n      if ($button.length) {\r\n        $button.removeAttr('disabled');\r\n        $button.attr('data-book-name', resolvedBookName);\r\n      }\r\n      const $options = $menu.find('.rlh-position-option');\r\n      $options.each(function () {\r\n        const $option = $(this);\r\n        const value = ($option.data('position-value') ?? '').toString();\r\n        const isActive = unifiedPosition && value === unifiedPosition;\r\n        $option.toggleClass('active', isActive);\r\n        $option.attr('aria-selected', isActive ? 'true' : 'false');\r\n        $option.attr('data-book-name', resolvedBookName);\r\n      });\r\n    }\r\n\r\n    showToast(`\u5DF2\u66F4\u65B0 ${updates.length} \u4E2A\u6761\u76EE\u7684\u4F4D\u7F6E\u4E3A\u300C${optionLabel}\u300D`);\r\n\r\n    await refreshLorebookData(resolvedBookName);\r\n  });\r\n\r\n\r\n\r\n  const handleCreateChatLorebook = errorCatched(async () => {\r\n  const bookName = await TavernAPI.getOrCreateChatWorldbook();\r\n  if (bookName) {\r\n    showToast(`\u5DF2\u521B\u5EFA\u5E76\u7ED1\u5B9A\u804A\u5929\u4E16\u754C\u4E66: ${bookName}`);\r\n    await loadAllData(true);\r\n  } else {\r\n    await showModal({ type: 'alert', title: '\u64CD\u4F5C\u5931\u8D25', text: '\u65E0\u6CD5\u521B\u5EFA\u6216\u7ED1\u5B9A\u804A\u5929\u4E16\u754C\u4E66\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002' });\r\n  }\r\n  });\r\n\r\n\r\n  const handleUnlinkChatLorebook = errorCatched(async () => {\r\n  const bookName = appState.chatLorebook;\r\n  if (!bookName) return;\r\n\r\n  try {\r\n    await showModal({\r\n      type: 'confirm',\r\n      title: '\u786E\u8BA4\u89E3\u9664\u7ED1\u5B9A',\r\n      text: `\u60A8\u786E\u5B9A\u8981\u89E3\u9664\u4E0E\u804A\u5929\u4E16\u754C\u4E66 \"${bookName}\" \u7684\u7ED1\u5B9A\u5417\uFF1F\u4E16\u754C\u4E66\u672C\u8EAB\u4E0D\u4F1A\u88AB\u5220\u9664\u3002`,\r\n    });\r\n  } catch {\r\n    return; // \u7528\u6237\u53D6\u6D88\r\n  }\r\n\r\n  await TavernAPI.rebindChatWorldbook(null);\r\n  appState.chatLorebook = null;\r\n  showToast('\u5DF2\u89E3\u9664\u7ED1\u5B9A');\r\n  renderContent();\r\n  });\r\n\r\n\r\n  const handleRefreshLorebookDetail = errorCatched(async () => {\r\n    const bookName = appState.activeBookName;\r\n    if (!bookName) return;\r\n\r\n    appState.loadingBookName = bookName;\r\n    renderContent();\r\n\r\n    await loadLorebookEntriesIfNeeded(bookName, true); // \u5F3A\u5236\u5237\u65B0\r\n\r\n    appState.loadingBookName = null;\r\n    renderContent();\r\n  });\r\n\r\n\r\n  return {\r\n    handleEnterLorebookDetail,\r\n    handleExitLorebookDetail,\r\n    handleRefreshLorebookDetail,\r\n    handleCreateLorebook,\r\n    handleDeleteLorebook,\r\n    handleRenameBook,\r\n    handleBatchSetRecursion,\r\n    handleFixKeywords,\r\n    applyUnifiedPosition,\r\n    handleCreateChatLorebook,\r\n    handleUnlinkChatLorebook,\r\n  };\r\n}\r\n", "import {\r\n  LOREBOOK_OPTIONS,\r\n  appState,\r\n  safeGetLorebookEntries,\r\n  safeSetLorebookEntries,\r\n  errorCatched,\r\n  showToast,\r\n  showModal,\r\n  escapeHtml,\r\n  get$,\r\n  getParentDoc,\r\n  debounce,\r\n} from '../../core.js';\r\nimport {\r\n  TavernAPI,\r\n  createInMemoryEntry,\r\n  updateInMemoryEntry,\r\n  saveAllChanges,\r\n  updateBookSummary,\r\n  updateWorldbookEntries, // \u5BFC\u5165\u65B0\u7684\u66F4\u65B0\u51FD\u6570\r\n  queueLorebookEntryUpdate,\r\n  queueRegexUpdate,\r\n  normalizeWorldbookEntry,\r\n} from '../../dataLayer.js';\r\nimport {\r\n  getViewContext,\r\n  prependEntry,\r\n  buildLoreEntryViewerHTML,\r\n  buildRegexViewerHTML,\r\n} from '../render/index.js';\r\n\r\n// --- \u6761\u76EE\u4E8B\u4EF6\u5904\u7406 ---\r\nexport function createItemHandlers(deps = {}) {\r\n  const $ = deps.$ ?? get$();\r\n  const parentDoc = deps.parentDoc ?? getParentDoc();\r\n  // \u5B9A\u4F4D\u5F53\u524D\u7F16\u8F91\u7684\u6B63\u5219\u9879\uFF0C\u4FBF\u4E8E\u5728\u8F93\u5165\u65F6\u540C\u6B65\u72B6\u6001\r\n  const findRegexItemById = (rawId) => {\r\n    const targetId = String(rawId);\r\n    const fromGlobal = appState.regexes.global.find(item => String(item.id) === targetId);\r\n    if (fromGlobal) return fromGlobal;\r\n    return appState.regexes.character.find(item => String(item.id) === targetId) ?? null;\r\n  };\r\n\r\n  // \u5C06\u8F93\u5165\u503C\u5199\u5165\u6B63\u5219\u9879\uFF0C\u81EA\u52A8\u5904\u7406\u5D4C\u5957\u5B57\u6BB5\u548C\u7C7B\u578B\u8F6C\u6362\r\n  const applyRegexFieldUpdate = (regexItem, fieldPath, rawValue) => {\r\n    if (!regexItem || !fieldPath) return;\r\n    let value = rawValue;\r\n    if (typeof value !== 'boolean') {\r\n      value = value ?? '';\r\n    }\r\n    if (fieldPath === 'min_depth' || fieldPath === 'max_depth') {\r\n      const numeric = parseInt(value, 10);\r\n      value = Number.isNaN(numeric) ? null : numeric;\r\n    }\r\n    const segments = fieldPath.split('.');\r\n    if (segments.length === 1) {\r\n      regexItem[segments[0]] = value;\r\n      return;\r\n    }\r\n    let cursor = regexItem;\r\n    for (let i = 0; i < segments.length - 1; i++) {\r\n      const key = segments[i];\r\n      if (!cursor[key] || typeof cursor[key] !== 'object') {\r\n        cursor[key] = {};\r\n      }\r\n      cursor = cursor[key];\r\n    }\r\n    cursor[segments[segments.length - 1]] = value;\r\n  };\r\n\r\n  // \u521B\u5EFA\u4E00\u4E2A\u9632\u6296\u51FD\u6570\u7528\u4E8E\u81EA\u52A8\u4FDD\u5B58\r\n  const debouncedSave = debounce(() => saveAllChanges({ silent: true }), 1000);\r\n\r\n  const handleEditorInput = errorCatched(async event => {\r\n    const $target = $(event.currentTarget);\r\n    const $container = $target.closest('.rlh-item-container');\r\n    const type = $container.data('type');\r\n    const id = $container.data('id');\r\n    const numericId = Number(id);\r\n    const field = $target.data('field');\r\n    if (!field) return;\r\n    if (type === 'lore') {\r\n      const bookName = $container.data('book-name');\r\n      const entries = safeGetLorebookEntries(bookName);\r\n      const entry = entries.find(item => {\r\n        const itemUid = item?.uid;\r\n        if (typeof itemUid === 'number' && !Number.isNaN(numericId)) {\r\n          return itemUid === numericId;\r\n        }\r\n        return String(itemUid) === String(id);\r\n      });\r\n      if (!entry) return;\r\n      // \u5B9E\u65F6\u66F4\u65B0\u5185\u5B58\u4E2D\u7684\u72B6\u6001\uFF0C\u800C\u4E0D\u662F\u76F4\u63A5\u8C03\u7528API\r\n      let value;\r\n      if ($target.is(':checkbox')) {\r\n        value = $target.is(':checked');\r\n      } else if ($target.is('[contenteditable=\"true\"]')) {\r\n        const element = $target.get(0);\r\n        if (element) {\r\n          const blockTags = new Set(['div', 'p', 'li', 'ul', 'ol', 'blockquote', 'pre', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'table', 'tr']);\r\n          const parts = [];\r\n          const appendText = textValue => {\r\n            if (!textValue) return;\r\n            parts.push(textValue);\r\n          };\r\n          const appendNewline = () => {\r\n            if (!parts.length) {\r\n              parts.push('\\n');\r\n              return;\r\n            }\r\n            const last = parts[parts.length - 1];\r\n            if (last?.endsWith('\\n')) return;\r\n            parts.push('\\n');\r\n          };\r\n          const collectText = node => {\r\n            if (!node) return;\r\n            const nodeType = node.nodeType;\r\n            if (nodeType === Node.TEXT_NODE) {\r\n              appendText(node.nodeValue || '');\r\n              return;\r\n            }\r\n            if (nodeType !== Node.ELEMENT_NODE) return;\r\n            const tag = node.nodeName.toLowerCase();\r\n            if (tag === 'br') {\r\n              parts.push('\\n');\r\n              return;\r\n            }\r\n            if (tag === 'style' || tag === 'script') return;\r\n            node.childNodes.forEach(child => collectText(child));\r\n            if (blockTags.has(tag)) appendNewline();\r\n          };\r\n          collectText(element);\r\n          value = parts.join('');\r\n          value = value.replace(/\\u00a0/g, ' ');\r\n          value = value.replace(/\\r?\\n/g, '\\n');\r\n        } else {\r\n          value = '';\r\n        }\r\n      } else {\r\n        value = $target.val();\r\n      }\r\n      // \u7279\u6B8A\u5904\u7406\u9700\u8981\u7C7B\u578B\u8F6C\u6362\u7684\u5B57\u6BB5\r\n      if (field === 'keys') {\r\n        entry.keys = value.split(',').map(k => k.trim()).filter(Boolean);\r\n      } else if (['depth', 'order', 'probability'].includes(field)) {\r\n        const numValue = parseInt(value, 10);\r\n        entry[field] = isNaN(numValue) ? ($target.attr('placeholder') === '\u4F8B\u5982: 0' ? null : 100) : numValue;\r\n      } else {\r\n        entry[field] = value;\r\n      }\r\n      const pendingValue = Array.isArray(entry[field]) ? [...entry[field]] : entry[field];\r\n      queueLorebookEntryUpdate(bookName, entry.uid ?? id, { [field]: pendingValue });\r\n    } else if (type === 'regex') {\r\n      const regexItem = findRegexItemById(id);\r\n      if (!regexItem) return;\r\n      let value;\r\n      if ($target.is(':checkbox')) {\r\n        value = $target.is(':checked');\r\n      } else {\r\n        value = $target.val();\r\n      }\r\n      applyRegexFieldUpdate(regexItem, field, value);\r\n      queueRegexUpdate(regexItem.id);\r\n    }\r\n    // \u89E6\u53D1\u9632\u6296\u4FDD\u5B58\r\n    debouncedSave();\r\n  });\r\n  const buildLoreEntryEditorHtml = (entry) => {\r\n    const positionOptions = Object.entries(LOREBOOK_OPTIONS.position)\r\n      .map(([value, text]) => `<option value=\"${value}\" ${entry.position === value ? 'selected' : ''}>${text}</option>`)\r\n      .join('');\r\n    const logicOptions = Object.entries(LOREBOOK_OPTIONS.logic)\r\n      .map(([value, text]) => `<option value=\"${value}\" ${entry.logic === value ? 'selected' : ''}>${text}</option>`)\r\n      .join('');\r\n    const keywordsText = Array.isArray(entry.keys) ? entry.keys.join(', ') : '';\r\n    const contentText = entry.content || '';\r\n    return `\r\n      <div class=\"rlh-editor-wrapper\" data-mode=\"edit\">\r\n        <div class=\"rlh-editor-field\">\r\n          <label>\u5173\u952E\u8BCD (\u9017\u53F7\u5206\u9694)</label>\r\n          <input type=\"text\" class=\"rlh-edit-keys\" data-field=\"keys\" value=\"${escapeHtml(keywordsText)}\">\r\n        </div>\r\n        <div class=\"rlh-editor-field\">\r\n          <label>\u5185\u5BB9</label>\r\n          <div class=\"rlh-edit-content\" data-field=\"content\" contenteditable=\"true\">${escapeHtml(contentText)}</div>\r\n        </div>\r\n        <div class=\"rlh-editor-group\"><h5>\u63D2\u5165\u89C4\u5219</h5>\r\n          <div class=\"rlh-editor-grid\">\r\n            <div class=\"rlh-grid-item\"><label>\u4F4D\u7F6E</label><select class=\"rlh-edit-position rlh-select-nudge\" data-field=\"position\">${positionOptions}</select></div>\r\n            <div class=\"rlh-grid-item rlh-depth-container\"><label>\u6DF1\u5EA6</label><input type=\"number\" class=\"rlh-edit-depth\" data-field=\"depth\" placeholder=\"\u4F8B\u5982: 0\" value=\"${entry.depth ?? ''}\"></div>\r\n            <div class=\"rlh-grid-item\"><label>\u987A\u5E8F</label><input type=\"number\" class=\"rlh-edit-order\" data-field=\"order\" placeholder=\"\u4F8B\u5982: 100\" value=\"${entry.order ?? ''}\"></div>\r\n          </div>\r\n        </div>\r\n        <div class=\"rlh-editor-group\"><h5>\u6FC0\u6D3B\u903B\u8F91</h5>\r\n          <div class=\"rlh-editor-grid\">\r\n            <div class=\"rlh-grid-item\"><label>\u6982\u7387 (%)</label><input type=\"number\" class=\"rlh-edit-probability\" data-field=\"probability\" min=\"0\" max=\"100\" placeholder=\"100\" value=\"${entry.probability ?? ''}\"></div>\r\n            <div class=\"rlh-grid-item\"><label>\u5173\u952E\u8BCD\u903B\u8F91</label><select class=\"rlh-edit-logic rlh-select-nudge\" data-field=\"logic\">${logicOptions}</select></div>\r\n          </div>\r\n        </div>\r\n        <div class=\"rlh-editor-group\"><h5>\u5339\u914D\u4E0E\u9012\u5F52</h5>\r\n          <div class=\"rlh-editor-options-row\">\r\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-case-sensitive\" data-field=\"case_sensitive\" ${entry.case_sensitive ? 'checked' : ''}> \u5927\u5C0F\u5199\u654F\u611F</label>\r\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-match-whole\" data-field=\"match_whole_words\" ${entry.match_whole_words ? 'checked' : ''}> \u5168\u8BCD\u5339\u914D</label>\r\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-prevent-recursion\" data-field=\"prevent_recursion\" ${entry.prevent_recursion ? 'checked' : ''}> \u9632\u6B62\u9012\u5F52</label>\r\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-exclude-recursion\" data-field=\"exclude_recursion\" ${entry.exclude_recursion ? 'checked' : ''}> \u4E0D\u53EF\u88AB\u9012\u5F52</label>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  };\r\n  const buildRegexEditorHtml = (regexItem) => {\r\n    const destination = regexItem?.destination ?? {};\r\n    const source = regexItem?.source ?? {};\r\n    const findValue = escapeHtml(regexItem?.find_regex ?? '');\r\n    const replaceValue = escapeHtml(regexItem?.replace_string ?? '');\r\n    const minDepthValue = escapeHtml(String(regexItem?.min_depth ?? ''));\r\n    const maxDepthValue = escapeHtml(String(regexItem?.max_depth ?? ''));\r\n    return `\r\n      <div class=\"rlh-editor-wrapper\" data-mode=\"edit\">\r\n        <div class=\"rlh-editor-field\">\r\n          <label>\u67E5\u627E\u6B63\u5219\u8868\u8FBE\u5F0F</label>\r\n          <textarea class=\"rlh-edit-find\" data-field=\"find_regex\">${findValue}</textarea>\r\n        </div>\r\n        <div class=\"rlh-editor-field\">\r\n          <label>\u66FF\u6362\u4E3A</label>\r\n          <textarea class=\"rlh-edit-replace\" data-field=\"replace_string\">${replaceValue}</textarea>\r\n        </div>\r\n        <div class=\"rlh-editor-group\">\r\n          <h5>\u77ED\u6682</h5>\r\n          <div class=\"rlh-editor-options-row\">\r\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-dest-display\" data-field=\"destination.display\" ${destination.display ? 'checked' : ''}> \u4EC5\u683C\u5F0F\u663E\u793A</label>\r\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-dest-prompt\" data-field=\"destination.prompt\" ${destination.prompt ? 'checked' : ''}> \u4EC5\u683C\u5F0F\u63D0\u793A\u8BCD</label>\r\n          </div>\r\n        </div>\r\n        <div class=\"rlh-editor-group\">\r\n          <h5>\u4F5C\u7528\u8303\u56F4</h5>\r\n          <div class=\"rlh-editor-options-row\">\r\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-user\" data-field=\"source.user_input\" ${source.user_input ? 'checked' : ''}> \u7528\u6237\u8F93\u5165</label>\r\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-ai\" data-field=\"source.ai_output\" ${source.ai_output ? 'checked' : ''}> AI\u8F93\u51FA</label>\r\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-slash\" data-field=\"source.slash_command\" ${source.slash_command ? 'checked' : ''}> \u659C\u6760\u547D\u4EE4</label>\r\n            <label class=\"rlh-editor-option-item\"><input type=\"checkbox\" class=\"rlh-edit-src-world\" data-field=\"source.world_info\" ${source.world_info ? 'checked' : ''}> \u4E16\u754C\u4E66</label>\r\n          </div>\r\n        </div>\r\n        <div class=\"rlh-editor-group\">\r\n          <h5>\u6DF1\u5EA6</h5>\r\n          <div class=\"rlh-depth-inputs\">\r\n            <input type=\"number\" class=\"rlh-edit-depth-min\" data-field=\"min_depth\" placeholder=\"\u6700\u5C0F\u6DF1\u5EA6\" value=\"${minDepthValue}\">\r\n            <input type=\"number\" class=\"rlh-edit-depth-max\" data-field=\"max_depth\" placeholder=\"\u6700\u5927\u6DF1\u5EA6\" value=\"${maxDepthValue}\">\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  };\r\n\r\n  const updateRenameButtonState = ($container, mode) => {\r\n  const $button = $container.find('.rlh-rename-btn').first();\r\n  if (!$button.length) return;\r\n  const $icon = $button.find('i').first();\r\n  if (mode === 'edit') {\r\n    $button.attr('title', '\u9000\u51FA\u7F16\u8F91\u6A21\u5F0F');\r\n    $button.attr('data-rename-mode', 'exit');\r\n    if ($icon.length) {\r\n      $icon.removeClass('fa-pencil').addClass('fa-eye');\r\n    }\r\n  } else {\r\n    $button.attr('title', '\u91CD\u547D\u540D\u5E76\u7F16\u8F91');\r\n    $button.attr('data-rename-mode', 'rename');\r\n    if ($icon.length) {\r\n      $icon.removeClass('fa-eye').addClass('fa-pencil');\r\n    }\r\n  }\r\n};\r\n\r\n  const bindLoreEditorInputs = $content => {\r\n    $content.on('input.rlh change.rlh', 'input, textarea, select, [contenteditable=\"true\"]', handleEditorInput);\r\n    $content.find('.rlh-edit-position').trigger('change');\r\n  };\r\n\r\n  const switchLoreEntryMode = (mode, $container, entry, { animate = true, searchTerm } = {}) => {\r\n    const $content = $container.find('.rlh-collapsible-content').first();\r\n    if (!$content.length) return;\r\n\r\n    const isViewMode = mode === 'view';\r\n    const normalizedTerm = typeof searchTerm === 'string'\r\n      ? searchTerm\r\n      : ($container.data('searchTerm') || '');\r\n\r\n    const html = isViewMode\r\n      ? buildLoreEntryViewerHTML(entry, normalizedTerm)\r\n      : buildLoreEntryEditorHtml(entry);\r\n\r\n    if (isViewMode) {\r\n      $container.data('searchTerm', normalizedTerm);\r\n      $container.attr('data-search-term', normalizedTerm);\r\n    }\r\n\r\n    $content.stop(true, true);\n    $content.off('input.rlh change.rlh');\n    $content.html(html);\n\n    $container.attr('data-entry-mode', mode);\n    $content.attr('data-entry-mode', mode);\n    $container.toggleClass('rlh-editing', !isViewMode);\n    updateRenameButtonState($container, mode);\n\n    const $nameSpan = $container.find('.rlh-item-name').first();\n    if ($nameSpan.length) {\n      if (isViewMode) {\n        $nameSpan.show().removeAttr('aria-hidden');\n      } else {\n        $nameSpan.hide().attr('aria-hidden', 'true');\n      }\n    }\n\n    const finalize = () => {\n      if (!isViewMode) {\n        bindLoreEditorInputs($content);\n      }\n    };\n\n    const animateReveal = done => {\n      const el = $content[0];\n      if (!el) {\n        done();\n        return;\n      }\n\n      const duration = 280;\n      const easeInOut = t => (t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t);\n\n      el.style.display = 'block';\n      el.style.overflow = 'hidden';\n      const startHeight = 0;\n      const targetHeight = el.scrollHeight;\n      el.style.height = `${startHeight}px`;\n      el.style.opacity = '0';\n\n      let startTime = null;\n      const step = timestamp => {\n        if (!startTime) startTime = timestamp;\n        const progress = Math.min((timestamp - startTime) / duration, 1);\n        const eased = easeInOut(progress);\n        const currentHeight = startHeight + (targetHeight - startHeight) * eased;\n        el.style.height = `${currentHeight}px`;\n        el.style.opacity = String(0.6 + 0.4 * eased);\n\n        if (progress < 1) {\n          requestAnimationFrame(step);\n        } else {\n          el.style.height = '';\n          el.style.opacity = '';\n          el.style.overflow = '';\n          done();\n        }\n      };\n\n      requestAnimationFrame(step);\n    };\n\n    if (!$content.is(':visible')) {\n      if (animate) {\n        animateReveal(finalize);\n      } else {\n        $content.show();\n        finalize();\n      }\n    } else {\n      finalize();\n    }\n  };\n\r\n  const renderLoreEntryViewer = ($container, entry, searchTerm, options = {}) => {\r\n    switchLoreEntryMode('view', $container, entry, { ...options, searchTerm });\r\n  };\r\n\r\n  const renderLoreEntryEditor = ($container, entry, options = {}) => {\r\n    switchLoreEntryMode('edit', $container, entry, options);\r\n  };\r\n  const renderRegexViewer = ($container, regexItem, searchTerm, { animate = true } = {}) => {\r\n    const $content = $container.find('.rlh-collapsible-content').first();\r\n    if (!$content.length) return;\r\n    const normalizedTerm = typeof searchTerm === 'string' ? searchTerm : '';\r\n    $container.data('searchTerm', normalizedTerm);\r\n    $container.attr('data-search-term', normalizedTerm);\r\n    const viewerHtml = buildRegexViewerHTML(regexItem, normalizedTerm);\r\n    $content.stop(true, true);\r\n    $content.off('input.rlh change.rlh');\r\n    $content.html(viewerHtml);\r\n    $container.attr('data-entry-mode', 'view');\r\n    $content.attr('data-entry-mode', 'view');\r\n    $container.removeClass('rlh-editing');\r\n    updateRenameButtonState($container, 'view');\r\n    if (!$content.is(':visible')) {\r\n      if (animate) $content.slideDown(200);\r\n      else $content.show();\r\n    }\r\n  };\r\n  const renderRegexEditor = ($container, regexItem, { animate = true } = {}) => {\r\n    const $content = $container.find('.rlh-collapsible-content').first();\r\n    if (!$content.length) return;\r\n    const editorHtml = buildRegexEditorHtml(regexItem);\r\n    $content.stop(true, true);\r\n    $content.off('input.rlh change.rlh');\r\n    const bindInputs = () => {\r\n      $content.on('input.rlh change.rlh', 'input, textarea, select, [contenteditable=\"true\"]', handleEditorInput);\r\n    };\r\n    $content.html(editorHtml);\r\n    $container.attr('data-entry-mode', 'edit');\r\n    $content.attr('data-entry-mode', 'edit');\r\n    $container.addClass('rlh-editing');\r\n    updateRenameButtonState($container, 'edit');\r\n    if (!$content.is(':visible')) {\r\n      if (animate) $content.slideDown(200, bindInputs);\r\n      else {\r\n        $content.show();\r\n        bindInputs();\r\n      }\r\n    } else {\r\n      bindInputs();\r\n    }\r\n  };\r\n\r\n  const enterLoreEdit = ($container, options = {}) => {\r\n    const { animate = false, silent = false } = options;\r\n    if (!$container.length) return false;\r\n    if (appState.multiSelectMode) {\r\n      if (!silent) showToast('\u8BF7\u5148\u9000\u51FA\u591A\u9009\u6A21\u5F0F\u540E\u518D\u7F16\u8F91\u3002', 'info');\r\n      return false;\r\n    }\r\n    const bookName = $container.data('book-name');\r\n    const entryId = Number($container.data('id'));\r\n    if (!bookName || Number.isNaN(entryId)) return false;\r\n    const entry = safeGetLorebookEntries(bookName).find(e => e.uid === entryId);\r\n    if (!entry) return false;\r\n    renderLoreEntryEditor($container, entry, { animate });\r\n    return true;\r\n  };\r\n\r\n  const exitLoreEdit = ($container, options = {}) => {\r\n    const { animate = false } = options;\r\n    if (!$container.length) return false;\r\n    const bookName = $container.data('book-name');\r\n    const entryId = Number($container.data('id'));\r\n    if (!bookName || Number.isNaN(entryId)) return false;\r\n    const entry = safeGetLorebookEntries(bookName).find(e => e.uid === entryId);\r\n    if (!entry) return false;\r\n    const searchTerm = $container.data('searchTerm') || '';\r\n    renderLoreEntryViewer($container, entry, searchTerm, { animate });\r\n    return true;\r\n  };\r\n\r\n  const enterRegexEdit = ($container, options = {}) => {\r\n    const { animate = false, silent = false } = options;\r\n    if (!$container.length) return false;\r\n    if (appState.multiSelectMode) {\r\n      if (!silent) showToast('\u8BF7\u5148\u9000\u51FA\u591A\u9009\u6A21\u5F0F\u540E\u518D\u7F16\u8F91\u3002', 'info');\r\n      return false;\r\n    }\r\n    const id = $container.data('id');\r\n    const regexItem = findRegexItemById(id);\r\n    if (!regexItem) return false;\r\n    renderRegexEditor($container, regexItem, { animate });\r\n    return true;\r\n  };\r\n\r\n  const exitRegexEdit = ($container, options = {}) => {\r\n    const { animate = false } = options;\r\n    if (!$container.length) return false;\r\n    const id = $container.data('id');\r\n    const regexItem = findRegexItemById(id);\r\n    if (!regexItem) return false;\r\n    const searchTerm = $container.data('searchTerm') || '';\r\n    renderRegexViewer($container, regexItem, searchTerm, { animate });\r\n    return true;\r\n  };\r\n\r\n\r\n  const handleEntryEnterEdit = errorCatched(async event => {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $container = $(event.currentTarget).closest('.rlh-item-container');\r\n    enterLoreEdit($container, { animate: false });\r\n  });\r\n  const handleEntryExitEdit = errorCatched(async event => {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $container = $(event.currentTarget).closest('.rlh-item-container');\r\n    exitLoreEdit($container, { animate: false });\r\n  });\r\n  const handleRegexEnterEdit = errorCatched(async event => {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $container = $(event.currentTarget).closest('.rlh-item-container');\r\n    enterRegexEdit($container, { animate: false });\r\n  });\r\n  const handleRegexExitEdit = errorCatched(async event => {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const $container = $(event.currentTarget).closest('.rlh-item-container');\r\n    exitRegexEdit($container, { animate: false });\r\n  });\r\n  const handleToggleState = errorCatched(async event => {\r\n  event.stopPropagation();\r\n  const $button = $(event.currentTarget);\r\n  const $elementToSort = $button.closest('.rlh-book-group, .rlh-item-container');\r\n  if ($elementToSort.hasClass('renaming')) return;\r\n  const isEnabling = !$elementToSort.hasClass('enabled');\r\n  const parentList = $elementToSort.parent();\r\n  if ($button.hasClass('rlh-global-toggle')) {\r\n    $button.addClass('rlh-loading');\r\n    try {\r\n      const bookName = $elementToSort.data('book-name');\r\n      const currentBooks = new Set(await TavernAPI.getGlobalWorldbookNames() || []);\r\n      if (isEnabling) currentBooks.add(bookName);\r\n      else currentBooks.delete(bookName);\r\n      await TavernAPI.rebindGlobalWorldbooks(Array.from(currentBooks));\r\n      await TavernAPI.saveSettings();\r\n      const bookState = appState.allLorebooks.find(b => b.name === bookName);\r\n      if (bookState) bookState.enabled = isEnabling;\r\n    } finally {\r\n      $button.removeClass('rlh-loading');\r\n    }\r\n  } else {\r\n    const type = $elementToSort.data('type');\r\n    const id = $elementToSort.data('id');\r\n    if (type === 'lore') {\r\n      const bookName = $elementToSort.data('book-name');\r\n      await updateWorldbookEntries(bookName, [{ uid: Number(id), enabled: isEnabling }]);\r\n      const entry = safeGetLorebookEntries(bookName).find(e => e.uid === Number(id));\r\n      if (entry) entry.enabled = isEnabling;\r\n    } else {\r\n      const allServerRegexes = await TavernAPI.getRegexes();\r\n      const regex = allServerRegexes.find(r => r.id === id);\r\n      if (regex) {\r\n        regex.enabled = isEnabling;\r\n        await TavernAPI.replaceRegexes(allServerRegexes.filter(r => r.source !== 'card'));\r\n        await TavernAPI.saveSettings();\r\n        const localRegex =\r\n          appState.regexes.global.find(r => r.id === id) || appState.regexes.character.find(r => r.id === id);\r\n        if (localRegex) localRegex.enabled = isEnabling;\r\n      }\r\n    }\r\n  }\r\n  showToast(isEnabling ? '\u5DF2\u542F\u7528' : '\u5DF2\u7981\u7528');\r\n  $elementToSort.toggleClass('enabled', isEnabling);\r\n  const items = parentList.children().get();\r\n  items.sort((a, b) => {\r\n    const aEnabled = $(a).hasClass('enabled');\r\n    const bEnabled = $(b).hasClass('enabled');\r\n    if (aEnabled !== bEnabled) return bEnabled - aEnabled;\r\n    const aName = $(a).find('.rlh-item-name').text().trim();\r\n    const bName = $(b).find('.rlh-item-name').text().trim();\r\n    return aName.localeCompare(bName);\r\n  });\r\n  parentList.append(items);\r\n  });\r\n  const handleRename = errorCatched(async event => {\r\n    event.stopPropagation();\r\n    const $button = $(event.currentTarget);\r\n    const $container = $button.closest('.rlh-item-container');\r\n    if (!$container.length) return;\r\n\r\n    const type = $container.data('type');\r\n    const isEditing = $container.attr('data-entry-mode') === 'edit';\r\n\r\n    if (isEditing) {\r\n      exitRenameMode($container);\r\n      if (type === 'lore') exitLoreEdit($container, { animate: false });\r\n      else exitRegexEdit($container, { animate: false });\r\n      return;\r\n    }\r\n\r\n    if (appState.multiSelectMode) {\r\n      showToast('\u8BF7\u5148\u9000\u51FA\u591A\u9009\u6A21\u5F0F\u540E\u518D\u7F16\u8F91\u3002', 'info');\r\n      return;\r\n    }\r\n\r\n    const $header = $container.find('.rlh-item-header').first();\r\n    const $nameSpan = $header.find('.rlh-item-name').first();\r\n    const oldName = $nameSpan.clone().children().remove().end().text().trim();\r\n    const renameUIHtml = `<div class=\"rlh-rename-ui\"><div class=\"rlh-rename-input-wrapper\"><input type=\"text\" class=\"rlh-rename-input\" value=\"${escapeHtml(oldName)}\" /><button class=\"rlh-action-btn-icon rlh-rename-save-btn\" title=\"\u786E\u8BA4\"><i class=\"fa-solid fa-check\"></i></button></div></div>`;\r\n\r\n    let entered = false;\r\n    if (type === 'lore') entered = enterLoreEdit($container, { animate: false, silent: true });\r\n    else entered = enterRegexEdit($container, { animate: false, silent: true });\r\n    if (!entered) return;\r\n\r\n    if (!$header.find('.rlh-rename-ui').length) {\r\n      $container.addClass('renaming');\r\n      $header.append(renameUIHtml);\r\n    }\r\n\r\n    $nameSpan.attr('aria-hidden', 'true').hide();\r\n    $header.find('.rlh-rename-input').focus().select();\r\n  });\r\n  const exitRenameMode = ($container, newName = null) => {\r\n  const $header = $container.find('.rlh-item-header').first();\r\n  const $nameSpan = $header.find('.rlh-item-name').first();\r\n  if (newName) {\n    $nameSpan.text(newName);\n  }\n  $header.find('.rlh-rename-ui').remove();\n  if ($container.attr('data-entry-mode') === 'edit') {\n    $nameSpan.hide().attr('aria-hidden', 'true');\n  } else {\n    $nameSpan.show().removeAttr('aria-hidden');\n  }\n  $container.removeClass('renaming');\n  };\n  const handleConfirmRename = errorCatched(async event => {\r\n    event.stopPropagation();\r\n    const $container = $(event.currentTarget).closest('.rlh-item-container');\r\n    const type = $container.data('type');\r\n    const exitEditMode = () => {\r\n      if (type === 'lore') {\r\n        exitLoreEdit($container, { animate: false });\r\n      } else {\r\n        exitRegexEdit($container, { animate: false });\r\n      }\r\n    };\r\n    const $input = $container.find('.rlh-rename-input');\r\n    const newName = $input.val().trim();\r\n    const oldName = $container.find('.rlh-item-name').first().text().trim();\r\n    if (!newName || newName === oldName) {\r\n      exitRenameMode($container, oldName);\r\n      exitEditMode();\r\n      return;\r\n    }\r\n    const id = $container.data('id');\r\n    if (type === 'lore') {\r\n      const bookName = $container.data('book-name');\r\n      await updateWorldbookEntries(bookName, [{ uid: Number(id), name: newName }]);\r\n      const entries = [...safeGetLorebookEntries(bookName)];\r\n      const entry = entries.find(e => e.uid === Number(id));\r\n      if (entry) entry.name = newName;\r\n    } else {\r\n      // type === 'regex'\r\n      const allServerRegexes = await TavernAPI.getRegexes();\r\n      const regex = allServerRegexes.find(r => r.id === id);\r\n      if (regex) {\r\n        regex.script_name = newName;\r\n        await TavernAPI.replaceRegexes(allServerRegexes.filter(r => r.source !== 'card'));\r\n        await TavernAPI.saveSettings();\r\n        const localRegex =\r\n          appState.regexes.global.find(r => r.id === id) || appState.regexes.character.find(r => r.id === id);\r\n        if (localRegex) localRegex.script_name = newName;\r\n      }\r\n    }\r\n    exitRenameMode($container, newName);\r\n    exitEditMode();\r\n    showToast('\u91CD\u547D\u540D\u6210\u529F');\r\n  });\r\n\r\n  const handleRenameKeydown = errorCatched(async event => {\r\n  if (event.key === 'Enter') {\r\n    $(event.currentTarget).siblings('.rlh-rename-save-btn').click();\r\n  } else if (event.key === 'Escape') {\r\n    event.preventDefault();\r\n    const $container = $(event.currentTarget).closest('.rlh-item-container');\r\n    exitRenameMode($container);\r\n  }\r\n  });\r\n  const handleEditorExpandToggle = errorCatched(async event => {\r\n    event.stopPropagation();\r\n    const $button = $(event.currentTarget);\r\n    const $editorWrapper = $button.closest('.rlh-editor-wrapper');\r\n    // \u540C\u65F6\u5904\u7406 textarea \u548C contenteditable div\uFF0C\u786E\u4FDD\u529F\u80FD\u5728\u4E24\u79CD\u7F16\u8F91\u5668\u4E2D\u90FD\u53EF\u7528\r\n    const $editors = $editorWrapper.find('textarea, .rlh-edit-content');\r\n    // \u901A\u8FC7\u68C0\u67E5\u56FE\u6807\u7684 class \u6765\u5224\u65AD\u5F53\u524D\u72B6\u6001\uFF0C\u5B9E\u73B0\u81EA\u5305\u542B\u903B\u8F91\r\n    const isCollapsed = $button.find('i').hasClass('fa-expand');\r\n    if (isCollapsed) {\r\n      // \u5982\u679C\u662F\u6536\u7F29\u72B6\u6001\uFF0C\u5219\u5C55\u5F00\r\n      $button.attr('title', '\u6536\u7F29').find('i').removeClass('fa-expand').addClass('fa-compress');\r\n      $editors.each(function () {\r\n        // \u81EA\u52A8\u8C03\u6574\u9AD8\u5EA6\u4EE5\u9002\u5E94\u5185\u5BB9\r\n        this.style.height = 'auto';\r\n        this.style.height = this.scrollHeight + 'px';\r\n      });\r\n    } else {\r\n      // \u5982\u679C\u662F\u5C55\u5F00\u72B6\u6001\uFF0C\u5219\u6536\u7F29\r\n      $button.attr('title', '\u5C55\u5F00').find('i').removeClass('fa-compress').addClass('fa-expand');\r\n      $editors.css('height', ''); // \u6062\u590D\u9ED8\u8BA4\u9AD8\u5EA6\r\n    }\r\n  });\r\n  const handleCreateEntry = debounce(errorCatched(async (event) => {\r\n    const $button = $(event.currentTarget);\r\n    const explicitBookName = $button.data('book-name');\r\n    const context = getViewContext();\r\n    const activeBookName = context.activeBookName ?? appState.activeBookName ?? appState.activeCharacterBook ?? appState.chatLorebook ?? '';\r\n    const bookName = explicitBookName || activeBookName;\r\n    if (!bookName) {\r\n      await showModal({ type: 'alert', title: '\u521B\u5EFA\u5931\u8D25', text: '\u5F53\u524D\u6CA1\u6709\u9009\u4E2D\u7684\u4E16\u754C\u4E66\uFF0C\u65E0\u6CD5\u521B\u5EFA\u6761\u76EE\u3002' });\r\n      return;\r\n    }\r\n    // 1. \u524D\u7AEF\u7ACB\u5373\u54CD\u5E94\uFF1A\u521B\u5EFA\u5185\u5B58\u4E2D\u7684\u4E34\u65F6\u6761\u76EE\r\n    const tempEntry = createInMemoryEntry(bookName);\r\n    // 2. \u7ACB\u5373\u6E32\u67D3\u65B0\u6761\u76EE\u5230\u5217\u8868\u9876\u90E8\u5E76\u5C55\u5F00\r\n    const $newEntryDom = prependEntry(tempEntry, bookName);\r\n    // \u81EA\u52A8\u89E6\u53D1\u91CD\u547D\u540D\r\n    if ($newEntryDom && $newEntryDom.length) {\r\n      const renameButton = $newEntryDom.find('.rlh-rename-btn');\r\n      if (renameButton.length) {\r\n        renameButton.trigger('click');\r\n      }\r\n    }\r\n    try {\r\n      // 3. \u5F02\u6B65\u8C03\u7528API\r\n      const result = await TavernAPI.createWorldbookEntries(bookName, [{\r\n        name: tempEntry.name,\r\n        enabled: tempEntry.enabled,\r\n        keys: tempEntry.keys,\r\n      }]);\r\n      if (result && result.new_entries && result.new_entries.length > 0) {\r\n        safeSetLorebookEntries(bookName, result.worldbook.map(normalizeWorldbookEntry));\r\n        const serverEntry = result.new_entries[0];\r\n        if (serverEntry) {\r\n          // 4. API\u6210\u529F\u540E\uFF0C\u7528\u771F\u5B9E\u6570\u636E\u66F4\u65B0\u5185\u5B58\u6761\u76EE\u548CDOM\r\n          updateInMemoryEntry(bookName, tempEntry.uid, serverEntry);\r\n          const $entryDom = $(`#${'rlh-panel'} .rlh-item-container[data-id=\"${tempEntry.uid}\"]`, parentDoc);\r\n          if ($entryDom.length) {\r\n            $entryDom.attr('data-id', serverEntry.uid);\r\n            $entryDom.data('id', serverEntry.uid); // \u66F4\u65B0jQuery data\r\n          }\r\n        }\r\n        updateBookSummary(bookName);\r\n        showToast('\u65B0\u6761\u76EE\u5DF2\u521B\u5EFA');\r\n      } else {\r\n        throw new Error('API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u4E0D\u6B63\u786E');\r\n      }\r\n    } catch (error) {\r\n      // 5. API\u5931\u8D25\u540E\uFF0C\u663E\u793A\u9519\u8BEF\u5E76\u4FDD\u6301\u524D\u7AEF\u6761\u76EE\u53EF\u7F16\u8F91\r\n      console.error('[RegexLoreHub] Create entry failed:', error);\r\n      showModal({ type: 'alert', title: '\u521B\u5EFA\u5931\u8D25', text: `\u521B\u5EFA\u65B0\u6761\u76EE\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u4F46\u60A8\u4ECD\u53EF\u7F16\u8F91\u5F53\u524D\u5185\u5BB9\u5E76\u624B\u52A8\u4FDD\u5B58\u3002\u9519\u8BEF: ${error.message}` });\r\n    }\r\n  }), 300);\r\n  const handleDeleteEntry = errorCatched(async event => {\r\n  event.stopPropagation();\r\n  const $item = $(event.currentTarget).closest('.rlh-item-container');\r\n  const bookName = $item.data('book-name');\r\n  const uid = Number($item.data('id'));\r\n  const entryName = $item.find('.rlh-item-name').text().trim();\r\n  try {\r\n    await showModal({ type: 'confirm', title: '\u786E\u8BA4\u5220\u9664', text: `\u60A8\u786E\u5B9A\u8981\u5220\u9664\u6761\u76EE \"${entryName}\" \u5417\uFF1F` });\r\n  } catch {\r\n    return;\r\n  }\r\n  const result = await TavernAPI.deleteWorldbookEntries(bookName, [uid]);\r\n  // \u4F7F\u7528\u65B0\u7684API\u54CD\u5E94\u7ED3\u6784\r\n  if (result && result.deleted_entries && result.deleted_entries.length > 0) {\r\n    safeSetLorebookEntries(bookName, result.worldbook.map(normalizeWorldbookEntry));\r\n    updateBookSummary(bookName);\r\n    $item.slideUp(300, () => $item.remove());\r\n    showToast('\u5220\u9664\u6210\u529F');\r\n  } else {\r\n    await showModal({ type: 'alert', title: '\u5220\u9664\u5931\u8D25', text: '\u5220\u9664\u6761\u76EE\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002' });\r\n  }\r\n  });\r\n  const handlePositionChange = errorCatched(async event => {\r\n  const $select = $(event.currentTarget);\r\n  const $depthContainer = $select.closest('.rlh-editor-grid').find('.rlh-depth-container');\r\n  if ($select.val().startsWith('at_depth')) {\r\n    $depthContainer.slideDown(200);\r\n  } else {\r\n    $depthContainer.slideUp(200);\r\n  }\r\n  });\r\n  return {\r\n    handleToggleState,\r\n    handleEditorInput,\r\n    renderLoreEntryViewer,\r\n    renderLoreEntryEditor,\r\n    renderRegexViewer,\r\n    renderRegexEditor,\r\n    handleEntryEnterEdit,\r\n    handleEntryExitEdit,\r\n    handleRegexEnterEdit,\r\n    handleRegexExitEdit,\r\n    handleRename,\r\n    handleConfirmRename,\r\n    handleRenameKeydown,\r\n    handleEditorExpandToggle,\r\n    handleCreateEntry,\r\n    handleDeleteEntry,\r\n    handlePositionChange,\r\n  };\r\n}\r\n", "import {\r\n  buildSearchRegex,\r\n  PANEL_ID,\r\n  BUTTON_ID,\r\n  SEARCH_INPUT_ID,\r\n  REPLACE_INPUT_ID,\r\n  CREATE_LOREBOOK_BTN_ID,\r\n  TOGGLE_COLLAPSE_BTN_ID,\r\n  appState,\r\n  DOM_ID,\r\n  safeGetLorebookEntries,\r\n  safeSetLorebookEntries,\r\n  safeDeleteLorebookEntries,\r\n  errorCatched,\r\n  showModal,\r\n  showToast,\r\n  showProgressToast,\r\n  get$,\n  getParentDoc,\n  escapeHtml,\n  SORT_MENU_ID,\n  SORT_MENU_BUTTON_ID,\n  POSITION_MENU_ID,\n  POSITION_MENU_BUTTON_ID,\n} from '../../core.js';\n\r\nimport {\r\n  TavernAPI,\r\n  loadAllData,\r\n  loadLorebookEntriesIfNeeded,\r\n  saveAllChanges,\r\n  syncContextWithAppState,\r\n  refreshCharacterData,\r\n  updateBookSummary,\r\n  normalizeWorldbookEntry,\r\n  updateWorldbookEntries,\n  updateRegexOrderMetadata,\n} from '../../dataLayer.js';\n\r\nimport { renderContent, getViewContext, getContextInstanceKey } from '../render/index.js';\r\nimport { getGlobalLorebookMatches } from '../render/lorebook.js';\r\nimport { getRegexMatches } from '../render/regex.js';\r\nimport { updateSelectionCount, setActiveCollapseState, setActiveSortMode, buildReplaceConfirmationHTML } from '../render/shared.js';\n\r\n/**\r\n * \u663E\u793A\u4E00\u4E2A\u786E\u8BA4\u5F39\u7A97\uFF0C\u8BE6\u7EC6\u5217\u51FA\u5C06\u88AB\u66FF\u6362\u7684\u4E16\u754C\u4E66\u53CA\u5176\u6761\u76EE\u3002\r\n * @param {Array<object>} matches - \u5339\u914D\u9879\u6570\u7EC4\u3002\r\n * @param {object} stats - \u5206\u7C7B\u7EDF\u8BA1\u5BF9\u8C61\u3002\r\n * @param {string} searchTerm - \u8981\u641C\u7D22\u7684\u8BCD\u3002\r\n * @param {string} replaceTerm - \u7528\u4E8E\u66FF\u6362\u7684\u8BCD\u3002\r\n * @returns {Promise<boolean>} - \u7528\u6237\u786E\u8BA4\u5219 resolve(true)\uFF0C\u5426\u5219 reject\u3002\r\n */\r\nconst showReplaceConfirmationModal = (matches, stats, booksMatchedByNameOnly, searchTerm, replaceTerm, context) => {\r\n\r\n  const modalContent = buildReplaceConfirmationHTML(matches, stats, booksMatchedByNameOnly, searchTerm, replaceTerm, context);\r\n\r\n  // 2. \u8C03\u7528\u6838\u5FC3 showModal\r\n  return showModal({\r\n    type: 'confirm',\r\n    title: '\u786E\u8BA4\u66FF\u6362',\r\n    html: modalContent,\r\n  });\r\n};\r\n\r\n// \u9876\u90E8\u5DE5\u5177\u680F\u6298\u53E0/\u5C55\u5F00\u6309\u94AE\r\nexport const toggleToolbar = errorCatched(async event => {\r\n  const $ = get$();\r\n  const parentDoc = getParentDoc();\r\n\r\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\r\n  if (!$panel.length) return;\r\n\r\n  let $toolbarShell = $panel.find(`#${DOM_ID.TOOLBAR_SHELL}`);\r\n  if (!$toolbarShell.length) {\r\n    $toolbarShell = $panel.find('.rlh-toolbar-shell').first();\r\n    if ($toolbarShell.length) {\r\n      $toolbarShell.attr('id', DOM_ID.TOOLBAR_SHELL);\r\n    }\r\n  }\r\n  if (!$toolbarShell.length) return;\r\n\r\n  const willCollapse = !$toolbarShell.hasClass('rlh-toolbar-shell--collapsed');\r\n\r\n  event?.preventDefault?.();\r\n  event?.stopPropagation?.();\r\n\r\n  $toolbarShell.toggleClass('rlh-toolbar-shell--collapsed', willCollapse);\r\n  $toolbarShell.attr('aria-hidden', String(willCollapse));\r\n\r\n  appState.isToolbarCollapsed = willCollapse;\r\n\r\n  const $toggleButton = event?.currentTarget ? $(event.currentTarget) : $panel.find(`#${DOM_ID.TOGGLE_TOOLBAR_BTN}`);\r\n  if ($toggleButton.length) {\r\n    $toggleButton.text(willCollapse ? '\u5C55\u5F00\u5DE5\u5177\u680F' : '\u6298\u53E0\u5DE5\u5177\u680F');\r\n    $toggleButton.attr('aria-expanded', String(!willCollapse));\r\n    $toggleButton.attr('title', willCollapse ? '\u5C55\u5F00\u5DE5\u5177\u680F' : '\u6298\u53E0\u5DE5\u5177\u680F');\r\n  }\r\n});\r\n// --- UI \u4E8B\u4EF6\u5904\u7406 ---\r\nexport function createUIHandlers(deps = {}) {\r\n  const $ = deps.$ ?? get$();\r\n  const parentDoc = deps.parentDoc ?? getParentDoc();\r\n  const lorebookHandlers = deps.lorebookHandlers;\r\n  const itemHandlers = deps.itemHandlers;\r\n  const getTargetKeyPrefix = () => {\r\n    switch (appState.multiSelectTarget) {\r\n      case 'book':\r\n        return 'book:';\r\n      case 'entry':\r\n        return 'lore:';\r\n      case 'regex':\r\n        return 'regex:';\r\n      default:\r\n        return '';\r\n    }\r\n  };\r\n\r\n  const parseSelectionKey = rawKey => {\r\n    const key = String(rawKey ?? '');\r\n    const firstSepIndex = key.indexOf(':');\r\n    if (firstSepIndex === -1) {\r\n      return { type: key, raw: '' };\r\n    }\r\n\r\n    const type = key.slice(0, firstSepIndex);\r\n    const remainder = key.slice(firstSepIndex + 1);\r\n\r\n    if (type === 'book') {\r\n      return { type, bookName: remainder };\r\n    }\r\n\r\n    if (type === 'lore') {\r\n      const lastSepIndex = remainder.lastIndexOf(':');\r\n      if (lastSepIndex === -1) {\r\n        return { type, bookName: remainder, entryId: null };\r\n      }\r\n      return {\r\n        type,\r\n        bookName: remainder.slice(0, lastSepIndex),\r\n        entryId: remainder.slice(lastSepIndex + 1),\r\n      };\r\n    }\r\n\r\n    if (type === 'regex') {\r\n      return { type, regexId: remainder };\r\n    }\r\n\r\n    return { type, raw: remainder };\r\n  };\r\n\r\n  const getVisibleSelectKeys = () => {\r\n    if (!appState.multiSelectMode) return [];\r\n    const $panel = $(`#${PANEL_ID}`, parentDoc);\r\n    if (!$panel.length) return [];\r\n\r\n    let selector;\r\n    switch (appState.multiSelectTarget) {\r\n      case 'book':\r\n        selector = '.rlh-book-group[data-select-key]';\r\n        break;\r\n      case 'entry':\r\n        selector = '.rlh-item-container[data-select-key][data-type=\"lore\"]';\r\n        break;\r\n      case 'regex':\r\n        selector = '.rlh-item-container[data-select-key][data-type=\"regex\"]';\r\n        break;\r\n      default:\r\n        selector = '[data-select-key]';\r\n        break;\r\n    }\r\n\r\n    const keys = [];\r\n    $panel.find(selector).each((_, el) => {\r\n      const $el = $(el);\r\n      if (!$el.is(':visible')) return;\r\n      const key = $el.data('select-key');\r\n      if (key) keys.push(String(key));\r\n    });\r\n    return keys;\r\n  };\r\n\r\n  const hasSelectionForCurrentTarget = () => {\r\n    if (!appState.selectedItems || appState.selectedItems.size === 0) return false;\r\n    const prefix = getTargetKeyPrefix();\r\n    if (!prefix) return appState.selectedItems.size > 0;\r\n    for (const key of appState.selectedItems) {\r\n      if (key.startsWith(prefix)) return true;\r\n    }\r\n    return false;\r\n  };\r\n\r\n  const resolveSelectionKey = $container => {\r\n    if (!$container || !$container.length) return null;\r\n    if ($container.hasClass('rlh-book-group')) {\r\n      if (appState.multiSelectTarget !== 'book') return null;\r\n      const bookName = $container.data('book-name');\r\n      return bookName ? `book:${bookName}` : null;\r\n    }\r\n    if ($container.hasClass('rlh-item-container')) {\r\n      const itemType = $container.data('type');\r\n      const itemId = $container.data('id');\r\n      if (itemType === 'lore' && appState.multiSelectTarget === 'entry') {\r\n        const bookName = $container.data('book-name');\r\n        return bookName != null && itemId != null ? `lore:${bookName}:${itemId}` : null;\r\n      }\r\n      if (itemType === 'regex' && appState.multiSelectTarget === 'regex') {\r\n        return itemId != null ? `regex:${itemId}` : null;\r\n      }\r\n    }\r\n    return null;\r\n  };\r\n\r\n  const toggleSelectionForContainer = $container => {\r\n    const itemKey = resolveSelectionKey($container);\r\n    if (!itemKey) return false;\r\n    if (appState.selectedItems.has(itemKey)) {\r\n      appState.selectedItems.delete(itemKey);\r\n      $container.removeClass('selected');\r\n      $container.find('.rlh-multi-select-checkbox').prop('checked', false);\r\n    } else {\r\n      appState.selectedItems.add(itemKey);\r\n      $container.addClass('selected');\r\n      $container.find('.rlh-multi-select-checkbox').prop('checked', true);\r\n    }\r\n    updateSelectionCount();\r\n    return true;\r\n  };\r\n\r\n  const handleGlobalSearch = errorCatched(async (event) => {\r\n    const $target = $(event.currentTarget);\r\n    const value = $target.val();\r\n\r\n    if ($target.attr('id') === 'rlh-global-search-input') {\r\n        appState.globalSearch.term = value;\r\n    } else if ($target.attr('id') === 'rlh-global-replace-input') {\r\n        appState.globalSearch.replace = value;\r\n    }\r\n\r\n    // \u4EC5\u5F53\u641C\u7D22\u8BCD\u53D8\u5316\u65F6\u624D\u91CD\u7ED8\u4EE5\u5E94\u7528\u9AD8\u4EAE\r\n    if ($target.attr('id') === 'rlh-global-search-input') {\r\n        renderContent();\r\n    }\r\n  });\r\n  const handleSearchInputKeydown = errorCatched(async event => {\r\n    if (event.key === 'Enter') {\r\n      event.preventDefault();\r\n      const term = event.currentTarget.value ?? '';\r\n      appState.globalSearch.term = term;\r\n      renderContent();\r\n    }\r\n  });\r\n\r\n  const handleSearchClear = errorCatched(async () => {\r\n    const $input = $(`#${SEARCH_INPUT_ID}`, parentDoc);\r\n    if ($input.length) $input.val('');\r\n    appState.globalSearch.term = '';\r\n    renderContent();\r\n  });\r\n\r\n  const handleReplace = errorCatched(async () => {\r\n    const searchTerm = $(`#${SEARCH_INPUT_ID}`, parentDoc).val();\r\n    const replaceTerm = $(`#${REPLACE_INPUT_ID}`, parentDoc).val();\r\n    const context = getViewContext();\r\n\r\n    if (!searchTerm) {\r\n      await showModal({ type: 'alert', title: '\u66FF\u6362\u5931\u8D25', text: '\u8BF7\u5148\u8F93\u5165\u641C\u7D22\u8BCD\u3002' });\r\n      return;\r\n    }\r\n\r\n    // \u66FF\u6362\u8BCD\u53EF\u4EE5\u4E3A\u7A7A\uFF0C\u8868\u793A\u5220\u9664\r\n    // if (!replaceTerm) {\r\n    //   await showModal({ type: 'alert', title: '\u66FF\u6362\u5931\u8D25', text: '\u8BF7\u5148\u8F93\u5165\u66FF\u6362\u8BCD\u3002' });\r\n    //   return;\r\n    // }\r\n\r\n    // \u6838\u5FC3\u903B\u8F91\uFF1A\u5728\u5168\u5C40\u641C\u7D22\u524D\uFF0C\u786E\u4FDD\u6240\u6709\u4E16\u754C\u4E66\u6761\u76EE\u5DF2\u52A0\u8F7D\r\n    if (context.view === 'global-lore-list') {\r\n      const booksToLoad = appState.allLorebooks.filter(b => !b.entriesLoaded);\r\n      if (booksToLoad.length > 0) {\r\n        const progressToast = showProgressToast(`\u6B63\u5728\u52A0\u8F7D ${booksToLoad.length} \u672C\u4E16\u754C\u4E66\u7684\u6761\u76EE...`);\r\n        try {\r\n          await Promise.all(booksToLoad.map(b => loadLorebookEntriesIfNeeded(b.name)));\r\n          progressToast.remove();\r\n        } catch (error) {\r\n          progressToast.remove();\r\n          console.error('[RegexLoreHub] Failed to load entries before replace:', error);\r\n          await showModal({\r\n            type: 'alert',\r\n            title: '\u52A0\u8F7D\u5931\u8D25',\r\n            text: '\u5728\u6267\u884C\u66FF\u6362\u524D\u52A0\u8F7D\u4E16\u754C\u4E66\u6761\u76EE\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002',\r\n          });\r\n          return;\r\n        }\r\n      }\r\n    }\r\n\r\n    let matches, stats, booksMatchedByNameOnly;\r\n    // \u4F7F\u7528 context \u5BF9\u8C61\u5224\u65AD\u5F53\u524D\u89C6\u56FE\uFF0C\u800C\u4E0D\u662F appState\r\n    if (context.type === 'lore') {\r\n      if (context.view === 'global-lore-list' || context.view === 'global-lore-detail') {\r\n        ({ matches, stats, booksMatchedByNameOnly } = getGlobalLorebookMatches(searchTerm));\r\n      } else {\r\n        await showModal({ type: 'alert', title: '\u64CD\u4F5C\u65E0\u6548', text: '\u5F53\u524D\u89C6\u56FE\u4E0D\u652F\u6301\u66FF\u6362\u529F\u80FD\u3002' });\r\n        return;\r\n      }\r\n    } else if (context.type === 'regex') {\r\n      ({ matches, stats } = getRegexMatches(searchTerm));\r\n    } else {\r\n      await showModal({ type: 'alert', title: '\u64CD\u4F5C\u65E0\u6548', text: '\u672A\u77E5\u7684\u89C6\u56FE\u7C7B\u578B\uFF0C\u65E0\u6CD5\u6267\u884C\u66FF\u6362\u3002' });\r\n      return;\r\n    }\r\n\r\n    if ((!matches || matches.length === 0) && (!booksMatchedByNameOnly || booksMatchedByNameOnly.length === 0)) {\r\n      await showModal({ type: 'alert', title: '\u65E0\u5339\u914D\u9879', text: '\u672A\u627E\u5230\u53EF\u66FF\u6362\u7684\u6761\u76EE\u3002' });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // \u4F7F\u7528\u65B0\u7684\u8BE6\u7EC6\u786E\u8BA4\u5F39\u7A97\uFF0C\u5E76\u4F20\u9012 stats \u5BF9\u8C61\r\n      const modalContext = context.type === 'lore' ? 'lorebook' : 'regex';\r\n      await showReplaceConfirmationModal(matches, stats, booksMatchedByNameOnly, searchTerm, replaceTerm, modalContext);\r\n\r\n      // \u7528\u6237\u786E\u8BA4\u540E\u6267\u884C\u66FF\u6362\r\n      const progressToast = showProgressToast('\u6B63\u5728\u6267\u884C\u66FF\u6362...');\r\n      try {\r\n        await performReplace(matches, searchTerm, replaceTerm);\r\n        progressToast.remove();\r\n        showToast('\u66FF\u6362\u5B8C\u6210');\r\n        renderContent(); // \u5237\u65B0\u89C6\u56FE\r\n      } catch (error) {\r\n        progressToast.remove();\r\n        console.error('[RegexLoreHub] Replace error:', error);\r\n        await showModal({\r\n          type: 'alert',\r\n          title: '\u66FF\u6362\u5931\u8D25',\r\n          text: '\u66FF\u6362\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u83B7\u53D6\u8BE6\u7EC6\u4FE1\u606F\u3002',\r\n        });\r\n      }\r\n    } catch (error) {\r\n      // \u7528\u6237\u5728\u786E\u8BA4\u5F39\u7A97\u4E2D\u70B9\u51FB\u4E86\u201C\u53D6\u6D88\u201D\uFF0C\u65E0\u9700\u4EFB\u4F55\u64CD\u4F5C\r\n      console.log('[RegexLoreHub] Replace operation cancelled by user.');\r\n    }\r\n  });\r\n  const handleToolbarToggleCollapse = errorCatched(async () => {\r\n    const context = getViewContext();\r\n    if (!context.showCollapseToggle) return;\r\n\r\n    const key = getContextInstanceKey(context);\r\n    const current = appState.collapseStateByContext.get(key) ?? 'expanded';\r\n    const nextState = current === 'collapsed' ? 'expanded' : 'collapsed';\r\n    setActiveCollapseState(context, nextState);\r\n\r\n    // \u67E5\u627E\u6240\u6709\u53EF\u89C1\u7684\u3001\u53EF\u6298\u53E0\u7684\u9876\u5C42\u5143\u7D20\r\n    const $containers = $(\r\n      `#${PANEL_ID}-content .rlh-item-container:visible, #${PANEL_ID}-content .rlh-book-group:visible`,\r\n      parentDoc,\r\n    );\r\n\r\n    $containers.each(function () {\r\n      const $container = $(this);\r\n      const $content = $container.find('.rlh-collapsible-content').first();\r\n      const isCurrentlyVisible = $content.is(':visible');\r\n      const $header = $container.find('.rlh-item-header, .rlh-global-book-header').first();\r\n\r\n      // \u5982\u679C\u9700\u8981\u5C55\u5F00\u4F46\u5F53\u524D\u662F\u6298\u53E0\u7684\uFF0C\u5219\u89E6\u53D1\u70B9\u51FB\uFF08\u5E26\u6279\u91CF\u64CD\u4F5C\u6807\u8BB0\uFF09\r\n      if (nextState === 'expanded' && !isCurrentlyVisible) {\r\n        $header.trigger('click.rlh', { bulk: true });\r\n      }\r\n      // \u5982\u679C\u9700\u8981\u6298\u53E0\u4F46\u5F53\u524D\u662F\u5C55\u5F00\u7684\uFF0C\u4E5F\u89E6\u53D1\u70B9\u51FB\r\n      else if (nextState === 'collapsed' && isCurrentlyVisible) {\r\n        $header.trigger('click.rlh', { bulk: true });\r\n      }\r\n    });\r\n\r\n    // \u624B\u52A8\u66F4\u65B0\u6309\u94AE\u72B6\u6001\u4EE5\u907F\u514D\u5B8C\u5168\u91CD\u7ED8\r\n    const $button = $(`#${TOGGLE_COLLAPSE_BTN_ID}`, parentDoc);\r\n    if ($button.length) {\r\n      const iconClass = nextState === 'collapsed' ? 'fa-expand-arrows-alt' : 'fa-compress-arrows-alt';\r\n      const label = nextState === 'collapsed' ? '\u5168\u90E8\u5C55\u5F00' : '\u5168\u90E8\u6298\u53E0';\r\n      $button.attr('data-collapse-state', nextState);\r\n      $button.find('i').removeClass('fa-expand-arrows-alt fa-compress-arrows-alt').addClass(iconClass);\r\n      $button.find('span').text(label);\r\n    }\r\n  });\n\n\n\n\n  let sortMenuListenersActive = false;\n\n  function getSortMenuElements() {\n    return {\n      $menu: $(`#${SORT_MENU_ID}`, parentDoc),\n      $button: $(`#${SORT_MENU_BUTTON_ID}`, parentDoc),\n    };\n  }\n\n  function handleSortMenuOutsideClick(event) {\n    if (!sortMenuListenersActive) return;\n    const $target = $(event.target);\n    if ($target.closest(`#${SORT_MENU_ID}`).length) return;\n    if ($target.closest(`#${SORT_MENU_BUTTON_ID}`).length) return;\n    closeSortMenu();\n  }\n\n  function handleSortMenuKeydown(event) {\n    if (event.key !== 'Escape') return;\n    const { $button } = getSortMenuElements();\n    closeSortMenu();\n    if ($button.length) {\n      $button.trigger('focus');\n    }\n  }\n\n  function attachSortMenuListeners() {\n    if (sortMenuListenersActive) return;\n    $(parentDoc).on('click.rlhSortMenu', handleSortMenuOutsideClick);\n    $(parentDoc).on('keydown.rlhSortMenu', handleSortMenuKeydown);\n    sortMenuListenersActive = true;\n  }\n\n  function detachSortMenuListeners() {\n    if (!sortMenuListenersActive) return;\n    $(parentDoc).off('click.rlhSortMenu', handleSortMenuOutsideClick);\n    $(parentDoc).off('keydown.rlhSortMenu', handleSortMenuKeydown);\n    sortMenuListenersActive = false;\n  }\n\n  function closeSortMenu() {\n    const { $menu, $button } = getSortMenuElements();\n    if (!$menu.length) return;\n    $menu.attr('data-open', 'false').removeClass('open');\n    if ($button.length) {\n      $button.attr('aria-expanded', 'false');\n    }\n    detachSortMenuListeners();\n  }\n\n  function openSortMenu() {\n    const { $menu, $button } = getSortMenuElements();\n    if (!$menu.length) return;\n    $menu.attr('data-open', 'true').addClass('open');\n    if ($button.length) {\n      $button.attr('aria-expanded', 'true');\n    }\n    attachSortMenuListeners();\n  }\n\n  const handleSortMenuToggle = errorCatched(async event => {\n    event.preventDefault();\n    event.stopPropagation();\n    const { $menu } = getSortMenuElements();\n    if (!$menu.length) return;\n    const isOpen = $menu.attr('data-open') === 'true';\n    if (isOpen) closeSortMenu();\n    else openSortMenu();\n  });\n\n\n\n  const handleSortOptionSelect = errorCatched(async event => {\n    event.preventDefault();\n    const sortValue = $(event.currentTarget).data('sort-value');\n    if (!sortValue) return;\n    closeSortMenu();\n    const context = getViewContext();\n    setActiveSortMode(context, sortValue);\n    renderContent();\n  });\n\n\n\n  let positionMenuListenersActive = false;\n\r\n  function getPositionMenuElements() {\r\n    return {\r\n      $menu: $(`#${POSITION_MENU_ID}`, parentDoc),\r\n      $button: $(`#${POSITION_MENU_BUTTON_ID}`, parentDoc),\r\n    };\r\n  }\r\n\r\n  function handlePositionMenuOutsideClick(event) {\r\n    if (!positionMenuListenersActive) return;\r\n    const $target = $(event.target);\r\n    if ($target.closest(`#${POSITION_MENU_ID}`).length) return;\r\n    if ($target.closest(`#${POSITION_MENU_BUTTON_ID}`).length) return;\r\n    closePositionMenu();\r\n  }\r\n\r\n  function handlePositionMenuKeydown(event) {\r\n    if (event.key !== 'Escape') return;\r\n    const { $button } = getPositionMenuElements();\r\n    closePositionMenu();\r\n    if ($button.length) {\r\n      $button.trigger('focus');\r\n    }\r\n  }\r\n\r\n  function attachPositionMenuListeners() {\r\n    if (positionMenuListenersActive) return;\r\n    $(parentDoc).on('click.rlhPositionMenu', handlePositionMenuOutsideClick);\r\n    $(parentDoc).on('keydown.rlhPositionMenu', handlePositionMenuKeydown);\r\n    positionMenuListenersActive = true;\r\n  }\r\n\r\n  function detachPositionMenuListeners() {\r\n    if (!positionMenuListenersActive) return;\r\n    $(parentDoc).off('click.rlhPositionMenu', handlePositionMenuOutsideClick);\r\n    $(parentDoc).off('keydown.rlhPositionMenu', handlePositionMenuKeydown);\r\n    positionMenuListenersActive = false;\r\n  }\r\n\r\n  function closePositionMenu() {\r\n    const { $menu, $button } = getPositionMenuElements();\r\n    if (!$menu.length) return;\r\n    $menu.attr('data-open', 'false').removeClass('open');\r\n    if ($button.length) {\r\n      $button.attr('aria-expanded', 'false');\r\n    }\r\n    detachPositionMenuListeners();\r\n  }\r\n\r\n  function openPositionMenu() {\r\n    const { $menu, $button } = getPositionMenuElements();\r\n    if (!$menu.length) return;\r\n    if ($button.is('[disabled]')) return;\r\n    $menu.attr('data-open', 'true').addClass('open');\r\n    if ($button.length) {\r\n      $button.attr('aria-expanded', 'true');\r\n    }\r\n    attachPositionMenuListeners();\r\n  }\r\n\r\n  const handlePositionMenuToggle = errorCatched(async event => {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    const { $menu } = getPositionMenuElements();\r\n    if (!$menu.length) return;\r\n    const isOpen = $menu.attr('data-open') === 'true';\r\n    if (isOpen) closePositionMenu();\r\n    else openPositionMenu();\r\n  });\r\n\r\n  const handlePositionOptionSelect = errorCatched(async event => {\r\n    event.preventDefault();\r\n    const $option = $(event.currentTarget);\r\n    const positionValue = ($option.data('position-value') ?? '').toString().trim();\r\n    const bookName = ($option.data('book-name') ?? $option.closest(`#${POSITION_MENU_ID}`).data('book-name') ?? '')\r\n      .toString()\r\n      .trim();\r\n\r\n    closePositionMenu();\r\n\r\n    if (!positionValue) return;\r\n    if (lorebookHandlers?.applyUnifiedPosition) {\r\n      await lorebookHandlers.applyUnifiedPosition({ bookName, positionValue });\r\n    }\r\n  });\r\n\r\n\r\n\r\n  const handleCharacterBookSwitch = errorCatched(async event => {\r\n    const value = ($(event.currentTarget).val() ?? '').toString().trim();\r\n    if (!value || appState.activeCharacterBook === value) return;\r\n    appState.activeCharacterBook = value;\r\n    renderContent();\r\n  });\r\n\r\n\r\n\r\n  const handleSelectionCheckboxChange = errorCatched(async event => {\r\n    const $checkbox = $(event.currentTarget);\r\n    const selectKey = $checkbox.data('select-key');\r\n    if (!selectKey) return;\r\n    if (!appState.multiSelectMode) {\r\n      $checkbox.prop('checked', false);\r\n      return;\r\n    }\r\n    const isChecked = $checkbox.is(':checked');\r\n    if (isChecked) appState.selectedItems.add(selectKey);\r\n    else appState.selectedItems.delete(selectKey);\r\n    $checkbox.closest('[data-select-key]').toggleClass('selected', isChecked);\r\n    updateSelectionCount();\r\n  });\r\n\r\n\r\n\r\n  // \u6267\u884C\u66FF\u6362\u64CD\u4F5C\u7684\u51FD\u6570\r\n\r\n\r\n\r\n  const performReplace = async (matches, searchTerm, replaceTerm) => {\r\n    const replaceRegex = buildSearchRegex(searchTerm, false);\r\n    const updatesByBook = new Map();\r\n\r\n    const keysAreEqual = (a, b) => {\r\n      if (!Array.isArray(a) || !Array.isArray(b)) return false;\r\n      if (a.length !== b.length) return false;\r\n      for (let index = 0; index < a.length; index += 1) {\r\n        if (a[index] !== b[index]) return false;\r\n      }\r\n      return true;\r\n    };\r\n\r\n    for (const match of matches) {\r\n      const { bookName, entry } = match ?? {};\r\n      if (!bookName || !entry) {\r\n        throw new Error('\u4EC5\u652F\u6301\u4E16\u754C\u4E66\u6761\u76EE\u7684\u6279\u91CF\u66FF\u6362\u3002');\r\n      }\r\n\r\n      const uid = Number(entry?.uid);\r\n      if (!Number.isFinite(uid)) continue;\r\n\r\n      const update = { uid };\r\n      let hasChange = false;\r\n\r\n      if (Array.isArray(entry.keys)) {\r\n        const newKeys = entry.keys.map(key => key.replace(replaceRegex, replaceTerm));\r\n        if (!keysAreEqual(entry.keys, newKeys)) {\r\n          update.keys = newKeys;\r\n          hasChange = true;\r\n        }\r\n      }\r\n\r\n      if (typeof entry.content === 'string') {\r\n        const newContent = entry.content.replace(replaceRegex, replaceTerm);\r\n        if (newContent !== entry.content) {\r\n          update.content = newContent;\r\n          hasChange = true;\r\n        }\r\n      }\r\n\r\n      if (typeof entry.name === 'string') {\r\n        const newName = entry.name.replace(replaceRegex, replaceTerm);\r\n        if (newName !== entry.name) {\r\n          update.name = newName;\r\n          hasChange = true;\r\n        }\r\n      }\r\n\r\n      if (typeof entry.comment === 'string') {\r\n        const newComment = entry.comment.replace(replaceRegex, replaceTerm);\r\n        if (newComment !== entry.comment) {\r\n          update.comment = newComment;\r\n          hasChange = true;\r\n        }\r\n      }\r\n\r\n      if (!hasChange) continue;\r\n\r\n      if (!updatesByBook.has(bookName)) {\r\n        updatesByBook.set(bookName, []);\r\n      }\r\n      updatesByBook.get(bookName).push(update);\r\n    }\r\n\r\n    for (const [bookName, updates] of updatesByBook.entries()) {\r\n      if (updates.length === 0) continue;\r\n      await updateWorldbookEntries(bookName, updates);\r\n    }\r\n  };\r\n\r\n  // \u83B7\u53D6\u5168\u5C40\u4E16\u754C\u4E66\u5339\u914D\u9879\u7684\u51FD\u6570\r\n\r\n\r\n\r\n\r\n  const togglePanel = errorCatched(async () => {\r\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\r\n  if ($panel.is(':visible')) {\r\n    hidePanel();\r\n  } else {\r\n    await showPanel();\r\n  }\r\n  });\r\n\r\n\r\n\r\n  const hidePanel = async () => {\r\n    // \u5F02\u6B65\u4FDD\u5B58\u6240\u6709\u66F4\u6539\uFF0C\u5E76\u5728\u540E\u53F0\u5904\u7406\u7ED3\u679C\r\n    showToast('\u6B63\u5728\u540E\u53F0\u4FDD\u5B58\u6570\u636E...', 'info');\r\n    saveAllChanges()\r\n      .then(() => {\r\n        showToast('\u6570\u636E\u4FDD\u5B58\u6210\u529F\uFF01', 'success');\r\n      })\r\n      .catch(error => {\r\n        console.error('[RegexLoreHub] Background save failed:', error);\r\n        showToast('\u540E\u53F0\u4FDD\u5B58\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u65E5\u5FD7\u3002', 'error');\r\n      });\r\n\r\n    // \u7ACB\u5373\u9690\u85CF\u9762\u677F\uFF0C\u65E0\u9700\u7B49\u5F85\u4FDD\u5B58\u5B8C\u6210\r\n    const $panel = $(`#${PANEL_ID}`, parentDoc);\r\n    const $parentBody = $('body', parentDoc);\r\n    $panel.hide();\r\n    $(`#${BUTTON_ID}`, parentDoc).removeClass('active');\r\n    $parentBody.off('mousedown.rlh-outside-click');\r\n  };\r\n\r\n\r\n\r\n  const showPanel = async () => {\r\n  const $panel = $(`#${PANEL_ID}`, parentDoc);\r\n  const $parentBody = $('body', parentDoc);\r\n  $panel.css('display', 'flex');\r\n  $(`#${BUTTON_ID}`, parentDoc).addClass('active');\r\n\r\n  $parentBody.on('mousedown.rlh-outside-click', function (event) {\r\n    if (\r\n      $(event.target).closest(`#${PANEL_ID}`).length === 0 &&\r\n      $(event.target).closest(`#${BUTTON_ID}`).length === 0\r\n    ) {\r\n      hidePanel();\r\n    }\r\n  });\r\n\r\n  if (!appState.isDataLoaded) {\r\n    await loadAllData();\r\n  } else {\r\n    renderContent();\r\n  }\r\n  };\r\n\r\nconst handleTabRefresh = errorCatched(async tabId => {\r\n  appState.isLoadingTabData = true;\r\n  renderContent();\r\n\r\n  try {\r\n    await refreshCharacterData();\r\n\r\n    // \u786E\u4FDD\u65B0\u51FA\u73B0\u7684\u4E16\u754C\u4E66\u5728\u7F13\u5B58\u4E2D\u6709\u5143\u6570\u636E\uFF0C\u907F\u514D\u52A0\u8F7D\u6761\u76EE\u65F6\u7F3A\u5931\r\n    const ensureBookMeta = name => {\r\n      if (!name) return null;\r\n      if (!Array.isArray(appState.allLorebooks)) {\r\n        appState.allLorebooks = [];\r\n      }\r\n      let book = appState.allLorebooks.find(b => b.name === name);\r\n      if (!book) {\r\n        book = { name, enabled: false, entryCount: 0, enabledEntryCount: 0, entriesLoaded: false };\r\n        appState.allLorebooks.push(book);\r\n      }\r\n      return book;\r\n    };\r\n\r\n    if (tabId === 'char-lore') {\r\n      const books = Array.isArray(appState.lorebooks.character) ? appState.lorebooks.character : [];\r\n      for (const bookName of books) {\r\n        ensureBookMeta(bookName);\r\n        await loadLorebookEntriesIfNeeded(bookName, true);\r\n      }\r\n    } else if (tabId === 'chat-lore') {\r\n      const chatBookName = appState.chatLorebook;\r\n      if (chatBookName) {\r\n        ensureBookMeta(chatBookName);\r\n        await loadLorebookEntriesIfNeeded(chatBookName, true);\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error(`[RegexLoreHub] Error refreshing tab ${tabId}:`, error);\r\n    // \u4F7F\u7528\u5DF2\u6709\u7684\u9519\u8BEF\u5904\u7406\u51FD\u6570\u62A5\u544A\u9519\u8BEF\r\n    errorCatched(() => { throw error; })();\r\n  } finally {\r\n    appState.isLoadingTabData = false;\r\n    renderContent();\r\n  }\r\n});\r\n\r\n\r\n\r\n  const switchTab = errorCatched(async event => {\r\n  const targetTab = $(event.currentTarget).data('tab');\r\n\r\n  // \u65B0\u589E\u903B\u8F91\uFF1A\u5982\u679C\u5F53\u524D\u5728\u8BE6\u60C5\u9875\uFF0C\u70B9\u51FB\u5168\u5C40\u4E16\u754C\u4E66\u6807\u7B7E\u5219\u8FD4\u56DE\u5217\u8868\r\n  if (targetTab === 'global-lore' && appState.activeView === 'global-lore-detail') {\r\n    await lorebookHandlers.handleExitLorebookDetail();\r\n    return;\r\n  }\r\n\r\n  appState.activeTab = targetTab;\r\n  $(`#${PANEL_ID} .rlh-tab`, parentDoc).removeClass('active');\r\n  $(event.currentTarget).addClass('active');\r\n  $(`#${CREATE_LOREBOOK_BTN_ID}`, parentDoc).toggle(appState.activeTab === 'global-lore');\r\n  appState.selectedItems.clear();\r\n  const shouldRefreshCharLore = targetTab === 'char-lore' && !appState.charLoreInitialSynced;\r\n  if (shouldRefreshCharLore) {\r\n    await loadAllData();\r\n    appState.charLoreInitialSynced = true;\r\n  }\r\n\r\n  // \u65B0\u589E\uFF1A\u5982\u679C\u5207\u6362\u5230\u89D2\u8272\u6216\u804A\u5929\u4E16\u754C\u4E66\uFF0C\u5219\u89E6\u53D1\u5237\u65B0\r\n  if (targetTab === 'char-lore' || targetTab === 'chat-lore') {\r\n    await handleTabRefresh(targetTab);\r\n  } else {\r\n    renderContent();\r\n  }\r\n  });\r\n\r\n\r\n\r\n  const toggleMultiSelectMode = errorCatched(async event => {\r\n  appState.multiSelectMode = !appState.multiSelectMode;\r\n  appState.selectedItems.clear();\r\n  $(`#rlh-multi-select-btn`, parentDoc).toggleClass('active', appState.multiSelectMode);\r\n  $(`#rlh-multi-select-controls`, parentDoc).toggleClass('active', appState.multiSelectMode);\r\n  renderContent();\r\n  });\r\n\r\n\r\n\r\n  const handleSelectAll = errorCatched(async () => {\r\n  if (!appState.multiSelectMode) return;\r\n  const keys = getVisibleSelectKeys();\r\n  if (!keys.length) return;\r\n  keys.forEach(key => appState.selectedItems.add(key));\r\n  renderContent();\r\n  });\r\n\r\n\r\n\r\n  const handleSelectNone = errorCatched(async () => {\r\n  if (!appState.multiSelectMode) return;\r\n  const prefix = getTargetKeyPrefix();\r\n  let changed = false;\r\n  if (!prefix) {\r\n    if (appState.selectedItems.size === 0) return;\r\n    appState.selectedItems.clear();\r\n    changed = true;\r\n  } else {\r\n    const keys = [...appState.selectedItems];\r\n    keys.forEach(key => {\r\n      if (key.startsWith(prefix)) {\r\n        appState.selectedItems.delete(key);\r\n        changed = true;\r\n      }\r\n    });\r\n  }\r\n  if (changed) renderContent();\r\n  });\r\n\r\n\r\n\r\n  const handleSelectInvert = errorCatched(async () => {\r\n  if (!appState.multiSelectMode) return;\r\n  const keys = getVisibleSelectKeys();\r\n  if (!keys.length) return;\r\n  keys.forEach(key => {\r\n    if (appState.selectedItems.has(key)) appState.selectedItems.delete(key);\r\n    else appState.selectedItems.add(key);\r\n  });\r\n  renderContent();\r\n  });\r\n\r\n\r\n\r\n  const handleBatchEnable = errorCatched(async () => {\r\n  if (!appState.multiSelectMode) return;\r\n  if (!hasSelectionForCurrentTarget())\r\n    return await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u9009\u62E9\u8981\u542F\u7528\u7684\u9879\u76EE\u3002' });\r\n  await performBatchOperation(true);\r\n  showToast('\u6279\u91CF\u542F\u7528\u6210\u529F');\r\n  });\r\n\r\n\r\n\r\n  const handleBatchDisable = errorCatched(async () => {\r\n  if (!appState.multiSelectMode) return;\r\n  if (!hasSelectionForCurrentTarget())\r\n    return await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u9009\u62E9\u8981\u7981\u7528\u7684\u9879\u76EE\u3002' });\r\n  await performBatchOperation(false);\r\n  showToast('\u6279\u91CF\u7981\u7528\u6210\u529F');\r\n  });\r\n\r\n\r\n\r\n  const handleBatchDelete = errorCatched(async () => {\r\n  if (!appState.multiSelectMode) return;\r\n  const selectedBooks = new Set();\r\n  const selectedEntries = new Map();\r\n  const selectedRegexIds = new Set();\r\n  let totalEntriesToDelete = 0;\r\n\r\n  for (const key of appState.selectedItems) {\r\n    const { type, bookName, entryId, regexId } = parseSelectionKey(key);\r\n    if (type === 'book' && bookName) {\r\n      selectedBooks.add(bookName);\r\n    } else if (type === 'lore' && bookName) {\r\n      const numericId = Number(entryId);\r\n      if (!Number.isFinite(numericId)) continue;\r\n      if (!selectedEntries.has(bookName)) {\r\n        selectedEntries.set(bookName, []);\r\n      }\r\n      selectedEntries.get(bookName).push(numericId);\r\n      totalEntriesToDelete++;\r\n    } else if (type === 'regex') {\r\n      const normalizedRegexId = regexId != null && regexId !== '' ? String(regexId) : '';\r\n      if (normalizedRegexId) {\r\n        selectedRegexIds.add(normalizedRegexId);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (selectedBooks.size === 0 && totalEntriesToDelete === 0 && selectedRegexIds.size === 0) {\r\n    return await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u8BF7\u5148\u9009\u62E9\u8981\u5220\u9664\u7684\u9879\u76EE\u3002' });\r\n  }\r\n\r\n  let confirmText = '\u60A8\u786E\u5B9A\u8981\u6C38\u4E45\u5220\u9664';\r\n  const parts = [];\r\n  if (selectedBooks.size > 0) parts.push(`\u9009\u4E2D\u7684 ${selectedBooks.size} \u672C\u4E16\u754C\u4E66`);\r\n  if (totalEntriesToDelete > 0) parts.push(`${totalEntriesToDelete} \u4E2A\u6761\u76EE`);\r\n  if (selectedRegexIds.size > 0) parts.push(`${selectedRegexIds.size} \u4E2A\u6B63\u5219`);\r\n  confirmText += ` ${parts.join('\u548C')} \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`;\r\n\r\n  try {\r\n    await showModal({ type: 'confirm', title: '\u786E\u8BA4\u5220\u9664', text: confirmText });\r\n  } catch {\r\n    return; // User cancelled\r\n  }\r\n\r\n  const progressToast = showProgressToast('\u5F00\u59CB\u5220\u9664...');\r\n  try {\r\n    let deletedBooksCount = 0;\r\n    let deletedEntriesCount = 0;\r\n    let deletedRegexCount = 0;\r\n    let processedEntries = 0;\r\n    let processedBooks = 0;\r\n\r\n    // \u5148\u5220\u9664\u6761\u76EE\r\n    const entriesToDelete = Array.from(selectedEntries.entries());\r\n    for (const [bookName, uids] of entriesToDelete) {\r\n      if (selectedBooks.has(bookName)) {\r\n        processedEntries += uids.length;\r\n        continue;\r\n      }\r\n\r\n      progressToast.update(`\u6B63\u5728\u5220\u9664\u6761\u76EE... (${processedEntries}/${totalEntriesToDelete})`);\r\n      const result = await TavernAPI.deleteWorldbookEntries(bookName, uids);\r\n      processedEntries += uids.length;\r\n\r\n      if (result && result.deleted_entries && result.deleted_entries.length > 0) {\r\n        deletedEntriesCount += result.deleted_entries.length;\r\n        safeSetLorebookEntries(bookName, result.worldbook.map(normalizeWorldbookEntry));\r\n        uids.forEach(uid => appState.selectedItems.delete(`lore:${bookName}:${uid}`));\r\n      }\r\n    }\r\n\r\n    // \u518D\u5220\u9664\u6574\u4E2A\u4E16\u754C\u4E66\r\n    const booksToDelete = Array.from(selectedBooks);\r\n    for (const bookName of booksToDelete) {\r\n      progressToast.update(`\u6B63\u5728\u5220\u9664\u4E16\u754C\u4E66... (${processedBooks + 1}/${booksToDelete.length})`);\r\n      if (await TavernAPI.deleteWorldbook(bookName)) {\r\n        deletedBooksCount++;\r\n        appState.allLorebooks = appState.allLorebooks.filter(b => b.name !== bookName);\r\n        safeDeleteLorebookEntries(bookName);\r\n        appState.selectedItems.delete(`book:${bookName}`);\r\n        for (const key of appState.selectedItems) {\r\n          if (key.startsWith(`lore:${bookName}:`)) {\r\n            appState.selectedItems.delete(key);\r\n          }\r\n        }\r\n      }\r\n      processedBooks++;\r\n    }\r\n\r\n    // \u65B0\u589E\uFF1A\u5220\u9664\u6B63\u5219\u8868\u8FBE\u5F0F\r\n    if (selectedRegexIds.size > 0) {\r\n      progressToast.update(`\u6B63\u5728\u5220\u9664 ${selectedRegexIds.size} \u4E2A\u6B63\u5219...`);\r\n      const allServerRegexes = await TavernAPI.getRegexes();\r\n      const regexesToKeep = allServerRegexes.filter(r => !selectedRegexIds.has(String(r.id)));\r\n\r\n      // \u53EA\u66FF\u6362\u975E\u5361\u7247\u5185\u6B63\u5219\r\n      await TavernAPI.replaceRegexes(regexesToKeep.filter(r => r.source !== 'card'));\n      await TavernAPI.saveSettings();\n\n      deletedRegexCount = allServerRegexes.length - regexesToKeep.length;\n\n      // \u66F4\u65B0\u672C\u5730\u72B6\u6001\n      appState.regexes.global = appState.regexes.global.filter(r => !selectedRegexIds.has(String(r.id)));\n      appState.regexes.character = appState.regexes.character.filter(r => !selectedRegexIds.has(String(r.id)));\n      updateRegexOrderMetadata(appState.regexes.global);\n      updateRegexOrderMetadata(appState.regexes.character);\n      selectedRegexIds.forEach(id => appState.selectedItems.delete(`regex:${id}`));\n    }\n\r\n    progressToast.remove();\r\n\r\n    const messageParts = [];\r\n    if (deletedBooksCount > 0) messageParts.push(`\u6210\u529F\u5220\u9664 ${deletedBooksCount} \u672C\u4E16\u754C\u4E66`);\r\n    if (deletedEntriesCount > 0) messageParts.push(`\u6210\u529F\u5220\u9664 ${deletedEntriesCount} \u4E2A\u6761\u76EE`);\r\n    if (deletedRegexCount > 0) messageParts.push(`\u6210\u529F\u5220\u9664 ${deletedRegexCount} \u4E2A\u6B63\u5219`);\r\n\r\n    if (messageParts.length > 0) {\r\n      showToast(messageParts.join('\uFF0C'));\r\n      // \u5220\u9664\u6210\u529F\u540E\u9000\u51FA\u591A\u9009\u6A21\u5F0F\r\n      if (appState.multiSelectMode) {\r\n        toggleMultiSelectMode();\r\n      } else {\r\n        renderContent();\r\n      }\r\n    } else {\r\n      await showModal({ type: 'alert', title: '\u5220\u9664\u5931\u8D25', text: '\u5220\u9664\u9879\u76EE\u65F6\u53D1\u751F\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63A7\u5236\u53F0\u3002' });\r\n    }\r\n  } catch (error) {\r\n    progressToast.remove();\r\n    console.error('[RegexLoreHub] Batch delete failed:', error);\r\n    await showModal({ type: 'alert', title: '\u5220\u9664\u5931\u8D25', text: `\u64CD\u4F5C\u5931\u8D25: ${error.message}` });\r\n    await loadAllData(true); // \u53D1\u751F\u9519\u8BEF\u65F6\u91CD\u65B0\u52A0\u8F7D\u4EE5\u540C\u6B65\u72B6\u6001\r\n  }\r\n  });\r\n\r\n\r\n\r\n  const handleCleanOrphanLorebooks = errorCatched(async () => {\r\n    if (!Array.isArray(appState.allLorebooks) || appState.allLorebooks.length === 0) {\r\n      await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u6CA1\u6709\u627E\u5230\u53EF\u4EE5\u6E05\u7406\u7684\u4E16\u754C\u4E66\u3002' });\r\n      return;\r\n    }\r\n\r\n    const orphanBooks = appState.allLorebooks\r\n      .filter(book => {\r\n        const usageList = appState.lorebookUsage instanceof Map ? appState.lorebookUsage.get(book.name) : [];\r\n        const linkedChars = Array.isArray(usageList) ? usageList : [];\r\n        return !book.enabled && linkedChars.length === 0;\r\n      })\r\n      .map(book => book.name);\r\n\r\n    if (orphanBooks.length === 0) {\r\n      await showModal({ type: 'alert', title: '\u63D0\u793A', text: '\u6CA1\u6709\u627E\u5230\u672A\u542F\u7528\u4E14\u672A\u7ED1\u5B9A\u89D2\u8272\u5361\u7684\u4E16\u754C\u4E66\u3002' });\r\n      return;\r\n    }\r\n\r\n    appState.multiSelectMode = true;\r\n    appState.multiSelectTarget = 'book';\r\n    appState.selectedItems.clear();\r\n    orphanBooks.forEach(name => appState.selectedItems.add('book:' + name));\r\n    renderContent();\r\n\r\n    const confirmText = '\u5C06\u5220\u9664 ' + orphanBooks.length + ' \u672C\u672A\u542F\u7528\u4E14\u672A\u7ED1\u5B9A\u89D2\u8272\u5361\u7684\u4E16\u754C\u4E66\u3002\u56E0API\u9650\u5236\uFF0C\u65E0\u6CD5\u76F4\u63A5\u83B7\u53D6\u804A\u5929\u7ED1\u5B9A\u4E16\u754C\u4E66\uFF0C\u5B58\u5728\u8BEF\u5220\u8BE5\u4E16\u754C\u4E66\u7684\u53EF\u80FD\u3002\u786E\u5B9A\u7EE7\u7EED\u5417\uFF1F';\r\n\r\n\r\n    try {\r\n      await showModal({ type: 'confirm', title: '\u786E\u8BA4\u6E05\u7406\u5B64\u7ACB\u4E16\u754C\u4E66', text: confirmText });\r\n    } catch {\r\n      return;\r\n    }\r\n\r\n    const progressToast = showProgressToast('\u5F00\u59CB\u6E05\u7406\u5B64\u7ACB\u4E16\u754C\u4E66...');\r\n    const failedBooks = [];\r\n    let deletedCount = 0;\r\n\r\n    try {\r\n      for (let index = 0; index < orphanBooks.length; index += 1) {\r\n        const bookName = orphanBooks[index];\r\n        progressToast.update('\u6B63\u5728\u5220\u9664\u7B2C ' + (index + 1) + ' / ' + orphanBooks.length + ' \u672C\u4E16\u754C\u4E66...');\r\n        const success = await TavernAPI.deleteWorldbook(bookName);\r\n        if (success) {\r\n          deletedCount += 1;\r\n          appState.allLorebooks = appState.allLorebooks.filter(book => book.name !== bookName);\r\n          safeDeleteLorebookEntries(bookName);\r\n          if (appState.lorebookUsage instanceof Map && appState.lorebookUsage.has(bookName)) {\r\n            appState.lorebookUsage.delete(bookName);\r\n          }\r\n          if (Array.isArray(appState.lorebooks?.character)) {\r\n            appState.lorebooks.character = appState.lorebooks.character.filter(name => name !== bookName);\r\n          }\r\n          if (appState.chatLorebook === bookName) {\r\n            appState.chatLorebook = null;\r\n          }\r\n          if (appState.activeCharacterBook === bookName) {\r\n            appState.activeCharacterBook = null;\r\n          }\r\n          if (appState.activeBookName === bookName) {\r\n            appState.activeBookName = null;\r\n          }\r\n          appState.selectedItems.delete('book:' + bookName);\r\n          const remainingKeys = [...appState.selectedItems];\r\n          remainingKeys.forEach(key => {\r\n            if (key.startsWith('lore:' + bookName + ':')) {\r\n              appState.selectedItems.delete(key);\r\n            }\r\n          });\r\n        } else {\r\n          failedBooks.push(bookName);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      progressToast.remove();\r\n      console.error('[RegexLoreHub] Clean orphan lorebooks failed:', error);\r\n      await showModal({ type: 'alert', title: '\u64CD\u4F5C\u5931\u8D25', text: '\u6E05\u7406\u5B64\u7ACB\u4E16\u754C\u4E66\u65F6\u53D1\u751F\u9519\u8BEF\uFF1A' + (error?.message || error) });\r\n      await loadAllData(true);\r\n      return;\r\n    }\r\n\r\n    progressToast.remove();\r\n\r\n    if (deletedCount > 0) {\r\n      showToast('\u5DF2\u5220\u9664 ' + deletedCount + ' \u672C\u5B64\u7ACB\u4E16\u754C\u4E66');\r\n    }\r\n\r\n    if (failedBooks.length > 0) {\r\n      appState.selectedItems.clear();\r\n      failedBooks.forEach(name => appState.selectedItems.add('book:' + name));\r\n      await showModal({ type: 'alert', title: '\u90E8\u5206\u5220\u9664\u5931\u8D25', text: '\u4EE5\u4E0B\u4E16\u754C\u4E66\u672A\u80FD\u5220\u9664\uFF1A' + failedBooks.join('\u3001') });\r\n    } else {\r\n      appState.selectedItems.clear();\r\n      appState.multiSelectMode = false;\r\n    }\r\n\r\n    renderContent();\r\n  });\r\n\r\n\r\n\r\n  const performBatchOperation = errorCatched(async enable => {\r\n  const selectedBookNames = new Set();\r\n  const selectedEntriesByBook = new Map();\r\n  const selectedRegexIds = new Set();\r\n  let needsRegexUpdate = false;\r\n  let needsSettingsUpdate = false;\r\n\r\n  for (const itemKey of appState.selectedItems) {\r\n    const { type, bookName, entryId, regexId } = parseSelectionKey(itemKey);\r\n    if (type === 'book' && bookName) {\r\n      selectedBookNames.add(bookName);\r\n    } else if (type === 'lore' && bookName) {\r\n      const numericId = Number(entryId);\r\n      if (!Number.isFinite(numericId)) continue;\r\n      if (!selectedEntriesByBook.has(bookName)) selectedEntriesByBook.set(bookName, []);\r\n      selectedEntriesByBook.get(bookName).push(numericId);\r\n    } else if (type === 'regex') {\r\n      const normalizedRegexId = regexId != null && regexId !== '' ? String(regexId) : '';\r\n      if (normalizedRegexId) {\r\n        selectedRegexIds.add(normalizedRegexId);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (selectedBookNames.size > 0) {\r\n    let currentBooks = new Set(await TavernAPI.getGlobalWorldbookNames() || []);\r\n    selectedBookNames.forEach(name => (enable ? currentBooks.add(name) : currentBooks.delete(name)));\r\n    await TavernAPI.rebindGlobalWorldbooks(Array.from(currentBooks));\r\n    needsSettingsUpdate = true;\r\n    selectedBookNames.forEach(name => {\r\n      const book = appState.allLorebooks.find(b => b.name === name);\r\n      if (book) book.enabled = enable;\r\n    });\r\n  }\r\n\r\n  if (selectedEntriesByBook.size > 0) {\r\n    for (const [bookName, entryIds] of selectedEntriesByBook) {\r\n      const entries = [...safeGetLorebookEntries(bookName)];\r\n      if (entries) {\r\n        const updates = entryIds\r\n          .map(uid => {\r\n            const entry = entries.find(e => e.uid === uid);\r\n            if (entry) {\r\n              entry.enabled = enable;\r\n              return { uid, enabled: enable };\r\n            }\r\n            return null;\r\n          })\r\n          .filter(Boolean);\r\n        if (updates.length > 0) await updateWorldbookEntries(bookName, updates);\r\n      }\r\n    }\r\n  }\r\n\r\n  await TavernAPI.saveSettings();\r\n\r\n  if (selectedRegexIds.size > 0) {\r\n    const allServerRegexes = await TavernAPI.getRegexes();\r\n    allServerRegexes.forEach(regex => {\r\n      if (selectedRegexIds.has(String(regex.id))) regex.enabled = enable;\r\n    });\r\n    await TavernAPI.replaceRegexes(allServerRegexes.filter(r => r.source !== 'card'));\r\n    needsRegexUpdate = true;\r\n    [appState.regexes.global, appState.regexes.character].forEach(list =>\r\n      list.forEach(r => {\r\n        if (selectedRegexIds.has(String(r.id))) r.enabled = enable;\r\n      }),\r\n    );\r\n  }\r\n\r\n  if (needsSettingsUpdate || needsRegexUpdate) await TavernAPI.saveSettings();\r\n\r\n  appState.selectedItems.clear();\r\n  renderContent();\r\n  });\r\n\r\n\r\n\r\n  const handleHeaderClick = errorCatched(async (event, data) => {\r\n  const $target = $(event.target);\r\n  const $container = $(event.currentTarget).closest('.rlh-item-container, .rlh-book-group');\r\n\r\n  // 1. \u68C0\u67E5\u662F\u5426\u70B9\u51FB\u5728\u53EF\u4EA4\u4E92\u7684\u5B50\u63A7\u4EF6\u4E0A\r\n  if ($target.closest('.rlh-item-controls, .rlh-rename-ui').length > 0) {\r\n    return;\r\n  }\r\n\r\n  // 2. \u5982\u679C\u662F\u591A\u9009\u6A21\u5F0F\uFF0C\u53EA\u5904\u7406\u9009\u62E9\u903B\u8F91\r\n  if (appState.multiSelectMode) {\r\n    if (toggleSelectionForContainer($container)) return;\r\n  }\r\n\r\n  if (\r\n    !appState.multiSelectMode &&\r\n    appState.activeTab === 'global-lore' &&\r\n    appState.activeView === 'global-lore-list' &&\r\n    $container.is('.rlh-book-group') &&\r\n    $target.closest('.rlh-book-title-wrapper').length > 0\r\n  ) {\r\n    const bookName = $container.data('book-name');\r\n    if (bookName && lorebookHandlers?.handleEnterLorebookDetail) {\r\n      await lorebookHandlers.handleEnterLorebookDetail(bookName);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // 3. \u975E\u591A\u9009\u6A21\u5F0F\u4E0B\u7684\u9ED8\u8BA4\u5C55\u5F00/\u6298\u53E0\u903B\u8F91\r\n  if ($container.hasClass('from-card') || $container.hasClass('renaming')) return;\r\n\r\n  const $content = $container.find('.rlh-collapsible-content').first();\r\n\r\n  // \u5BF9\u4E8E\u975E\u5168\u5C40\u4E16\u754C\u4E66\u9875\u9762\u7684\u4E16\u754C\u4E66\u7EC4\uFF0C\u6267\u884C\u5C55\u5F00/\u6298\u53E0\r\n  if ($container.is('.rlh-book-group') && appState.activeTab !== 'global-lore') {\r\n    $content.slideToggle(200);\r\n    return;\r\n  }\r\n\r\n  // \u5BF9\u4E8E\u6761\u76EE\uFF0C\u5C55\u5F00/\u6298\u53E0\u7F16\u8F91\u5668\r\n  if ($container.is('.rlh-item-container')) {\r\n    if ($content.is(':visible')) {\r\n      $content.stop(true, true).slideUp(200, () => {\r\n        $content.off('input.rlh');\r\n        $content.empty();\r\n        $content.attr('data-entry-mode', 'collapsed');\r\n      });\r\n      $container.attr('data-entry-mode', 'collapsed');\r\n      return;\r\n    }\r\n\r\n    // \u5728\u975E\u6279\u91CF\u64CD\u4F5C\u65F6\uFF0C\u624D\u6267\u884C\u624B\u98CE\u7434\u6548\u679C\uFF08\u6298\u53E0\u5176\u4ED6\u5DF2\u5C55\u5F00\u7684\u6761\u76EE\uFF09\r\n    if (!data?.bulk) {\r\n      $container.siblings('.rlh-item-container').find('.rlh-collapsible-content:visible').slideUp(200).empty();\r\n    }\r\n\r\n    const type = $container.data('type');\r\n    const id = $container.data('id');\r\n    const storedSearchTerm = $container.data('searchTerm');\r\n    const attrSearchTerm = $container.attr('data-search-term');\r\n    const effectiveSearchTerm = typeof storedSearchTerm === 'string' && storedSearchTerm.length > 0\r\n      ? storedSearchTerm\r\n      : typeof attrSearchTerm === 'string' && attrSearchTerm.length > 0\r\n      ? attrSearchTerm\r\n      : '';\r\n\r\n    if (type === 'lore') {\r\n      const bookName = $container.data('book-name');\r\n      const entries = [...safeGetLorebookEntries(bookName)];\r\n      const entry = entries.find(e => e.uid === Number(id));\r\n      if (!entry) return;\r\n      itemHandlers.renderLoreEntryViewer($container, entry, effectiveSearchTerm, { animate: true });\r\n      return;\r\n    }\r\n\r\n    if (type === 'regex') {\r\n      const regexItem = [...appState.regexes.global, ...appState.regexes.character].find(r => r.id === id);\r\n      if (!regexItem) return;\r\n      const currentMode = $container.attr('data-entry-mode');\r\n      if (currentMode === 'edit') {\r\n        itemHandlers.renderRegexEditor($container, regexItem, { animate: true });\r\n      } else {\r\n        itemHandlers.renderRegexViewer($container, regexItem, effectiveSearchTerm, { animate: true });\r\n      }\r\n      return;\r\n    }\r\n\r\n  }\r\n  });\r\n\r\n\r\n\r\n  const handleMultiSelectContainerClick = errorCatched(async event => {\r\n  if (!appState.multiSelectMode) return;\r\n  const $target = $(event.target);\r\n  if (\r\n    $target.closest('.rlh-item-controls, .rlh-rename-ui, .rlh-action-btn, .rlh-action-btn-icon, .rlh-toggle-btn, .rlh-selection-control, .rlh-multi-select-checkbox, .rlh-item-header, .rlh-global-book-header').length > 0\r\n  ) {\r\n    return;\r\n  }\r\n  const $container = $(event.currentTarget).closest('.rlh-item-container, .rlh-book-group');\r\n  if (!$container.length) return;\r\n  if (toggleSelectionForContainer($container)) {\r\n    event.stopPropagation();\r\n    event.preventDefault();\r\n  }\r\n  });\r\n\r\n\r\n\r\n  const handleEditEntriesToggle = errorCatched(async event => {\r\n  event.stopPropagation();\r\n  const $button = $(event.currentTarget);\r\n  const $bookGroup = $button.closest('.rlh-book-group');\r\n  const isEnteringEditMode = !$bookGroup.hasClass('editing-entries');\r\n\r\n  // \u5207\u6362\u7F16\u8F91\u72B6\u6001\r\n  $bookGroup.toggleClass('editing-entries');\r\n\r\n  if (isEnteringEditMode) {\r\n    // **\u8FDB\u5165** \u7F16\u8F91\u6A21\u5F0F\r\n    // 1. \u5982\u679C\u591A\u9009\u672A\u6FC0\u6D3B\uFF0C\u5219\u81EA\u52A8\u6FC0\u6D3B\u5E76\u66F4\u65B0\u76F8\u5173UI\r\n    if (!appState.multiSelectMode) {\r\n      appState.multiSelectMode = true;\r\n      $(`#rlh-multi-select-btn`, parentDoc).addClass('active');\r\n      $(`#rlh-multi-select-controls`, parentDoc).addClass('active');\r\n      // \u624B\u52A8\u4E3A\u6240\u6709\u53EF\u89C1\u9879\u76EE\u6DFB\u52A0\u591A\u9009\u6A21\u5F0F\u7684class\uFF0C\u800C\u4E0D\u662F\u91CD\u7ED8\u6574\u4E2A\u9762\u677F\r\n      $(`#${PANEL_ID}`, parentDoc).addClass('rlh-multi-select-mode');\r\n    }\r\n\r\n    // 2. \u5F3A\u5236\u5C55\u5F00\u5185\u5BB9\r\n    $bookGroup.find('.rlh-collapsible-content').first().slideDown(200);\r\n\r\n    // 3. \u66F4\u65B0\u6309\u94AE\u72B6\u6001\r\n    $button.attr('title', '\u5B8C\u6210\u7F16\u8F91').find('i').removeClass('fa-pen-to-square').addClass('fa-check-square');\r\n    $button.addClass('active');\r\n  } else {\r\n    // **\u9000\u51FA** \u7F16\u8F91\u6A21\u5F0F\r\n    // 1. \u4EC5\u66F4\u65B0\u6309\u94AE\u72B6\u6001\r\n    $button.attr('title', '\u7F16\u8F91/\u9009\u62E9\u6761\u76EE').find('i').removeClass('fa-check-square').addClass('fa-pen-to-square');\r\n    $button.removeClass('active');\r\n  }\r\n  });\r\n\r\n\r\n\r\n  const handleRefresh = errorCatched(async event => {\r\n    const $button = $(event.currentTarget);\r\n    const $icon = $button.find('i');\r\n    $icon.addClass('fa-spin');\r\n\r\n    // \u5728\u5168\u5C40\u5237\u65B0\u524D\uFF0C\u4FDD\u62A4\u8BE6\u60C5\u89C6\u56FE\u4E2D\u7684\u5F53\u524D\u4E16\u754C\u4E66\u6761\u76EE\r\n    let cachedEntries = null;\r\n    if (appState.activeView === 'global-lore-detail' && appState.activeBookName) {\r\n      cachedEntries = safeGetLorebookEntries(appState.activeBookName);\r\n      console.log(`[RegexLoreHub] \u5168\u5C40\u5237\u65B0\u65F6\u7F13\u5B58\u8BE6\u60C5\u89C6\u56FE\u6761\u76EE: ${appState.activeBookName}`);\r\n    }\r\n\r\n    syncContextWithAppState();\r\n    await loadAllData(true);\r\n\r\n    // \u6062\u590D\u8BE6\u60C5\u89C6\u56FE\u7684\u7F13\u5B58\u6761\u76EE\r\n    if (cachedEntries && appState.activeView === 'global-lore-detail' && appState.activeBookName) {\r\n      safeSetLorebookEntries(appState.activeBookName, cachedEntries);\r\n      updateBookSummary(appState.activeBookName);\r\n      console.log(`[RegexLoreHub] \u6062\u590D\u8BE6\u60C5\u89C6\u56FE\u6761\u76EE: ${appState.activeBookName}`);\r\n      // \u5F02\u6B65\u5F3A\u5236\u5237\u65B0\u4EE5\u83B7\u53D6\u6700\u65B0\u6570\u636E\r\n      loadLorebookEntriesIfNeeded(appState.activeBookName, true).catch(error => {\r\n        console.warn(`[RegexLoreHub] \u6062\u590D\u540E\u5237\u65B0\u6761\u76EE\u5931\u8D25: ${appState.activeBookName}`, error);\r\n      });\r\n      renderContent();\r\n    }\r\n\r\n    setTimeout(() => $icon.removeClass('fa-spin'), 500);\r\n  });\r\n\r\n\r\n\r\n  const handlePrimaryCreateButtonClick = errorCatched(async (event) => {\r\n    if (appState.activeView === 'global-lore-list') {\r\n      if (lorebookHandlers?.handleCreateLorebook) {\r\n        await lorebookHandlers.handleCreateLorebook(event);\r\n      }\r\n    } else if (appState.activeView === 'global-lore-detail') {\r\n      if (!appState.activeBookName) return;\r\n\r\n      if (itemHandlers?.handleCreateEntry) {\r\n\r\n        const mockEvent = { currentTarget: $(`<button data-book-name=\"${appState.activeBookName}\"></button>`) };\r\n\r\n        await itemHandlers.handleCreateEntry(mockEvent);\r\n\r\n      }\r\n\r\n    }\r\n  });\r\n\r\n\r\n\r\n  return {\r\n\r\n    handleGlobalSearch,\r\n\r\n    handleSearchClear,\r\n\r\n    handleSearchInputKeydown,\r\n\r\n    handleReplace,\r\n\r\n    handleToolbarToggleCollapse,\n\n    handleSortMenuToggle,\n\n    handleSortOptionSelect,\n\n    handlePositionMenuToggle,\n\r\n    handlePositionOptionSelect,\r\n\r\n    handleCharacterBookSwitch,\r\n\r\n    handleSelectionCheckboxChange,\r\n\r\n    togglePanel,\r\n\r\n    switchTab,\r\n\r\n    toggleMultiSelectMode,\r\n\r\n    handleSelectAll,\r\n\r\n    handleSelectNone,\r\n\r\n    handleSelectInvert,\r\n\r\n    handleBatchEnable,\r\n\r\n    handleBatchDisable,\r\n\r\n    handleBatchDelete,\r\n\r\n    handleCleanOrphanLorebooks,\r\n\r\n    handleHeaderClick,\r\n\r\n    handleMultiSelectContainerClick,\r\n\r\n    handleEditEntriesToggle,\r\n\r\n    handleRefresh,\r\n\r\n    handlePrimaryCreateButtonClick,\r\n\r\n  };\r\n}\r\n", "import { get$, getParentDoc, getParentWin } from '../../core.js';\nimport { createLorebookHandlers } from './lorebook.js';\nimport { createItemHandlers } from './item.js';\nimport { createUIHandlers } from './ui.js';\n\n// --- \u7EDF\u4E00\u5BFC\u51FA ---\nexport function createHandlers() {\n  const $ = get$();\n  const parentDoc = getParentDoc();\n  const parentWin = getParentWin();\n\n  const sharedDeps = { $, parentDoc, parentWin };\n\n  const lorebookHandlers = createLorebookHandlers(sharedDeps);\n  const itemHandlers = createItemHandlers(sharedDeps);\n  const uiHandlers = createUIHandlers({ ...sharedDeps, lorebookHandlers, itemHandlers });\n\n  return {\n    ...lorebookHandlers,\n    ...itemHandlers,\n    ...uiHandlers,\n  };\n}\n", "// \u81EA\u52A8\u751F\u6210\u7684\u6587\u4EF6\uFF0C\u8BF7\u52FF\u76F4\u63A5\u4FEE\u6539\u3002\nexport const builtCSS = `\n/*! tailwindcss v4.1.13 | MIT License | https://tailwindcss.com */\n@layer theme{:root,:host{--rlh-font-sans:ui-sans-serif,system-ui,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\",\"Segoe UI Symbol\",\"Noto Color Emoji\";--rlh-spacing:.25rem;--rlh-text-sm:.875rem;--rlh-text-sm--line-height:calc(1.25/.875);--rlh-text-base:1rem;--rlh-text-base--line-height:calc(1.5/1);--rlh-font-weight-medium:500;--rlh-radius-lg:.5rem;--rlh-radius-xl:.75rem;--rlh-ease-out:cubic-bezier(0,0,.2,1);--rlh-blur-xl:24px;--rlh-default-transition-duration:.15s;--rlh-default-transition-timing-function:cubic-bezier(.4,0,.2,1)}}@layer utilities;@layer base{#regex-lore-hub-panel *{text-shadow:none!important}#regex-lore-hub-panel{--rlh-panel-radius:20px;--rlh-focus-ring:0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-focus-ring:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}#regex-lore-hub-panel{--rlh-bg-color:#f5f7fb;--rlh-surface-color:#fffd;--rlh-text-color:#0f172a;--rlh-em-color:#475569;--rlh-border-color:#bfc8f5;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)12%,transparent)}}#regex-lore-hub-panel{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)20%,transparent)}}#regex-lore-hub-panel{--rlh-shadow-color:#0f172a2e;--rlh-header-bg:#eef2ffd9;--rlh-input-bg:#ffffffeb;--rlh-accent-color:#4f46e5;--rlh-green:#10b981;--rlh-red:#ef4444;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)18%,transparent)}}#regex-lore-hub-panel{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)18%,transparent)}}#regex-lore-hub-panel.dark{--rlh-bg-color:#101827;--rlh-surface-color:#111827cc;--rlh-text-color:#f9fafb;--rlh-em-color:#cbd5e1;--rlh-border-color:#2d3748;--rlh-hover-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-hover-bg:color-mix(in srgb,var(--rlh-accent-color)14%,transparent)}}#regex-lore-hub-panel.dark{--rlh-selected-bg:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-selected-bg:color-mix(in srgb,var(--rlh-accent-color)22%,transparent)}}#regex-lore-hub-panel.dark{--rlh-shadow-color:#02061780;--rlh-header-bg:#0f172ae6;--rlh-input-bg:#1f2937d9;--rlh-accent-color:#6366f1;--rlh-green:#10b981;--rlh-red:#fb7185;--rlh-green-bg:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-green-bg:color-mix(in srgb,var(--rlh-green)20%,transparent)}}#regex-lore-hub-panel.dark{--rlh-red-bg:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark{--rlh-red-bg:color-mix(in srgb,var(--rlh-red)20%,transparent)}}@keyframes rlhFadeInUp{0%{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}@keyframes rlhSoftPulse{}@keyframes rlhToastIn{0%{opacity:0;transform:translate(-50%)translateY(28px)scale(.96)}60%{opacity:1;transform:translate(-50%)translateY(-4px)scale(1.02)}to{opacity:1;transform:translate(-50%)translateY(0)scale(1)}}@keyframes rlhHighlightPulse{0%{background-color:#fde68a}50%{background-color:#facc15}to{background-color:#fde68a}}}@layer components{#regex-lore-hub-panel{z-index:10000;width:100%;height:100dvh;min-height:100svh;color:var(--rlh-text-color);background:var(--rlh-bg-color);justify-content:center;align-items:center;padding:clamp(.8rem,1.5vw,1.3rem);display:none;position:fixed;inset:0}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel{background:color-mix(in srgb,var(--rlh-bg-color)92%,transparent)}}#regex-lore-hub-panel{-webkit-backdrop-filter:blur(24px);backdrop-filter:blur(24px);font-family:Inter,Segoe UI,Microsoft YaHei,sans-serif;transition:opacity .25s}@media (max-width:1024px){#regex-lore-hub-panel{justify-content:flex-start;align-items:stretch}}#regex-lore-hub-panel .rlh-shell{border-radius:var(--rlh-panel-radius);background:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);width:min(1250px,100%);height:100%;box-shadow:0 32px 120px -60px var(--rlh-shadow-color);flex-direction:column;gap:clamp(.45rem,1vw,.75rem);margin:0 auto;padding:clamp(.75rem,1.4vw,1.15rem);animation:.3s ease-out both rlhFadeInUp;display:flex;position:relative;overflow:hidden}#regex-lore-hub-panel .rlh-shell:before{content:\"\";background:radial-gradient(circle at top right,var(--rlh-accent-color)0%,transparent 60%),radial-gradient(circle at bottom left,var(--rlh-green)0%,transparent 65%);position:absolute;inset:-140px}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel .rlh-shell:before{background:radial-gradient(circle at top right,color-mix(in srgb,var(--rlh-accent-color)24%,transparent)0%,transparent 60%),radial-gradient(circle at bottom left,color-mix(in srgb,var(--rlh-green)18%,transparent)0%,transparent 65%)}}#regex-lore-hub-panel .rlh-shell:before{opacity:.32;pointer-events:none}@media (max-width:768px){#regex-lore-hub-panel .rlh-shell{border-radius:14px;padding:.55rem}}@media (min-width:1360px){#regex-lore-hub-panel .rlh-shell{border-radius:20px;padding:1.05rem 1.3rem}}.rlh-shell-header{justify-content:space-between;align-items:center;gap:.55rem;padding-block:.08rem;display:flex}.rlh-shell-title{flex-direction:column;gap:.18rem;display:flex}.rlh-shell-title h4{color:var(--rlh-text-color);margin:0;font-size:clamp(1rem,2vw,1.3rem);font-weight:600;line-height:1.2}.rlh-shell-meta{color:var(--rlh-em-color);align-items:center;gap:.35rem;font-size:max(.8125rem,13px);line-height:1.2;display:inline-flex;margin:0!important}.rlh-shell-version{background:var(--rlh-accent-color);border-radius:9999px;align-items:center;padding:.1rem .55rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-shell-version{background:color-mix(in srgb,var(--rlh-accent-color)16%,transparent)}}.rlh-shell-version{color:var(--rlh-text-color);font-size:.78rem;font-weight:600}.rlh-shell-dot{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-shell-dot{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-shell-dot{font-size:max(.8125rem,13px);line-height:1}.rlh-shell-updated{color:var(--rlh-em-color);font-size:.78rem}.rlh-shell-actions{align-items:center;gap:.4rem;display:flex}.rlh-shell-right{align-items:center;gap:.6rem;margin-left:auto;display:flex}.rlh-prefetch-indicator{text-align:right;flex-direction:column;align-items:flex-end;gap:.35rem;width:clamp(200px,34vw,320px);display:none}.rlh-prefetch-indicator[data-visible=true]{display:flex}.rlh-prefetch-text{color:var(--rlh-em-color);white-space:normal;font-size:.78rem}#rlh-prefetch-progress-text{width:100%}.rlh-prefetch-bar{background:var(--rlh-accent-color);border-radius:9999px;width:100%;height:4px;position:relative}@supports (color:color-mix(in lab, red, red)){.rlh-prefetch-bar{background:color-mix(in srgb,var(--rlh-accent-color)20%,transparent)}}.rlh-prefetch-bar{overflow:hidden}.rlh-prefetch-bar-inner{border-radius:inherit;background:var(--rlh-accent-color);width:0%;height:100%;transition:width .25s;display:block}.rlh-icon-button,.rlh-close-button{width:2.25rem;height:2.25rem;color:var(--rlh-text-color);cursor:pointer;background-color:#0000;border:1px solid #0000;border-radius:9999px;justify-content:center;align-items:center;transition:color .2s,background-color .2s,border-color .2s;display:inline-flex}.rlh-icon-button:hover,.rlh-close-button:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-icon-button:hover,.rlh-close-button:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-theme-toggle{border:1px solid var(--rlh-accent-color);border-radius:9999px;align-items:center;gap:.35rem;padding:.4rem .9rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle{border:1px solid color-mix(in srgb,var(--rlh-accent-color)28%,transparent)}}.rlh-theme-toggle{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle{background-color:color-mix(in srgb,var(--rlh-accent-color)12%,transparent)}}.rlh-theme-toggle{color:var(--rlh-text-color);cursor:pointer;font-size:.85rem;font-weight:500;transition:background-color .2s,color .2s,border-color .2s}.rlh-theme-toggle:hover{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-theme-toggle:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)18%,transparent)}}.rlh-tab-nav{background-color:var(--rlh-header-bg);flex-wrap:wrap;gap:.4rem;padding:.35rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-tab-nav{background-color:color-mix(in srgb,var(--rlh-header-bg)85%,transparent)}}.rlh-tab-nav{border:1px solid var(--rlh-border-color);border-radius:9999px}@supports (color:color-mix(in lab, red, red)){.rlh-tab-nav{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-tab{color:var(--rlh-em-color);cursor:pointer;border-radius:9999px;justify-content:center;align-items:center;gap:.55rem;padding:.4rem 1.1rem;font-size:.9rem;font-weight:500;transition:color .2s,background-color .2s,transform .2s;display:inline-flex}.rlh-tab:hover{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color)}.rlh-tab.active{background-color:var(--rlh-selected-bg);color:var(--rlh-text-color);box-shadow:inset 0 0 0 1px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-tab.active{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)60%,transparent)}}.rlh-tab-text-short{display:none}@media (max-width:640px){.rlh-tab-text-full{display:none}.rlh-tab-text-short{display:inline}}.rlh-main-area{flex-direction:column;flex:auto;gap:clamp(.6rem,1.4vw,1rem);width:100%;min-height:0;padding:0;display:flex}.rlh-toolbar-shell{flex-direction:column;gap:clamp(.6rem,1.3vw,.95rem);width:100%;display:flex}.rlh-toolbar-container,.rlh-replace-container{flex-direction:column;gap:clamp(.65rem,1.1vw,.9rem);display:flex}.rlh-toolbar-inner{background-color:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:clamp(.125rem,.3vw,.25rem);padding:clamp(.25rem,.5vw,.4rem);display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{background-color:color-mix(in srgb,var(--rlh-surface-color)95%,var(--rlh-accent-color)5%)}}.rlh-toolbar-inner{border:1px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{border:1px solid color-mix(in srgb,var(--rlh-accent-color)24%,var(--rlh-border-color))}}.rlh-toolbar-inner{box-shadow:0 16px 42px -34px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-inner{box-shadow:0 16px 42px -34px color-mix(in srgb,var(--rlh-shadow-color)78%,transparent)}}@media (max-width:768px){.rlh-toolbar-inner{border-radius:14px;padding:.55rem}.rlh-toolbar-section{gap:.4rem;padding:.45rem}}@media (min-width:1360px){.rlh-toolbar-inner{gap:1.1rem;padding:1.05rem 1.3rem}.rlh-toolbar-section{gap:.8rem;padding:.6rem .8rem}}.rlh-toolbar-section{background-color:#0000;border:none;border-radius:12px;flex-direction:column;gap:clamp(.1rem,.3vw,.2rem);padding:clamp(.1rem,.25vw,.2rem);display:flex}.rlh-toolbar-section--search,.rlh-toolbar-section--actions,.rlh-toolbar-section--multiselect{background-color:#0000}.rlh-toolbar-section--actions{flex-direction:row;align-items:center}.rlh-search-section-grid{flex-wrap:nowrap;align-items:stretch;gap:clamp(.25rem,.7vw,.5rem);display:flex}.rlh-search-section-main{flex:18rem;min-width:0}.rlh-search-section-multiselect{flex:0 14rem;justify-content:flex-start;align-items:flex-start;min-width:10rem;max-width:20rem;padding:5px 0 0;display:flex}.rlh-search-section-multiselect .rlh-multi-select-module{flex-direction:column;align-items:flex-start;gap:.25rem;width:100%;display:flex}.rlh-toolbar-section--actions .rlh-toolbar-actions{flex-wrap:wrap;justify-content:flex-start;align-items:center;gap:clamp(.25rem,.6vw,.45rem);width:100%;display:flex;overflow:visible}.rlh-toolbar-section--actions .rlh-toolbar-actions>*{flex-shrink:0}@media (max-width:960px){.rlh-search-section-grid{flex-direction:column}.rlh-search-section-main,.rlh-search-section-multiselect{flex:100%;max-width:none}.rlh-search-box{grid-template-columns:minmax(0,1fr);grid-template-areas:\"row\"\"replace\"\"meta\"}.rlh-replace-body{grid-template-columns:minmax(0,1fr) auto}}.rlh-content-pane{flex-direction:column;flex:auto;gap:clamp(.8rem,1.6vw,1.2rem);min-height:0;padding:0;display:flex}.rlh-content-pane>*{min-width:0}@media (max-width:768px){.rlh-content-pane{gap:.6rem}}.rlh-toolbar-btn{border:1px solid var(--rlh-accent-color);border-radius:12px;justify-content:flex-start;align-items:center;gap:.35rem;padding:.125rem .75rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{border:1px solid color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}.rlh-toolbar-btn{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-toolbar-btn{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{color:color-mix(in srgb,var(--rlh-text-color)90%,var(--rlh-accent-color)10%)}}.rlh-toolbar-btn{cursor:pointer;box-shadow:inset 0 0 0 1px var(--rlh-accent-color);font-size:.9rem;font-weight:500}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn{box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)25%,transparent)}}.rlh-toolbar-btn{transition:color .2s,background-color .2s,border-color .2s,box-shadow .2s,transform .2s}.rlh-toolbar-icon-btn{border:1px solid var(--rlh-accent-color);border-radius:12px;justify-content:center;align-items:center;width:2.1rem;height:2.1rem;padding:0;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{border:1px solid color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color)55%)}}.rlh-toolbar-icon-btn{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{background-color:color-mix(in srgb,var(--rlh-surface-color)88%,var(--rlh-accent-color)12%)}}.rlh-toolbar-icon-btn{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn{color:color-mix(in srgb,var(--rlh-text-color)90%,var(--rlh-accent-color)10%)}}.rlh-toolbar-icon-btn{cursor:pointer;line-height:1;transition:color .2s,background-color .2s,border-color .2s,box-shadow .2s,transform .2s}.rlh-toolbar-icon-btn i{font-size:.95rem}.rlh-toolbar-icon-btn:hover{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:hover{background-color:color-mix(in srgb,var(--rlh-surface-color)92%,var(--rlh-accent-color)20%)}}.rlh-toolbar-icon-btn:hover{color:var(--rlh-text-color)}.rlh-toolbar-icon-btn:focus{box-shadow:0 0 0 2px var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-icon-btn:focus{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-search-row .rlh-toolbar-icon-btn,.rlh-replace-body .rlh-toolbar-icon-btn{width:2rem;height:2rem}.rlh-toolbar-btn i{font-size:.95rem}.rlh-toggle-btn i,.rlh-action-btn-icon i,.rlh-toolbar-btn i{transition:transform .25s}.rlh-toolbar-btn span{white-space:nowrap}.rlh-toggle-btn:hover i,.rlh-action-btn-icon:hover i,.rlh-toolbar-btn:hover i{transform:translateY(-1px)scale(1.08)}.rlh-toolbar-group--leading .rlh-toolbar-btn,.rlh-toolbar-group--actions .rlh-toolbar-btn{width:100%}.rlh-toolbar-btn:hover{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{background-color:color-mix(in srgb,var(--rlh-accent-color)26%,var(--rlh-surface-color))}}.rlh-toolbar-btn:hover{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-border-color)30%)}}.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px var(--rlh-accent-color),0 10px 22px -16px var(--rlh-shadow-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{box-shadow:inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent),0 10px 22px -16px var(--rlh-shadow-color)}}.rlh-toolbar-btn:hover{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:hover{color:color-mix(in srgb,var(--rlh-text-color)85%,var(--rlh-accent-color)15%)}}.rlh-toolbar-btn:hover{transform:translateY(-1px)scale(1.01)}.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{cursor:not-allowed;opacity:.55;box-shadow:none;border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{border-color:color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:disabled,.rlh-toolbar-btn.disabled{color:color-mix(in srgb,var(--rlh-text-color)75%,var(--rlh-accent-color)5%)}}.rlh-toolbar-btn:focus-visible{box-shadow:0 0 0 2px var(--rlh-accent-color),inset 0 0 0 1.5px var(--rlh-accent-color);outline:none;animation:1.1s ease-out rlhSoftPulse}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:focus-visible{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)40%,transparent),inset 0 0 0 1.5px color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-toolbar-btn.active{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{background-color:color-mix(in srgb,var(--rlh-accent-color)32%,var(--rlh-surface-color))}}.rlh-toolbar-btn.active{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{border-color:color-mix(in srgb,var(--rlh-accent-color)75%,var(--rlh-border-color)25%)}}.rlh-toolbar-btn.active{box-shadow:inset 0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{box-shadow:inset 0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)50%,transparent)}}.rlh-toolbar-btn.active{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn.active{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-search-field{border:1px solid var(--rlh-border-color);border-radius:12px;align-items:center;gap:0;width:100%;min-width:0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-field{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-field{background-color:var(--rlh-input-bg);transition:border-color .2s,box-shadow .2s,color .2s;overflow:hidden}.rlh-search-row{grid-area:row;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:.125rem;width:100%;display:grid}.rlh-search-box{border:1px solid var(--rlh-border-color);border-radius:12px;grid-template-columns:minmax(0,1fr) auto;grid-template-areas:\"row replace\"\"meta meta\";gap:.125rem;padding:.2rem .3rem;display:grid}@supports (color:color-mix(in lab, red, red)){.rlh-search-box{border:1px solid color-mix(in srgb,var(--rlh-border-color)45%,transparent)}}.rlh-search-box{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-box{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,transparent)}}.rlh-search-box{box-shadow:0 8px 28px -24px var(--rlh-shadow-color)}.rlh-search-field .rlh-search-input{min-width:0;color:inherit;background:0 0;border:none;flex:auto;padding:.4rem .6rem;font-size:.92rem}.rlh-search-field .rlh-search-input:focus{box-shadow:none;border:none;outline:none}.rlh-search-field:focus-within{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-field:focus-within{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-search-field:focus-within{box-shadow:var(--rlh-focus-ring);color:var(--rlh-text-color)}.rlh-search-meta{color:var(--rlh-em-color);flex-direction:row;grid-area:meta;align-items:center;gap:.4rem;font-size:.85rem;display:flex}.rlh-search-scope{color:var(--rlh-accent-color);font-weight:500}@supports (color:color-mix(in lab, red, red)){.rlh-search-scope{color:color-mix(in srgb,var(--rlh-accent-color)65%,var(--rlh-text-color))}}.rlh-sort-menu,.rlh-position-menu{align-items:center;width:auto;min-width:0;margin-left:auto;display:inline-flex;position:relative}.rlh-sort-menu-list,.rlh-position-menu-list{background-color:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);border-radius:14px;min-width:10rem;padding:.5rem;list-style:none;position:absolute;top:calc(100% + .5rem);right:0}@supports (color:color-mix(in lab, red, red)){.rlh-sort-menu-list,.rlh-position-menu-list{border:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-sort-menu-list,.rlh-position-menu-list{box-shadow:0 24px 60px -36px var(--rlh-shadow-color);z-index:99;opacity:0;visibility:hidden;pointer-events:none;transition:opacity var(--rlh-default-transition-duration)var(--rlh-default-transition-timing-function),transform var(--rlh-default-transition-duration)var(--rlh-default-transition-timing-function),visibility 0s linear var(--rlh-default-transition-duration);will-change:opacity,transform;flex-direction:column;gap:.35rem;display:flex;transform:translateY(6px)scale(.98)}.rlh-toolbar-group--actions .rlh-sort-menu-list,.rlh-toolbar-group--actions .rlh-position-menu-list{left:0;right:auto}.rlh-sort-menu.open .rlh-sort-menu-list,.rlh-position-menu.open .rlh-position-menu-list{opacity:1;visibility:visible;pointer-events:auto;transition-delay:0s,0s,0s;transform:translateY(0)scale(1)}.rlh-sort-option,.rlh-position-option{width:100%;color:var(--rlh-text-color);cursor:pointer;background-color:#0000;border:1px solid #0000;border-radius:10px;justify-content:space-between;align-items:center;gap:.4rem;padding:.4rem .6rem;font-size:.9rem;transition:background-color .2s,border-color .2s,color .2s;display:flex}.rlh-sort-option:hover,.rlh-position-option:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option:hover,.rlh-position-option:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-sort-option.active,.rlh-position-option.active{background-color:var(--rlh-selected-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option.active,.rlh-position-option.active{border-color:color-mix(in srgb,var(--rlh-accent-color)60%,transparent)}}.rlh-sort-option.active,.rlh-position-option.active{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-sort-option.active,.rlh-position-option.active{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-replace-body{grid-area:replace;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:.25rem;width:100%;display:grid}.rlh-info-text{color:var(--rlh-em-color);font-size:.9rem}@supports (color:color-mix(in lab, red, red)){.rlh-info-text{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-info-text{margin:.5rem 0}.rlh-info-text-small{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}@supports (color:color-mix(in lab, red, red)){.rlh-info-text-small{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-chat-lore-empty{text-align:center;background-color:var(--rlh-hover-bg);border-radius:16px;flex-direction:column;justify-content:center;align-items:center;gap:1rem;padding:2rem 1.5rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-chat-lore-empty{background-color:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}.rlh-chat-lore-empty{border:1px dashed var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-chat-lore-empty{border:1px dashed color-mix(in srgb,var(--rlh-border-color)75%,transparent)}}.rlh-detail-view{background-color:var(--rlh-surface-color);border-radius:18px;flex-direction:column;gap:.6rem;padding:.6rem .8rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-detail-view{background-color:color-mix(in srgb,var(--rlh-surface-color)94%,transparent)}}.rlh-detail-view{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-detail-view{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-detail-view{box-shadow:0 24px 70px -50px var(--rlh-shadow-color)}@media (max-width:768px){.rlh-detail-view{gap:.6rem;padding:.6rem .8rem}.rlh-detail-header{gap:.4rem;padding:.4rem .6rem}.rlh-detail-content{gap:.4rem}.rlh-entry-list-wrapper{gap:.4rem;padding:.4rem 0}.rlh-detail-header h2{font-size:1rem;line-height:1.1}}.rlh-detail-header{grid-template-columns:auto 1fr auto;align-items:center;gap:.4rem;padding:.4rem .6rem;display:grid}.rlh-detail-header h2{color:var(--rlh-text-color);text-align:center;white-space:nowrap;text-overflow:ellipsis;min-width:0;margin:0;padding-inline:.5rem;font-size:1.1rem;font-weight:600;overflow:hidden}.rlh-detail-header .rlh-back-to-list-btn{justify-self:start}.rlh-detail-header .rlh-item-controls{justify-self:end;align-items:center;gap:.4rem;display:inline-flex}.rlh-detail-content,.rlh-entry-list-wrapper{flex-direction:column;gap:.4rem;display:flex}.rlh-entry-list-wrapper .rlh-item-container{animation:.3s ease-out both rlhFadeListItem}@keyframes rlhFadeListItem{0%{opacity:0;transform:translateY(6px)scale(.95)}to{opacity:1;transform:translateY(0)scale(1)}}.rlh-regex-list{flex-direction:column;gap:.45rem;display:flex;position:relative}.rlh-regex-list.sorting-active{border:1.5px dashed var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{border:1.5px dashed color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}.rlh-regex-list.sorting-active{box-shadow:0 0 0 3px var(--rlh-accent-color),0 20px 50px -30px var(--rlh-shadow-color);border-radius:14px;padding:.35rem .45rem}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{box-shadow:0 0 0 3px color-mix(in srgb,var(--rlh-accent-color)12%,transparent),0 20px 50px -30px var(--rlh-shadow-color)}}.rlh-regex-list.sorting-active{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-regex-list.sorting-active{background:color-mix(in srgb,var(--rlh-hover-bg)45%,transparent)}}.rlh-regex-list.sorting-active .rlh-item-container{border-radius:12px}.rlh-regex-list .sortable-ghost{opacity:.2;transform:scale(.98)}.rlh-regex-list .sortable-chosen{box-shadow:0 18px 40px -28px var(--rlh-shadow-color);transform:rotate(.4deg)}.rlh-sorting-fallback{opacity:.7!important;transform:scale(1.02)!important}.rlh-entry-list-wrapper>*{margin:0}.rlh-order-indicator{background-color:var(--rlh-hover-bg);min-width:1.75rem;color:var(--rlh-accent-color);border-radius:9999px;justify-content:center;align-items:center;padding:.1rem .5rem;font-size:max(.8125rem,13px);font-weight:600;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-order-indicator{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-text-color))}}.rlh-selection-control{justify-content:center;align-items:center;margin-right:.35rem;display:inline-flex}.rlh-selection-control input{cursor:pointer;width:1rem;height:1rem;accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-selection-control input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}.rlh-drag-handle{color:var(--rlh-em-color);justify-content:center;align-items:center;margin-right:.35rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-drag-handle{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-drag-handle{cursor:grab}.rlh-drag-handle:active{cursor:grabbing}.rlh-editor-group{border-top:1px solid var(--rlh-border-color);flex-direction:column;gap:.6rem;padding:.75rem 0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-editor-group{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-editor-group:first-of-type{border-top:none;padding-top:0}.rlh-editor-group h5{color:var(--rlh-em-color);font-size:.85rem;font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-editor-group h5{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-editor-grid{grid-template-columns:repeat(auto-fit,minmax(14rem,1fr));gap:.6rem;display:grid}.rlh-grid-item,.rlh-depth-container{flex-direction:column;gap:.4rem;display:flex}.rlh-depth-inputs{flex-wrap:wrap;gap:.6rem;display:flex}.rlh-editor-options-row{flex-wrap:wrap;gap:.4rem;display:flex}.rlh-editor-option-item{background-color:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.35rem;padding:.35rem .65rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-editor-option-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}.rlh-editor-option-item{color:var(--rlh-em-color);font-size:.85rem}.rlh-editor-option-item input{accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-editor-option-item input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}.rlh-select-nudge{min-width:8rem}.rlh-rename-ui{width:100%}.rlh-rename-input-wrapper{border:1px solid var(--rlh-border-color);border-radius:12px;align-items:center;gap:.4rem;width:100%;padding:.4rem .6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-rename-input-wrapper{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-rename-input-wrapper{background-color:var(--rlh-input-bg)}.rlh-rename-input{color:var(--rlh-text-color);background:0 0;border:none;outline:none;flex:1;font-size:.9rem}.rlh-rename-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)75%,transparent)}}.rlh-rename-save-btn{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-save-btn{border-color:color-mix(in srgb,var(--rlh-green)55%,transparent)}}.rlh-rename-cancel-btn{color:var(--rlh-red);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-rename-cancel-btn{border-color:color-mix(in srgb,var(--rlh-red)55%,transparent)}}.rlh-global-toggle,.rlh-item-toggle{transition:background-color .2s,border-color .2s,color .2s}.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{border-color:color-mix(in srgb,var(--rlh-green)65%,transparent)}}.rlh-book-group.enabled .rlh-global-toggle,.rlh-item-container.enabled .rlh-item-toggle{background-color:var(--rlh-green-bg)}.rlh-clickable-header{cursor:pointer}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{box-shadow:0 36px 120px -60px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-shell{box-shadow:0 36px 120px -60px color-mix(in srgb,var(--rlh-accent-color)30%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{color:color-mix(in srgb,var(--rlh-accent-color)65%,transparent)}}#regex-lore-hub-panel.rlh-multi-select-mode .rlh-selection-count{font-size:max(.8125rem,13px)}.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{box-shadow:0 0 0 2px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{box-shadow:0 0 0 2px color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.editing-entries,.rlh-book-group.renaming,.rlh-item-container.renaming{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-item-container.rlh-collapsed .rlh-item-header,.rlh-book-group.rlh-collapsed .rlh-global-book-header{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.rlh-collapsed .rlh-item-header,.rlh-book-group.rlh-collapsed .rlh-global-book-header{background-color:color-mix(in srgb,var(--rlh-hover-bg)45%,transparent)}}.sortable-ghost{opacity:.75;background-color:var(--rlh-selected-bg)}@supports (color:color-mix(in lab, red, red)){.sortable-ghost{background-color:color-mix(in srgb,var(--rlh-selected-bg)85%,transparent)}}.sortable-ghost{border:1px dashed var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.sortable-ghost{border:1px dashed color-mix(in srgb,var(--rlh-accent-color)55%,transparent)}}.rlh-search-controls{flex-wrap:wrap;align-items:center;gap:.7rem;display:flex}#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{border:1px solid var(--rlh-border-color);border-radius:12px;width:100%;min-width:0;padding:.4rem .6rem}@supports (color:color-mix(in lab, red, red)){#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}#rlh-search-input,.rlh-search-input,#rlh-replace-input,.rlh-replace-input{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);font-size:.92rem;transition:border-color .2s,box-shadow .2s}#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}#rlh-search-input:focus,.rlh-search-input:focus,#rlh-replace-input:focus,.rlh-replace-input:focus{box-shadow:var(--rlh-focus-ring)}#rlh-search-input::placeholder,.rlh-search-input::placeholder,#rlh-replace-input::placeholder,.rlh-replace-input::placeholder{color:var(--rlh-em-color)}@supports (color:color-mix(in lab, red, red)){#rlh-search-input::placeholder,.rlh-search-input::placeholder,#rlh-replace-input::placeholder,.rlh-replace-input::placeholder{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-multi-select-module{flex-direction:column;align-items:flex-start;gap:.25rem;display:flex}.rlh-search-action-btn,.rlh-multi-select-action-btn{border:1px solid var(--rlh-border-color);border-radius:10px;justify-content:center;align-items:center;gap:.2rem;padding:.3rem .5rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-action-btn,.rlh-multi-select-action-btn{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-action-btn,.rlh-multi-select-action-btn{color:var(--rlh-text-color);cursor:pointer;background:0 0;font-size:.78rem;line-height:1;transition:color .2s,background-color .2s,border-color .2s,transform .2s}.rlh-multi-select-action-btn:active{transform:scale(.95)}.rlh-search-action-btn:hover,.rlh-multi-select-action-btn:hover{background-color:var(--rlh-hover-bg);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-action-btn:hover,.rlh-multi-select-action-btn:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-multi-select-actions{flex-wrap:nowrap;align-items:center;gap:.3rem;display:inline-flex}.rlh-multi-select-action-btn.enable{color:var(--rlh-green);border-color:var(--rlh-green)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.enable{border-color:color-mix(in srgb,var(--rlh-green)60%,transparent)}}.rlh-multi-select-action-btn.enable{background-color:var(--rlh-green-bg)}.rlh-multi-select-action-btn.disable{color:var(--rlh-red);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-multi-select-action-btn.disable{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-multi-select-action-btn.disable{background-color:var(--rlh-red-bg)}#rlh-search-filters-container,.rlh-filter-list{flex-wrap:wrap;gap:.6rem;display:flex}.rlh-filter-item{background-color:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.4rem;padding:.4rem .65rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item{background-color:color-mix(in srgb,var(--rlh-hover-bg)65%,transparent)}}.rlh-filter-item{color:var(--rlh-em-color);font-size:.85rem}.rlh-filter-item input{accent-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-filter-item input{accent-color:color-mix(in srgb,var(--rlh-accent-color)85%,transparent)}}#rlh-multi-select-controls{align-items:center;gap:.35rem;display:none}#rlh-multi-select-controls.active{flex-wrap:wrap;display:flex}@media (max-width:960px){.rlh-multi-select-module{align-items:stretch;gap:.35rem}#rlh-multi-select-controls{flex-wrap:wrap;justify-content:flex-start;align-items:flex-start}.rlh-multi-select-actions{flex-wrap:wrap;justify-content:flex-start}}.rlh-content-pane{-webkit-overflow-scrolling:touch;scrollbar-gutter:stable both-edges;flex-direction:column;flex:auto;gap:1rem;min-height:0;padding-right:.25rem;display:flex;overflow:hidden auto}#regex-lore-hub-panel-content{-webkit-overflow-scrolling:touch;scrollbar-gutter:stable both-edges;scroll-behavior:smooth;flex:auto;min-height:clamp(18rem,48vh,32rem);padding-right:clamp(.25rem,.8vw,.5rem);display:block;overflow:hidden auto}#regex-lore-hub-panel-content>*+*{margin-top:clamp(.8rem,1.4vw,1.1rem)}#regex-lore-hub-panel-content::-webkit-scrollbar{width:6px}#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{background-color:color-mix(in srgb,var(--rlh-accent-color)35%,transparent)}}#regex-lore-hub-panel-content::-webkit-scrollbar-thumb{border-radius:9999px}.rlh-book-group,.rlh-item-container{border:1px solid var(--rlh-border-color);border-radius:16px;flex-direction:column;min-height:0;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-book-group,.rlh-item-container{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group,.rlh-item-container{background-color:color-mix(in srgb,var(--rlh-surface-color)94%,transparent)}}.rlh-book-group,.rlh-item-container{box-shadow:0 18px 50px -40px var(--rlh-shadow-color);overflow:hidden}.rlh-book-group-header{justify-content:center;align-items:center;padding:.85rem 1rem;display:flex;position:relative}.rlh-book-group-title{color:var(--rlh-text-color);text-align:center;white-space:nowrap;text-overflow:ellipsis;max-width:calc(100% - 8rem);margin:0;font-size:1.1rem;font-weight:600;overflow:hidden}.rlh-book-group-header .rlh-item-controls{align-items:center;gap:.4rem;display:inline-flex;position:absolute;top:50%;right:1rem;transform:translateY(-50%)}.rlh-global-book-header,.rlh-item-header{cursor:pointer;justify-content:flex-start;align-items:center;gap:.6rem;padding:.85rem 1rem;transition:background-color .2s,border-color .2s;display:flex}.rlh-global-book-header{flex-wrap:wrap;align-items:flex-start}.rlh-global-book-header .rlh-book-title-wrapper{flex:auto;min-width:0}.rlh-global-book-header .rlh-item-name{white-space:normal;word-break:break-word;flex:0 auto;min-width:0}.rlh-global-book-header .rlh-book-stats{white-space:nowrap}.rlh-global-book-header .rlh-item-controls{flex:none;margin-top:.1rem;margin-left:auto}.rlh-global-book-header.enabled{color:var(--rlh-text-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{color:color-mix(in srgb,var(--rlh-text-color)70%,var(--rlh-accent-color)30%)}}.rlh-global-book-header.enabled{background:linear-gradient(135deg,var(--rlh-accent-color)0%,var(--rlh-accent-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{background:linear-gradient(135deg,color-mix(in srgb,var(--rlh-accent-color)32%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-accent-color)18%,var(--rlh-surface-color))100%)}}.rlh-global-book-header.enabled{box-shadow:0 18px 45px -30px var(--rlh-accent-color),inset 0 0 0 1px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled{box-shadow:0 18px 45px -30px color-mix(in srgb,var(--rlh-accent-color)50%,transparent),inset 0 0 0 1px color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-global-book-header.enabled .rlh-item-name{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled .rlh-item-name{color:color-mix(in srgb,var(--rlh-accent-color)85%,var(--rlh-text-color))}}.rlh-global-book-header.enabled .rlh-book-stats{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled .rlh-book-stats{color:color-mix(in srgb,var(--rlh-accent-color)70%,var(--rlh-em-color))}}.rlh-global-book-header.enabled:hover{background:linear-gradient(135deg,var(--rlh-accent-color)0%,var(--rlh-accent-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-global-book-header.enabled:hover{background:linear-gradient(135deg,color-mix(in srgb,var(--rlh-accent-color)38%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-accent-color)22%,var(--rlh-surface-color))100%)}}.rlh-global-book-header:hover,.rlh-item-header:hover{background-color:var(--rlh-hover-bg)}.rlh-item-header-main{flex:auto;align-items:center;gap:.5rem;min-width:0;display:flex}.rlh-item-name{color:var(--rlh-text-color);flex-shrink:0;font-size:.95rem;font-weight:500}@media (max-width:720px){.rlh-item-header{flex-wrap:wrap;align-items:flex-start;gap:.45rem;padding:.7rem .75rem}.rlh-item-header-main{flex-direction:column;align-items:flex-start;gap:.3rem;width:100%}.rlh-item-name{text-overflow:ellipsis;white-space:nowrap;flex:auto;min-width:0;max-width:100%;overflow:hidden}.rlh-book-group-header{justify-content:flex-start;align-items:flex-start}.rlh-book-group-title{text-align:left;width:100%;max-width:100%}.rlh-item-controls{flex-direction:row;justify-content:flex-end;align-self:flex-start;align-items:center;gap:.18rem;width:auto}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{border-width:1px;border-radius:.6rem;width:1.55rem;height:1.55rem;padding:0}.rlh-item-controls .rlh-toggle-btn i,.rlh-item-controls .rlh-action-btn-icon i{font-size:max(.8125rem,13px)}.rlh-detail-header .rlh-item-controls{justify-self:flex-end}.rlh-book-group-header .rlh-item-controls{justify-content:flex-end;align-items:center;margin-top:.25rem;margin-left:auto;position:static;transform:none}.rlh-item-meta{gap:.25rem;font-size:.74rem}.rlh-item-meta-chip{gap:.2rem;padding:.12rem .45rem}}.rlh-item-meta{color:var(--rlh-em-color);flex-wrap:wrap;align-items:center;gap:.35rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta{color:color-mix(in srgb,var(--rlh-em-color)92%,transparent)}}.rlh-item-meta{font-size:.78rem}.rlh-item-meta-chip{background:var(--rlh-hover-bg);border-radius:9999px;align-items:center;gap:.25rem;padding:.15rem .55rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)70%,transparent)}}.rlh-item-meta-chip{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip{border:1px solid color-mix(in srgb,var(--rlh-border-color)50%,transparent)}}.rlh-item-meta-chip{line-height:1.2}.rlh-item-meta-chip i{color:var(--rlh-accent-color);font-size:.7rem}@supports (color:color-mix(in lab, red, red)){.rlh-item-meta-chip i{color:color-mix(in srgb,var(--rlh-accent-color)75%,var(--rlh-em-color))}}#regex-lore-hub-panel.dark .rlh-item-meta-chip{background:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-item-meta-chip{background:color-mix(in srgb,var(--rlh-hover-bg)55%,transparent)}}#regex-lore-hub-panel.dark .rlh-item-meta-chip{border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-item-meta-chip{border-color:color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-item-controls{flex-wrap:wrap;align-items:center;gap:.35rem;margin-left:auto;display:inline-flex}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{flex-shrink:0}@media (max-width:960px){.rlh-item-controls{gap:.28rem}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:2rem;height:2rem}}@media (max-width:900px) and (min-width:721px){.rlh-item-controls{flex-direction:column;align-items:flex-end;gap:.22rem;width:auto}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:1.75rem;height:1.75rem}.rlh-item-name{flex:auto;min-width:0;max-width:100%}}.rlh-toggle-btn,.rlh-action-btn-icon{border:1px solid var(--rlh-border-color);border-radius:9999px;justify-content:center;align-items:center;width:2.25rem;height:2.25rem;display:inline-flex}@supports (color:color-mix(in lab, red, red)){.rlh-toggle-btn,.rlh-action-btn-icon{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-toggle-btn,.rlh-action-btn-icon{color:var(--rlh-em-color);cursor:pointer;background:0 0;transition:color .2s,background-color .2s,border-color .2s,transform .2s}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color);border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,transparent)}}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover{transform:translateY(-1px)scale(1.03)}.rlh-item-container.enabled .rlh-item-name,.rlh-book-group.enabled .rlh-item-name{color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-item-container.enabled .rlh-item-name,.rlh-book-group.enabled .rlh-item-name{color:color-mix(in srgb,var(--rlh-accent-color)80%,var(--rlh-text-color))}}.rlh-collapsible-content{border-top:1px solid var(--rlh-border-color);margin-top:.75rem;padding:0 1rem 1rem;display:none}@supports (color:color-mix(in lab, red, red)){.rlh-collapsible-content{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-collapsible-content{background-color:var(--rlh-surface-color)}@supports (color:color-mix(in lab, red, red)){.rlh-collapsible-content{background-color:color-mix(in srgb,var(--rlh-surface-color)90%,transparent)}}.rlh-entry-actions{border-bottom:1px dashed var(--rlh-border-color);flex-wrap:wrap;gap:.6rem;padding:.9rem 1rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-entry-actions{border-bottom:1px dashed color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-action-btn{background-color:var(--rlh-accent-color);color:#fff;cursor:pointer;border:none;border-radius:12px;justify-content:center;align-items:center;gap:.4rem;padding:.55rem 1rem;font-size:.9rem;font-weight:500;transition:transform .2s,opacity .2s;display:inline-flex}.rlh-action-btn:hover{opacity:.9}.rlh-action-btn.rlh-maximize-btn{border:1px solid var(--rlh-em-color);background:0 0}@supports (color:color-mix(in lab, red, red)){.rlh-action-btn.rlh-maximize-btn{border:1px solid color-mix(in srgb,var(--rlh-em-color)45%,transparent)}}.rlh-action-btn.rlh-maximize-btn{color:var(--rlh-em-color)}.rlh-editor-wrapper{flex-direction:column;gap:1rem;display:flex}.rlh-editor-field{flex-direction:column;gap:.35rem;display:flex}.rlh-editor-field label{background-color:var(--rlh-header-bg);padding:.55rem .85rem;display:block}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field label{background-color:color-mix(in srgb,var(--rlh-header-bg)82%,transparent)}}.rlh-editor-field label{border-bottom:1px solid var(--rlh-border-color);border-radius:12px 12px 0 0}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field label{border-bottom:1px solid color-mix(in srgb,var(--rlh-border-color)68%,transparent)}}.rlh-editor-field label{color:var(--rlh-text-color);margin:0;font-size:.875rem;font-weight:600;line-height:1.3}.rlh-editor-field label+*{border-top-left-radius:0;border-top-right-radius:0;margin-top:0}.rlh-viewer-field{gap:0}.rlh-regex-viewer{grid-template-columns:repeat(auto-fit,minmax(14rem,1fr));gap:.75rem;display:grid}.rlh-regex-viewer>.rlh-editor-field:nth-child(-n+2){grid-column:1/-1}.rlh-entry-viewer{flex-direction:column;gap:.75rem;display:flex}.rlh-viewer-field label{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-field label{background-color:color-mix(in srgb,var(--rlh-hover-bg)60%,transparent)}}.rlh-viewer-field label{border-bottom-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-field label{border-bottom-color:color-mix(in srgb,var(--rlh-accent-color)28%,transparent)}}.rlh-viewer-text{border:1px solid var(--rlh-border-color);padding:.6rem .85rem}@supports (color:color-mix(in lab, red, red)){.rlh-viewer-text{border:1px solid color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}.rlh-viewer-text{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);border-top:none;border-radius:0 0 12px 12px;line-height:1.5}.rlh-viewer-text>article{margin:0}.rlh-editor-field .rlh-edit-content,.rlh-editor-field article{border-top:none;border-radius:0 0 12px 12px;margin-top:0}#regex-lore-hub-panel.dark .rlh-editor-field label{background-color:var(--rlh-header-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-editor-field label{background-color:color-mix(in srgb,var(--rlh-header-bg)70%,transparent)}}#regex-lore-hub-panel.dark .rlh-editor-field label{border-bottom-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-editor-field label{border-bottom-color:color-mix(in srgb,var(--rlh-border-color)60%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-field label{background-color:var(--rlh-hover-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-field label{background-color:color-mix(in srgb,var(--rlh-hover-bg)70%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-field label{border-bottom-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-field label{border-bottom-color:color-mix(in srgb,var(--rlh-accent-color)32%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{border-color:var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-text{border-color:color-mix(in srgb,var(--rlh-border-color)50%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{background-color:var(--rlh-input-bg)}@supports (color:color-mix(in lab, red, red)){#regex-lore-hub-panel.dark .rlh-viewer-text{background-color:color-mix(in srgb,var(--rlh-input-bg)90%,transparent)}}#regex-lore-hub-panel.dark .rlh-viewer-text{border-top:none}.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{border:1px solid var(--rlh-border-color);border-radius:12px;width:100%;padding:.55rem .75rem}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-editor-field input[type=text],.rlh-editor-field textarea,.rlh-editor-field select{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);transition:border-color .2s,box-shadow .2s}.rlh-editor-field label+:is(input,textarea,select){border-top:none;border-radius:0 0 12px 12px}.rlh-editor-field textarea{resize:vertical;min-height:8rem}.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-editor-field input:focus,.rlh-editor-field textarea:focus,.rlh-editor-field select:focus{box-shadow:var(--rlh-focus-ring)}.rlh-toast-notification,.rlh-progress-toast{background-color:var(--rlh-accent-color);color:#fff;box-shadow:0 24px 120px -40px var(--rlh-shadow-color);opacity:0;pointer-events:none;z-index:10002;border-radius:9999px;padding:.9rem 1.3rem;font-size:.9rem;font-weight:500;transition:opacity .25s,transform .25s;position:fixed;bottom:clamp(1rem,4vw,2rem);left:50%;transform:translate(-50%)translateY(20px)}.rlh-progress-toast{background-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-progress-toast{background-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-toast-notification.visible,.rlh-progress-toast.visible{opacity:1;animation:.38s cubic-bezier(.3,.7,.4,1.1) both rlhToastIn;transform:translate(-50%)translateY(0)}.rlh-modal-overlay{z-index:10003;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);background:#0206178c;justify-content:center;align-items:center;display:flex;position:fixed;inset:0}.rlh-modal-content{background:var(--rlh-surface-color);border:1px solid var(--rlh-border-color);width:min(420px,90%);box-shadow:0 30px 120px -60px var(--rlh-shadow-color);border-radius:16px;margin:auto;overflow:hidden}.rlh-modal-header{border-bottom:1px solid var(--rlh-border-color);padding:1rem 1.25rem;font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-modal-header{border-bottom:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-body{color:var(--rlh-em-color);flex-direction:column;gap:.6rem;padding:1.1rem 1.25rem;display:flex}.rlh-modal-footer{border-top:1px solid var(--rlh-border-color);justify-content:flex-end;gap:.6rem;padding:.9rem 1.25rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-modal-footer{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-btn{border:1px solid var(--rlh-border-color);border-radius:12px;padding:.55rem 1.1rem}@supports (color:color-mix(in lab, red, red)){.rlh-modal-btn{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-modal-btn{color:var(--rlh-text-color);cursor:pointer;background:0 0;font-weight:500;transition:background-color .2s,border-color .2s}.rlh-modal-btn:hover{background-color:var(--rlh-hover-bg)}.rlh-modal-btn.rlh-modal-ok{background-color:var(--rlh-accent-color);color:#fff;border-color:#0000}.rlh-modal-btn.rlh-modal-cancel{background-color:var(--rlh-red-bg);border-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-modal-btn.rlh-modal-cancel{border-color:color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-modal-btn.rlh-modal-cancel{color:var(--rlh-red)}.rlh-loading{background:var(--rlh-surface-color);border-radius:20px;align-items:center;gap:1.25rem;padding:1.4rem 1.6rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-loading{background:color-mix(in srgb,var(--rlh-surface-color)96%,transparent)}}.rlh-loading{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-loading{border:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-loading{box-shadow:0 24px 80px -50px var(--rlh-shadow-color)}.rlh-loading-spinner{border:3px solid var(--rlh-em-color);border-radius:9999px;width:2.6rem;height:2.6rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-spinner{border:3px solid color-mix(in srgb,var(--rlh-em-color)35%,transparent)}}.rlh-loading-spinner{border-top-color:var(--rlh-accent-color);animation:.9s linear infinite rlh-spin}.rlh-loading-text{flex-direction:column;flex:1;gap:.55rem;display:flex}.rlh-loading-title{color:var(--rlh-text-color);font-size:.95rem;font-weight:600}.rlh-loading-status{color:var(--rlh-text-color);font-size:.9rem}.rlh-loading-detail{color:var(--rlh-em-color);font-size:.82rem}@supports (color:color-mix(in lab, red, red)){.rlh-loading-detail{color:color-mix(in srgb,var(--rlh-em-color)85%,transparent)}}.rlh-loading-bar{background:var(--rlh-hover-bg);border-radius:9999px;width:100%;height:.4rem;position:relative}@supports (color:color-mix(in lab, red, red)){.rlh-loading-bar{background:color-mix(in srgb,var(--rlh-hover-bg)75%,transparent)}}.rlh-loading-bar{overflow:hidden}.rlh-loading-bar-inner{background:linear-gradient(90deg,var(--rlh-accent-color),var(--rlh-accent-color));width:0%;height:100%}@supports (color:color-mix(in lab, red, red)){.rlh-loading-bar-inner{background:linear-gradient(90deg,var(--rlh-accent-color),color-mix(in srgb,var(--rlh-accent-color)70%,transparent))}}.rlh-loading-bar-inner{transition:width .3s}.rlh-loading-progress{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}@supports (color:color-mix(in lab, red, red)){.rlh-loading-progress{color:color-mix(in srgb,var(--rlh-em-color)70%,transparent)}}.rlh-menu-icon{width:1.1rem;height:1.1rem;color:var(--rlh-accent-color);justify-content:center;align-items:center;display:inline-flex}@keyframes rlh-spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.rlh-edit-content{border:1px solid var(--rlh-border-color);border-radius:0 0 12px 12px;min-height:6rem;padding:.75rem}@supports (color:color-mix(in lab, red, red)){.rlh-edit-content{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-edit-content{background-color:var(--rlh-input-bg);color:var(--rlh-text-color);white-space:pre-wrap}.rlh-error-wrapper{text-align:center;border:1px dashed var(--rlh-red);border-radius:16px;padding:1.5rem}@supports (color:color-mix(in lab, red, red)){.rlh-error-wrapper{border:1px dashed color-mix(in srgb,var(--rlh-red)60%,transparent)}}.rlh-error-wrapper{background-color:var(--rlh-red-bg)}.rlh-error-title{color:var(--rlh-red);margin-bottom:.75rem;font-weight:600}.rlh-error-text{color:var(--rlh-em-color);font-size:.9rem}.rlh-error-retry-btn{border:1px solid var(--rlh-red);color:var(--rlh-red);cursor:pointer;background-color:#0000;border-radius:9999px;margin-top:1rem;padding:.55rem 1.1rem;transition:background-color .2s}.rlh-error-retry-btn:hover{background-color:var(--rlh-red)}@supports (color:color-mix(in lab, red, red)){.rlh-error-retry-btn:hover{background-color:color-mix(in srgb,var(--rlh-red)18%,transparent)}}.rlh-error-retry-btn:hover{color:#fff}.rlh-search-card,.rlh-filters-card{background:var(--rlh-surface-color);border-radius:16px;flex-direction:column;gap:.9rem;padding:1rem 1.1rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-search-card,.rlh-filters-card{background:color-mix(in srgb,var(--rlh-surface-color)92%,transparent)}}.rlh-search-card,.rlh-filters-card{border:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-search-card,.rlh-filters-card{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-search-card,.rlh-filters-card{box-shadow:0 20px 60px -40px var(--rlh-shadow-color)}.rlh-section-title{letter-spacing:.08em;text-transform:uppercase;color:var(--rlh-em-color);font-size:max(.8125rem,13px);font-weight:600}@supports (color:color-mix(in lab, red, red)){.rlh-section-title{color:color-mix(in srgb,var(--rlh-em-color)80%,transparent)}}.rlh-toast-notification.success{background-color:var(--rlh-green)}.rlh-toast-notification.error{background-color:var(--rlh-red)}.rlh-toast-notification.info{background-color:var(--rlh-accent-color)}@media (prefers-reduced-motion:reduce){#regex-lore-hub-panel .rlh-shell,.rlh-toolbar-btn:focus-visible{animation:none}.rlh-toast-notification.visible,.rlh-progress-toast.visible{transition:opacity .2s,transform .2s;animation:none}.rlh-toggle-btn:hover,.rlh-action-btn-icon:hover,.rlh-toolbar-btn:hover,.rlh-toggle-btn:hover i,.rlh-action-btn-icon:hover i,.rlh-toolbar-btn:hover i{transform:none}}.rlh-breadcrumbs{align-items:center;gap:.4rem;margin-bottom:.5rem;font-size:.9rem;display:flex}.rlh-breadcrumb-item{color:var(--rlh-em-color);text-decoration:none;transition:color .2s}.rlh-breadcrumb-item:hover{color:var(--rlh-accent-color)}.rlh-breadcrumb-item.active{color:var(--rlh-text-color);pointer-events:none;font-weight:500}.rlh-breadcrumb-separator{color:var(--rlh-em-color)}.rlh-empty-state{text-align:center;background-color:var(--rlh-hover-bg);border-radius:16px;flex-direction:column;justify-content:center;align-items:center;margin-top:1rem;padding:2rem;display:flex}@supports (color:color-mix(in lab, red, red)){.rlh-empty-state{background-color:color-mix(in srgb,var(--rlh-hover-bg)50%,transparent)}}.rlh-empty-state{border:1px dashed var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-empty-state{border:1px dashed color-mix(in srgb,var(--rlh-border-color)80%,transparent)}}.rlh-empty-icon{color:var(--rlh-accent-color);background-color:var(--rlh-selected-bg);border-radius:9999px;justify-content:center;align-items:center;width:4rem;height:4rem;margin-bottom:1rem;font-size:2rem;display:flex}.rlh-empty-state h4{color:var(--rlh-text-color);margin-bottom:.5rem;font-size:1.1rem;font-weight:600}.rlh-empty-state p{color:var(--rlh-em-color);max-width:300px}.rlh-book-group{transition:box-shadow .2s,border-color .2s;position:relative}.rlh-book-group.enabled{border-left:3px solid var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{border-left:3px solid color-mix(in srgb,var(--rlh-accent-color)80%,transparent)}}.rlh-book-group.enabled{border-color:var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{border-color:color-mix(in srgb,var(--rlh-accent-color)45%,var(--rlh-border-color))}}.rlh-book-group.enabled{background:linear-gradient(160deg,var(--rlh-accent-color)0%,var(--rlh-surface-color)100%)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{background:linear-gradient(160deg,color-mix(in srgb,var(--rlh-accent-color)20%,var(--rlh-surface-color))0%,color-mix(in srgb,var(--rlh-surface-color)96%,transparent)100%)}}.rlh-book-group.enabled{box-shadow:0 26px 70px -46px var(--rlh-accent-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-group.enabled{box-shadow:0 26px 70px -46px color-mix(in srgb,var(--rlh-accent-color)58%,transparent)}}.rlh-book-title-wrapper{flex-direction:column;flex:1;gap:.2rem;display:flex}.rlh-book-stats{color:var(--rlh-em-color);font-size:max(.8125rem,13px)}.rlh-book-summary{background-color:var(--rlh-hover-bg);padding:.5rem 1rem;font-size:.85rem}@supports (color:color-mix(in lab, red, red)){.rlh-book-summary{background-color:color-mix(in srgb,var(--rlh-hover-bg)40%,transparent)}}.rlh-book-summary{border-top:1px solid var(--rlh-border-color)}@supports (color:color-mix(in lab, red, red)){.rlh-book-summary{border-top:1px solid color-mix(in srgb,var(--rlh-border-color)55%,transparent)}}.rlh-used-by-chars span{background-color:var(--rlh-selected-bg);border-radius:9999px;margin:.1rem;padding:.1rem .5rem;font-size:max(.8125rem,13px);display:inline-block}.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{border:1px solid var(--rlh-border-color);border-radius:12px;padding:.45rem .65rem}@supports (color:color-mix(in lab, red, red)){.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{border:1px solid color-mix(in srgb,var(--rlh-border-color)65%,transparent)}}.rlh-edit-depth,.rlh-edit-order,.rlh-edit-probability,.rlh-edit-depth-min,.rlh-edit-depth-max,.rlh-modal-input{background-color:var(--rlh-input-bg);color:var(--rlh-text-color)}.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{border-color:var(--rlh-accent-color);outline:none}@supports (color:color-mix(in lab, red, red)){.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{border-color:color-mix(in srgb,var(--rlh-accent-color)70%,transparent)}}.rlh-edit-depth:focus,.rlh-edit-order:focus,.rlh-edit-probability:focus,.rlh-edit-depth-min:focus,.rlh-edit-depth-max:focus,.rlh-modal-input:focus{box-shadow:var(--rlh-focus-ring)}.rlh-loading{pointer-events:none;opacity:.5;position:relative}.rlh-loading>i{visibility:hidden}.rlh-loading:after{content:\"\";border:2px solid oklch(70.7% .022 261.325);border-top-color:oklch(62.3% .214 259.815);border-radius:50%;width:16px;height:16px;margin-top:-8px;margin-left:-8px;animation:.8s linear infinite rlh-spin;position:absolute;top:50%;left:50%}.rlh-highlight{color:#1f2937;background-color:#facc15;animation:.5s ease-out rlhHighlightPulse}.rlh-toolbar-btn:focus-visible,.rlh-icon-button:focus-visible,.rlh-close-button:focus-visible,.rlh-toggle-btn:focus-visible,.rlh-action-btn-icon:focus-visible,.rlh-toolbar-icon-btn:focus-visible{outline-offset:2px;outline:3px solid var(--rlh-accent-color)!important;box-shadow:0 0 0 5px var(--rlh-accent-color)!important}@supports (color:color-mix(in lab, red, red)){.rlh-toolbar-btn:focus-visible,.rlh-icon-button:focus-visible,.rlh-close-button:focus-visible,.rlh-toggle-btn:focus-visible,.rlh-action-btn-icon:focus-visible,.rlh-toolbar-icon-btn:focus-visible{box-shadow:0 0 0 5px color-mix(in srgb,var(--rlh-accent-color)20%,transparent)!important}}input:focus-visible,select:focus-visible,textarea:focus-visible,[contenteditable]:focus-visible{outline:3px solid var(--rlh-accent-color);outline-offset:2px}}.rlh-toolbar-toggle-btn{background-color:var(--rlh-hover-bg);color:var(--rlh-text-color);border:1px solid var(--rlh-border-color);cursor:pointer;border-radius:8px;justify-content:center;align-items:center;padding:.5rem 1rem;transition:background-color .2s,color .2s;display:inline-flex}.rlh-toolbar-toggle-btn:hover{background-color:var(--rlh-selected-bg);color:var(--rlh-accent-color)}#regex-lore-hub-toolbar-shell{transition:max-height .3s ease-in-out}.rlh-toolbar-shell--collapsed{max-height:0;margin-top:0;margin-bottom:0;padding-top:0;padding-bottom:0;overflow:hidden}@media (max-width:640px){.rlh-toggle-btn,.rlh-action-btn-icon,.rlh-toolbar-icon-btn,.rlh-icon-button,.rlh-close-button{width:44px;height:44px;padding:.5rem;min-width:44px!important;min-height:44px!important}.rlh-multi-select-action-btn{padding:.6rem .8rem;min-width:44px!important;min-height:44px!important}.rlh-item-controls{gap:.5rem!important}.rlh-item-controls .rlh-toggle-btn,.rlh-item-controls .rlh-action-btn-icon{width:44px!important;height:44px!important}}\n`;\n", "import { loadAllData } from '../dataLayer.js';\r\n\r\nimport {\r\n\r\n  DOM_ID,\r\n  PANEL_ID,\r\n\r\n  BUTTON_ID,\r\n\r\n  BUTTON_ICON_URL,\r\n\r\n  BUTTON_TOOLTIP,\r\n\r\n  BUTTON_TEXT_IN_MENU,\r\n\r\n  CLOSE_BTN_ID,\r\n\r\n  SEARCH_INPUT_ID,\r\n\r\n  REFRESH_BTN_ID,\r\n\r\n  CORE_TOOLBAR_ID,\r\n\r\n  REPLACE_TOOL_CONTAINER_ID,\r\n\r\n  REPLACE_TOGGLE_BTN_ID,\r\n\r\n  REPLACE_INPUT_ID,\r\n\r\n  TOGGLE_COLLAPSE_BTN_ID,\r\n\r\n  TOGGLE_RECURSION_BTN_ID,\n\n  FIX_KEYWORDS_BTN_ID,\n\n  SORT_MENU_BUTTON_ID,\n\n  POSITION_MENU_BUTTON_ID,\n\r\n  CREATE_LOREBOOK_BTN_ID,\r\n\r\n  CHARACTER_BOOK_SWITCH_ID,\r\n\r\n  PREFETCH_INDICATOR_ID,\r\n\r\n  PREFETCH_PROGRESS_TEXT_ID,\r\n\r\n  PREFETCH_PROGRESS_BAR_ID,\r\n  appState,\r\n  showModal,\r\n\r\n  get$,\r\n\r\n  getParentDoc,\r\n\r\n  getParentWin,\r\n\r\n} from '../core.js';\r\n\r\nimport { toggleToolbar } from './handlers/ui.js';\r\n\r\nimport { renderContent } from './render/index.js';\r\n\r\nimport { builtCSS } from '../styles/generated.js';\r\n\r\n\r\n\r\n\r\nexport function initializeUI(createHandlers) {\r\n\r\n  const $ = get$();\r\n\r\n  const parentDoc = getParentDoc();\r\n\r\n  const parentWin = getParentWin();\r\n\r\n\r\n\r\n\r\n  const handlers = createHandlers();\r\n\r\n\r\n\r\n\r\n\r\n  function injectCSS() {\r\n\r\n    const existingStyle = parentDoc.getElementById(`${PANEL_ID}-styles`);\r\n\r\n    if (existingStyle) {\r\n\r\n      existingStyle.textContent = builtCSS;\r\n\r\n      return;\r\n\r\n    }\r\n\r\n    const styleElement = parentDoc.createElement('style');\r\n\r\n    styleElement.id = `${PANEL_ID}-styles`;\r\n\r\n    styleElement.textContent = builtCSS;\r\n\r\n    parentDoc.head.appendChild(styleElement);\r\n\r\n  }\r\n\r\n\r\n\r\n\r\n  function loadSortableJS(callback) {\r\n\r\n    if (parentWin.Sortable) {\r\n\r\n      callback();\r\n\r\n      return;\r\n\r\n    }\r\n\r\n    const script = parentWin.document.createElement('script');\r\n\r\n    script.src = 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js';\r\n\r\n    script.onload = () => {\r\n\r\n      console.log('[RegexLoreHub] SortableJS loaded successfully.');\r\n\r\n      callback();\r\n\r\n    };\r\n\r\n    script.onerror = () => {\r\n\r\n      console.error('[RegexLoreHub] Failed to load SortableJS.');\r\n\r\n      showModal({ type: 'alert', title: '\u9519\u8BEF', text: '\u65E0\u6CD5\u52A0\u8F7D\u62D6\u62FD\u6392\u5E8F\u5E93\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5\u6216\u6D4F\u89C8\u5668\u63A7\u5236\u53F0\u3002' });\r\n\r\n    };\r\n\r\n    parentWin.document.head.appendChild(script);\r\n\r\n  }\r\n\r\n\r\n\r\n\r\n\r\n  function initializeScript() {\r\n\r\n    console.log('[RegexLoreHub] Initializing UI and button...');\r\n\r\n\r\n\r\n\r\n\r\n    if ($(`#${PANEL_ID}`, parentDoc).length > 0) {\r\n\r\n      console.log('[RegexLoreHub] Panel already exists. Skipping UI creation.');\r\n\r\n      return;\r\n\r\n    }\r\n\r\n\r\n\r\n\r\n\r\n    injectCSS();\r\n\r\n\r\n\r\n\r\n\r\n    const panelHtml = `\r\n      <div id=\"${PANEL_ID}\">\r\n\r\n        <div class=\"rlh-shell\">\r\n\r\n          <header class=\"rlh-shell-header\">\r\n\r\n            <div class=\"rlh-shell-title\">\r\n\r\n              <h4>${BUTTON_TOOLTIP}</h4>\r\n\r\n              <p class=\"rlh-shell-meta\"><span class=\"rlh-shell-version\">v3.0</span><span class=\"rlh-shell-dot\">\u00B7</span><span class=\"rlh-shell-updated\">\u66F4\u65B0\u4E8E 2025 \u5E74 9 \u6708 30 \u65E5</span></p>\r\n\r\n            </div>\r\n\r\n            <div class=\"rlh-shell-right\">\r\n\r\n              <div id=\"${PREFETCH_INDICATOR_ID}\" class=\"rlh-prefetch-indicator\" data-visible=\"false\" aria-hidden=\"true\">\r\n\r\n                <div id=\"${PREFETCH_PROGRESS_TEXT_ID}\" class=\"rlh-prefetch-text\" aria-live=\"polite\">\u540E\u53F0\u52A0\u8F7D\u4E16\u754C\u4E66 (0/0)\uFF0C\u4E0D\u5F71\u54CD\u5176\u4ED6\u64CD\u4F5C</div>\r\n\r\n                <div class=\"rlh-prefetch-bar\" role=\"progressbar\" aria-valuemin=\"0\" aria-valuemax=\"100\" aria-valuenow=\"0\">\r\n\r\n                  <span id=\"${PREFETCH_PROGRESS_BAR_ID}\" class=\"rlh-prefetch-bar-inner\"></span>\r\n\r\n                </div>\r\n\r\n              </div>\r\n\r\n              <button type=\"button\" id=\"${DOM_ID.TOGGLE_TOOLBAR_BTN}\" class=\"rlh-toolbar-toggle-btn\" title=\"\u6298\u53E0\u5DE5\u5177\u680F\" aria-controls=\"${DOM_ID.TOOLBAR_SHELL}\" aria-expanded=\"true\">\u6298\u53E0\u5DE5\u5177\u680F</button>\r\n\r\n              <div class=\"rlh-shell-actions\">\r\n\r\n                <button type=\"button\" id=\"${REFRESH_BTN_ID}\" class=\"rlh-icon-button rlh-refresh-button\" title=\"\u5237\u65B0\u6570\u636E\">\r\n\r\n                  <i class=\"fa-solid fa-arrows-rotate\"></i>\r\n\r\n                </button>\r\n\r\n                <button type=\"button\" id=\"${CLOSE_BTN_ID}\" class=\"rlh-icon-button rlh-close-button\" title=\"\u5173\u95ED\u9762\u677F\">\r\n\r\n                  <i class=\"fa-solid fa-xmark\"></i>\r\n\r\n                </button>\r\n\r\n              </div>\r\n\r\n            </div>\r\n\r\n          </header>\r\n\r\n\r\n\r\n\r\n\r\n          <nav class=\"rlh-tab-nav\">\r\n\r\n            <div class=\"rlh-tab active\" data-tab=\"global-lore\"><span class=\"rlh-tab-text-full\">\u5168\u5C40\u4E16\u754C\u4E66</span><span class=\"rlh-tab-text-short\">\u5168\u5C40\u4E66</span></div>\r\n\r\n            <div class=\"rlh-tab\" data-tab=\"char-lore\"><span class=\"rlh-tab-text-full\">\u89D2\u8272\u4E16\u754C\u4E66</span><span class=\"rlh-tab-text-short\">\u89D2\u8272\u4E66</span></div>\r\n\r\n            <div class=\"rlh-tab\" data-tab=\"chat-lore\"><span class=\"rlh-tab-text-full\">\u804A\u5929\u4E16\u754C\u4E66</span><span class=\"rlh-tab-text-short\">\u804A\u5929\u4E66</span></div>\r\n\r\n            <div class=\"rlh-tab\" data-tab=\"global-regex\"><span class=\"rlh-tab-text-full\">\u5168\u5C40\u6B63\u5219</span><span class=\"rlh-tab-text-short\">\u5168\u5C40\u6B63\u5219</span></div>\r\n\r\n            <div class=\"rlh-tab\" data-tab=\"char-regex\"><span class=\"rlh-tab-text-full\">\u89D2\u8272\u6B63\u5219</span><span class=\"rlh-tab-text-short\">\u89D2\u8272\u6B63\u5219</span></div>\r\n\r\n          </nav>\r\n\r\n          <div id=\"${DOM_ID.TOOLBAR_SHELL}\" class=\"rlh-toolbar-shell\">\r\n\r\n            <div id=\"${CORE_TOOLBAR_ID}\" class=\"rlh-toolbar-container\"></div>\r\n\r\n            <div id=\"${REPLACE_TOOL_CONTAINER_ID}\" class=\"rlh-replace-container\"></div>\r\n\r\n          </div>\r\n\r\n          <div class=\"rlh-content-pane\">\r\n\r\n            <div id=\"${PANEL_ID}-content\"></div>\r\n\r\n          </div>\r\n\r\n          <footer class=\"rlh-shell-footer\">\r\n\r\n            <div id=\"regex-lore-hub-save-status\" class=\"rlh-save-status\"></div>\r\n\r\n          </footer>\r\n\r\n        </div>\r\n\r\n      </div>`;\r\n\r\n\r\n\r\n\r\n\r\n    $('body', parentDoc).append(panelHtml);\r\n\r\n\r\n\r\n\r\n\r\n    const buttonHtml = `<div id=\"${BUTTON_ID}\" class=\"list-group-item flex-container flexGap5 interactable\" title=\"${BUTTON_TOOLTIP}\"><span class=\"rlh-menu-icon\"><i class=\"fa-solid fa-layer-group\"></i></span><span>${BUTTON_TEXT_IN_MENU}</span></div>`;\r\n\r\n    const $extensionsMenu = $(`#extensionsMenu`, parentDoc);\r\n\r\n    if ($extensionsMenu.find(`#${BUTTON_ID}`).length === 0) {\r\n\r\n      $extensionsMenu.append(buttonHtml);\r\n\r\n      console.log(`[RegexLoreHub] Button #${BUTTON_ID} appended to #extensionsMenu.`);\r\n\r\n    }\r\n\r\n\r\n\r\n\r\n\r\n    const $panel = $(`#${PANEL_ID}`, parentDoc);\r\n\r\n    $panel.addClass('dark');\r\n\r\n\r\n\r\n\r\n\r\n    const $parentBody = $('body', parentDoc);\r\n\r\n    $parentBody.off('.rlh').on('click.rlh', `#${BUTTON_ID}`, handlers.togglePanel);\r\n\r\n\r\n\r\n\r\n\r\n    $panel\r\n\r\n      .off('.rlh')\r\n\r\n      .on('click.rlh', `#${CLOSE_BTN_ID}`, handlers.togglePanel)\r\n\r\n      .on('click.rlh', '.rlh-tab', handlers.switchTab)\r\n\r\n      .on('click.rlh', '.rlh-item-header, .rlh-global-book-header', handlers.handleHeaderClick)\r\n\r\n      .on('click.rlh', '.rlh-item-container', handlers.handleMultiSelectContainerClick)\r\n\r\n      .on('click.rlh', '.rlh-book-group', handlers.handleMultiSelectContainerClick)\r\n\r\n      .on('click.rlh', '.rlh-back-to-list-btn', handlers.handleExitLorebookDetail) // \u65B0\u589E\u7ED1\u5B9A\r\n\r\n      .on('click.rlh', '.rlh-toggle-btn', handlers.handleToggleState)\r\n\r\n      .on('click.rlh', '.rlh-refresh-detail-btn', handlers.handleRefreshLorebookDetail)\r\n\r\n      .on('click.rlh', '.rlh-entry-edit-btn', handlers.handleEntryEnterEdit)\r\n\r\n      .on('click.rlh', '.rlh-entry-view-btn', handlers.handleEntryExitEdit)\r\n\r\n      .on('click.rlh', '.rlh-regex-edit-btn', handlers.handleRegexEnterEdit)\r\n\r\n      .on('click.rlh', '.rlh-regex-view-btn', handlers.handleRegexExitEdit)\r\n\r\n      .on('keydown.rlh', `#${SEARCH_INPUT_ID}`, handlers.handleSearchInputKeydown)\r\n\r\n      .on('click.rlh', '#rlh-search-clear-btn', handlers.handleSearchClear)\r\n\r\n      .on('input.rlh', `#${SEARCH_INPUT_ID}, #${REPLACE_INPUT_ID}`, handlers.handleGlobalSearch) // \u8BE6\u60C5\u9875\u641C\u7D22/\u66FF\u6362\u6846\r\n\r\n      .on('change.rlh', '#rlh-search-filters-container input', renderContent)\r\n\r\n      .on('change.rlh', `#${CHARACTER_BOOK_SWITCH_ID}`, handlers.handleCharacterBookSwitch)\r\n\r\n      .on('click.rlh', `#${TOGGLE_COLLAPSE_BTN_ID}`, handlers.handleToolbarToggleCollapse)\n\n      .on('click.rlh', `#${SORT_MENU_BUTTON_ID}`, handlers.handleSortMenuToggle)\n\n      .on('click.rlh', '.rlh-sort-option', handlers.handleSortOptionSelect)\n\n      .on('click.rlh', `#${POSITION_MENU_BUTTON_ID}`, handlers.handlePositionMenuToggle)\n\r\n      .on('click.rlh', '.rlh-position-option', handlers.handlePositionOptionSelect)\r\n\r\n      .on('change.rlh', '.rlh-multi-select-checkbox', handlers.handleSelectionCheckboxChange)\r\n\r\n      .on('click.rlh', `#${REFRESH_BTN_ID}`, handlers.handleRefresh)\r\n\r\n      .on('click.rlh', '#rlh-multi-select-btn', handlers.toggleMultiSelectMode)\r\n\r\n      .on('click.rlh', '#rlh-select-all-btn', handlers.handleSelectAll)\r\n\r\n      .on('click.rlh', '#rlh-select-none-btn', handlers.handleSelectNone)\r\n\r\n      .on('click.rlh', '#rlh-select-invert-btn', handlers.handleSelectInvert)\r\n\r\n      .on('click.rlh', '#rlh-batch-enable-btn', handlers.handleBatchEnable)\r\n\r\n      .on('click.rlh', '#rlh-batch-disable-btn', handlers.handleBatchDisable)\r\n\r\n      .on('click.rlh', '#rlh-batch-delete-btn', handlers.handleBatchDelete)\r\n\r\n      .on('click.rlh', '.rlh-clean-orphan-books-btn', handlers.handleCleanOrphanLorebooks)\r\n\r\n      .on('click.rlh', `#${CREATE_LOREBOOK_BTN_ID}`, handlers.handlePrimaryCreateButtonClick)\r\n\r\n      .on('click.rlh', '.rlh-rename-book-btn', handlers.handleRenameBook)\r\n\r\n      .on('click.rlh', '.rlh-edit-entries-btn', handlers.handleEditEntriesToggle)\r\n\r\n      .on('click.rlh', '.rlh-delete-book-btn', handlers.handleDeleteLorebook)\r\n\r\n      .on('click.rlh', '.rlh-create-entry-btn', handlers.handleCreateEntry)\r\n\r\n      .on('click.rlh', '#regex-lore-hub-create-lorebook-btn', handlers.handleCreateLorebook)\r\n\r\n      .on('click.rlh', '.rlh-delete-entry-btn', handlers.handleDeleteEntry)\r\n\r\n      .on('click.rlh', '.rlh-batch-recursion-btn', handlers.handleBatchSetRecursion)\r\n\r\n      .on('click.rlh', '.rlh-fix-keywords-btn', handlers.handleFixKeywords)\r\n\r\n      .on('click.rlh', '.rlh-rename-btn', handlers.handleRename)\n\n      .on('click.rlh', '.rlh-rename-save-btn', handlers.handleConfirmRename)\n\n      .on('keydown.rlh', '.rlh-rename-input', handlers.handleRenameKeydown)\n\r\n      .on('change.rlh', '.rlh-edit-position', handlers.handlePositionChange)\r\n\r\n      .on('click.rlh', '#rlh-create-chat-lore-btn', handlers.handleCreateChatLorebook)\r\n\r\n      .on('click.rlh', '.rlh-unlink-chat-lore-btn', handlers.handleUnlinkChatLorebook)\r\n\r\n      .on('click.rlh', `#${DOM_ID.TOGGLE_TOOLBAR_BTN}`, toggleToolbar)\r\n      .on('click.rlh', '#rlh-replace-btn', handlers.handleReplace);\r\n\r\n    if (appState.isToolbarCollapsed) {\r\n\r\n      const $toolbarShell = $(`#${DOM_ID.TOOLBAR_SHELL}`, parentDoc);\r\n\r\n      $toolbarShell.addClass('rlh-toolbar-shell--collapsed');\r\n\r\n      const $toggleBtn = $(`#${DOM_ID.TOGGLE_TOOLBAR_BTN}`, parentDoc);\r\n\r\n      if ($toggleBtn.length) {\r\n\r\n        $toggleBtn.text('\u5C55\u5F00\u5DE5\u5177\u680F').attr('aria-expanded', 'false').attr('title', '\u5C55\u5F00\u5DE5\u5177\u680F');\r\n\r\n      }\r\n\r\n    }\r\n\r\n\r\n\r\n\r\n\r\n    console.log('[RegexLoreHub] All UI and events initialized.');\r\n\r\n\r\n\r\n\r\n\r\n    loadAllData();\r\n\r\n  }\r\n\r\n\r\n\r\n\r\n\r\n  loadSortableJS(initializeScript);\r\n\r\n}\r\n", "let jqInstance = null;\nlet tavernHelperInstance = null;\n\nexport function setEnv($, TavernHelper) {\n  jqInstance = $;\n  tavernHelperInstance = TavernHelper;\n}\n\nexport function get$() {\n  if (jqInstance) return jqInstance;\n  const parentWin = window.parent || window;\n  if (parentWin?.jQuery) return parentWin.jQuery;\n  return null;\n}\n\nexport function getTavernHelper() {\n  if (tavernHelperInstance) return tavernHelperInstance;\n  const parentWin = window.parent || window;\n  if (parentWin?.TavernHelper) return parentWin.TavernHelper;\n  return null;\n}\n\nfunction onReady(callback) {\n  const domSelector = '#extensionsMenu';\n  const maxRetries = 100; // \u6700\u591A\u7B49\u5F8520\u79D2\n  let retries = 0;\n\n  console.log(\n    `[RegexLoreHub] Starting readiness check. Polling for DOM element \"${domSelector}\" AND core APIs (TavernHelper, jQuery).`,\n  );\n\n  const interval = setInterval(() => {\n    const parentDoc = window.parent?.document;\n    const parentWin = window.parent;\n\n    const domReady = !!parentDoc && parentDoc.querySelector(domSelector) !== null;\n    const apiReady =\n      !!(parentWin && parentWin.TavernHelper) &&\n      typeof parentWin.TavernHelper.getCharData === 'function' &&\n      !!parentWin.jQuery;\n\n    if (domReady && apiReady) {\n      clearInterval(interval);\n      console.log(\n        `[RegexLoreHub] SUCCESS: Both DOM (\"${domSelector}\") and Core APIs are ready. Initializing script.`,\n      );\n      try {\n        const result = callback(parentWin.jQuery, parentWin.TavernHelper);\n        if (result?.catch) {\n          result.catch(error => {\n            console.error('[RegexLoreHub] FATAL: Error during main callback execution.', error);\n          });\n        }\n      } catch (error) {\n        console.error('[RegexLoreHub] FATAL: Error during main callback execution.', error);\n      }\n    } else {\n      retries++;\n      if (retries > maxRetries) {\n        clearInterval(interval);\n        console.error('[RegexLoreHub] FATAL: Readiness check timed out.');\n        if (!domReady) console.error(`[RegexLoreHub] -> Failure: DOM element \"${domSelector}\" not found.`);\n        if (!apiReady)\n          console.error(\n            `[RegexLoreHub] -> Failure: Core APIs not available. TavernHelper: ${!!parentWin?.TavernHelper}, jQuery: ${!!parentWin?.jQuery}`,\n          );\n      }\n    }\n  }, 150);\n}\n\nimport { createHandlers } from './ui/handlers/index.js';\nimport { initializeUI } from './ui/shell.js';\n\nasync function main($, TavernHelper) {\n  setEnv($, TavernHelper);\n\n  try {\n    await initializeUI(createHandlers);\n  } catch (error) {\n    console.error('[RegexLoreHub] FATAL: Failed to bootstrap application.', error);\n  }\n}\n\nonReady(main);\n"],
  "mappings": "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",
  "names": ["PANEL_ID", "BUTTON_ID", "BUTTON_TOOLTIP", "BUTTON_TEXT_IN_MENU", "CLOSE_BTN_ID", "SEARCH_INPUT_ID", "REFRESH_BTN_ID", "CORE_TOOLBAR_ID", "REPLACE_TOOL_CONTAINER_ID", "REPLACE_INPUT_ID", "TOGGLE_COLLAPSE_BTN_ID", "TOGGLE_RECURSION_BTN_ID", "FIX_KEYWORDS_BTN_ID", "SORT_MENU_ID", "SORT_MENU_BUTTON_ID", "POSITION_MENU_ID", "POSITION_MENU_BUTTON_ID", "CREATE_LOREBOOK_BTN_ID", "CHARACTER_BOOK_SWITCH_ID", "PREFETCH_INDICATOR_ID", "PREFETCH_PROGRESS_TEXT_ID", "PREFETCH_PROGRESS_BAR_ID", "DOM_ID", "LOREBOOK_OPTIONS", "DEFAULT_FILTER_LABELS", "REGEX_FILTER_LABELS", "FILTER_DEFINITIONS", "SORT_OPTION_DEFINITIONS", "appState", "safeGetLorebookEntries", "bookName", "entries", "error", "safeSetLorebookEntries", "safeDeleteLorebookEntries", "safeClearLorebookEntries", "safeHasLorebookEntries", "getParentWin", "getParentDoc", "escapeHtml", "text", "div", "highlightText", "searchTerm", "escapedText", "htmlSafeSearchTerm", "regexSpecialChars", "escapedSearchTerm", "char", "regex", "showToast", "message", "type", "duration", "$", "get$", "parentDoc", "$panel", "PANEL_ID", "iconClass", "toastHtml", "$toast", "showProgressToast", "initialMessage", "newMessage", "showModal", "options", "resolve", "reject", "title", "html", "placeholder", "value", "buttonsHtml", "inputHtml", "bodyContent", "modalHtml", "$modal", "$input", "closeModal", "isSuccess", "val", "e", "errorCatched", "fn", "context", "notify", "toastType", "toastDuration", "toastMessage", "modalTitle", "modalText", "args", "debounce", "func", "delay", "timeout", "buildSearchRegex", "caseSensitive", "escapedTerm", "flags", "UI_TEXTS", "getContextInstanceKey", "context", "getActiveCollapseState", "key", "appState", "setActiveCollapseState", "state", "getActiveSortMode", "options", "stored", "defaultValue", "setActiveSortMode", "mode", "escapeAttr", "value", "escapeHtml", "buildFilterCheckboxes", "filtersState", "filters", "items", "definition", "FILTER_DEFINITIONS", "label", "DEFAULT_FILTER_LABELS", "isChecked", "buildSortMenu", "currentSort", "option", "SORT_OPTION_DEFINITIONS", "isActive", "menuListId", "SORT_MENU_ID", "SORT_MENU_BUTTON_ID", "buildPositionMenu", "bookName", "entries", "safeGetLorebookEntries", "hasEntries", "uniquePositions", "entry", "activePosition", "POSITION_MENU_ID", "buttonAttributes", "POSITION_MENU_BUTTON_ID", "LOREBOOK_OPTIONS", "attributes", "containerAttributes", "renderToolbar", "$toolbar", "$replaceContainer", "collapseState", "sortMode", "multiSelectClasses", "multiSelectAttributes", "multiSelectButtonHtml", "multiSelectControlsClass", "multiSelectControlsHtml", "multiSelectModuleHtml", "collapseButtonHtml", "TOGGLE_COLLAPSE_BTN_ID", "recursionButtonHtml", "targetBookName", "TOGGLE_RECURSION_BTN_ID", "fixKeywordsButtonHtml", "FIX_KEYWORDS_BTN_ID", "positionMenuHtml", "sortMenuHtml", "filtersHtml", "scopeLabel", "searchPlaceholder", "searchValue", "searchRowHtml", "SEARCH_INPUT_ID", "replaceValue", "replacePanelHtml", "REPLACE_INPUT_ID", "searchMetaHtml", "searchBoxHtml", "createEntryButtonHtml", "bookNameForCreate", "disabled", "buttonClasses", "actionTitle", "iconClass", "createBookButtonHtml", "searchSectionHtml", "actionsItems", "actionsSectionHtml", "toolbarHtml", "matchEntry", "searchTerm", "term", "matchRegex", "item", "createGlobalLorebookElement", "book", "forceShowAllEntries", "filteredEntries", "$", "get$", "usedByChars", "usedByHtml", "char", "highlightedBookName", "highlightText", "selectionAllowed", "selectionKey", "isSelected", "selectionControl", "$element", "$content", "$entryActions", "allEntries", "a", "b", "entriesToShow", "$listWrapper", "createItemElement", "convertMultilineToHtml", "html", "buildViewerPlaceholder", "text", "buildLoreEntryViewerHTML", "keywordsText", "keywordsHtml", "rawContent", "contentHtml", "hasValue", "formatViewerText", "placeholder", "buildViewerField", "field", "body", "buildViewerGroup", "title", "fields", "layout", "headingHtml", "positionLabel", "pos", "depthValue", "orderValue", "hasLogic", "logicKey", "logicBaseLabel", "logicValue", "probabilityValue", "keywordsField", "contentField", "insertRuleGroup", "UI_TEXTS", "activationGroup", "matchingGroup", "buildRegexViewerHTML", "findRaw", "replaceRaw", "normalizedTerm", "findHtml", "replaceHtml", "destination", "source", "minDepth", "maxDepth", "destinationLabels", "destinationText", "activeSources", "sourceText", "hasMin", "hasMax", "depthText", "metaHtml", "row", "type", "isLore", "id", "name", "fromCard", "isExpanded", "enableDrag", "target", "controlsHtml", "dragHandleHtml", "headerTitle", "highlightedName", "positionKey", "positionLabelRaw", "orderNumber", "fallbackOrder", "effectiveOrder", "orderLabel", "initialMode", "viewerHtml", "prependEntry", "parentDoc", "getParentDoc", "$newEntryDom", "updateSelectionCount", "buildReplaceConfirmationHTML", "matches", "stats", "booksMatchedByNameOnly", "replaceTerm", "summaryHtml", "listHtml", "booksOnlyHtml", "buildStatsList", "statsData", "count", "totalBooks", "m", "totalEntries", "matchedFields", "hitFields", "fieldsText", "entryName", "hitDetails", "statsItems", "renderSaveStatus", "$statusContainer", "status", "statusClass", "reorderLoreEntriesInState", "orderedIds", "entryMap", "reordered", "index", "safeSetLorebookEntries", "initializeLoreEntrySortable", "parentWin", "getParentWin", "listEl", "errorCatched", "evt", "oldIndex", "newIndex", "node", "saveAllChanges", "GLOBAL_LIST_CHUNK_SIZE", "globalListRenderHandle", "globalListProgressEl", "cancelPendingGlobalListRender", "parentWin", "getParentWin", "type", "id", "clearFn", "sortLoreEntries", "entries", "sortMode", "list", "b", "diff", "getGlobalLorebookMatches", "searchTerm", "caseSensitive", "matches", "booksMatchedByNameOnly", "stats", "books", "appState", "flags", "searchRegex", "matchedBooksForName", "matchedEntriesForName", "matchedEntriesForKeywords", "matchedEntriesForContent", "addedEntries", "book", "safeGetLorebookEntries", "isBookNameMatch", "bookHasEntryMatches", "entry", "currentMatch", "entryHasMatch", "matchedKeywordsCount", "k", "renderGlobalLoreTabView", "context", "$container", "renderGlobalLoreDetailView", "renderGlobalLoreListView", "$", "get$", "parentDoc", "getParentDoc", "normalizedTerm", "getActiveSortMode", "a", "filteredBooks", "matchEntry", "total", "chunkSize", "currentIndex", "updateProgress", "completed", "appendNodes", "nodes", "fragment", "node", "renderChunk", "end", "i", "domNode", "createGlobalLorebookElement", "progressRef", "scheduleNextChunk", "callback", "bookName", "escapeHtml", "loadingHtml", "collapseState", "getActiveCollapseState", "detailHtml", "visibleEntries", "$content", "message", "entriesHtml", "createItemElement", "renderCharacterLorebookView", "context", "searchTerm", "$container", "$", "get$", "linkedBooks", "appState", "characterName", "activeBookName", "sortMode", "getActiveSortMode", "collapseState", "getActiveCollapseState", "optionsHtml", "name", "escapeHtml", "CHARACTER_BOOK_SWITCH_ID", "$bookElement", "bookName", "$bookContainer", "$listWrapper", "bookMeta", "b", "loadLorebookEntriesIfNeeded", "renderContent", "baseEntries", "safeGetLorebookEntries", "a", "entries", "sortLoreEntries", "bookNameMatches", "matchingEntries", "entry", "matchEntry", "entriesToShow", "canReorder", "createItemElement", "initializeLoreEntrySortable", "renderChatLorebookView", "context", "searchTerm", "$container", "$", "get$", "bookName", "appState", "parentWin", "getParentWin", "characterName", "escapeHtml", "sortMode", "getActiveSortMode", "collapseState", "getActiveCollapseState", "$bookContainer", "$listWrapper", "bookMeta", "b", "loadLorebookEntriesIfNeeded", "renderContent", "baseEntries", "safeGetLorebookEntries", "a", "entries", "sortLoreEntries", "matchingEntries", "entry", "matchEntry", "canReorder", "createItemElement", "message", "initializeLoreEntrySortable", "cancelGlobalLoreListRender", "cancelPendingGlobalListRender", "sortRegexEntries", "entries", "sortMode", "list", "b", "diff", "getRegexMatches", "searchTerm", "caseSensitive", "matches", "stats", "scripts", "appState", "flags", "searchRegex", "matchedScriptsForName", "matchedScriptsForContent", "addedScripts", "script", "hasMatch", "contentToSearch", "renderRegexView", "context", "itemList", "$container", "title", "$", "get$", "parentWin", "getParentWin", "getActiveSortMode", "collapseState", "getActiveCollapseState", "items", "label", "hostContext", "filteredItems", "item", "matchRegex", "listId", "$listContainer", "canReorder", "index", "$element", "createItemElement", "listEl", "sortable", "errorCatched", "evt", "oldIndex", "newIndex", "scope", "targetList", "moved", "updateRegexOrderMetadata", "saveAllChanges", "normalizeSearchTerm", "value", "getViewContext", "tab", "appState", "view", "base", "DEFAULT_FILTER_LABELS", "bookName", "REGEX_FILTER_LABELS", "ensureSearchFiltersDefaults", "context", "contextKey", "key", "renderContent", "$", "get$", "parentDoc", "getParentDoc", "$panel", "PANEL_ID", "ensureLayoutNodes", "emptySet", "$toolbarRow", "$tabNav", "$toolbar", "CORE_TOOLBAR_ID", "$replaceContainer", "REPLACE_TOOL_CONTAINER_ID", "$contentPane", "$content", "searchTerm", "selector", "$checkbox", "viewContext", "cancelGlobalLoreListRender", "renderToolbar", "renderSaveStatus", "updateSelectionCount", "renderGlobalLoreTabView", "renderCharacterLorebookView", "renderChatLorebookView", "renderRegexView", "LOGIC_STRING_TO_ENUM", "LOGIC_ENUM_TO_STRING", "ROLE_NAME_TO_ENUM", "ROLE_ENUM_TO_NAME", "POSITION_UI_TO_STRUCT", "POSITION_NUMERIC_TO_UI", "LEGACY_POSITION_ALIASES", "cloneEntry", "source", "sanitizeKeyArray", "keys", "key", "str", "ORDER_FIELD_KEYS", "updateRegexOrderMetadata", "regexList", "regex", "index", "normalizeRegexPayloadOrder", "regexes", "buckets", "scope", "list", "toBooleanStrict", "value", "normalized", "parseOptionalNumber", "numeric", "normalizeLogicString", "normalizeRoleName", "value", "normalized", "ROLE_NAME_TO_ENUM", "mapped", "ROLE_ENUM_TO_NAME", "resolveUiPositionKey", "positionValue", "roleValue", "normalizedType", "LEGACY_POSITION_ALIASES", "roleName", "POSITION_NUMERIC_TO_UI", "extractPositionDetails", "positionValue", "fallbackRole", "fallbackDepth", "fallbackOrder", "fallbackRoleName", "normalizeRoleName", "details", "parseOptionalNumber", "setOrder", "value", "parsed", "setDepth", "normalizedType", "LEGACY_POSITION_ALIASES", "roleName", "uiKey", "resolveUiPositionKey", "buildRawPosition", "uiKeyInput", "depth", "order", "basePosition", "baseDetails", "normalizedKey", "mapping", "POSITION_UI_TO_STRUCT", "result", "parsedOrder", "resolvedOrder", "role", "parsedDepth", "resolvedDepth", "normalizeWorldbookEntry", "entry", "clone", "cloneEntry", "strategy", "keys", "sanitizeKeyArray", "secondaryKeys", "logicString", "normalizeLogicString", "LOGIC_STRING_TO_ENUM", "positionDetails", "probability", "toBooleanStrict", "convertUiEntryToRaw", "uiEntry", "baseEntry", "raw", "uiClone", "numericUid", "positionStruct", "recursion", "resolveBool", "uiValue", "currentValue", "caseSensitiveValue", "matchWholeWordsValue", "resolveNumericUid", "sanitizeKeysForUpdate", "isCharacterNotFoundError", "error", "message", "TavernAPI", "errorCatched", "name", "getTavernHelper", "regexes", "options", "scope", "payload", "normalizeRegexPayloadOrder", "bookNames", "charData", "characterName", "updater", "entries", "uids", "uidsSet", "lorebooks", "updateWorldbookEntries", "bookName", "entryUpdates", "updatesByUid", "pendingUidSet", "update", "uid", "existing", "localEntries", "safeGetLorebookEntries", "localEntryMap", "currentEntries", "localEntry", "mergedLocal", "partialUpdate", "key", "item", "updatedEntries", "normalizedEntries", "safeSetLorebookEntries", "updateBookSummary", "ensurePendingLorebookUpdateMap", "appState", "queueLorebookEntryUpdate", "entryIdentifier", "updatesMap", "field", "queueRegexUpdate", "regexId", "migratePendingLorebookUpdate", "tempUid", "newUid", "tempKey", "record", "newKey", "target", "loadAllDataPromise", "performLoadAllData", "$", "get$", "parentDoc", "getParentDoc", "parentWin", "getParentWin", "TavernHelper", "$content", "PANEL_ID", "syncContextWithAppState", "loading", "$status", "$detail", "$progress", "$bar", "$barContainer", "total", "current", "updateBar", "safeTotal", "ratio", "percent", "totalValue", "status", "detail", "totalSteps", "progressCurrent", "advanceProgress", "safeClearLorebookEntries", "renderContent", "context", "allCharacters", "hasActiveCharacter", "hasActiveChat", "charLinkedBooks", "chatLorebook", "promises", "results", "allUIRegexes", "enabledGlobalBookNames", "allBookFileNames", "r", "updateRegexOrderMetadata", "updateCharacterRegexes", "knownBookNames", "char", "books", "bookSet", "b", "charError", "charProcessingError", "enabledGlobalBooks", "charBookSet", "prefetchGlobalBookSummaries", "REFRESH_BTN_ID", "loadAllData", "force", "isPrefetchingGlobalSummaries", "PREFETCH_MAX_CONCURRENCY", "sleep", "ms", "resolve", "getPrefetchElements", "$indicator", "PREFETCH_INDICATOR_ID", "$text", "PREFETCH_PROGRESS_TEXT_ID", "PREFETCH_PROGRESS_BAR_ID", "setPrefetchIndicatorVisibility", "visible", "updatePrefetchIndicatorContent", "clamped", "hidePrefetchIndicator", "updateGlobalBookStatsDisplay", "$panel", "$group", "_", "el", "book", "showPrefetchIndicator", "booksToPrefetch", "completed", "queue", "worker", "loadLorebookEntriesIfNeeded", "workerCount", "refreshCharacterData", "charBooks", "chatWorldbook", "updateCharacterLorebooks", "newBooksToLoad", "safeHasLorebookEntries", "characterUIRegexes", "cardRegexes", "i", "e", "uiRegexIdentifiers", "uniqueCardRegexes", "identifier", "characterBookNames", "createInMemoryEntry", "newEntry", "updateInMemoryEntry", "tempId", "serverData", "entryIndex", "normalizedServerData", "updatedEntry", "saveAllChanges", "silent", "MAX_RETRIES", "RETRY_DELAY", "attempts", "delay", "triggerUIUpdate", "renderSaveStatus", "flushLorebookUpdates", "didSave", "processedKeys", "data", "k", "flushRegexUpdates", "allRegexes", "performSave", "loreSaved", "regexSaved", "normalizeCharacterName", "trimmed", "extractNameFromCharacter", "character", "extractNameFromCharData", "matchCharacterById", "targetId", "normalizedTarget", "id", "characters", "characterId", "matchedCharacter", "createLorebookHandlers", "deps", "$", "get$", "parentDoc", "getParentDoc", "parentWin", "getParentWin", "refreshLorebookData", "bookName", "showLoading", "targetName", "previousLoading", "appState", "renderContent", "loadLorebookEntriesIfNeeded", "handleEnterLorebookDetail", "errorCatched", "handleExitLorebookDetail", "$searchInput", "updateLinkedCharacters", "oldBookName", "newBookName", "progressToast", "linkedChars", "context", "originalCharId", "processedCount", "totalCount", "charName", "charIndex", "c", "charBooks", "TavernAPI", "updated", "index", "charError", "handleRenameBook", "event", "$bookSource", "isDetailView", "oldName", "newName", "showModal", "b", "linkedCharacters", "isChatLinked", "chatCount", "totalBindings", "confirmText", "showProgressToast", "oldEntries", "safeGetLorebookEntries", "entriesToCreate", "entry", "newEntry", "enabledGlobalBooks", "newGlobalBooks", "name", "updatedGlobalBooks", "updatedChatLorebook", "verifyError", "currentChatLorebook", "loadAllData", "finalChatLorebook", "syncError", "showToast", "error", "handleCreateLorebook", "previousValue", "book", "$button", "handleDeleteLorebook", "safeDeleteLorebookEntries", "handleBatchSetRecursion", "rawDatasetName", "getViewContext", "entries", "updates", "updateWorldbookEntries", "update", "$openEditor", "handleFixKeywords", "changedCount", "originalKeysString", "newKeysArray", "k", "finalKeysString", "e", "applyUnifiedPosition", "positionValue", "targetPosition", "resolvedBookName", "optionLabel", "LOREBOOK_OPTIONS", "refreshedEntries", "uniquePositions", "unifiedPosition", "selector", "$container", "$positionSelect", "$menu", "POSITION_MENU_ID", "POSITION_MENU_BUTTON_ID", "$option", "value", "isActive", "handleCreateChatLorebook", "handleUnlinkChatLorebook", "handleRefreshLorebookDetail", "createItemHandlers", "deps", "$", "get$", "parentDoc", "getParentDoc", "findRegexItemById", "rawId", "targetId", "fromGlobal", "appState", "item", "applyRegexFieldUpdate", "regexItem", "fieldPath", "rawValue", "value", "numeric", "segments", "cursor", "i", "key", "debouncedSave", "debounce", "saveAllChanges", "handleEditorInput", "errorCatched", "event", "$target", "$container", "type", "id", "numericId", "field", "bookName", "entry", "safeGetLorebookEntries", "itemUid", "element", "blockTags", "parts", "appendText", "textValue", "appendNewline", "collectText", "node", "nodeType", "tag", "child", "k", "numValue", "pendingValue", "queueLorebookEntryUpdate", "queueRegexUpdate", "buildLoreEntryEditorHtml", "positionOptions", "LOREBOOK_OPTIONS", "text", "logicOptions", "keywordsText", "contentText", "escapeHtml", "buildRegexEditorHtml", "destination", "source", "findValue", "replaceValue", "minDepthValue", "maxDepthValue", "updateRenameButtonState", "mode", "$button", "$icon", "bindLoreEditorInputs", "$content", "switchLoreEntryMode", "animate", "searchTerm", "isViewMode", "normalizedTerm", "html", "buildLoreEntryViewerHTML", "$nameSpan", "finalize", "animateReveal", "done", "el", "duration", "easeInOut", "t", "startHeight", "targetHeight", "startTime", "step", "timestamp", "progress", "eased", "currentHeight", "renderLoreEntryViewer", "options", "renderLoreEntryEditor", "renderRegexViewer", "viewerHtml", "buildRegexViewerHTML", "renderRegexEditor", "editorHtml", "bindInputs", "enterLoreEdit", "silent", "showToast", "entryId", "e", "exitLoreEdit", "enterRegexEdit", "exitRegexEdit", "handleEntryEnterEdit", "handleEntryExitEdit", "handleRegexEnterEdit", "handleRegexExitEdit", "handleToggleState", "$elementToSort", "isEnabling", "parentList", "currentBooks", "TavernAPI", "bookState", "b", "updateWorldbookEntries", "allServerRegexes", "regex", "r", "localRegex", "items", "a", "aEnabled", "bEnabled", "aName", "bName", "handleRename", "exitRenameMode", "$header", "oldName", "renameUIHtml", "entered", "newName", "handleConfirmRename", "exitEditMode", "handleRenameKeydown", "handleEditorExpandToggle", "$editors", "handleCreateEntry", "explicitBookName", "activeBookName", "getViewContext", "showModal", "tempEntry", "createInMemoryEntry", "$newEntryDom", "prependEntry", "renameButton", "result", "safeSetLorebookEntries", "normalizeWorldbookEntry", "serverEntry", "updateInMemoryEntry", "$entryDom", "updateBookSummary", "error", "handleDeleteEntry", "$item", "uid", "entryName", "handlePositionChange", "$select", "$depthContainer", "showReplaceConfirmationModal", "matches", "stats", "booksMatchedByNameOnly", "searchTerm", "replaceTerm", "context", "modalContent", "buildReplaceConfirmationHTML", "showModal", "toggleToolbar", "errorCatched", "event", "$", "get$", "parentDoc", "getParentDoc", "$panel", "PANEL_ID", "$toolbarShell", "DOM_ID", "willCollapse", "appState", "$toggleButton", "createUIHandlers", "deps", "lorebookHandlers", "itemHandlers", "getTargetKeyPrefix", "parseSelectionKey", "rawKey", "key", "firstSepIndex", "type", "remainder", "lastSepIndex", "getVisibleSelectKeys", "selector", "keys", "_", "el", "$el", "hasSelectionForCurrentTarget", "prefix", "resolveSelectionKey", "$container", "bookName", "itemType", "itemId", "toggleSelectionForContainer", "itemKey", "updateSelectionCount", "handleGlobalSearch", "$target", "value", "renderContent", "handleSearchInputKeydown", "term", "handleSearchClear", "$input", "SEARCH_INPUT_ID", "handleReplace", "REPLACE_INPUT_ID", "getViewContext", "booksToLoad", "b", "progressToast", "showProgressToast", "loadLorebookEntriesIfNeeded", "error", "getGlobalLorebookMatches", "getRegexMatches", "modalContext", "performReplace", "showToast", "handleToolbarToggleCollapse", "getContextInstanceKey", "nextState", "setActiveCollapseState", "isCurrentlyVisible", "$header", "$button", "TOGGLE_COLLAPSE_BTN_ID", "iconClass", "label", "sortMenuListenersActive", "getSortMenuElements", "SORT_MENU_ID", "SORT_MENU_BUTTON_ID", "handleSortMenuOutsideClick", "closeSortMenu", "handleSortMenuKeydown", "attachSortMenuListeners", "detachSortMenuListeners", "$menu", "openSortMenu", "handleSortMenuToggle", "handleSortOptionSelect", "sortValue", "setActiveSortMode", "positionMenuListenersActive", "getPositionMenuElements", "POSITION_MENU_ID", "POSITION_MENU_BUTTON_ID", "handlePositionMenuOutsideClick", "closePositionMenu", "handlePositionMenuKeydown", "attachPositionMenuListeners", "detachPositionMenuListeners", "openPositionMenu", "handlePositionMenuToggle", "handlePositionOptionSelect", "$option", "positionValue", "handleCharacterBookSwitch", "handleSelectionCheckboxChange", "$checkbox", "selectKey", "isChecked", "replaceRegex", "buildSearchRegex", "updatesByBook", "keysAreEqual", "a", "index", "match", "entry", "uid", "update", "hasChange", "newKeys", "newContent", "newName", "newComment", "updates", "updateWorldbookEntries", "togglePanel", "hidePanel", "showPanel", "saveAllChanges", "$parentBody", "BUTTON_ID", "loadAllData", "handleTabRefresh", "tabId", "refreshCharacterData", "ensureBookMeta", "name", "book", "books", "chatBookName", "switchTab", "targetTab", "CREATE_LOREBOOK_BTN_ID", "toggleMultiSelectMode", "handleSelectAll", "handleSelectNone", "changed", "handleSelectInvert", "handleBatchEnable", "performBatchOperation", "handleBatchDisable", "handleBatchDelete", "selectedBooks", "selectedEntries", "selectedRegexIds", "totalEntriesToDelete", "entryId", "regexId", "numericId", "normalizedRegexId", "confirmText", "parts", "deletedBooksCount", "deletedEntriesCount", "deletedRegexCount", "processedEntries", "processedBooks", "entriesToDelete", "uids", "result", "TavernAPI", "safeSetLorebookEntries", "normalizeWorldbookEntry", "booksToDelete", "safeDeleteLorebookEntries", "allServerRegexes", "regexesToKeep", "r", "updateRegexOrderMetadata", "id", "messageParts", "handleCleanOrphanLorebooks", "orphanBooks", "usageList", "linkedChars", "failedBooks", "deletedCount", "enable", "selectedBookNames", "selectedEntriesByBook", "needsRegexUpdate", "needsSettingsUpdate", "currentBooks", "entryIds", "entries", "safeGetLorebookEntries", "e", "regex", "list", "handleHeaderClick", "data", "$content", "storedSearchTerm", "attrSearchTerm", "effectiveSearchTerm", "regexItem", "handleMultiSelectContainerClick", "handleEditEntriesToggle", "$bookGroup", "isEnteringEditMode", "handleRefresh", "$icon", "cachedEntries", "syncContextWithAppState", "updateBookSummary", "handlePrimaryCreateButtonClick", "mockEvent", "createHandlers", "$", "get$", "parentDoc", "getParentDoc", "parentWin", "getParentWin", "sharedDeps", "lorebookHandlers", "createLorebookHandlers", "itemHandlers", "createItemHandlers", "uiHandlers", "createUIHandlers", "builtCSS", "initializeUI", "createHandlers", "$", "get$", "parentDoc", "getParentDoc", "parentWin", "getParentWin", "handlers", "injectCSS", "existingStyle", "PANEL_ID", "builtCSS", "styleElement", "loadSortableJS", "callback", "script", "showModal", "initializeScript", "panelHtml", "BUTTON_TOOLTIP", "PREFETCH_INDICATOR_ID", "PREFETCH_PROGRESS_TEXT_ID", "PREFETCH_PROGRESS_BAR_ID", "DOM_ID", "REFRESH_BTN_ID", "CLOSE_BTN_ID", "CORE_TOOLBAR_ID", "REPLACE_TOOL_CONTAINER_ID", "buttonHtml", "BUTTON_ID", "BUTTON_TEXT_IN_MENU", "$extensionsMenu", "$panel", "SEARCH_INPUT_ID", "REPLACE_INPUT_ID", "renderContent", "CHARACTER_BOOK_SWITCH_ID", "TOGGLE_COLLAPSE_BTN_ID", "SORT_MENU_BUTTON_ID", "POSITION_MENU_BUTTON_ID", "CREATE_LOREBOOK_BTN_ID", "toggleToolbar", "appState", "$toggleBtn", "loadAllData", "jqInstance", "tavernHelperInstance", "setEnv", "$", "TavernHelper", "get$", "parentWin", "getTavernHelper", "onReady", "callback", "domSelector", "retries", "interval", "parentDoc", "domReady", "apiReady", "result", "error", "main", "initializeUI", "createHandlers"]
}

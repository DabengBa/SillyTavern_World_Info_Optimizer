# 技术文档

## 概述

本文档详细描述了WI_Optimizer.js脚本的技术实现方式，包括其核心功能、架构设计和关键算法。

## 版本历史

### v2.7 主要更新
- **搜索功能增强**：新增内容搜索功能和搜索关键词高亮显示
- **替换功能**：实现了批量内容替换功能，支持条目关键词、内容和名称的批量修改
- **安全性优化**：修复了多个可能导致程序异常的问题，增强了程序稳定性
- **世界书重命名增强**：改进了角色绑定关系的同步更新机制

## 架构设计

WI_Optimizer采用模块化设计，主要由以下几个核心组件构成：

1. **TavernAPI包装器**：封装了与SillyTavern后端交互的所有API调用，包括世界书管理、正则表达式管理等。
2. **数据加载与管理模块**：负责从后端加载数据，并在前端维护应用状态。
3. **UI渲染引擎**：根据应用状态动态渲染用户界面。
4. **事件处理系统**：处理用户交互，如点击、拖拽等。
5. **工具函数库**：提供一系列辅助功能，如HTML转义、文本高亮等。
6. **搜索与替换引擎**：(v2.7新增) 提供强大的搜索过滤和批量替换功能。
7. **安全访问层**：(v2.7增强) 提供安全的数据访问函数，防止数据结构异常导致的程序崩溃。

## 核心功能实现

### 1. 数据加载与状态管理

- `loadAllData()` 函数使用 `Promise.allSettled()` 并行加载所有必要数据，包括全局和角色的世界书、正则表达式等。
- 应用状态存储在 `appState` 对象中，包含所有加载的数据以及UI状态。
- 通过安全函数如 `safeClearLorebookEntries()`, `safeHasLorebookEntries()` 确保数据操作的安全性。

### 2. UI渲染

- `renderContent()` 函数根据当前选项卡和搜索条件渲染相应的内容。
- 各种专门的渲染函数如 `renderGlobalLorebookView()`, `renderCharacterLorebookView()` 等负责渲染不同类型的数据视图。
- 使用 `createItemElement()` 函数创建世界书条目和正则表达式的UI元素，支持高亮、拖拽排序和状态管理。

### 3. 事件处理

- 事件处理函数如 `handleReplace()`, `performReplace()` 处理用户交互。
- 批量操作功能通过 `handleBatchEnable()`, `handleBatchDisable()`, `handleBatchDelete()` 等函数实现。
- 通过 `handleEditEntriesToggle()` 实现编辑模式的切换。

### 4. 工具函数

- `escapeHtml()` 函数用于HTML转义，防止XSS攻击。
- `highlightText()` (v2.7新增) 函数实现搜索结果高亮显示，支持特殊字符的安全处理。
- `showSuccessTick()`, `showProgressToast()` 等函数提供用户反馈。
- 安全访问函数 (v2.7新增)：`safeGetLorebookEntries()`, `safeSetLorebookEntries()`, `safeDeleteLorebookEntries()`, `safeClearLorebookEntries()`, `safeHasLorebookEntries()` 确保数据操作的安全性。

### 5. 搜索与替换引擎 (v2.7新增)

- `handleReplace()` 函数处理批量替换操作的用户交互和确认流程。
- `performReplace()` 函数执行实际的替换操作，支持关键词、内容和条目名称的批量修改。
- `getGlobalLorebookMatches()`, `getCharacterLorebookMatches()`, `getChatLorebookMatches()` 函数根据不同页面获取搜索匹配项。
- 搜索高亮功能通过HTML转义和正则表达式安全地实现关键词高亮显示。

## 安全措施

- 所有从后端获取的数据都通过安全函数进行处理，如 `safeGetLorebookEntries()`, `safeSetLorebookEntries()` 等。
- 在进行DOM操作前，会对特殊字符进行转义处理。
- 对于搜索和替换功能，统一对显示文本与搜索词进行 HTML 转义后再执行不区分大小写的正则匹配，保证匹配层级一致且安全。
- (v2.7增强) 新增多层安全检查机制：
  - Map对象类型检查和自动重新初始化
  - 方法存在性验证，防止API变更导致的调用失败
  - 异常捕获和自动恢复机制，确保程序在异常情况下的稳定性

## 性能优化

- 使用防抖技术优化频繁触发的操作，如正则表达式顺序保存。
- 批量操作减少API调用次数，提高效率。
- 使用 `Promise.allSettled()` 并行加载数据，提高数据加载速度。

## 扩展功能实现

### 1. 聊天世界书支持

- 实现了对聊天专用世界书的全面支持，包括创建、绑定、解绑和重命名。
- 通过 `getChatLorebookMatches()` 和 `renderChatLorebookView()` 函数处理聊天世界书的显示和管理。

### 2. 正则表达式顺序管理

- 通过可视化显示和拖拽调整功能，实现了正则表达式的顺序管理。
- 使用防抖技术优化正则表达式顺序保存操作。

### 3. 批量操作

- 批量操作功能通过 `handleBatchEnable()`, `handleBatchDisable()`, `handleBatchDelete()` 等函数实现。
- `handleBatchDelete()` 函数支持混合选择世界书和条目进行批量删除。
- 通过进度提示优化长时间运行的批量操作用户体验。

### 4. 编辑功能

- 世界书条目和正则表达式的编辑功能通过专门的HTML生成逻辑实现。
- 编辑模式切换通过 `handleEditEntriesToggle()` 函数处理，支持多选模式自动激活。
- 保存操作通过 `handleSave()` 函数实现，包括数据验证、API调用及本地状态更新。

### 5. 搜索与高亮功能 (v2.7新增)

- **内容搜索功能**：扩展了搜索过滤器，新增"内容"选项，允许用户在世界书条目的具体内容中搜索关键词。
- **搜索结果高亮**：实现了 `highlightText()` 函数，对搜索匹配的文本进行黄色背景高亮显示。
- **安全的文本处理**：高亮功能通过先进行HTML转义，再进行正则匹配和替换，确保特殊字符的正确处理。
- **动态过滤**：支持按书名、条目名、关键词、内容的多维度组合搜索和过滤。

### 6. 批量替换功能 (v2.7新增)

- **替换操作流程**：通过 `handleReplace()` 函数提供用户友好的替换确认界面。
- **智能匹配检测**：自动检测当前视图中的匹配项数量，并向用户展示详细的替换预览。
- **批量内容修改**：`performReplace()` 函数支持对多个世界书的条目进行批量修改，包括：
  - 关键词 (keys) 的批量替换
  - 条目内容 (content) 的批量替换  
  - 条目名称 (comment) 的批量替换
- **事务性更新**：按世界书分组进行批量更新，确保数据一致性。

### 7. 安全访问层优化 (v2.7重点增强)

- **防御性编程**：所有访问 `appState.lorebookEntries` Map对象的操作都通过安全函数进行。
- **自动修复机制**：当检测到Map对象异常时，自动重新初始化并继续执行。
- **类型安全检查**：验证Map对象的类型和方法可用性，防止运行时错误。
- **异常隔离**：通过try-catch包装，将潜在的异常控制在安全函数内部，不影响主程序流程。

安全函数包括：
- `safeGetLorebookEntries(bookName)` - 安全获取世界书条目
- `safeSetLorebookEntries(bookName, entries)` - 安全设置世界书条目
- `safeDeleteLorebookEntries(bookName)` - 安全删除世界书条目映射
- `safeClearLorebookEntries()` - 安全清空所有条目映射
- `safeHasLorebookEntries(bookName)` - 安全检查是否存在指定世界书

### 8. 世界书重命名功能增强 (v2.7优化)

- **角色绑定同步**：通过 `updateLinkedCharacters()` 函数自动更新所有相关角色的世界书绑定关系。
- **API兼容性**：使用正确的 `Character.findCharacterIndex()` API进行角色索引查找。
- **状态同步验证**：在每个关键步骤后验证操作结果，确保数据一致性。
- **调试信息增强**：添加详细的控制台日志，便于问题排查和状态跟踪。
- **错误恢复**：在操作失败时提供完整的回滚机制，确保数据不会处于不一致状态。